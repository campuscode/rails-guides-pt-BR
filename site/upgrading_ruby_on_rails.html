<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Atualizando o Ruby on Rails ‚Äî Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Atualizando o Ruby on Rails ‚Äî Ruby on Rails Guides" />
  <meta name="description" content="Atualizando o Ruby on RailsEste guia fornece os passos a serem seguidos quando voc√™ for atualizar suas aplica√ß√µes para uma vers√£o mais nova do Ruby on Rails. Estes passos tamb√©m est√£o dispon√≠veis em guias de releases individuais." />
  <meta property="og:description" content="Atualizando o Ruby on RailsEste guia fornece os passos a serem seguidos quando voc√™ for atualizar suas aplica√ß√µes para uma vers√£o mais nova do Ruby on Rails. Estes passos tamb√©m est√£o dispon√≠veis em guias de releases individuais." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a p√°gina principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Come√ßando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                  <dd><a href="active_record_encryption.html">Active Record Encryption</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribui√ß√µes</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Pol√≠ticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - ?</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Come√ßando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</option>
                  <option value="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
                  <option value="active_record_encryption.html">Active Record Encryption</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribui√ß√µes">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Pol√≠ticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_0_release_notes.html">Version 7.0 - ?</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Atualizando o Ruby on Rails</h2><p>Este guia fornece os passos a serem seguidos quando voc√™ for atualizar suas aplica√ß√µes
para uma vers√£o mais nova do Ruby on Rails. Estes passos tamb√©m est√£o dispon√≠veis em guias de <em>releases</em> individuais.</p>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#conselho-geral">Conselho Geral</a>

<ul>
<li><a href="#cobertura-de-testes">Cobertura de Testes</a></li>
<li><a href="#versoes-ruby">Vers√µes Ruby</a></li>
<li><a href="#o-processo-de-atualizacao">O Processo de Atualiza√ß√£o</a></li>
<li><a href="#a-tarefa-de-atualizacao">A Tarefa de Atualiza√ß√£o</a></li>
<li><a href="#configurar-padroes-de-framework">Configurar Padr√µes de Framework</a></li>
</ul>
</li>
<li>
<a href="#upgrading-from-rails-6-1-to-rails-7-0">Upgrading from Rails 6.1 to Rails 7.0</a>

<ul>
<li><a href="#actionview-helpers-urlhelper-button-to-changed-behavior"><code>ActionView::Helpers::UrlHelper#button_to</code> changed behavior</a></li>
<li><a href="#upgrading-from-rails-6-1-to-rails-7-0-spring">Spring</a></li>
<li><a href="#sprockets-is-now-an-optional-dependency">Sprockets is now an optional dependency</a></li>
<li><a href="#applications-need-to-run-in-zeitwerk-mode">Applications need to run in <code>zeitwerk</code> mode</a></li>
<li><a href="#the-setter-config-autoloader-has-been-deleted">The setter <code>config.autoloader=</code> has been deleted</a></li>
<li><a href="#activesupport-dependencies-private-api-has-been-deleted"><code>ActiveSupport::Dependencies</code> private API has been deleted</a></li>
<li><a href="#autoloading-during-initialization">Autoloading during initialization</a></li>
<li><a href="#ability-to-configure-config-autoload-once-paths">Ability to configure <code>config.autoload_once_paths</code></a></li>
<li><a href="#actiondispatch-request-content-type-now-returned-content-type-header-as-it-is"><code>ActionDispatch::Request#content_type</code> now returned Content-Type header as it is.</a></li>
<li><a href="#key-generator-digest-class-changing-to-use-sha256">Key generator digest class changing to use SHA256</a></li>
<li><a href="#digest-class-for-activesupport-digest-changing-to-sha256">Digest class for ActiveSupport::Digest changing to SHA256</a></li>
<li><a href="#new-activesupport-cache-serialization-format">New ActiveSupport::Cache serialization format</a></li>
<li><a href="#active-storage-video-preview-image-generation">Active Storage video preview image generation</a></li>
<li><a href="#active-storage-default-variant-processor-changed-to-vips">Active Storage default variant processor changed to <code>:vips</code></a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-6-0-para-o-rails-6-1">Atualizando do Rails 6.0 para o Rails 6.1</a>

<ul>
<li><a href="#rails-application-config-for-o-valor-de-retorno-nao-oferece-mais-suporte-para-acesso-com-chaves-string"><code>Rails.application.config_for</code> o valor de retorno n√£o oferece mais suporte para acesso com chaves <em>String</em>.</a></li>
<li><a href="#respostas-do-tipo-de-conteudo-ao-utilizar-respond-to-any">Respostas do tipo de conte√∫do ao utilizar <code>respond_to#any</code></a></li>
<li><a href="#activesupport-callbacks-halted-callback-hook-agora-recebe-um-segundo-argumento"><code>ActiveSupport::Callbacks#halted_callback_hook</code> agora recebe um segundo argumento</a></li>
<li><a href="#o-metodo-de-classe-helper-nos-controllers-usa-string-constantize">O m√©todo de classe <code>helper</code> nos <em>controllers</em> usa <code>String#constantize</code></a></li>
<li><a href="#redirecionamento-para-https-vindo-de-http-agora-usara-o-codigo-de-status-308-http">Redirecionamento para HTTPS vindo de HTTP agora usar√° o c√≥digo de status 308 HTTP</a></li>
<li><a href="#active-storage-agora-requer-processamento-de-imagem">Active Storage agora requer Processamento de Imagem</a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-5-2-para-o-rails-6-0">Atualizando do Rails 5.2 para o Rails 6.0</a>

<ul>
<li><a href="#usando-webpacker">Usando Webpacker</a></li>
<li><a href="#forcar-ssl">For√ßar SSL</a></li>
<li><a href="#proposito-purpose-e-metadados-de-expiracao-agora-estao-incorporados-em-cookies-assinados-e-criptografados-para-maior-seguranca">Prop√≥sito (<em>Purpose</em>) e metadados de expira√ß√£o agora est√£o incorporados em cookies assinados e criptografados para maior seguran√ßa</a></li>
<li><a href="#todos-os-pacotes-npm-foram-movidos-para-o-escopo-rails">Todos os pacotes npm foram movidos para o escopo <code>@rails</code></a></li>
<li><a href="#mudancas-na-api-do-action-cable-javascript">Mudan√ßas na API do <em>Action Cable JavaScript</em></a></li>
<li><a href="#actiondispatch-response-content-type-agora-retorna-o-cabecalho-header-do-tipo-de-conteudo-content-type-sem-modificacao"><code>ActionDispatch::Response#content_type</code> agora retorna o cabe√ßalho (<em>header</em>) do tipo de conte√∫do (<em>Content-Type</em>) sem modifica√ß√£o</a></li>
<li><a href="#carregamento-automatico">Carregamento Autom√°tico</a></li>
<li><a href="#alteracao-de-comportamento-de-atribuicao-do-active-storage">Altera√ß√£o de comportamento de atribui√ß√£o do <em>Active Storage</em></a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-5-1-para-o-rails-5-2">Atualizando do Rails 5.1 para o Rails 5.2</a>

<ul>
<li><a href="#atualizando-do-rails-5-1-para-o-rails-5-2-bootsnap"><em>Bootsnap</em></a></li>
<li><a href="#a-expiracao-em-cookies-assinados-ou-criptografados-esta-agora-incorporada-nos-valores-dos-cookies">A expira√ß√£o em <em>cookies</em> assinados ou criptografados est√° agora incorporada nos valores dos <em>cookies</em></a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-5-0-para-o-rails-5-1">Atualizando do Rails 5.0 para o Rails 5.1</a>

<ul>
<li><a href="#hashwithindifferentaccess-de-nivel-superior-esta-descontinuado"><code>HashWithIndifferentAccess</code> de n√≠vel superior est√° descontinuado</a></li>
<li><a href="#application-secrets-agora-e-carregado-com-todas-as-chaves-como-simbolos"><code>application.secrets</code> agora √© carregado com todas as chaves como s√≠mbolos</a></li>
<li><a href="#removido-suporte-obsoleto-para-text-e-nothing-em-render">Removido suporte obsoleto para <code>:text</code> e <code>:nothing</code> em <code>render</code></a></li>
<li><a href="#removido-suporte-obsoleto-para-redirect-to-back">Removido suporte obsoleto para <code>redirect_to :back</code></a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-4-2-para-o-rails-5-0">Atualizando do Rails 4.2 para o Rails 5.0</a>

<ul>
<li><a href="#necessario-ruby-2-2-2">Necess√°rio Ruby 2.2.2+</a></li>
<li><a href="#active-record-models-agora-herdam-de-applicationrecord-por-padrao"><em>Active Record Models</em> agora herdam de <em>ApplicationRecord</em> por padr√£o</a></li>
<li><a href="#interrompendo-sequencias-de-callback-via-throw-abort">Interrompendo Sequ√™ncias de <em>Callback</em> via <code>throw(:abort)</code></a></li>
<li><a href="#activejob-agora-herda-de-applicationjob-por-padrao"><em>ActiveJob</em> agora herda de <em>ApplicationJob</em> por padr√£o</a></li>
<li><a href="#testando-rails-controller">Testando Rails <em>Controller</em></a></li>
<li><a href="#carregamento-automatico-e-desabilitado-apos-a-inicializacao-no-ambiente-de-producao">Carregamento autom√°tico √© desabilitado ap√≥s a inicializa√ß√£o no ambiente de produ√ß√£o</a></li>
<li><a href="#serializacao-xml">Serializa√ß√£o XML</a></li>
<li><a href="#removido-o-suporte-para-o-antigo-adaptador-de-banco-de-dados-mysql">Removido o suporte para o antigo adaptador de banco de dados <code>mysql</code></a></li>
<li><a href="#removido-suporte-para-o-debugger">Removido suporte para o <em>Debugger</em></a></li>
<li><a href="#use-bin-rails-para-executar-tarefas-e-testes">Use <code>bin/rails</code> para executar tarefas e testes</a></li>
<li><a href="#actioncontroller-parameters-nao-herda-mais-de-hashwithindifferentaccess"><code>ActionController::Parameters</code> N√£o herda mais de <code>HashWithIndifferentAccess</code></a></li>
<li><a href="#protect-from-forgery-agora-assume-como-padrao-prepend-false"><code>protect_from_forgery</code> Agora assume como padr√£o <code>prepend:false</code></a></li>
<li><a href="#o-template-handler-padrao-agora-e-raw">O <em>Template Handler</em> padr√£o agora √© <em>RAW</em></a></li>
<li><a href="#adicionada-correspondencia-de-curinga-wildcard-para-template-dependencies">Adicionada correspond√™ncia de curinga (<em>Wildcard</em>) para <em>Template Dependencies</em></a></li>
<li><a href="#actionview-helpers-recordtaghelper-movido-para-a-gem-externa-record-tag-helper"><code>ActionView::Helpers::RecordTagHelper</code> movido para a <em>gem</em> externa (record_tag_helper)</a></li>
<li><a href="#removido-suporte-para-a-gem-protected-attributes">Removido suporte para a <em>Gem</em> <code>protected_attributes</code></a></li>
<li><a href="#removido-o-suporte-para-a-gem-activerecord-deprecated-finders">Removido o suporte para a <em>gem</em> <code>activerecord-deprecated_finders</code></a></li>
<li><a href="#a-ordem-do-teste-padrao-activesupport-testcase-agora-e-aleatoria">A ordem do teste padr√£o <code>ActiveSupport::TestCase</code> agora √© aleat√≥ria</a></li>
<li><a href="#actioncontroller-live-tornou-se-uma-concern"><code>ActionController::Live</code> tornou-se uma <code>Concern</code></a></li>
<li><a href="#novos-padroes-do-framework">Novos Padr√µes do Framework</a></li>
<li><a href="#mudancas-na-serializacao-json-jsonb">Mudan√ßas na Serializa√ß√£o JSON/JSONB</a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-4-1-para-o-rails-4-2">Atualizando do Rails 4.1 para o Rails 4.2</a>

<ul>
<li><a href="#web-console"><em>Web Console</em></a></li>
<li><a href="#responders"><em>Responders</em></a></li>
<li><a href="#tratamento-de-erros-em-transaction-callbacks">Tratamento de erros em <em>transaction callbacks</em></a></li>
<li><a href="#ordenando-os-casos-de-teste">Ordenando os casos de teste</a></li>
<li><a href="#atributos-serializados">Atributos serializados</a></li>
<li><a href="#nivel-de-log-em-producao">N√≠vel de <em>log</em> em produ√ß√£o</a></li>
<li><a href="#after-bundle-em-rails-templates"><code>after_bundle</code> em Rails <em>templates</em></a></li>
<li><a href="#rails-html-sanitizer">Rails <em>HTML Sanitizer</em></a></li>
<li><a href="#testando-rails-dom">Testando <em>Rails DOM</em></a></li>
<li><a href="#tokens-de-autenticidade-mascarados">Tokens de autenticidade mascarados</a></li>
<li><a href="#action-mailer"><em>Action Mailer</em></a></li>
<li><a href="#suporte-para-chave-estrangeira">Suporte para chave estrangeira</a></li>
</ul>
</li>
<li>
<a href="#upgrading-from-rails-4-0-to-rails-4-1">Upgrading from Rails 4.0 to Rails 4.1</a>

<ul>
<li><a href="#csrf-protection-from-remote-script-tags">CSRF protection from remote <code>&lt;script&gt;</code> tags</a></li>
<li><a href="#upgrading-from-rails-4-0-to-rails-4-1-spring">Spring</a></li>
<li><a href="#config-secrets-yml"><code>config/secrets.yml</code></a></li>
<li><a href="#changes-to-test-helper">Changes to test helper</a></li>
<li><a href="#cookies-serializer">Cookies serializer</a></li>
<li><a href="#flash-structure-changes">Flash structure changes</a></li>
<li><a href="#changes-in-json-handling">Changes in JSON handling</a></li>
<li><a href="#usage-of-return-within-inline-callback-blocks">Usage of <code>return</code> within inline callback blocks</a></li>
<li><a href="#methods-defined-in-active-record-fixtures">Methods defined in Active Record fixtures</a></li>
<li><a href="#i18n-enforcing-available-locales">I18n enforcing available locales</a></li>
<li><a href="#mutator-methods-called-on-relation">Mutator methods called on Relation</a></li>
<li><a href="#changes-on-default-scopes">Changes on Default Scopes</a></li>
<li><a href="#rendering-content-from-string">Rendering content from string</a></li>
<li><a href="#postgresql-json-and-hstore-datatypes">PostgreSQL json and hstore datatypes</a></li>
<li><a href="#explicit-block-use-for-activesupport-callbacks">Explicit block use for <code>ActiveSupport::Callbacks</code></a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-3-2-para-o-rails-4-0">Atualizando do Rails 3.2 para o Rails 4.0</a>

<ul>
<li><a href="#http-patch">HTTP PATCH</a></li>
<li><a href="#atualizando-do-rails-3-2-para-o-rails-4-0-gemfile">Gemfile</a></li>
<li><a href="#atualizando-do-rails-3-2-para-o-rails-4-0-vendor-plugins">vendor/plugins</a></li>
<li><a href="#atualizando-do-rails-3-2-para-o-rails-4-0-active-record"><em>Active Record</em></a></li>
<li><a href="#active-resource"><em>Active Resource</em></a></li>
<li><a href="#active-model"><em>Active Model</em></a></li>
<li><a href="#action-pack"><em>Action Pack</em></a></li>
<li><a href="#active-support"><em>Active Support</em></a></li>
<li><a href="#ordem-de-carregamento-de-helpers">Ordem de Carregamento de <em>Helpers</em></a></li>
<li><a href="#active-record-observer-e-action-controller-sweeper"><em>Active Record Observer</em> e <em>Action Controller Sweeper</em></a></li>
<li><a href="#sprockets-rails">sprockets-rails</a></li>
<li><a href="#sass-rails">sass-rails</a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-3-1-para-o-rails-3-2">Atualizando do Rails 3.1 para o Rails 3.2</a>

<ul>
<li><a href="#atualizando-do-rails-3-1-para-o-rails-3-2-gemfile">Gemfile</a></li>
<li><a href="#atualizando-do-rails-3-1-para-o-rails-3-2-config-environments-development-rb">config/environments/development.rb</a></li>
<li><a href="#atualizando-do-rails-3-1-para-o-rails-3-2-config-environments-test-rb">config/environments/test.rb</a></li>
<li><a href="#atualizando-do-rails-3-1-para-o-rails-3-2-vendor-plugins">vendor/plugins</a></li>
<li><a href="#atualizando-do-rails-3-1-para-o-rails-3-2-active-record">Active Record</a></li>
</ul>
</li>
<li>
<a href="#atualizando-do-rails-3-0-para-o-rails-3-1">Atualizando do Rails 3.0 para o Rails 3.1</a>

<ul>
<li><a href="#gemfile">Gemfile</a></li>
<li><a href="#config-application-rb">config/application.rb</a></li>
<li><a href="#atualizando-do-rails-3-0-para-o-rails-3-1-config-environments-development-rb">config/environments/development.rb</a></li>
<li><a href="#config-environments-production-rb">config/environments/production.rb</a></li>
<li><a href="#atualizando-do-rails-3-0-para-o-rails-3-1-config-environments-test-rb">config/environments/test.rb</a></li>
<li><a href="#config-initializers-wrap-parameters-rb">config/initializers/wrap_parameters.rb</a></li>
<li><a href="#config-initializers-session-store-rb">config/initializers/session_store.rb</a></li>
<li><a href="#remover-opcoes-de-cache-e-concat-em-referencias-de-helpers-para-assets-em-views">Remover op√ß√µes de :cache e :concat em refer√™ncias de <em>helpers</em> para <em>assets</em> em <em>views</em></a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="conselho-geral"><a class="anchorlink" href="#conselho-geral">1 Conselho Geral</a></h3><p>Antes de tentar atualizar uma aplica√ß√£o existente, voc√™ deve ter certeza que possui uma boa raz√£o para faz√™-lo. Ent√£o tenha em mente alguns fatores: a necessidade de novas funcionalidades, a crescente dificuldade de encontrar suporte para c√≥digo mais antigo, seu tempo dispon√≠vel e habilidades, entre outros.</p><h4 id="cobertura-de-testes"><a class="anchorlink" href="#cobertura-de-testes">1.1 Cobertura de Testes</a></h4><p>A melhor maneira de garantir que sua aplica√ß√£o ainda funciona ap√≥s a atualiza√ß√£o √© possuir uma boa cobertura de testes antes de come√ßar o processo. Se voc√™ n√£o tiver testes automatizados para a maior parte de sua aplica√ß√£o, ser√° necess√°rio gastar algum tempo realizando testes manuais de todas as partes alteradas. No caso da atualiza√ß√£o do Rails, isso significa cada umas das funcionalidades dentro da aplica√ß√£o. Fa√ßa a si mesmo um favor e tenha certeza de ter uma boa cobertura de teste <strong>antes</strong> de iniciar uma atualiza√ß√£o.</p><h4 id="versoes-ruby"><a class="anchorlink" href="#versoes-ruby">1.2 Vers√µes Ruby</a></h4><p>Rails geralmente se mant√©m pr√≥ximo √† vers√£o mais recente do Ruby quando √© liberado:</p>
<ul>
<li>Rails 7 requer Ruby 2.7.0 ou mais recente.</li>
<li>Rails 6 requer Ruby 2.5.0 ou mais recente.</li>
<li>Rails 5 requer Ruby 2.2.2 ou mais recente.</li>
</ul>
<p>√â uma boa ideia atualizar Ruby e Rails separadamente. Atualize para o Ruby mais recente que puder primeiro e, em seguida, atualize o Rails.</p><h4 id="o-processo-de-atualizacao"><a class="anchorlink" href="#o-processo-de-atualizacao">1.3 O Processo de Atualiza√ß√£o</a></h4><p>Quando estiver atualizando a vers√£o do Rails, o melhor √© ir devagar, uma vers√£o <em>Minor</em> por vez, para fazer bom uso dos avisos de deprecia√ß√£o. As vers√µes do Rails s√£o numeradas da maneira <em>Major</em>.<em>Minor</em>.<em>Patch</em>. Vers√µes <em>Major</em> e <em>Minor</em> t√™m permiss√£o para alterar API p√∫blica, isso pode causar erros em sua aplica√ß√£o. Vers√µes <em>Patch</em> incluem apenas corre√ß√µes de <em>bug</em>, e n√£o alteram nenhuma API p√∫blica.</p><p>O processo deve correr da seguinte maneira:</p>
<ol>
<li>Escreva os testes e garanta que eles passem.</li>
<li>Atualize para a √∫ltima vers√£o <em>Patch</em> ap√≥s a vers√£o atual de seu projeto.</li>
<li>Conserte os testes e funcionalidades depreciadas.</li>
<li>Atualize para a √∫ltima vers√£o <em>Patch</em> da vers√£o <em>Minor</em> seguinte.</li>
</ol>
<p>Repita este processo at√© chegar na vers√£o desejada do Rails.</p><h5 id="movendo-se-entre-as-versoes"><a class="anchorlink" href="#movendo-se-entre-as-versoes">1.3.1 Movendo-se entre as vers√µes</a></h5><p>Para alternar entre as vers√µes:</p>
<ol>
<li>Altere o n√∫mero da vers√£o do Rails no <code>Gemfile</code> e execute o <code>bundle update</code>.</li>
<li>Altere as vers√µes dos pacotes JavaScript do Rails em <code>package.json</code> e execute <code>yarn install</code>, se estiver executando no Webpacker.</li>
<li>Execute a <a href="#the-update-task">Tarefa de atualiza√ß√£o</a>.</li>
<li>Execute seus testes.</li>
</ol>
<p>Voc√™ pode encontrar uma lista de todas as gems do Rails lan√ßadas <a href="https://rubygems.org/gems/rails/versions">aqui</a>.</p><h4 id="a-tarefa-de-atualizacao"><a class="anchorlink" href="#a-tarefa-de-atualizacao">1.4 A Tarefa de Atualiza√ß√£o</a></h4><p>Rails fornece o comando <code>rails app:update</code>. Execute este comando ap√≥s atualizar a vers√£o do Rails no <code>Gemfile</code>. Isto lhe ajudar√° na cria√ß√£o de novos arquivos e na altera√ß√£o de arquivos antigos em uma sess√£o interativa.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>app:update
<span class="go">       exist  config
    conflict  config/application.rb
Overwrite /myapp/config/application.rb? (enter "h" for help) [Ynaqdh]
       force  config/application.rb
      create  config/initializers/new_framework_defaults_7_0.rb
</span><span class="c">...
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-d13eb6de4d897f05169a85fdcfc3afe6">bin/rails app:update
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d13eb6de4d897f05169a85fdcfc3afe6">Copiar</button>
</div>
<p>N√£o esque√ßa de revisar a diferen√ßa, para verificar se houveram mudan√ßas inesperadas.</p><h4 id="configurar-padroes-de-framework"><a class="anchorlink" href="#configurar-padroes-de-framework">1.5 Configurar Padr√µes de Framework</a></h4><p>A nova vers√£o do Rails pode ter configura√ß√µes padr√£o diferentes da vers√£o anterior. No entanto, ap√≥s seguir os passos descritos acima, sua aplica√ß√£o ainda estaria rodando com configura√ß√µes padr√£o da vers√£o <strong>anterior</strong> do Rails. Isso porque o valor para <code>config.load_defaults</code> em <code>config/application.rb</code> ainda n√£o foi alterado.</p><p>Para permitir que voc√™ atualize para novos padr√µes um por um, a tarefa de atualiza√ß√£o criou um arquivo <code>config/initializers/new_framework_defaults_X.Y.rb</code> (com a vers√£o desejada do Rails no nome do arquivo). Voc√™ deve habilitar os novos padr√µes de configura√ß√£o descomentando-os no arquivo; isso pode ser feito gradualmente ao longo de v√°rias implanta√ß√µes. Assim que sua aplica√ß√£o estiver pronta para rodar com novos padr√µes, voc√™ pode remover este arquivo e inverter o valor <code>config.load_defaults</code>.</p><h3 id="upgrading-from-rails-6-1-to-rails-7-0"><a class="anchorlink" href="#upgrading-from-rails-6-1-to-rails-7-0">2 Upgrading from Rails 6.1 to Rails 7.0</a></h3><h4 id="actionview-helpers-urlhelper-button-to-changed-behavior"><a class="anchorlink" href="#actionview-helpers-urlhelper-button-to-changed-behavior">2.1 <code>ActionView::Helpers::UrlHelper#button_to</code> changed behavior</a></h4><p>Starting from Rails 7.0 <code>button_to</code> renders a <code>form</code> tag with <code>patch</code> HTTP verb if a persisted Active Record object is used to build button URL.
To keep current behavior consider explicitly passing <code>method:</code> option:</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
</span><span class="gi">+button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)], method: :post)
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-93e826158135b1355c1cfd2e210d01c2">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
+button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)], method: :post)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-93e826158135b1355c1cfd2e210d01c2">Copiar</button>
</div>
<p>or using helper to build the URL:</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
</span><span class="gi">+button_to("Do a POST", my_custom_post_action_on_workshop_workshop_path(Workshop.find(1)))
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-73371bfeb369244eec4a065b20511798">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
+button_to("Do a POST", my_custom_post_action_on_workshop_workshop_path(Workshop.find(1)))
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-73371bfeb369244eec4a065b20511798">Copiar</button>
</div>
<h4 id="upgrading-from-rails-6-1-to-rails-7-0-spring"><a class="anchorlink" href="#upgrading-from-rails-6-1-to-rails-7-0-spring">2.2 Spring</a></h4><p>If your application uses Spring, it needs to be upgraded to at least version 3.0.0. Otherwise you'll get</p><div class="code_container">
<pre><code class="highlight plaintext">undefined method `mechanism=' for ActiveSupport::Dependencies:Module
</code></pre>
<textarea class="clipboard-content" id="clipboard-edc94fea455cbf943aa2e1021455e4ef">undefined method `mechanism=' for ActiveSupport::Dependencies:Module
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-edc94fea455cbf943aa2e1021455e4ef">Copiar</button>
</div>
<p>Also, make sure <code>config.cache_classes</code> is set to <code>false</code> in <code>config/environments/test.rb</code>.</p><h4 id="sprockets-is-now-an-optional-dependency"><a class="anchorlink" href="#sprockets-is-now-an-optional-dependency">2.3 Sprockets is now an optional dependency</a></h4><p>The gem <code>rails</code> doesn't depend on <code>sprockets-rails</code> anymore. If your application still needs to use Sprockets,
make sure to add <code>sprockets-rails</code> to your Gemfile.</p><div class="code_container">
<pre><code class="highlight plaintext">gem "sprockets-rails"
</code></pre>
<textarea class="clipboard-content" id="clipboard-2403ec406329f010aae7a00c05251502">gem "sprockets-rails"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2403ec406329f010aae7a00c05251502">Copiar</button>
</div>
<h4 id="applications-need-to-run-in-zeitwerk-mode"><a class="anchorlink" href="#applications-need-to-run-in-zeitwerk-mode">2.4 Applications need to run in <code>zeitwerk</code> mode</a></h4><p>Applications still running in <code>classic</code> mode have to switch to <code>zeitwerk</code> mode. Please check the <a href="https://guides.rubyonrails.org/classic_to_zeitwerk_howto.html">Classic to Zeitwerk HOWTO</a> guide for details.</p><h4 id="the-setter-config-autoloader-has-been-deleted"><a class="anchorlink" href="#the-setter-config-autoloader-has-been-deleted">2.5 The setter <code>config.autoloader=</code> has been deleted</a></h4><p>In Rails 7 there is no configuration point to set the autoloading mode, <code>config.autoloader=</code> has been deleted. If you had it set to <code>:zeitwerk</code> for whatever reason, just remove it.</p><h4 id="activesupport-dependencies-private-api-has-been-deleted"><a class="anchorlink" href="#activesupport-dependencies-private-api-has-been-deleted">2.6 <code>ActiveSupport::Dependencies</code> private API has been deleted</a></h4><p>The private API of <code>ActiveSupport::Dependencies</code> has been deleted. That includes methods like <code>hook!</code>, <code>unhook!</code>, <code>depend_on</code>, <code>require_or_load</code>, <code>mechanism</code>, and many others.</p><p>A few of highlights:</p>
<ul>
<li>If you used <code>ActiveSupport::Dependencies.constantize</code> or <code>ActiveSupport::Dependencies.safe_constantize</code>, just change them to <code>String#constantize</code> or <code>String#safe_constantize</code>.</li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">constantize</span><span class="p">(</span><span class="s2">"User"</span><span class="p">)</span> <span class="c1"># NO LONGER POSSIBLE</span>
  <span class="s2">"User"</span><span class="p">.</span><span class="nf">constantize</span> <span class="c1"># üëç</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e4b3992b343774d1e1c46ca0c2cb9de1">  ActiveSupport::Dependencies.constantize("User") # NO LONGER POSSIBLE
  "User".constantize # üëç
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e4b3992b343774d1e1c46ca0c2cb9de1">Copiar</button>
</div>

<ul>
<li><p>Any usage of <code>ActiveSupport::Dependencies.mechanism</code>, reader or writer, has to be replaced by accessing <code>config.cache_classes</code> accordingly.</p></li>
<li><p>If you want to trace the activity of the autoloader, <code>ActiveSupport::Dependencies.verbose=</code> is no longer available, just throw <code>Rails.autoloaders.log!</code> in <code>config/application.rb</code>.</p></li>
</ul>
<p>Auxiliary internal classes or modules are also gone, like like <code>ActiveSupport::Dependencies::Reference</code>, <code>ActiveSupport::Dependencies::Blamable</code>, and others.</p><h4 id="autoloading-during-initialization"><a class="anchorlink" href="#autoloading-during-initialization">2.7 Autoloading during initialization</a></h4><p>Applications that autoloaded reloadable constants during initialization outside of <code>to_prepare</code> blocks got those constants unloaded and had this warning issued since Rails 6.0:</p><div class="code_container">
<pre><code class="highlight plaintext">DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
</code></pre>
<textarea class="clipboard-content" id="clipboard-3dc13c17d7b4f50f75c098dfab5b0430">DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3dc13c17d7b4f50f75c098dfab5b0430">Copiar</button>
</div>
<p>If you still get this warning in the logs, please check the section about autoloading when the application boots in the <a href="https://guides.rubyonrails.org/v7.0/autoloading_and_reloading_constants.html#autoloading-when-the-application-boots">autoloading guide</a>. You'd get a <code>NameError</code> in Rails 7 otherwise.</p><h4 id="ability-to-configure-config-autoload-once-paths"><a class="anchorlink" href="#ability-to-configure-config-autoload-once-paths">2.8 Ability to configure <code>config.autoload_once_paths</code></a></h4><p><code>config.autoload_once_paths</code> can be set in the body of the application class defined in <code>config/application.rb</code> or in the configuration for environments in <code>config/environments/*</code>.</p><p>Similarly, engines can configure that collection in the class body of the engine class or in the configuration for environments.</p><p>After that, the collection is frozen, and you can autoload from those paths. In particular, you can autoload from there during initialization. They are managed by the <code>Rails.autoloaders.once</code> autoloader, which does not reload, only autoloads/eager loads.</p><p>If you configured this setting after the environments configuration has been processed and are getting <code>FrozenError</code>, please just move the code.</p><h4 id="actiondispatch-request-content-type-now-returned-content-type-header-as-it-is"><a class="anchorlink" href="#actiondispatch-request-content-type-now-returned-content-type-header-as-it-is">2.9 <code>ActionDispatch::Request#content_type</code> now returned Content-Type header as it is.</a></h4><p>Previously, <code>ActionDispatch::Request#content_type</code> returned value does NOT contain charset part.
This behavior changed to returned Content-Type header containing charset part as it is.</p><p>If you want just MIME type, please use <code>ActionDispatch::Request#media_type</code> instead.</p><p>Before:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"CONTENT_TYPE"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0cd5e6007f5e6e260feb814197e7812b">request = ActionDispatch::Request.new("CONTENT_TYPE" =&gt; "text/csv; header=present; charset=utf-16", "REQUEST_METHOD" =&gt; "GET")
request.content_type #=&gt; "text/csv"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0cd5e6007f5e6e260feb814197e7812b">Copiar</button>
</div>
<p>After:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-945766c51aa6f98249d881401ddaf405">request = ActionDispatch::Request.new("Content-Type" =&gt; "text/csv; header=present; charset=utf-16", "REQUEST_METHOD" =&gt; "GET")
request.content_type #=&gt; "text/csv; header=present; charset=utf-16"
request.media_type   #=&gt; "text/csv"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-945766c51aa6f98249d881401ddaf405">Copiar</button>
</div>
<h4 id="key-generator-digest-class-changing-to-use-sha256"><a class="anchorlink" href="#key-generator-digest-class-changing-to-use-sha256">2.10 Key generator digest class changing to use SHA256</a></h4><p>The default digest class for the key generator is changing from SHA1 to SHA256.
This has consequences in any encrypted message generated by Rails, including
encrypted cookies.</p><p>In order to be able to read messages using the old digest class it is necessary
to register a rotator.</p><p>The following is an example for rotator for the encrypted cookies.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_rotations</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">cookies</span><span class="o">|</span>
  <span class="n">salt</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">authenticated_encrypted_cookie_salt</span>
  <span class="n">secret_key_base</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">secret_key_base</span>

  <span class="n">key_generator</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">KeyGenerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="n">secret_key_base</span><span class="p">,</span> <span class="ss">iterations: </span><span class="mi">1000</span><span class="p">,</span> <span class="ss">hash_digest_class: </span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span>
  <span class="p">)</span>
  <span class="n">key_len</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">MessageEncryptor</span><span class="p">.</span><span class="nf">key_len</span>
  <span class="n">secret</span> <span class="o">=</span> <span class="n">key_generator</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">key_len</span><span class="p">)</span>

  <span class="n">cookies</span><span class="p">.</span><span class="nf">rotate</span> <span class="ss">:encrypted</span><span class="p">,</span> <span class="n">secret</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-83d8889354236897db763f9f5f2da443">Rails.application.config.action_dispatch.cookies_rotations.tap do |cookies|
  salt = Rails.application.config.action_dispatch.authenticated_encrypted_cookie_salt
  secret_key_base = Rails.application.secrets.secret_key_base

  key_generator = ActiveSupport::KeyGenerator.new(
    secret_key_base, iterations: 1000, hash_digest_class: OpenSSL::Digest::SHA1
  )
  key_len = ActiveSupport::MessageEncryptor.key_len
  secret = key_generator.generate_key(salt, key_len)

  cookies.rotate :encrypted, secret
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-83d8889354236897db763f9f5f2da443">Copiar</button>
</div>
<h4 id="digest-class-for-activesupport-digest-changing-to-sha256"><a class="anchorlink" href="#digest-class-for-activesupport-digest-changing-to-sha256">2.11 Digest class for ActiveSupport::Digest changing to SHA256</a></h4><p>The default digest class for ActiveSupport::Digest is changing from SHA1 to SHA256.
This has consequences for things like Etags that will change and cache keys as well.
Changing these keys can have impact on cache hit rates, so be careful and watch out
for this when upgrading to the new hash.</p><h4 id="new-activesupport-cache-serialization-format"><a class="anchorlink" href="#new-activesupport-cache-serialization-format">2.12 New ActiveSupport::Cache serialization format</a></h4><p>A faster and more compact serialization format was introduced.</p><p>To enable it you must set <code>config.active_support.cache_format_version = 7.0</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.1</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">cache_format_version</span> <span class="o">=</span> <span class="mf">7.0</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-12f8cf1ee9de9776a32eda8c78a4144a"># config/application.rb

config.load_defaults 6.1
config.active_support.cache_format_version = 7.0
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-12f8cf1ee9de9776a32eda8c78a4144a">Copiar</button>
</div>
<p>Or simply:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">7.0</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8e0dc131413e9b6e0715d3d92cb4d8da"># config/application.rb

config.load_defaults 7.0
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8e0dc131413e9b6e0715d3d92cb4d8da">Copiar</button>
</div>
<p>However Rails 6.1 applications are not able to read this new serialization format,
so to ensure a seamless upgrade you must first deploy your Rails 7.0 upgrade with
<code>config.active_support.cache_format_version = 6.1</code>, and then only once all Rails
processes have been updated you can set <code>config.active_support.cache_format_version = 7.0</code>.</p><p>Rails 7.0 is able to read both formats so the cache won't be invalidated during the
upgrade.</p><h4 id="active-storage-video-preview-image-generation"><a class="anchorlink" href="#active-storage-video-preview-image-generation">2.13 Active Storage video preview image generation</a></h4><p>Video preview image generation now uses FFmpeg's scene change detection to generate
more meaningful preview images. Previously the first frame of the video would be used
and that caused problems if the video faded in from black. This change requires
FFmpeg v3.4+.</p><h4 id="active-storage-default-variant-processor-changed-to-vips"><a class="anchorlink" href="#active-storage-default-variant-processor-changed-to-vips">2.14 Active Storage default variant processor changed to <code>:vips</code></a></h4><p>For new apps, image transformation will use libvips instead of ImageMagick. This will reduce
the time taken to generate variants as well as CPU and memory usage, improving response
times in apps that rely on active storage to serve their images.</p><p>The <code>:mini_magick</code> option is not being deprecated, so it is fine to keep using it.</p><p>To migrate an existing app to libvips, set:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">variant_processor</span> <span class="o">=</span> <span class="ss">:vips</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b9ea05f7a371417a2919cc323dbbf85c">Rails.application.config.active_storage.variant_processor = :vips
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b9ea05f7a371417a2919cc323dbbf85c">Copiar</button>
</div>
<p>You will then need to change existing image transformation code to the
<code>image_processing</code> macros, and replace ImageMagick's options with libvips' options.</p><h5 id="replace-resize-with-resize-to-limit"><a class="anchorlink" href="#replace-resize-with-resize-to-limit">2.14.1 Replace resize with resize_to_limit</a></h5><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(resize: "100x")
</span><span class="gi">+ variant(resize_to_limit: [100, nil])
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-4ab9e1e38b7178359293036c348763e7">- variant(resize: "100x")
+ variant(resize_to_limit: [100, nil])
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4ab9e1e38b7178359293036c348763e7">Copiar</button>
</div>
<p>If you don't do this, when you switch to vips you will see this error: <code>no implicit conversion to float from string</code>.</p><h5 id="use-an-array-when-cropping"><a class="anchorlink" href="#use-an-array-when-cropping">2.14.2 Use an array when cropping</a></h5><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(crop: "1920x1080+0+0")
</span><span class="gi">+ variant(crop: [0, 0, 1920, 1080])
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-e2fdc825942d444ab662f7e1998462a8">- variant(crop: "1920x1080+0+0")
+ variant(crop: [0, 0, 1920, 1080])
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e2fdc825942d444ab662f7e1998462a8">Copiar</button>
</div>
<p>If you don't do this when migrating to vips, you will see the following error: <code>unable to call crop: you supplied 2 arguments, but operation needs 5</code>.</p><h5 id="clamp-your-crop-values"><a class="anchorlink" href="#clamp-your-crop-values">2.14.3 Clamp your crop values:</a></h5><p>Vips is more strict than ImageMagick when it comes to cropping:</p>
<ol>
<li>It will not crop if <code>x</code> and/or <code>y</code> are negative values. e.g.: <code>[-10, -10, 100, 100]</code>
</li>
<li>It will not crop if position (<code>x</code> or <code>y</code>) plus crop dimension (<code>width</code>, <code>height</code>) is larger than the image. e.g.: a 125x125 image and a crop of <code>[50, 50, 100, 100]</code>
</li>
</ol>
<p>If you don't do this when migrating to vips, you will see the following error: <code>extract_area: bad extract area</code></p><h5 id="adjust-the-background-color-used-for-resize-and-pad"><a class="anchorlink" href="#adjust-the-background-color-used-for-resize-and-pad">2.14.4 Adjust the background color used for <code>resize_and_pad</code></a></h5><p>Vips uses black as the default background color <code>resize_and_pad</code>, instead of white like ImageMagick. Fix that by using the <code>background</code> option:</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(resize_and_pad: [300, 300])
</span><span class="gi">+ variant(resize_and_pad: [300, 300, background: [255]])
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-f71216d8dc951bc9ee77d0780cf2c1be">- variant(resize_and_pad: [300, 300])
+ variant(resize_and_pad: [300, 300, background: [255]])
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f71216d8dc951bc9ee77d0780cf2c1be">Copiar</button>
</div>
<h5 id="remove-any-exif-based-rotation"><a class="anchorlink" href="#remove-any-exif-based-rotation">2.14.5 Remove any EXIF based rotation</a></h5><p>Vips will auto rotate images using the EXIF value when processing variants. If you were storing rotation values from user uploaded photos to apply rotation with ImageMagick, you must stop doing that:</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(format: :jpg, rotate: rotation_value)
</span><span class="gi">+ variant(format: :jpg)
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-d569b246218e9498a0a841de3ede1a41">- variant(format: :jpg, rotate: rotation_value)
+ variant(format: :jpg)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d569b246218e9498a0a841de3ede1a41">Copiar</button>
</div>
<h5 id="replace-monochrome-with-colourspace"><a class="anchorlink" href="#replace-monochrome-with-colourspace">2.14.6 Replace monochrome with colourspace</a></h5><p>Vips uses a different option to make monochrome images:</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(monochrome: true)
</span><span class="gi">+ variant(colourspace: "b-w")
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-602279208064722da07ff8600d6f8b56">- variant(monochrome: true)
+ variant(colourspace: "b-w")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-602279208064722da07ff8600d6f8b56">Copiar</button>
</div>
<h5 id="switch-to-libvips-options-for-compressing-images"><a class="anchorlink" href="#switch-to-libvips-options-for-compressing-images">2.14.7 Switch to libvips options for compressing images</a></h5><p>JPEG</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(strip: true, quality: 80, interlace: "JPEG", sampling_factor: "4:2:0", colorspace: "sRGB")
</span><span class="gi">+ variant(saver: { strip: true, quality: 80, interlace: true })
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-e72f4691d4d7cb9d888d525804ddcb53">- variant(strip: true, quality: 80, interlace: "JPEG", sampling_factor: "4:2:0", colorspace: "sRGB")
+ variant(saver: { strip: true, quality: 80, interlace: true })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e72f4691d4d7cb9d888d525804ddcb53">Copiar</button>
</div>
<p>PNG</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(strip: true, quality: 75)
</span><span class="gi">+ variant(saver: { strip: true, compression: 9 })
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-634a1ac58513ccbbb5fe6c20cd34801e">- variant(strip: true, quality: 75)
+ variant(saver: { strip: true, compression: 9 })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-634a1ac58513ccbbb5fe6c20cd34801e">Copiar</button>
</div>
<p>WEBP</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(strip: true, quality: 75, define: { webp: { lossless: false, alpha_quality: 85, thread_level: 1 } })
</span><span class="gi">+ variant(saver: { strip: true, quality: 75, lossless: false, alpha_q: 85, reduction_effort: 6, smart_subsample: true })
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-1fb47fec290a2ee20283d30c35714092">- variant(strip: true, quality: 75, define: { webp: { lossless: false, alpha_quality: 85, thread_level: 1 } })
+ variant(saver: { strip: true, quality: 75, lossless: false, alpha_q: 85, reduction_effort: 6, smart_subsample: true })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1fb47fec290a2ee20283d30c35714092">Copiar</button>
</div>
<p>GIF</p><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(layers: "Optimize")
</span><span class="gi">+ variant(saver: { optimize_gif_frames: true, optimize_gif_transparency: true })
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-f2a91f11e23417180b51a6938d93aac3">- variant(layers: "Optimize")
+ variant(saver: { optimize_gif_frames: true, optimize_gif_transparency: true })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f2a91f11e23417180b51a6938d93aac3">Copiar</button>
</div>
<h5 id="deploy-to-production"><a class="anchorlink" href="#deploy-to-production">2.14.8 Deploy to production</a></h5><p>Active Storage encodes into the url for the image the list of transformations that must be performed.
If your app is caching these urls, your images will break after you deploy the new code to production.
Because of this you must manually invalidate your affected cache keys.</p><p>For example, if you have something like this in a view:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">cache</span> <span class="n">product</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">product</span><span class="p">.</span><span class="nf">cover_photo</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"200x"</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-52528b7bf147b56d1e885b7bd30d4afa">&lt;% @products.each do |product| %&gt;
  &lt;% cache product do %&gt;
    &lt;%= image_tag product.cover_photo.variant(resize: "200x") %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-52528b7bf147b56d1e885b7bd30d4afa">Copiar</button>
</div>
<p>You can invalidate the cache either by touching the product, or changing the cache key:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">cache</span> <span class="p">[</span><span class="s2">"v2"</span><span class="p">,</span> <span class="n">product</span><span class="p">]</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">product</span><span class="p">.</span><span class="nf">cover_photo</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="kp">nil</span><span class="p">])</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9335290a2fa9d77c532aa8d6c610a0e2">&lt;% @products.each do |product| %&gt;
  &lt;% cache ["v2", product] do %&gt;
    &lt;%= image_tag product.cover_photo.variant(resize_to_limit: [200, nil]) %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9335290a2fa9d77c532aa8d6c610a0e2">Copiar</button>
</div>
<h3 id="atualizando-do-rails-6-0-para-o-rails-6-1"><a class="anchorlink" href="#atualizando-do-rails-6-0-para-o-rails-6-1">3 Atualizando do Rails 6.0 para o Rails 6.1</a></h3><p>Para mais informa√ß√µes sobre as mudan√ßas feitas no Rails 6.1 consulte as <a href="6_1_release_notes.html">notas de lan√ßamento</a>.</p><h4 id="rails-application-config-for-o-valor-de-retorno-nao-oferece-mais-suporte-para-acesso-com-chaves-string"><a class="anchorlink" href="#rails-application-config-for-o-valor-de-retorno-nao-oferece-mais-suporte-para-acesso-com-chaves-string">3.1 <code>Rails.application.config_for</code> o valor de retorno n√£o oferece mais suporte para acesso com chaves <em>String</em>.</a></h4><p>Dado um arquivo de configura√ß√£o como este:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="c1"># config/example.yml</span>
<span class="na">development</span><span class="pi">:</span>
  <span class="na">options</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s">value</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7962a2aba80fa6f9b01f7356c6fab302"># config/example.yml
development:
  options:
    key: value
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7962a2aba80fa6f9b01f7356c6fab302">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">options</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b3fabb4a4318d2150614f8ce41b49079">Rails.application.config_for(:example).options
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b3fabb4a4318d2150614f8ce41b49079">Copiar</button>
</div>
<p>Isso costumava retornar um <em>hash</em> no qual voc√™ podia acessar valores com chaves <em>String</em>. Isso foi descontinuado no 6.0 e agora n√£o funciona mais.</p><p>Voc√™ pode chamar <code>with_indifferent_access</code> no valor de retorno de<code>config_for</code> se ainda quiser acessar valores com chaves <em>String</em>, por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">with_indifferent_access</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'options'</span><span class="p">,</span> <span class="s1">'key'</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-df12757faa620adbc2ba511bd98224ad">Rails.application.config_for(:example).with_indifferent_access.dig('options', 'key')
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-df12757faa620adbc2ba511bd98224ad">Copiar</button>
</div>
<h4 id="respostas-do-tipo-de-conteudo-ao-utilizar-respond-to-any"><a class="anchorlink" href="#respostas-do-tipo-de-conteudo-ao-utilizar-respond-to-any">3.2 Respostas do tipo de conte√∫do ao utilizar <code>respond_to#any</code></a></h4><p>O cabe√ßalho (<em>header</em>) do tipo de conte√∫do (<em>Content-Type</em>) retornado na resposta pode ser diferente do que o Rails 6.0 retornou,
mais especificamente se sua aplica√ß√£o usa o formato <code>respond_to { |format| format.any }</code>.
O tipo de conte√∫do ser√° baseado no bloco fornecido e n√£o no formato da solicita√ß√£o.</p><p>Exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">my_action</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span> <span class="n">render</span><span class="p">(</span><span class="ss">json: </span><span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">})</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1a9158ef9d5e8b9af34d6e00424c58e0">def my_action
  respond_to do |format|
    format.any { render(json: { foo: 'bar' }) }
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1a9158ef9d5e8b9af34d6e00424c58e0">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span><span class="p">(</span><span class="s1">'my_action.csv'</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8335a7e213628773d45f152a22a79d9b">get('my_action.csv')
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8335a7e213628773d45f152a22a79d9b">Copiar</button>
</div>
<p>O comportamento anterior era retornar um tipo de conte√∫do de resposta <code>text/csv</code> que √© impreciso uma vez que uma resposta JSON est√° sendo renderizada.
O comportamento atual retorna corretamente o tipo de conte√∫do de uma resposta <code>application/json</code>.</p><p>Se sua aplica√ß√£o depende do comportamento incorreto anterior, voc√™ √© incentivado a especificar
quais formatos sua a√ß√£o aceita, ou seja.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">format</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="ss">:xml</span><span class="p">,</span> <span class="ss">:json</span><span class="p">)</span> <span class="p">{</span> <span class="n">render</span> <span class="n">request</span><span class="p">.</span><span class="nf">format</span><span class="p">.</span><span class="nf">to_sym</span> <span class="o">=&gt;</span> <span class="vi">@people</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-984a01b7bc83372355cce7052b122726">format.any(:xml, :json) { render request.format.to_sym =&gt; @people }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-984a01b7bc83372355cce7052b122726">Copiar</button>
</div>
<h4 id="activesupport-callbacks-halted-callback-hook-agora-recebe-um-segundo-argumento"><a class="anchorlink" href="#activesupport-callbacks-halted-callback-hook-agora-recebe-um-segundo-argumento">3.3 <code>ActiveSupport::Callbacks#halted_callback_hook</code> agora recebe um segundo argumento</a></h4><p><em>Active Support</em> permite que voc√™ substitua o <code>halted_callback_hook</code> sempre que um retorno de chamada
pare a sequ√™ncia. Este m√©todo agora recebe um segundo argumento que √© o nome do retorno de chamada que est√° sendo interrompido.
Se voc√™ tiver classes que substituem esse m√©todo, certifique-se de que ele aceite dois argumentos. Observe que isso √© uma mudan√ßa
significativa sem um ciclo de deprecia√ß√£o anterior (por motivos de desempenho).</p><p>Exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before_create</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">halted_callback_hook</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">callback_name</span><span class="p">)</span> <span class="c1"># =&gt; Este m√©todo agora aceita 2 argumentos em vez de 1</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Book couldn't be </span><span class="si">#{</span><span class="n">callback_name</span><span class="si">}</span><span class="s2">d"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-53e6ef3df2aa40d0f22b592f5f451238">class Book &lt; ApplicationRecord
  before_save { throw(:abort) }
  before_create { throw(:abort) }

  def halted_callback_hook(filter, callback_name) # =&gt; Este m√©todo agora aceita 2 argumentos em vez de 1
    Rails.logger.info("Book couldn't be #{callback_name}d")
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-53e6ef3df2aa40d0f22b592f5f451238">Copiar</button>
</div>
<h4 id="o-metodo-de-classe-helper-nos-controllers-usa-string-constantize"><a class="anchorlink" href="#o-metodo-de-classe-helper-nos-controllers-usa-string-constantize">3.4 O m√©todo de classe <code>helper</code> nos <em>controllers</em> usa <code>String#constantize</code></a></h4><p>Conceitualmente antes do Rails 6.1</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">helper</span> <span class="s2">"foo/bar"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bc0852a0dc485b0f7069fddd96498ea8">helper "foo/bar"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bc0852a0dc485b0f7069fddd96498ea8">Copiar</button>
</div>
<p>resultou em</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">require_dependency</span> <span class="s2">"foo/bar_helper"</span>
<span class="n">module_name</span> <span class="o">=</span> <span class="s2">"foo/bar_helper"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="n">module_name</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-00b305da61e96be3e57c3886aeab4d62">require_dependency "foo/bar_helper"
module_name = "foo/bar_helper".camelize
module_name.constantize
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-00b305da61e96be3e57c3886aeab4d62">Copiar</button>
</div>
<p>Agora ele faz isso:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">prefix</span> <span class="o">=</span> <span class="s2">"foo/bar"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Helper"</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-637dd2d6c4e058ba9ec2fa5a83dc296a">prefix = "foo/bar".camelize
"#{prefix}Helper".constantize
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-637dd2d6c4e058ba9ec2fa5a83dc296a">Copiar</button>
</div>
<p>Essa mudan√ßa √© compat√≠vel com as vers√µes anteriores para a maioria das aplica√ß√µes, nesse caso, voc√™ n√£o precisa fazer nada.</p><p>Tecnicamente, no entanto, os controllers podem configurar <code>helpers_path</code> para apontar para um diret√≥rio em <code>$LOAD_PATH</code> que n√£o estava nos caminhos de carregamento autom√°tico. Esse caso de uso n√£o √© mais compat√≠vel com o uso imediato. Se o m√≥dulo auxiliar n√£o for auto-carreg√°vel, a aplica√ß√£o √© respons√°vel por carreg√°-lo antes de chamar o <code>helper</code>.</p><h4 id="redirecionamento-para-https-vindo-de-http-agora-usara-o-codigo-de-status-308-http"><a class="anchorlink" href="#redirecionamento-para-https-vindo-de-http-agora-usara-o-codigo-de-status-308-http">3.5 Redirecionamento para HTTPS vindo de HTTP agora usar√° o c√≥digo de status 308 HTTP</a></h4><p>O c√≥digo de status HTTP padr√£o usado em <code>ActionDispatch::SSL</code> ao redirecionar solicita√ß√µes n√£o GET/HEAD de HTTP para HTTPS foi alterado para <code>308</code> conforme definido em <a href="https://tools.ietf.org/html/rfc7538">https://tools.ietf.org/html/rfc7538</a>.</p><h4 id="active-storage-agora-requer-processamento-de-imagem"><a class="anchorlink" href="#active-storage-agora-requer-processamento-de-imagem">3.6 Active Storage agora requer Processamento de Imagem</a></h4><p>Ao processar variantes no Active Storage, agora √© necess√°rio ter a <em>gem</em> <a href="https://github.com/janko-m/image_processing">image_processing</a> empacotada em vez de usar diretamente <code>mini_magick</code>. O processamento de imagem √© configurado por padr√£o para usar <code>mini_magick</code> nos bastidores, ent√£o a maneira mais f√°cil de atualizar √© substituindo a gem <code>mini_magick</code> pela gem <code>image_processing</code> e certificando-se de remover o uso expl√≠cito de <code>combine_options</code>, uma vez que n√£o √© mais necess√°rio.</p><p>Para facilitar a leitura, voc√™ pode desejar alterar as chamadas <code>resize</code> brutas para macros <code>image_processing</code>. Por exemplo, em vez de:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100&gt;"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100^"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ffdffe0173eb9246a8b545d2f76de122">video.preview(resize: "100x100")
video.preview(resize: "100x100&gt;")
video.preview(resize: "100x100^")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ffdffe0173eb9246a8b545d2f76de122">Copiar</button>
</div>
<p>voc√™ pode fazer respectivamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-37d582d41e83b30eb3ed52012ba28717">video.preview(resize_to_fit: [100, 100])
video.preview(resize_to_limit: [100, 100])
video.preview(resize_to_fill: [100, 100])
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-37d582d41e83b30eb3ed52012ba28717">Copiar</button>
</div>
<h3 id="atualizando-do-rails-5-2-para-o-rails-6-0"><a class="anchorlink" href="#atualizando-do-rails-5-2-para-o-rails-6-0">4 Atualizando do Rails 5.2 para o Rails 6.0</a></h3><p>Para mais informa√ß√µes sobre as mudan√ßas feitas no Rails 6.0 consulte as <a href="6_0_release_notes.html">notas de lan√ßamento</a>.</p><h4 id="usando-webpacker"><a class="anchorlink" href="#usando-webpacker">4.1 Usando Webpacker</a></h4><p><a href="https://github.com/rails/webpacker">Webpacker</a>
√© o compilador <em>JavaScript</em> padr√£o para Rails 6. Mas se voc√™ estiver atualizando a aplica√ß√£o, ele n√£o √© ativado por padr√£o.
Se voc√™ quiser usar o <em>Webpacker</em>, adicione ele em seu <em>Gemfile</em> e instale:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"webpacker"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4edfdbffe2923f6234b7e4b66b736cdc">gem "webpacker"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4edfdbffe2923f6234b7e4b66b736cdc">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>webpacker:install
</code></pre>
<textarea class="clipboard-content" id="clipboard-ba1b66e1df00610a345e19b5a93fb93b">bin/rails webpacker:install
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ba1b66e1df00610a345e19b5a93fb93b">Copiar</button>
</div>
<h4 id="forcar-ssl"><a class="anchorlink" href="#forcar-ssl">4.2 For√ßar SSL</a></h4><p>O m√©todo <code>force_ssl</code> nos <em>controllers</em> foi descontinuado e ser√° removido no
Rails 6.1. Voc√™ √© encorajado a habilitar <code>config.force_ssl</code> para impor conex√µes
HTTPS ao longo de sua aplica√ß√£o. Se voc√™ precisar isentar certos <em>endpoints</em>
do redirecionamento, voc√™ pode usar <code>config.ssl_options</code> para configurar esse comportamento.</p><h4 id="proposito-purpose-e-metadados-de-expiracao-agora-estao-incorporados-em-cookies-assinados-e-criptografados-para-maior-seguranca"><a class="anchorlink" href="#proposito-purpose-e-metadados-de-expiracao-agora-estao-incorporados-em-cookies-assinados-e-criptografados-para-maior-seguranca">4.3 Prop√≥sito (<em>Purpose</em>) e metadados de expira√ß√£o agora est√£o incorporados em cookies assinados e criptografados para maior seguran√ßa</a></h4><p>Para melhorar a seguran√ßa, o Rails incorpora os metadados de prop√≥sito e expira√ß√£o dentro do valor de cookies criptografados ou assinados.</p><p>Rails pode ent√£o impedir ataques que tentam copiar o valor assinado/criptografado
de um <em>cookie</em> e us√°-lo como o valor de outro <em>cookie</em>.</p><p>Esses novos metadados incorporados tornam esses <em>cookies</em> incompat√≠veis com vers√µes do Rails anteriores a 6.0.</p><p>Se voc√™ deseja que seus <em>cookies</em> sejam lidos pelo Rails 5.2 e anteriores, ou ainda est√° validando seu <em>deploy</em> do 6.0 e deseja ser capaz de reverter (<em>rollback</em>)
<code>Rails.application.config.action_dispatch.use_cookies_with_metadata</code> para <code>false</code>.</p><h4 id="todos-os-pacotes-npm-foram-movidos-para-o-escopo-rails"><a class="anchorlink" href="#todos-os-pacotes-npm-foram-movidos-para-o-escopo-rails">4.4 Todos os pacotes npm foram movidos para o escopo <code>@rails</code></a></h4><p>Se voc√™ estava anteriormente carregando qualquer um dos pacotes <code>actioncable</code>, <code>activestorage</code>,
ou <code>rails-ujs</code> atrav√©s de npm/yarn, voc√™ deve atualizar os nomes destas
depend√™ncias antes de atualiz√°-los para o <code>6.0.0</code>:</p><div class="code_container">
<pre><code class="highlight plaintext">actioncable   ‚Üí @rails/actioncable
activestorage ‚Üí @rails/activestorage
rails-ujs     ‚Üí @rails/ujs
</code></pre>
<textarea class="clipboard-content" id="clipboard-50a819fbf3558013e462f1972fc85a39">actioncable   ‚Üí @rails/actioncable
activestorage ‚Üí @rails/activestorage
rails-ujs     ‚Üí @rails/ujs
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-50a819fbf3558013e462f1972fc85a39">Copiar</button>
</div>
<h4 id="mudancas-na-api-do-action-cable-javascript"><a class="anchorlink" href="#mudancas-na-api-do-action-cable-javascript">4.5 Mudan√ßas na API do <em>Action Cable JavaScript</em></a></h4><p>O pacote <em>Action Cable JavaScript</em> foi convertido do <em>CoffeeScript</em>
para <em>ES2015</em>, e agora publicamos o c√≥digo-fonte via distribui√ß√£o pelo npm.</p><p>Esta vers√£o inclui algumas mudan√ßas importantes para partes opcionais da
<em>API JavaScript Action Cable</em>:</p>
<ul>
<li>
<p>A configura√ß√£o do adaptador <em>WebSocket</em> e do adaptador <em>logger</em> foi movida
das propriedades de <code>ActionCable</code> para as propriedades de <code>ActionCable.adapters</code>.
Se voc√™ estiver configurando esses adaptadores, voc√™ precisar√° fazer
estas altera√ß√µes:</p>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.WebSocket = MyWebSocket
</span><span class="gi">+    ActionCable.adapters.WebSocket = MyWebSocket
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-6c0c0db811d0b64e6f97716904d757be">-    ActionCable.WebSocket = MyWebSocket
+    ActionCable.adapters.WebSocket = MyWebSocket
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6c0c0db811d0b64e6f97716904d757be">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.logger = myLogger
</span><span class="gi">+    ActionCable.adapters.logger = myLogger
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-78bce3677a6a25a4e7362f43652820f8">-    ActionCable.logger = myLogger
+    ActionCable.adapters.logger = myLogger
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-78bce3677a6a25a4e7362f43652820f8">Copiar</button>
</div>
</li>
<li>
<p>Os m√©todos <code>ActionCable.startDebugging()</code> e <code>ActionCable.stopDebugging()</code>
foram movidos e substitu√≠dos pela propriedade
<code>ActionCable.logger.enabled</code>. Se voc√™ estiver usando esse m√©todos, voc√™
precisar√° fazer estas altera√ß√µes:</p>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.startDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = true
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-29719a9206c542bc4f7b7daeddb024c2">-    ActionCable.startDebugging()
+    ActionCable.logger.enabled = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-29719a9206c542bc4f7b7daeddb024c2">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.stopDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = false
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-eb7b9a81e1c11ddec160af654e9bbfc0">-    ActionCable.stopDebugging()
+    ActionCable.logger.enabled = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-eb7b9a81e1c11ddec160af654e9bbfc0">Copiar</button>
</div>
</li>
</ul>
<h4 id="actiondispatch-response-content-type-agora-retorna-o-cabecalho-header-do-tipo-de-conteudo-content-type-sem-modificacao"><a class="anchorlink" href="#actiondispatch-response-content-type-agora-retorna-o-cabecalho-header-do-tipo-de-conteudo-content-type-sem-modificacao">4.6 <code>ActionDispatch::Response#content_type</code> agora retorna o cabe√ßalho (<em>header</em>) do tipo de conte√∫do (<em>Content-Type</em>) sem modifica√ß√£o</a></h4><p>Anteriormente, o valor de retorno de <code>ActionDispatch::Response#content_type</code> N√ÉO continha a parte do conjunto de caracteres.
Este comportamento foi alterado para incluir tamb√©m a parte do conjunto de caracteres omitida anteriormente.</p><p>Se voc√™ quiser apenas o tipo <em>MIME</em>, use <code>ActionDispatch::Response#media_type</code> em seu lugar.</p><p>Antes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-be254a70f5b7efce258ec8a782579f39">resp = ActionDispatch::Response.new(200, "Content-Type" =&gt; "text/csv; header=present; charset=utf-16")
resp.content_type #=&gt; "text/csv; header=present"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-be254a70f5b7efce258ec8a782579f39">Copiar</button>
</div>
<p>Depois:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b06068aaea8b0b73772f418a107d65e8">resp = ActionDispatch::Response.new(200, "Content-Type" =&gt; "text/csv; header=present; charset=utf-16")
resp.content_type #=&gt; "text/csv; header=present; charset=utf-16"
resp.media_type   #=&gt; "text/csv"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b06068aaea8b0b73772f418a107d65e8">Copiar</button>
</div>
<h4 id="carregamento-automatico"><a class="anchorlink" href="#carregamento-automatico">4.7 Carregamento Autom√°tico</a></h4><p>A configura√ß√£o padr√£o para Rails 6</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6c963c37de6dde744f8d009063def703"># config/application.rb

config.load_defaults 6.0
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6c963c37de6dde744f8d009063def703">Copiar</button>
</div>
<p>ativa o modo de carregamento autom√°tico <code>zeitwerk</code> no CRuby. Nesse modo, o carregamento autom√°tico, o recarregamento e o carregamento antecipado s√£o gerenciados pelo <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a>.</p><p>Se voc√™ estiver usando os padr√µes de uma vers√£o anterior do Rails, voc√™ pode habilitar o zeitwerk assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:zeitwerk</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e0a872f0b28a333586081f325dcc4f65"># config/application.rb

config.autoloader = :zeitwerk
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e0a872f0b28a333586081f325dcc4f65">Copiar</button>
</div>
<h5 id="api-publica"><a class="anchorlink" href="#api-publica">4.7.1 API P√∫blica</a></h5><p>Em geral, as aplica√ß√µes n√£o precisam usar a API do <em>Zeitwerk</em> diretamente. Rails configura as coisas de acordo com o contrato existente: <code>config.autoload_paths</code>,<code>config.cache_classes</code>, etc.</p><p>Embora as aplica√ß√µes devam seguir essa interface, o objeto do carregador <em>Zeitwerk</em> atual pode ser acessado como</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-577d72d559e3130cd579e62e56281f24">Rails.autoloaders.main
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-577d72d559e3130cd579e62e56281f24">Copiar</button>
</div>
<p>Isso pode ser √∫til se voc√™ precisar pr√©-carregar classes com heran√ßa de tabela √∫nica (Single Table Inheritance - STIs) ou configurar um <em>inflector</em> customizado, por exemplo.</p><h5 id="estrutura-do-projeto"><a class="anchorlink" href="#estrutura-do-projeto">4.7.2 Estrutura do Projeto</a></h5><p>Se a aplica√ß√£o que est√° sendo atualizada for carregada automaticamente de forma correta, a estrutura do projeto j√° deve ser compat√≠vel.</p><p>No entanto, o modo <code>cl√°ssico</code> entende nomes de arquivos com (<code>underscore</code>), enquanto o modo <code>zeitwerk</code> entende nomes de arquivos (<code>camelize</code>). Esses <em>helpers</em> nem sempre s√£o inversos entre si, especialmente se houver acr√¥nimos envolvidos. Por exemplo, <code>"FOO".underscore</code> √© <code>"foo"</code>, mas <code>"foo".camelize</code> √© <code>"Foo"</code>, n√£o <code>"FOO "</code>.</p><p>A compatibilidade pode ser verificada com a tarefa <code>zeitwerk:check</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>zeitwerk:check
<span class="go">Hold on, I am eager loading the application.
All is good!
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-4dfed1d6fae07be4bb6657ce9eba5cf4">bin/rails zeitwerk:check
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4dfed1d6fae07be4bb6657ce9eba5cf4">Copiar</button>
</div>
<h5 id="require-dependency"><a class="anchorlink" href="#require-dependency">4.7.3 <em>require_dependency</em></a></h5><p>Todos os casos de uso conhecidos de <code>require_dependency</code> foram eliminados, voc√™ deve executar o <em>grep</em> no projeto e exclu√≠-los.</p><p>Se sua aplica√ß√£o usa heran√ßa de tabela √∫nica (STI), consulte a <a href="autoloading_and_reloading_constants.html#single-table-inheritance">se√ß√£o Heran√ßa de tabela √∫nica</a> do guia Autoloading and Reloading Constants (Zeitwerk Mode).</p><h5 id="nomes-qualificados-nas-definicoes-de-classe-e-modulo"><a class="anchorlink" href="#nomes-qualificados-nas-definicoes-de-classe-e-modulo">4.7.4 Nomes qualificados nas defini√ß√µes de classe e m√≥dulo</a></h5><p>Agora voc√™ pode usar <em>constant paths</em> de forma robusta nas defini√ß√µes de classe e m√≥dulo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># O carregamento autom√°tico no corpo desta classe corresponde √† sem√¢ntica Ruby agora.</span>
<span class="k">class</span> <span class="nc">Admin::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-aaa96f05cf75712f4eaffb76807feebe"># O carregamento autom√°tico no corpo desta classe corresponde √† sem√¢ntica Ruby agora.
class Admin::UsersController &lt; ApplicationController
  # ...
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-aaa96f05cf75712f4eaffb76807feebe">Copiar</button>
</div>
<p>Um problema a ter em conta √© que, dependendo da ordem de execu√ß√£o, o auto carregamento cl√°ssico pode √†s vezes ser capaz de carregar automaticamente <code>Foo::Wadus</code> em</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Wadus</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5be734c3f2b21c79dc47c44e7fb266d8">class Foo::Bar
  Wadus
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5be734c3f2b21c79dc47c44e7fb266d8">Copiar</button>
</div>
<p>Isso n√£o corresponde √† sem√¢ntica Ruby porque <code>Foo</code> n√£o est√° no aninhamento e n√£o funcionar√° no modo <code>zeitwerk</code>. Se voc√™ encontrar esse caso, voc√™ pode usar o nome qualificado <code>Foo::Wadus</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Foo::Wadus</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3afc584ee775e86308bd753b9ffaa5b1">class Foo::Bar
  Foo::Wadus
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3afc584ee775e86308bd753b9ffaa5b1">Copiar</button>
</div>
<p>ou adicione <code>Foo</code> ao aninhamento:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Foo</span>
  <span class="k">class</span> <span class="nc">Bar</span>
    <span class="no">Wadus</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-48570992cf19b14ca8c1fe6dc6bef6c0">module Foo
  class Bar
    Wadus
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-48570992cf19b14ca8c1fe6dc6bef6c0">Copiar</button>
</div>
<h5 id="concerns"><a class="anchorlink" href="#concerns">4.7.5 (<em>Concerns</em>)</a></h5><p>Voc√™ pode carregar automaticamente e antecipadamente a partir de uma estrutura padr√£o como</p><div class="code_container">
<pre><code class="highlight plaintext">app/models
app/models/concerns
</code></pre>
<textarea class="clipboard-content" id="clipboard-e2ffe88ab0b6c870fbcf78da00f6bb58">app/models
app/models/concerns
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e2ffe88ab0b6c870fbcf78da00f6bb58">Copiar</button>
</div>
<p>Nesse caso, <code>app/models/concerns</code> √© considerado um diret√≥rio raiz (porque pertence aos caminhos de carregamento autom√°tico) e √© ignorado como <em>namespace</em>. Portanto, <code>app/models/concern/foo.rb</code> deve definir <code>Foo</code>, n√£o <code>Concerns::Foo</code>.</p><p>O <em>namespace</em> <code>Concerns::</code> funcionou com o carregamento autom√°tico cl√°ssico como um efeito colateral da implementa√ß√£o, mas n√£o foi realmente um comportamento pretendido. Uma aplica√ß√£o que usa <code>Concerns::</code> precisa renomear essas classes e m√≥dulos para poder rodar no modo <code>zeitwerk</code>.</p><h5 id="tendo-app-nos-caminhos-de-carregamento-automatico"><a class="anchorlink" href="#tendo-app-nos-caminhos-de-carregamento-automatico">4.7.6 Tendo <code>app</code> nos caminhos de carregamento autom√°tico</a></h5><p>Alguns projetos querem algo como <code>app/api/base.rb</code> para definir <code>API::Base</code>, e adicionar <code>app</code> aos caminhos de carregamento autom√°tico para fazer isso no modo <code>cl√°ssico</code>. J√° que Rails adiciona todos os subdiret√≥rios de <code>app</code> aos caminhos de carregamento autom√°tico automaticamente, temos outra situa√ß√£o em que h√° diret√≥rios raiz aninhados, de forma que a configura√ß√£o n√£o funciona mais. Princ√≠pio semelhante que explicamos acima com <code>concerns</code>.</p><p>Se quiser manter essa estrutura, voc√™ precisar√° excluir o subdiret√≥rio dos caminhos de carregamento autom√°tico em um inicializador:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">autoload_paths</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/app/api"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ceeaaea9191988a50ac01f2931f5d4fb">ActiveSupport::Dependencies.autoload_paths.delete("#{Rails.root}/app/api")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ceeaaea9191988a50ac01f2931f5d4fb">Copiar</button>
</div>
<h5 id="constantes-carregadas-automaticamente-e-namespaces-explicitos"><a class="anchorlink" href="#constantes-carregadas-automaticamente-e-namespaces-explicitos">4.7.7 Constantes carregadas automaticamente e <em>namespaces</em> expl√≠citos</a></h5><p>Se um <em>namespace</em> for definido em um arquivo, como <code>Hotel</code> est√° aqui:</p><div class="code_container">
<pre><code class="highlight plaintext">app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
</code></pre>
<textarea class="clipboard-content" id="clipboard-d3b679c4179a83c9173fbf668a1d8e6d">app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d3b679c4179a83c9173fbf668a1d8e6d">Copiar</button>
</div>
<p>a constante <code>Hotel</code> deve ser definida usando as palavras-chave <code>class</code> ou <code>module</code>. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Hotel</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a5fe1723d53f4d78f5454a4686308d6d">class Hotel
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a5fe1723d53f4d78f5454a4686308d6d">Copiar</button>
</div>
<p>√© bom.</p><p>Alternativas como</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-10371628917b45483f1f4f5613992e4d">Hotel = Class.new
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-10371628917b45483f1f4f5613992e4d">Copiar</button>
</div>
<p>ou</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6278d830065b260a2fb3d94ab3742d42">Hotel = Struct.new
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6278d830065b260a2fb3d94ab3742d42">Copiar</button>
</div>
<p>n√£o funcionar√°, objetos filhos como <code>Hotel::Pricing</code> n√£o ser√£o encontrados.</p><p>Essa restri√ß√£o se aplica apenas a <em>namespaces</em> expl√≠citos. Classes e m√≥dulos que n√£o definem um <em>namespace</em> podem ser definidos usando esses idiomas.</p><h5 id="um-arquivo-uma-constante-no-mesmo-nivel-superior"><a class="anchorlink" href="#um-arquivo-uma-constante-no-mesmo-nivel-superior">4.7.8 Um arquivo, uma constante (no mesmo n√≠vel superior)</a></h5><p>No modo <code>classic</code>, voc√™ pode definir tecnicamente v√°rias constantes no mesmo n√≠vel superior e ter todas elas recarregadas. Por exemplo, dado</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bar</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8b6cf7b320c5f212fcf90e77ae0b55e8"># app/models/foo.rb

class Foo
end

class Bar
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8b6cf7b320c5f212fcf90e77ae0b55e8">Copiar</button>
</div>
<p>enquanto <code>Bar</code> n√£o p√¥de ser carregado automaticamente, o carregamento autom√°tico de <code>Foo</code> marcaria <code>Bar</code> como carregado automaticamente tamb√©m. Este n√£o √© o caso no modo <code>zeitwerk</code>, voc√™ precisa mover <code>Bar</code> para seu pr√≥prio arquivo <code>bar.rb</code>. Um arquivo, uma constante.</p><p>Isso se aplica apenas as constantes no mesmo n√≠vel superior do exemplo acima. Classes e m√≥dulos internos s√£o adequados. Por exemplo, considere</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
  <span class="k">class</span> <span class="nc">InnerClass</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-77c02cef6688df7d56d058545f8ec9d1"># app/models/foo.rb

class Foo
  class InnerClass
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-77c02cef6688df7d56d058545f8ec9d1">Copiar</button>
</div>
<p>Se a aplica√ß√£o recarregar <code>Foo</code>, ela ir√° recarregar <code>Foo::InnerClass</code> tamb√©m.</p><h5 id="spring-e-o-ambiente-test"><a class="anchorlink" href="#spring-e-o-ambiente-test">4.7.9 <em>Spring</em> e o ambiente <code>test</code></a></h5><p><em>Spring</em> recarrega o c√≥digo da aplica√ß√£o se algo mudar. No ambiente <code>test</code>, voc√™ precisa habilitar o recarregamento para que funcione:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/environments/test.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">cache_classes</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-edc9661db12699294232b743649d8c2c"># config/environments/test.rb

config.cache_classes = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-edc9661db12699294232b743649d8c2c">Copiar</button>
</div>
<p>Caso contr√°rio, voc√™ obter√° este erro:</p><div class="code_container">
<pre><code class="highlight plaintext">reloading is disabled because config.cache_classes is true
</code></pre>
<textarea class="clipboard-content" id="clipboard-d71095044cb4c9383da752799d90b5a3">reloading is disabled because config.cache_classes is true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d71095044cb4c9383da752799d90b5a3">Copiar</button>
</div>
<h5 id="carregamento-automatico-bootsnap"><a class="anchorlink" href="#carregamento-automatico-bootsnap">4.7.10 <em>Bootsnap</em></a></h5><p>O <em>Bootsnap</em> deve ter pelo menos a vers√£o 1.4.2.</p><p>Al√©m disso, o <em>Bootsnap</em> precisa desabilitar o cache <em>iseq</em> devido a um bug no interpretador se estiver executando o Ruby 2.5. Certifique-se de depender de pelo menos Bootsnap 1.4.4 nesse caso.</p><h5 id="config-add-autoload-paths-to-load-path"><a class="anchorlink" href="#config-add-autoload-paths-to-load-path">4.7.11 <code>config.add_autoload_paths_to_load_path</code></a></h5><p>O novo ponto de configura√ß√£o</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">add_autoload_paths_to_load_path</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d1e6fbd92abcd6d22a233d61c70c73cd">config.add_autoload_paths_to_load_path
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d1e6fbd92abcd6d22a233d61c70c73cd">Copiar</button>
</div>
<p>√© <code>true</code> por padr√£o para compatibilidade com vers√µes anteriores, mas permite que voc√™ opte por n√£o adicionar os caminhos de carregamento autom√°tico a <code>$LOAD_PATH</code>.</p><p>Isso faz sentido na maioria das aplica√ß√µes, j√° que voc√™ nunca deve requerer um arquivo em <code>app/models</code>, por exemplo, e o <em>Zeitwerk</em> s√≥ usa nomes de arquivo absolutos internamente.</p><p>Ao optar pela exclus√£o, voc√™ otimiza as pesquisas ao <code>$LOAD_PATH</code> (menos diret√≥rios para verificar) e economiza o trabalho do <em>Bootsnap</em> e o consumo de mem√≥ria, j√° que n√£o √© necess√°rio construir um √≠ndice para esses diret√≥rios.</p><h5 id="thread-safety"><a class="anchorlink" href="#thread-safety">4.7.12 <em>Thread-safety</em></a></h5><p>No modo cl√°ssico, o carregamento autom√°tico constante n√£o √© <em>thread-safe</em>, embora o Rails tenha travas, por exemplo, para tornar as solicita√ß√µes da web <em>thread-safe</em> quando o carregamento autom√°tico est√° habilitado, como √© comum no ambiente de desenvolvimento.</p><p>O carregamento autom√°tico constante √© <em>thread-safe</em> no modo <code>zeitwerk</code>. Por exemplo, agora voc√™ pode carregar automaticamente em scripts <em>multi-threaded</em> executados pelo comando <code>runner</code>.</p><h5 id="globs-em-config-autoload-paths"><a class="anchorlink" href="#globs-em-config-autoload-paths">4.7.13 <em>Globs</em> em <em>config.autoload_paths</em></a></h5><p>Cuidado com configura√ß√µes como</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/**/"</span><span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f1168ac826b927250ad2aa7c64e0b043">config.autoload_paths += Dir["#{config.root}/lib/**/"]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f1168ac826b927250ad2aa7c64e0b043">Copiar</button>
</div>
<p>Cada elemento de <code>config.autoload_paths</code> deve representar o <em>namespace</em> de n√≠vel superior (<code>Object</code>) e eles n√£o podem ser aninhados em consequ√™ncia (com exce√ß√£o dos diret√≥rios <code>concerns</code> explicados acima).</p><p>Para corrigir isso, basta remover os curingas (<em>wildcards</em>):</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-838dcbd4b101d85a8e8d35711c5b0131">config.autoload_paths &lt;&lt; "#{config.root}/lib"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-838dcbd4b101d85a8e8d35711c5b0131">Copiar</button>
</div>
<h5 id="carregamento-rapido-eager-loading-e-carregamento-automatico-sao-consistentes"><a class="anchorlink" href="#carregamento-rapido-eager-loading-e-carregamento-automatico-sao-consistentes">4.7.14 Carregamento r√°pido (<em>Eager loading</em>) e carregamento autom√°tico s√£o consistentes</a></h5><p>No modo <code>cl√°ssico</code>, se <code>app/models/foo.rb</code> define <code>Bar</code>, voc√™ n√£o ser√° capaz de carregar automaticamente aquele arquivo, mas o carregamento r√°pido funcionar√° porque carrega os arquivos recursivamente √†s cegas. Isso pode ser uma fonte de erros se voc√™ testar as coisas primeiro com carregamento r√°pido; a execu√ß√£o pode falhar no carregamento autom√°tico posterior.</p><p>No modo <code>zeitwerk</code> ambos os modos de carregamento s√£o consistentes, eles falham e erram nos mesmos arquivos.</p><h5 id="como-usar-o-carregamento-automatico-classico-no-rails-6"><a class="anchorlink" href="#como-usar-o-carregamento-automatico-classico-no-rails-6">4.7.15 Como usar o Carregamento Autom√°tico Cl√°ssico no Rails 6</a></h5><p>As aplica√ß√µes podem carregar os padr√µes do Rails 6 e ainda usar o carregamento autom√°tico cl√°ssico definindo <code>config.autoloader</code> desta forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:classic</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a13ca7f29d823f0baa1c36f1bd6e09d6"># config/application.rb

config.load_defaults 6.0
config.autoloader = :classic
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a13ca7f29d823f0baa1c36f1bd6e09d6">Copiar</button>
</div>
<p>Ao usar o Carregamento Autom√°tico Cl√°ssico na aplica√ß√£o Rails 6, √© recomendado definir o n√≠vel de simultaneidade (<em>concurrency</em>) como 1 no ambiente de desenvolvimento, para os servidores web e processadores de segundo plano, devido √†s quest√µes de <em>thread-safety</em>.</p><h4 id="alteracao-de-comportamento-de-atribuicao-do-active-storage"><a class="anchorlink" href="#alteracao-de-comportamento-de-atribuicao-do-active-storage">4.8 Altera√ß√£o de comportamento de atribui√ß√£o do <em>Active Storage</em></a></h4><p>Com os padr√µes de configura√ß√£o para Rails 5.2, atribuir a uma cole√ß√£o de anexos declarados com <code>has_many_attached</code> acrescenta novos arquivos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:highlights</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-091dd8e444c8898e30316f74928e2ffa">class User &lt; ApplicationRecord
  has_many_attached :highlights
end

user.highlights.attach(filename: "funky.jpg", ...)
user.highlights.count # =&gt; 1

blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.update!(highlights: [ blob ])

user.highlights.count # =&gt; 2
user.highlights.first.filename # =&gt; "funky.jpg"
user.highlights.second.filename # =&gt; "town.jpg"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-091dd8e444c8898e30316f74928e2ffa">Copiar</button>
</div>
<p>Com os padr√µes de configura√ß√£o do Rails 6.0, atribuir a uma cole√ß√£o de anexos substitui os arquivos existentes em vez de anexar a eles. Isso corresponde ao comportamento do <em>Active Record</em> ao atribuir a uma associa√ß√£o de cole√ß√£o:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-19b762a7da0fdbbee38608ff514cc4dd">user.highlights.attach(filename: "funky.jpg", ...)
user.highlights.count # =&gt; 1

blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.update!(highlights: [ blob ])

user.highlights.count # =&gt; 1
user.highlights.first.filename # =&gt; "town.jpg"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-19b762a7da0fdbbee38608ff514cc4dd">Copiar</button>
</div>
<p><code>#attach</code> pode ser usado para adicionar novos anexos sem remover os existentes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-70225c2aba6edbea545ba42239bc2b8b">blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.highlights.attach(blob)

user.highlights.count # =&gt; 2
user.highlights.first.filename # =&gt; "funky.jpg"
user.highlights.second.filename # =&gt; "town.jpg"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-70225c2aba6edbea545ba42239bc2b8b">Copiar</button>
</div>
<p>As aplica√ß√µes existentes podem aceitar este novo comportamento definindo <code>config.active_storage.replace_on_assign_to_many</code> como <code>true</code>. O comportamento antigo ser√° descontinuado no Rails 7.0 e removido no Rails 7.1.</p><h3 id="atualizando-do-rails-5-1-para-o-rails-5-2"><a class="anchorlink" href="#atualizando-do-rails-5-1-para-o-rails-5-2">5 Atualizando do Rails 5.1 para o Rails 5.2</a></h3><p>Para mais informa√ß√µes sobre as mudan√ßas feitas no Rails 5.2 consulte as <a href="5_2_release_notes.html">notas de lan√ßamento</a>.</p><h4 id="atualizando-do-rails-5-1-para-o-rails-5-2-bootsnap"><a class="anchorlink" href="#atualizando-do-rails-5-1-para-o-rails-5-2-bootsnap">5.1 <em>Bootsnap</em></a></h4><p>Rails 5.2 adiciona a <em>gem bootsnap</em> no <a href="https://github.com/rails/rails/pull/29313">novo Gemfile</a>.
O comando <code>app:update</code> o configura em <code>boot.rb</code>. Se voc√™ quiser utiliz√°-lo, ent√£o adicione-o no Gemfile,
caso contr√°rio, mude o <code>boot.rb</code> para n√£o utilizar o <em>bootsnap</em>.</p><h4 id="a-expiracao-em-cookies-assinados-ou-criptografados-esta-agora-incorporada-nos-valores-dos-cookies"><a class="anchorlink" href="#a-expiracao-em-cookies-assinados-ou-criptografados-esta-agora-incorporada-nos-valores-dos-cookies">5.2 A expira√ß√£o em <em>cookies</em> assinados ou criptografados est√° agora incorporada nos valores dos <em>cookies</em></a></h4><p>Para melhorar a seguran√ßa, Rails agora incorpora as informa√ß√µes de expira√ß√£o tamb√©m no valor de cookies criptografados ou assinados.</p><p>Estas novas informa√ß√µes incorporadas tornam estes <em>cookies</em> incompat√≠veis com vers√µes do Rails mais antigas que 5.2.</p><p>Se voc√™ quer que seus cookies sejam lidos at√© 5.1 e anteriores, ou se ainda estiver validando seu <em>deploy</em> 5.2 e quiser permitir o <em>rollback</em> configure
 <code>Rails.application.config.action_dispatch.use_authenticated_cookie_encryption</code> para `false'.</p><h3 id="atualizando-do-rails-5-0-para-o-rails-5-1"><a class="anchorlink" href="#atualizando-do-rails-5-0-para-o-rails-5-1">6 Atualizando do Rails 5.0 para o Rails 5.1</a></h3><p>Para mais informa√ß√µes sobre as mudan√ßas feitas no Rails 5.1 consulte as <a href="5_1_release_notes.html">notas de lan√ßamento</a>.</p><h4 id="hashwithindifferentaccess-de-nivel-superior-esta-descontinuado"><a class="anchorlink" href="#hashwithindifferentaccess-de-nivel-superior-esta-descontinuado">6.1 <code>HashWithIndifferentAccess</code> de n√≠vel superior est√° descontinuado</a></h4><p>Se sua aplica√ß√£o usa a classe <code>HashWithIndifferentAccess</code> de n√≠vel superior, voc√™
 deve mover lentamente seu c√≥digo para usar <code>ActiveSupport::HashWithIndifferentAccess</code>.</p><p>Est√° apenas descontinuado, o que significa que seu c√≥digo n√£o quebrar√° no momento e nenhum aviso de descontinua√ß√£o ser√° exibido, mas esta constante ser√° removida no futuro.</p><p>Al√©m disso, se voc√™ tiver documentos <em>YAML</em> muito antigos contendo despejos (<em>dumps</em>) de tais objetos, pode ser necess√°rio carreg√°-los e despej√°-los novamente para ter certeza de que referenciam √† constante correta, e que carreg√°-los n√£o quebrar√° no futuro.</p><h4 id="application-secrets-agora-e-carregado-com-todas-as-chaves-como-simbolos"><a class="anchorlink" href="#application-secrets-agora-e-carregado-com-todas-as-chaves-como-simbolos">6.2 <code>application.secrets</code> agora √© carregado com todas as chaves como s√≠mbolos</a></h4><p>Se sua aplica√ß√£o armazena configura√ß√£o aninhada em <code>config/secrets.yml</code>, todas as chaves agora s√£o carregadas como s√≠mbolos, ent√£o o acesso usando <em>strings</em> deve ser alterado.</p><p>De:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="s2">"address"</span><span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2ad2696150e4b06bf5beefa17b94d634">Rails.application.secrets[:smtp_settings]["address"]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2ad2696150e4b06bf5beefa17b94d634">Copiar</button>
</div>
<p>Para:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="ss">:address</span><span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ecac845a4820ab1ff5466dd82b3bf160">Rails.application.secrets[:smtp_settings][:address]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ecac845a4820ab1ff5466dd82b3bf160">Copiar</button>
</div>
<h4 id="removido-suporte-obsoleto-para-text-e-nothing-em-render"><a class="anchorlink" href="#removido-suporte-obsoleto-para-text-e-nothing-em-render">6.3 Removido suporte obsoleto para <code>:text</code> e <code>:nothing</code> em <code>render</code></a></h4><p>Se seus <em>controllers</em> estiverem usando <code>render :text</code>, elas n√£o funcionar√£o mais. O novo m√©todo de renderiza√ß√£o de texto com o tipo MIME de <code>text/plain</code> √© usar <code>render :plain</code>.</p><p>Similarmente, <code>render :nothing</code> tamb√©m √© removido e voc√™ deve usar o m√©todo <code>head</code> para enviar respostas que contenham apenas cabe√ßalhos (<em>headers</em>). Por exemplo, <code>head :ok</code> envia uma resposta 200 sem corpo (<em>body</em>) para renderizar.</p><h4 id="removido-suporte-obsoleto-para-redirect-to-back"><a class="anchorlink" href="#removido-suporte-obsoleto-para-redirect-to-back">6.4 Removido suporte obsoleto para <code>redirect_to :back</code></a></h4><p>No Rails 5.0, <code>redirect_to :back</code> foi descontinuado. No Rails 5.1, foi removido completamente.</p><p>Como alternativa, use <code>redirect_back</code>. √â importante notar que <code>redirect_back</code> tamb√©m leva
uma op√ß√£o <code>fallback_location</code> que ser√° usada caso o <code>HTTP_REFERER</code> esteja faltando.</p><div class="code_container">
<pre><code class="highlight plaintext">redirect_back(fallback_location: root_path)
</code></pre>
<textarea class="clipboard-content" id="clipboard-a03cd1c574190b6b76bd3189c3ba8e77">redirect_back(fallback_location: root_path)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a03cd1c574190b6b76bd3189c3ba8e77">Copiar</button>
</div>
<h3 id="atualizando-do-rails-4-2-para-o-rails-5-0"><a class="anchorlink" href="#atualizando-do-rails-4-2-para-o-rails-5-0">7 Atualizando do Rails 4.2 para o Rails 5.0</a></h3><p>Para mais informa√ß√µes sobre as mudan√ßas feitas no Rails 5.0 consulte as <a href="5_0_release_notes.html">notas de lan√ßamento</a>.</p><h4 id="necessario-ruby-2-2-2"><a class="anchorlink" href="#necessario-ruby-2-2-2">7.1 Necess√°rio Ruby 2.2.2+</a></h4><p>Do Ruby on Rails 5.0 em diante, Ruby 2.2.2+ √© a √∫nica vers√£o do Ruby suportada.
Certifique-se de ter a vers√£o Ruby 2.2.2 ou superior, antes de prosseguir.</p><h4 id="active-record-models-agora-herdam-de-applicationrecord-por-padrao"><a class="anchorlink" href="#active-record-models-agora-herdam-de-applicationrecord-por-padrao">7.2 <em>Active Record Models</em> agora herdam de <em>ApplicationRecord</em> por padr√£o</a></h4><p>No Rails 4.2, um <em>Active Record model</em> herda de <code>ActiveRecord::Base</code>. No Rails 5.0,
todos os <em>models</em> s√£o herdados de <code>ApplicationRecord</code>.</p><p><code>ApplicationRecord</code> √© uma nova superclasse para todos os <em>models</em> da aplica√ß√£o, an√°logo ao que o
<code>ApplicationController</code> √© para os <em>controllers</em> em vez de <code>ActionController::Base</code>. Isso d√° as aplica√ß√µes um √∫nico local para configurar o comportamento dos <em>models</em>.</p><p>Ao atualizar do Rails 4.2 para o Rails 5.0, voc√™ precisa criar um arquivo <code>application_record.rb</code> em <code>app/models/</code> e adicionar o seguinte conte√∫do:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f28ecd08a7ae695b9d69ba0f38241954">class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f28ecd08a7ae695b9d69ba0f38241954">Copiar</button>
</div>
<p>Em seguida, certifique-se de que todos os seus <em>models</em> herdem dele.</p><h4 id="interrompendo-sequencias-de-callback-via-throw-abort"><a class="anchorlink" href="#interrompendo-sequencias-de-callback-via-throw-abort">7.3 Interrompendo Sequ√™ncias de <em>Callback</em> via <code>throw(:abort)</code></a></h4><p>No Rails 4.2, quando um <em>'before' callback</em> retorna <code>false</code> no <em>Active Record</em>
e <em>Active Model</em>, ent√£o toda a sequ√™ncia de <em>callback</em> √© interrompida. Em outras palavras,
sucessivos <em>'before' callback</em> n√£o s√£o executados, e nem √© a a√ß√£o encapsulada
em <em>callbacks</em>.</p><p>No Rails 5.0, ao retornar <code>false</code> em um <em>callback</em> no <em>Active Record</em> ou <em>Active Model</em>
n√£o ter√° o efeito colateral de interromper a sequ√™ncia de <em>callback</em>. Em vez disso, a sequ√™ncia de <em>callback</em> deve ser interrompida explicitamente chamando <code>throw(:abort)</code>.</p><p>Quando voc√™ atualiza do Rails 4.2 para o Rails 5.0, retornando <code>false</code> nesse tipo de
<em>callback</em> a sequ√™ncia de <em>callback</em> ainda ser√° interrompida, mas voc√™ receber√° um aviso de suspens√£o de uso sobre esta mudan√ßa futura.</p><p>Quando estiver pronto, voc√™ pode optar pelo novo comportamento e remover o aviso de suspens√£o de uso adicionando a seguinte configura√ß√£o ao seu <code>config/application.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">halt_callback_chains_on_return_false</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-388e4a3384734b60c88049a7d13249ea">ActiveSupport.halt_callback_chains_on_return_false = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-388e4a3384734b60c88049a7d13249ea">Copiar</button>
</div>
<p>Observe que esta op√ß√£o n√£o afetar√° os <em>callbacks</em> do <em>Active Support</em>, uma vez que eles nunca
interrompem a sequ√™ncia quando algum valor foi retornado.</p><p>Consulte <a href="https://github.com/rails/rails/pull/17227">#17227</a> para obter mais detalhes.</p><h4 id="activejob-agora-herda-de-applicationjob-por-padrao"><a class="anchorlink" href="#activejob-agora-herda-de-applicationjob-por-padrao">7.4 <em>ActiveJob</em> agora herda de <em>ApplicationJob</em> por padr√£o</a></h4><p>No Rails 4.2, um <em>Active Job</em> herda de <code>ActiveJob::Base</code>. No Rails 5.0, este
comportamento mudou para agora herdar de <code>ApplicationJob</code>.</p><p>Ao atualizar do Rails 4.2 para o Rails 5.0, voc√™ precisa criar um
arquivo <code>application_job.rb</code> em <code>app/jobs/</code> e adicionar o seguinte conte√∫do:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-699dd4909f607df4c72487983dc327eb">class ApplicationJob &lt; ActiveJob::Base
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-699dd4909f607df4c72487983dc327eb">Copiar</button>
</div>
<p>Em seguida, certifique-se de que todas as classes <em>job</em> herdam dele.</p><p>Veja <a href="https://github.com/rails/rails/pull/19034">#19034</a> para maiores detalhes.</p><h4 id="testando-rails-controller"><a class="anchorlink" href="#testando-rails-controller">7.5 Testando Rails <em>Controller</em></a></h4><h5 id="extracao-de-alguns-metodos-auxiliares-helper-para-rails-controller-testing"><a class="anchorlink" href="#extracao-de-alguns-metodos-auxiliares-helper-para-rails-controller-testing">7.5.1 Extra√ß√£o de alguns m√©todos auxiliares (<em>helper</em>) para <code>rails-controller-testing</code></a></h5><p><code>assigns</code> e <code>assert_template</code> foram extra√≠dos para a gem <code>rails-controller-testing</code>. Para
continuar usando esses m√©todos em seus testes de <em>controller</em>, adicione a <code>gem 'rails-controller-testing'</code> para seu <code>Gemfile</code>.</p><p>Se voc√™ estiver usando RSpec para teste, consulte a configura√ß√£o extra necess√°ria na
documenta√ß√£o da gem.</p><h5 id="novo-comportamento-ao-enviar-arquivos"><a class="anchorlink" href="#novo-comportamento-ao-enviar-arquivos">7.5.2 Novo comportamento ao enviar arquivos</a></h5><p>Se voc√™ estiver usando <code>ActionDispatch::Http::UploadedFile</code> em seus testes para
envio de arquivos, voc√™ precisar√° alterar para usar a classe <code>Rack::Test::UploadedFile</code>.</p><p>Veja <a href="https://github.com/rails/rails/issues/26404">#26404</a> para maiores detalhes.</p><h4 id="carregamento-automatico-e-desabilitado-apos-a-inicializacao-no-ambiente-de-producao"><a class="anchorlink" href="#carregamento-automatico-e-desabilitado-apos-a-inicializacao-no-ambiente-de-producao">7.6 Carregamento autom√°tico √© desabilitado ap√≥s a inicializa√ß√£o no ambiente de produ√ß√£o</a></h4><p>O carregamento autom√°tico agora est√° desativado ap√≥s a inicializa√ß√£o no ambiente de produ√ß√£o por padr√£o.</p><p>O carregamento r√°pido (<em>Eager loading</em>) da aplica√ß√£o faz parte do processo de inicializa√ß√£o, portanto, constantes de alto n√≠vel est√£o bem e ainda s√£o carregadas automaticamente, n√£o h√° necessidade de exigir seus arquivos.</p><p>Constantes em locais mais profundos s√£o executados apenas em tempo de execu√ß√£o, como corpos de m√©todos regulares, tamb√©m est√£o bem porque o arquivo que os define ter√° sido carregado durante a inicializa√ß√£o.</p><p>Para a grande maioria das aplica√ß√µes, essa altera√ß√£o n√£o exige nenhuma a√ß√£o. Mas no
evento muito raro em que sua aplica√ß√£o precisa de carregamento autom√°tico durante a execu√ß√£o em
produ√ß√£o, defina <code>Rails.application.config.enable_dependency_loading</code> para <em>true</em>.</p><h4 id="serializacao-xml"><a class="anchorlink" href="#serializacao-xml">7.7 Serializa√ß√£o XML</a></h4><p><code>ActiveModel::Serializers::Xml</code> foi extra√≠do do Rails para a <em>gem</em> <code>activemodel-serializers-xml</code>.
Para continuar usando a serializa√ß√£o XML em sua aplica√ß√£o, adicione a <code>gem 'activemodel-serializers-xml'</code> para o seu <code>Gemfile</code>.</p><h4 id="removido-o-suporte-para-o-antigo-adaptador-de-banco-de-dados-mysql"><a class="anchorlink" href="#removido-o-suporte-para-o-antigo-adaptador-de-banco-de-dados-mysql">7.8 Removido o suporte para o antigo adaptador de banco de dados <code>mysql</code></a></h4><p>O Rails 5 remove o suporte para o antigo adaptador de banco de dados <code>mysql</code>. A maioria dos usu√°rios devem usar o <code>mysql2</code> em vez disso. Ser√° convertido em uma <em>gem</em> separada quando encontrarmos algu√©m para manter.</p><h4 id="removido-suporte-para-o-debugger"><a class="anchorlink" href="#removido-suporte-para-o-debugger">7.9 Removido suporte para o <em>Debugger</em></a></h4><p><code>debugger</code> n√£o √© suportado pelo Ruby 2.2 que √© requerido pelo Rails 5. Use <code>byebug</code> ao inv√©s.</p><h4 id="use-bin-rails-para-executar-tarefas-e-testes"><a class="anchorlink" href="#use-bin-rails-para-executar-tarefas-e-testes">7.10 Use <code>bin/rails</code> para executar tarefas e testes</a></h4><p>Rails 5 adiciona a habilidade de executar tarefas e testes atrav√©s de <code>bin/rails</code> ao inv√©s de <em>rake</em>.
Geralmente essas mudan√ßas ocorrem em paralelo com o <em>rake</em>, mas algumas foram portadas completamente.</p><p>Para usar o novo executor de teste, simplesmente digite <code>bin/rails test</code>.</p><p><code>rake dev:cache</code> √© agora <code>bin/rails dev:cache</code>.</p><p>Execute <code>bin/rails</code> dentro do diret√≥rio raiz da sua aplica√ß√£o para ver a lista de comandos dispon√≠veis.</p><h4 id="actioncontroller-parameters-nao-herda-mais-de-hashwithindifferentaccess"><a class="anchorlink" href="#actioncontroller-parameters-nao-herda-mais-de-hashwithindifferentaccess">7.11 <code>ActionController::Parameters</code> N√£o herda mais de <code>HashWithIndifferentAccess</code></a></h4><p>Chamar <code>params</code> em sua aplica√ß√£o agora retornar√° um objeto em vez de um <em>hash</em>. Se seus
par√¢metros j√° s√£o permitidos, ent√£o voc√™ n√£o precisar√° fazer nenhuma altera√ß√£o. Se voc√™ estiver usando <code>map</code>
e outros m√©todos que dependem de ser capaz de ler o <em>hash</em> independentemente de <code>permitted?</code> voc√™
precisar√° atualizar sua aplica√ß√£o para primeiro permitir e depois converter para um <em>hash</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">([</span><span class="ss">:proceed_to</span><span class="p">,</span> <span class="ss">:return_to</span><span class="p">]).</span><span class="nf">to_h</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2f26f9ae20a307c1c65da3c0aaeb9241">params.permit([:proceed_to, :return_to]).to_h
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2f26f9ae20a307c1c65da3c0aaeb9241">Copiar</button>
</div>
<h4 id="protect-from-forgery-agora-assume-como-padrao-prepend-false"><a class="anchorlink" href="#protect-from-forgery-agora-assume-como-padrao-prepend-false">7.12 <code>protect_from_forgery</code> Agora assume como padr√£o <code>prepend:false</code></a></h4><p>O padr√£o <code>protect_from_forgery</code> √© <code>prepend: false</code>, o que significa que ser√° inserido no
<em>callback</em> no ponto em que voc√™ a chama em sua aplica√ß√£o. Se voc√™ quiser
<code>protect_from_forgery</code> para sempre executar primeiro, ent√£o voc√™ deve alterar sua aplica√ß√£o para usar
<code>protect_from_forgery prepend: true</code>.</p><h4 id="o-template-handler-padrao-agora-e-raw"><a class="anchorlink" href="#o-template-handler-padrao-agora-e-raw">7.13 O <em>Template Handler</em> padr√£o agora √© <em>RAW</em></a></h4><p>Os arquivos sem um <em>template handler</em> em sua extens√£o ser√£o renderizados usando o <em>raw handler</em>.
Anteriormente, o Rails renderizava arquivos usando o <em>ERB template handler</em>.</p><p>Se voc√™ n√£o deseja que seu arquivo seja tratado por meio do <em>raw handler</em>, voc√™ deve adicionar uma extens√£o
ao seu arquivo que pode ser analisado pelo <em>template handler</em> apropriado.</p><h4 id="adicionada-correspondencia-de-curinga-wildcard-para-template-dependencies"><a class="anchorlink" href="#adicionada-correspondencia-de-curinga-wildcard-para-template-dependencies">7.14 Adicionada correspond√™ncia de curinga (<em>Wildcard</em>) para <em>Template Dependencies</em></a></h4><p>Agora voc√™ pode usar a correspond√™ncia de curinga para suas <em>template dependencies</em>. Por exemplo, se voc√™
definisse seus <em>templates</em> como:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/subscribers_changed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/completed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/uncompleted </span><span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f54b6c3f5ecb59333b896394af2b21b3">&lt;% # Template Dependency: recordings/threads/events/subscribers_changed %&gt;
&lt;% # Template Dependency: recordings/threads/events/completed %&gt;
&lt;% # Template Dependency: recordings/threads/events/uncompleted %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f54b6c3f5ecb59333b896394af2b21b3">Copiar</button>
</div>
<p>Agora voc√™ pode chamar a depend√™ncia apenas uma vez com um curinga.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/* </span><span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b6ac8c43d31edce2e8a9875ca8168801">&lt;% # Template Dependency: recordings/threads/events/* %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b6ac8c43d31edce2e8a9875ca8168801">Copiar</button>
</div>
<h4 id="actionview-helpers-recordtaghelper-movido-para-a-gem-externa-record-tag-helper"><a class="anchorlink" href="#actionview-helpers-recordtaghelper-movido-para-a-gem-externa-record-tag-helper">7.15 <code>ActionView::Helpers::RecordTagHelper</code> movido para a <em>gem</em> externa (record_tag_helper)</a></h4><p><code>content_tag_for</code> e <code>div_for</code> foram removidos em favor de usar apenas <code>content_tag</code>. Para continuar usando os m√©todos mais antigos, adicione a <em>gem</em> <code>record_tag_helper</code> ao seu <code>Gemfile</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'record_tag_helper'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-434e555d5a7f4b902c2dfd54d0d0dc9e">gem 'record_tag_helper', '~&gt; 1.0'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-434e555d5a7f4b902c2dfd54d0d0dc9e">Copiar</button>
</div>
<p>Veja <a href="https://github.com/rails/rails/pull/18411">#18411</a> para mais detalhes.</p><h4 id="removido-suporte-para-a-gem-protected-attributes"><a class="anchorlink" href="#removido-suporte-para-a-gem-protected-attributes">7.16 Removido suporte para a <em>Gem</em> <code>protected_attributes</code></a></h4><p>A <em>gem</em> <code>protected_attributes</code> n√£o √© mais suportada no Rails 5.</p><h4 id="removido-o-suporte-para-a-gem-activerecord-deprecated-finders"><a class="anchorlink" href="#removido-o-suporte-para-a-gem-activerecord-deprecated-finders">7.17 Removido o suporte para a <em>gem</em> <code>activerecord-deprecated_finders</code></a></h4><p>A <em>gem</em> <code>activerecord-deprecated_finders</code> n√£o √© mais suportada no Rails 5.</p><h4 id="a-ordem-do-teste-padrao-activesupport-testcase-agora-e-aleatoria"><a class="anchorlink" href="#a-ordem-do-teste-padrao-activesupport-testcase-agora-e-aleatoria">7.18 A ordem do teste padr√£o <code>ActiveSupport::TestCase</code> agora √© aleat√≥ria</a></h4><p>Quando os testes s√£o executados em sua aplica√ß√£o, a ordem padr√£o agora √© <code>:random</code>
em vez de <code>:sorted</code>. Use a seguinte op√ß√£o de configura√ß√£o para defini-lo de volta para <code>:sorted</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/environments/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bae35b529b9259e930675d6a37b69955"># config/environments/test.rb
Rails.application.configure do
  config.active_support.test_order = :sorted
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bae35b529b9259e930675d6a37b69955">Copiar</button>
</div>
<h4 id="actioncontroller-live-tornou-se-uma-concern"><a class="anchorlink" href="#actioncontroller-live-tornou-se-uma-concern">7.19 <code>ActionController::Live</code> tornou-se uma <code>Concern</code></a></h4><p>Se voc√™ incluir <code>ActionController::Live</code> em outro m√≥dulo que est√° inclu√≠do em seu <em>controller</em>, ent√£o voc√™
tamb√©m deve estender o m√≥dulo com <code>ActiveSupport::Concern</code>. Alternativamente, voc√™ pode usar o gancho (<em>hook</em>)
<code>self.included</code> para incluir <code>ActionController::Live</code> diretamente no <em>controller</em> uma vez que o <code>StreamingSupport</code> est√° inclu√≠do.</p><p>Isso significa que se sua aplica√ß√£o costumava ter seu pr√≥prio m√≥dulo de <em>streaming</em>, o c√≥digo a seguir
seria interrompido em produ√ß√£o:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Esta √© uma solu√ß√£o alternativa para *streamed controllers* realizando autentica√ß√£o com *Warden/Devise*.</span>
<span class="c1"># Veja https://github.com/plataformatec/devise/issues/2332</span>
<span class="c1"># Autenticando no *router* √© outra solu√ß√£o, conforme sugerido nessa *issue*</span>
<span class="k">class</span> <span class="nc">StreamingSupport</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span> <span class="c1"># isso n√£o funcionar√° em produ√ß√£o para Rails 5</span>
  <span class="c1"># extend ActiveSupport::Concern # a menos que voc√™ descomente esta linha.</span>

  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="o">==</span> <span class="s1">'uncaught throw :warden'</span>
      <span class="kp">throw</span> <span class="ss">:warden</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-005d03ee127f638cee9c1d584dce85e1"># Esta √© uma solu√ß√£o alternativa para *streamed controllers* realizando autentica√ß√£o com *Warden/Devise*.
# Veja https://github.com/plataformatec/devise/issues/2332
# Autenticando no *router* √© outra solu√ß√£o, conforme sugerido nessa *issue*
class StreamingSupport
  include ActionController::Live # isso n√£o funcionar√° em produ√ß√£o para Rails 5
  # extend ActiveSupport::Concern # a menos que voc√™ descomente esta linha.

  def process(name)
    super(name)
  rescue ArgumentError =&gt; e
    if e.message == 'uncaught throw :warden'
      throw :warden
    else
      raise e
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-005d03ee127f638cee9c1d584dce85e1">Copiar</button>
</div>
<h4 id="novos-padroes-do-framework"><a class="anchorlink" href="#novos-padroes-do-framework">7.20 Novos Padr√µes do Framework</a></h4><h5 id="active-record-belongs-to-exigido-por-padrao"><a class="anchorlink" href="#active-record-belongs-to-exigido-por-padrao">7.20.1 <em>Active Record</em> <code>belongs_to</code> Exigido por Padr√£o</a></h5><p><code>belongs_to</code> agora ir√° disparar um erro de valida√ß√£o por padr√£o se a associa√ß√£o n√£o estiver presente.</p><p>Isso pode ser desativado por associa√ß√£o com <code>optional: true</code>.</p><p>Este padr√£o ser√° configurado automaticamente em novas aplica√ß√µes. Se uma aplica√ß√£o existente
deseja adicionar este recurso, ele precisar√° ser ativado em um <em>initializer</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-773195ebb5af65c826ec532765d3f441">config.active_record.belongs_to_required_by_default = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-773195ebb5af65c826ec532765d3f441">Copiar</button>
</div>
<p>A configura√ß√£o √© global por padr√£o para todos os seus <em>models</em>, mas voc√™ pode
sobrepor individualmente por <em>model</em>. Isso deve ajud√°-lo a migrar todos os seus <em>models</em> para ter suas
associa√ß√µes exigidas por padr√£o.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model ainda n√£o est√° pronto para ter sua associa√ß√£o exigida por padr√£o</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model est√° pronto para ter sua associa√ß√£o exigida por padr√£o</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:pilot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ef18063302556f88d7558c16a8eeb52f">class Book &lt; ApplicationRecord
  # model ainda n√£o est√° pronto para ter sua associa√ß√£o exigida por padr√£o

  self.belongs_to_required_by_default = false
  belongs_to(:author)
end

class Car &lt; ApplicationRecord
  # model est√° pronto para ter sua associa√ß√£o exigida por padr√£o

  self.belongs_to_required_by_default = true
  belongs_to(:pilot)
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ef18063302556f88d7558c16a8eeb52f">Copiar</button>
</div>
<h5 id="tokens-csrf-por-formulario"><a class="anchorlink" href="#tokens-csrf-por-formulario">7.20.2 <em>Tokens</em> CSRF por formul√°rio</a></h5><p>Rails 5 agora suporta <em>tokens</em> CSRF por formul√°rio para mitigar ataques de inje√ß√£o de c√≥digo com formul√°rios
criados por JavaScript. Com esta op√ß√£o ativada, cada formul√°rio em sua aplica√ß√£o ter√° seu
pr√≥prio <em>token</em> CSRF que √© espec√≠fico para a a√ß√£o e o m√©todo desse formul√°rio.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">per_form_csrf_tokens</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7074a8c60512fc8bca6a4b9d1065b872">config.action_controller.per_form_csrf_tokens = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7074a8c60512fc8bca6a4b9d1065b872">Copiar</button>
</div>
<h5 id="protecao-contra-falsificacao-com-verificacao-de-origem"><a class="anchorlink" href="#protecao-contra-falsificacao-com-verificacao-de-origem">7.20.3 Prote√ß√£o contra Falsifica√ß√£o com Verifica√ß√£o de Origem</a></h5><p>Agora voc√™ pode configurar sua aplica√ß√£o para verificar se o cabe√ßalho (<em>header</em>) HTTP <code>Origin</code> deve ser
verificado contra a origem do site como uma defesa adicional de CSRF. Defina o seguinte em sua configura√ß√£o para
true:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">forgery_protection_origin_check</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a7b9d3d9cd0a4a4f207f5b24da1acbd4">config.action_controller.forgery_protection_origin_check = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a7b9d3d9cd0a4a4f207f5b24da1acbd4">Copiar</button>
</div>
<h5 id="permitir-configuracao-do-nome-da-fila-do-action-mailer"><a class="anchorlink" href="#permitir-configuracao-do-nome-da-fila-do-action-mailer">7.20.4 Permitir Configura√ß√£o do Nome da Fila do <em>Action Mailer</em></a></h5><p>O nome da fila do <em>mailer</em> padr√£o √© <code>mailers</code>. Esta op√ß√£o de configura√ß√£o permite que voc√™ mude globalmente
o nome da fila. Defina o seguinte em sua configura√ß√£o:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">deliver_later_queue_name</span> <span class="o">=</span> <span class="ss">:new_queue_name</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c88138a8a3cbd2ab2f731863c9128520">config.action_mailer.deliver_later_queue_name = :new_queue_name
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c88138a8a3cbd2ab2f731863c9128520">Copiar</button>
</div>
<h5 id="suportar-fragment-caching-na-action-mailer-views"><a class="anchorlink" href="#suportar-fragment-caching-na-action-mailer-views">7.20.5 Suportar <em>Fragment Caching</em> na <em>Action Mailer Views</em></a></h5><p>Defina <code>config.action_mailer.perform_caching</code> em sua configura√ß√£o para determinar se sua <em>Action Mailer views</em>
deve suportar cache.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-49998071e9a333ef09061a0adbb65371">config.action_mailer.perform_caching = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-49998071e9a333ef09061a0adbb65371">Copiar</button>
</div>
<h5 id="configure-a-saida-de-db-structure-dump"><a class="anchorlink" href="#configure-a-saida-de-db-structure-dump">7.20.6 Configure a Sa√≠da de <code>db:structure:dump</code></a></h5><p>Se voc√™ estiver usando <code>schema_search_path</code> ou outras extens√µes PostgreSQL, voc√™ pode controlar como o esquema √©
despejado. Defina como <code>:all</code> para gerar todos os <em>dumps</em>, ou como <code>:schema_search_path</code> para gerar a partir do caminho de pesquisa do esquema.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">dump_schemas</span> <span class="o">=</span> <span class="ss">:all</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-34b91594f40eae7b659c559e3d0a456e">config.active_record.dump_schemas = :all
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-34b91594f40eae7b659c559e3d0a456e">Copiar</button>
</div>
<h5 id="configurar-opcoes-de-ssl-para-habilitar-hsts-com-subdominios"><a class="anchorlink" href="#configurar-opcoes-de-ssl-para-habilitar-hsts-com-subdominios">7.20.7 Configurar Op√ß√µes de SSL para Habilitar HSTS com Subdom√≠nios</a></h5><p>Defina o seguinte em sua configura√ß√£o para habilitar HSTS ao usar subdom√≠nios:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">ssl_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">hsts: </span><span class="p">{</span> <span class="ss">subdomains: </span><span class="kp">true</span> <span class="p">}</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-acff0fac50042b8967a943a765fc760e">config.ssl_options = { hsts: { subdomains: true } }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-acff0fac50042b8967a943a765fc760e">Copiar</button>
</div>
<h5 id="preservar-fuso-horario-do-receptor"><a class="anchorlink" href="#preservar-fuso-horario-do-receptor">7.20.8 Preservar Fuso Hor√°rio do Receptor</a></h5><p>Ao usar Ruby 2.4, voc√™ pode preservar o fuso hor√°rio do receptor ao chamar <code>to_time</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">to_time_preserves_timezone</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5a764e95441cfb419e40aae7c238edb7">ActiveSupport.to_time_preserves_timezone = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5a764e95441cfb419e40aae7c238edb7">Copiar</button>
</div>
<h4 id="mudancas-na-serializacao-json-jsonb"><a class="anchorlink" href="#mudancas-na-serializacao-json-jsonb">7.21 Mudan√ßas na Serializa√ß√£o JSON/JSONB</a></h4><p>No Rails 5.0, como os atributos JSON/JSONB s√£o serializados e desserializados foram alterados. Agora se
voc√™ definir uma coluna igual a uma <code>String</code>, <em>Active Record</em> n√£o ir√° mais transformar essa <em>string</em>
em um <code>Hash</code> e, em vez disso, apenas retornar√° a <em>string</em>. Isso n√£o se limita ao c√≥digo que
interage com os <em>models</em>, mas tamb√©m afeta as configura√ß√µes da coluna <code>:default</code> em <code>db/schema.rb</code>.
√â recomendado que voc√™ n√£o defina colunas iguais a <code>String</code>, mas passe <code>Hash</code>
em vez disso, que ser√° convertido de e para uma <em>string</em> JSON automaticamente.</p><h3 id="atualizando-do-rails-4-1-para-o-rails-4-2"><a class="anchorlink" href="#atualizando-do-rails-4-1-para-o-rails-4-2">8 Atualizando do Rails 4.1 para o Rails 4.2</a></h3><h4 id="web-console"><a class="anchorlink" href="#web-console">8.1 <em>Web Console</em></a></h4><p>Primeiro, adicione a <code>gem 'web-console', '~&gt; 2.0'</code> ao grupo <code>:development</code> em seu <code>Gemfile</code> e execute <code>bundle install</code> (ela n√£o foi inclu√≠da quando voc√™ atualizou o Rails). Depois de instalado, voc√™ pode simplesmente colocar uma refer√™ncia ao <em>console helper</em> (ou seja, <code>&lt;%= console %&gt;</code>) em qualquer <em>view</em> para a qual deseja habilit√°-lo. Um <em>console</em> tamb√©m ser√° fornecido em qualquer p√°gina de erro exibida em seu ambiente de desenvolvimento.</p><h4 id="responders"><a class="anchorlink" href="#responders">8.2 <em>Responders</em></a></h4><p>Os m√©todos de classe <code>respond_with</code> e <code>respond_to</code> foram extra√≠dos para a <em>gem</em> <code>responders</code>. Para us√°-los, simplesmente adicione a <code>gem 'responders', '~&gt; 2.0'</code> ao seu <code>Gemfile</code>. Chamadas para <code>respond_with</code> e <code>respond_to</code> (novamente, no n√≠vel de classe) n√£o funcionar√£o mais sem incluir a <em>gem</em> <code>responders</code> em suas depend√™ncias:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6f9db36afae4d8b3a61e22ca44cbefcb"># app/controllers/users_controller.rb

class UsersController &lt; ApplicationController
  respond_to :html, :json

  def show
    @user = User.find(params[:id])
    respond_with @user
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6f9db36afae4d8b3a61e22ca44cbefcb">Copiar</button>
</div>
<p><code>respond_to</code> em n√≠vel de inst√¢ncia n√£o √© afetado e n√£o requer a <em>gem</em> adicional:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-00880fefcafadfe045378531fd4ff0ed"># app/controllers/users_controller.rb

class UsersController &lt; ApplicationController
  def show
    @user = User.find(params[:id])
    respond_to do |format|
      format.html
      format.json { render json: @user }
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-00880fefcafadfe045378531fd4ff0ed">Copiar</button>
</div>
<p>Veja <a href="https://github.com/rails/rails/pull/16526">#16526</a> para mais detalhes.</p><h4 id="tratamento-de-erros-em-transaction-callbacks"><a class="anchorlink" href="#tratamento-de-erros-em-transaction-callbacks">8.3 Tratamento de erros em <em>transaction callbacks</em></a></h4><p>Atualmente, o <em>Active Record</em> suprime os erros levantados dentro de <em>callbacks</em> <code>after_rollback</code> ou <code>after_commit</code> e apenas os imprime para os logs.
Na pr√≥xima vers√£o, esses erros n√£o ser√£o mais suprimidos. Em vez disso, os erros ser√£o propagados normalmente como em outros <em>Active Record callbacks</em>.</p><p>Quando voc√™ define um <em>callback</em> <code>after_rollback</code> ou <code>after_commit</code>, voc√™ receber√° um aviso de suspens√£o de uso sobre essa mudan√ßa futura.
Quando voc√™ estiver pronto, pode optar pelo novo comportamento e remover o aviso de suspens√£o de uso, adicionando a seguinte configura√ß√£o ao seu
<code>config/application.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">raise_in_transactional_callbacks</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e04d9b9433aa8a19413b9968b91ca87f">config.active_record.raise_in_transactional_callbacks = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e04d9b9433aa8a19413b9968b91ca87f">Copiar</button>
</div>
<p>Veja <a href="https://github.com/rails/rails/pull/14488">#14488</a> e
<a href="https://github.com/rails/rails/pull/16537">#16537</a> para mais detalhes.</p><h4 id="ordenando-os-casos-de-teste"><a class="anchorlink" href="#ordenando-os-casos-de-teste">8.4 Ordenando os casos de teste</a></h4><p>No Rails 5.0, os casos de teste ser√£o executados em ordem aleat√≥ria por padr√£o. Em antecipa√ß√£o a esta mudan√ßa, Rails 4.2 introduziu uma nova op√ß√£o de configura√ß√£o
<code>active_support.test_order</code> para especificar explicitamente a ordem dos testes. Isso permite que voc√™ bloqueie o comportamento atual, definindo a op√ß√£o para
<code>:sorted</code>, ou opte pelo comportamento futuro configurando a op√ß√£o para <code>:random</code>.</p><p>Se voc√™ n√£o especificar um valor para esta op√ß√£o, um aviso de suspens√£o de uso ser√° emitido. Para evitar isso, adicione a seguinte linha ao seu ambiente de teste:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/environments/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span> <span class="c1"># ou `:random` se voc√™ preferir</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-816f4b660be9ad2de31be9b4f36cd5d3"># config/environments/test.rb
Rails.application.configure do
  config.active_support.test_order = :sorted # ou `:random` se voc√™ preferir
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-816f4b660be9ad2de31be9b4f36cd5d3">Copiar</button>
</div>
<h4 id="atributos-serializados"><a class="anchorlink" href="#atributos-serializados">8.5 Atributos serializados</a></h4><p>Ao usar um codificador personalizado (por exemplo, <code>serialize :metadata, JSON</code>), atribuir <code>nil</code> a um atributo serializado ir√° salv√°-lo no banco de dados
como <code>NULL</code> em vez de passar o valor <code>nil</code> atrav√©s do codificador (por exemplo, <code>"null"</code> quando usando o codificador <code>JSON</code>).</p><h4 id="nivel-de-log-em-producao"><a class="anchorlink" href="#nivel-de-log-em-producao">8.6 N√≠vel de <em>log</em> em produ√ß√£o</a></h4><p>No Rails 5, o n√≠vel de <em>log</em> padr√£o para o ambiente de produ√ß√£o ser√° alterado para <code>:debug</code> (de <code>:info</code>). Para preservar o padr√£o atual, adicione a seguinte linha para o seu <code>production.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Defina como `:info` para corresponder ao padr√£o atual, ou defina como `:debug` para ativar o padr√£o futuro.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">log_level</span> <span class="o">=</span> <span class="ss">:info</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-76b2846742126387218673ba5c1c6e26"># Defina como `:info` para corresponder ao padr√£o atual, ou defina como `:debug` para ativar o padr√£o futuro.
config.log_level = :info
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-76b2846742126387218673ba5c1c6e26">Copiar</button>
</div>
<h4 id="after-bundle-em-rails-templates"><a class="anchorlink" href="#after-bundle-em-rails-templates">8.7 <code>after_bundle</code> em Rails <em>templates</em></a></h4><p>Se voc√™ tem um <em>Rails template</em> que adiciona todos os arquivos no controle de vers√£o, isso falhar√° ao adicionar os <em>binstubs</em> gerados porque ele √© executado antes do Bundler:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># template.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">git</span> <span class="ss">:init</span>
<span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
<span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0cea1adce176a8ce07e5da5c07c44f30"># template.rb
generate(:scaffold, "person name:string")
route "root to: 'people#index'"
rake("db:migrate")

git :init
git add: "."
git commit: %Q{ -m 'Initial commit' }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0cea1adce176a8ce07e5da5c07c44f30">Copiar</button>
</div>
<p>Agora voc√™ pode envolver as chamadas <code>git</code> em um bloco <code>after_bundle</code>. Isso ser√° executado depois que os <em>binstubs</em> foram gerados.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># template.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">after_bundle</span> <span class="k">do</span>
  <span class="n">git</span> <span class="ss">:init</span>
  <span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
  <span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4bd259a2bb96bdc788d59fb7d756d948"># template.rb
generate(:scaffold, "person name:string")
route "root to: 'people#index'"
rake("db:migrate")

after_bundle do
  git :init
  git add: "."
  git commit: %Q{ -m 'Initial commit' }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4bd259a2bb96bdc788d59fb7d756d948">Copiar</button>
</div>
<h4 id="rails-html-sanitizer"><a class="anchorlink" href="#rails-html-sanitizer">8.8 Rails <em>HTML Sanitizer</em></a></h4><p>H√° uma nova op√ß√£o para sanitizar fragmentos de HTML em suas aplica√ß√µes. A vener√°vel abordagem <em>html-scanner</em> agora est√° oficialmente sendo descontinuada em favor de
<a href="https://github.com/rails/rails-html-sanitizer"><code>Rails HTML Sanitizer</code></a>.</p><p>Isso significa que os m√©todos <code>sanitize</code>, <code>sanitize_css</code>, <code>strip_tags</code> e <code>strip_links</code> s√£o apoiados por uma nova implementa√ß√£o.</p><p>Este novo <em>sanitizer</em> usa internamente <a href="https://github.com/flavorjones/loofah">Loofah</a>. Loofah, por sua vez, usa Nokogiri, que
envolve analisadores XML escritos em C e Java, portanto, a sanitiza√ß√£o deve ser mais r√°pida n√£o importa qual vers√£o do Ruby voc√™ execute.</p><p>A nova vers√£o atualiza <code>sanitize</code>, ent√£o pode usar um <code>Loofah::Scrubber</code> para uma depura√ß√£o poderosa.
<a href="https://github.com/flavorjones/loofah#loofahscrubber">Veja alguns exemplos de depuradores aqui</a>.</p><p>Dois novos depuradores tamb√©m foram adicionados: <code>PermitScrubber</code> e <code>TargetScrubber</code>.
Leia o <a href="https://github.com/rails/rails-html-sanitizer"><em>gem's readme</em></a> para mais informa√ß√µes.</p><p>A documenta√ß√£o para <code>PermitScrubber</code> e <code>TargetScrubber</code> explica como voc√™ pode obter controle total sobre quando e como os elementos devem ser removidos.</p><p>Se sua aplica√ß√£o precisa usar a implementa√ß√£o antiga do <em>sanitizer</em>, inclua <code>rails-deprecated_sanitizer</code> em seu <code>Gemfile</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails-deprecated_sanitizer'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-59b9709872fa8af55e9185fe883199fb">gem 'rails-deprecated_sanitizer'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-59b9709872fa8af55e9185fe883199fb">Copiar</button>
</div>
<h4 id="testando-rails-dom"><a class="anchorlink" href="#testando-rails-dom">8.9 Testando <em>Rails DOM</em></a></h4><p>O <a href="https://api.rubyonrails.org/v4.1/classes/ActionDispatch/Assertions/TagAssertions.html">m√≥dulo <code>TagAssertions</code></a> (contendo m√©todos como <code>assert_tag</code>), <a href="https://github.com/rails/rails/blob/6061472b8c310158a2a2e8e9a6b81a1aef6b60fe/actionpack/lib/action_dispatch/testing/assertions/dom.rb">foi descontinuado</a> em favor dos m√©todos <code>assert_select</code> do m√≥dulo <code>SelectorAssertions</code>, que foi extra√≠do para a <a href="https://github.com/rails/rails-dom-testing"><em>gem rails-dom-testing</em></a>.</p><h4 id="tokens-de-autenticidade-mascarados"><a class="anchorlink" href="#tokens-de-autenticidade-mascarados">8.10 Tokens de autenticidade mascarados</a></h4><p>A fim de mitigar ataques SSL, <code>form_authenticity_token</code> agora √© mascarado para que varie com cada solicita√ß√£o (<em>request</em>). Assim, os <em>tokens</em> s√£o validados desmascarando e depois descriptografando. Como resultado, quaisquer estrat√©gias para verificar solicita√ß√µes de formul√°rios n√£o-rails que dependiam de um <em>token</em> CSRF de sess√£o est√°tica devem levar isso em considera√ß√£o.</p><h4 id="action-mailer"><a class="anchorlink" href="#action-mailer">8.11 <em>Action Mailer</em></a></h4><p>Anteriormente, chamar um m√©todo <em>mailer</em> em uma classe <em>mailer</em> resultaria no m√©todo de inst√¢ncia correspondente sendo executado diretamente. Com a introdu√ß√£o de
<em>Active Job</em> e <code>#deliver_later</code>, isso n√£o √© mais verdade. No Rails 4.2, a invoca√ß√£o dos m√©todos de inst√¢ncia √© adiada at√© <code>deliver_now</code> ou
<code>deliver_later</code> sejam chamados. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Called"</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8c03ffd863e353c7daf32ae5e270ae07">class Notifier &lt; ActionMailer::Base
  def notify(user, ...)
    puts "Called"
    mail(to: user.email, ...)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8c03ffd863e353c7daf32ae5e270ae07">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">mail</span> <span class="o">=</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1"># Notifier#notify ainda n√£o √© chamado neste momento</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="nf">deliver_now</span>           <span class="c1"># Imprime "Called"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-86e370e60d1879f8a9f60896e14b0ae8">mail = Notifier.notify(user, ...) # Notifier#notify ainda n√£o √© chamado neste momento
mail = mail.deliver_now           # Imprime "Called"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-86e370e60d1879f8a9f60896e14b0ae8">Copiar</button>
</div>
<p>Isso n√£o deve resultar em diferen√ßas percept√≠veis para a maioria das aplica√ß√µes.
No entanto, se voc√™ precisar que alguns m√©todos n√£o-<em>mailer</em> sejam executados de forma s√≠ncrona, e
voc√™ estava contando anteriormente com o comportamento de <em>proxy</em> s√≠ncrono, voc√™ deve
defin√≠-los como m√©todos de classe na classe <em>mailer</em> diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">broadcast_notifications</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-932d6753cea4d42df48e24974386b655">class Notifier &lt; ActionMailer::Base
  def self.broadcast_notifications(users, ...)
    users.each { |user| Notifier.notify(user, ...) }
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-932d6753cea4d42df48e24974386b655">Copiar</button>
</div>
<h4 id="suporte-para-chave-estrangeira"><a class="anchorlink" href="#suporte-para-chave-estrangeira">8.12 Suporte para chave estrangeira</a></h4><p>A migra√ß√£o DSL foi expandida para suportar defini√ß√µes de chave estrangeira. Se
voc√™ tem usado a <em>gem Foreigner</em>, voc√™ pode querer considerar remov√™-la.
Observe que o suporte de chave estrangeira do Rails √© um subconjunto de <em>Foreigner</em>. Isso significa
que nem todas as defini√ß√µes <em>Foreigner</em> podem ser totalmente substitu√≠das pela contraparte
DSL de migra√ß√£o Rails.</p><p>O procedimento de migra√ß√£o √© o seguinte:</p>
<ol>
<li>remova <code>gem "foreigner"</code> do <code>Gemfile</code>.</li>
<li>execute <code>bundle install</code>.</li>
<li>execute <code>bin/rake db:schema:dump</code>.</li>
<li>certifique-se de que <code>db/schema.rb</code> cont√©m todas as defini√ß√µes de chave estrangeira com
as op√ß√µes necess√°rias.</li>
</ol>
<h3 id="upgrading-from-rails-4-0-to-rails-4-1"><a class="anchorlink" href="#upgrading-from-rails-4-0-to-rails-4-1">9 Upgrading from Rails 4.0 to Rails 4.1</a></h3><h4 id="csrf-protection-from-remote-script-tags"><a class="anchorlink" href="#csrf-protection-from-remote-script-tags">9.1 CSRF protection from remote <code>&lt;script&gt;</code> tags</a></h4><p>Or, "whaaat my tests are failing!!!?" or "my <code>&lt;script&gt;</code> widget is busted!!"</p><p>Cross-site request forgery (CSRF) protection now covers GET requests with
JavaScript responses, too. This prevents a third-party site from remotely
referencing your JavaScript with a <code>&lt;script&gt;</code> tag to extract sensitive data.</p><p>This means that your functional and integration tests that use</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a68f939b458660b90088a172c892eaef">get :index, format: :js
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a68f939b458660b90088a172c892eaef">Copiar</button>
</div>
<p>will now trigger CSRF protection. Switch to</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">xhr</span> <span class="ss">:get</span><span class="p">,</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b8357e39b8343aba6817ea3a5d3c33e8">xhr :get, :index, format: :js
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b8357e39b8343aba6817ea3a5d3c33e8">Copiar</button>
</div>
<p>to explicitly test an <code>XmlHttpRequest</code>.</p><div class="note"><p>Your own <code>&lt;script&gt;</code> tags are treated as cross-origin and blocked by
default, too. If you really mean to load JavaScript from <code>&lt;script&gt;</code> tags,
you must now explicitly skip CSRF protection on those actions.</p></div><h4 id="upgrading-from-rails-4-0-to-rails-4-1-spring"><a class="anchorlink" href="#upgrading-from-rails-4-0-to-rails-4-1-spring">9.2 Spring</a></h4><p>If you want to use Spring as your application preloader you need to:</p>
<ol>
<li>Add <code>gem 'spring', group: :development</code> to your <code>Gemfile</code>.</li>
<li>Install spring using <code>bundle install</code>.</li>
<li>Generate the Spring binstub with <code>bundle exec spring binstub</code>.</li>
</ol>
<div class="note"><p>User defined rake tasks will run in the <code>development</code> environment by
default. If you want them to run in other environments consult the
<a href="https://github.com/rails/spring#rake">Spring README</a>.</p></div><h4 id="config-secrets-yml"><a class="anchorlink" href="#config-secrets-yml">9.3 <code>config/secrets.yml</code></a></h4><p>If you want to use the new <code>secrets.yml</code> convention to store your application's
secrets, you need to:</p>
<ol>
<li>
<p>Create a <code>secrets.yml</code> file in your <code>config</code> folder with the following content:</p>
<div class="code_container">
<pre><code class="highlight yaml"><span class="na">development</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-139902cc15e01db8f07f7ac21dfb492b">development:
  secret_key_base:

test:
  secret_key_base:

production:
  secret_key_base: &lt;%= ENV["SECRET_KEY_BASE"] %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-139902cc15e01db8f07f7ac21dfb492b">Copiar</button>
</div>
</li>
<li><p>Use your existing <code>secret_key_base</code> from the <code>secret_token.rb</code> initializer to
set the <code>SECRET_KEY_BASE</code> environment variable for whichever users running the
Rails application in production. Alternatively, you can simply copy the existing
<code>secret_key_base</code> from the <code>secret_token.rb</code> initializer to <code>secrets.yml</code>
under the <code>production</code> section, replacing <code>&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</code>.</p></li>
<li><p>Remove the <code>secret_token.rb</code> initializer.</p></li>
<li><p>Use <code>rake secret</code> to generate new keys for the <code>development</code> and <code>test</code> sections.</p></li>
<li><p>Restart your server.</p></li>
</ol>
<h4 id="changes-to-test-helper"><a class="anchorlink" href="#changes-to-test-helper">9.4 Changes to test helper</a></h4><p>If your test helper contains a call to
<code>ActiveRecord::Migration.check_pending!</code> this can be removed. The check
is now done automatically when you <code>require "rails/test_help"</code>, although
leaving this line in your helper is not harmful in any way.</p><h4 id="cookies-serializer"><a class="anchorlink" href="#cookies-serializer">9.5 Cookies serializer</a></h4><p>Applications created before Rails 4.1 uses <code>Marshal</code> to serialize cookie values into
the signed and encrypted cookie jars. If you want to use the new <code>JSON</code>-based format
in your application, you can add an initializer file with the following content:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_serializer</span> <span class="o">=</span> <span class="ss">:hybrid</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-feb27922189efe4c44e2fa3c66f933e7">Rails.application.config.action_dispatch.cookies_serializer = :hybrid
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-feb27922189efe4c44e2fa3c66f933e7">Copiar</button>
</div>
<p>This would transparently migrate your existing <code>Marshal</code>-serialized cookies into the
new <code>JSON</code>-based format.</p><p>When using the <code>:json</code> or <code>:hybrid</code> serializer, you should beware that not all
Ruby objects can be serialized as JSON. For example, <code>Date</code> and <code>Time</code> objects
will be serialized as strings, and <code>Hash</code>es will have their keys stringified.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CookiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">set_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">tomorrow</span> <span class="c1"># =&gt; Thu, 20 Mar 2014</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s1">'read_cookie'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="c1"># =&gt; "2014-03-20"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-adde9fde6fd24a1c73364a99b9d7aff7">class CookiesController &lt; ApplicationController
  def set_cookie
    cookies.encrypted[:expiration_date] = Date.tomorrow # =&gt; Thu, 20 Mar 2014
    redirect_to action: 'read_cookie'
  end

  def read_cookie
    cookies.encrypted[:expiration_date] # =&gt; "2014-03-20"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-adde9fde6fd24a1c73364a99b9d7aff7">Copiar</button>
</div>
<p>It's advisable that you only store simple data (strings and numbers) in cookies.
If you have to store complex objects, you would need to handle the conversion
manually when reading the values on subsequent requests.</p><p>If you use the cookie session store, this would apply to the <code>session</code> and
<code>flash</code> hash as well.</p><h4 id="flash-structure-changes"><a class="anchorlink" href="#flash-structure-changes">9.6 Flash structure changes</a></h4><p>Flash message keys are
<a href="https://github.com/rails/rails/commit/a668beffd64106a1e1fedb71cc25eaaa11baf0c1">normalized to strings</a>. They
can still be accessed using either symbols or strings. Looping through the flash
will always yield string keys:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">flash</span><span class="p">[</span><span class="s2">"string"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a string"</span>
<span class="n">flash</span><span class="p">[</span><span class="ss">:symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a symbol"</span>

<span class="c1"># Rails &lt; 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", :symbol]</span>

<span class="c1"># Rails &gt;= 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", "symbol"]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f5425436ace96f299ef919ba095ac578">flash["string"] = "a string"
flash[:symbol] = "a symbol"

# Rails &lt; 4.1
flash.keys # =&gt; ["string", :symbol]

# Rails &gt;= 4.1
flash.keys # =&gt; ["string", "symbol"]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f5425436ace96f299ef919ba095ac578">Copiar</button>
</div>
<p>Make sure you are comparing Flash message keys against strings.</p><h4 id="changes-in-json-handling"><a class="anchorlink" href="#changes-in-json-handling">9.7 Changes in JSON handling</a></h4><p>There are a few major changes related to JSON handling in Rails 4.1.</p><h5 id="multijson-removal"><a class="anchorlink" href="#multijson-removal">9.7.1 MultiJSON removal</a></h5><p>MultiJSON has reached its <a href="https://github.com/rails/rails/pull/10576">end-of-life</a>
and has been removed from Rails.</p><p>If your application currently depends on MultiJSON directly, you have a few options:</p>
<ol>
<li><p>Add 'multi_json' to your <code>Gemfile</code>. Note that this might cease to work in the future</p></li>
<li><p>Migrate away from MultiJSON by using <code>obj.to_json</code>, and <code>JSON.parse(str)</code> instead.</p></li>
</ol>
<div class="warning"><p>Do not simply replace <code>MultiJson.dump</code> and <code>MultiJson.load</code> with
<code>JSON.dump</code> and <code>JSON.load</code>. These JSON gem APIs are meant for serializing and
deserializing arbitrary Ruby objects and are generally <a href="https://ruby-doc.org/stdlib-2.2.2/libdoc/json/rdoc/JSON.html#method-i-load">unsafe</a>.</p></div><h5 id="json-gem-compatibility"><a class="anchorlink" href="#json-gem-compatibility">9.7.2 JSON gem compatibility</a></h5><p>Historically, Rails had some compatibility issues with the JSON gem. Using
<code>JSON.generate</code> and <code>JSON.dump</code> inside a Rails application could produce
unexpected errors.</p><p>Rails 4.1 fixed these issues by isolating its own encoder from the JSON gem. The
JSON gem APIs will function as normal, but they will not have access to any
Rails-specific features. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FooBar</span>
  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-22da3f0feb41d7777dfb15ef8aac127a">class FooBar
  def as_json(options = nil)
    { foo: 'bar' }
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-22da3f0feb41d7777dfb15ef8aac127a">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">to_json</span>
<span class="p">=&gt;</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">foo</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">bar</span><span class="se">\"</span><span class="s2">}"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="ss">quirks_mode: </span><span class="kp">true</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">#&lt;FooBar:0x007fa80a481610&gt;</span><span class="se">\"</span><span class="s2">"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6d5ea5d6fd58235c7c3c33f335a69edc">FooBar.new.to_json
JSON.generate(FooBar.new, quirks_mode: true)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6d5ea5d6fd58235c7c3c33f335a69edc">Copiar</button>
</div>
<h5 id="new-json-encoder"><a class="anchorlink" href="#new-json-encoder">9.7.3 New JSON encoder</a></h5><p>The JSON encoder in Rails 4.1 has been rewritten to take advantage of the JSON
gem. For most applications, this should be a transparent change. However, as
part of the rewrite, the following features have been removed from the encoder:</p>
<ol>
<li>Circular data structure detection</li>
<li>Support for the <code>encode_json</code> hook</li>
<li>Option to encode <code>BigDecimal</code> objects as numbers instead of strings</li>
</ol>
<p>If your application depends on one of these features, you can get them back by
adding the <a href="https://github.com/rails/activesupport-json_encoder"><code>activesupport-json_encoder</code></a>
gem to your <code>Gemfile</code>.</p><h5 id="json-representation-of-time-objects"><a class="anchorlink" href="#json-representation-of-time-objects">9.7.4 JSON representation of Time objects</a></h5><p><code>#as_json</code> for objects with time component (<code>Time</code>, <code>DateTime</code>, <code>ActiveSupport::TimeWithZone</code>)
now returns millisecond precision by default. If you need to keep old behavior with no millisecond
precision, set the following in an initializer:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">JSON</span><span class="o">::</span><span class="no">Encoding</span><span class="p">.</span><span class="nf">time_precision</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9449dc38f88f0a10f55795e2b3135a7c">ActiveSupport::JSON::Encoding.time_precision = 0
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9449dc38f88f0a10f55795e2b3135a7c">Copiar</button>
</div>
<h4 id="usage-of-return-within-inline-callback-blocks"><a class="anchorlink" href="#usage-of-return-within-inline-callback-blocks">9.8 Usage of <code>return</code> within inline callback blocks</a></h4><p>Previously, Rails allowed inline callback blocks to use <code>return</code> this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="k">return</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># BAD</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2507ba99a89970454511df27929384ea">class ReadOnlyModel &lt; ActiveRecord::Base
  before_save { return false } # BAD
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2507ba99a89970454511df27929384ea">Copiar</button>
</div>
<p>This behavior was never intentionally supported. Due to a change in the internals
of <code>ActiveSupport::Callbacks</code>, this is no longer allowed in Rails 4.1. Using a
<code>return</code> statement in an inline callback block causes a <code>LocalJumpError</code> to
be raised when the callback is executed.</p><p>Inline callback blocks using <code>return</code> can be refactored to evaluate to the
returned value:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># GOOD</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f9e5955f28ff45628179fdcc8585358c">class ReadOnlyModel &lt; ActiveRecord::Base
  before_save { false } # GOOD
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f9e5955f28ff45628179fdcc8585358c">Copiar</button>
</div>
<p>Alternatively, if <code>return</code> is preferred it is recommended to explicitly define
a method:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="ss">:before_save_callback</span> <span class="c1"># GOOD</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">before_save_callback</span>
      <span class="k">return</span> <span class="kp">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0621975f0e6e55eac11c2f635320ef0d">class ReadOnlyModel &lt; ActiveRecord::Base
  before_save :before_save_callback # GOOD

  private
    def before_save_callback
      return false
    end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0621975f0e6e55eac11c2f635320ef0d">Copiar</button>
</div>
<p>This change applies to most places in Rails where callbacks are used, including
Active Record and Active Model callbacks, as well as filters in Action
Controller (e.g. <code>before_action</code>).</p><p>See <a href="https://github.com/rails/rails/pull/13271">this pull request</a> for more
details.</p><h4 id="methods-defined-in-active-record-fixtures"><a class="anchorlink" href="#methods-defined-in-active-record-fixtures">9.9 Methods defined in Active Record fixtures</a></h4><p>Rails 4.1 evaluates each fixture's ERB in a separate context, so helper methods
defined in a fixture will not be available in other fixtures.</p><p>Helper methods that are used in multiple fixtures should be defined on modules
included in the newly introduced <code>ActiveRecord::FixtureSet.context_class</code>, in
<code>test_helper.rb</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FixtureFileHelpers</span>
  <span class="k">def</span> <span class="nf">file_sha</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'test/fixtures'</span><span class="p">,</span> <span class="n">path</span><span class="p">)))</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">FixtureSet</span><span class="p">.</span><span class="nf">context_class</span><span class="p">.</span><span class="nf">include</span> <span class="no">FixtureFileHelpers</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cb5fbab2a80bc733833e7de043532e77">module FixtureFileHelpers
  def file_sha(path)
    OpenSSL::Digest::SHA256.hexdigest(File.read(Rails.root.join('test/fixtures', path)))
  end
end

ActiveRecord::FixtureSet.context_class.include FixtureFileHelpers
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cb5fbab2a80bc733833e7de043532e77">Copiar</button>
</div>
<h4 id="i18n-enforcing-available-locales"><a class="anchorlink" href="#i18n-enforcing-available-locales">9.10 I18n enforcing available locales</a></h4><p>Rails 4.1 now defaults the I18n option <code>enforce_available_locales</code> to <code>true</code>. This
means that it will make sure that all locales passed to it must be declared in
the <code>available_locales</code> list.</p><p>To disable it (and allow I18n to accept <em>any</em> locale option) add the following
configuration to your application:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">i18n</span><span class="p">.</span><span class="nf">enforce_available_locales</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f5d4b4362780ad57c9ad8bf35737f6a3">config.i18n.enforce_available_locales = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f5d4b4362780ad57c9ad8bf35737f6a3">Copiar</button>
</div>
<p>Note that this option was added as a security measure, to ensure user input
cannot be used as locale information unless it is previously known. Therefore,
it's recommended not to disable this option unless you have a strong reason for
doing so.</p><h4 id="mutator-methods-called-on-relation"><a class="anchorlink" href="#mutator-methods-called-on-relation">9.11 Mutator methods called on Relation</a></h4><p><code>Relation</code> no longer has mutator methods like <code>#map!</code> and <code>#delete_if</code>. Convert
to an <code>Array</code> by calling <code>#to_a</code> before using these methods.</p><p>It intends to prevent odd bugs and confusion in code that call mutator
methods directly on the <code>Relation</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Instead of this</span>
<span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">compact!</span>

<span class="c1"># Now you have to do this</span>
<span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">authors</span><span class="p">.</span><span class="nf">compact!</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a9dbea9c01504209a97f7af08bc6b7fb"># Instead of this
Author.where(name: 'Hank Moody').compact!

# Now you have to do this
authors = Author.where(name: 'Hank Moody').to_a
authors.compact!
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a9dbea9c01504209a97f7af08bc6b7fb">Copiar</button>
</div>
<h4 id="changes-on-default-scopes"><a class="anchorlink" href="#changes-on-default-scopes">9.12 Changes on Default Scopes</a></h4><p>Default scopes are no longer overridden by chained conditions.</p><p>In previous versions when you defined a <code>default_scope</code> in a model
it was overridden by chained conditions in the same field. Now it
is merged like any other scope.</p><p>Before:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3be07ab997188a15e1f43d9565c0a26c">class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { where state: 'active' }
  scope :inactive, -&gt; { where state: 'inactive' }
end

User.all
# SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'

User.active
# SELECT "users".* FROM "users" WHERE "users"."state" = 'active'

User.where(state: 'inactive')
# SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3be07ab997188a15e1f43d9565c0a26c">Copiar</button>
</div>
<p>After:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'inactive'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-643e81b40b2790f91bfda7238a91a955">class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { where state: 'active' }
  scope :inactive, -&gt; { where state: 'inactive' }
end

User.all
# SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'

User.active
# SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'active'

User.where(state: 'inactive')
# SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'inactive'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-643e81b40b2790f91bfda7238a91a955">Copiar</button>
</div>
<p>To get the previous behavior it is needed to explicitly remove the
<code>default_scope</code> condition using <code>unscoped</code>, <code>unscope</code>, <code>rewhere</code> or
<code>except</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">unscope</span><span class="p">(</span><span class="ss">where: :state</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'active'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">rewhere</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">inactive</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d2577864f6d923f616c1d274605cf004">class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { unscope(where: :state).where(state: 'active') }
  scope :inactive, -&gt; { rewhere state: 'inactive' }
end

User.all
# SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'

User.active
# SELECT "users".* FROM "users" WHERE "users"."state" = 'active'

User.inactive
# SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d2577864f6d923f616c1d274605cf004">Copiar</button>
</div>
<h4 id="rendering-content-from-string"><a class="anchorlink" href="#rendering-content-from-string">9.13 Rendering content from string</a></h4><p>Rails 4.1 introduces <code>:plain</code>, <code>:html</code>, and <code>:body</code> options to <code>render</code>. Those
options are now the preferred way to render string-based content, as it allows
you to specify which content type you want the response sent as.</p>
<ul>
<li>
<code>render :plain</code> will set the content type to <code>text/plain</code>
</li>
<li>
<code>render :html</code> will set the content type to <code>text/html</code>
</li>
<li>
<code>render :body</code> will <em>not</em> set the content type header.</li>
</ul>
<p>From the security standpoint, if you don't expect to have any markup in your
response body, you should be using <code>render :plain</code> as most browsers will escape
unsafe content in the response for you.</p><p>We will be deprecating the use of <code>render :text</code> in a future version. So please
start using the more precise <code>:plain</code>, <code>:html</code>, and <code>:body</code> options instead.
Using <code>render :text</code> may pose a security risk, as the content is sent as
<code>text/html</code>.</p><h4 id="postgresql-json-and-hstore-datatypes"><a class="anchorlink" href="#postgresql-json-and-hstore-datatypes">9.14 PostgreSQL json and hstore datatypes</a></h4><p>Rails 4.1 will map <code>json</code> and <code>hstore</code> columns to a string-keyed Ruby <code>Hash</code>.
In earlier versions, a <code>HashWithIndifferentAccess</code> was used. This means that
symbol access is no longer supported. This is also the case for
<code>store_accessors</code> based on top of <code>json</code> or <code>hstore</code> columns. Make sure to use
string keys consistently.</p><h4 id="explicit-block-use-for-activesupport-callbacks"><a class="anchorlink" href="#explicit-block-use-for-activesupport-callbacks">9.15 Explicit block use for <code>ActiveSupport::Callbacks</code></a></h4><p>Rails 4.1 now expects an explicit block to be passed when calling
<code>ActiveSupport::Callbacks.set_callback</code>. This change stems from
<code>ActiveSupport::Callbacks</code> being largely rewritten for the 4.1 release.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Previously in Rails 4.0</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>

<span class="c1"># Now in Rails 4.1</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1d15304e2d1a287406e7b659ab3526b1"># Previously in Rails 4.0
set_callback :save, :around, -&gt;(r, &amp;block) { stuff; result = block.call; stuff }

# Now in Rails 4.1
set_callback :save, :around, -&gt;(r, block) { stuff; result = block.call; stuff }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1d15304e2d1a287406e7b659ab3526b1">Copiar</button>
</div>
<h3 id="atualizando-do-rails-3-2-para-o-rails-4-0"><a class="anchorlink" href="#atualizando-do-rails-3-2-para-o-rails-4-0">10 Atualizando do Rails 3.2 para o Rails 4.0</a></h3><p>Se sua aplica√ß√£o est√° em qualquer vers√£o do Rails anterior a 3.2.x, voc√™ deve atualizar para o Rails 3.2 antes de tentar atualizar para o Rails 4.0.</p><p>As seguintes mudan√ßas s√£o necess√°rias a atualizar seu aplicativo para Rails 4.0.</p><h4 id="http-patch"><a class="anchorlink" href="#http-patch">10.1 HTTP PATCH</a></h4><p>O Rails 4 agora usa <code>PATCH</code> como o verbo HTTP prim√°rio para atualiza√ß√µes quando um RESTful
<code>resource</code> √© declarado em <code>config/routes.rb</code>. A <em>action</em> <code>update</code> ainda √© usada,
e as solicita√ß√µes <code>PUT</code> continuar√£o a ser roteadas para a <em>action</em> <code>update</code> tamb√©m.
Portanto, se voc√™ estiver usando apenas as rotas RESTful padr√£o, nenhuma altera√ß√£o precisa ser feita:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0ff2dadd3c9ca8d026b68cce97ef0920">resources :users
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0ff2dadd3c9ca8d026b68cce97ef0920">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e40cba8401e432192c0956bbb808c1bd">&lt;%= form_for @user do |f| %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e40cba8401e432192c0956bbb808c1bd">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># Nenhuma mudan√ßa necess√°ria; PATCH ser√° preferido e PUT ainda funcionar√°.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8deeace92a1badec6177e9a451da5526">class UsersController &lt; ApplicationController
  def update
    # Nenhuma mudan√ßa necess√°ria; PATCH ser√° preferido e PUT ainda funcionar√°.
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8deeace92a1badec6177e9a451da5526">Copiar</button>
</div>
<p>No entanto, voc√™ precisar√° fazer uma mudan√ßa se estiver usando <code>form_for</code> para atualizar
um recurso em conjunto com uma rota personalizada usando o verbo HTTP <code>PUT</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">put</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e889be4fcbe21257ca2e722c07be76a2">resources :users do
  put :update_name, on: :member
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e889be4fcbe21257ca2e722c07be76a2">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a2113b7ab70ebf52dfdb0ed0860574a7">&lt;%= form_for [ :update_name, @user ] do |f| %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a2113b7ab70ebf52dfdb0ed0860574a7">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update_name</span>
    <span class="c1"># Mudan√ßa necess√°ria; form_for tentar√° usar uma rota PATCH inexistente.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f1be9fdd6eebd87a49a6e930d33bd8f4">class UsersController &lt; ApplicationController
  def update_name
    # Mudan√ßa necess√°ria; form_for tentar√° usar uma rota PATCH inexistente.
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f1be9fdd6eebd87a49a6e930d33bd8f4">Copiar</button>
</div>
<p>Se a <em>action</em> n√£o estiver sendo usada em uma API p√∫blica e voc√™ estiver livre para alterar o
verbo HTTP, voc√™ pode atualizar sua rota para usar <code>patch</code> em vez de <code>put</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">patch</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0d686c70e60a01586e1c2dc1597e9488">resources :users do
  patch :update_name, on: :member
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0d686c70e60a01586e1c2dc1597e9488">Copiar</button>
</div>
<p>Requisi√ß√µes <code>PUT</code> para <code>/users/:id</code> no Rails 4 s√£o encaminhadas para <code>update</code> como est√£o
hoje. Portanto, se voc√™ tiver uma API que recebe solicita√ß√µes <code>PUT</code> reais, ela funcionar√°.
O roteador tamb√©m roteia solicita√ß√µes <code>PATCH</code> para <code>/users/:id</code> para a <em>action</em> <code>update</code>.</p><p>Se a <em>action</em> est√° sendo usada em uma API p√∫blica e voc√™ n√£o pode mudar para o verbo HTTP
usado, voc√™ pode atualizar seu formul√°rio para usar o m√©todo <code>PUT</code> no lugar:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">],</span> <span class="ss">method: :put</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-275b300335459928c29caf1db9dfb9d0">&lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-275b300335459928c29caf1db9dfb9d0">Copiar</button>
</div>
<p>Para mais informa√ß√µes sobre o PATCH e por que essa mudan√ßa foi feita, consulte <a href="https://weblog.rubyonrails.org/2012/2/26/edge-rails-patch-is-the-new-primary-http-method%20-for-updates/">esta postagem</a>
no blog do Rails.</p><h5 id="uma-nota-sobre-os-tipos-de-midia"><a class="anchorlink" href="#uma-nota-sobre-os-tipos-de-midia">10.1.1 Uma nota sobre os tipos de m√≠dia</a></h5><p>A errata para o verbo <code>PATCH</code> <a href="http://www.rfc-editor.org/errata_search.php?rfc=5789">especifica que um tipo de m√≠dia 'diff' deve ser
usado com <code>PATCH</code></a>. Um
desses formatos √© <a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a>. Enquanto o Rails
n√£o oferece suporte nativo ao JSON Patch, √© f√°cil adicionar suporte:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># em seu controller:</span>
<span class="k">def</span> <span class="nf">update</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="k">do</span>
      <span class="c1"># executa uma atualiza√ß√£o parcial</span>
      <span class="vi">@article</span><span class="p">.</span><span class="nf">update</span> <span class="n">params</span><span class="p">[</span><span class="ss">:article</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="nb">format</span><span class="p">.</span><span class="nf">json_patch</span> <span class="k">do</span>
      <span class="c1"># realizar mudan√ßas sofisticadas</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6809adc690321b412fbf5c2dfb07d05b"># em seu controller:
def update
  respond_to do |format|
    format.json do
      # executa uma atualiza√ß√£o parcial
      @article.update params[:article]
    end

    format.json_patch do
      # realizar mudan√ßas sofisticadas
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6809adc690321b412fbf5c2dfb07d05b">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/json_patch.rb</span>
<span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="p">.</span><span class="nf">register</span> <span class="s1">'application/json-patch+json'</span><span class="p">,</span> <span class="ss">:json_patch</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0c25ec0646a940432bfcfeebe559d749"># config/initializers/json_patch.rb
Mime::Type.register 'application/json-patch+json', :json_patch
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0c25ec0646a940432bfcfeebe559d749">Copiar</button>
</div>
<p>Como o JSON Patch foi transformado recentemente em um RFC, n√£o h√° muitas
Bibliotecas Ruby ainda. A <code>gem</code> do Aaron Patterson
<a href="https://github.com/tenderlove/hana">hana</a> √© uma dessas, mas n√£o tem
suporte total para as √∫ltimas mudan√ßas na especifica√ß√£o.</p><h4 id="atualizando-do-rails-3-2-para-o-rails-4-0-gemfile"><a class="anchorlink" href="#atualizando-do-rails-3-2-para-o-rails-4-0-gemfile">10.2 Gemfile</a></h4><p>O Rails 4.0 removeu o grupo <code>assets</code> do <code>Gemfile</code>. Voc√™ precisaria remover essa
linha de seu <code>Gemfile</code> ao atualizar. Voc√™ tamb√©m deve atualizar seu arquivo da
aplica√ß√£o (em <code>config/application.rb</code>):</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Requer as gems listadas no Gemfile, incluindo todas as gems que</span>
<span class="c1"># voc√™ limitou a :test, :development ou :production.</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="p">.</span><span class="nf">groups</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2f17a08345818e472f7e270a504e2c70"># Requer as gems listadas no Gemfile, incluindo todas as gems que
# voc√™ limitou a :test, :development ou :production.
Bundler.require(*Rails.groups)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2f17a08345818e472f7e270a504e2c70">Copiar</button>
</div>
<h4 id="atualizando-do-rails-3-2-para-o-rails-4-0-vendor-plugins"><a class="anchorlink" href="#atualizando-do-rails-3-2-para-o-rails-4-0-vendor-plugins">10.3 vendor/plugins</a></h4><p>O Rails 4.0 n√£o suporta mais o carregamento de <em>plugins</em> de <code>vendor/plugins</code>. Voc√™ deve substituir quaisquer <em>plugins</em>, extraindo-os para <em>gems</em> e adicionando-os ao seu <code>Gemfile</code>. Se voc√™ escolher n√£o torn√°-los <em>gems</em>, voc√™ pode mov√™-los para, digamos, <code>lib/my_plugin/*</code> e adicionar um inicializador apropriado em <code>config/initializers/my_plugin.rb</code>.</p><h4 id="atualizando-do-rails-3-2-para-o-rails-4-0-active-record"><a class="anchorlink" href="#atualizando-do-rails-3-2-para-o-rails-4-0-active-record">10.4 <em>Active Record</em></a></h4>
<ul>
<li><p>O Rails 4.0 removeu o mapa de identidade do Active Record, devido a <a href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">algumas inconsist√™ncias com associa√ß√µes</a>. Se voc√™ o habilitou manualmente em sua aplica√ß√£o, voc√™ ter√° que remover a seguinte configura√ß√£o que n√£o tem mais efeito: <code>config.active_record.identity_map</code>.</p></li>
<li><p>O m√©todo <code>delete</code> em associa√ß√µes de cole√ß√£o agora pode receber argumentos<code>Integer</code> ou <code>String</code> como ids de registro, al√©m de registros, muito parecido com o m√©todo <code>destroy</code>. Anteriormente, ele gerava <code>ActiveRecord::AssociationTypeMismatch</code> para tais argumentos. Do Rails 4.0 em <code>delete</code> automaticamente tenta encontrar os registros que combinam com os ids fornecidos antes de exclu√≠-los.</p></li>
<li><p>No Rails 4.0, quando uma coluna ou tabela √© renomeada, os √≠ndices relacionados tamb√©m s√£o renomeados. Se voc√™ tiver migra√ß√µes que renomeiam os √≠ndices, eles n√£o ser√£o mais necess√°rios.</p></li>
<li><p>Rails 4.0 mudou <code>serialized_attributes</code> e <code>attr_readonly</code> apenas para m√©todos de classe. Voc√™ n√£o deve usar os m√©todos de inst√¢ncia, pois agora est√° obsoleto. Voc√™ deve alter√°-los para usar m√©todos de classe, por exemplo, <code>self.serialized_attributes</code> para <code>self.class.serialized_attributes</code>.</p></li>
<li><p>Ao usar o codificador padr√£o, atribuir <code>nil</code> a um atributo serializado ir√° salv√°-lo
para o banco de dados como <code>NULL</code> em vez de passar o valor <code>nil</code> por meio de YAML (<code>"---\n...\n"</code>).</p></li>
<li><p>Rails 4.0 removeu os recursos <code>attr_accessible</code> e <code>attr_protected</code> em favor dos par√¢metros fortes (<em>Strong Parameters</em>). Voc√™ pode usar a <a href="https://github.com/rails/protected_attributes">gem Protected Attributes</a> para uma atualiza√ß√£o mais suave.</p></li>
<li><p>Se n√£o estiver usando <em>Protected Attributes</em>, voc√™ pode remover todas as op√ß√µes relacionadas a
esta <em>gem</em> como as op√ß√µes <code>whitelist_attributes</code> ou <code>mass_assignment_sanitizer</code>.</p></li>
<li>
<p>O Rails 4.0 requer que os escopos (<em>scopes</em>) usem um objeto que pode ser chamado, como Proc ou lambda:</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span>

  <span class="c1"># torna-se</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fe8af5f6a0f0b86a8483123fa0cb0ab3">  scope :active, where(active: true)

  # torna-se
  scope :active, -&gt; { where active: true }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fe8af5f6a0f0b86a8483123fa0cb0ab3">Copiar</button>
</div>
</li>
<li><p>O Rails 4.0 tornou o <code>ActiveRecord::Fixtures</code> obsoleto em favor do <code>ActiveRecord::FixtureSet</code>.</p></li>
<li><p>O Rails 4.0 tornou o <code>ActiveRecord::TestCase</code> obsoleto em favor do <code>ActiveSupport::TestCase</code>.</p></li>
<li><p>Rails 4.0 descontinuou a API de localiza√ß√£o baseada em hash usando o estilo antigo. Isso significa que
m√©todos que anteriormente aceitavam "op√ß√µes para localiza√ß√£o" n√£o servem mais. Por exemplo, <code>Book.find(:all, conditions: {name: '1984'})</code> foi substitu√≠do por <code>Book.where(name: '1984')</code></p></li>
<li>
<p>Todos os m√©todos din√¢micos, exceto <code>find_by_..</code> e <code>find_by_...!</code> Est√£o obsoletos.
Veja como voc√™ pode lidar com as mudan√ßas:</p>
<ul>
<li>
<code>find_all_by_...</code>           torna-se <code>where(...)</code>.</li>
<li>
<code>find_last_by_...</code>          torna-se <code>where(...).last</code>.</li>
<li>
<code>scoped_by_...</code>             torna-se <code>where(...)</code>.</li>
<li>
<code>find_or_initialize_by_...</code> torna-se <code>find_or_initialize_by(...)</code>.</li>
<li>
<code>find_or_create_by_...</code>     torna-se <code>find_or_create_by(...)</code>.</li>
</ul>
</li>
<li><p>Observe que <code>where(...)</code> retorna uma rela√ß√£o, n√£o um array como os antigos localizadores. Se voc√™ precisar de um <code>Array</code>, use <code>where(...).to_a</code>.</p></li>
<li><p>Esses m√©todos apesar de equivalentes podem n√£o executar o mesmo SQL da implementa√ß√£o anterior.</p></li>
<li><p>Para reativar os localizadores antigos, voc√™ pode usar a <a href="https://github.com/rails/activerecord-deprecated_finders">gem activerecord-deprecated_finders</a>.</p></li>
<li>
<p>O Rails 4.0 mudou para a tabela de jun√ß√£o (<em>join</em>) padr√£o para rela√ß√µes <code>has_and_belongs_to_many</code> para retirar o prefixo comum do nome da segunda tabela. Qualquer relacionamento <code>has_and_belongs_to_many</code> existente entre os <em>models</em> com um prefixo comum deve ser especificado com a op√ß√£o <code>join_table</code>. Por exemplo:</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="no">CatalogCategory</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_products</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>

<span class="no">CatalogProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_categories</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-18e9430064e86c0a093b7209e4851373">CatalogCategory &lt; ActiveRecord::Base
  has_and_belongs_to_many :catalog_products, join_table: 'catalog_categories_catalog_products'
end

CatalogProduct &lt; ActiveRecord::Base
  has_and_belongs_to_many :catalog_categories, join_table: 'catalog_categories_catalog_products'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-18e9430064e86c0a093b7209e4851373">Copiar</button>
</div>
</li>
<li><p>Observe que o prefixo leva os escopos (<em>scopes</em>) em considera√ß√£o tamb√©m, portanto, as rela√ß√µes entre <code>Catalog::Category</code> e <code>Catalog::Product</code> ou <code>Catalog::Category</code> e <code>CatalogProduct</code> precisam ser atualizadas de forma semelhante.</p></li>
</ul>
<h4 id="active-resource"><a class="anchorlink" href="#active-resource">10.5 <em>Active Resource</em></a></h4><p>O Rails 4.0 extraiu o <em>Active Resource</em> para sua pr√≥pria <em>gem</em>. Se voc√™ ainda precisa do recurso, pode adicionar a <a href="https://github.com/rails/activeresource">gem <em>Active Resource</em></a> em seu <code>Gemfile</code>.</p><h4 id="active-model"><a class="anchorlink" href="#active-model">10.6 <em>Active Model</em></a></h4>
<ul>
<li><p>O Rails 4.0 mudou a forma como os erros s√£o anexados ao <code>ActiveModel::Validations::ConfirmationValidator</code>. Agora, quando as valida√ß√µes de confirma√ß√£o falham, o erro ser√° anexado a <code>:#{attribute}_confirmation</code> ao inv√©s de <code>attribute</code>.</p></li>
<li>
<p>Rails 4.0 mudou o valor padr√£o de <code>ActiveModel::Serializers::JSON.include_root_in_json</code> para <code>false</code>. Agora, os <em>Active Model Serializers</em> e os objetos <em>Active Record</em> t√™m o mesmo comportamento padr√£o. Isso significa que voc√™ pode comentar ou remover a seguinte op√ß√£o no arquivo <code>config/initializers/wrap_parameters.rb</code>:</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Desative o elemento raiz em JSON por padr√£o.</span>
<span class="c1"># ActiveSupport.on_load(:active_record) do</span>
<span class="c1">#   self.include_root_in_json = false</span>
<span class="c1"># end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9314fbaedfe6666fae8c2c438ddfb6d0"># Desative o elemento raiz em JSON por padr√£o.
# ActiveSupport.on_load(:active_record) do
#   self.include_root_in_json = false
# end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9314fbaedfe6666fae8c2c438ddfb6d0">Copiar</button>
</div>
</li>
</ul>
<h4 id="action-pack"><a class="anchorlink" href="#action-pack">10.7 <em>Action Pack</em></a></h4>
<ul>
<li>
<p>  Rails 4.0 introduz <code>ActiveSupport::KeyGenerator</code> e usa isso como uma base para gerar e verificar <em>cookies</em> assinados (entre outras coisas). Os <em>cookies</em> assinados existentes gerados com o Rails 3.x ser√£o atualizados de forma transparente se voc√™ deixar seu <code>secret_token</code> existente e adicionar o novo <code>secret_key_base</code>.</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="c1"># config/initializers/secret_token.rb</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_token</span> <span class="o">=</span> <span class="s1">'existing secret token'</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="s1">'new secret key base'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7d27d1159d504d68ef3f25127e64fa1e">  # config/initializers/secret_token.rb
  Myapp::Application.config.secret_token = 'existing secret token'
  Myapp::Application.config.secret_key_base = 'new secret key base'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7d27d1159d504d68ef3f25127e64fa1e">Copiar</button>
</div>
<p>Observe que voc√™ deve esperar para definir <code>secret_key_base</code> at√© ter 100% de sua base de usu√°rios no Rails 4.x e estar razoavelmente certo de que n√£o precisar√° fazer <em>rollback</em> para voltar para o Rails 3.x. Isso ocorre porque os <em>cookies</em> assinados com base no novo <code>secret_key_base</code> no Rails 4.x n√£o s√£o compat√≠veis com vers√µes anteriores do Rails 3.x. Voc√™ √© livre para deixar seu <code>secret_token</code> existente no lugar, n√£o definir o novo <code>secret_key_base</code> e ignorar os avisos de deprecia√ß√£o at√© que esteja razoavelmente certo de que sua atualiza√ß√£o est√° completa.</p>
<p>Se voc√™ est√° contando com a capacidade de aplica√ß√µes externas ou JavaScript de ler os <em>cookies</em> de sess√£o assinada da sua aplica√ß√£o Rails (ou <em>cookies</em> assinados em geral), voc√™ n√£o deve definir <code>secret_key_base</code> at√© que tenha n√£o tenha mais essas preocupa√ß√µes.</p>
</li>
<li>
<p>  O Rails 4.0 criptografa o conte√∫do de sess√µes baseadas em <em>cookies</em> se <code>secret_key_base</code> tiver sido definido. O Rails 3.x assinou, mas n√£o criptografou, o conte√∫do da sess√£o baseada em cookie. Os cookies assinados s√£o "seguros" no sentido de que s√£o verificados se foram gerados pela sua aplica√ß√£o e s√£o √† prova de adultera√ß√£o. No entanto, o conte√∫do pode ser visualizado pelos usu√°rios finais e criptografar o conte√∫do elimina essa advert√™ncia/preocupa√ß√£o sem uma penalidade de desempenho significativa.</p>
<p>Leia <a href="https://github.com/rails/rails/pull/9978">Pull Request #9978</a> para obter detalhes sobre a mudan√ßa para <em>cookies</em> de sess√£o criptografada.</p>
</li>
<li><p>O Rails 4.0 removeu a op√ß√£o <code>ActionController::Base.asset_path</code>. Use o recurso da nova <em>asset pipeline</em>.</p></li>
<li><p>O Rails 4.0 tornou a op√ß√£o <code>ActionController::Base.page_cache_extension</code> obsoleta. Use <code>ActionController::Base.default_static_extension</code> ao inv√©s.</p></li>
<li><p>O Rails 4.0 removeu o <em>cache</em> de <em>Action</em> e <em>Page</em> do Action Pack. Voc√™ precisar√° adicionar a gem <code>actionpack-action_caching</code> para usar <code>caches_action</code> e <code>actionpack-page_caching</code> para usar <code>caches_page</code> em seus <em>controllers</em>.</p></li>
<li><p>O Rails 4.0 removeu o analisador de par√¢metros XML. Voc√™ precisar√° adicionar a gem <code>actionpack-xml_parser</code> se precisar deste recurso.</p></li>
<li><p>O Rails 4.0 muda o conjunto de pesquisa do <code>layout</code> padr√£o usando s√≠mbolos ou procs que retornam <code>nil</code>. Para obter o comportamento "sem layout", retorne false em vez de <code>nil</code>.</p></li>
<li><p>O Rails 4.0 muda o cliente memcached padr√£o de <code>memcache-client</code> para <code>dalli</code>. Para atualizar, simplesmente adicione <code>gem 'dalli'</code> ao seu<code>Gemfile</code>.</p></li>
<li><p>O Rails 4.0 descontinuar√° em breve os m√©todos <code>dom_id</code> e <code>dom_class</code> em <em>controllers</em> (eles podem ser usados em <em>views</em>). Voc√™ precisar√° incluir o m√≥dulo <code>ActionView::RecordIdentifier</code> nos <em>controllers</em> que requerem este recurso.</p></li>
<li><p>O Rails 4.0 descontinuar√° em breve a op√ß√£o <code>:confirm</code> para o helper <code>link_to</code>. Voc√™ deve
em vez disso, usar um atributo de dados (por exemplo, <code>data: {confirm: 'Are you sure?'}</code>).
Esta deprecia√ß√£o tamb√©m diz respeito aos <em>helpers</em> baseados neste (como <code>link_to_if</code>
ou <code>link_to_unless</code>).</p></li>
<li><p>O Rails 4.0 mudou como <code>assert_generates</code>, <code>assert_recognizes</code> e <code>assert_routing</code> funcionam. Agora todas essas asser√ß√µes geram <code>Assertion</code> ao inv√©s de<code>ActionController::RoutingError</code>.</p></li>
<li>
<p> O Rails 4.0 levanta um <code>ArgumentError</code> se rotas nomeadas conflitantes s√£o definidas. Isso pode ser acionado por rotas nomeadas explicitamente definidas ou pelo m√©todo <code>resources</code>. Aqui est√£o dois exemplos que conflitam usando o nome <code>example_path</code>:</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'one'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
<span class="n">get</span> <span class="s1">'two'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ebd8fe724a9b6fb84be7c3353898abf8">get 'one' =&gt; 'test#example', as: :example
get 'two' =&gt; 'test#example', as: :example
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ebd8fe724a9b6fb84be7c3353898abf8">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:examples</span>
<span class="n">get</span> <span class="s1">'clashing/:id'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-93448f8495a816a70188f4c18a297080">resources :examples
get 'clashing/:id' =&gt; 'test#example', as: :example
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-93448f8495a816a70188f4c18a297080">Copiar</button>
</div>
<p>No primeiro caso, voc√™ pode simplesmente evitar usar o mesmo nome para v√°rias
rotas. No segundo, voc√™ pode usar as op√ß√µes <code>only</code> ou <code>except</code> fornecidas pelo
m√©todo <code>resources</code> para restringir as rotas criadas conforme detalhado no
<a href="routing.html%20#restting-the-routes-created">Guia de roteamento</a>.</p>
</li>
<li>
<p>  O Rails 4.0 tamb√©m mudou a forma como as rotas de caracteres Unicode s√£o definidas. Agora voc√™ pode definir rotas de caracteres Unicode diretamente. Se voc√™ j√° usou tais rotas, deve alter√°-las, por exemplo:</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'„Åì„Çì„Å´„Å°„ÅØ'</span><span class="p">),</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ecb1463b4f727c3bda2f0b7bb6e0f900">get Rack::Utils.escape('„Åì„Çì„Å´„Å°„ÅØ'), controller: 'welcome', action: 'index'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ecb1463b4f727c3bda2f0b7bb6e0f900">Copiar</button>
</div>
<p>torna-se</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'„Åì„Çì„Å´„Å°„ÅØ'</span><span class="p">,</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-527cdc912f53e26830aaf8836d9abe1e">get '„Åì„Çì„Å´„Å°„ÅØ', controller: 'welcome', action: 'index'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-527cdc912f53e26830aaf8836d9abe1e">Copiar</button>
</div>
</li>
<li>
<p>  Rails 4.0 requer que as rotas que usam <code>match</code> especifiquem o m√©todo de solicita√ß√£o. Por exemplo:</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="c1"># Rails 3.x</span>
  <span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>

  <span class="c1"># torna-se</span>
  <span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span><span class="p">,</span> <span class="ss">via: :get</span>

  <span class="c1"># ou</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-85bf76ceb8053a44312c1f917c17bed8">  # Rails 3.x
  match '/' =&gt; 'root#index'

  # torna-se
  match '/' =&gt; 'root#index', via: :get

  # ou
  get '/' =&gt; 'root#index'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-85bf76ceb8053a44312c1f917c17bed8">Copiar</button>
</div>
</li>
<li>
<p>  O Rails 4.0 removeu o <em>middleware</em> <code>ActionDispatch::BestStandardsSupport</code>, <code>&lt;!DOCTYPE html&gt;</code>j√° aciona o modo de padr√µes de <a href="https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85)">https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85)</a>. Os cabe√ßalhos aspx e ChromeFrame foram movidos para <code>config.action_dispatch.default_headers</code>.</p>
<p>Lembre-se de que voc√™ tamb√©m deve remover todas as refer√™ncias ao <em>middleware</em> do c√≥digo da sua aplica√ß√£o, por exemplo:</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Levanta exce√ß√£o</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span><span class="p">(</span><span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span><span class="p">,</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">BestStandardsSupport</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5b01264b8c06c94a5a5b60baec3a254f"># Levanta exce√ß√£o
config.middleware.insert_before(Rack::Lock, ActionDispatch::BestStandardsSupport)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5b01264b8c06c94a5a5b60baec3a254f">Copiar</button>
</div>
<p>Verifique tamb√©m suas configura√ß√µes de ambiente por <code>config.action_dispatch.best_standards_support</code> e remova-o se houver.</p>
</li>
<li>
<p>  Rails 4.0 permite a configura√ß√£o de cabe√ßalhos (<em>headers</em>) HTTP definindo <code>config.action_dispatch.default_headers</code>. Os padr√µes s√£o os seguintes:</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">default_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'X-Frame-Options'</span> <span class="o">=&gt;</span> <span class="s1">'SAMEORIGIN'</span><span class="p">,</span>
    <span class="s1">'X-XSS-Protection'</span> <span class="o">=&gt;</span> <span class="s1">'1; mode=block'</span>
  <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ff8e15869148d1c816d793b7df6ca3be">  config.action_dispatch.default_headers = {
    'X-Frame-Options' =&gt; 'SAMEORIGIN',
    'X-XSS-Protection' =&gt; '1; mode=block'
  }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ff8e15869148d1c816d793b7df6ca3be">Copiar</button>
</div>
<p>Observe que se sua aplica√ß√£o depende do carregamento de certas p√°ginas em um <code>&lt;frame&gt;</code> ou <code>&lt;iframe&gt;</code>, ent√£o voc√™ pode precisar definir explicitamente <code>X-Frame-Options</code> para <code>ALLOW-FROM ...</code>ou <code>ALLOWALL</code>.</p>
</li>
<li><p>No Rails 4.0, os recursos de pr√©-compila√ß√£o n√£o copiam mais recursos n√£o JS/CSS automaticamente de <code>vendor/assets</code> e <code>lib/assets</code>. As pessoas desenvolvedoras de aplica√ß√µes e <em>engine</em> Rails devem colocar esses <em>assets</em> em <code>app/assets</code> ou configurar <code>config.assets.precompile</code>.</p></li>
<li><p>No Rails 4.0, o erro <code>ActionController::UnknownFormat</code> √© gerado quando a <em>action</em> n√£o manipula o formato da solicita√ß√£o. Por padr√£o, a exce√ß√£o √© tratada respondendo com 406 N√£o Aceit√°vel, mas voc√™ pode substituir isso agora. No Rails 3, 406 N√£o Aceit√°vel sempre foi retornado. Sem substitui√ß√µes.</p></li>
<li><p>No Rails 4.0, uma exce√ß√£o gen√©rica <code>ActionDispatch::ParamsParser::ParseError</code> √© levantada quando <code>ParamsParser</code> falha em analisar os par√¢metros da solicita√ß√£o. Voc√™ desejar√° resgatar esta exce√ß√£o em vez do baixo n√≠vel <code>MultiJson::DecodeError</code>, por exemplo.</p></li>
<li><p>No Rails 4.0, <code>SCRIPT_NAME</code> √© devidamente aninhado quando os <em>engines</em> s√£o montados em uma aplica√ß√£o e √© servido a partir de um prefixo de URL. Voc√™ n√£o precisa mais definir <code>default_url_options[:script_name]</code> para contornar os prefixos de URL sobrescritos.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::Integration</code> em favor de <code>ActionDispatch :: Integration</code>.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::IntegrationTest</code> em favor de <code>ActionDispatch::IntegrationTest</code>.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::PerformanceTest</code> em favor de <code>ActionDispatch::PerformanceTest</code>.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::AbstractRequest</code> em favor de <code>ActionDispatch::Request</code>.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::Request</code> em favor de <code>ActionDispatch::Request</code>.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::AbstractResponse</code> em favor de <code>ActionDispatch::Response</code>.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::Response</code> em favor de <code>ActionDispatch::Response</code>.</p></li>
<li><p>Rails 4.0 torna obsoleto <code>ActionController::Routing</code> em favor de <code>ActionDispatch::Routing</code>.</p></li>
</ul>
<h4 id="active-support"><a class="anchorlink" href="#active-support">10.8 <em>Active Support</em></a></h4><p>O Rails 4.0 remove o alias <code>j</code> para <code>ERB::Util#json_escape</code> visto que <code>j</code> j√° √© usado para <code>ActionView::Helpers::JavaScriptHelper#escape_javascript</code>.</p><h5 id="cache"><a class="anchorlink" href="#cache">10.8.1 <em>Cache</em></a></h5><p>The caching method changed between Rails 3.x and 4.0. You should <a href="https://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-store">change the cache namespace</a> and roll out with a cold cache.
O m√©todo de <em>cache</em> mudou entre Rails 3.x e 4.0. Voc√™ deve <a href="https://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-store">alterar o <em>namespace</em> do <em>cache</em></a> e implementar com um <em>cold cache</em>.</p><h4 id="ordem-de-carregamento-de-helpers"><a class="anchorlink" href="#ordem-de-carregamento-de-helpers">10.9 Ordem de Carregamento de <em>Helpers</em></a></h4><p>A ordem na qual <em>helpers</em> de mais de um diret√≥rio s√£o carregados mudou no Rails 4.0. Anteriormente, eles eram reunidos e classificados em ordem alfab√©tica. Ap√≥s atualizar para o Rails 4.0, os <em>helpers</em> ir√£o preservar a ordem dos diret√≥rios carregados e ser√£o classificados em ordem alfab√©tica apenas dentro de cada diret√≥rio. A menos que voc√™ use explicitamente o par√¢metro <code>helpers_path</code>, essa mudan√ßa s√≥ afetar√° a maneira de carregar os helpers nas <em>engines</em>. Se voc√™ precisa de uma ordem, deve verificar se os m√©todos corretos est√£o dispon√≠veis ap√≥s a atualiza√ß√£o. Se voc√™ gostaria de mudar a ordem em que as <em>engines</em> s√£o carregados, voc√™ pode usar o m√©todo <code>config.railties_order=</code>.</p><h4 id="active-record-observer-e-action-controller-sweeper"><a class="anchorlink" href="#active-record-observer-e-action-controller-sweeper">10.10 <em>Active Record Observer</em> e <em>Action Controller Sweeper</em></a></h4><p><code>ActiveRecord::Observer</code> e<code>ActionController::Caching::Sweeper</code> foram extra√≠dos para a gem <code>rails-observers</code>. Voc√™ precisar√° adicionar a <em>gem</em> <code>rails-observers</code> se precisar desses recursos.</p><h4 id="sprockets-rails"><a class="anchorlink" href="#sprockets-rails">10.11 sprockets-rails</a></h4>
<ul>
<li>
<code>assets:precompile:primary</code> e<code>assets:precompile:all</code> foram removidos. Em vez disso, use <code>assets:precompile</code>.</li>
<li>
<p>A op√ß√£o <code>config.assets.compress</code> deve ser alterada para <code>config.assets.js_compressor</code> como por exemplo:</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:uglifier</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2a2b572aec5293b29c15ed16d9a98427">config.assets.js_compressor = :uglifier
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2a2b572aec5293b29c15ed16d9a98427">Copiar</button>
</div>
</li>
</ul>
<h4 id="sass-rails"><a class="anchorlink" href="#sass-rails">10.12 sass-rails</a></h4>
<ul>
<li>
<code>asset-url</code> com dois argumentos est√° deprecado. Por exemplo: <code>asset-url("rails.png", image)</code> torna-se <code>asset-url("rails.png")</code>.</li>
</ul>
<h3 id="atualizando-do-rails-3-1-para-o-rails-3-2"><a class="anchorlink" href="#atualizando-do-rails-3-1-para-o-rails-3-2">11 Atualizando do Rails 3.1 para o Rails 3.2</a></h3><p>Se sua aplica√ß√£o est√° atualmente em qualquer vers√£o do Rails anterior a 3.1.x, voc√™
deve atualizar para o Rails 3.1 antes de tentar uma atualiza√ß√£o para o Rails 3.2.</p><p>As seguintes mudan√ßas s√£o destinadas a atualizar sua aplica√ß√£o para a mais recente
vers√£o 3.2.x do Rails.</p><h4 id="atualizando-do-rails-3-1-para-o-rails-3-2-gemfile"><a class="anchorlink" href="#atualizando-do-rails-3-1-para-o-rails-3-2-gemfile">11.1 Gemfile</a></h4><p>Fa√ßa as seguintes altera√ß√µes em seu <code>Gemfile</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.2.21'</span>

<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 3.2.6'</span>
  <span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.2.2'</span>
  <span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>     <span class="s1">'&gt;= 1.0.3'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9825e64eb211d85e336993a6050f6128">gem 'rails', '3.2.21'

group :assets do
  gem 'sass-rails',   '~&gt; 3.2.6'
  gem 'coffee-rails', '~&gt; 3.2.2'
  gem 'uglifier',     '&gt;= 1.0.3'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9825e64eb211d85e336993a6050f6128">Copiar</button>
</div>
<h4 id="atualizando-do-rails-3-1-para-o-rails-3-2-config-environments-development-rb"><a class="anchorlink" href="#atualizando-do-rails-3-1-para-o-rails-3-2-config-environments-development-rb">11.2 config/environments/development.rb</a></h4><p>Existem algumas novas defini√ß√µes de configura√ß√£o que voc√™ deve adicionar ao seu ambiente de desenvolvimento:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Levantar exce√ß√£o na prote√ß√£o de atribui√ß√£o em massa para models Active Record</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>

<span class="c1"># Registrar o log da query para consultas que ocupem mais do que isso (funciona</span>
<span class="c1"># com SQLite, MySQL e PostgreSQL)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">auto_explain_threshold_in_seconds</span> <span class="o">=</span> <span class="mf">0.5</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-354cbf4a21f3abcb7104447182ba1cb6"># Levantar exce√ß√£o na prote√ß√£o de atribui√ß√£o em massa para models Active Record
config.active_record.mass_assignment_sanitizer = :strict

# Registrar o log da query para consultas que ocupem mais do que isso (funciona
# com SQLite, MySQL e PostgreSQL)
config.active_record.auto_explain_threshold_in_seconds = 0.5
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-354cbf4a21f3abcb7104447182ba1cb6">Copiar</button>
</div>
<h4 id="atualizando-do-rails-3-1-para-o-rails-3-2-config-environments-test-rb"><a class="anchorlink" href="#atualizando-do-rails-3-1-para-o-rails-3-2-config-environments-test-rb">11.3 config/environments/test.rb</a></h4><p>A defini√ß√£o de configura√ß√£o <code>mass_assignment_sanitizer</code> tamb√©m deve ser adicionada a<code>config/environment/test.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Levantar exce√ß√£o na prote√ß√£o de atribui√ß√£o em massa para models Active Record</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d7b333d50da73942c236c75851504015"># Levantar exce√ß√£o na prote√ß√£o de atribui√ß√£o em massa para models Active Record
config.active_record.mass_assignment_sanitizer = :strict
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d7b333d50da73942c236c75851504015">Copiar</button>
</div>
<h4 id="atualizando-do-rails-3-1-para-o-rails-3-2-vendor-plugins"><a class="anchorlink" href="#atualizando-do-rails-3-1-para-o-rails-3-2-vendor-plugins">11.4 vendor/plugins</a></h4><p>O Rails 3.2 depreca <code>vendor/plugins</code> e o Rails 4.0 ir√° remov√™-los completamente. Embora n√£o seja estritamente necess√°rio como parte de uma atualiza√ß√£o do Rails 3.2, voc√™ pode come√ßar a substituir quaisquer <em>plugins</em>, extraindo-os para <em>gems</em> e adicionando-os ao seu <code>Gemfile</code>. Se voc√™ escolher n√£o torn√°-los <em>gems</em>, voc√™ pode mov√™-los para, digamos, <code>lib/my_plugin/*</code> e adicionar um inicializador apropriado em <code>config/initializers/my_plugin.rb</code>.</p><h4 id="atualizando-do-rails-3-1-para-o-rails-3-2-active-record"><a class="anchorlink" href="#atualizando-do-rails-3-1-para-o-rails-3-2-active-record">11.5 Active Record</a></h4><p>A op√ß√£o <code>:dependent =&gt;: restrict</code> foi removida de <code>belongs_to</code>. Se voc√™ quiser evitar a exclus√£o do objeto se houver algum objeto associado, voc√™ pode definir <code>:dependent =&gt; :destroy</code> e retornar <code>false</code> ap√≥s verificar a exist√™ncia de associa√ß√£o de qualquer retorno de chamada de destrui√ß√£o do objeto associado.</p><h3 id="atualizando-do-rails-3-0-para-o-rails-3-1"><a class="anchorlink" href="#atualizando-do-rails-3-0-para-o-rails-3-1">12 Atualizando do Rails 3.0 para o Rails 3.1</a></h3><p>Se sua aplica√ß√£o estiver em qualquer vers√£o do Rails anterior a 3.0.x, voc√™ deve atualizar para o Rails 3.0 antes de tentar uma atualiza√ß√£o para o Rails 3.1.</p><p>As seguintes mudan√ßas s√£o destinadas para atualizar sua aplica√ß√£o para o Rails 3.1.12, a √∫ltima vers√£o 3.1.x do Rails.</p><h4 id="gemfile"><a class="anchorlink" href="#gemfile">12.1 Gemfile</a></h4><p>Fa√ßa as seguintes mudan√ßas no seu <code>Gemfile</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.1.12'</span>
<span class="n">gem</span> <span class="s1">'mysql2'</span>

<span class="c1"># Necess√°rio para o novo pipeline de assets</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 3.1.7'</span>
  <span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.1.1'</span>
  <span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>     <span class="s1">'&gt;= 1.0.3'</span>
<span class="k">end</span>

<span class="c1"># jQuery √© a biblioteca JavaScript padr√£o no Rails 3.1</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0af356b44094c15404c23bf8578bd63e">gem 'rails', '3.1.12'
gem 'mysql2'

# Necess√°rio para o novo pipeline de assets
group :assets do
  gem 'sass-rails',   '~&gt; 3.1.7'
  gem 'coffee-rails', '~&gt; 3.1.1'
  gem 'uglifier',     '&gt;= 1.0.3'
end

# jQuery √© a biblioteca JavaScript padr√£o no Rails 3.1
gem 'jquery-rails'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0af356b44094c15404c23bf8578bd63e">Copiar</button>
</div>
<h4 id="config-application-rb"><a class="anchorlink" href="#config-application-rb">12.2 config/application.rb</a></h4><p>A pipeline de <em>assets</em> requer as seguintes adi√ß√µes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="s1">'1.0'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-467de0695049f849802a0f7dcf3482e5">config.assets.enabled = true
config.assets.version = '1.0'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-467de0695049f849802a0f7dcf3482e5">Copiar</button>
</div>
<p>Se sua aplica√ß√£o estiver usando uma rota "/assets" para um <code>resource</code>, voc√™ pode querer alterar o prefixo usado para <em>assets</em> para evitar conflitos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># O padr√£o √© '/assets'</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s1">'/asset-files'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d934c50f64c338ea1b4d034459ed2dfa"># O padr√£o √© '/assets'
config.assets.prefix = '/asset-files'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d934c50f64c338ea1b4d034459ed2dfa">Copiar</button>
</div>
<h4 id="atualizando-do-rails-3-0-para-o-rails-3-1-config-environments-development-rb"><a class="anchorlink" href="#atualizando-do-rails-3-0-para-o-rails-3-1-config-environments-development-rb">12.3 config/environments/development.rb</a></h4><p>Remova a configura√ß√£o RJS <code>config.action_view.debug_rjs = true</code>.</p><p>Adicione essas configura√ß√µes se voc√™ habilitar a pipeline de <em>assets</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># N√£o comprimir os assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Expande as linhas que carregam os assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-521f3d94a5fa7d388b1d26434b81e450"># N√£o comprimir os assets
config.assets.compress = false

# Expande as linhas que carregam os assets
config.assets.debug = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-521f3d94a5fa7d388b1d26434b81e450">Copiar</button>
</div>
<h4 id="config-environments-production-rb"><a class="anchorlink" href="#config-environments-production-rb">12.4 config/environments/production.rb</a></h4><p>Novamente, a maioria das mudan√ßas abaixo s√£o para a pipeline de <em>assets</em>. Voc√™ pode ler mais sobre isso no guia <a href="asset_pipeline.html">Asset Pipeline</a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Comprime JavaScripts e CSS</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># N√£o use a compila√ß√£o da pipeline de assets se um ativo pr√©-compilado for perdido</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Gera uma URLs especifica para assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># O padr√£o √© Rails.root.join("public/assets")</span>
<span class="c1"># config.assets.manifest = YOUR_PATH</span>

<span class="c1"># Pr√©-compilar recursos adicionais (application.js, application.css e todos os n√£o JS/CSS j√° foram adicionados)</span>
<span class="c1"># config.assets.precompile += %w( admin.js admin.css )</span>

<span class="c1"># Force todo o acesso da aplica√ß√£o por SSL, use Strict-Transport-Security e use cookies seguros.</span>
<span class="c1"># config.force_ssl = true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ce870a0d7a5cf6290d2a35db63278294"># Comprime JavaScripts e CSS
config.assets.compress = true

# N√£o use a compila√ß√£o da pipeline de assets se um ativo pr√©-compilado for perdido
config.assets.compile = false

# Gera uma URLs especifica para assets
config.assets.digest = true

# O padr√£o √© Rails.root.join("public/assets")
# config.assets.manifest = YOUR_PATH

# Pr√©-compilar recursos adicionais (application.js, application.css e todos os n√£o JS/CSS j√° foram adicionados)
# config.assets.precompile += %w( admin.js admin.css )

# Force todo o acesso da aplica√ß√£o por SSL, use Strict-Transport-Security e use cookies seguros.
# config.force_ssl = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ce870a0d7a5cf6290d2a35db63278294">Copiar</button>
</div>
<h4 id="atualizando-do-rails-3-0-para-o-rails-3-1-config-environments-test-rb"><a class="anchorlink" href="#atualizando-do-rails-3-0-para-o-rails-3-1-config-environments-test-rb">12.5 config/environments/test.rb</a></h4><p>Voc√™ pode ajudar a testar o desempenho com estas adi√ß√µes ao seu ambiente de teste:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Configure o servidor de ativos est√°ticos para testes com Cache-Control para melhor performance</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'Cache-Control'</span> <span class="o">=&gt;</span> <span class="s1">'public, max-age=3600'</span>
<span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-223a7293e9d64cea202baf7427d017e1"># Configure o servidor de ativos est√°ticos para testes com Cache-Control para melhor performance
config.public_file_server.enabled = true
config.public_file_server.headers = {
  'Cache-Control' =&gt; 'public, max-age=3600'
}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-223a7293e9d64cea202baf7427d017e1">Copiar</button>
</div>
<h4 id="config-initializers-wrap-parameters-rb"><a class="anchorlink" href="#config-initializers-wrap-parameters-rb">12.6 config/initializers/wrap_parameters.rb</a></h4><p>Adicione este arquivo com o seguinte conte√∫do, se desejar agrupar os par√¢metros em um <em>hash</em> aninhado. Isso est√° ativado por padr√£o em novas aplica√ß√µes.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Certifique-se de reiniciar o servidor ao modificar este arquivo.</span>
<span class="c1"># Este arquivo cont√©m configura√ß√µes para ActionController::ParamsWrapper que</span>
<span class="c1"># est√° habilitado por padr√£o.</span>

<span class="c1"># Habilite o agrupamento de par√¢metros para JSON. Voc√™ pode desabilitar isso configurando: format para um array vazio.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">wrap_parameters</span> <span class="ss">format: </span><span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
<span class="k">end</span>

<span class="c1"># Desative o elemento raiz em JSON por padr√£o.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">include_root_in_json</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a8e396f4338a65ce210f05558c83c25b"># Certifique-se de reiniciar o servidor ao modificar este arquivo.
# Este arquivo cont√©m configura√ß√µes para ActionController::ParamsWrapper que
# est√° habilitado por padr√£o.

# Habilite o agrupamento de par√¢metros para JSON. Voc√™ pode desabilitar isso configurando: format para um array vazio.
ActiveSupport.on_load(:action_controller) do
  wrap_parameters format: [:json]
end

# Desative o elemento raiz em JSON por padr√£o.
ActiveSupport.on_load(:active_record) do
  self.include_root_in_json = false
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a8e396f4338a65ce210f05558c83c25b">Copiar</button>
</div>
<h4 id="config-initializers-session-store-rb"><a class="anchorlink" href="#config-initializers-session-store-rb">12.7 config/initializers/session_store.rb</a></h4><p>Voc√™ precisa alterar sua chave de sess√£o para algo novo ou remover todas as sess√µes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># em config/initializers/session_store.rb</span>
<span class="no">AppName</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'SOMETHINGNEW'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2d26bb4a2bfec82c951e5b37c65cbc34"># em config/initializers/session_store.rb
AppName::Application.config.session_store :cookie_store, key: 'SOMETHINGNEW'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2d26bb4a2bfec82c951e5b37c65cbc34">Copiar</button>
</div>
<p>or</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/rake db:sessions:clear
</code></pre>
<textarea class="clipboard-content" id="clipboard-6a6d21f5e2c4390856813a367c02a079">bin/rake db:sessions:clear
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6a6d21f5e2c4390856813a367c02a079">Copiar</button>
</div>
<h4 id="remover-opcoes-de-cache-e-concat-em-referencias-de-helpers-para-assets-em-views"><a class="anchorlink" href="#remover-opcoes-de-cache-e-concat-em-referencias-de-helpers-para-assets-em-views">12.8 Remover op√ß√µes de :cache e :concat em refer√™ncias de <em>helpers</em> para <em>assets</em> em <em>views</em></a></h4>
<ul>
<li>Com a <em>Asset Pipeline</em>, as op√ß√µes :cache e :concat n√£o s√£o mais usadas, exclua essas op√ß√µes de suas <em>views</em>.</li>
</ul>


        <h3>Feedback</h3>
        <p>
          Voc√™ √© incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua caso veja quaisquer erros, inclusive erros de digita√ß√£o.
          Para come√ßar, voc√™ pode ler nossa sess√£o de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documenta√ß√£o</a>.
        </p>
        <p>
          Voc√™ tamb√©m pode encontrar conte√∫do incompleto ou coisas que n√£o est√£o atualizadas.
          Por favor, adicione qualquer documenta√ß√£o em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema j√° foi resolvido ou n√£o no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e conven√ß√µes.
        </p>
        <p>
          Se, por qualquer motivo, voc√™ encontrar algo para consertar, mas n√£o conseguir consert√°-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por √∫ltimo, mas n√£o menos importante, qualquer tipo de discuss√£o sobre a documenta√ß√£o do Ruby on Rails
          √© muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discuss√£o rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em portugu√™s</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto est√° licenciado sob uma licen√ßa <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails s√£o marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
