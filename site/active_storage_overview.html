<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Storage Overview — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Active Storage Overview — Ruby on Rails Guides" />
  <meta name="description" content="Active Storage OverviewThis guide covers how to attach files to your Active Record models.After reading this guide, you will know: How to attach one or many files to a record. How to delete an attached file. How to link to an attached file. How to use variants to transform images. How to generate an image representation of a non-image file, such as a PDF or a video. How to send file uploads directly from browsers to a storage service, bypassing your application servers. How to clean up files stored during testing. How to implement support for additional storage services." />
  <meta property="og:description" content="Active Storage OverviewThis guide covers how to attach files to your Active Record models.After reading this guide, you will know: How to attach one or many files to a record. How to delete an attached file. How to link to an attached file. How to use variants to transform images. How to generate an image representation of a non-image file, such as a PDF or a video. How to send file uploads directly from browsers to a storage service, bypassing your application servers. How to clean up files stored during testing. How to implement support for additional storage services." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.8</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                  <dd><a href="active_record_encryption.html">Active Record Encryption</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - Dezembro 2021</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</option>
                  <option value="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
                  <option value="active_record_encryption.html">Active Record Encryption</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_0_release_notes.html">Version 7.0 - Dezembro 2021</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Active Storage Overview</h2><p>This guide covers how to attach files to your Active Record models.</p><p>After reading this guide, you will know:</p>
<ul>
<li>How to attach one or many files to a record.</li>
<li>How to delete an attached file.</li>
<li>How to link to an attached file.</li>
<li>How to use variants to transform images.</li>
<li>How to generate an image representation of a non-image file, such as a PDF or a video.</li>
<li>How to send file uploads directly from browsers to a storage service,
bypassing your application servers.</li>
<li>How to clean up files stored during testing.</li>
<li>How to implement support for additional storage services.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#o-que-%C3%A9-active-storage-questionmark">O que é <em>Active Storage</em>?</a>

<ul>
<li><a href="#requirements">Requirements</a></li>
</ul>
</li>
<li>
<a href="#configura%C3%A7%C3%A3o">Configuração</a>

<ul>
<li><a href="#servi%C3%A7o-disk">Serviço Disk</a></li>
<li><a href="#servi%C3%A7o-s3-amazon-s3-e-apis-compat%C3%ADveis-com-s3">Serviço S3 (Amazon S3 e APIs compatíveis com S3)</a></li>
<li><a href="#servi%C3%A7o-armazenamento-da-microsoft-azure">Serviço Armazenamento da Microsoft Azure</a></li>
<li><a href="#servi%C3%A7o-google-cloud-storage">Serviço Google Cloud Storage</a></li>
<li><a href="#servi%C3%A7o-espelho">Serviço Espelho</a></li>
<li><a href="#acesso-p%C3%BAblico">Acesso público</a></li>
</ul>
</li>
<li>
<a href="#anexar-arquivos-a-registros">Anexar Arquivos a Registros</a>

<ul>
<li><a href="#has-one-attached"><code>has_one_attached</code></a></li>
<li><a href="#has-many-attached"><code>has_many_attached</code></a></li>
<li><a href="#anexando-objetos-file-io">Anexando Objetos <em>File/IO</em></a></li>
</ul>
</li>
<li><a href="#removendo-arquivos">Removendo arquivos</a></li>
<li>
<a href="#serving-files">Serving Files</a>

<ul>
<li><a href="#redirect-mode">Redirect Mode</a></li>
<li><a href="#proxy-mode">Proxy Mode</a></li>
<li><a href="#authenticated-controllers">Authenticated Controllers</a></li>
</ul>
</li>
<li><a href="#baixando-arquivos">Baixando arquivos</a></li>
<li><a href="#analyzing-files">Analyzing Files</a></li>
<li>
<a href="#displaying-images-videos-and-pdfs">Displaying Images, Videos, and PDFs</a>

<ul>
<li><a href="#lazy-vs-immediate-loading">Lazy vs Immediate Loading</a></li>
<li><a href="#transforming-images">Transforming Images</a></li>
<li><a href="#pr%C3%A9-visualiza%C3%A7%C3%A3o-de-arquivos">Pré-visualização de arquivos</a></li>
</ul>
</li>
<li>
<a href="#uploads-diretos"><em>Uploads</em> Diretos</a>

<ul>
<li><a href="#uso">Uso</a></li>
<li><a href="#configura%C3%A7%C3%A3o-do-cross-origin-resource-sharing-cors">Configuração do <em>Cross-Origin Resource Sharing</em> (CORS)</a></li>
<li><a href="#eventos-de-upload-direto-do-javascript">Eventos de <em>Upload</em> Direto do JavaScript</a></li>
<li><a href="#exemplo">Exemplo</a></li>
<li><a href="#integrando-com-bibliotecas-ou-frameworks">Integrando com Bibliotecas ou <em>Frameworks</em></a></li>
</ul>
</li>
<li>
<a href="#testando">Testando</a>

<ul>
<li><a href="#descartando-arquivos-criados-durante-os-testes">Descartando Arquivos Criados Durante os Testes</a></li>
<li><a href="#adicionando-arquivos-em-fixtures">Adicionando Arquivos em Fixtures</a></li>
</ul>
</li>
<li><a href="#implementando-suporte-a-outros-servi%C3%A7os-cloud">Implementando Suporte a Outros Serviços <em>Cloud</em></a></li>
<li><a href="#purging-unattached-uploads">Purging Unattached Uploads</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="o-que-é-active-storage-questionmark"><a class="anchorlink" href="#o-que-%C3%A9-active-storage-questionmark">1 O que é <em>Active Storage</em>?</a></h3><p>O <em>Active Storage</em> facilita o <em>upload</em> de arquivos para um serviço de armazenamento como
<em>Amazon S3</em>, <em>Google Cloud Storage</em>, ou <em>Microsoft Azure Storage</em> e anexa esses
arquivos para objetos <em>Active Record</em>. Ele vem com um serviço local baseado em disco para
desenvolvimento e teste e oferece suporte a espelhamento de arquivos em serviços destinados para
<em>backups</em> e <em>migrations</em>.</p><p>Usando o <em>Active Storage</em>, uma aplicação pode transformar <em>uploads</em> de imagens ou gerar
representações de <em>uploads</em> que não são imagens, como PDFs e vídeos, e extrair metadados de
arquivos arbitrários.</p><h4 id="requirements"><a class="anchorlink" href="#requirements">1.1 Requirements</a></h4><p>Vários recursos do <em>Active Storage</em> dependem de softwares de terceiros que o Rails
não instala e devem ser instalados separadamente:</p>
<ul>
<li>
<a href="https://github.com/libvips/libvips">libvips</a> v8.6+ ou <a href="https://imagemagick.org/index.php">ImageMagick</a> para análise de imagens e modificações</li>
<li>
<a href="http://ffmpeg.org/">ffmpeg</a> v3.4+ para preview de vídeo e ffprobe para análise de vídeo/áudio</li>
<li>
<a href="https://poppler.freedesktop.org/">poppler</a> ou <a href="https://mupdf.com/">muPDF</a> para pre-visualização de PDF</li>
</ul>
<p>Análise e transformações de imagem também requerem a <em>gem</em> <code>image_processing</code>. Descomente-a em seu <code>Gemfile</code> ou adicione-a se necessário:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"image_processing"</span><span class="p">,</span> <span class="s2">"&gt;= 1.2"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "image_processing", "&gt;= 1.2"
'>Copy</button>
</div>
<div class="info"><p>Comparado a libvips, a ImageMagick é mais conhecida e mais amplamente disponível. No entanto, libvips pode ser <a href="https://github.com/libvips/libvips/wiki/Speed-and-memory-use">até 10x mais rápido e consumir 1/10 da memória</a>. Para arquivos JPEG, isso pode ser melhorado substituindo <code>libjpeg-dev</code> por <code>libjpeg-turbo-dev</code>, que é <a href="https://libjpeg-turbo.org/About/Performance">2-7x mais rápido</a>.</p></div><div class="warning"><p>Antes de instalar e usar software de terceiros, certifique-se de compreender as implicações de licenciamento de fazê-lo. O MuPDF, em particular, é licenciado sob AGPL e requer uma licença comercial para alguns usos.</p></div><h3 id="configuração"><a class="anchorlink" href="#configura%C3%A7%C3%A3o">2 Configuração</a></h3><p>O <em>Active Storage</em> usa três tabelas no banco de dados da sua aplicação chamadas
<code>active_storage_blobs</code>, <code>active_storage_variant_records</code> e <code>active_storage_attachments</code>. Depois de criar uma nova aplicação (ou atualizar sua aplicação para Rails 5.2), execute
<code>bin/rails active_storage:install</code> para gerar uma <em>migration</em> que cria essas
tabelas. Use <code>bin/rails db:migrate</code> para executar a <em>migration</em>.</p><div class="warning"><p><code>active_storage_attachments</code> é uma tabela de junção (<em>join table</em>) polimórfica que armazena o nome da classe do seu <em>model</em>. Se o nome da classe do seu <em>model</em> mudar, você precisará executar uma <em>migration</em> nesta tabela para atualizar o <code>record_type</code> implícito para o novo nome da classe do seu <em>model</em>.</p></div><div class="warning"><p>Se você estiver usando UUIDs em vez de inteiros como a chave primária em seus <em>models</em>, você precisará alterar o tipo de coluna de <code>active_storage_attachments.record_id</code> e <code>active_storage_variant_records.id</code> na migração.</p></div><p>Declare os serviços do <em>Active Storage</em> em <code>config/storage.yml</code>. Para cada serviço que sua
aplicação usa, forneça um nome e a configuração necessária. O exemplo
abaixo declara três serviços chamados <code>local</code>, <code>test</code> e <code>amazon</code>:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">local</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("storage") %&gt;</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("tmp/storage") %&gt;</span>

<span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span> <span class="c1"># e.g. 'us-east-1'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="local:
  service: Disk
  root: &lt;%= Rails.root.join(&quot;storage&quot;) %&gt;

test:
  service: Disk
  root: &lt;%= Rails.root.join(&quot;tmp/storage&quot;) %&gt;

amazon:
  service: S3
  access_key_id: &quot;&quot;
  secret_access_key: &quot;&quot;
  bucket: &quot;&quot;
  region: &quot;&quot; # e.g. 'us-east-1'
">Copy</button>
</div>
<p>Tell Active Storage which service to use by setting
<code>Rails.application.config.active_storage.service</code>. Because each environment will
likely use a different service, it is recommended to do this on a
per-environment basis. To use the disk service from the previous example in the
development environment, you would add the following to
<code>config/environments/development.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Store files locally.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">service</span> <span class="o">=</span> <span class="ss">:local</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Store files locally.
config.active_storage.service = :local
">Copy</button>
</div>
<p>Para usar o serviço S3 em produção, você adiciona o seguinte ao
<code>config/environments/production.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Store files on Amazon S3.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">service</span> <span class="o">=</span> <span class="ss">:amazon</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Store files on Amazon S3.
config.active_storage.service = :amazon
">Copy</button>
</div>
<p>Para usar o serviço <em>test</em> durante o teste, você adiciona o seguinte ao
<code>config/environments/test.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Store uploaded files on the local file system in a temporary directory.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">service</span> <span class="o">=</span> <span class="ss">:test</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Store uploaded files on the local file system in a temporary directory.
config.active_storage.service = :test
">Copy</button>
</div>
<p>Continue lendo para obter mais informações sobre os adaptadores de serviço integrados (por exemplo,
<code>Disk</code> e <code>S3</code>) e configurações que ele exigem.</p><div class="note"><p>Os arquivos de configuração específicos do ambiente terão precedência:
em produção, por exemplo, o arquivo <code>config/storage/production.yml</code> (se existente)
terá precedência sobre o arquivo <code>config/storage.yml</code>.</p></div><p>É recomendado usar <code>Rails.env</code> nos nomes dos buckets para reduzir ainda mais o risco de destruição acidental de dados de produção.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="c1"># ...</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s">your_own_bucket-&lt;%= Rails.env %&gt;</span>

<span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="c1"># ...</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s">your_own_bucket-&lt;%= Rails.env %&gt;</span>

<span class="na">azure</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">AzureStorage</span>
  <span class="c1"># ...</span>
  <span class="na">container</span><span class="pi">:</span> <span class="s">your_container_name-&lt;%= Rails.env %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="amazon:
  service: S3
  # ...
  bucket: your_own_bucket-&lt;%= Rails.env %&gt;

google:
  service: GCS
  # ...
  bucket: your_own_bucket-&lt;%= Rails.env %&gt;

azure:
  service: AzureStorage
  # ...
  container: your_container_name-&lt;%= Rails.env %&gt;
">Copy</button>
</div>
<h4 id="serviço-disk"><a class="anchorlink" href="#servi%C3%A7o-disk">2.1 Serviço Disk</a></h4><p>Declare um serviço Disk em <code>config/storage.yml</code>:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">local</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("storage") %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='local:
  service: Disk
  root: &lt;%= Rails.root.join("storage") %&gt;
'>Copy</button>
</div>
<h4 id="serviço-s3-amazon-s3-e-apis-compatíveis-com-s3"><a class="anchorlink" href="#servi%C3%A7o-s3-amazon-s3-e-apis-compat%C3%ADveis-com-s3">2.2 Serviço S3 (Amazon S3 e APIs compatíveis com S3)</a></h4><p>Para conectar ao Amazon S3, declare um serviço S3 em <code>config/storage.yml</code>:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='amazon:
  service: S3
  access_key_id: ""
  secret_access_key: ""
  region: ""
  bucket: ""
'>Copy</button>
</div>
<p>Opcionalmente, você pode fornecer opções de cliente e upload:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">http_open_timeout</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">http_read_timeout</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">retry_limit</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">upload</span><span class="pi">:</span>
    <span class="na">server_side_encryption</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span> <span class="c1"># 'aws:kms' ou 'AES256'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="amazon:
  service: S3
  access_key_id: &quot;&quot;
  secret_access_key: &quot;&quot;
  region: &quot;&quot;
  bucket: &quot;&quot;
  http_open_timeout: 0
  http_read_timeout: 0
  retry_limit: 0
  upload:
    server_side_encryption: &quot;&quot; # 'aws:kms' ou 'AES256'
">Copy</button>
</div>
<div class="info"><p>Defina tempos limites de HTTP <em>timeout</em> e limites de nova tentativa para sua aplicação.
Em certos cenários de falha, a configuração do cliente AWS padrão pode fazer
com que as conexões sejam retidas por vários minutos e levar à enfileiramento de requisições.</p></div><p>Adicione a gem <a href="https://github.com/aws/aws-sdk-ruby"><code>aws-sdk-s3</code></a> no seu <code>Gemfile</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"aws-sdk-s3"</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "aws-sdk-s3", require: false
'>Copy</button>
</div>
<div class="note"><p>Os principais recursos do <em>Active Storage</em> requerem as seguintes permissões: <code>s3:ListBucket</code>, <code>s3:PutObject</code>, <code>s3:GetObject</code>, e <code>s3:DeleteObject</code>. <a href="#acesso-publico">Acesso público</a> requer também <code>s3:PutObjectAcl</code>. Se você tiver opções de <em>upload</em> adicionais configuradas como configurações de ACLs, então permissões adicionais podem ser necessárias.</p></div><div class="note"><p>Se você quiser usar variáveis de ambiente, arquivos de configuração padrão do SDK, perfis,
perfis de instância do IAM ou funções de tarefa, você pode omitir as chaves <code>access_key_id</code>, <code>secret_access_key</code>,
e <code>region</code> no exemplo acima. O serviço S3 suporta todas as opções de
autenticação descritas na <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/developer-guide/setup-config.html">documentação AWS SDK</a>.</p></div><p>Para se conectar a uma API de armazenamento de objetos compatíveis com S3, como DigitalOcean Spaces, forneça o <code>endpoint</code>:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">digitalocean</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">endpoint</span><span class="pi">:</span> <span class="s">https://nyc3.digitaloceanspaces.com</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s">...</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s">...</span>
  <span class="c1"># ...e outras opções</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="digitalocean:
  service: S3
  endpoint: https://nyc3.digitaloceanspaces.com
  access_key_id: ...
  secret_access_key: ...
  # ...e outras opções
">Copy</button>
</div>
<p>Existem muitas outras opções disponíveis. Você pode verificá-los na documentação do <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/S3/Client.html#initialize-instance_method">AWS S3 Client</a>.</p><h4 id="serviço-armazenamento-da-microsoft-azure"><a class="anchorlink" href="#servi%C3%A7o-armazenamento-da-microsoft-azure">2.3 Serviço Armazenamento da Microsoft Azure</a></h4><p>Declare um serviço Azure Storage em <code>config/storage.yml</code>:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">azure</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">AzureStorage</span>
  <span class="na">storage_account_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">storage_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">container</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='azure:
  service: AzureStorage
  storage_account_name: ""
  storage_access_key: ""
  container: ""
'>Copy</button>
</div>
<p>Adicione a gem <a href="https://github.com/Azure/azure-storage-ruby"><code>azure-storage-blob</code></a> no seu <code>Gemfile</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"azure-storage-blob"</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "azure-storage-blob", require: false
'>Copy</button>
</div>
<h4 id="serviço-google-cloud-storage"><a class="anchorlink" href="#servi%C3%A7o-google-cloud-storage">2.4 Serviço Google Cloud Storage</a></h4><p>Declare um serviço Google Cloud Storage service in <code>config/storage.yml</code>:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="na">credentials</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("path/to/keyfile.json") %&gt;</span>
  <span class="na">project</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  credentials: &lt;%= Rails.root.join("path/to/keyfile.json") %&gt;
  project: ""
  bucket: ""
'>Copy</button>
</div>
<p>Opcionalmente forneça uma <em>Hash</em> de credenciais em vez de um caminho para o arquivo de chave:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="na">credentials</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">service_account"</span>
    <span class="na">project_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">private_key_id</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:gcs, :private_key_id) %&gt;</span>
    <span class="na">private_key</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:gcs, :private_key).dump %&gt;</span>
    <span class="na">client_email</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">client_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">auth_uri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://accounts.google.com/o/oauth2/auth"</span>
    <span class="na">token_uri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://accounts.google.com/o/oauth2/token"</span>
    <span class="na">auth_provider_x509_cert_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://www.googleapis.com/oauth2/v1/certs"</span>
    <span class="na">client_x509_cert_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">project</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  credentials:
    type: "service_account"
    project_id: ""
    private_key_id: &lt;%= Rails.application.credentials.dig(:gcs, :private_key_id) %&gt;
    private_key: &lt;%= Rails.application.credentials.dig(:gcs, :private_key).dump %&gt;
    client_email: ""
    client_id: ""
    auth_uri: "https://accounts.google.com/o/oauth2/auth"
    token_uri: "https://accounts.google.com/o/oauth2/token"
    auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs"
    client_x509_cert_url: ""
  project: ""
  bucket: ""
'>Copy</button>
</div>
<p>Opcionalmente, forneça metadados Cache-Control para serem definidos nos recursos enviados:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="s">...</span>
  <span class="na">cache_control</span><span class="pi">:</span> <span class="s2">"</span><span class="s">public,</span><span class="nv"> </span><span class="s">max-age=3600"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  ...
  cache_control: "public, max-age=3600"
'>Copy</button>
</div>
<p>Opcionalmente, use <a href="https://cloud.google.com/storage/docs/access-control/signed-urls#signing-iam">IAM</a> em vez das <code>credentials</code> ao assinar URLs. Isso é útil se você estiver autenticando suas aplicações do GKE com o Workload Identity. Consulte <a href="https://cloud.google.com/blog/products/containers-kubernetes/introducing-workload-identity-better-authentication%20-for-your-gke-applications">esta postagem do blog do Google Cloud</a> para obter mais informações.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="s">...</span>
  <span class="na">iam</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="google:
  service: GCS
  ...
  iam: true
">Copy</button>
</div>
<p>Opcionalmente, use um GSA específico ao assinar URLs. Ao usar o IAM, o <a href="https://cloud.google.com/compute/docs/storing-retrieving-metadata">servidor de metadados</a> será contatado para obter o e-mail do GSA, mas esse servidor de metadados nem sempre está presente (por exemplo, em ambientes locais ou testes) e você pode querer usar um GSA não padrão.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="s">...</span>
  <span class="na">iam</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">gsa_email</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foobar@baz.iam.gserviceaccount.com"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  ...
  iam: true
  gsa_email: "foobar@baz.iam.gserviceaccount.com"
'>Copy</button>
</div>
<p>Adicione a gem <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby/tree/master/google-cloud-storage"><code>google-cloud-storage</code></a> no seu <code>Gemfile</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"google-cloud-storage"</span><span class="p">,</span> <span class="s2">"~&gt; 1.11"</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "google-cloud-storage", "~&gt; 1.11", require: false
'>Copy</button>
</div>
<h4 id="serviço-espelho"><a class="anchorlink" href="#servi%C3%A7o-espelho">2.5 Serviço Espelho</a></h4><p>Você pode manter múltiplos serviços sincronizados definindo um serviço espelho.
Quando um arquivo é carregado ou deletado, isso é feito em todos serviços espelhados.</p><p>Serviços espelhados podem ser usados para facilitar a migração entre serviços em produção.
Você pode começar a espelhar para o novo serviço, copiar os arquivos existentes do antigo
serviço para o novo, e então muda para o novo serviço.</p><div class="note"><p>O espelhamento não é atômico. É possível que um upload seja bem-sucedido no
serviço principal e falha em qualquer um dos serviços subordinados. Antes de ir
totalmente para um novo serviço, verifique se todos os arquivos foram copiados.</p></div><p>Defina cada um dos serviços que você gostaria de usar conforme descrito acima e faça referência para um serviço
espelhado.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">s3_west_coast</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">s3_east_coast</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Mirror</span>
  <span class="na">primary</span><span class="pi">:</span> <span class="s">s3_east_coast</span>
  <span class="na">mirrors</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">s3_west_coast</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='s3_west_coast:
  service: S3
  access_key_id: ""
  secret_access_key: ""
  region: ""
  bucket: ""

s3_east_coast:
  service: S3
  access_key_id: ""
  secret_access_key: ""
  region: ""
  bucket: ""

production:
  service: Mirror
  primary: s3_east_coast
  mirrors:
    - s3_west_coast
'>Copy</button>
</div>
<p>Embora todos os serviços secundários recebam uploads, os downloads são sempre
tratados pelo serviço principal.</p><p>Os serviços de espelho são compatíveis com uploads diretos. Novos arquivos são
diretamente carregados para o serviço principal. Quando um arquivo enviado é
anexado a um registro, um <em>job</em> em segundo plano é enfileirado para copiá-lo para os
serviços secundários.</p><h4 id="acesso-público"><a class="anchorlink" href="#acesso-p%C3%BAblico">2.6 Acesso público</a></h4><p>Por padrão, o <em>Active Storage</em> assume acesso privado aos serviços. Isso significa gerar URLs assinadas e de uso único para os blobs. Se você preferir tornar os blobs acessíveis publicamente, especifique <code>public: true</code> em <code>config/storage.yml</code> na sua aplicação:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">gcs</span><span class="pi">:</span> <span class="nl">&amp;gcs</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="na">project</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">private_gcs</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*gcs</span>
  <span class="na">credentials</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("path/to/private_keyfile.json") %&gt;</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">public_gcs</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*gcs</span>
  <span class="na">credentials</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("path/to/public_keyfile.json") %&gt;</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">public</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gcs: &amp;gcs
  service: GCS
  project: ""

private_gcs:
  &lt;&lt;: *gcs
  credentials: &lt;%= Rails.root.join("path/to/private_keyfile.json") %&gt;
  bucket: ""

public_gcs:
  &lt;&lt;: *gcs
  credentials: &lt;%= Rails.root.join("path/to/public_keyfile.json") %&gt;
  bucket: ""
  public: true
'>Copy</button>
</div>
<p>Tenha certeza que seus <em>buckets</em> estão configurados para acesso público. Veja a documentação sobre como ativar permissão de leitura pública para os serviços <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/block-public-access-bucket.html">Amazon S3</a>, <a href="https://cloud.google.com/storage/docs/access-control/making-data-public#buckets">Google Cloud Storage</a>, e <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-manage-access-to-resources#set-container-public-access-level-in-the-azure-portal">Microsoft Azure</a>. A Amazon S3 requer também que você tenha permissão <code>s3:PutObjectAcl</code>.</p><p>Ao converter uma aplicação existente para usar <code>public: true</code>, certifique-se de atualizar cada arquivo individual no <em>bucket</em> para ser lido publicamente antes de alternar.</p><h3 id="anexar-arquivos-a-registros"><a class="anchorlink" href="#anexar-arquivos-a-registros">3 Anexar Arquivos a Registros</a></h3><h4 id="has-one-attached"><a class="anchorlink" href="#has-one-attached">3.1 <code>has_one_attached</code></a></h4><p>O macro <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/Model.html#method-i-has_one_attached"><code>has_one_attached</code></a> configura um mapeamento um-para-um entre registros e
arquivos. Cada registro pode ter um arquivo anexado a ele.</p><p>Por exemplo, imagine que sua aplicação tenha um <em>model</em> <code>User</code>. Se você quiser que cada usuário
tenha uma avatar, defina o <em>model</em> <code>User</code> da seguinte forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one_attached</span> <span class="ss">:avatar</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  has_one_attached :avatar
end
">Copy</button>
</div>
<p>ou se você estiver usando Rails 6.0+, você pode executar um comando gerador de <em>model</em> como este:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">User</span> <span class="n">avatar</span><span class="ss">:attachment</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model User avatar:attachment
">Copy</button>
</div>
<p>Você pode criar um usuário com um avatar:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:avatar</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form.file_field :avatar %&gt;
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">SignupController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email_address</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:avatar</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class SignupController &lt; ApplicationController
  def create
    user = User.create!(user_params)
    session[:user_id] = user.id
    redirect_to root_path
  end

  private
    def user_params
      params.require(:user).permit(:email_address, :password, :avatar)
    end
end
">Copy</button>
</div>
<p>Chamar <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/One.html#method-i-attach"><code>avatar.attach</code></a> para anexar um avatar a um usuário existente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:avatar</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="user.avatar.attach(params[:avatar])
">Copy</button>
</div>
<p>Chamar <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/One.html#method-i-attached-3F"><code>avatar.attached?</code></a> para determinar se um usuário em particular tem um avatar:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">attached?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="user.avatar.attached?
">Copy</button>
</div>
<p>Em alguns casos, você pode querer substituir um serviço padrão para um anexo específico.
Você pode configurar serviços específicos por anexo usando a opção <code>service</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one_attached</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="ss">service: :s3</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  has_one_attached :avatar, service: :s3
end
">Copy</button>
</div>
<p>Você pode configurar variantes específicas por objeto carregado chamando o método <code>variant</code> no objeto gerado:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one_attached</span> <span class="ss">:avatar</span> <span class="k">do</span> <span class="o">|</span><span class="n">attachable</span><span class="o">|</span>
    <span class="n">attachable</span><span class="p">.</span><span class="nf">variant</span> <span class="ss">:thumb</span><span class="p">,</span> <span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  has_one_attached :avatar do |attachable|
    attachable.variant :thumb, resize_to_limit: [100, 100]
  end
end
">Copy</button>
</div>
<p>Chame <code>avatar.variant(:thumb)</code> para obter uma variante thumb de um avatar:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">:thumb</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag user.avatar.variant(:thumb) %&gt;
">Copy</button>
</div>
<h4 id="has-many-attached"><a class="anchorlink" href="#has-many-attached">3.2 <code>has_many_attached</code></a></h4><p>O macro <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/Model.html#method-i-has_many_attached"><code>has_many_attached</code></a> configura um relacionamento um-para-muitos entre os registros
e arquivos. Cada registro pode ter muitos arquivos anexados a ele.</p><p>Por exemplo, imagine que sua aplicação tem um <em>model</em> <code>Message</code>. Se você quiser que cada
mensagem tenha muitas imagens, defina o <em>model</em> <code>Message</code> da seguinte forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:images</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Message &lt; ApplicationRecord
  has_many_attached :images
end
">Copy</button>
</div>
<p>ou se você estiver usando Rails 6.0+, você pode executar um comando gerador de <em>model</em> como este:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">Message</span> <span class="n">images</span><span class="ss">:attachments</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model Message images:attachments
">Copy</button>
</div>
<p>Você pode criar uma mensagem com images:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MessagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">message</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">message_params</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="n">message</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">message_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:message</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">images: </span><span class="p">[])</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class MessagesController &lt; ApplicationController
  def create
    message = Message.create!(message_params)
    redirect_to message
  end

  private
    def message_params
      params.require(:message).permit(:title, :content, images: [])
    end
end
">Copy</button>
</div>
<p>Chamar <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/Many.html#method-i-attach"><code>images.attach</code></a> para adicionar novas imagens para uma mensagem existente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@message</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:images</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(params[:images])
">Copy</button>
</div>
<p>Chamar <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/Many.html#method-i-attached-3F"><code>images.attached?</code></a> para determinar se uma mensagem em particular alguma imagem:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@message</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">attached?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attached?
">Copy</button>
</div>
<p>Substituir o serviço padrão é feito da mesma maneira que <code>has_one_attached</code>, usando a opção <code>service</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:images</span><span class="p">,</span> <span class="ss">service: :s3</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Message &lt; ApplicationRecord
  has_many_attached :images, service: :s3
end
">Copy</button>
</div>
<p>A configuração de variantes específicas é feita da mesma forma que <code>has_one_attached</code>, chamando o método <code>variant</code> no objeto gerado:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:images</span> <span class="k">do</span> <span class="o">|</span><span class="n">attachable</span><span class="o">|</span>
    <span class="n">attachable</span><span class="p">.</span><span class="nf">variant</span> <span class="ss">:thumb</span><span class="p">,</span> <span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Message &lt; ApplicationRecord
  has_many_attached :images do |attachable|
    attachable.variant :thumb, resize_to_limit: [100, 100]
  end
end
">Copy</button>
</div>
<h4 id="anexando-objetos-file-io"><a class="anchorlink" href="#anexando-objetos-file-io">3.3 Anexando Objetos <em>File/IO</em></a></h4><p>Às vezes você precisa anexar um arquivo que não chega por meio de uma requisição HTTP.
Por exemplo, você pode querer anexar um arquivo que você gerou no disco ou baixou
de uma URL enviada pelo usuário. Você também pode querer anexar um arquivo de fixação em um
<em>model</em> de test. Para fazer isso, forneça uma <em>Hash</em> contendo pelo menos um objeto <em>open IO</em>
e um <em>filename</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@message</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">io: </span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'/path/to/file'</span><span class="p">),</span> <span class="ss">filename: </span><span class="s1">'file.pdf'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(io: File.open('/path/to/file'), filename: 'file.pdf')
">Copy</button>
</div>
<p>Quando possível, forneça um tipo de conteúdo também. O <em>Active Storage</em> tenta
determinar o tipo de conteúdo de um arquivo a partir de seus dados. Depende do tipo
de conteúdo que você fornece se não for possível.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@message</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">io: </span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'/path/to/file'</span><span class="p">),</span> <span class="ss">filename: </span><span class="s1">'file.pdf'</span><span class="p">,</span> <span class="ss">content_type: </span><span class="s1">'application/pdf'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(io: File.open('/path/to/file'), filename: 'file.pdf', content_type: 'application/pdf')
">Copy</button>
</div>
<p>Você pode ignorar a inferência do tipo de conteúdo a partir dos dados passando
<code>identify: false</code> junto com o <code>content_type</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@message</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span>
  <span class="ss">io: </span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'/path/to/file'</span><span class="p">),</span>
  <span class="ss">filename: </span><span class="s1">'file.pdf'</span><span class="p">,</span>
  <span class="ss">content_type: </span><span class="s1">'application/pdf'</span><span class="p">,</span>
  <span class="ss">identify: </span><span class="kp">false</span>
<span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(
  io: File.open('/path/to/file'),
  filename: 'file.pdf',
  content_type: 'application/pdf',
  identify: false
)
">Copy</button>
</div>
<p>Se você não fornecer um tipo de conteúdo e o <em>Active Storage</em> não puder determinar o
tipo de conteúdo do arquivo automaticamente, o padrão é <em>application/octet-stream</em>.</p><h3 id="removendo-arquivos"><a class="anchorlink" href="#removendo-arquivos">4 Removendo arquivos</a></h3><p>Para remover um arquivo anexado de um <em>model</em>, use o método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/One.html#method-i-purge"><code>purge</code></a> no anexo.
Se a aplicação está configurada para usar <em>Active Job</em>, a remoção pode ser feita de maneira assíncrona
chamando <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attached/One.html#method-i-purge_later"><code>purge_later</code></a>. <code>Purge</code> remove o <em>blob</em> (O arquivo em sua versão binaria salvo no banco de
dados) e o arquivo do seu serviço de armazenamento.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Maneira usada para remover um avatar e seus arquivos de maneira síncrona.</span>
<span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">purge</span>

<span class="c1"># Maneira usada para remover um avatar e seus arquivos de maneira assíncrona.</span>
<span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">purge_later</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Maneira usada para remover um avatar e seus arquivos de maneira síncrona.
user.avatar.purge

# Maneira usada para remover um avatar e seus arquivos de maneira assíncrona.
user.avatar.purge_later
">Copy</button>
</div>
<h3 id="serving-files"><a class="anchorlink" href="#serving-files">5 Serving Files</a></h3><p>Active Storage supports two ways to serve files: redirecting and proxying.</p><div class="warning"><p>All Active Storage controllers are publicly accessible by default. The
generated URLs are hard to guess, but permanent by design. If your files
require a higher level of protection consider implementing
<a href="#authenticated-controllers">Authenticated Controllers</a>.</p></div><h4 id="redirect-mode"><a class="anchorlink" href="#redirect-mode">5.1 Redirect Mode</a></h4><p>To generate a permanent URL for a blob, you can pass the blob to the
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActionView/RoutingUrlFor.html#method-i-url_for"><code>url_for</code></a> view helper. This generates a
URL with the blob's <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob.html#method-i-signed_id"><code>signed_id</code></a>
that is routed to the blob's <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blobs/RedirectController.html"><code>RedirectController</code></a></p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">url_for</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">)</span>
<span class="c1"># =&gt; /rails/active_storage/blobs/:signed_id/my-avatar.png</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="url_for(user.avatar)
# =&gt; /rails/active_storage/blobs/:signed_id/my-avatar.png
">Copy</button>
</div>
<p>The <code>RedirectController</code> redirects to the actual service endpoint. This
indirection decouples the service URL from the actual one, and allows, for
example, mirroring attachments in different services for high-availability. The
redirection has an HTTP expiration of 5 minutes.</p><p>To create a download link, use the <code>rails_blob_{path|url}</code> helper. Using this
helper allows you to set the disposition.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">rails_blob_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">,</span> <span class="ss">disposition: </span><span class="s2">"attachment"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='rails_blob_path(user.avatar, disposition: "attachment")
'>Copy</button>
</div>
<div class="warning"><p>To prevent XSS attacks, Active Storage forces the Content-Disposition header
to "attachment" for some kind of files. To change this behaviour see the
available configuration options in <a href="configuring.html#configuring-active-storage">Configuring Rails Applications</a>.</p></div><p>If you need to create a link from outside of controller/view context (Background
jobs, Cronjobs, etc.), you can access the <code>rails_blob_path</code> like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">url_helpers</span><span class="p">.</span><span class="nf">rails_blob_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">,</span> <span class="ss">only_path: </span><span class="kp">true</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.routes.url_helpers.rails_blob_path(user.avatar, only_path: true)
">Copy</button>
</div>
<h4 id="proxy-mode"><a class="anchorlink" href="#proxy-mode">5.2 Proxy Mode</a></h4><p>Optionally, files can be proxied instead. This means that your application servers will download file data from the storage service in response to requests. This can be useful for serving files from a CDN.</p><p>You can configure Active Storage to use proxying by default:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/active_storage.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">resolve_model_to_route</span> <span class="o">=</span> <span class="ss">:rails_storage_proxy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/active_storage.rb
Rails.application.config.active_storage.resolve_model_to_route = :rails_storage_proxy
">Copy</button>
</div>
<p>Or if you want to explicitly proxy specific attachments there are URL helpers you can use in the form of <code>rails_storage_proxy_path</code> and <code>rails_storage_proxy_url</code>.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">rails_storage_proxy_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag rails_storage_proxy_path(@user.avatar) %&gt;
">Copy</button>
</div>
<h5 id="putting-a-cdn-in-front-of-active-storage"><a class="anchorlink" href="#putting-a-cdn-in-front-of-active-storage">5.2.1 Putting a CDN in Front of Active Storage</a></h5><p>Additionally, in order to use a CDN for Active Storage attachments, you will need to generate URLs with proxy mode so that they are served by your app and the CDN will cache the attachment without any extra configuration. This works out of the box because the default Active Storage proxy controller sets an HTTP header indicating to the CDN to cache the response.</p><p>You should also make sure that the generated URLs use the CDN host instead of your app host. There are multiple ways to achieve this, but in general it involves tweaking your <code>config/routes.rb</code> file so that you can generate the proper URLs for the attachments and their variations. As an example, you could add this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/routes.rb</span>
<span class="n">direct</span> <span class="ss">:cdn_image</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">model</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:signed_id</span><span class="p">)</span>
    <span class="n">route_for</span><span class="p">(</span>
      <span class="ss">:rails_service_blob_proxy</span><span class="p">,</span>
      <span class="n">model</span><span class="p">.</span><span class="nf">signed_id</span><span class="p">,</span>
      <span class="n">model</span><span class="p">.</span><span class="nf">filename</span><span class="p">,</span>
      <span class="n">options</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">host: </span><span class="no">ENV</span><span class="p">[</span><span class="s1">'CDN_HOST'</span><span class="p">])</span>
    <span class="p">)</span>
  <span class="k">else</span>
    <span class="n">signed_blob_id</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">blob</span><span class="p">.</span><span class="nf">signed_id</span>
    <span class="n">variation_key</span>  <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">variation</span><span class="p">.</span><span class="nf">key</span>
    <span class="n">filename</span>       <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">blob</span><span class="p">.</span><span class="nf">filename</span>

    <span class="n">route_for</span><span class="p">(</span>
      <span class="ss">:rails_blob_representation_proxy</span><span class="p">,</span>
      <span class="n">signed_blob_id</span><span class="p">,</span>
      <span class="n">variation_key</span><span class="p">,</span>
      <span class="n">filename</span><span class="p">,</span>
      <span class="n">options</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">host: </span><span class="no">ENV</span><span class="p">[</span><span class="s1">'CDN_HOST'</span><span class="p">])</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/routes.rb
direct :cdn_image do |model, options|
  if model.respond_to?(:signed_id)
    route_for(
      :rails_service_blob_proxy,
      model.signed_id,
      model.filename,
      options.merge(host: ENV['CDN_HOST'])
    )
  else
    signed_blob_id = model.blob.signed_id
    variation_key  = model.variation.key
    filename       = model.blob.filename

    route_for(
      :rails_blob_representation_proxy,
      signed_blob_id,
      variation_key,
      filename,
      options.merge(host: ENV['CDN_HOST'])
    )
  end
end
">Copy</button>
</div>
<p>and then generate routes like this:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">cdn_image_url</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]))</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= cdn_image_url(user.avatar.variant(resize_to_limit: [128, 128])) %&gt;
">Copy</button>
</div>
<h4 id="authenticated-controllers"><a class="anchorlink" href="#authenticated-controllers">5.3 Authenticated Controllers</a></h4><p>All Active Storage controllers are publicly accessible by default. The generated
URLs use a plain <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob.html#method-i-signed_id"><code>signed_id</code></a>, making them hard to
guess but permanent. Anyone that knows the blob URL will be able to access it,
even if a <code>before_action</code> in your <code>ApplicationController</code> would otherwise
require a login. If your files require a higher level of protection, you can
implement your own authenticated controllers, based on the
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blobs/RedirectController.html"><code>ActiveStorage::Blobs::RedirectController</code></a>,
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blobs/ProxyController.html"><code>ActiveStorage::Blobs::ProxyController</code></a>,
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Representations/RedirectController.html"><code>ActiveStorage::Representations::RedirectController</code></a> and
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Representations/ProxyController.html"><code>ActiveStorage::Representations::ProxyController</code></a></p><p>To only allow an account to access their own logo you could do the following:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/routes.rb</span>
<span class="n">resource</span> <span class="ss">:account</span> <span class="k">do</span>
  <span class="n">resource</span> <span class="ss">:logo</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/routes.rb
resource :account do
  resource :logo
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/logos_controller.rb</span>
<span class="k">class</span> <span class="nc">LogosController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># Through ApplicationController:</span>
  <span class="c1"># include Authenticate, SetCurrentAccount</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">redirect_to</span> <span class="no">Current</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">logo</span><span class="p">.</span><span class="nf">url</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/controllers/logos_controller.rb
class LogosController &lt; ApplicationController
  # Through ApplicationController:
  # include Authenticate, SetCurrentAccount

  def show
    redirect_to Current.account.logo.url
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">account_logo_path</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag account_logo_path %&gt;
">Copy</button>
</div>
<p>And then you might want to disable the Active Storage default routes with:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">draw_routes</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_storage.draw_routes = false
">Copy</button>
</div>
<p>to prevent files being accessed with the publicly accessible URLs.</p><h3 id="baixando-arquivos"><a class="anchorlink" href="#baixando-arquivos">6 Baixando arquivos</a></h3><p>Algumas vezes você vai precisar processar um <em>blob</em> depois dele ter sido
<em>uploaded</em> (Transferir um arquivo da maquina do cliente para o servidor da sua
aplicação) para, por exemplo, converte-lo para um formato diferente. Use o
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob.html#method-i-download"><code>download</code></a> para ler o conteúdo binário do <em>blob</em> na
memória:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">binary</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">download</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="binary = user.avatar.download
">Copy</button>
</div>
<p>Caso deseje baixar o <em>blob</em> para um arquivo no disco para um programa externo
(Um antivírus, por exemplo) possa operar nele. Use o método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob.html#method-i-open"><code>open</code></a>
para baixar o <em>blob</em> para um arquivo temporário no disco:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">message</span><span class="p">.</span><span class="nf">video</span><span class="p">.</span><span class="nf">open</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
  <span class="nb">system</span> <span class="s1">'/caminho/para/o/antivirus'</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="nf">path</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="message.video.open do |file|
  system '/caminho/para/o/antivirus', file.path
  # ...
end
">Copy</button>
</div>
<p>É importante saber que o arquivo ainda não está disponível no <em>callback</em> <code>after_create</code>, mas apenas no <code>after_create_commit</code>.</p><h3 id="analyzing-files"><a class="anchorlink" href="#analyzing-files">7 Analyzing Files</a></h3><p>Active Storage analyzes files once they've been uploaded by queuing a job in Active Job. Analyzed files will store additional information in the metadata hash, including <code>analyzed: true</code>. You can check whether a blob has been analyzed by calling <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob/Analyzable.html#method-i-analyzed-3F"><code>analyzed?</code></a> on it.</p><p>Image analysis provides <code>width</code> and <code>height</code> attributes. Video analysis provides these, as well as <code>duration</code>, <code>angle</code>, <code>display_aspect_ratio</code>, and <code>video</code> and <code>audio</code> booleans to indicate the presence of those channels. Audio analysis provides <code>duration</code> and <code>bit_rate</code> attributes.</p><h3 id="displaying-images-videos-and-pdfs"><a class="anchorlink" href="#displaying-images-videos-and-pdfs">8 Displaying Images, Videos, and PDFs</a></h3><p>Active Storage supports representing a variety of files. You can call
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob/Representable.html#method-i-representation"><code>representation</code></a> on an attachment to display an image variant, or a
preview of a video or PDF. Before calling <code>representation</code>, check if the
attachment can be represented by calling <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob/Representable.html#method-i-representable-3F"><code>representable?</code></a>. Some file formats
can't be previewed by Active Storage out of the box (e.g. Word documents); if
<code>representable?</code> returns false you may want to <a href="#serving-files">link to</a>
the file instead.</p><div class="code_container">
<pre><code class="highlight erb"><span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@message</span><span class="p">.</span><span class="nf">files</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">file</span><span class="p">.</span><span class="nf">representable?</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">file</span><span class="p">.</span><span class="nf">representation</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">rails_blob_path</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="ss">disposition: </span><span class="s2">"attachment"</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"placeholder.png"</span><span class="p">,</span> <span class="ss">alt: </span><span class="s2">"Download file"</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;ul&gt;
  &lt;% @message.files.each do |file| %&gt;
    &lt;li&gt;
      &lt;% if file.representable? %&gt;
        &lt;%= image_tag file.representation(resize_to_limit: [100, 100]) %&gt;
      &lt;% else %&gt;
        &lt;%= link_to rails_blob_path(file, disposition: "attachment") do %&gt;
          &lt;%= image_tag "placeholder.png", alt: "Download file" %&gt;
        &lt;% end %&gt;
      &lt;% end %&gt;
    &lt;/li&gt;
  &lt;% end %&gt;
&lt;/ul&gt;
'>Copy</button>
</div>
<p>Internally, <code>representation</code> calls <code>variant</code> for images, and <code>preview</code> for
previewable files. You can also call these methods directly.</p><h4 id="lazy-vs-immediate-loading"><a class="anchorlink" href="#lazy-vs-immediate-loading">8.1 Lazy vs Immediate Loading</a></h4><p>By default, Active Storage will process representations lazily. This code:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">image_tag</span> <span class="n">file</span><span class="p">.</span><span class="nf">representation</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="image_tag file.representation(resize_to_limit: [100, 100])
">Copy</button>
</div>
<p>Will generate an <code>&lt;img&gt;</code> tag with the <code>src</code> pointing to the
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Representations/RedirectController.html"><code>ActiveStorage::Representations::RedirectController</code></a>. The browser will
make a request to that controller, which will return a <code>302</code> redirect to the
file on the remote service (or in <a href="#proxy-mode">proxy mode</a>, return the file
contents). Loading the file lazily allows features like
<a href="#public-access">single use URLs</a> to work without slowing down your initial page loads.</p><p>This works fine for most cases.</p><p>If you want to generate URLs for images immediately, you can call <code>.processed.url</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">image_tag</span> <span class="n">file</span><span class="p">.</span><span class="nf">representation</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]).</span><span class="nf">processed</span><span class="p">.</span><span class="nf">url</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="image_tag file.representation(resize_to_limit: [100, 100]).processed.url
">Copy</button>
</div>
<p>The Active Storage variant tracker improves performance of this, by storing a
record in the database if the requested representation has been processed before.
Thus, the above code will only make an API call to the remote service (e.g. S3)
once, and once a variant is stored, will use that. The variant tracker runs
automatically, but can be disabled through <code>config.active_storage.track_variants</code>.</p><p>If you're rendering lots of images on a page, the above example could result
in N+1 queries loading all the variant records. To avoid these N+1 queries,
use the named scopes on <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Attachment.html"><code>ActiveStorage::Attachment</code></a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">message</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">with_all_variant_records</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
  <span class="n">image_tag</span> <span class="n">file</span><span class="p">.</span><span class="nf">representation</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]).</span><span class="nf">processed</span><span class="p">.</span><span class="nf">url</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="message.images.with_all_variant_records.each do |file|
  image_tag file.representation(resize_to_limit: [100, 100]).processed.url
end
">Copy</button>
</div>
<h4 id="transforming-images"><a class="anchorlink" href="#transforming-images">8.2 Transforming Images</a></h4><p>Transforming images allows you to display the image at your choice of dimensions.
To create a variation of an image, call <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob/Representable.html#method-i-variant"><code>variant</code></a> on the attachment. You
can pass any transformation supported by the variant processor to the method.
When the browser hits the variant URL, Active Storage will lazily transform
the original blob into the specified format and redirect to its new service
location.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag user.avatar.variant(resize_to_limit: [100, 100]) %&gt;
">Copy</button>
</div>
<p>If a variant is requested, Active Storage will automatically apply
transformations depending on the image's format:</p>
<ol>
<li><p>Content types that are variable (as dictated by <a href="configuring.html#config-active-storage-variable-content-types"><code>config.active_storage.variable_content_types</code></a>)
and not considered web images (as dictated by [<code>config.active_storage.web_image_content_types</code>][]),
will be converted to PNG.</p></li>
<li><p>If <code>quality</code> is not specified, the variant processor's default quality for the format will be used.</p></li>
</ol>
<p>Active Storage can use either <a href="https://www.rubydoc.info/gems/ruby-vips/Vips/Image">Vips</a> or MiniMagick as the variant processor.
The default depends on your <code>config.load_defaults</code> target version, and the
processor can be changed by setting [<code>config.active_storage.variant_processor</code>][].</p><p>The two processors are not fully compatible, so when migrating an existing application
between MiniMagick and Vips, some changes have to be made if using options that are format
specific:</p><div class="code_container">
<pre><code class="highlight rhtml"><span class="c">&lt;!-- MiniMagick --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="ss">format: :jpeg</span><span class="p">,</span> <span class="ss">sampling_factor: </span><span class="s2">"4:2:0"</span><span class="p">,</span> <span class="ss">strip: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">interlace: </span><span class="s2">"JPEG"</span><span class="p">,</span> <span class="ss">colorspace: </span><span class="s2">"sRGB"</span><span class="p">,</span> <span class="ss">quality: </span><span class="mi">80</span><span class="p">)</span> <span class="cp">%&gt;</span>

<span class="c">&lt;!-- Vips --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="ss">format: :jpeg</span><span class="p">,</span> <span class="ss">saver: </span><span class="p">{</span> <span class="ss">subsample_mode: </span><span class="s2">"on"</span><span class="p">,</span> <span class="ss">strip: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">interlace: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">quality: </span><span class="mi">80</span> <span class="p">})</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;!-- MiniMagick --&gt;
&lt;%= image_tag user.avatar.variant(resize_to_limit: [100, 100], format: :jpeg, sampling_factor: "4:2:0", strip: true, interlace: "JPEG", colorspace: "sRGB", quality: 80) %&gt;

&lt;!-- Vips --&gt;
&lt;%= image_tag user.avatar.variant(resize_to_limit: [100, 100], format: :jpeg, saver: { subsample_mode: "on", strip: true, interlace: true, quality: 80 }) %&gt;
'>Copy</button>
</div>
<h4 id="pré-visualização-de-arquivos"><a class="anchorlink" href="#pr%C3%A9-visualiza%C3%A7%C3%A3o-de-arquivos">8.3 Pré-visualização de arquivos</a></h4><p>Alguns arquivos que não são imagens podem ser pré-visualizados: isto é, eles podem
ser apresentados como imagens. Por exemplo, um arquivo de vídeo pode ser pré-visualizado
através da extração de seu primeiro <em>frame</em>. O <em>Active Storage</em> por padrão já oferece
suporte para a pré-visualização de vídeos e documentos PDF. Para criar um link e
gerar um preview use o método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Blob/Representable.html#method-i-preview"><code>preview</code></a>:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">message</span><span class="p">.</span><span class="nf">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag message.video.preview(resize_to_limit: [100, 100]) %&gt;
">Copy</button>
</div>
<p>Para adicionar suporte para outros formatos, adicione seu próprio visualizador. Veja a documentação de
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Preview.html"><code>ActiveStorage::Preview</code></a> para mais informações.</p><h3 id="uploads-diretos"><a class="anchorlink" href="#uploads-diretos">9 <em>Uploads</em> Diretos</a></h3><p>O <em>Active Storage</em> com a sua biblioteca JavaScript incluída suporta <em>uploads</em> direto do cliente (<em>front-end</em>) para a nuvem.</p><h4 id="uso"><a class="anchorlink" href="#uso">9.1 Uso</a></h4>
<ol>
<li>
<p>Inclua o <code>activestorage.js</code> na sua aplicação.</p>
<p>Usando o <em>asset pipeline</em>:</p>
<div class="code_container">
<pre><code class="highlight js"><span class="c1">//= require activestorage</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="//= require activestorage
">Copy</button>
</div>
<p>Usando o pacote npm:</p>
<div class="code_container">
<pre><code class="highlight js"><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">ActiveStorage</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/activestorage</span><span class="dl">"</span>
<span class="nx">ActiveStorage</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='import * as ActiveStorage from "@rails/activestorage"
ActiveStorage.start()
'>Copy</button>
</div>
</li>
<li>
<p>Adicione <code>direct_upload: true</code> no seu <a href="form_helpers.html#enviando-arquivos"><code>file_field</code></a>.</p>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:attachments</span><span class="p">,</span> <span class="ss">multiple: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">direct_upload: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form.file_field :attachments, multiple: true, direct_upload: true %&gt;
">Copy</button>
</div>
<p>Se você não está usando um <a href="form_helpers.html#customizando-os-construtores-de-formularios">FormBuilder</a> adicione o <code>direct_upload: true</code> diretamente:</p>
<div class="code_container">
<pre><code class="highlight erb"><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">data-direct-upload-url=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">rails_direct_uploads_url</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="nt">/&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;input type="file" data-direct-upload-url="&lt;%= rails_direct_uploads_url %&gt;" /&gt;
'>Copy</button>
</div>
</li>
<li><p>Configure o serviço de armazenamento de terceiros do CORS para permitir requisições de <em>upload</em> direto.</p></li>
<li><p>E é isso! Os <em>uploads</em> começam após o envio do formulário.</p></li>
</ol>
<h4 id="configuração-do-cross-origin-resource-sharing-cors"><a class="anchorlink" href="#configura%C3%A7%C3%A3o-do-cross-origin-resource-sharing-cors">9.2 Configuração do <em>Cross-Origin Resource Sharing</em> (CORS)</a></h4><p>Para que o <em>upload</em> direto a partir de terceiros funcione você vai precisar configurar o seu serviço de nuvem para aceitar requisições de múltiplas origens. Consulte a documentação sobre CORS do seu serviço:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html#how-do-i-enable-cors">S3</a></li>
<li><a href="https://cloud.google.com/storage/docs/configuring-cors">Google Cloud Storage</a></li>
<li><a href="https://docs.microsoft.com/en-us/rest/api/storageservices/cross-origin-resource-sharing--cors--support-for-the-azure-storage-services">Azure Storage</a></li>
</ul>
<p>Tome cuidado em permitir:</p>
<ul>
<li>Todas as origens pela qual a sua aplicação é acessada.</li>
<li>O método de requisição <code>PUT</code>
</li>
<li>Os seguintes cabeçalhos de requisição:

<ul>
<li><code>Origin</code></li>
<li><code>Content-Type</code></li>
<li><code>Content-MD5</code></li>
<li>
<code>Content-Disposition</code> (exceto para o Azure Storage)</li>
<li>
<code>x-ms-blob-content-disposition</code> (somente para o Azure Storage)</li>
<li>
<code>x-ms-blob-type</code> (somente para o Azure Storage)</li>
<li>
<code>Cache-Control</code> (para GCS, somente se <code>cache_control</code> estiver definido)</li>
</ul>
</li>
</ul>
<p>Se você for utilizar seu disco como armazenamento e ele compartilhar a mesma origem da sua aplicação não é necessário configurar o CORS.</p><h5 id="exemplo-configuração-do-cors-para-o-s3"><a class="anchorlink" href="#exemplo-configura%C3%A7%C3%A3o-do-cors-para-o-s3">9.2.1 Exemplo: Configuração do CORS para o S3</a></h5><div class="code_container">
<pre><code class="highlight json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"AllowedHeaders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"*"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"AllowedMethods"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"PUT"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"AllowedOrigins"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"https://www.example.com"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"ExposeHeaders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"Origin"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Content-MD5"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Content-Disposition"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"MaxAgeSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='[
  {
    "AllowedHeaders": [
      "*"
    ],
    "AllowedMethods": [
      "PUT"
    ],
    "AllowedOrigins": [
      "https://www.example.com"
    ],
    "ExposeHeaders": [
      "Origin",
      "Content-Type",
      "Content-MD5",
      "Content-Disposition"
    ],
    "MaxAgeSeconds": 3600
  }
]
'>Copy</button>
</div>
<h5 id="exemplo-configuração-do-cors-para-o-google-cloud-storage"><a class="anchorlink" href="#exemplo-configura%C3%A7%C3%A3o-do-cors-para-o-google-cloud-storage">9.2.2 Exemplo: Configuração do CORS para o Google Cloud Storage</a></h5><div class="code_container">
<pre><code class="highlight json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"origin"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"https://www.example.com"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"PUT"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"responseHeader"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Origin"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Content-MD5"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Content-Disposition"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"maxAgeSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='[
  {
    "origin": ["https://www.example.com"],
    "method": ["PUT"],
    "responseHeader": ["Origin", "Content-Type", "Content-MD5", "Content-Disposition"],
    "maxAgeSeconds": 3600
  }
]
'>Copy</button>
</div>
<h5 id="exemplo-configuração-do-cors-para-o-azure-storage"><a class="anchorlink" href="#exemplo-configura%C3%A7%C3%A3o-do-cors-para-o-azure-storage">9.2.3 Exemplo: Configuração do CORS para o Azure Storage</a></h5><div class="code_container">
<pre><code class="highlight xml"><span class="nt">&lt;Cors&gt;</span>
  <span class="nt">&lt;CorsRule&gt;</span>
    <span class="nt">&lt;AllowedOrigins&gt;</span>https://www.example.com<span class="nt">&lt;/AllowedOrigins&gt;</span>
    <span class="nt">&lt;AllowedMethods&gt;</span>PUT<span class="nt">&lt;/AllowedMethods&gt;</span>
    <span class="nt">&lt;AllowedHeaders&gt;</span>Origin, Content-Type, Content-MD5, x-ms-blob-content-disposition, x-ms-blob-type<span class="nt">&lt;/AllowedHeaders&gt;</span>
    <span class="nt">&lt;MaxAgeInSeconds&gt;</span>3600<span class="nt">&lt;/MaxAgeInSeconds&gt;</span>
  <span class="nt">&lt;/CorsRule&gt;</span>
<span class="nt">&lt;/Cors&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;Cors&gt;
  &lt;CorsRule&gt;
    &lt;AllowedOrigins&gt;https://www.example.com&lt;/AllowedOrigins&gt;
    &lt;AllowedMethods&gt;PUT&lt;/AllowedMethods&gt;
    &lt;AllowedHeaders&gt;Origin, Content-Type, Content-MD5, x-ms-blob-content-disposition, x-ms-blob-type&lt;/AllowedHeaders&gt;
    &lt;MaxAgeInSeconds&gt;3600&lt;/MaxAgeInSeconds&gt;
  &lt;/CorsRule&gt;
&lt;/Cors&gt;
">Copy</button>
</div>
<h4 id="eventos-de-upload-direto-do-javascript"><a class="anchorlink" href="#eventos-de-upload-direto-do-javascript">9.3 Eventos de <em>Upload</em> Direto do JavaScript</a></h4>
<table>
<thead>
<tr>
<th>Nome do evento</th>
<th>Alvo do evento</th>
<th>Dados do evento (<code>event.detail</code>)</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>direct-uploads:start</code></td>
<td><code>&lt;form&gt;</code></td>
<td>Nenhum</td>
<td>Um formulário contendo campos para <em>upload</em> direto foi submetido.</td>
</tr>
<tr>
<td><code>direct-upload:initialize</code></td>
<td><code>&lt;input&gt;</code></td>
<td><code>{id, file}</code></td>
<td>Disparado para cada arquivo após a submissão do formulário.</td>
</tr>
<tr>
<td><code>direct-upload:start</code></td>
<td><code>&lt;input&gt;</code></td>
<td><code>{id, file}</code></td>
<td>O <em>upload</em> direto está iniciando.</td>
</tr>
<tr>
<td><code>direct-upload:before-blob-request</code></td>
<td><code>&lt;input&gt;</code></td>
<td><code>{id, file, xhr}</code></td>
<td>Antes de fazer uma requisição de <em>upload</em> direto de metadados para a sua aplicação.</td>
</tr>
<tr>
<td><code>direct-upload:before-storage-request</code></td>
<td><code>&lt;input&gt;</code></td>
<td><code>{id, file, xhr}</code></td>
<td>Antes de fazer uma requisição para armazenar um arquivo.</td>
</tr>
<tr>
<td><code>direct-upload:progress</code></td>
<td><code>&lt;input&gt;</code></td>
<td><code>{id, file, progress}</code></td>
<td>O progresso da requisição para armazenar um arquivo.</td>
</tr>
<tr>
<td><code>direct-upload:error</code></td>
<td><code>&lt;input&gt;</code></td>
<td><code>{id, file, error}</code></td>
<td>Um erro ocorreu. Um <code>alert</code> deve ser exibido, a menos que esse evento seja cancelado.</td>
</tr>
<tr>
<td><code>direct-upload:end</code></td>
<td><code>&lt;input&gt;</code></td>
<td><code>{id, file}</code></td>
<td>Um <em>upload</em> direto foi finalizado.</td>
</tr>
<tr>
<td><code>direct-uploads:end</code></td>
<td><code>&lt;form&gt;</code></td>
<td>Nenhum</td>
<td>Todos os <em>uploads</em> diretos foram finalizados.</td>
</tr>
</tbody>
</table>
<h4 id="exemplo"><a class="anchorlink" href="#exemplo">9.4 Exemplo</a></h4><p>Você pode usar esses eventos para exibir o progresso de um <em>upload</em>.</p><p><img src="https://user-images.githubusercontent.com/5355/28694528-16e69d0c-72f8-11e7-91a7-c0b8cfc90391.gif" alt="direct-uploads"></p><p>Para mostrar os arquivos enviados em um formulário:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// direct_uploads.js</span>

<span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:initialize</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">detail</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">file</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">detail</span>
  <span class="nx">target</span><span class="p">.</span><span class="nf">insertAdjacentHTML</span><span class="p">(</span><span class="dl">"</span><span class="s2">beforebegin</span><span class="dl">"</span><span class="p">,</span> <span class="s2">`
    &lt;div id="direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">" class="direct-upload direct-upload--pending"&gt;
      &lt;div id="direct-upload-progress-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">" class="direct-upload__progress" style="width: 0%"&gt;&lt;/div&gt;
      &lt;span class="direct-upload__filename"&gt;&lt;/span&gt;
    &lt;/div&gt;
  `</span><span class="p">)</span>
  <span class="nx">target</span><span class="p">.</span><span class="nx">previousElementSibling</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="s2">`.direct-upload__filename`</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span>
<span class="p">})</span>

<span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:start</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s2">`direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload--pending</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>

<span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:progress</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">progress</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">progressElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s2">`direct-upload-progress-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">progressElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">progress</span><span class="p">}</span><span class="s2">%`</span>
<span class="p">})</span>

<span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:error</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">error</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s2">`direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload--error</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span>
<span class="p">})</span>

<span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:end</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s2">`direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload--complete</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='// direct_uploads.js

addEventListener("direct-upload:initialize", event =&gt; {
  const { target, detail } = event
  const { id, file } = detail
  target.insertAdjacentHTML("beforebegin", `
    &lt;div id="direct-upload-${id}" class="direct-upload direct-upload--pending"&gt;
      &lt;div id="direct-upload-progress-${id}" class="direct-upload__progress" style="width: 0%"&gt;&lt;/div&gt;
      &lt;span class="direct-upload__filename"&gt;&lt;/span&gt;
    &lt;/div&gt;
  `)
  target.previousElementSibling.querySelector(`.direct-upload__filename`).textContent = file.name
})

addEventListener("direct-upload:start", event =&gt; {
  const { id } = event.detail
  const element = document.getElementById(`direct-upload-${id}`)
  element.classList.remove("direct-upload--pending")
})

addEventListener("direct-upload:progress", event =&gt; {
  const { id, progress } = event.detail
  const progressElement = document.getElementById(`direct-upload-progress-${id}`)
  progressElement.style.width = `${progress}%`
})

addEventListener("direct-upload:error", event =&gt; {
  event.preventDefault()
  const { id, error } = event.detail
  const element = document.getElementById(`direct-upload-${id}`)
  element.classList.add("direct-upload--error")
  element.setAttribute("title", error)
})

addEventListener("direct-upload:end", event =&gt; {
  const { id } = event.detail
  const element = document.getElementById(`direct-upload-${id}`)
  element.classList.add("direct-upload--complete")
})
'>Copy</button>
</div>
<p>Adicionar estilos:</p><div class="code_container">
<pre><code class="highlight css"><span class="c">/* direct_uploads.css */</span>

<span class="nc">.direct-upload</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">2px</span> <span class="m">4px</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="m">3px</span> <span class="m">3px</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.3</span><span class="p">);</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">11px</span><span class="p">;</span>
  <span class="nl">line-height</span><span class="p">:</span> <span class="m">13px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.direct-upload--pending</span> <span class="p">{</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.6</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.direct-upload__progress</span> <span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">left</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">bottom</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.2</span><span class="p">;</span>
  <span class="nl">background</span><span class="p">:</span> <span class="m">#0076ff</span><span class="p">;</span>
  <span class="nl">transition</span><span class="p">:</span> <span class="n">width</span> <span class="m">120ms</span> <span class="n">ease-out</span><span class="p">,</span> <span class="n">opacity</span> <span class="m">60ms</span> <span class="m">60ms</span> <span class="n">ease-in</span><span class="p">;</span>
  <span class="nl">transform</span><span class="p">:</span> <span class="n">translate3d</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="nc">.direct-upload--complete</span> <span class="nc">.direct-upload__progress</span> <span class="p">{</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.4</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.direct-upload--error</span> <span class="p">{</span>
  <span class="nl">border-color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">file</span><span class="o">][</span><span class="nt">data-direct-upload-url</span><span class="o">][</span><span class="nt">disabled</span><span class="o">]</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="/* direct_uploads.css */

.direct-upload {
  display: inline-block;
  position: relative;
  padding: 2px 4px;
  margin: 0 3px 3px 0;
  border: 1px solid rgba(0, 0, 0, 0.3);
  border-radius: 3px;
  font-size: 11px;
  line-height: 13px;
}

.direct-upload--pending {
  opacity: 0.6;
}

.direct-upload__progress {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  opacity: 0.2;
  background: #0076ff;
  transition: width 120ms ease-out, opacity 60ms 60ms ease-in;
  transform: translate3d(0, 0, 0);
}

.direct-upload--complete .direct-upload__progress {
  opacity: 0.4;
}

.direct-upload--error {
  border-color: red;
}

input[type=file][data-direct-upload-url][disabled] {
  display: none;
}
">Copy</button>
</div>
<h4 id="integrando-com-bibliotecas-ou-frameworks"><a class="anchorlink" href="#integrando-com-bibliotecas-ou-frameworks">9.5 Integrando com Bibliotecas ou <em>Frameworks</em></a></h4><p>Se você quer utilizar a funcionalidade de <em>upload</em> direto a partir de um <em>framework</em> JavaScript, ou se você quiser integrar uma funcionalidade de <em>drag and drop</em> (arrastar e soltar), você poderá utilizar a classe <code>DirectUpload</code> para fazer a integração. Ao receber um arquivo da sua biblioteca de escolha, instancie um <code>DirectUpload</code> e chame o seu método de criação. O método de criação recebe uma <em>callback</em> para ser executada quando o <em>upload</em> é concluído.</p><div class="code_container">
<pre><code class="highlight js"><span class="k">import</span> <span class="p">{</span> <span class="nx">DirectUpload</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/activestorage</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">input[type=file]</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// Vincular ao arquivo solto - use o onDrop em um elemento pai ou use uma</span>
<span class="c1">//  biblioteca com o Dropzone</span>
<span class="kd">const</span> <span class="nx">onDrop</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
  <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">files</span><span class="p">).</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="nf">uploadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Vincular à seleção de arquivo normal</span>
<span class="nx">input</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">files</span><span class="p">).</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="nf">uploadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span>
  <span class="c1">// você pode limpar os arquivos selecionados da entrada</span>
  <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">uploadFile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// seu formulário precisa do file_field direct_upload: true, que</span>
  <span class="c1">//  fornece o data-direct-upload-url</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">directUploadUrl</span>
  <span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DirectUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>

  <span class="nx">upload</span><span class="p">.</span><span class="nf">create</span><span class="p">((</span><span class="nx">error</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Trata o erro</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Adiciona uma entrada oculta apropriadamente nomeada ao formulário com o</span>
      <span class="c1">//  valor blob.signed_id, assim os blob ids podem ser</span>
      <span class="c1">//  transmitidos no fluxo normal de upload</span>
      <span class="kd">const</span> <span class="nx">hiddenField</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">hiddenField</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">hiddenField</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">value</span><span class="dl">"</span><span class="p">,</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">signed_id</span><span class="p">);</span>
      <span class="nx">hiddenField</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">name</span>
      <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">form</span><span class="dl">'</span><span class="p">).</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">hiddenField</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="import { DirectUpload } from &quot;@rails/activestorage&quot;

const input = document.querySelector('input[type=file]')

// Vincular ao arquivo solto - use o onDrop em um elemento pai ou use uma
//  biblioteca com o Dropzone
const onDrop = (event) =&gt; {
  event.preventDefault()
  const files = event.dataTransfer.files;
  Array.from(files).forEach(file =&gt; uploadFile(file))
}

// Vincular à seleção de arquivo normal
input.addEventListener('change', (event) =&gt; {
  Array.from(input.files).forEach(file =&gt; uploadFile(file))
  // você pode limpar os arquivos selecionados da entrada
  input.value = null
})

const uploadFile = (file) =&gt; {
  // seu formulário precisa do file_field direct_upload: true, que
  //  fornece o data-direct-upload-url
  const url = input.dataset.directUploadUrl
  const upload = new DirectUpload(file, url)

  upload.create((error, blob) =&gt; {
    if (error) {
      // Trata o erro
    } else {
      // Adiciona uma entrada oculta apropriadamente nomeada ao formulário com o
      //  valor blob.signed_id, assim os blob ids podem ser
      //  transmitidos no fluxo normal de upload
      const hiddenField = document.createElement('input')
      hiddenField.setAttribute(&quot;type&quot;, &quot;hidden&quot;);
      hiddenField.setAttribute(&quot;value&quot;, blob.signed_id);
      hiddenField.name = input.name
      document.querySelector('form').appendChild(hiddenField)
    }
  })
}
">Copy</button>
</div>
<p>Se você precisa acompanhar o progresso de <em>upload</em> do arquivo, você pode passar um terceiro
parâmetro para o construtor do <code>DirectUpload</code>. Durante o <em>upload</em>, o DirectUpload
irá chamar o método <code>directUploadWillStoreFileWithXHR</code> do objeto. Você poderá então
vincular o seu manipulador de progresso no XHR.</p><div class="code_container">
<pre><code class="highlight js"><span class="k">import</span> <span class="p">{</span> <span class="nx">DirectUpload</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/activestorage</span><span class="dl">"</span>

<span class="kd">class</span> <span class="nc">Uploader</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DirectUpload</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">upload</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nf">create</span><span class="p">((</span><span class="nx">error</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Trata o erro</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Adiciona uma entrada oculta apropriadamente nomeada no formulário</span>
        <span class="c1">// com o valor blob.signed_id</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nf">directUploadWillStoreFileWithXHR</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">progress</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">event</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nf">directUploadDidProgress</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="nf">directUploadDidProgress</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Usa o event.loaded e o event.total para atualizar a barra de progresso</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='import { DirectUpload } from "@rails/activestorage"

class Uploader {
  constructor(file, url) {
    this.upload = new DirectUpload(this.file, this.url, this)
  }

  upload(file) {
    this.upload.create((error, blob) =&gt; {
      if (error) {
        // Trata o erro
      } else {
        // Adiciona uma entrada oculta apropriadamente nomeada no formulário
        // com o valor blob.signed_id
      }
    })
  }

  directUploadWillStoreFileWithXHR(request) {
    request.upload.addEventListener("progress",
      event =&gt; this.directUploadDidProgress(event))
  }

  directUploadDidProgress(event) {
    // Usa o event.loaded e o event.total para atualizar a barra de progresso
  }
}
'>Copy</button>
</div>
<p>NOTA: O uso de <a href="#direct-uploads">Uploads Diretos</a> às vezes pode resultar em um arquivo que é carregado, mas nunca anexado a um registro. Considere <a href="#purging-unattached-uploads">limpar uploads não anexados</a>.</p><h3 id="testando"><a class="anchorlink" href="#testando">10 Testando</a></h3><p>Use <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/TestProcess/FixtureFile.html"><code>fixture_file_upload</code></a> para testar o <em>upload</em> de um arquivo em um teste de integração ou <em>controller</em>.
O Rails lida com arquivos como qualquer outro parâmetro.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">SignupController</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"can sign up"</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span>
      <span class="ss">name: </span><span class="s2">"David"</span><span class="p">,</span>
      <span class="ss">avatar: </span><span class="n">fixture_file_upload</span><span class="p">(</span><span class="s2">"david.png"</span><span class="p">,</span> <span class="s2">"image/png"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">).</span><span class="nf">last</span>
    <span class="n">assert</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">attached?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class SignupController &lt; ActionDispatch::IntegrationTest
  test "can sign up" do
    post signup_path, params: {
      name: "David",
      avatar: fixture_file_upload("david.png", "image/png")
    }

    user = User.order(:created_at).last
    assert user.avatar.attached?
  end
end
'>Copy</button>
</div>
<h4 id="descartando-arquivos-criados-durante-os-testes"><a class="anchorlink" href="#descartando-arquivos-criados-durante-os-testes">10.1 Descartando Arquivos Criados Durante os Testes</a></h4><h5 id="system-tests"><a class="anchorlink" href="#system-tests">10.1.1 System Tests</a></h5><p>Os testes de sistema limpam os dados de testes revertendo uma transação. Como o
<code>destroy</code> nunca é chamado em um objeto, os arquivos anexados nunca são limpos. Se
quiser limpar os arquivos, podemos usar um <em>callback</em> <code>after_teardown</code>.
Fazendo isso garantimos que todas as conexões criadas durante o teste sejam
concluídas sem que recebamos um erro do <em>Active Storage</em> informando que não
foi possível encontrar um arquivo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">after_teardown</span>
    <span class="k">super</span>
    <span class="no">FileUtils</span><span class="p">.</span><span class="nf">rm_rf</span><span class="p">(</span><span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">service</span><span class="p">.</span><span class="nf">root</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase
  # ...
  def after_teardown
    super
    FileUtils.rm_rf(ActiveStorage::Blob.service.root)
  end
  # ...
end
">Copy</button>
</div>
<p>Se você estiver usando [testes paralelos][] e o <code>DiskService</code>, você deve configurar cada processo para usar sua própria
pasta para o <em>Active Storage</em>. Dessa forma, o retorno de chamada <code>teardown</code> só excluirá arquivos do processo do teste relevante.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="c1"># ...</span>
  <span class="n">parallelize_setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">service</span><span class="p">.</span><span class="nf">root</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">service</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase
  # ...
  parallelize_setup do |i|
    ActiveStorage::Blob.service.root = "#{ActiveStorage::Blob.service.root}-#{i}"
  end
  # ...
end
'>Copy</button>
</div>
<p>Se os testes de sistema verificarem a exclusão de um <em>model</em> com anexos e
estivermos usando o <em>Active Job</em>, configure seu ambiente de testes para usar
o adaptador de fila para que o trabalho de limpeza seja executado imediatamente,
em vez de em um momento desconhecido no futuro.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Usa o processamento de trabalho em linha para fazer as coisas</span>
<span class="c1"># acontecerem imediatamente</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">queue_adapter</span> <span class="o">=</span> <span class="ss">:inline</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Usa o processamento de trabalho em linha para fazer as coisas
# acontecerem imediatamente
config.active_job.queue_adapter = :inline
">Copy</button>
</div>
<h5 id="testes-de-integração"><a class="anchorlink" href="#testes-de-integra%C3%A7%C3%A3o">10.1.2 Testes de Integração</a></h5><p>Similar aos testes de sistema, arquivos enviados durante testes de integração
não serão automaticamente descartados. Se você deseja limpar esses arquivos, você
pode fazer isso usando o <em>callback</em> <code>teardown</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="k">def</span> <span class="nf">after_teardown</span>
    <span class="k">super</span>
    <span class="no">FileUtils</span><span class="p">.</span><span class="nf">rm_rf</span><span class="p">(</span><span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">service</span><span class="p">.</span><span class="nf">root</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ActionDispatch::IntegrationTest
  def after_teardown
    super
    FileUtils.rm_rf(ActiveStorage::Blob.service.root)
  end
end
">Copy</button>
</div>
<p>Se você estiver usando [testes paralelos][] e o serviço em disco, deverá configurar cada processo para usar sua própria
pasta para o <em>Active Storage</em>. Dessa forma, o retorno de chamada <code>teardown</code> só excluirá arquivos do processo do teste relevante.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="n">parallelize_setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">service</span><span class="p">.</span><span class="nf">root</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">service</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ActionDispatch::IntegrationTest
  parallelize_setup do |i|
    ActiveStorage::Blob.service.root = "#{ActiveStorage::Blob.service.root}-#{i}"
  end
end
'>Copy</button>
</div>
<h4 id="adicionando-arquivos-em-fixtures"><a class="anchorlink" href="#adicionando-arquivos-em-fixtures">10.2 Adicionando Arquivos em Fixtures</a></h4><p>Você pode adicionar anexos às suas <a href="testing.html#the-low-down-on-fixtures">fixtures</a>. Primeiro, você desejará criar um serviço de armazenamento separado:</p><div class="code_container">
<pre><code class="highlight yml"><span class="c1"># config/storage.yml</span>

<span class="na">test_fixtures</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("tmp/storage_fixtures") %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/storage.yml

test_fixtures:
  service: Disk
  root: &lt;%= Rails.root.join("tmp/storage_fixtures") %&gt;
'>Copy</button>
</div>
<p>Isso informa ao <em>Active Storage</em> para onde "carregar" os arquivos de fixture, então deve ser um diretório temporário. Ao fazê-lo
um diretório diferente do seu serviço <code>test</code> regular, você pode separar os arquivos de fixtures dos arquivos carregados durante um teste.</p><p>Em seguida, crie arquivos de fixture para as classes <em>Active Storage</em>:</p><div class="code_container">
<pre><code class="highlight yml"><span class="c1"># active_storage/attachments.yml</span>
<span class="na">david_avatar</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">avatar</span>
  <span class="na">record</span><span class="pi">:</span> <span class="s">david (User)</span>
  <span class="na">blob</span><span class="pi">:</span> <span class="s">david_avatar_blob</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# active_storage/attachments.yml
david_avatar:
  name: avatar
  record: david (User)
  blob: david_avatar_blob
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight yml"><span class="c1"># active_storage/blobs.yml</span>
<span class="na">david_avatar_blob: &lt;%= ActiveStorage::FixtureSet.blob filename</span><span class="pi">:</span> <span class="s2">"</span><span class="s">david.png"</span><span class="err">,</span> <span class="na">service_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_fixtures"</span> <span class="err">%</span><span class="pi">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# active_storage/blobs.yml
david_avatar_blob: &lt;%= ActiveStorage::FixtureSet.blob filename: "david.png", service_name: "test_fixtures" %&gt;
'>Copy</button>
</div>
<p>Em seguida, coloque um arquivo em seu diretório de fixtures (o caminho padrão é <code>test/fixtures/files</code>) com o nome de arquivo correspondente.
Veja a documentação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/FixtureSet.html"><code>ActiveStorage::FixtureSet</code></a> para mais informações.</p><p>Depois que tudo estiver configurado, você poderá acessar os anexos em seus testes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="k">def</span> <span class="nf">test_avatar</span>
    <span class="n">avatar</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">avatar</span>

    <span class="n">assert</span> <span class="n">avatar</span><span class="p">.</span><span class="nf">attached?</span>
    <span class="n">assert_not_nil</span> <span class="n">avatar</span><span class="p">.</span><span class="nf">download</span>
    <span class="n">assert_equal</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">avatar</span><span class="p">.</span><span class="nf">byte_size</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class UserTest &lt; ActiveSupport::TestCase
  def test_avatar
    avatar = users(:david).avatar

    assert avatar.attached?
    assert_not_nil avatar.download
    assert_equal 1000, avatar.byte_size
  end
end
">Copy</button>
</div>
<h5 id="limpando-as-fixtures"><a class="anchorlink" href="#limpando-as-fixtures">10.2.1 Limpando as Fixtures</a></h5><p>Enquanto os arquivos enviados nos testes são limpos <a href="#discarding-files-created-durante-tests">no final de cada teste</a>,
você só precisa limpar os arquivos de fixtures uma vez: quando todos os seus testes forem concluídos.</p><p>Se você estiver usando testes paralelos, chame <code>parallelize_teardown</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="c1"># ...</span>
  <span class="n">parallelize_teardown</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="no">FileUtils</span><span class="p">.</span><span class="nf">rm_rf</span><span class="p">(</span><span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">services</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:test_fixtures</span><span class="p">).</span><span class="nf">root</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ActiveSupport::TestCase
  # ...
  parallelize_teardown do |i|
    FileUtils.rm_rf(ActiveStorage::Blob.services.fetch(:test_fixtures).root)
  end
  # ...
end
">Copy</button>
</div>
<p>Se você não estiver executando testes paralelos, use <code>Minitest.after_run</code> ou equivalente para seu teste
framework (por exemplo, <code>after(:suite)</code> para RSpec):</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test_helper.rb</span>

<span class="no">Minitest</span><span class="p">.</span><span class="nf">after_run</span> <span class="k">do</span>
  <span class="no">FileUtils</span><span class="p">.</span><span class="nf">rm_rf</span><span class="p">(</span><span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">services</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:test_fixtures</span><span class="p">).</span><span class="nf">root</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# test_helper.rb

Minitest.after_run do
  FileUtils.rm_rf(ActiveStorage::Blob.services.fetch(:test_fixtures).root)
end
">Copy</button>
</div>
<h3 id="implementando-suporte-a-outros-serviços-cloud"><a class="anchorlink" href="#implementando-suporte-a-outros-servi%C3%A7os-cloud">11 Implementando Suporte a Outros Serviços <em>Cloud</em></a></h3><p>Se for necessário dar suporte a algum outro serviço <em>cloud</em> além desses, você precisa implementá-lo. Cada serviço estende <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveStorage/Service.html"><code>ActiveStorage::Service</code></a> implementando os métodos necessários para fazer o <em>upload</em> e <em>download</em> de arquivos para a nuvem.</p><h3 id="purging-unattached-uploads"><a class="anchorlink" href="#purging-unattached-uploads">12 Purging Unattached Uploads</a></h3><p>There are cases where a file is uploaded but never attached to a record. This can happen when using <a href="#direct-uploads">Direct Uploads</a>. You can query for unattached records using the <a href="https://github.com/rails/rails/blob/8ef5bd9ced351162b673904a0b77c7034ca2bc20/activestorage/app/models/active_storage/blob.rb#L49">unattached scope</a>. Below is an example using a <a href="command_line.html#custom-rake-tasks">custom rake task</a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">namespace</span> <span class="ss">:active_storage</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Purges unattached Active Storage blobs. Run regularly."</span>
  <span class="n">task</span> <span class="ss">purge_unattached: :environment</span> <span class="k">do</span>
    <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">unattached</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">created_at: </span><span class="o">..</span><span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">).</span><span class="nf">find_each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:purge_later</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='namespace :active_storage do
  desc "Purges unattached Active Storage blobs. Run regularly."
  task purge_unattached: :environment do
    ActiveStorage::Blob.unattached.where(created_at: ..2.days.ago).find_each(&amp;:purge_later)
  end
end
'>Copy</button>
</div>
<div class="warning"><p>The query generated by <code>ActiveStorage::Blob.unattached</code> can be slow and potentially disruptive on applications with larger databases.</p></div>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua caso veja quaisquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">forum oficial do Ruby on Rails</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
