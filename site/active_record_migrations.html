<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record Migrations — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Active Record Migrations — Ruby on Rails Guides" />
  <meta name="description" content="Active Record MigrationsMigrations são uma funcionalidade do Active Record que permitem expandir nosso esquema do banco de dados com o tempo. Ao invés de escrever modificações no esquema em SQL puro, migrations permitem o uso de uma Linguagem Específica de Domínio (DSL) em Ruby para descrever as mudanças em nossas tabelas.Depois de ler esse guia, você vai saber: Os generators que você pode usar para criar as migrations. Os métodos que o Active Record provê para manipular seu banco de dados. Os comandos rails que manipulam migrations e o esquema do seu banco. Como migrations e schema.rb se relacionam." />
  <meta property="og:description" content="Active Record MigrationsMigrations são uma funcionalidade do Active Record que permitem expandir nosso esquema do banco de dados com o tempo. Ao invés de escrever modificações no esquema em SQL puro, migrations permitem o uso de uma Linguagem Específica de Domínio (DSL) em Ruby para descrever as mudanças em nossas tabelas.Depois de ler esse guia, você vai saber: Os generators que você pode usar para criar as migrations. Os métodos que o Active Record provê para manipular seu banco de dados. Os comandos rails que manipulam migrations e o esquema do seu banco. Como migrations e schema.rb se relacionam." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                  <dd><a href="active_record_encryption.html">Active Record Encryption</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - ?</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</option>
                  <option value="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
                  <option value="active_record_encryption.html">Active Record Encryption</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_0_release_notes.html">Version 7.0 - ?</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Active Record Migrations</h2><p><em>Migrations</em> são uma funcionalidade do <em>Active Record</em> que permitem expandir nosso esquema do banco de dados com o tempo. Ao invés de escrever modificações no esquema em SQL puro, <em>migrations</em> permitem o uso de uma <a href="https://pt.wikipedia.org/wiki/Linguagem_de_dom%C3%ADnio_espec%C3%ADfico">Linguagem Específica de Domínio (DSL)</a> em <em>Ruby</em> para descrever as mudanças em nossas tabelas.</p><p>Depois de ler esse guia, você vai saber:</p>
<ul>
<li>Os <em>generators</em> que você pode usar para criar as <em>migrations</em>.</li>
<li>Os métodos que o <em>Active Record</em> provê para manipular seu banco de dados.</li>
<li>Os comandos <code>rails</code> que manipulam <em>migrations</em> e o esquema do seu banco.</li>
<li>Como <em>migrations</em> e <code>schema.rb</code> se relacionam.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#visao-geral-de-migration">Visão Geral de Migration</a></li>
<li>
<a href="#criando-uma-migration">Criando uma <em>Migration</em></a>

<ul>
<li><a href="#criando-uma-migration-independente">Criando uma <em>Migration</em> Independente</a></li>
<li><a href="#model-generators">Model Generators</a></li>
<li><a href="#usando-modificadores">Usando Modificadores</a></li>
</ul>
</li>
<li>
<a href="#escrevendo-uma-migration">Escrevendo uma <em>Migration</em></a>

<ul>
<li><a href="#criando-uma-tabela">Criando uma Tabela</a></li>
<li><a href="#criando-uma-tabela-de-juncao-join-table">Criando uma Tabela de Junção (Join Table)</a></li>
<li><a href="#mudando-tabelas">Mudando Tabelas</a></li>
<li><a href="#mudando-colunas">Mudando Colunas</a></li>
<li><a href="#modificadores-de-coluna">Modificadores de Coluna</a></li>
<li><a href="#references">References</a></li>
<li><a href="#foreign-keys-chaves-estrangeiras">Foreign Keys (Chaves Estrangeiras)</a></li>
<li><a href="#quando-os-helpers-nao-sao-suficientes">Quando os Helpers não são Suficientes</a></li>
<li><a href="#usando-o-metodo-change">Usando o Método <code>change</code></a></li>
<li><a href="#usando-reversible">Usando <code>reversible</code></a></li>
<li><a href="#usando-os-metodos-up-down">Usando os métodos <code>up</code>/<code>down</code></a></li>
<li><a href="#revertendo-migrations-anteriores">Revertendo <em>Migrations</em> Anteriores</a></li>
</ul>
</li>
<li>
<a href="#executando-as-migrations">Executando as <em>Migrations</em></a>

<ul>
<li><a href="#revertendo-a-migration">Revertendo a <em>Migration</em></a></li>
<li><a href="#setup-do-banco-de-dados">Setup do Banco de Dados</a></li>
<li><a href="#reinicializando-o-banco-de-dados">Reinicializando o Banco de Dados</a></li>
<li><a href="#executando-migrations-especificas">Executando <em>Migrations</em> Específicas</a></li>
<li><a href="#executando-migrations-em-ambientes-diferentes">Executando <em>Migrations</em> em Ambientes Diferentes</a></li>
<li><a href="#alterando-o-output-saida-de-migrations-em-execucao">Alterando o Output (Saída) de <em>Migrations</em> em Execução</a></li>
</ul>
</li>
<li><a href="#mudando-migrations-existentes">Mudando <em>Migrations</em> Existentes</a></li>
<li>
<a href="#schema-dumping-e-voce"><em>Schema Dumping</em> e Você</a>

<ul>
<li><a href="#para-que-servem-arquivos-de-schema-questionmark">Para que servem arquivos de Schema?</a></li>
<li><a href="#tipos-de-schema-dumps">Tipos de Schema Dumps</a></li>
<li><a href="#schema-dumps-e-o-controle-de-versao">Schema Dumps e o Controle de Versão</a></li>
</ul>
</li>
<li><a href="#active-record-e-integridade-referencial"><em>Active Record</em> e Integridade Referencial</a></li>
<li><a href="#migracoes-e-dados-de-seed">Migrações e Dados de <em>Seed</em></a></li>
<li><a href="#migrations-antigas"><em>Migrations</em> Antigas</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="visao-geral-de-migration"><a class="anchorlink" href="#visao-geral-de-migration">1 Visão Geral de Migration</a></h3><p><em>Migrations</em> são uma forma conveniente de
<a href="https://en.wikipedia.org/wiki/Schema_migration">alterar nosso esquema de banco de dados com o tempo</a> de uma forma fácil e consistente. Elas usam uma <em>Ruby DSL</em> para que você não precise escrever SQL puro, permitindo que seu esquema e as alterações sejam independentes do banco de dados utilizado.</p><p>Você pode pensar em cada <em>migration</em> como sendo uma nova 'versão' do banco de dados. Um esquema é vazio no início, e após cada <em>migration</em> ele é modificado para adicionar ou remover tabelas, colunas, ou entradas de dados. O <em>Active Record</em> sabe como atualizar seu esquema nessa linha do tempo, trazendo-o de qualquer ponto em que ele esteja no histórico, para a última versão. O <em>Active Record</em> também atualizará seu arquivo <code>db/schema.rb</code> para igualar a estrutura mais atualizada do seu banco de dados.</p><p>Aqui temos um exemplo de uma <em>migration</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-853fb7472baa5b037a91e9386c24b7e6">class CreateProducts &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :products do |t|
      t.string :name
      t.text :description

      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-853fb7472baa5b037a91e9386c24b7e6">Copiar</button>
</div>
<p>Essa <em>migration</em> adiciona uma tabela chamada <code>products</code> com uma coluna do tipo <em>string</em> chamada <code>name</code> e uma coluna do tipo <em>text</em> chamada <code>description</code>. Uma coluna do tipo chave primária chamada <code>id</code> também será adicionada implicitamente, pois ela é a chave primária padrão para todos os <em>models</em> de <em>Active Record</em>. A macro <code>timestamps</code> adiciona duas colunas, <code>created_at</code> e <code>updated_at</code>. Essas colunas especiais são automaticamente gerenciadas pelo <em>Active Record</em>, se existirem.</p><p>Note que nós definimos as mudanças que queremos que aconteçam no futuro.
Antes desta <em>migration</em> ser executada, não há sequer a tabela. Depois, a tabela será criada. O <em>Active Record</em> também sabe como reverter essa <em>migration</em>: se a desfizermos, ele removerá a tabela.</p><p>Em bancos de dados que suportem transações com declarações que alterem o esquema,
<em>migrations</em> são incluídas na transação. Se o banco de dados não suportar esses tipos de declarações, então, quando uma <em>migration</em> falhar, as partes dela que tiveram sucesso não serão desfeitas. Você terá que desfazer as mudanças que fez manualmente.</p><div class="note"><p>Há certos tipos de <em>queries</em> que não podem ser executadas dentro de uma transação. Se o seu adaptador de conexão suporta transações DDL você pode usar <code>disable_ddl_transaction!</code> para desabilitá-las para uma única <em>migration</em>.</p></div><p>Se você quiser que uma <em>migration</em> faça algo que o <em>Active Record</em> não sabe como reverter, pode usar <code>reversible</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ChangeProductsPrice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
      <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">up</span>   <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:string</span> <span class="p">}</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:integer</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0d1a7360fee086e610db2623bcf2c333">class ChangeProductsPrice &lt; ActiveRecord::Migration[7.0]
  def change
    reversible do |dir|
      change_table :products do |t|
        dir.up   { t.change :price, :string }
        dir.down { t.change :price, :integer }
      end
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0d1a7360fee086e610db2623bcf2c333">Copiar</button>
</div>
<p>Alternativamente, você pode usar <code>up</code> e <code>down</code> ao invés de <code>change</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ChangeProductsPrice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:integer</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cfbdb16a34c314c77a3212ef8c5f67dc">class ChangeProductsPrice &lt; ActiveRecord::Migration[7.0]
  def up
    change_table :products do |t|
      t.change :price, :string
    end
  end

  def down
    change_table :products do |t|
      t.change :price, :integer
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cfbdb16a34c314c77a3212ef8c5f67dc">Copiar</button>
</div>
<h3 id="criando-uma-migration"><a class="anchorlink" href="#criando-uma-migration">2 Criando uma <em>Migration</em></a></h3><h4 id="criando-uma-migration-independente"><a class="anchorlink" href="#criando-uma-migration-independente">2.1 Criando uma <em>Migration</em> Independente</a></h4><p><em>Migrations</em> são armazenadas em arquivos no diretório <code>db/migrate</code>, um para cada classe de
<em>migration</em>. O nome do arquivo tem o seguinte formato
<code>YYYYMMDDHHMMSS_create_products.rb</code>, isto é uma <em>timestamp</em> (marcação de data/hora) em UTC identificando a
<em>migration</em> seguida por um underline seguido pelo
nome da <em>migration</em>. O nome da classe da migration
(em CamelCase) deve corresponder à última parte do nome do arquivo. Por exemplo
<code>20080906120000_create_products.rb</code> deve definir a classe <code>CreateProducts</code> e
<code>20080906120001_add_details_to_products.rb</code> deve definir
<code>AddDetailsToProducts</code>. O Rails usa esse registro de data e hora para determinar qual <em>migration</em>
deve ser executada e em que ordem, portanto, se você estiver copiando uma <em>migration</em> de outra
aplicação ou gerar um arquivo você mesmo, esteja ciente de sua posição na ordem.</p><p>Obviamente, calcular <em>timestamps</em> não é divertido, portanto, o <em>Active Record</em> fornece um
gerador para fazer isso por você:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddPartNumberToProducts
</code></pre>
<textarea class="clipboard-content" id="clipboard-2a37d046373937a8e93e5e98a9b2ec46">bin/rails generate migration AddPartNumberToProducts
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2a37d046373937a8e93e5e98a9b2ec46">Copiar</button>
</div>
<p>Isso criará uma <em>migration</em> vazia nomeada devidamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-431ecc91877594da9801c35f98c8446b">class AddPartNumberToProducts &lt; ActiveRecord::Migration[7.0]
  def change
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-431ecc91877594da9801c35f98c8446b">Copiar</button>
</div>
<p>Esse gerador pode fazer muito mais do que acrescentar uma <em>timestamp</em> ao nome do arquivo.
Com base em convenções de nomenclatura e argumentos (opcionais) adicionais, ele pode
também começar a concretizar a <em>migration</em>.</p><p>Se o nome da migração estiver no formato "AddColumnToTable" ou
"RemoveColumnFromTable" e é seguido por uma lista de nomes de colunas e
tipos de dados, então uma <em>migration</em> contendo as intruções <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_column"><code>add_column</code></a> e
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_column"><code>remove_column</code></a> serão criadas apropriadamente.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddPartNumberToProducts part_number:string
</code></pre>
<textarea class="clipboard-content" id="clipboard-8ff4f489e9ba04e166faf1546831dbb4">bin/rails generate migration AddPartNumberToProducts part_number:string
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8ff4f489e9ba04e166faf1546831dbb4">Copiar</button>
</div>
<p>irá gerar</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-223c5d5247190b3d5e86718a407c4b7b">class AddPartNumberToProducts &lt; ActiveRecord::Migration[7.0]
  def change
    add_column :products, :part_number, :string
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-223c5d5247190b3d5e86718a407c4b7b">Copiar</button>
</div>
<p>Se você deseja adicionar um índice na nova coluna, você também pode fazer isso.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddPartNumberToProducts part_number:string:index
</code></pre>
<textarea class="clipboard-content" id="clipboard-c5eea9371735678bda75f2c0f2f4a060">bin/rails generate migration AddPartNumberToProducts part_number:string:index
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c5eea9371735678bda75f2c0f2f4a060">Copiar</button>
</div>
<p>irá gerar o <code>add_column</code> apropriado e o <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_index"><code>add_index</code></a></p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8b41e7c582a0823a7d577e8a42bb1d78">class AddPartNumberToProducts &lt; ActiveRecord::Migration[7.0]
  def change
    add_column :products, :part_number, :string
    add_index :products, :part_number
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8b41e7c582a0823a7d577e8a42bb1d78">Copiar</button>
</div>
<p>Da mesma forma, você pode gerar uma <em>migration</em> para remover uma coluna via linha de comando:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration RemovePartNumberFromProducts part_number:string
</code></pre>
<textarea class="clipboard-content" id="clipboard-b89126d2e961f2d616dc1051369306da">bin/rails generate migration RemovePartNumberFromProducts part_number:string
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b89126d2e961f2d616dc1051369306da">Copiar</button>
</div>
<p>gera</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">RemovePartNumberFromProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">remove_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e50f1b3d997479ce845a556ddcf96f94">class RemovePartNumberFromProducts &lt; ActiveRecord::Migration[7.0]
  def change
    remove_column :products, :part_number, :string
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e50f1b3d997479ce845a556ddcf96f94">Copiar</button>
</div>
<p>Você não tem a limitação de apenas uma coluna ser gerada magicamente. Por exemplo:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddDetailsToProducts part_number:string price:decimal
</code></pre>
<textarea class="clipboard-content" id="clipboard-6bb07f0024d20c747a428bc70c883dc7">bin/rails generate migration AddDetailsToProducts part_number:string price:decimal
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6bb07f0024d20c747a428bc70c883dc7">Copiar</button>
</div>
<p>gera</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddDetailsToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:decimal</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8860e05df93d7f9b28746329aa3f8b30">class AddDetailsToProducts &lt; ActiveRecord::Migration[7.0]
  def change
    add_column :products, :part_number, :string
    add_column :products, :price, :decimal
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8860e05df93d7f9b28746329aa3f8b30">Copiar</button>
</div>
<p>Se o nome da migração estiver no formato "CreateXXX" e for
seguido por uma lista de nomes e tipos de colunas, em seguida, uma <em>migration</em> criando a tabela
XXX com as colunas listadas será gerado. Por exemplo:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration CreateProducts name:string part_number:string
</code></pre>
<textarea class="clipboard-content" id="clipboard-20a110c19b37086d5238993f6aca9a90">bin/rails generate migration CreateProducts name:string part_number:string
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-20a110c19b37086d5238993f6aca9a90">Copiar</button>
</div>
<p>gera</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c64999beedd28fa618f821e0473d50c4">class CreateProducts &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :products do |t|
      t.string :name
      t.string :part_number

      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c64999beedd28fa618f821e0473d50c4">Copiar</button>
</div>
<p>Como sempre, o que foi gerado para você é apenas um ponto de partida. Você pode adicionar
ou remover conteúdo como achar melhor, editando o arquivo
<code>db/migrate/YYYYMMDDHHMMSS_add_details_to_products.rb</code>.</p><p>Além disso, o gerador aceita o tipo de coluna <code>references</code> (também disponível como
<code>belongs_to</code>). Por exemplo:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddUserRefToProducts user:references
</code></pre>
<textarea class="clipboard-content" id="clipboard-b0bb29ee5640d1fd2c09ae5df1fb5283">bin/rails generate migration AddUserRefToProducts user:references
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b0bb29ee5640d1fd2c09ae5df1fb5283">Copiar</button>
</div>
<p>gera a seguinte chamada a [<code>add_references</code>][]:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddUserRefToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bc81850c72ffff9cd63e9623d51d6c74">class AddUserRefToProducts &lt; ActiveRecord::Migration[7.0]
  def change
    add_reference :products, :user, foreign_key: true
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bc81850c72ffff9cd63e9623d51d6c74">Copiar</button>
</div>
<p>Essa migração criará uma coluna <code>user_id</code>, <a href="#references">references</a> é um
abreviação para criar colunas, índices, chaves estrangeiras ou mesmo colunas polimórficas
de associação.</p><p>Também existe um gerador que produzirá <em>join tables</em> se <code>JoinTable</code> fizer parte do nome:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>g migration CreateJoinTableCustomerProduct customer product
</code></pre>
<textarea class="clipboard-content" id="clipboard-14e610ad9e952a46cf9d99b46ff4b2b0">bin/rails g migration CreateJoinTableCustomerProduct customer product
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-14e610ad9e952a46cf9d99b46ff4b2b0">Copiar</button>
</div>
<p>produzirá a seguinte migração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateJoinTableCustomerProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:customers</span><span class="p">,</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># t.index [:customer_id, :product_id]</span>
      <span class="c1"># t.index [:product_id, :customer_id]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fef2aeb6530d1e2ad88e9ca7de0f05f8">class CreateJoinTableCustomerProduct &lt; ActiveRecord::Migration[7.0]
  def change
    create_join_table :customers, :products do |t|
      # t.index [:customer_id, :product_id]
      # t.index [:product_id, :customer_id]
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fef2aeb6530d1e2ad88e9ca7de0f05f8">Copiar</button>
</div>
<h4 id="model-generators"><a class="anchorlink" href="#model-generators">2.2 Model Generators</a></h4><p>Os geradores de <em>model</em>, <em>resource</em> e <em>scaffold</em> criarão migrações apropriadas para adicionar
um novo <em>model</em>. Essa migração já irá conter as instruções para criar a
tabela. Se você disser ao Rails quais colunas você deseja, as instruções para
adicionar essas colunas também serão criadas. Por exemplo, executando:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model Product name:string description:text
</code></pre>
<textarea class="clipboard-content" id="clipboard-74bdaf3d3273e821f03de5de78359cdf">bin/rails generate model Product name:string description:text
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-74bdaf3d3273e821f03de5de78359cdf">Copiar</button>
</div>
<p>criará uma migração que se parece com isso</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d6a9c76d94b9d864ae98436a4aa71e85">class CreateProducts &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :products do |t|
      t.string :name
      t.text :description

      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d6a9c76d94b9d864ae98436a4aa71e85">Copiar</button>
</div>
<p>Você pode utilizar quantos pares de nome/tipo de coluna desejar.</p><h4 id="usando-modificadores"><a class="anchorlink" href="#usando-modificadores">2.3 Usando Modificadores</a></h4><p>Alguns <a href="#modificadores-de-coluna">modificadores de tipo</a> podem utilizados diretamente via
linha de comando. Eles são delimitados por chaves e vem após o tipo de campo:</p><p>Por exemplo, executando:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddDetailsToProducts <span class="s1">'price:decimal{5,2}'</span> supplier:references<span class="o">{</span>polymorphic<span class="o">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d7385f86590af69b73aaaebe0ab443a3">bin/rails generate migration AddDetailsToProducts 'price:decimal{5,2}' supplier:references{polymorphic}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d7385f86590af69b73aaaebe0ab443a3">Copiar</button>
</div>
<p>produzirá uma migração que se parece com isso</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddDetailsToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:decimal</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span>
    <span class="n">add_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b375f2ea474290f0e92736bdcc31a138">class AddDetailsToProducts &lt; ActiveRecord::Migration[7.0]
  def change
    add_column :products, :price, :decimal, precision: 5, scale: 2
    add_reference :products, :supplier, polymorphic: true
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b375f2ea474290f0e92736bdcc31a138">Copiar</button>
</div>
<div class="info"><p>Dê uma olhada no <code>--help</code> dos <em>generators</em> (geradores) obter mais detalhes.</p></div><h3 id="escrevendo-uma-migration"><a class="anchorlink" href="#escrevendo-uma-migration">3 Escrevendo uma <em>Migration</em></a></h3><p>Depois de criar sua <em>migration</em> usando um dos geradores, é hora de
começar os trabalhos!</p><h4 id="criando-uma-tabela"><a class="anchorlink" href="#criando-uma-tabela">3.1 Criando uma Tabela</a></h4><p>O método <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_table"><code>create_table</code></a> é um dos mais fundamentais, mas na maioria das vezes,
ele será criado para você usando um gerador de <em>model</em>, <em>resource</em> ou <em>scaffold</em>. Um uso
típico seria:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bda8a08e1863bd46ab375770f276c607">create_table :products do |t|
  t.string :name
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bda8a08e1863bd46ab375770f276c607">Copiar</button>
</div>
<p>Que cria uma tabela <code>products</code> com uma coluna chamada <code>name</code>.</p><p>Por padrão, o <code>create_table</code> criará uma chave primária chamada <code>id</code>. Você pode mudar
o nome da chave primária com a opção <code>:primary_key</code> (não esqueça de
atualizar o <em>model</em> correspondente) ou, se você não quer uma chave primária, você
pode passar a opção <code>id: false</code>. Se você precisa passar opções específicas do banco de dados
você pode colocar um fragmento SQL na opção <code>:option</code>. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">options: </span><span class="s2">"ENGINE=BLACKHOLE"</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-252323e3f43dc790f9b20b860c5b8e62">create_table :products, options: "ENGINE=BLACKHOLE" do |t|
  t.string :name, null: false
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-252323e3f43dc790f9b20b860c5b8e62">Copiar</button>
</div>
<p>acrescentará <code>ENGINE=BLACKHOLE</code> à instrução SQL usada para criar a tabela.</p><p>Um índice pode ser criado nas colunas criadas dentro do bloco <code>create_table</code>
passando <code>true</code> ou um <code>hash</code> para a opção <code>:index</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'unique_emails'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e2f395d5e092b456f5ed00e74d8c5c02">create_table :users do |t|
  t.string :name, index: true
  t.string :email, index: { unique: true, name: 'unique_emails' }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e2f395d5e092b456f5ed00e74d8c5c02">Copiar</button>
</div>
<p>Você também pode passar a opção <code>:comment</code> com qualquer descrição para a tabela
que serão armazenados no próprio bando de dados e poderão ser visualizados com ferramentas de administração
de banco de dados, como MySQL Workbench ou PgAdmin III. É altamente recomendável especificar
comentários nas <em>migrations</em> para aplicações com grandes bancos de dados, pois ajudam as pessoas
a entender o modelo de dados e gerar documentação.
Atualmente, apenas os adaptadores MySQL e PostgreSQL suportam comentários.</p><h4 id="criando-uma-tabela-de-juncao-join-table"><a class="anchorlink" href="#criando-uma-tabela-de-juncao-join-table">3.2 Criando uma Tabela de Junção (Join Table)</a></h4><p>O método de <em>migration</em> <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_join_table"><code>create_join_table</code></a> cria uma tabela <em>join</em> HABTM (tem e pertence a
muitos). Um uso comum seria:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e6029b698dc8f7b513bc158d9f8aecd8">create_join_table :products, :categories
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e6029b698dc8f7b513bc158d9f8aecd8">Copiar</button>
</div>
<p>que cria uma tabela <code>categories_products</code> com duas colunas chamadas
<code>category_id</code> e <code>product_id</code>. Essas colunas têm a opção <code>:null</code> definida como
<code>false</code> por padrão. Isso pode ser substituído, especificando a opção
<code>:column_options</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">column_options: </span><span class="p">{</span> <span class="ss">null: </span><span class="kp">true</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-695248c969b5cfc2e0466fb4da1e1b06">create_join_table :products, :categories, column_options: { null: true }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-695248c969b5cfc2e0466fb4da1e1b06">Copiar</button>
</div>
<p>Por padrão, o nome da tabela de <em>join</em> vem da união dos dois primeiros
argumentos fornecidos para <code>create_join_table</code> em ordem alfabética.
Para customizar o nome da tabela, forneça uma opção <code>:table_name</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">table_name: :categorization</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1c6a97da73af1baa3de607abd1ab4f9a">create_join_table :products, :categories, table_name: :categorization
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1c6a97da73af1baa3de607abd1ab4f9a">Copiar</button>
</div>
<p>cria uma tabela <code>categorization</code>.</p><p><code>create_join_table</code> também aceita um bloco, que você pode usar para adicionar índices
(que não são criados por padrão) ou colunas adicionais:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:product_id</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:category_id</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-72509345335f021d50d6d48985de1682">create_join_table :products, :categories do |t|
  t.index :product_id
  t.index :category_id
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-72509345335f021d50d6d48985de1682">Copiar</button>
</div>
<h4 id="mudando-tabelas"><a class="anchorlink" href="#mudando-tabelas">3.3 Mudando Tabelas</a></h4><p>Um primo próximo do <code>create_table</code> é <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_table"><code>change_table</code></a>, usado para mudar tabelas
existentes. É usado de maneira semelhante ao <code>create_table</code> mas o objeto
produzido no bloco conhece mais truques. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">remove</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:name</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_number</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">rename</span> <span class="ss">:upccode</span><span class="p">,</span> <span class="ss">:upc_code</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e2ecf75d5d716ed962e30f60f13228ca">change_table :products do |t|
  t.remove :description, :name
  t.string :part_number
  t.index :part_number
  t.rename :upccode, :upc_code
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e2ecf75d5d716ed962e30f60f13228ca">Copiar</button>
</div>
<p>remove as colunas <code>description</code> e <code>name</code>, cria uma coluna de string <code>part_number</code>
e adiciona um índice nela. Finalmente renomeia a coluna <code>upccode</code>.</p><h4 id="mudando-colunas"><a class="anchorlink" href="#mudando-colunas">3.4 Mudando Colunas</a></h4><p>Assim como o <code>remove_column</code> e <code>add_column</code>, o Rails fornece o método de
<em>migration</em> <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column"><code>change_column</code></a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">change_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:text</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0be19118daebf996701417ed7eae4b94">change_column :products, :part_number, :text
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0be19118daebf996701417ed7eae4b94">Copiar</button>
</div>
<p>Isso muda a coluna <code>part_number</code> na tabela produtos para ser um campo <code>:text</code>.
Note que o comando <code>change_column</code> é irreversível.</p><p>Além do <code>change_column</code>, os métodos <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_null"><code>change_column_null</code></a> e <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_default"><code>change_column_default</code></a>
são usados especificamente para alterar uma restrição de não ser nulo e valores
padrão de uma coluna.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">change_column_null</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="kp">false</span>
<span class="n">change_column_default</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:approved</span><span class="p">,</span> <span class="ss">from: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">to: </span><span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c024c76c3d18a0190c194f0d786d97cc">change_column_null :products, :name, false
change_column_default :products, :approved, from: true, to: false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c024c76c3d18a0190c194f0d786d97cc">Copiar</button>
</div>
<p>Isso define o campo <code>:name</code> em produtos para uma coluna <code>NOT NULL</code> e o valor
padrão do campo <code>:approved</code> de <code>true</code> para <code>false</code>.</p><div class="note"><p>Você também pode escrever a <em>migration</em> <code>change_column_default</code> acima como
<code>change_column_default :products, :approved, false</code>, mas diferente do exemplo
anterior, isso tornaria sua <em>migration</em> irreversível.</p></div><h4 id="modificadores-de-coluna"><a class="anchorlink" href="#modificadores-de-coluna">3.5 Modificadores de Coluna</a></h4><p>Modificadores de coluna podem ser aplicados ao criar ou alterar uma coluna:</p>
<ul>
<li>
<code>comment</code>      Adiciona um comentário para a coluna.</li>
<li>
<code>collation</code>    Especifica a <em>collation</em> para uma coluna <code>string</code> ou <code>text</code>.</li>
<li>
<code>default</code>      Permite definir um valor padrão na coluna. Note que se você
estiver usando um valor dinâmico (como uma data), o padrão será calculado
apenas na primeira vez (ou seja, na data em que a <em>migration</em> é aplicada). Use <code>nil</code> para <code>NULL</code>.</li>
<li>
<code>limit</code>        Define o número máximo de caracteres para uma coluna <code>string</code> e o número máximo de bytes para colunas do tipo <code>text/binary/integer</code>.</li>
<li>
<code>null</code>         Permite ou não permite valores <code>NULL</code> na coluna.</li>
<li>
<code>precision</code>    Define a precisão para colunas de tipo <code>decimal/numeric/datetime/time</code>.</li>
<li>
<code>scale</code>        Define a escala para os campos <code>decimal</code> e <code>numeric</code>, representando o
número de digitos após o ponto decimal.</li>
</ul>
<div class="note"><p>Para <code>add_column</code> ou <code>change_column</code> não há opção para adicionar índices.
Eles precisam ser adicionados separadamente usando <code>add_index</code>.</p></div><p>Alguns adaptadores podem suportar opções adicionais; consulte a documentação da API de um adaptador específico
para maiores informações.</p><div class="note"><p><code>null</code> e <code>default</code> não podem ser especificados via linha de comando.</p></div><h4 id="references"><a class="anchorlink" href="#references">3.6 References</a></h4><p>O método <code>add_reference</code> permite a criação de uma coluna apropriadamente nomeada.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_reference</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:role</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2bc285f0c40d7370932ad9e623c8de12">add_reference :users, :role
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2bc285f0c40d7370932ad9e623c8de12">Copiar</button>
</div>
<p>Essa migração criará uma coluna <code>role_id</code> na tabela de usuários. Ela cria um
index para esta coluna também, a menos que explicitamente informado com o
opção <code>index: false</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_reference</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:role</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b6ba5ee24ed647b0d9dfa45b64b30f8f">add_reference :users, :role, index: false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b6ba5ee24ed647b0d9dfa45b64b30f8f">Copiar</button>
</div>
<p>O método <code>add_belongs_to</code> é um <em>alias</em> para <code>add_reference</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_belongs_to</span> <span class="ss">:taggings</span><span class="p">,</span> <span class="ss">:taggable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-af68f229a88d67279999336aef5b423b">add_belongs_to :taggings, :taggable, polymorphic: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-af68f229a88d67279999336aef5b423b">Copiar</button>
</div>
<p>A opção polimórfica criará duas colunas na tabela de tags que podem
ser usado para associações polimórficas: <code>taggable_type</code> e <code>taggable_id</code>.</p><p>Uma chave estrangeira pode ser criada com a opção <code>foreign_key</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_reference</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:role</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-27c99b97428dd3be0bf7730b5d1f7d00">add_reference :users, :role, foreign_key: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-27c99b97428dd3be0bf7730b5d1f7d00">Copiar</button>
</div>
<p>Para obter mais opções de <code>add_reference</code>, visite a <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference">documentação da API</a>.</p><p>As referências também podem ser removidas:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">remove_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-303f9f9649629475636d64aee88704d8">remove_reference :products, :user, foreign_key: true, index: false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-303f9f9649629475636d64aee88704d8">Copiar</button>
</div>
<h4 id="foreign-keys-chaves-estrangeiras"><a class="anchorlink" href="#foreign-keys-chaves-estrangeiras">3.7 Foreign Keys (Chaves Estrangeiras)</a></h4><p>Embora não seja necessário, você pode adicionar restrições de foreign key (chave estrangeira) para
<a href="#active-record-e-integridade-referencial">garantir a integridade referencial</a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_foreign_key</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:authors</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7f654eb5b1bd8e461bbd99b4122ac0b3">add_foreign_key :articles, :authors
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7f654eb5b1bd8e461bbd99b4122ac0b3">Copiar</button>
</div>
<p>Isso adiciona uma nova <em>foreign key</em> (chave estrangeira) à coluna <code>author_id</code> da tabela
<code>articles</code>. A chave referencia a coluna <code>id</code> para a tabela <code>authors</code>. Se os
nomes da coluna não puderem ser derivados dos nomes das tabelas, você poderá usar as
opções <code>:column</code> e <code>:primary_key</code>.
O Rails irá gerar um nome para cada <em>foreign key</em> (chave estrangeira) começando com
<code>fk_rails_</code> seguido por 10 caracteres que são gerados
especificamente a partir do <code>from_table</code> e <code>column</code>.
Existe uma opção <code>:name</code> para especificar um nome diferente se necessário.</p><div class="note"><p>O Active Record suporta apenas <em>foreign keys</em> (chaves estrangeiras) de coluna única. <code>execute</code> e
<code>structure.sql</code> são obrigados a usar foreign keys (chaves estrangeiras) compostas. Consulte
<a href="#schema-dumping-e-voce">Schema Dumping e Você</a>.</p></div><p>Foreign key (chave estrangeira) também podem ser removidas:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># let Active Record figure out the column name</span>
<span class="n">remove_foreign_key</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:branches</span>

<span class="c1"># remove foreign key for a specific column</span>
<span class="n">remove_foreign_key</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">column: :owner_id</span>

<span class="c1"># remove foreign key by name</span>
<span class="n">remove_foreign_key</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">name: :special_fk_name</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d8947b6dc18b852fcb58a281bbefe4ac"># let Active Record figure out the column name
remove_foreign_key :accounts, :branches

# remove foreign key for a specific column
remove_foreign_key :accounts, column: :owner_id

# remove foreign key by name
remove_foreign_key :accounts, name: :special_fk_name
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d8947b6dc18b852fcb58a281bbefe4ac">Copiar</button>
</div>
<h4 id="quando-os-helpers-nao-sao-suficientes"><a class="anchorlink" href="#quando-os-helpers-nao-sao-suficientes">3.8 Quando os Helpers não são Suficientes</a></h4><p>Se os <em>helpers</em> fornecidos pelo Active Record não forem suficientes, você poderá usar o método <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/DatabaseStatements.html#method-i-execute"><code>execute</code></a>
para executar SQL arbitrário:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"UPDATE products SET price = 'free' WHERE 1=1"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1e350f82cd79f6bd102fb67c18c3f65a">Product.connection.execute("UPDATE products SET price = 'free' WHERE 1=1")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1e350f82cd79f6bd102fb67c18c3f65a">Copiar</button>
</div>
<p>Para mais detalhes e exemplos de métodos individuais, consulte a documentação da API.
Em particular, a documentação para
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html"><code>ActiveRecord::ConnectionAdapters::SchemaStatements</code></a>
(que fornece os métodos disponíveis nos métodos <code>change</code>, <code>up</code> e <code>down</code>),
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html"><code>ActiveRecord::ConnectionAdapters::TableDefinition</code></a>
(que fornece os métodos disponíveis no objeto gerado por <code>create_table</code>)
e
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/Table.html"><code>ActiveRecord::ConnectionAdapters::Table</code></a>
(que fornece os métodos disponíveis no objeto gerado por <code>change_table</code>).</p><h4 id="usando-o-metodo-change"><a class="anchorlink" href="#usando-o-metodo-change">3.9 Usando o Método <code>change</code></a></h4><p>O método <code>change</code> é a principal maneira de escrever <em>migrations</em>. Funciona para a
maioria dos casos, onde o <em>Active Record</em> sabe como reverter a <em>migration</em>
automaticamente. Atualmente, o método <code>change</code> suporta apenas estas definições de
<em>migrations</em>:</p>
<ul>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_column"><code>add_column</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_foreign_key"><code>add_foreign_key</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_index"><code>add_index</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference"><code>add_reference</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_timestamps"><code>add_timestamps</code></a></li>
<li>
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_default"><code>change_column_default</code></a> (must supply a <code>:from</code> and <code>:to</code> option)</li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_null"><code>change_column_null</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_join_table"><code>create_join_table</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_table"><code>create_table</code></a></li>
<li><code>disable_extension</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-drop_join_table"><code>drop_join_table</code></a></li>
<li>
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-drop_table"><code>drop_table</code></a> (must supply a block)</li>
<li><code>enable_extension</code></li>
<li>
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_column"><code>remove_column</code></a> (must supply a type)</li>
<li>
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_foreign_key"><code>remove_foreign_key</code></a> (must supply a second table)</li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_index"><code>remove_index</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_reference"><code>remove_reference</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_timestamps"><code>remove_timestamps</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-rename_column"><code>rename_column</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-rename_index"><code>rename_index</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-rename_table"><code>rename_table</code></a></li>
</ul>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_table"><code>change_table</code></a> também é reversível, desde que o bloco não chame <code>change</code>,
<code>change_default</code> ou <code>remove</code>.</p><p><code>remove_column</code> é reversível se você fornecer o tipo de coluna como o terceiro
argumento. Forneça também as opções da coluna original, caso contrário, o Rails não poderá
recriar a coluna exatamente ao reverter:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">remove_column</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">:slug</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">''</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-dec62042cd71be0a8dcb0ccbba963f3d">remove_column :posts, :slug, :string, null: false, default: ''
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-dec62042cd71be0a8dcb0ccbba963f3d">Copiar</button>
</div>
<p>Se você precisar usar outros métodos, você deve usar <code>reversible</code>
ou escrever os métodos <code>up</code> e <code>down</code> em vez de usar o médoto <code>change</code>.</p><h4 id="usando-reversible"><a class="anchorlink" href="#usando-reversible">3.10 Usando <code>reversible</code></a></h4><p><em>Migrations</em> complexas podem exigir processamento que o <em>Active Record</em> não sabe como
reverter. Você pode usar <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Migration.html#method-i-reversible"><code>reversible</code></a> para especificar o que fazer ao executar uma
<em>migration</em> e o que mais fazer ao revertê-la. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:distributors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:zipcode</span>
    <span class="k">end</span>

    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
        <span class="c1"># add a CHECK constraint</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          ALTER TABLE distributors
            ADD CONSTRAINT zipchk
              CHECK (char_length(zipcode) = 5) NO INHERIT;
</span><span class="no">        SQL</span>
      <span class="k">end</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          ALTER TABLE distributors
            DROP CONSTRAINT zipchk
</span><span class="no">        SQL</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:email_address</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6f9c6f9f87c5b5c2de9dfcf57c3a41d0">class ExampleMigration &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :distributors do |t|
      t.string :zipcode
    end

    reversible do |dir|
      dir.up do
        # add a CHECK constraint
        execute &lt;&lt;-SQL
          ALTER TABLE distributors
            ADD CONSTRAINT zipchk
              CHECK (char_length(zipcode) = 5) NO INHERIT;
        SQL
      end
      dir.down do
        execute &lt;&lt;-SQL
          ALTER TABLE distributors
            DROP CONSTRAINT zipchk
        SQL
      end
    end

    add_column :users, :home_page_url, :string
    rename_column :users, :email, :email_address
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6f9c6f9f87c5b5c2de9dfcf57c3a41d0">Copiar</button>
</div>
<p>O uso de <code>reversible</code> garantirá que as instruções também sejam executadas na
ordem certa. Se o exemplo anterior de <em>migration</em> for revertido,
o bloco <code>down</code> será executado depois que a coluna <code>home_page_url</code> for removida e
logo antes da tabela <code>distributors</code> for apagada.</p><p>Às vezes sua <em>migration</em> fará algo que é simplesmente irreversível;
por exemplo, pode destruir alguns dados. Em alguns casos, você pode levantar o
<code>ActiveRecord::IrreversibleMigration</code> no seu bloco <code>down</code>. Se alguém tentar
reverter sua <em>migration</em>, uma mensagem de erro será exibida dizendo que isso
não pode ser feito.</p><h4 id="usando-os-metodos-up-down"><a class="anchorlink" href="#usando-os-metodos-up-down">3.11 Usando os métodos <code>up</code>/<code>down</code></a></h4><p>Você também pode usar o estilo antigo de <em>migration</em> usando os métodos <code>up</code> e <code>down</code>
em vez do método <code>change</code>.
O método <code>up</code> deve descrever a transformação que você deseja fazer no seu
<em>schema</em>, e o método <code>down</code> da sua <em>migration</em> deve reverter as
transformações feitas pelo método <code>up</code>. Em outras palavas, o <em>schema</em> do banco de dados
deve permanecer inalterado se você fizer um <code>up</code> seguido por um <code>down</code>. Por exemplo, se você
criar uma tabela em um método <code>up</code>, você deve apagá-la no método <code>down</code>. É
aconselhável realizar as transformações precisamente na ordem inversa em que foram
feitas no método <code>up</code>. O exemplo na seção <code>reversible</code> é equivalente a:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:distributors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:zipcode</span>
    <span class="k">end</span>

    <span class="c1"># add a CHECK constraint</span>
    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      ALTER TABLE distributors
        ADD CONSTRAINT zipchk
        CHECK (char_length(zipcode) = 5);
</span><span class="no">    SQL</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:email_address</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email_address</span><span class="p">,</span> <span class="ss">:email</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span>

    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      ALTER TABLE distributors
        DROP CONSTRAINT zipchk
</span><span class="no">    SQL</span>

    <span class="n">drop_table</span> <span class="ss">:distributors</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-19b9b250844677d3c07e0c79d9fbdef4">class ExampleMigration &lt; ActiveRecord::Migration[7.0]
  def up
    create_table :distributors do |t|
      t.string :zipcode
    end

    # add a CHECK constraint
    execute &lt;&lt;-SQL
      ALTER TABLE distributors
        ADD CONSTRAINT zipchk
        CHECK (char_length(zipcode) = 5);
    SQL

    add_column :users, :home_page_url, :string
    rename_column :users, :email, :email_address
  end

  def down
    rename_column :users, :email_address, :email
    remove_column :users, :home_page_url

    execute &lt;&lt;-SQL
      ALTER TABLE distributors
        DROP CONSTRAINT zipchk
    SQL

    drop_table :distributors
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-19b9b250844677d3c07e0c79d9fbdef4">Copiar</button>
</div>
<p>Se sua <em>migration</em> é irreversível, você deve dar <code>raise</code> num
<code>ActiveRecord::IrreversibleMigration</code> do seu método <code>down</code>. Se alguém tentar
reveter sua <em>migration</em>, uma mensagem de erro será exibida dizendo que isso
não pode ser feito.</p><h4 id="revertendo-migrations-anteriores"><a class="anchorlink" href="#revertendo-migrations-anteriores">3.12 Revertendo <em>Migrations</em> Anteriores</a></h4><p>Você pode usar a capacidade do Active Record de reverter <em>migrations</em> usando o método <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Migration.html#method-i-revert"><code>revert</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"20121212123456_example_migration"</span>

<span class="k">class</span> <span class="nc">FixupExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">revert</span> <span class="no">ExampleMigration</span>

    <span class="n">create_table</span><span class="p">(</span><span class="ss">:apples</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:variety</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-517beb19d896f0504eb1ecd8e6bdc4b1">require_relative "20121212123456_example_migration"

class FixupExampleMigration &lt; ActiveRecord::Migration[7.0]
  def change
    revert ExampleMigration

    create_table(:apples) do |t|
      t.string :variety
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-517beb19d896f0504eb1ecd8e6bdc4b1">Copiar</button>
</div>
<p>O método <code>revert</code> também aceita um bloco de instruções para reverter.
Isso pode ser útil para reverter partes selecionadas de <em>migrations</em> anteriores.
Por exemplo, vamos imaginar que <code>ExampleMigration</code> seja executado e
mais tarde decidimos que seria melhor usar as validações do Active Record,
no lugar da <em>constraint</em> (restrição) <code>CHECK</code>, para verificar o CEP.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">DontUseConstraintForZipcodeValidationMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">revert</span> <span class="k">do</span>
      <span class="c1"># copy-pasted code from ExampleMigration</span>
      <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
          <span class="c1"># add a CHECK constraint</span>
          <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
            ALTER TABLE distributors
              ADD CONSTRAINT zipchk
                CHECK (char_length(zipcode) = 5);
</span><span class="no">          SQL</span>
        <span class="k">end</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
          <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
            ALTER TABLE distributors
              DROP CONSTRAINT zipchk
</span><span class="no">          SQL</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># The rest of the migration was ok</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-43b2004b3045c5deb0734675d70cf3e8">class DontUseConstraintForZipcodeValidationMigration &lt; ActiveRecord::Migration[7.0]
  def change
    revert do
      # copy-pasted code from ExampleMigration
      reversible do |dir|
        dir.up do
          # add a CHECK constraint
          execute &lt;&lt;-SQL
            ALTER TABLE distributors
              ADD CONSTRAINT zipchk
                CHECK (char_length(zipcode) = 5);
          SQL
        end
        dir.down do
          execute &lt;&lt;-SQL
            ALTER TABLE distributors
              DROP CONSTRAINT zipchk
          SQL
        end
      end

      # The rest of the migration was ok
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-43b2004b3045c5deb0734675d70cf3e8">Copiar</button>
</div>
<p>A mesma <em>migration</em> também poderia ter sido escrita sem o uso do <code>revert</code>
mas isso envolveria mais algumas etapas: reverter a ordem
de <code>create_table</code> e <code>reversible</code>, substituindo <code>create_table</code>
por <code>drop_table</code>, e finalmente mudando <code>up</code> para <code>down</code> e vice-versa.
Tudo isso é resolvido por <code>revert</code>.</p><h3 id="executando-as-migrations"><a class="anchorlink" href="#executando-as-migrations">4 Executando as <em>Migrations</em></a></h3><p>O Rails fornece uma série de comandos para executar certos conjuntos de
<em>migrations</em>.</p><p>O primeiro comando rails relacionado à <em>migration</em> (migração) que você
utilizará, provavelmente será <code>bin/rails db:migrate</code>. Basicamente, ele executa o
método <code>change</code> ou <code>up</code> para todas as <em>migrations</em> que ainda não foram
executadas até o momento. Se não houver nenhuma dessas <em>migrations</em>, nada é executado. O
comando executará as <em>migrations</em> com base na ordem da data da <em>migration</em>.</p><p>Observe que ao executar o comando <code>db:migrate</code> também é chamado o comando
<code>db:schema:dump</code>, que atualizará seu arquivo <code>db/schema.rb</code> para corresponder a
estrutura do seu banco de dados.</p><p>Se você especificar uma versão alvo, o <em>Active Record</em> executará as <em>migrations</em>
necessárias (<code>change</code>, <code>up</code>, <code>down</code>) até atingir a versão especificada. A versão
é o prefixo numérico do nome do arquivo da <em>migration</em>. Por exemplo, para migrar
para a versão 20080906120000 execute:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate <span class="nv">VERSION</span><span class="o">=</span>20080906120000
</code></pre>
<textarea class="clipboard-content" id="clipboard-8c7caadad74ddbb5de5310634c11d588">bin/rails db:migrate VERSION=20080906120000
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8c7caadad74ddbb5de5310634c11d588">Copiar</button>
</div>
<p>Se a versão 20080906120000 for maior que a versão atual (ou seja, está migrando
para cima), será executado o método <code>change</code> (ou <code>up</code>) em todas as <em>migrations</em>
até a 20080906120000 (incluindo ela na execução) e não será executada nenhuma <em>migration</em>
posterior. Se estiver migrando para baixo, será executado o método <code>down</code> em
todas as <em>migrations</em> até a 20080906120000, não incluindo ela na execução.</p><h4 id="revertendo-a-migration"><a class="anchorlink" href="#revertendo-a-migration">4.1 Revertendo a <em>Migration</em></a></h4><p>Uma tarefa comum é reverter a última <em>migration</em>. Por exemplo, se você cometeu
um erro e deseja corrigí-lo. Ao invés de rastrear o número da versão associada
à <em>migration</em> anterior, você pode executar:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:rollback
</code></pre>
<textarea class="clipboard-content" id="clipboard-84aefdb68e8f0da912be94941eb8e0cc">bin/rails db:rollback
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-84aefdb68e8f0da912be94941eb8e0cc">Copiar</button>
</div>
<p>Isso reverterá a <em>migration</em> mais recente, seja revertendo o método <code>change</code> ou
executando o método <code>down</code>. Se precisar desfazer várias <em>migrations</em>, você pode
passar um parâmetro <code>STEP</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:rollback <span class="nv">STEP</span><span class="o">=</span>3
</code></pre>
<textarea class="clipboard-content" id="clipboard-d3e31025e306f1d88ec9702241012fbc">bin/rails db:rollback STEP=3
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d3e31025e306f1d88ec9702241012fbc">Copiar</button>
</div>
<p>vai reverter as últimas 3 <em>migrations</em>.</p><p>O comando <code>db:migrate:redo</code> é um atalho para fazer um <em>rollback</em> e então refazer
uma <em>migration</em> de volta. Assim como o comando <code>db:rollback</code>, você pode utilizar
o parâmetro <code>STEP</code> se precisar voltar mais de uma versão, por exemplo:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate:redo <span class="nv">STEP</span><span class="o">=</span>3
</code></pre>
<textarea class="clipboard-content" id="clipboard-6cb40d0a4d38044e1860f33cb861412f">bin/rails db:migrate:redo STEP=3
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6cb40d0a4d38044e1860f33cb861412f">Copiar</button>
</div>
<p>Nenhum desses comandos do rails fazem nada do que você não pudesse fazer com o
<code>db:migrate</code>. Eles são apenas mais convenientes, já que você não precisa
especificar explicitamente a versão para a qual migrar.</p><h4 id="setup-do-banco-de-dados"><a class="anchorlink" href="#setup-do-banco-de-dados">4.2 Setup do Banco de Dados</a></h4><p>O comando <code>bin/rails db:setup</code> vai criar o banco de dados, carregar o <em>schema</em> e
inicializar com os dados iniciais.</p><h4 id="reinicializando-o-banco-de-dados"><a class="anchorlink" href="#reinicializando-o-banco-de-dados">4.3 Reinicializando o Banco de Dados</a></h4><p>O comando <code>bin/rails db:reset</code> vai eliminar o banco de dados e configurá-lo
novamente. Isso é funcionalmente equivalente ao comando <code>bin/rails db:drop db:setup</code>.</p><div class="note"><p>Isso não é o mesmo que executar todas as <em>migrations</em>. Ele usará apenas o
conteúdo do arquivo atual <code>db/schema.rb</code> ou <code>db/structure.sql</code>. Se uma
<em>migration</em> não pode ser revertida, o comando <code>bin/rails db:reset</code> pode não ser
útil. Para saber mais sobre como descartar o <code>schema</code>, consulte a seção <a href="#schema-dumping-e-voce">Schema
Dumping e Você</a>.</p></div><h4 id="executando-migrations-especificas"><a class="anchorlink" href="#executando-migrations-especificas">4.4 Executando <em>Migrations</em> Específicas</a></h4><p>Se você precisar executar uma <em>migration</em> específica para cima ou para baixo, os
comandos <code>db:migrate:up</code> e <code>db:migration:down</code> farão isso. Basta especificar a
versão correta e a <em>migration</em> correspondente terá o método <code>change</code>, <code>up</code> ou
<code>down</code> chamado, por exemplo:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate:up <span class="nv">VERSION</span><span class="o">=</span>20080906120000
</code></pre>
<textarea class="clipboard-content" id="clipboard-625d1c1e8a154d254ae400c6a2d632b6">bin/rails db:migrate:up VERSION=20080906120000
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-625d1c1e8a154d254ae400c6a2d632b6">Copiar</button>
</div>
<p>vai executar a <em>migration</em> 20080906120000 executando o método <code>change</code> (ou o
método <code>up</code>). Este comando verificará primeiro se a <em>migration</em> já foi realizada
e não fará nada se o <em>Active Record</em> entender que já foi executada.</p><h4 id="executando-migrations-em-ambientes-diferentes"><a class="anchorlink" href="#executando-migrations-em-ambientes-diferentes">4.5 Executando <em>Migrations</em> em Ambientes Diferentes</a></h4><p>Por padrão, ao rodar o <code>bin/rails db:migrate</code> ele será executado no ambiente
<code>development</code> (desenvolvimento). Para executar as <em>migrations</em> em outro
ambiente, você pode especificá-lo usando a variável de ambiente <code>RAILS_ENV</code>
enquanto executa o comando. Por exemplo, para executar as *migrations*no
ambiente <code>test</code> (teste), você pode executar:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span><span class="nb">test</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0653bf058f887362ace147e016a9f955">bin/rails db:migrate RAILS_ENV=test
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0653bf058f887362ace147e016a9f955">Copiar</button>
</div>
<h4 id="alterando-o-output-saida-de-migrations-em-execucao"><a class="anchorlink" href="#alterando-o-output-saida-de-migrations-em-execucao">4.6 Alterando o Output (Saída) de <em>Migrations</em> em Execução</a></h4><p>Por padrão, as <em>migrations</em> informam exatamente o que estão fazendo e o quanto
tempo levou.
Uma <em>migration</em> criando uma tabela e adicionando um índice pode produzir um
<em>output</em> como esse:</p><div class="code_container">
<pre><code class="highlight plaintext">==  CreateProducts: migrating =================================================
-- create_table(:products)
   -&gt; 0.0028s
==  CreateProducts: migrated (0.0028s) ========================================
</code></pre>
<textarea class="clipboard-content" id="clipboard-2052c696ca947b0f5f5fb434fce7b864">==  CreateProducts: migrating =================================================
-- create_table(:products)
   -&gt; 0.0028s
==  CreateProducts: migrated (0.0028s) ========================================
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2052c696ca947b0f5f5fb434fce7b864">Copiar</button>
</div>
<p>Vários métodos são fornecidos nas <em>migrations</em> que permitem que você controle
tudo isso:</p>
<table>
<thead>
<tr>
<th>Método</th>
<th>Objetivo</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Migration.html#method-i-suppress_messages"><code>suppress_messages</code></a></td>
<td>Pega um bloco como argumento e suprime qualquer <em>output</em> gerado pelo bloco.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Migration.html#method-i-say"><code>say</code></a></td>
<td>Pega um argumento de mensagem e o exibe como está. Um segundo argumento booleano pode ser passado para especificar se deve ser indentado ou não.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Migration.html#method-i-say_with_time"><code>say_with_time</code></a></td>
<td>Produz um texto junto com o tempo que levou para executar seu bloco. Se o bloco retornar um inteiro, ele assume que é o número de linhas afetadas.</td>
</tr>
</tbody>
</table>
<p>Por exemplo, esta <em>migration</em></p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">suppress_messages</span> <span class="k">do</span>
      <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">say</span> <span class="s2">"Created a table"</span>

    <span class="n">suppress_messages</span> <span class="p">{</span><span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:name</span><span class="p">}</span>
    <span class="n">say</span> <span class="s2">"and an index!"</span><span class="p">,</span> <span class="kp">true</span>

    <span class="n">say_with_time</span> <span class="s1">'Waiting for a while'</span> <span class="k">do</span>
      <span class="nb">sleep</span> <span class="mi">10</span>
      <span class="mi">250</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-49c2cefb8a93c5c42b527d147c8fb799">class CreateProducts &lt; ActiveRecord::Migration[7.0]
  def change
    suppress_messages do
      create_table :products do |t|
        t.string :name
        t.text :description
        t.timestamps
      end
    end

    say "Created a table"

    suppress_messages {add_index :products, :name}
    say "and an index!", true

    say_with_time 'Waiting for a while' do
      sleep 10
      250
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-49c2cefb8a93c5c42b527d147c8fb799">Copiar</button>
</div>
<p>gera o seguinte <em>output</em></p><div class="code_container">
<pre><code class="highlight plaintext">==  CreateProducts: migrating =================================================
-- Created a table
   -&gt; and an index!
-- Waiting for a while
   -&gt; 10.0013s
   -&gt; 250 rows
==  CreateProducts: migrated (10.0054s) =======================================
</code></pre>
<textarea class="clipboard-content" id="clipboard-47b2fcef8e374d31a15202bbf8fdccbf">==  CreateProducts: migrating =================================================
-- Created a table
   -&gt; and an index!
-- Waiting for a while
   -&gt; 10.0013s
   -&gt; 250 rows
==  CreateProducts: migrated (10.0054s) =======================================
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-47b2fcef8e374d31a15202bbf8fdccbf">Copiar</button>
</div>
<p>Se você deseja que o <em>Active Record</em> não produza nada, execute <code>bin/rails db:migrate
VERBOSE=false</code> e isso irá suprimir todos os <em>outputs</em></p><h3 id="mudando-migrations-existentes"><a class="anchorlink" href="#mudando-migrations-existentes">5 Mudando <em>Migrations</em> Existentes</a></h3><p>Ocasionalmente, você cometerá um erro ao escrever uma <em>migration</em>. Se você já executou a <em>migration</em>, você não pode editá-la e rodá-la novamente: o Rails assume que você já rodou a <em>migration</em>, então não irá fazer nada quando você executar o comando <code>bin/rails db:migrate</code>. Você deve reverter a <em>migration</em> (por exemplo com <code>bin/rails db:rollback</code>), editar a <em>migration</em>, e então rodar o comando <code>bin/rails db:migrate</code> para que a versão correta seja executada.</p><p>Em geral, a edição de <em>migrations</em> existentes não é uma boa ideia. Você criará trabalho extra para si mesmo e seus colegas de trabalho e causará dores de cabeça maiores se a versão existente da <em>migration</em> já tiver sido executada nas máquinas de produção.</p><p>Como alternativa, você deveria escrever uma nova <em>migration</em> que execute as mudanças necessárias. Editar uma <em>migration</em> recentemente gerada e que ainda não foi feito um <em>commit</em> para o <em>source control</em> (ou, de forma geral, que não foi propagada além de sua máquina de desenvolvimento) é relativamente inofensivo.</p><p>O método <code>revert</code> pode ajudar ao escrever uma nova <em>migration</em> para desfazer <em>migrations</em> anteriores no todo ou em partes (veja <a href="#revertendo-migrations-anteriores">Revertendo <em>Migrations</em> Anteriores</a> acima).</p><h3 id="schema-dumping-e-voce"><a class="anchorlink" href="#schema-dumping-e-voce">6 <em>Schema Dumping</em> e Você</a></h3><h4 id="para-que-servem-arquivos-de-schema-questionmark"><a class="anchorlink" href="#para-que-servem-arquivos-de-schema-questionmark">6.1 Para que servem arquivos de Schema?</a></h4><p><em>Migrations</em>, poderosas como podem ser, não são a fonte oficial para o <em>schema</em> do seu banco de dados. Seu banco de dados permanece sendo a fonte oficial. Por padrão, o Rails gera o arquivo <code>db/schema.rb</code> (um <a href="https://pt.wikipedia.org/wiki/Dump_de_banco_de_dados"><em>schema dump</em></a>), que tenta capturar o estado atual do <em>schema</em> do seu banco de dados.</p><p>Costuma ser mais rápido e menos suscetível a erros criar uma nova instância do banco de dados da sua aplicação caregando o arquivo de <em>schema</em> por meio do comando <code>bin/rails db:schema:load</code> ao invés de reexecutar todo o histórico de <em>migrations</em>.
<a href="#migrations-antigas"><em>Migrations</em> Antigas</a> podem falhar em sua execução se estas <em>migrations</em> usam dependências externas que estejam em constante mudança ou se dependem de um código de aplicação que evolui separadamente das suas <em>migrations</em>.</p><p>Arquivos de <em>schema</em> também são úteis se você deseja verificar rapidamente quais atributos um objeto do tipo <em>Active Record</em> possui. Essa informação não está no código do <em>model</em> e é frequentemente espalhada em diversas <em>migrations</em>, mas a informação é facilmente acessível no arquivo de <em>schema</em>.</p><h4 id="tipos-de-schema-dumps"><a class="anchorlink" href="#tipos-de-schema-dumps">6.2 Tipos de Schema Dumps</a></h4><p>O formato dos arquivos de <em>schema</em> gerados pelo Rails é controlado pela configuração <code>config.active_record.schema_format</code> em <code>config/application.rb</code>. Por padrão, o formato é <code>:ruby</code>, mas pode ser também alterado para <code>:sql</code>.</p><p>Se <code>:ruby</code> está selecionado, então o arquivo de <em>schema</em> é salvo em <code>db/schema.rb</code>. Se você analisar este arquivo perceberá que ele se parece muito com uma <em>migration</em> gigante.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span><span class="p">(</span><span class="ss">version: </span><span class="mi">2008_09_06_171750</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">create_table</span> <span class="s2">"authors"</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"name"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span>
  <span class="k">end</span>

  <span class="n">create_table</span> <span class="s2">"products"</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"name"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">text</span>     <span class="s2">"description"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"part_number"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8f722079e0b5b50880317ce21bbea419">ActiveRecord::Schema.define(version: 2008_09_06_171750) do
  create_table "authors", force: true do |t|
    t.string   "name"
    t.datetime "created_at"
    t.datetime "updated_at"
  end

  create_table "products", force: true do |t|
    t.string   "name"
    t.text     "description"
    t.datetime "created_at"
    t.datetime "updated_at"
    t.string   "part_number"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8f722079e0b5b50880317ce21bbea419">Copiar</button>
</div>
<p>De muitas maneiras é exatamente isso. Este arquivo é criado ao inspecionar o banco de dados, expressando sua estrutura através dos comandos <code>create_table</code>, <code>add_index</code>, e por aí vai.</p><p>O arquivo <code>db/schema.rb</code> não consegue expressar tudo o que o seu banco de dados suporta como <em>triggers</em>, <em>sequences</em>, <em>stored procedures</em>, etc. Enquanto outras <em>migrations</em> podem utilizar o comando <code>execute</code> para criar estruturas do banco de dados que não são suportadas pela DSL de <em>migrations</em> do Ruby, estas estruturas podem não ser possíveis de serem reconstituídas ao gerar um novo <em>schema</em> padrão. Se você estiver utilizando estes tipos de funcionalidades, você deve então alterar o formato do <em>schema</em> para <code>:sql</code> para conseguir obter um arquivo de <em>schema</em> mais preciso e que possa ser utilizado para criar novas instâncias do banco de dados.</p><p>Quando o formato do <em>schema</em> é definido como <code>:sql</code>, a estrutura do banco de dados será reproduzida utilizando uma ferramenta específica para o banco de dados sendo usado no arquivo <code>db/structure.sql</code>. Por exemplo, para o PostgreSQL, a ferramenta <code>pg_dump</code> é utilizada. Para MySQL e MariaDB, este arquivo irá conter a saída de <code>SHOW CREATE TABLE</code> para as tabelas do banco.</p><p>Para carregar o <em>schema</em> de <code>db/structure.sql</code>, execute <code>bin/rails db:schema:load</code>. O carregamento deste arquivo é realizado executando os comandos em SQL que ele contém. Por definição, isso irá criar uma cópia perfeita da estrutura do banco de dados.</p><h4 id="schema-dumps-e-o-controle-de-versao"><a class="anchorlink" href="#schema-dumps-e-o-controle-de-versao">6.3 Schema Dumps e o Controle de Versão</a></h4><p>Como os arquivos de <em>schema</em> são comumente utilizados para criar novos bancos de dados, é fortemente recomendado que você adicione seu arquivo de <em>schema</em> ao controle de versão.</p><p>Conflitos de <em>merge</em> podem acontecer no seu arquivo de <em>schema</em> quando duas <em>branches</em> o modificam. Para resolver estes conflitos execute <code>bin/rails db:migrate</code> para gerar novamente o arquivo de <em>schema</em>.</p><h3 id="active-record-e-integridade-referencial"><a class="anchorlink" href="#active-record-e-integridade-referencial">7 <em>Active Record</em> e Integridade Referencial</a></h3><p>A maneira do <em>Active Record</em> trabalhar presume que a inteligência pertence aos seus <em>models</em>, não ao banco de dados. Desta forma, funcionalidades como <em>triggers</em> ou <em>constraints</em>, que enviam um pouco desta inteligência de volta para o banco de dados, não são usadas com frequência.</p><p>Validações como <code>validates :foreign_key, uniqueness: true</code> são uma maneira pela qual os <em>models</em> podem impor integridade dos dados. A opção <code>:dependent</code> nas associações permite aos <em>models</em> destruir automaticamente objetos filhos quando o objeto pai é destruído. Como qualquer coisa que opera no nível da aplicação, estas validações não podem garantir integridade referencial e assim algumas pessoas as aprimoram com <a href="#foreign-keys-chaves-estrangeiras">vínculos de chaves estrangeiras</a> no banco de dados.</p><p>Embora o <em>Active Record</em> não forneça todas as ferramentas para trabalhar diretamente com estas funcionalidades, o método <code>execute</code> pode ser usado para executar SQL arbitrário.</p><h3 id="migracoes-e-dados-de-seed"><a class="anchorlink" href="#migracoes-e-dados-de-seed">8 Migrações e Dados de <em>Seed</em></a></h3><p>O propósito principal da funcionalidade de migração do Rails é enviar comandos que modificam o <em>schema</em> usando um processo consistente. Migrações também podem ser usadas para inserir ou modificar dados. Isto é útil em um banco de dados existente que não pode ser destruído e criado de novo, como por exemplo um banco de dados em produção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddInitialProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
      <span class="no">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Product #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"A product."</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="no">Product</span><span class="p">.</span><span class="nf">delete_all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-375c6c2d34b1b192bf40794c9ce8cc6b">class AddInitialProducts &lt; ActiveRecord::Migration[7.0]
  def up
    5.times do |i|
      Product.create(name: "Product ##{i}", description: "A product.")
    end
  end

  def down
    Product.delete_all
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-375c6c2d34b1b192bf40794c9ce8cc6b">Copiar</button>
</div>
<p>Para inserir dados depois que um banco de dados for criado, o Rails tem uma funcionalidade padrão de <em>seeds</em> que torna o processo rápido. Isto é especialmente útil ao recarregar o banco de dados com frequência nos ambientes de teste e desenvolvimento. Para começar a usar estafuncionalidade, preencha o arquivo <code>db/seeds.rb</code> com código Ruby, e execute <code>bin/rails db:seed</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
  <span class="no">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Product #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"A product."</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-86a0e3c589003bc0e14143d29568144c">5.times do |i|
  Product.create(name: "Product ##{i}", description: "A product.")
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-86a0e3c589003bc0e14143d29568144c">Copiar</button>
</div>
<p>Isto é, geralmente, uma maneira mais limpa para preparar o banco de dados de uma aplicação em branco.</p><h3 id="migrations-antigas"><a class="anchorlink" href="#migrations-antigas">9 <em>Migrations</em> Antigas</a></h3><p>Os arquivos <code>db/schema.rb</code> ou <code>db/structure.sql</code> refletem o estado atual do seu
banco de dados e são a fonte oficial para reconstruí-lo. Isto torna possível
excluir arquivos antigos de <em>migration</em>.</p><p>Quando você exclui arquivos de <em>migration</em> no diretório <code>db/migrate</code>, qualquer
ambiente no qual <code>bin/rails db:migrate</code> foi executado quando estes arquivos ainda
existiam irá manter uma referência às suas <em>timestamps</em> específicas dentro de uma
tabela interna do Rails chamada <code>schema_migrations</code>. Esta tabela é usada para manter
um acompanhamento de quais <em>migrations</em> foram executadas em um ambiente específico.</p><p>Se você executar o comando <code>bin/rails db:migrate:status</code>, que mostra o estado (<code>up</code> ou
<code>down</code>) de cada <em>migration</em>, você verá o texto <code>********** NO FILE **********</code>
próximo a cada arquivo de <em>migration</em> excluído que foi anteriormente executado
em um ambiente específico mas não se encontra mais no diretório <code>db/migrate/</code>.</p><p>Porém, há uma advertência. As tarefas <code>rake</code> para instalar <em>migrations</em> de <em>engines</em> são idempotentes. As <em>migrations</em> presentes na aplicação principal vindas de uma instalação anterior são ignoradas e as que faltam são copiadas com um novo carimbo de data/hora (<em>timestamp</em>). Se você excluiu as <em>migrations</em> de <em>engines</em> antigas e executou a tarefa de instalação novamente, você obteria novos arquivos com novos carimbos de data/hora e o comando <code>db: migrate</code> tentaria executá-las novamente.</p><p>Portanto, geralmente você deseja preservar as <em>migrations</em> provenientes de <em>engines</em>. Elas têm um comentário especial como este:</p><div class="code_container">
<pre><code class="highlight plaintext"># This migration comes from blorgh (originally 20210621082949)
</code></pre>
<textarea class="clipboard-content" id="clipboard-aeb7f2ec36ab7359a50404cd2fa2730e"># This migration comes from blorgh (originally 20210621082949)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-aeb7f2ec36ab7359a50404cd2fa2730e">Copiar</button>
</div>


        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua caso veja quaisquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
