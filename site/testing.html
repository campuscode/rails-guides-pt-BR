<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Testando Applicações Rails — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Testando Applicações Rails — Ruby on Rails Guides" />
  <meta name="description" content="Testando Applicações RailsEste guia cobre mecanismos nativos do Rails para testar suas aplicações.Após ler este guia, você saberá: A terminologia de testes. Como escrever testes unitários, funcionais, de integração e de sistema para a sua aplicação. Outras abordagens e plugins populares de testes." />
  <meta property="og:description" content="Testando Applicações RailsEste guia cobre mecanismos nativos do Rails para testar suas aplicações.Após ler este guia, você saberá: A terminologia de testes. Como escrever testes unitários, funcionais, de integração e de sistema para a sua aplicação. Outras abordagens e plugins populares de testes." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v6.1.4</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Testando Applicações Rails</h2><p>Este guia cobre mecanismos nativos do Rails para testar suas aplicações.</p><p>Após ler este guia, você saberá:</p>
<ul>
<li>A terminologia de testes.</li>
<li>Como escrever testes unitários, funcionais, de integração e de sistema para a sua aplicação.</li>
<li>Outras abordagens e plugins populares de testes.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#por-que-escrever-testes-para-a-sua-aplicacao-rails-questionmark">Por que escrever testes para a sua aplicação Rails?</a></li>
<li>
<a href="#introducao-a-testes">Introdução a testes</a>

<ul>
<li><a href="#configuracoes-para-testes-em-aplicacoes-rails">Configurações para testes em aplicações Rails</a></li>
<li><a href="#o-ambiente-de-teste">O Ambiente de Teste</a></li>
<li><a href="#rails-conhece-minitest">Rails conhece Minitest</a></li>
<li><a href="#assercoes-disponiveis">Asserções disponíveis</a></li>
<li><a href="#assercoes-especificas-do-rails">Asserções Específicas do Rails</a></li>
<li><a href="#uma-breve-nota-sobre-os-casos-de-testes">Uma breve nota sobre os Casos de Testes</a></li>
<li><a href="#o-teste-runner-do-rails">O <code>Teste Runner</code> do Rails</a></li>
</ul>
</li>
<li>
<a href="#testes-em-paralelo">Testes em Paralelo</a>

<ul>
<li><a href="#testes-em-paralelo-com-processos">Testes em Paralelo com Processos</a></li>
<li><a href="#testes-em-paralelo-com-threads">Testes em Paralelo com <em>Threads</em></a></li>
<li><a href="#testando-transacoes-em-paralelo">Testando Transações em Paralelo</a></li>
</ul>
</li>
<li>
<a href="#o-banco-de-dados-de-teste">O Banco de Dados de Teste</a>

<ul>
<li><a href="#mantendo-o-esquema-do-banco-de-dados-de-teste">Mantendo o esquema do banco de dados de teste</a></li>
<li><a href="#o-essencial-sobre-fixtures">O Essencial sobre <em>Fixtures</em></a></li>
</ul>
</li>
<li><a href="#testando-models">Testando <em>Models</em></a></li>
<li>
<a href="#fazendo-testes-de-sistema">Fazendo Testes de Sistema</a>

<ul>
<li><a href="#mudando-as-configuracoes-padrao">Mudando as Configurações Padrão</a></li>
<li><a href="#helper-de-capturas-de-tela"><em>Helper</em> de capturas de tela</a></li>
<li><a href="#implementando-um-teste-de-sistema">Implementando um Teste de Sistema</a></li>
</ul>
</li>
<li>
<a href="#integration-testing">Integration Testing</a>

<ul>
<li><a href="#helpers-available-for-integration-tests">Helpers Available for Integration Tests</a></li>
<li><a href="#implementing-an-integration-test">Implementing an integration test</a></li>
</ul>
</li>
<li>
<a href="#functional-tests-for-your-controllers">Functional Tests for Your Controllers</a>

<ul>
<li><a href="#what-to-include-in-your-functional-tests">What to include in your Functional Tests</a></li>
<li><a href="#available-request-types-for-functional-tests">Available Request Types for Functional Tests</a></li>
<li><a href="#testing-xhr-ajax-requests">Testing XHR (AJAX) requests</a></li>
<li><a href="#the-three-hashes-of-the-apocalypse">The Three Hashes of the Apocalypse</a></li>
<li><a href="#instance-variables-available">Instance Variables Available</a></li>
<li><a href="#setting-headers-and-cgi-variables">Setting Headers and CGI variables</a></li>
<li><a href="#testing-flash-notices">Testing <code>flash</code> notices</a></li>
<li><a href="#putting-it-together">Putting it together</a></li>
<li><a href="#test-helpers">Test helpers</a></li>
</ul>
</li>
<li><a href="#testando-rotas">Testando Rotas</a></li>
<li><a href="#testando-views">Testando <em>Views</em></a></li>
<li><a href="#testando-os-helpers">Testando os <em>Helpers</em></a></li>
<li>
<a href="#testing-your-mailers">Testing Your Mailers</a>

<ul>
<li><a href="#keeping-the-postman-in-check">Keeping the Postman in Check</a></li>
<li><a href="#unit-testing">Unit Testing</a></li>
<li><a href="#functional-and-system-testing">Functional and System Testing</a></li>
</ul>
</li>
<li>
<a href="#testando-os-jobs">Testando os <em>Jobs</em></a>

<ul>
<li><a href="#um-caso-de-teste-basico">Um Caso de Teste Básico</a></li>
<li><a href="#assercoes-personalizadas-e-testando-jobs-dentro-de-outros-componentes">Asserções Personalizadas e Testando Jobs dentro de Outros Componentes</a></li>
</ul>
</li>
<li>
<a href="#testing-action-cable">Testing Action Cable</a>

<ul>
<li><a href="#connection-test-case">Connection Test Case</a></li>
<li><a href="#channel-test-case">Channel Test Case</a></li>
<li><a href="#custom-assertions-and-testing-broadcasts-inside-other-components">Custom Assertions And Testing Broadcasts Inside Other Components</a></li>
</ul>
</li>
<li>
<a href="#recursos-adicionais-para-testes">Recursos Adicionais para Testes</a>

<ul>
<li><a href="#testando-codigo-dependente-de-data-horario">Testando Código Dependente de Data/Horário</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="por-que-escrever-testes-para-a-sua-aplicacao-rails-questionmark"><a class="anchorlink" href="#por-que-escrever-testes-para-a-sua-aplicacao-rails-questionmark">1 Por que escrever testes para a sua aplicação Rails?</a></h3><p>O Rails torna super fácil escrever seus testes. Ele começa produzindo um esqueleto de código de teste enquanto você cria seus <em>models</em> e <em>controllers</em>.</p><p>Ao rodar seus testes no Rails você pode garantir que seu código continua com a funcionalidade desejada mesmo após algumas grandes refatorações no código.</p><p>Os testes no Rails podem simular requisições no browser e com isso, você pode testar a resposta da sua aplicação sem ter que testar utilizando de fato seu o browser.</p><h3 id="introducao-a-testes"><a class="anchorlink" href="#introducao-a-testes">2 Introdução a testes</a></h3><p>O suporte a testes foi implantado no Rails desde os primórdios. Não foi uma epifania do tipo: "Vamos adicionar suporte para testes porque eles são novos e legais!"</p><h4 id="configuracoes-para-testes-em-aplicacoes-rails"><a class="anchorlink" href="#configuracoes-para-testes-em-aplicacoes-rails">2.1 Configurações para testes em aplicações Rails</a></h4><p>O Rails cria um diretório <code>test</code> para você logo que você cria um projeto Rails usando o comando <code>rails new</code> <em>nome_da_aplicacao</em>. Se você listar o conteúdo deste diretório, você verá:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-F</span> <span class="nb">test</span>
<span class="go">application_system_test_case.rb  controllers/                     helpers/                         mailers/                         system/
channels/                        fixtures/                        integration/                     models/                          test_helper.rb
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-73fd991e0f0f62bcdbc1490d1c3446ed">ls -F test
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-73fd991e0f0f62bcdbc1490d1c3446ed">Copiar</button>
</div>
<p>Os diretórios <code>helpers</code>, <code>mailers</code> e <code>models</code> são destinados a realizar os testes para <em>view helpers</em>, <em>mailers</em> e <em>models</em>, respectivamente. O diretório <code>channel</code> é destinado a realizar os testes para a conexão e canais do <em>ActionCable</em>. O diretório <code>controllers</code> se destina a realizar testes para os <em>controllers</em>, rotas e <em>views</em>. O diretório <code>integration</code> se destina a realizar testes de interação entre <em>controllers</em>.</p><p>O diretório <code>system</code> é destinado a realizar os testes do sistema, que são usados para testes completos da aplicação no browser. Os Testes de Sistema permitem você testar a aplicação do jeito que seu usuário experiência e ajuda você a testar seu JavaScript também.
Os Testes de sistemas herdam de Capybara e são executados em testes de <em>browser</em> para a sua aplicação</p><p><em>Fixtures</em> são um jeito de organizar dados de testes; ficam no diretório <code>fixtures</code></p><p>Um diretório <code>jobs</code> também será criado quando um teste associado é gerado.</p><p>O arquivo <code>test_helper.rb</code> é responsável por realizar as configurações padrão para seus testes.</p><p>O arquivo <code>application_system_test_case.rb</code> é responsável por realizar as configurações padrão para seus testes de sistema.</p><h4 id="o-ambiente-de-teste"><a class="anchorlink" href="#o-ambiente-de-teste">2.2 O Ambiente de Teste</a></h4><p>Por padrão, toda aplicação Rails tem três ambientes: desenvolvimento, teste e produção.</p><p>A configuração de cada ambiente pode ser modificada de forma semelhante. Neste caso, podemos modificar nosso ambiente de teste alterando as opções encontradas em <code>config/environments/test.rb</code>.</p><div class="note"><p>Seus testes são executados sob o comando <code>RAILS_ENV=test</code>.</p></div><h4 id="rails-conhece-minitest"><a class="anchorlink" href="#rails-conhece-minitest">2.3 Rails conhece Minitest</a></h4><p>Se você se lembra, nós usamos o comando <code>bin/rails generate model</code> no guia <a href="getting_started.html">Começando com Rails</a>. Nós criamos nosso primeiro model e, entre outras coisas, foi criado <a href="https://pt.wikipedia.org/wiki/Stub"><em>stub</em></a> de testes no diretório <code>test</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model article title:string body:text
<span class="c">...
</span><span class="go">create  app/models/article.rb
create  test/models/article_test.rb
create  test/fixtures/articles.yml
</span><span class="c">...
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-200587a123057521b15554be7264718f">bin/rails generate model article title:string body:text
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-200587a123057521b15554be7264718f">Copiar</button>
</div>
<p>O <em>stub</em> teste padrão em <code>test/models/article_test.rb</code> parece assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ArticleTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># test "the truth" do</span>
  <span class="c1">#   assert true</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2c449186bd7d36ee2fe6ebebce57d1c7">require "test_helper"

class ArticleTest &lt; ActiveSupport::TestCase
  # test "the truth" do
  #   assert true
  # end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2c449186bd7d36ee2fe6ebebce57d1c7">Copiar</button>
</div>
<p>Uma inspeção linha a linha desse arquivo ajudará você a se orientar a terminologia e código de testes no Rails.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ffde8386a7b798bdd17fbfc4056e788f">require "test_helper"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ffde8386a7b798bdd17fbfc4056e788f">Copiar</button>
</div>
<p>Por fazer <em>require</em> desse arquivo, <code>test_helper.rb</code> as configurações padrões para executar nossos testes são carregadas. Nós vamos incluir isso em todos os testes que escrevermos, então qualquer método adicionado a este arquivo vai estar disponível em todos os nossos testes.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ArticleTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1e4292f675ed6b2ac52b1feaca31b0c8">class ArticleTest &lt; ActiveSupport::TestCase
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1e4292f675ed6b2ac52b1feaca31b0c8">Copiar</button>
</div>
<p>A classe <code>ArticleTest</code> define um <em>test case</em> porque ela herda de <code>ActiveSupport::TestCase</code>. <code>ArticleTest</code> portanto tem todos os métodos disponíveis de <code>ActiveSupport::TestCase</code>. Mais pra frente nesse guia, nós vamos adicionar alguns dos métodos dados.</p><p>Qualquer método definido com uma classe herdada de <code>Minitest::Test</code> (que é uma superclasse de <code>ActiveSupport::TestCase</code>) que começa com <code>test_</code> é simplesmente chamada em um teste. Então, métodos definidos como <code>test_password</code> e <code>test_valid_password</code> são nomes de testes legais e serão executados automaticamente quando o caso de teste (<em>test_case</em>) é executado.</p><p>O Rails também adiciona um método <code>test</code> que leva um nome <em>test</em> e um bloco. Isso gera um teste normal <code>Minitest::Unit</code> com nomes de métodos prefixados com <code>test_</code>. Então você não precisa se preocupar com nomear os métodos, e você pode escrever algo assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"the truth"</span> <span class="k">do</span>
  <span class="n">assert</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-909c4f91373c944895b0990dc59b3448">test "the truth" do
  assert true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-909c4f91373c944895b0990dc59b3448">Copiar</button>
</div>
<p>Que é aproximadamente o mesmo que escrever isto:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">test_the_truth</span>
  <span class="n">assert</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0953069547e64baef01128aa017acd7e">def test_the_truth
  assert true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0953069547e64baef01128aa017acd7e">Copiar</button>
</div>
<p>Apesar de você ainda poder usar definições comuns de métodos, usando o prefixo <code>test</code> permite você ter um teste mais legível.</p><div class="note"><p>O nome do método é gerado por alterar espaços com undescores(<em>_</em>). O resultado não precisa ser um identificador Ruby válido, embora o nome possa conter caracteres de pontuação, etc. Isso é porque em Ruby tecnicamente qualquer string pode ser o nome de um método. Isso pode requerer a chamada dos métodos <code>define_method</code> e <code>send</code> para funcionar corretamente, mas formalmente há uma pequena restrição no nome.</p></div><p>A seguir, vamos olhar para nossa primeira asserção:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assert</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-77f9479f6bee671280cbc87a61f0278f">assert true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-77f9479f6bee671280cbc87a61f0278f">Copiar</button>
</div>
<p>Uma asserção é uma linha de código que pode se tornar um objeto (ou expressão) para resultados esperados. Por exemplo, uma asserção pode checar se:</p>
<ul>
<li>Esse valor é igual a aquele valor?</li>
<li>Esse objeto é nulo?</li>
<li>Essa linha de código dispara uma exceção?</li>
<li>A senha do usuário é maior que 5 caracteres?</li>
</ul>
<p>Todo teste pode conter uma ou mais asserções, sem restrições em quantas asserções são permitidas. Apenas quando todas as asserções serem bem-sucedidas o teste vai passar.</p><h5 id="seu-primeiro-teste-que-falha"><a class="anchorlink" href="#seu-primeiro-teste-que-falha">2.3.1 Seu primeiro teste que falha</a></h5><p>Para ver como uma falha no teste é reportada, você pode adicionar um teste que falha no caso de teste do arquivo <code>article_test.rb</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should not save article without title"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">assert_not</span> <span class="n">article</span><span class="p">.</span><span class="nf">save</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f6505cff8e452687e2dafd5db5eb2c1b">test "should not save article without title" do
  article = Article.new
  assert_not article.save
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f6505cff8e452687e2dafd5db5eb2c1b">Copiar</button>
</div>
<p>Vamos executar o teste com esse caso de teste adicionado (onde 6 é o número da linha onde o teste é definido).</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/models/article_test.rb:6
<span class="go">Run options: --seed 44656

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
F

Failure:
</span><span class="gp">ArticleTest#</span>test_should_not_save_article_without_title <span class="o">[</span>/path/to/blog/test/models/article_test.rb:6]:
<span class="go">Expected true to be nil or false


rails test test/models/article_test.rb:6



Finished in 0.023918s, 41.8090 runs/s, 41.8090 assertions/s.

1 runs, 1 assertions, 1 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-8b5404efd8debabe2b002b829b235242">bin/rails test test/models/article_test.rb:6
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8b5404efd8debabe2b002b829b235242">Copiar</button>
</div>
<p>Na saída do teste, <code>F</code> significa uma falha. Você pode ver o <em>trace</em> correspondente mostrado abaixo de <code>Failure</code> junto com o nome do teste que está falhando. As próximas linhas contém as origens do erro seguido por uma mensagem que menciona o valor atual e o valor esperado pela asserção. A mensagem de asserção padrão provê informação o suficiente para ajudar a localizar o erro. Para fazer a asserção mais legível, toda asserção tem um parâmetro de mensagem opcional, como foi mostrado aqui:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should not save article without title"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">assert_not</span> <span class="n">article</span><span class="p">.</span><span class="nf">save</span><span class="p">,</span> <span class="s2">"Saved the article without a title"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d4cb1742eae89783d55580e6124ff488">test "should not save article without title" do
  article = Article.new
  assert_not article.save, "Saved the article without a title"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d4cb1742eae89783d55580e6124ff488">Copiar</button>
</div>
<p>A execução desse teste exibe uma mensagem de asserção mais amigável:</p><div class="code_container">
<pre><code class="highlight plaintext">Failure:
ArticleTest#test_should_not_save_article_without_title [/path/to/blog/test/models/article_test.rb:6]:
Saved the article without a title
</code></pre>
<textarea class="clipboard-content" id="clipboard-f85b9dc1ab53767f7e4d2378120458bd">Failure:
ArticleTest#test_should_not_save_article_without_title [/path/to/blog/test/models/article_test.rb:6]:
Saved the article without a title
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f85b9dc1ab53767f7e4d2378120458bd">Copiar</button>
</div>
<p>Agora para fazer esse teste passar nós podemos adicionar uma validação no nível do model para o campo <em>title</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e7ffa6d6b62f4fc903376e9ed16a7cc1">class Article &lt; ApplicationRecord
  validates :title, presence: true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e7ffa6d6b62f4fc903376e9ed16a7cc1">Copiar</button>
</div>
<p>Agora o teste deveria passar. Vamos verificar executando o teste novamente:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/models/article_test.rb:6
<span class="go">Run options: --seed 31252

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
</span><span class="c">.
</span><span class="go">
Finished in 0.027476s, 36.3952 runs/s, 36.3952 assertions/s.

1 runs, 1 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-b2f7a4406997776bd8be6b9e9914c1d0">bin/rails test test/models/article_test.rb:6
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b2f7a4406997776bd8be6b9e9914c1d0">Copiar</button>
</div>
<p>Agora, se você notou, nós escrevemos um teste que falha para uma funcionalidade desejada, então nós escrevemos um código básico que adiciona a funcionalidade e finalmente nós tivemos certeza que nosso testes passam. Essa abordagem em desenvolvimento de software é referida como
<a href="http://c2.com/cgi/wiki?TestDrivenDevelopment"><em>Test-Driven Development</em> (TDD)</a>.</p><h5 id="como-um-erro-se-parece"><a class="anchorlink" href="#como-um-erro-se-parece">2.3.2 Como um erro se parece</a></h5><p>Para ver como um erro é reportado, aqui está um teste contendo um erro:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should report error"</span> <span class="k">do</span>
  <span class="c1"># some_undefined_variable não está definida no caso de teste</span>
  <span class="n">some_undefined_variable</span>
  <span class="n">assert</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c742fadf4e53c153233d1f839cd4fde1">test "should report error" do
  # some_undefined_variable não está definida no caso de teste
  some_undefined_variable
  assert true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c742fadf4e53c153233d1f839cd4fde1">Copiar</button>
</div>
<p>Agora você pode ver mais saída no console ao rodar os testes:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/models/article_test.rb
<span class="go">Run options: --seed 1808

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
.E

Error:
</span><span class="gp">ArticleTest#</span>test_should_report_error:
<span class="gp">NameError: undefined local variable or method 'some_undefined_variable' for #</span>&lt;ArticleTest:0x007fee3aa71798&gt;
<span class="gp">    test/models/article_test.rb:11:in 'block in &lt;class:ArticleTest&gt;</span><span class="s1">'
</span><span class="go">

rails test test/models/article_test.rb:9



Finished in 0.040609s, 49.2500 runs/s, 24.6250 assertions/s.

2 runs, 1 assertions, 0 failures, 1 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-27d8754560171ac23a1ad8502b6b79ce">bin/rails test test/models/article_test.rb
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-27d8754560171ac23a1ad8502b6b79ce">Copiar</button>
</div>
<p>Observe o 'E' na saída. Isso significa um teste com erro.</p><div class="note"><p>A execução de cada método de teste para assim que qualquer erro ou uma falha de teste é encontrada, e a suíte de teste continua com o próximo método. Todos os métodos de testes são executados numa ordem aleatória. A <a href="configuring.html#configuring-active-support">opção <code>config.active_support.test_order</code></a> pode ser usada para configurar a ordem do teste.</p></div><p>Quando um teste falha você é apresentado ao <em>backtrace</em> correspondente. Por padrão
Rails filtra o <em>backtrace</em> e mostrará apenas linhas relevantes para sua
aplicação. Isso elimina qualquer reclamação do <em>framework</em> e isso  ajuda a focar no seu
código. No entanto existem situações que você quer ver o <em>backtrace</em>
completo. Coloque o argumento <code>-b</code> (ou <code>--backtrace</code>) para habilitar esse comportamento:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test</span> <span class="nt">-b</span> <span class="nb">test</span>/models/article_test.rb
</code></pre>
<textarea class="clipboard-content" id="clipboard-0cdbc12379fa94f94aa172aeacc63483">bin/rails test -b test/models/article_test.rb
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0cdbc12379fa94f94aa172aeacc63483">Copiar</button>
</div>
<p>Se nós queremos que este teste passe nós devemos modificar isto para usar <code>assert_raises</code> assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should report error"</span> <span class="k">do</span>
  <span class="c1"># some_undefined_variable não está definida no caso de teste</span>
  <span class="n">assert_raises</span><span class="p">(</span><span class="no">NameError</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">some_undefined_variable</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c634e936aef9ba54e2aa966f663bed0f">test "should report error" do
  # some_undefined_variable não está definida no caso de teste
  assert_raises(NameError) do
    some_undefined_variable
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c634e936aef9ba54e2aa966f663bed0f">Copiar</button>
</div>
<p>Este teste agora deveria passar.</p><h4 id="assercoes-disponiveis"><a class="anchorlink" href="#assercoes-disponiveis">2.4 Asserções disponíveis</a></h4><p>Por agora você viu pouco de algumas asserções que estão disponíveis. Asserções são as obreiras dos testes. Elas são as únicas que na verdade performam para checar se as coisas estão indo conforme o planejado.</p><p>Aqui está um resumo das asserções que você pode usar com
<a href="https://github.com/seattlerb/minitest"><code>Minitest</code></a>, a biblioteca padrão
usada pelo Rails. O parâmetro <code>[msg]</code> é uma mensagem opcional do tipo string que você pode
especificar para fazer as falhas do teste mais claras.</p>
<table>
<thead>
<tr>
<th>Asserção</th>
<th>Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>assert( test, [msg] )</code></td>
<td>Checa se <code>test</code> é verdadeiro.</td>
</tr>
<tr>
<td><code>assert_not( test, [msg] )</code></td>
<td>Checa se <code>test</code> é falso.</td>
</tr>
<tr>
<td><code>assert_equal( expected, actual, [msg] )</code></td>
<td>Checa se <code>expected == actual</code> é verdadeiro.</td>
</tr>
<tr>
<td><code>assert_not_equal( expected, actual, [msg] )</code></td>
<td>Checa se <code>expected != actual</code> é verdadeiro.</td>
</tr>
<tr>
<td><code>assert_same( expected, actual, [msg] )</code></td>
<td>Checa se <code>expected.equal?(actual)</code> é verdadeiro.</td>
</tr>
<tr>
<td><code>assert_not_same( expected, actual, [msg] )</code></td>
<td>Checa se <code>expected.equal?(actual)</code> é falso.</td>
</tr>
<tr>
<td><code>assert_nil( obj, [msg] )</code></td>
<td>Checa se <code>obj.nil?</code> é verdadeiro.</td>
</tr>
<tr>
<td><code>assert_not_nil( obj, [msg] )</code></td>
<td>Checa se <code>obj.nil?</code> é falso.</td>
</tr>
<tr>
<td><code>assert_empty( obj, [msg] )</code></td>
<td>Checa se <code>obj</code> is <code>empty?</code> (<code>obj</code> é vazio).</td>
</tr>
<tr>
<td><code>assert_not_empty( obj, [msg] )</code></td>
<td>Checa se <code>obj</code> is not <code>empty?</code> (<code>obj</code> não é vazio).</td>
</tr>
<tr>
<td><code>assert_match( regexp, string, [msg] )</code></td>
<td>Checa se uma string bate com a expressão regular dada.</td>
</tr>
<tr>
<td><code>assert_no_match( regexp, string, [msg] )</code></td>
<td>Checa se uma string não bate com a expressão regular dada.</td>
</tr>
<tr>
<td><code>assert_includes( collection, obj, [msg] )</code></td>
<td>Checa se <code>obj</code> está incluído na <code>collection</code>.</td>
</tr>
<tr>
<td><code>assert_not_includes( collection, obj, [msg] )</code></td>
<td>Checa se <code>obj</code> não está incluído na <code>collection</code>.</td>
</tr>
<tr>
<td><code>assert_in_delta( expected, actual, [delta], [msg] )</code></td>
<td>Checa se os números <code>expected</code> e atual estão aproximados com o <code>delta</code> de cada.</td>
</tr>
<tr>
<td><code>assert_not_in_delta( expected, actual, [delta], [msg] )</code></td>
<td>Checa se os números <code>expected</code> e atual não estão aproximados com o <code>delta</code> de cada.</td>
</tr>
<tr>
<td><code>assert_in_epsilon ( expected, actual, [epsilon], [msg] )</code></td>
<td>Checa se os números <code>expected</code> e <code>actual</code> tem um erro relativo menor que <code>epsilon</code>.</td>
</tr>
<tr>
<td><code>assert_not_in_epsilon ( expected, actual, [epsilon], [msg] )</code></td>
<td>Checa se os números <code>expected</code> e <code>actual</code> não tem um erro relativo menor que <code>epsilon</code>.</td>
</tr>
<tr>
<td><code>assert_throws( symbol, [msg] ) { block }</code></td>
<td>Checa se um dado <em>bloco</em> dispara um erro com o <code>symbol</code>
</td>
</tr>
<tr>
<td><code>assert_raises( exception1, exception2, ... ) { block }</code></td>
<td>Checa se um dado bloco dispara uma das exceções dadas.</td>
</tr>
<tr>
<td><code>assert_instance_of( class, obj, [msg] )</code></td>
<td>Checa se <code>obj</code> é uma instância de <code>class</code>.</td>
</tr>
<tr>
<td><code>assert_not_instance_of( class, obj, [msg] )</code></td>
<td>Checa se <code>obj</code> não é uma instância de <code>class</code>.</td>
</tr>
<tr>
<td><code>assert_kind_of( class, obj, [msg] )</code></td>
<td>Checa se <code>obj</code> é uma instância de <code>class</code> or uma descendente dela.</td>
</tr>
<tr>
<td><code>assert_not_kind_of( class, obj, [msg] )</code></td>
<td>Checa se <code>obj</code> não é uma instância de <code>class</code> e não é uma descendente dela.</td>
</tr>
<tr>
<td><code>assert_respond_to( obj, symbol, [msg] )</code></td>
<td>Checa se <code>obj</code> responde a <code>symbol</code>.</td>
</tr>
<tr>
<td><code>assert_not_respond_to( obj, symbol, [msg] )</code></td>
<td>Checa se <code>obj</code> não responde a <code>symbol</code>.</td>
</tr>
<tr>
<td><code>assert_operator( obj1, operator, [obj2], [msg] )</code></td>
<td>Checa se <code>obj1.operator(obj2)</code> é verdadeiro.</td>
</tr>
<tr>
<td><code>assert_not_operator( obj1, operator, [obj2], [msg] )</code></td>
<td>Checa se <code>obj1.operator(obj2)</code> é falso.</td>
</tr>
<tr>
<td><code>assert_predicate ( obj, predicate, [msg] )</code></td>
<td>Checa se <code>obj.predicate</code> é verdadeiro, ex: <code>assert_predicate str, :empty?</code>
</td>
</tr>
<tr>
<td><code>assert_not_predicate ( obj, predicate, [msg] )</code></td>
<td>Checa se <code>obj.predicate</code> é falso, ex: <code>assert_not_predicate str, :empty?</code>
</td>
</tr>
<tr>
<td><code>flunk( [msg] )</code></td>
<td>Checa que o teste falha. Isso é útil para marcar explicitamente que o teste não está finalizado ainda.</td>
</tr>
</tbody>
</table>
<p>As asserções acima são um subconjunto de asserções que <code>minitest</code> suporta. Para uma lista mais atualizada, por favor cheque
<a href="http://docs.seattlerb.org/minitest/">Minitest API documentation</a>, especificamente
<a href="http://docs.seattlerb.org/minitest/Minitest/Assertions.html"><code>Minitest::Assertions</code></a>.</p><p>Por conta da natureza modular do <code>framework</code> de testes, é possível criar suas próprias asserções. De fato, isso é exatamente o que Rails faz. Isso inclui algumas asserções especializadas para deixar sua vida mais fácil.</p><div class="note"><p>Criar suas próprias asserções é um tópico avançado que não cobriremos nesse tutorial.</p></div><h4 id="assercoes-especificas-do-rails"><a class="anchorlink" href="#assercoes-especificas-do-rails">2.5 Asserções Específicas do Rails</a></h4><p>Rails adiciona algumas asserções customizadas o framework <code>minitest</code>:</p>
<table>
<thead>
<tr>
<th>Asserção</th>
<th>Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_difference"><code>assert_difference(expressions, difference = 1, message = nil) {...}</code></a></td>
<td>Testa a diferença numérica entre o valor retornada da expressão como um resultado que contabilizado no bloco <em>yielded</em>.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_no_difference"><code>assert_no_difference(expressions, message = nil, &amp;block)</code></a></td>
<td>Checa se i resultado numérico da expressão calculada não é mudado antes e depois de invocar o bloco passado.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_changes"><code>assert_changes(expressions, message = nil, from:, to:, &amp;block)</code></a></td>
<td>Testa o resultado de uma expressão calculado é alterado depois de passar pelo <em>bloco</em>.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_no_changes"><code>assert_no_changes(expressions, message = nil, &amp;block)</code></a></td>
<td>Testa o resultado de uma expressão não é alterada depois de passar pelo <em>bloco</em>.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_nothing_raised"><code>assert_nothing_raised { block }</code></a></td>
<td>Checa se o bloco dado não dispara nenhuma exceção.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Assertions/RoutingAssertions.html#method-i-assert_recognizes"><code>assert_recognizes(expected_options, path, extras={}, message=nil)</code></a></td>
<td>Checa se o Rails reconhece a rota fornecida pelas <code>expected_options</code>.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Assertions/RoutingAssertions.html#method-i-assert_generates"><code>assert_generates(expected_path, options, defaults={}, extras = {}, message=nil)</code></a></td>
<td>O inverso de <code>assert_recognizes</code>. Checa se o Rails não reconhece a rota fornecida pelas <code>expected_options</code>.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Assertions/ResponseAssertions.html#method-i-assert_response"><code>assert_response(type, message = nil)</code></a></td>
<td>Checa se a resposta de uma requisição vem com um código de status específico. Você pode especificar <code>:success</code> para indicar 200-299, <code>:redirect</code> para indicar 300-399, <code>:missing</code> para indicar 404, ou <code>:error</code> para indicar o intervalo de 500-599. Você pode também passar o número explícito do status ou símbolo equivalente. Para mais informação, veja <a href="http://rubydoc.info/github/rack/rack/master/Rack/Utils#HTTP_STATUS_CODES-constant">lista completa de códigos de status</a> e como seus <a href="https://rubydoc.info/github/rack/rack/master/Rack/Utils#SYMBOL_TO_STATUS_CODE-constant">mapeamentos</a> funcionam.</td>
</tr>
<tr>
<td><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Assertions/ResponseAssertions.html#method-i-assert_redirected_to"><code>assert_redirected_to(options = {}, message=nil)</code></a></td>
<td>Checa se a resposta de uma requisição é redirecionada para uma URL que "bate" com as opções dadas. Você pode passar rotas nomeadas tais como <code>asset_redirected_to root_path</code> e objetos do Active Record como <code>assert_redirected_to @article</code>.</td>
</tr>
</tbody>
</table>
<p>Agora você verá alguns usos de algumas dessas asserções no próximo capítulo.</p><h4 id="uma-breve-nota-sobre-os-casos-de-testes"><a class="anchorlink" href="#uma-breve-nota-sobre-os-casos-de-testes">2.6 Uma breve nota sobre os Casos de Testes</a></h4><p>Todas as asserções tais como <code>assert_equal</code> são definidas em <code>Minitest::Assertions</code> são também disponíveis nas classes que nós usamos em nossos próprios casos de teste. De fato, Rails provê as seguintes classes que você pode herdar de:</p>
<ul>
<li><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/TestCase.html"><code>ActiveSupport::TestCase</code></a></li>
<li><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionMailer/TestCase.html"><code>ActionMailer::TestCase</code></a></li>
<li><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionView/TestCase.html"><code>ActionView::TestCase</code></a></li>
<li><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveJob/TestCase.html"><code>ActiveJob::TestCase</code></a></li>
<li><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/IntegrationTest.html"><code>ActionDispatch::IntegrationTest</code></a></li>
<li><a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/SystemTestCase.html"><code>ActionDispatch::SystemTestCase</code></a></li>
<li><a href="https://api.rubyonrails.org/v6.1.4/classes/Rails/Generators/TestCase.html"><code>Rails::Generators::TestCase</code></a></li>
</ul>
<p>Cada uma dessas asserções inclui <code>Minitest::Assertions</code>, nos permitindo usar todas as asserções básicas de nossos testes.</p><div class="note"><p>Para mais informações em <code>Minitest</code>, procure na sua <a href="http://docs.seattlerb.org/minitest">própria documentação</a>.</p></div><h4 id="o-teste-runner-do-rails"><a class="anchorlink" href="#o-teste-runner-do-rails">2.7 O <code>Teste Runner</code> do Rails</a></h4><p>Nós podemos executar todos os nossos testes de uma vez usando o comando <code>bin/rails test</code>.</p><p>Ou podemos executar um único arquivo de teste passando no comando <code>bin/rails test</code> o arquivo contendo os casos de testes.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/models/article_test.rb
<span class="go">Run options: --seed 1559

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
</span><span class="c">..
</span><span class="go">
Finished in 0.027034s, 73.9810 runs/s, 110.9715 assertions/s.

2 runs, 3 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-311b34dff0ff10cac660af94fb596476">bin/rails test test/models/article_test.rb
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-311b34dff0ff10cac660af94fb596476">Copiar</button>
</div>
<p>Isso vai executar todos os métodos do caso de teste.</p><p>Você também pode executar um método particular do caso de teste provendo a opção <code>-n</code> ou <code>--name</code> e o nome do método de teste.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/models/article_test.rb <span class="nt">-n</span> test_the_truth
<span class="go">Run options: -n test_the_truth --seed 43583

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
</span><span class="c">.
</span><span class="go">
Finished tests in 0.009064s, 110.3266 tests/s, 110.3266 assertions/s.

1 tests, 1 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-7ed0b93b1e302fc105365fceeb45dcd6">bin/rails test test/models/article_test.rb -n test_the_truth
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7ed0b93b1e302fc105365fceeb45dcd6">Copiar</button>
</div>
<p>Você pode também executar uma linha específica de um teste colocando o número da linha.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/models/article_test.rb:6 <span class="c"># run specific test and line</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3870ad161c62a16a897ddad3f744db07">bin/rails test test/models/article_test.rb:6 # run specific test and line
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3870ad161c62a16a897ddad3f744db07">Copiar</button>
</div>
<p>Você também pode executar um diretório inteiro de testes colocando o caminho do diretório.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/controllers <span class="c"># run all tests from specific directory</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d3d3a88988d9b5e2116f16a3ceb3a097">bin/rails test test/controllers # run all tests from specific directory
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d3d3a88988d9b5e2116f16a3ceb3a097">Copiar</button>
</div>
<p>O Teste Runner provê muitas feature como <em>failing fast</em>, adiando a saída do teste
no fim da execução do teste e assim por diante. Cheque a documentação do Test Runner da seguinte forma:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test</span> <span class="nt">-h</span>
<span class="go">Usage: rails test [options] [files or directories]

Você pode executar um único teste adicionando o número da linha para o arquivo:

    bin/rails test test/models/user_test.rb:27

Você pode executar múltiplos arquivos e pastas ao mesmo tempo:

    bin/rails test test/controllers test/integration/login_test.rb

Por padrão falhas de testes e erros são reportados numa única linha durante uma execução.

opções do minitest:
    -h, --help                       Mostra esse menu de ajuda.
</span><span class="gp">        --no-plugins                 Pula o plugin de auto-loading do minitest (ou coloque $</span>MT_NO_PLUGINS<span class="o">)</span><span class="nb">.</span>
<span class="go">    -s, --seed SEED                  Coloca _seed_ aleatório. Pode também ser colocado por variável de ambiente. Ex: SEED=n rake
    -v, --verbose                    Verboso. Mostra o progresso de arquivos enquanto estão processando.
    -n, --name PATTERN               Filtra a execução em  /regexp/ (Expressão regular) ou string.
        --exclude PATTERN            Exclui /regexp/ ou string da execução.

Extensões conhecidas: rails, pride
    -w, --warnings                   Executa com Warnings habilitados
    -e, --environment ENV            Executa os testes em um ambiente específico
    -b, --backtrace                  Mostra o _backtrace_ completo
    -d, --defer-output               Saída das falhas no teste e erros depois da execução de todos os testes
    -f, --fail-fast                  Aborta a execução dos testes na primeira falha ou no primeiro erro
    -c, --[no-]color                 Habilita cor ou não na saída
    -p, --pride                      Orgulho. Mostre o orgulho do seu teste!
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-b330a53097f8975067e4935ce23448e1">bin/rails test -h
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b330a53097f8975067e4935ce23448e1">Copiar</button>
</div>
<h3 id="testes-em-paralelo"><a class="anchorlink" href="#testes-em-paralelo">3 Testes em Paralelo</a></h3><p>Testes em paralelo permitem a paralelização da sua suíte de testes.
Ao passo que fazer <em>fork</em> de processos é o método padrão, também é suportado o uso de <em>threads</em>.
Rodar testes em paralelo reduz o tempo que leva para rodar sua suíte de testes inteira.</p><h4 id="testes-em-paralelo-com-processos"><a class="anchorlink" href="#testes-em-paralelo-com-processos">3.1 Testes em Paralelo com Processos</a></h4><p>O método padrão de paralelização é fazer <em>fork</em> de processos utilizando o sistema DRb do Ruby.
Os número de processos utilizados depende do número de <em>workers</em> fornecidos.
O número padrão é a quantidade de núcleos de seu computador, mas pode ser mudado para a quantidade
passada para o método <code>parallelize</code>.</p><p>Para habilitar a paralelização adicione o seguinte em seu arquivo <code>test_helper.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="n">parallelize</span><span class="p">(</span><span class="ss">workers: </span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bb097d6c895fbcb31d0649613068913a">class ActiveSupport::TestCase
  parallelize(workers: 2)
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb097d6c895fbcb31d0649613068913a">Copiar</button>
</div>
<p>O número de <em>workers</em> informado é o número de vezes que o processo sofrerá <em>fork</em>.
Voce pode querer paralelizar sua suíte de testes local de maneira diferente de seu <em>CI</em>,
por isso uma variável de ambiente está disponível para que seja possível mudar facilmente
o número de <em>workers</em> que uma execução dos testes deve usar:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nv">PARALLEL_WORKERS</span><span class="o">=</span>15 <span class="nb">bin/rails test</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-667646b441670c98d0844203c55013fa">PARALLEL_WORKERS=15 bin/rails test
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-667646b441670c98d0844203c55013fa">Copiar</button>
</div>
<p>Quando testes são paralelizados, o <em>Active Record</em> automaticamente lida com a criação dos bancos de dados e do carregamento do esquema (<em>schema</em>) no banco de dados de cada processo.
Os bancos de dados criados serão sufixados de acordo com a numeração do <em>worker</em>.
Por exemplo, se há 2 <em>workers</em>, os testes criarão os bancos <code>test-database-0</code> e <code>test-database-1</code> respectivamente.</p><p>Se o número de <em>workers</em> passado for 1 ou menos, os processos não sofrerão <em>fork</em> e os testes não serão paralelizados.
Além disso, o banco de original <code>test-database</code> será usado.</p><p>Dois <em>hooks</em> são disponibilizados, um que roda quando o processo sofre <em>fork</em> e outro quando o <em>fork</em> é encerrado.
Isso pode ser útil se sua aplicação usa múltiplos bancos de dados ou executa outras atividades que dependem da quantidade de <em>workers</em>.</p><p>O método <code>parallelize_setup</code> é chamado logo após o <em>fork</em> do processo.
O método <code>parallelize_teardown</code> é chamado no momento antes do processo ser finalizado.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="n">parallelize_setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">worker</span><span class="o">|</span>
    <span class="c1"># configuração dos bancos de dados</span>
  <span class="k">end</span>

  <span class="n">parallelize_teardown</span> <span class="k">do</span> <span class="o">|</span><span class="n">worker</span><span class="o">|</span>
    <span class="c1"># limpeza dos bancos de dados</span>
  <span class="k">end</span>

  <span class="n">parallelize</span><span class="p">(</span><span class="ss">workers: :number_of_processors</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fad464be0924db9ef5a8ea2f0c72cc6d">class ActiveSupport::TestCase
  parallelize_setup do |worker|
    # configuração dos bancos de dados
  end

  parallelize_teardown do |worker|
    # limpeza dos bancos de dados
  end

  parallelize(workers: :number_of_processors)
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fad464be0924db9ef5a8ea2f0c72cc6d">Copiar</button>
</div>
<p>Esses métodos não são necessários ou estão indisponíveis quando testes paralelos com <em>threads</em> são utilizados.</p><h4 id="testes-em-paralelo-com-threads"><a class="anchorlink" href="#testes-em-paralelo-com-threads">3.2 Testes em Paralelo com <em>Threads</em></a></h4><p>Se você preferir utilizar <em>threads</em> ou está utilizando JRuby, a opção de paralelizar com <em>threads</em> está disponível.
O paralelizador com <em>threads</em> utiliza por baixo dos panos a classe <code>Parallel::Executor</code> do <em>Minitest</em>.</p><p>Para mudar o método de paralelização para utilizar <em>threads</em> ao invés de <em>forks</em>, escreva o seguinte em seu <code>test_helper.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="n">parallelize</span><span class="p">(</span><span class="ss">workers: :number_of_processors</span><span class="p">,</span> <span class="ss">with: :threads</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fdad48285a0ec3993fefa6338ed26cfd">class ActiveSupport::TestCase
  parallelize(workers: :number_of_processors, with: :threads)
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fdad48285a0ec3993fefa6338ed26cfd">Copiar</button>
</div>
<p>Aplicações Rails geradas com JRuby ou TruffleRuby irão incluir automaticamente a opção <code>with: :threads</code>.</p><p>o número de <em>workers</em> passado para <code>parallelize</code> determina o número de <em>threads</em> que os testes irão utilizar.
Voce pode querer paralelizar sua suíte de testes de maneira diferente de seu <em>CI</em>,
por isso uma variável de ambiente está disponível para que seja possível mudar facilmente
o número de <em>workers</em> que uma execução dos testes deve usar:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nv">PARALLEL_WORKERS</span><span class="o">=</span>15 <span class="nb">bin/rails test</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-02b8529731352f0754e2751dfbe34dae">PARALLEL_WORKERS=15 bin/rails test
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-02b8529731352f0754e2751dfbe34dae">Copiar</button>
</div>
<h4 id="testando-transacoes-em-paralelo"><a class="anchorlink" href="#testando-transacoes-em-paralelo">3.3 Testando Transações em Paralelo</a></h4><p>O Rails automaticamente envolve todo caso de teste em uma transação do banco de dados, que é desfeita depois que o teste é concluído.
Isso faz com que os casos de teste sejam independentes uns dos outros e faz com que as mudanças no banco de dados sejam visíveis somente dentro daquele teste.</p><p>Quando você testa código que roda transações paralelas em <em>threads</em>,
as transações podem bloquear umas às outras, pois eles já estão aninhadas com a transação do caso de teste.</p><p>Você pode desabilitar transações na classe de um caso de teste, através da configuração <code>self.use_transactional_tests = false</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">WorkerTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">use_transactional_tests</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="nb">test</span> <span class="s2">"parallel transactions"</span> <span class="k">do</span>
    <span class="c1"># inicia threads que criam transações</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-23586457907c5019dd89c239e837d19e">class WorkerTest &lt; ActiveSupport::TestCase
  self.use_transactional_tests = false

  test "parallel transactions" do
    # inicia threads que criam transações
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-23586457907c5019dd89c239e837d19e">Copiar</button>
</div>
<div class="note"><p>Com os testes transacionais desligados, você terá que que limpar os dados de teste criados,
já que a as mudanças não são automaticamente desfeitas depois que o teste termina.</p></div><h3 id="o-banco-de-dados-de-teste"><a class="anchorlink" href="#o-banco-de-dados-de-teste">4 O Banco de Dados de Teste</a></h3><p>Quase tudo em uma aplicação Rails interage fortemente com um banco de dados e, como resultado, seus testes também precisarão interagir com um banco de dados.
Para escrever testes eficientes, você precisará entender como configurar e como popular esse banco de dados com dados de exemplo.</p><p>Por padrão, toda aplicação Rails tem 3 ambientes (<em>environments</em>): <code>development</code>, <code>test</code> e <code>production</code>.
O banco de dados de cada ambiente é configurado em <code>config/database.yml</code>.</p><p>Um banco de dados dedicado aos testes permite a configuração e a interação com os dados de teste separadamente.
Dessa forma, seus testes podem manipular dados de teste com confiança, sem se preocupar com os bancos de desenvolvimento ou produção.</p><h4 id="mantendo-o-esquema-do-banco-de-dados-de-teste"><a class="anchorlink" href="#mantendo-o-esquema-do-banco-de-dados-de-teste">4.1 Mantendo o esquema do banco de dados de teste</a></h4><p>Para rodar os testes, seu banco de dados precisará ter a estrutura atual.
A classe <em>test helper</em> checa se seu banco de teste tem alguma migração pendente.
Ela vai tentar carregar seu <code>db/schema.rb</code> ou <code>db/structure.sql</code> dentro do banco de teste.
Se alguma migração ainda estiver faltando, um erro vai ser levantado.
Isso indica que seu esquema (<em>schema</em>) ainda não foi totalmente migrado.
Rodar as migrações do banco de desenvolvimento (<code>bin/rails db:migrate</code>) irá atualizar o esquema para a última versão.</p><div class="note"><p>Se migrações que já existiam forem modificadas, o banco de dados de teste precisará ser refeito.
Isso pode ser feito executando <code>bin/rails db:test:prepare</code>.</p></div><h4 id="o-essencial-sobre-fixtures"><a class="anchorlink" href="#o-essencial-sobre-fixtures">4.2 O Essencial sobre <em>Fixtures</em></a></h4><p>Para fazer bons testes, você precisará pensar bastante em como irá preparar seus dados de teste.
No Rails, você pode lidar com isso definindo e customizando <em>fixtures</em>.
Você pode encontrar a documentação completa em <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/FixtureSet.html">documentação da API de Fixtures</a>.</p><h5 id="o-que-sao-fixtures-questionmark"><a class="anchorlink" href="#o-que-sao-fixtures-questionmark">4.2.1 O que são <em>Fixtures</em>?</a></h5><p><em>Fixtures</em> é uma apenas uma palavra bonita pra dados de teste.
<em>Fixtures</em> permitem você popular seu banco de teste com dados predefinidos antes dos testes rodarem.
<em>Fixtures</em> funcionam independentemente do banco de dados e são escritas em YAML.
Há um arquivo por <em>model</em>.</p><div class="note"><p><em>Fixtures</em> não foram feitas para criar todos os objetos que seus testes precisam e são melhor gerenciadas quando usadas somente para dados padrão que podem ser usados em casos comuns.</p></div><p>Você encontrará <em>fixtures</em> dentro da pasta <code>test/fixtures</code>.
Quando se roda <code>bin/rails generate model</code> para criar um <em>model</em>, o Rails automaticamente cria um esqueleto de <em>fixture</em> nessa pasta.</p><h5 id="yaml"><a class="anchorlink" href="#yaml">4.2.2 YAML</a></h5><p><em>Fixtures</em> escritas em YAML são um jeito amigável para humanos de escrever seus dados de teste.
Esse tipo de <em>fixture</em> vai ter a extensão <strong>.yml</strong> (como em <code>users.yml</code>).</p><p>Segue um exemplo de <em>fixture</em> em arquivo YAML:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="c1"># Vejam e contemplem! Eu sou um comentário em YAML!</span>
<span class="na">david</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">David Heinemeier Hansson</span>
  <span class="na">birthday</span><span class="pi">:</span> <span class="s">1979-10-15</span>
  <span class="na">profession</span><span class="pi">:</span> <span class="s">Systems development</span>

<span class="na">steve</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Steve Ross Kellock</span>
  <span class="na">birthday</span><span class="pi">:</span> <span class="s">1974-09-27</span>
  <span class="na">profession</span><span class="pi">:</span> <span class="s">guy with keyboard</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7e20bfe8d2eba6000f939bcaabbcb50f"># Vejam e contemplem! Eu sou um comentário em YAML!
david:
  name: David Heinemeier Hansson
  birthday: 1979-10-15
  profession: Systems development

steve:
  name: Steve Ross Kellock
  birthday: 1974-09-27
  profession: guy with keyboard
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7e20bfe8d2eba6000f939bcaabbcb50f">Copiar</button>
</div>
<p>Cada <em>fixture</em> recebe um nome, seguido de uma lista indentada de chaves/valores separados por dois pontos.
Registros são separados uns dos outros por uma linha em branco.
Você pode colocar comentários em uma arquivo <em>fixture</em> usando o caractere # na primeira coluna do texto.</p><p>Se você está trabalhando com <a href="/association_basics.html">associações</a>, você pode definir referências entre duas <em>fixtures</em> diferentes.
Aqui está um exemplo com uma associação <code>belongs_to</code>/<code>has_many</code>:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="c1"># fixtures/categories.yml</span>
<span class="na">about</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">About</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1af1235e57a34a7b1cf5b3c17960e96e"># fixtures/categories.yml
about:
  name: About
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1af1235e57a34a7b1cf5b3c17960e96e">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight yaml"><span class="c1"># fixtures/articles.yml</span>
<span class="na">first</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Welcome to Rails!</span>
  <span class="na">body</span><span class="pi">:</span> <span class="s">Hello world!</span>
  <span class="na">category</span><span class="pi">:</span> <span class="s">about</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-22c41064d5bfb8319a1b63d7bbfd2027"># fixtures/articles.yml
first:
  title: Welcome to Rails!
  body: Hello world!
  category: about
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-22c41064d5bfb8319a1b63d7bbfd2027">Copiar</button>
</div>
<p>Veja que a chave de <code>category</code> do artigo <code>first</code> encontrado em <code>fixtures/articles.yml</code> tem o valor <code>about</code>.
Isso diz ao Rails para carregar a categoria <code>about</code> encontrada em <code>fixtures/categories.yml</code>.</p><div class="note"><p>Para que associações façam referência umas as outras pelo nome, você pode usar o nome da <em>fixture</em> ao invés de especificar a chave <code>id:</code> nas <em>fixtures</em> associadas.
O Rails vai dar automaticamente uma chave para que haja consistência entre execuções dos testes.
Para mais informações sobre esse comportamento das associações, leia a página <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/FixtureSet.html">documentação da API de Fixtures</a>.</p></div><h5 id="erbzando-as-fixtures"><a class="anchorlink" href="#erbzando-as-fixtures">4.2.3 ERBzando as Fixtures</a></h5><p>A linguagem ERB permite que você coloque código Ruby dentro de templates.
As <em>fixtures</em> em formato YAML são pré-processadas com ERB antes do Rails carregar as <em>fixtures</em>.
Isso faz com que você possa usar Ruby para ajudar a gerar dados de teste.
Por exemplo, o código a seguir vai gerar mil usuários:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="mi">1000</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="cp">%&gt;</span>
user_<span class="cp">&lt;%=</span> <span class="n">n</span> <span class="cp">%&gt;</span>:
  username: <span class="cp">&lt;%=</span> <span class="s2">"user</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="cp">%&gt;</span>
  email: <span class="cp">&lt;%=</span> <span class="s2">"user</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-24354b1f52e1a99bfde4521aceb6d891">&lt;% 1000.times do |n| %&gt;
user_&lt;%= n %&gt;:
  username: &lt;%= "user#{n}" %&gt;
  email: &lt;%= "user#{n}@example.com" %&gt;
&lt;% end %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-24354b1f52e1a99bfde4521aceb6d891">Copiar</button>
</div>
<h5 id="fixtures-em-acao"><a class="anchorlink" href="#fixtures-em-acao">4.2.4 Fixtures em Ação</a></h5><p>O Rails automaticamente carrega todas as <em>fixtures</em> dentro do diretório <code>test/fixtures</code> por padrão.
O carregamento envolve três passos:</p>
<ol>
<li>Remover qualquer dado existente da tabela que corresponde a <em>fixture</em>
</li>
<li>Carregar os dados da <em>fixture</em> na tabela</li>
<li>Copiar os dados da <em>fixture</em> para dentro de um método caso você queira acessá-los diretamente</li>
</ol>
<div class="info"><p>Para remover todos os dados existentes, o Rails tenta desabilitar os <em>triggers</em> de integridade referencial (como chaves estrangeiras e <em>constraints</em>).
Se você estiver recebendo erros irritantes de permissão na hora de rodar os testes, garanta que o usuário do banco de dados tenha permissão para desabilitar esses <em>triggers</em> no ambiente de teste.
(No PostgreSQL, somente superusuários podem desativar todos os <em>triggers</em>.
Leia mais sobre as permissões do PostgreSQL <a href="http://blog.endpoint.com/2012/10/postgres-system-triggers-error.html">aqui</a>).</p></div><h5 id="fixtures-sao-objetos-do-active-record"><a class="anchorlink" href="#fixtures-sao-objetos-do-active-record">4.2.5 Fixtures são objetos do Active Record</a></h5><p><em>Fixtures</em> são instâncias de Active Record.
Como mencionado no ponto #3 acima, você pode acessar o objeto diretamente, já que ele está automaticamente acessível como um método cujo escopo é local para cada teste.
Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># isso retornará um objeto User para a fixture chamada david</span>
<span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>

<span class="c1"># isso retornará a propriedade id de david</span>
<span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">id</span>

<span class="c1"># também é possível acessar os métodos disponíveis dentro de User</span>
<span class="n">david</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>
<span class="n">david</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">david</span><span class="p">.</span><span class="nf">partner</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2eaf18968c2088f910e1f089f06aadaf"># isso retornará um objeto User para a fixture chamada david
users(:david)

# isso retornará a propriedade id de david
users(:david).id

# também é possível acessar os métodos disponíveis dentro de User
david = users(:david)
david.call(david.partner)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2eaf18968c2088f910e1f089f06aadaf">Copiar</button>
</div>
<p>Para acessar várias <em>fixtures</em> de uma vez, você pode passar uma lista de nomes de <em>fixtures</em>.
Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># isso retornará uma array contendo as fixtures david e steve</span>
<span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">,</span> <span class="ss">:steve</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7116e8fbaede8151eb5f0b284c2bdf3f"># isso retornará uma array contendo as fixtures david e steve
users(:david, :steve)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7116e8fbaede8151eb5f0b284c2bdf3f">Copiar</button>
</div>
<h3 id="testando-models"><a class="anchorlink" href="#testando-models">5 Testando <em>Models</em></a></h3><p>Testes de <em>model</em> são usados para testar os vários <em>models</em> de sua aplicação.</p><p>Os testes de <em>model</em> do Rails estão localizados em <code>test/models</code>.
O Rails disponibiliza um gerador (<em>generator</em>) para criar esqueletos de testes de <em>model</em>.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate test_unit:model article title:string body:text
<span class="go">create  test/models/article_test.rb
create  test/fixtures/articles.yml
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-c0efc741ce187d4ecbbd37c0a5df6aaa">bin/rails generate test_unit:model article title:string body:text
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c0efc741ce187d4ecbbd37c0a5df6aaa">Copiar</button>
</div>
<p>Testes de <em>model</em> não possuem uma superclasse como <code>ActionMailer::TestCase</code>.
Ao invés disso, eles herdam de <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/TestCase.html"><code>ActiveSupport::TestCase</code></a>.</p><h3 id="fazendo-testes-de-sistema"><a class="anchorlink" href="#fazendo-testes-de-sistema">6 Fazendo Testes de Sistema</a></h3><p>Testes de sistema permitem testar interações do usuário com sua aplicação, rodando os testes em um navegador web real ou <em>headless</em>.
Testes de sistema usam <em>Capybara</em> por debaixo dos panos.</p><p>Para criar testes de sistema do Rails, utilize o caminho <code>test/system</code> da sua aplicação.
O Rails também disponibiliza um <em>generator</em> para criar esqueletos de testes de sistema para você.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate system_test <span class="nb">users</span>
<span class="go">      invoke test_unit
      create test/system/users_test.rb
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-b3aa8839cd8031bdce5963a4a2fb45ca">bin/rails generate system_test users
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b3aa8839cd8031bdce5963a4a2fb45ca">Copiar</button>
</div>
<p>Aqui está como um teste de sistema recém gerado se parece:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"application_system_test_case"</span>

<span class="k">class</span> <span class="nc">UsersTest</span> <span class="o">&lt;</span> <span class="no">ApplicationSystemTestCase</span>
  <span class="c1"># test "visiting the index" do</span>
  <span class="c1">#   visit users_url</span>
  <span class="c1">#</span>
  <span class="c1">#   assert_selector "h1", text: "Users"</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c6401d774c62d28c1b3ed9a3a8f39c19">require "application_system_test_case"

class UsersTest &lt; ApplicationSystemTestCase
  # test "visiting the index" do
  #   visit users_url
  #
  #   assert_selector "h1", text: "Users"
  # end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c6401d774c62d28c1b3ed9a3a8f39c19">Copiar</button>
</div>
<p>Por padrão, testes de sistema utilizam o <em>driver</em> Selenium, executando o navegador Chrome, em uma tela de tamanho 1400x1400.
A próxima seção explica como mudar as configurações padrão.</p><h4 id="mudando-as-configuracoes-padrao"><a class="anchorlink" href="#mudando-as-configuracoes-padrao">6.1 Mudando as Configurações Padrão</a></h4><p>O Rails faz com que mudar as configurações padrão de testes de sistema seja muito simples.
Toda a preparação (<em>setup</em>) é abstraída, logo você pode focar mais em escrever testes.</p><p>Quando uma nova aplicação ou <em>scaffold</em> são gerados, o arquivo <code>application_system_test_case.rb</code> é criado na pasta de testes.
É nele em que todas as configurações de seus testes de sistema devem estão.</p><p>Se você quiser mudar as configurações padrão, você pode mudar quem "dirige" (<em>driver</em>) os testes de sistema.
Digamos que você quer mudar de Selenium para Poltergeist.
Primeiro adicione a gem <code>poltergeist</code> em seu <code>Gemfile</code>.
Depois, em seu <code>application_system_test_case.rb</code>, faça o seguinte:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>
<span class="nb">require</span> <span class="s2">"capybara/poltergeist"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:poltergeist</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bd5a52dfd76e964ba4de042bbbdf5ee6">require "test_helper"
require "capybara/poltergeist"

class ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase
  driven_by :poltergeist
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bd5a52dfd76e964ba4de042bbbdf5ee6">Copiar</button>
</div>
<p>O nome do <em>driver</em> é um argumento obrigatório de <code>driven_by</code>.
Os argumentos opcionais que podem ser passados para <code>driven_by</code> são <code>:using</code> para o navegador web (opção usada somente pelo <em>driver</em> Selenium), <code>:screen_size</code> para mudar o tamanho da tela e das capturas de tela e <code>:options</code> que serve para configurações específicas de cada <em>driver</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :firefox</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e2edefb03f570f61db3f5b4ad996fb2c">require "test_helper"

class ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase
  driven_by :selenium, using: :firefox
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e2edefb03f570f61db3f5b4ad996fb2c">Copiar</button>
</div>
<p>Se você quiser usar um navegador <em>headless</em>, você pode usar o Chrome <em>headless</em> ou Firefox <em>headless</em> passando <code>headless_chrome</code> ou <code>headless_firefox</code> para o argumento <code>:using</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :headless_chrome</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ed7180d2c2e8f5e08bae32f50761f13e">require "test_helper"

class ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase
  driven_by :selenium, using: :headless_chrome
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ed7180d2c2e8f5e08bae32f50761f13e">Copiar</button>
</div>
<p>Se a sua configuração do Capybara requer mais customização do que as fornecidas pelo Rails, opções adicionais podem ser adicionadas no arquivo <code>application_system_test_case.rb</code>.</p><p>Consulte a <a href="https://github.com/teamcapybara/capybara#setup">documentação do Capybara</a> para configurações adicionais.</p><h4 id="helper-de-capturas-de-tela"><a class="anchorlink" href="#helper-de-capturas-de-tela">6.2 <em>Helper</em> de capturas de tela</a></h4><p>O módulo <code>ScreenshotHelper</code> é um <em>helper</em> feito para fazer capturas de tela ("prints") dos seus testes.
Isso pode ser útil para ver o navegador web no momento em que um teste falha ou para debug.</p><p>Dois métodos são disponibilizados: <code>take_screenshot</code> e <code>take_failed_screenshot</code>.
No Rails, o método <code>take_failed_screenshot</code> é automaticamente incluído em <code>before_teardown</code>.</p><p>O <em>helper</em> <code>take_screenshot</code> pode ser chamado em qualquer lugar nos seus testes para fazer uma captura de tela do navegador.</p><h4 id="implementando-um-teste-de-sistema"><a class="anchorlink" href="#implementando-um-teste-de-sistema">6.3 Implementando um Teste de Sistema</a></h4><p>Agora vamos adicionar um teste de sistema em nossa aplicação de blog.
Vamos demonstrar como escrever testes de sistema, através da visita a página inicial da aplicação e da escrita de um novo artigo de blog.</p><p>Se você tive usado o <em>generator</em> de <em>scaffold</em>, então o esqueleto de um teste de sistema foi automaticamente criado para você.
Se você não utilizou o <em>generator</em> de <em>scaffold</em>, comece criando o esqueleto de um teste de sistema.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate system_test articles
</code></pre>
<textarea class="clipboard-content" id="clipboard-dd1409421bf7ea2c8a7dca6e8d86a39e">bin/rails generate system_test articles
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-dd1409421bf7ea2c8a7dca6e8d86a39e">Copiar</button>
</div>
<p>Isso deveria criar um arquivo de teste.
Se você utilizou o comando anterior, você deveria ver a seguinte saída:</p><div class="code_container">
<pre><code class="highlight plaintext">      invoke  test_unit
      create    test/system/articles_test.rb
</code></pre>
<textarea class="clipboard-content" id="clipboard-20c32277030223d278806cd900893900">      invoke  test_unit
      create    test/system/articles_test.rb
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-20c32277030223d278806cd900893900">Copiar</button>
</div>
<p>Agora vamos abrir o arquivo e escrever nossa primeira asserção:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"application_system_test_case"</span>

<span class="k">class</span> <span class="nc">ArticlesTest</span> <span class="o">&lt;</span> <span class="no">ApplicationSystemTestCase</span>
  <span class="nb">test</span> <span class="s2">"viewing the index"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">articles_path</span>
    <span class="n">assert_selector</span> <span class="s2">"h1"</span><span class="p">,</span> <span class="ss">text: </span><span class="s2">"Articles"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4253810ebae8dd9dad867ba2569de3cd">require "application_system_test_case"

class ArticlesTest &lt; ApplicationSystemTestCase
  test "viewing the index" do
    visit articles_path
    assert_selector "h1", text: "Articles"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4253810ebae8dd9dad867ba2569de3cd">Copiar</button>
</div>
<p>O teste deveria localizar que há um elemento <code>h1</code> na página inicial (<em>index</em>) de <em>articles</em> e passar.</p><p>Rode os testes de sistema.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test</span>:system
</code></pre>
<textarea class="clipboard-content" id="clipboard-46774238b0a449e7c10ec31b3e68b10d">bin/rails test:system
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-46774238b0a449e7c10ec31b3e68b10d">Copiar</button>
</div>
<div class="note"><p>Por padrão, rodar <code>bin/rails test</code> não irá rodar seus testes de sistema.
Certifique-se de rodar <code>bin/rails test:system</code> para que eles sejam executados.
Você também pode executar <code>bin/rails test:all</code> para rodar todos os testes, incluindo os de sistema.</p></div><h5 id="criando-um-teste-de-sistema-de-artigos"><a class="anchorlink" href="#criando-um-teste-de-sistema-de-artigos">6.3.1 Criando um Teste de Sistema de Artigos</a></h5><p>Agora vamos testar o fluxo de criação de um novo artigo para o nosso blog.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"creating an article"</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">articles_path</span>

  <span class="n">click_on</span> <span class="s2">"New Article"</span>

  <span class="n">fill_in</span> <span class="s2">"Title"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"Creating an Article"</span>
  <span class="n">fill_in</span> <span class="s2">"Body"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"Created this article successfully!"</span>

  <span class="n">click_on</span> <span class="s2">"Create Article"</span>

  <span class="n">assert_text</span> <span class="s2">"Creating an Article"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0f0a8a90a5df998defbe3174c3f1b81f">test "creating an article" do
  visit articles_path

  click_on "New Article"

  fill_in "Title", with: "Creating an Article"
  fill_in "Body", with: "Created this article successfully!"

  click_on "Create Article"

  assert_text "Creating an Article"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0f0a8a90a5df998defbe3174c3f1b81f">Copiar</button>
</div>
<p>O primeiro passo é chamar <code>visit articles_path</code>.
Isso faz com que o teste acesse a página inicial (<em>index</em>) de <em>articles</em>.</p><p>Depois a instrução <code>click_on "New Article"</code> vai achar o botão "New Article" na página inicial (<em>index</em>).
Isso vai redirecionar o navegador para <code>/articles/new</code>.</p><p>Após isso, o teste vai preencher o título (<em>title</em>) e o corpo (<em>body</em>) do artigo com o texto especificado.
Uma vez que os campos estão preenchidos, clica-se em "Create Article", que irá mandar uma requisição POST para criar o artigo no banco de dados.</p><p>Finalmente, nós vamos ser redirecionados de volta para a página inicial (<em>index</em>) e lá vamos assertar que o texto do título de nosso novo artigo está presente na página inicial.</p><h5 id="testando-em-diferentes-tamanhos-de-tela"><a class="anchorlink" href="#testando-em-diferentes-tamanhos-de-tela">6.3.2 Testando em diferentes tamanhos de tela</a></h5><p>Se você quiser testar em telas de tamanho mobile além do tamanho desktop, você pode criar outra classe que herda de <code>SystemTestCase</code> para usar em sua suite de testes.
Nesse exemplo, um arquivo chamado <code>mobile_system_test_case.rb</code> foi criado no caminho <code>/test</code> com a seguinte configuração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">MobileSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :chrome</span><span class="p">,</span> <span class="ss">screen_size: </span><span class="p">[</span><span class="mi">375</span><span class="p">,</span> <span class="mi">667</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a4b9bc0134ad1568e95bce20301d5b54">require "test_helper"

class MobileSystemTestCase &lt; ActionDispatch::SystemTestCase
  driven_by :selenium, using: :chrome, screen_size: [375, 667]
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a4b9bc0134ad1568e95bce20301d5b54">Copiar</button>
</div>
<p>Para usar essa configuração, crie um teste dentro de <code>test/system</code> que herda de <code>MobileSystemTestCase</code>.
Agora você pode testar seu app com diferentes configurações de tela.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"mobile_system_test_case"</span>

<span class="k">class</span> <span class="nc">PostsTest</span> <span class="o">&lt;</span> <span class="no">MobileSystemTestCase</span>

  <span class="nb">test</span> <span class="s2">"visiting the index"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">posts_url</span>
    <span class="n">assert_selector</span> <span class="s2">"h1"</span><span class="p">,</span> <span class="ss">text: </span><span class="s2">"Posts"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c71e377b16b8151eb4f35b1dbc5a3a0d">require "mobile_system_test_case"

class PostsTest &lt; MobileSystemTestCase

  test "visiting the index" do
    visit posts_url
    assert_selector "h1", text: "Posts"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c71e377b16b8151eb4f35b1dbc5a3a0d">Copiar</button>
</div>
<h5 id="indo-alem"><a class="anchorlink" href="#indo-alem">6.3.3 Indo Além</a></h5><p>A beleza dos testes de sistema é que, parecido com os testes de integração, eles também testam a interação do usuário com o <em>controller</em>, <em>model</em> e a <em>view</em>.
Porém, o teste de sistema é muito mais robusto e testa a aplicação como se uma pessoa de verdade estivesse usando.
Indo além, você pode testar qualquer coisa que os próprios usuários fariam em sua aplicação, como comentar, deletar artigos, publicar rascunhos e etc.</p><h3 id="integration-testing"><a class="anchorlink" href="#integration-testing">7 Integration Testing</a></h3><p>Integration tests are used to test how various parts of our application interact. They are generally used to test important workflows within our application.</p><p>For creating Rails integration tests, we use the <code>test/integration</code> directory for our application. Rails provides a generator to create an integration test skeleton for us.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate integration_test user_flows
<span class="go">      exists  test/integration/
      create  test/integration/user_flows_test.rb
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-b3001c712523cb4fe911c322b9b33ce9">bin/rails generate integration_test user_flows
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b3001c712523cb4fe911c322b9b33ce9">Copiar</button>
</div>
<p>Here's what a freshly generated integration test looks like:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserFlowsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># test "the truth" do</span>
  <span class="c1">#   assert true</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-aff5ce4bd4fe66c0bbc80af743e1588d">require "test_helper"

class UserFlowsTest &lt; ActionDispatch::IntegrationTest
  # test "the truth" do
  #   assert true
  # end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-aff5ce4bd4fe66c0bbc80af743e1588d">Copiar</button>
</div>
<p>Here the test is inheriting from <code>ActionDispatch::IntegrationTest</code>. This makes some additional helpers available for us to use in our integration tests.</p><h4 id="helpers-available-for-integration-tests"><a class="anchorlink" href="#helpers-available-for-integration-tests">7.1 Helpers Available for Integration Tests</a></h4><p>In addition to the standard testing helpers, inheriting from <code>ActionDispatch::IntegrationTest</code> comes with some additional helpers available when writing integration tests. Let's get briefly introduced to the three categories of helpers we get to choose from.</p><p>For dealing with the integration test runner, see <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Integration/Runner.html"><code>ActionDispatch::Integration::Runner</code></a>.</p><p>When performing requests, we will have <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Integration/RequestHelpers.html"><code>ActionDispatch::Integration::RequestHelpers</code></a> available for our use.</p><p>If we need to modify the session, or state of our integration test, take a look at <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Integration/Session.html"><code>ActionDispatch::Integration::Session</code></a> to help.</p><h4 id="implementing-an-integration-test"><a class="anchorlink" href="#implementing-an-integration-test">7.2 Implementing an integration test</a></h4><p>Let's add an integration test to our blog application. We'll start with a basic workflow of creating a new blog article, to verify that everything is working properly.</p><p>We'll start by generating our integration test skeleton:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate integration_test blog_flow
</code></pre>
<textarea class="clipboard-content" id="clipboard-03c0babac26b245c60cd86eadd81caf8">bin/rails generate integration_test blog_flow
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-03c0babac26b245c60cd86eadd81caf8">Copiar</button>
</div>
<p>It should have created a test file placeholder for us. With the output of the
previous command we should see:</p><div class="code_container">
<pre><code class="highlight plaintext">      invoke  test_unit
      create    test/integration/blog_flow_test.rb
</code></pre>
<textarea class="clipboard-content" id="clipboard-d52d81c75592651c0fedae78a4e6a3a1">      invoke  test_unit
      create    test/integration/blog_flow_test.rb
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d52d81c75592651c0fedae78a4e6a3a1">Copiar</button>
</div>
<p>Now let's open that file and write our first assertion:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">BlogFlowTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"can see the welcome page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s2">"/"</span>
    <span class="n">assert_select</span> <span class="s2">"h1"</span><span class="p">,</span> <span class="s2">"Welcome#index"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2bebdb112114d0785ac650f705baedce">require "test_helper"

class BlogFlowTest &lt; ActionDispatch::IntegrationTest
  test "can see the welcome page" do
    get "/"
    assert_select "h1", "Welcome#index"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2bebdb112114d0785ac650f705baedce">Copiar</button>
</div>
<p>We will take a look at <code>assert_select</code> to query the resulting HTML of a request in the "Testing Views" section below. It is used for testing the response of our request by asserting the presence of key HTML elements and their content.</p><p>When we visit our root path, we should see <code>welcome/index.html.erb</code> rendered for the view. So this assertion should pass.</p><h5 id="creating-articles-integration"><a class="anchorlink" href="#creating-articles-integration">7.2.1 Creating articles integration</a></h5><p>How about testing our ability to create a new article in our blog and see the resulting article.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"can create an article"</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"/articles/new"</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>

  <span class="n">post</span> <span class="s2">"/articles"</span><span class="p">,</span>
    <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"can create"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"article successfully."</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">assert_response</span> <span class="ss">:redirect</span>
  <span class="n">follow_redirect!</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="n">assert_select</span> <span class="s2">"p"</span><span class="p">,</span> <span class="s2">"Title:</span><span class="se">\n</span><span class="s2">  can create"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c68ae41aa3729c47145cb6e8a502eae5">test "can create an article" do
  get "/articles/new"
  assert_response :success

  post "/articles",
    params: { article: { title: "can create", body: "article successfully." } }
  assert_response :redirect
  follow_redirect!
  assert_response :success
  assert_select "p", "Title:\n  can create"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c68ae41aa3729c47145cb6e8a502eae5">Copiar</button>
</div>
<p>Let's break this test down so we can understand it.</p><p>We start by calling the <code>:new</code> action on our Articles controller. This response should be successful.</p><p>After this we make a post request to the <code>:create</code> action of our Articles controller:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">post</span> <span class="s2">"/articles"</span><span class="p">,</span>
  <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"can create"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"article successfully."</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">assert_response</span> <span class="ss">:redirect</span>
<span class="n">follow_redirect!</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e2e8d85db5ac2ea6f556a0bfeab0fe08">post "/articles",
  params: { article: { title: "can create", body: "article successfully." } }
assert_response :redirect
follow_redirect!
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e2e8d85db5ac2ea6f556a0bfeab0fe08">Copiar</button>
</div>
<p>The two lines following the request are to handle the redirect we setup when creating a new article.</p><div class="note"><p>Don't forget to call <code>follow_redirect!</code> if you plan to make subsequent requests after a redirect is made.</p></div><p>Finally we can assert that our response was successful and our new article is readable on the page.</p><h5 id="taking-it-further"><a class="anchorlink" href="#taking-it-further">7.2.2 Taking it further</a></h5><p>We were able to successfully test a very small workflow for visiting our blog and creating a new article. If we wanted to take this further we could add tests for commenting, removing articles, or editing comments. Integration tests are a great place to experiment with all kinds of use cases for our applications.</p><h3 id="functional-tests-for-your-controllers"><a class="anchorlink" href="#functional-tests-for-your-controllers">8 Functional Tests for Your Controllers</a></h3><p>In Rails, testing the various actions of a controller is a form of writing functional tests. Remember your controllers handle the incoming web requests to your application and eventually respond with a rendered view. When writing functional tests, you are testing how your actions handle the requests and the expected result or response, in some cases an HTML view.</p><h4 id="what-to-include-in-your-functional-tests"><a class="anchorlink" href="#what-to-include-in-your-functional-tests">8.1 What to include in your Functional Tests</a></h4><p>You should test for things such as:</p>
<ul>
<li>was the web request successful?</li>
<li>was the user redirected to the right page?</li>
<li>was the user successfully authenticated?</li>
<li>was the appropriate message displayed to the user in the view?</li>
<li>was the correct information displayed in the response?</li>
</ul>
<p>The easiest way to see functional tests in action is to generate a controller using the scaffold generator:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate scaffold_controller article title:string body:text
<span class="c">...
</span><span class="go">create  app/controllers/articles_controller.rb
</span><span class="c">...
</span><span class="go">invoke  test_unit
create    test/controllers/articles_controller_test.rb
</span><span class="c">...
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-e958c78c69c0f79efd6a90a10acf3139">bin/rails generate scaffold_controller article title:string body:text
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e958c78c69c0f79efd6a90a10acf3139">Copiar</button>
</div>
<p>This will generate the controller code and tests for an <code>Article</code> resource.
You can take a look at the file <code>articles_controller_test.rb</code> in the <code>test/controllers</code> directory.</p><p>If you already have a controller and just want to generate the test scaffold code for
each of the seven default actions, you can use the following command:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate test_unit:scaffold article
<span class="c">...
</span><span class="go">invoke  test_unit
create    test/controllers/articles_controller_test.rb
</span><span class="c">...
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-60908c44aedd657fcc3351dca3440f20">bin/rails generate test_unit:scaffold article
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-60908c44aedd657fcc3351dca3440f20">Copiar</button>
</div>
<p>Let's take a look at one such test, <code>test_should_get_index</code> from the file <code>articles_controller_test.rb</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># articles_controller_test.rb</span>
<span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"should get index"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">articles_url</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-dab90f78a88008fec4688be6afd09ed9"># articles_controller_test.rb
class ArticlesControllerTest &lt; ActionDispatch::IntegrationTest
  test "should get index" do
    get articles_url
    assert_response :success
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-dab90f78a88008fec4688be6afd09ed9">Copiar</button>
</div>
<p>In the <code>test_should_get_index</code> test, Rails simulates a request on the action called <code>index</code>, making sure the request was successful
and also ensuring that the right response body has been generated.</p><p>The <code>get</code> method kicks off the web request and populates the results into the <code>@response</code>. It can accept up to 6 arguments:</p>
<ul>
<li>The URI of the controller action you are requesting.
This can be in the form of a string or a route helper (e.g. <code>articles_url</code>).</li>
<li>
<code>params</code>: option with a hash of request parameters to pass into the action
(e.g. query string parameters or article variables).</li>
<li>
<code>headers</code>: for setting the headers that will be passed with the request.</li>
<li>
<code>env</code>: for customizing the request environment as needed.</li>
<li>
<code>xhr</code>: whether the request is Ajax request or not. Can be set to true for marking the request as Ajax.</li>
<li>
<code>as</code>: for encoding the request with different content type.</li>
</ul>
<p>All of these keyword arguments are optional.</p><p>Example: Calling the <code>:show</code> action for the first <code>Article</code>, passing in an <code>HTTP_REFERER</code> header:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">first</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"HTTP_REFERER"</span> <span class="o">=&gt;</span> <span class="s2">"http://example.com/home"</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7d28a25f38582794e7cb80b748ad5856">get article_url(Article.first), headers: { "HTTP_REFERER" =&gt; "http://example.com/home" }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7d28a25f38582794e7cb80b748ad5856">Copiar</button>
</div>
<p>Another example: Calling the <code>:update</code> action for the last <code>Article</code>, passing in new text for the <code>title</code> in <code>params</code>, as an Ajax request:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">xhr: </span><span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-163dc5bb4ea6c1804dfa8dd000748d61">patch article_url(Article.last), params: { article: { title: "updated" } }, xhr: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-163dc5bb4ea6c1804dfa8dd000748d61">Copiar</button>
</div>
<p>One more example: Calling the <code>:create</code> action to create a new article, passing in
text for the <code>title</code> in <code>params</code>, as JSON request:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">post</span> <span class="n">articles_path</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"Ahoy!"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-427db5558aca15b829b0c7a16e466976">post articles_path, params: { article: { title: "Ahoy!" } }, as: :json
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-427db5558aca15b829b0c7a16e466976">Copiar</button>
</div>
<div class="note"><p>If you try running <code>test_should_create_article</code> test from <code>articles_controller_test.rb</code> it will fail on account of the newly added model level validation and rightly so.</p></div><p>Let us modify <code>test_should_create_article</code> test in <code>articles_controller_test.rb</code> so that all our test pass:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should create article"</span> <span class="k">do</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">body: </span><span class="s2">"Rails is awesome!"</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Hello Rails"</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-afebc6eeb85bc9cbd8294fe96dde9501">test "should create article" do
  assert_difference("Article.count") do
    post articles_url, params: { article: { body: "Rails is awesome!", title: "Hello Rails" } }
  end

  assert_redirected_to article_path(Article.last)
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-afebc6eeb85bc9cbd8294fe96dde9501">Copiar</button>
</div>
<p>Now you can try running all the tests and they should pass.</p><div class="note"><p>If you followed the steps in the <a href="getting_started.html#basic-authentication">Basic Authentication</a> section, you'll need to add authorization to every request header to get all the tests passing:</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">body: </span><span class="s2">"Rails is awesome!"</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Hello Rails"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">HttpAuthentication</span><span class="o">::</span><span class="no">Basic</span><span class="p">.</span><span class="nf">encode_credentials</span><span class="p">(</span><span class="s2">"dhh"</span><span class="p">,</span> <span class="s2">"secret"</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d18d7bf74bd3500d60e1ca81877fd7bb">post articles_url, params: { article: { body: "Rails is awesome!", title: "Hello Rails" } }, headers: { Authorization: ActionController::HttpAuthentication::Basic.encode_credentials("dhh", "secret") }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d18d7bf74bd3500d60e1ca81877fd7bb">Copiar</button>
</div>
<h4 id="available-request-types-for-functional-tests"><a class="anchorlink" href="#available-request-types-for-functional-tests">8.2 Available Request Types for Functional Tests</a></h4><p>If you're familiar with the HTTP protocol, you'll know that <code>get</code> is a type of request. There are 6 request types supported in Rails functional tests:</p>
<ul>
<li><code>get</code></li>
<li><code>post</code></li>
<li><code>patch</code></li>
<li><code>put</code></li>
<li><code>head</code></li>
<li><code>delete</code></li>
</ul>
<p>All of request types have equivalent methods that you can use. In a typical C.R.U.D. application you'll be using <code>get</code>, <code>post</code>, <code>put</code>, and <code>delete</code> more often.</p><div class="note"><p>Functional tests do not verify whether the specified request type is accepted by the action, we're more concerned with the result. Request tests exist for this use case to make your tests more purposeful.</p></div><h4 id="testing-xhr-ajax-requests"><a class="anchorlink" href="#testing-xhr-ajax-requests">8.3 Testing XHR (AJAX) requests</a></h4><p>To test AJAX requests, you can specify the <code>xhr: true</code> option to <code>get</code>, <code>post</code>,
<code>patch</code>, <code>put</code>, and <code>delete</code> methods. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"ajax request"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="ss">xhr: </span><span class="kp">true</span>

  <span class="n">assert_equal</span> <span class="s2">"hello world"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">body</span>
  <span class="n">assert_equal</span> <span class="s2">"text/javascript"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">media_type</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-27447fee55fb110e62f2f1152c8d2bc9">test "ajax request" do
  article = articles(:one)
  get article_url(article), xhr: true

  assert_equal "hello world", @response.body
  assert_equal "text/javascript", @response.media_type
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-27447fee55fb110e62f2f1152c8d2bc9">Copiar</button>
</div>
<h4 id="the-three-hashes-of-the-apocalypse"><a class="anchorlink" href="#the-three-hashes-of-the-apocalypse">8.4 The Three Hashes of the Apocalypse</a></h4><p>After a request has been made and processed, you will have 3 Hash objects ready for use:</p>
<ul>
<li>
<code>cookies</code> - Any cookies that are set</li>
<li>
<code>flash</code> - Any objects living in the flash</li>
<li>
<code>session</code> - Any object living in session variables</li>
</ul>
<p>As is the case with normal Hash objects, you can access the values by referencing the keys by string. You can also reference them by symbol name. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">flash</span><span class="p">[</span><span class="s2">"gordon"</span><span class="p">]</span>               <span class="n">flash</span><span class="p">[</span><span class="ss">:gordon</span><span class="p">]</span>
<span class="n">session</span><span class="p">[</span><span class="s2">"shmession"</span><span class="p">]</span>          <span class="n">session</span><span class="p">[</span><span class="ss">:shmession</span><span class="p">]</span>
<span class="n">cookies</span><span class="p">[</span><span class="s2">"are_good_for_u"</span><span class="p">]</span>     <span class="n">cookies</span><span class="p">[</span><span class="ss">:are_good_for_u</span><span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a029a62432247caa09344957ca697373">flash["gordon"]               flash[:gordon]
session["shmession"]          session[:shmession]
cookies["are_good_for_u"]     cookies[:are_good_for_u]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a029a62432247caa09344957ca697373">Copiar</button>
</div>
<h4 id="instance-variables-available"><a class="anchorlink" href="#instance-variables-available">8.5 Instance Variables Available</a></h4><p>You also have access to three instance variables in your functional tests, after a request is made:</p>
<ul>
<li>
<code>@controller</code> - The controller processing the request</li>
<li>
<code>@request</code> - The request object</li>
<li>
<code>@response</code> - The response object</li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"should get index"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">articles_url</span>

    <span class="n">assert_equal</span> <span class="s2">"index"</span><span class="p">,</span> <span class="vi">@controller</span><span class="p">.</span><span class="nf">action_name</span>
    <span class="n">assert_equal</span> <span class="s2">"application/x-www-form-urlencoded"</span><span class="p">,</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">media_type</span>
    <span class="n">assert_match</span> <span class="s2">"Articles"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f2bdab8bd4743ddd03304959ab1bd09a">class ArticlesControllerTest &lt; ActionDispatch::IntegrationTest
  test "should get index" do
    get articles_url

    assert_equal "index", @controller.action_name
    assert_equal "application/x-www-form-urlencoded", @request.media_type
    assert_match "Articles", @response.body
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f2bdab8bd4743ddd03304959ab1bd09a">Copiar</button>
</div>
<h4 id="setting-headers-and-cgi-variables"><a class="anchorlink" href="#setting-headers-and-cgi-variables">8.6 Setting Headers and CGI variables</a></h4><p><a href="https://tools.ietf.org/search/rfc2616#section-5.3">HTTP headers</a>
and
<a href="https://tools.ietf.org/search/rfc3875#section-4.1">CGI variables</a>
can be passed as headers:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># setting an HTTP Header</span>
<span class="n">get</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"text/plain"</span> <span class="p">}</span> <span class="c1"># simulate the request with custom header</span>

<span class="c1"># setting a CGI variable</span>
<span class="n">get</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"HTTP_REFERER"</span><span class="p">:</span> <span class="s2">"http://example.com/home"</span> <span class="p">}</span> <span class="c1"># simulate the request with custom env variable</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5127be36c67cd03503f495fcb99a5f9b"># setting an HTTP Header
get articles_url, headers: { "Content-Type": "text/plain" } # simulate the request with custom header

# setting a CGI variable
get articles_url, headers: { "HTTP_REFERER": "http://example.com/home" } # simulate the request with custom env variable
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5127be36c67cd03503f495fcb99a5f9b">Copiar</button>
</div>
<h4 id="testing-flash-notices"><a class="anchorlink" href="#testing-flash-notices">8.7 Testing <code>flash</code> notices</a></h4><p>If you remember from earlier, one of the Three Hashes of the Apocalypse was <code>flash</code>.</p><p>We want to add a <code>flash</code> message to our blog application whenever someone
successfully creates a new Article.</p><p>Let's start by adding this assertion to our <code>test_should_create_article</code> test:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should create article"</span> <span class="k">do</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"Some title"</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
  <span class="n">assert_equal</span> <span class="s2">"Article was successfully created."</span><span class="p">,</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-132a98e4cfc7924a55dad8eb23aa3aeb">test "should create article" do
  assert_difference("Article.count") do
    post articles_url, params: { article: { title: "Some title" } }
  end

  assert_redirected_to article_path(Article.last)
  assert_equal "Article was successfully created.", flash[:notice]
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-132a98e4cfc7924a55dad8eb23aa3aeb">Copiar</button>
</div>
<p>If we run our test now, we should see a failure:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/controllers/articles_controller_test.rb <span class="nt">-n</span> test_should_create_article
<span class="go">Run options: -n test_should_create_article --seed 32266

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
F

Finished in 0.114870s, 8.7055 runs/s, 34.8220 assertions/s.

  1) Failure:
</span><span class="gp">ArticlesControllerTest#</span>test_should_create_article <span class="o">[</span>/test/controllers/articles_controller_test.rb:16]:
<span class="go">--- expected
+++ actual
@@ -1 +1 @@
-"Article was successfully created."
+nil

1 runs, 4 assertions, 1 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-0618652948ae22d44abb84ec4ee2f405">bin/rails test test/controllers/articles_controller_test.rb -n test_should_create_article
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0618652948ae22d44abb84ec4ee2f405">Copiar</button>
</div>
<p>Let's implement the flash message now in our controller. Our <code>:create</code> action should now look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">article_params</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Article was successfully created."</span>
    <span class="n">redirect_to</span> <span class="vi">@article</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="s2">"new"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7db316e0de9008ffb0cde1c3eaea83a3">def create
  @article = Article.new(article_params)

  if @article.save
    flash[:notice] = "Article was successfully created."
    redirect_to @article
  else
    render "new"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7db316e0de9008ffb0cde1c3eaea83a3">Copiar</button>
</div>
<p>Now if we run our tests, we should see it pass:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/controllers/articles_controller_test.rb <span class="nt">-n</span> test_should_create_article
<span class="go">Run options: -n test_should_create_article --seed 18981

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
</span><span class="c">.
</span><span class="go">
Finished in 0.081972s, 12.1993 runs/s, 48.7972 assertions/s.

1 runs, 4 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-2a850d2ddc5033288b1b49e396a516e4">bin/rails test test/controllers/articles_controller_test.rb -n test_should_create_article
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2a850d2ddc5033288b1b49e396a516e4">Copiar</button>
</div>
<h4 id="putting-it-together"><a class="anchorlink" href="#putting-it-together">8.8 Putting it together</a></h4><p>At this point our Articles controller tests the <code>:index</code> as well as <code>:new</code> and <code>:create</code> actions. What about dealing with existing data?</p><p>Let's write a test for the <code>:show</code> action:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should show article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6e9c7972df82d015a427bced461c3107">test "should show article" do
  article = articles(:one)
  get article_url(article)
  assert_response :success
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6e9c7972df82d015a427bced461c3107">Copiar</button>
</div>
<p>Remember from our discussion earlier on fixtures, the <code>articles()</code> method will give us access to our Articles fixtures.</p><p>How about deleting an existing Article?</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should destroy article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">delete</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">articles_path</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1a4412673ef3e17d17577a7a46eec211">test "should destroy article" do
  article = articles(:one)
  assert_difference("Article.count", -1) do
    delete article_url(article)
  end

  assert_redirected_to articles_path
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1a4412673ef3e17d17577a7a46eec211">Copiar</button>
</div>
<p>We can also add a test for updating an existing Article.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should update article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>

  <span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">}</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="c1"># Reload association to fetch updated data and assert that title is updated.</span>
  <span class="n">article</span><span class="p">.</span><span class="nf">reload</span>
  <span class="n">assert_equal</span> <span class="s2">"updated"</span><span class="p">,</span> <span class="n">article</span><span class="p">.</span><span class="nf">title</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cf966813a0f35c0f7f20f86356ce2eee">test "should update article" do
  article = articles(:one)

  patch article_url(article), params: { article: { title: "updated" } }

  assert_redirected_to article_path(article)
  # Reload association to fetch updated data and assert that title is updated.
  article.reload
  assert_equal "updated", article.title
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cf966813a0f35c0f7f20f86356ce2eee">Copiar</button>
</div>
<p>Notice we're starting to see some duplication in these three tests, they both access the same Article fixture data. We can D.R.Y. this up by using the <code>setup</code> and <code>teardown</code> methods provided by <code>ActiveSupport::Callbacks</code>.</p><p>Our test should now look something as what follows. Disregard the other tests for now, we're leaving them out for brevity.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># called before every single test</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># called after every single test</span>
  <span class="n">teardown</span> <span class="k">do</span>
    <span class="c1"># when controller is using cache it may be a good idea to reset it afterwards</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">clear</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show article"</span> <span class="k">do</span>
    <span class="c1"># Reuse the @article instance variable from setup</span>
    <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should destroy article"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">assert_redirected_to</span> <span class="n">articles_path</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should update article"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">}</span>

    <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="c1"># Reload association to fetch updated data and assert that title is updated.</span>
    <span class="vi">@article</span><span class="p">.</span><span class="nf">reload</span>
    <span class="n">assert_equal</span> <span class="s2">"updated"</span><span class="p">,</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">title</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ca7c7babcbd9097c04db394bcd4e475e">require "test_helper"

class ArticlesControllerTest &lt; ActionDispatch::IntegrationTest
  # called before every single test
  setup do
    @article = articles(:one)
  end

  # called after every single test
  teardown do
    # when controller is using cache it may be a good idea to reset it afterwards
    Rails.cache.clear
  end

  test "should show article" do
    # Reuse the @article instance variable from setup
    get article_url(@article)
    assert_response :success
  end

  test "should destroy article" do
    assert_difference("Article.count", -1) do
      delete article_url(@article)
    end

    assert_redirected_to articles_path
  end

  test "should update article" do
    patch article_url(@article), params: { article: { title: "updated" } }

    assert_redirected_to article_path(@article)
    # Reload association to fetch updated data and assert that title is updated.
    @article.reload
    assert_equal "updated", @article.title
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ca7c7babcbd9097c04db394bcd4e475e">Copiar</button>
</div>
<p>Similar to other callbacks in Rails, the <code>setup</code> and <code>teardown</code> methods can also be used by passing a block, lambda, or method name as a symbol to call.</p><h4 id="test-helpers"><a class="anchorlink" href="#test-helpers">8.9 Test helpers</a></h4><p>To avoid code duplication, you can add your own test helpers.
Sign in helper can be a good example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helper.rb</span>

<span class="k">module</span> <span class="nn">SignInHelper</span>
  <span class="k">def</span> <span class="nf">sign_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">post</span> <span class="n">sign_in_url</span><span class="p">(</span><span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="kp">include</span> <span class="no">SignInHelper</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ab3dc640c55eb8709fabd1913a9bbbf8"># test/test_helper.rb

module SignInHelper
  def sign_in_as(user)
    post sign_in_url(email: user.email, password: user.password)
  end
end

class ActionDispatch::IntegrationTest
  include SignInHelper
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ab3dc640c55eb8709fabd1913a9bbbf8">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProfileControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"should show profile"</span> <span class="k">do</span>
    <span class="c1"># helper is now reusable from any controller test case</span>
    <span class="n">sign_in_as</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>

    <span class="n">get</span> <span class="n">profile_url</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c29ff2e1c673ab4302d8567d6be9cd77">require "test_helper"

class ProfileControllerTest &lt; ActionDispatch::IntegrationTest

  test "should show profile" do
    # helper is now reusable from any controller test case
    sign_in_as users(:david)

    get profile_url
    assert_response :success
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c29ff2e1c673ab4302d8567d6be9cd77">Copiar</button>
</div>
<h5 id="using-separate-files"><a class="anchorlink" href="#using-separate-files">8.9.1 Using Separate Files</a></h5><p>If you find your helpers are cluttering <code>test_helper.rb</code>, you can extract them into separate files.
One good place to store them is <code>test/lib</code> or <code>test/test_helpers</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helpers/multiple_assertions.rb</span>
<span class="k">module</span> <span class="nn">MultipleAssertions</span>
  <span class="k">def</span> <span class="nf">assert_multiple_of_forty_two</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="n">assert</span> <span class="p">(</span><span class="n">number</span> <span class="o">%</span> <span class="mi">42</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">'expected #{number} to be a multiple of 42'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6ca58ff4d605cf9a16fceef778dfc706"># test/test_helpers/multiple_assertions.rb
module MultipleAssertions
  def assert_multiple_of_forty_two(number)
    assert (number % 42 == 0), 'expected #{number} to be a multiple of 42'
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6ca58ff4d605cf9a16fceef778dfc706">Copiar</button>
</div>
<p>These helpers can then be explicitly required as needed and included as needed</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>
<span class="nb">require</span> <span class="s2">"test_helpers/multiple_assertions"</span>

<span class="k">class</span> <span class="nc">NumberTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">MultipleAssertions</span>

  <span class="nb">test</span> <span class="s2">"420 is a multiple of forty two"</span> <span class="k">do</span>
    <span class="n">assert_multiple_of_forty_two</span> <span class="mi">420</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b6c5f6cee6c286ad8a24ac4ce3e9cbdb">require "test_helper"
require "test_helpers/multiple_assertions"

class NumberTest &lt; ActiveSupport::TestCase
  include MultipleAssertions

  test "420 is a multiple of forty two" do
    assert_multiple_of_forty_two 420
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b6c5f6cee6c286ad8a24ac4ce3e9cbdb">Copiar</button>
</div>
<p>or they can continue to be included directly into the relevant parent classes</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helper.rb</span>
<span class="nb">require</span> <span class="s2">"test_helpers/sign_in_helper"</span>

<span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="kp">include</span> <span class="no">SignInHelper</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f66661c11ce4eaf09d34ab41de6f3414"># test/test_helper.rb
require "test_helpers/sign_in_helper"

class ActionDispatch::IntegrationTest
  include SignInHelper
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f66661c11ce4eaf09d34ab41de6f3414">Copiar</button>
</div>
<h5 id="eagerly-requiring-helpers"><a class="anchorlink" href="#eagerly-requiring-helpers">8.9.2 Eagerly Requiring Helpers</a></h5><p>You may find it convenient to eagerly require helpers in <code>test_helper.rb</code> so your test files have implicit access to them. This can be accomplished using globbing, as follows</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helper.rb</span>
<span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span> <span class="s2">"test_helpers"</span><span class="p">,</span> <span class="s2">"**"</span><span class="p">,</span> <span class="s2">"*.rb"</span><span class="p">)].</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">require</span> <span class="n">file</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d40a9a02ab3a05c5357ec052f8a645af"># test/test_helper.rb
Dir[Rails.root.join("test", "test_helpers", "**", "*.rb")].each { |file| require file }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d40a9a02ab3a05c5357ec052f8a645af">Copiar</button>
</div>
<p>This has the downside of increasing the boot-up time, as opposed to manually requiring only the necessary files in your individual tests.</p><h3 id="testando-rotas"><a class="anchorlink" href="#testando-rotas">9 Testando Rotas</a></h3><p>Assim como tudo na sua aplicação Rails, você também pode testar suas rotas.
Testes de rotas são encontrados na pasta <code>test/controllers/</code> ou podem fazer parte de seus testes de <em>controller</em>.</p><div class="note"><p>Se sua aplicação tem rotas muito complexas, o Rails fornece vários <em>helpers</em> úteis para testá-las.</p></div><p>Para mais informações sobre as asserções de rotas disponíveis no Rails, veja a documentação da API de <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionDispatch/Assertions/RoutingAssertions.html"><code>ActionDispatch::Assertions::RoutingAssertions</code></a>.</p><h3 id="testando-views"><a class="anchorlink" href="#testando-views">10 Testando <em>Views</em></a></h3><p>Testar a resposta de sua requisição através da presença de elementos HTML chave e o seu conteúdo é uma forma comum de testar as <em>views</em> de sua aplicação. Assim como os testes de rota, testes de <em>view</em> ficam em <code>test/controllers/</code> ou são parte dos seus testes de <em>controller</em>.</p><p>O método <code>assert_select</code> permite que você faça consultas a elementos HTML da resposta, através de uma sintaxe simples, mas poderosa.</p><p>Há duas formas de <code>assert_select</code>:</p><p>A assinatura <code>assert_select(selector, [equality], [message])</code> garante que a condição de igualdade (<code>equality</code>) é atendida nos elementos selecionados através do seletor (<em>selector</em>).
O argumento <em>selector</em> pode ser um seletor CSS (String) ou uma expressão com valores de substituição (como <a href="https://github.com/rails/rails-dom-testing/blob/8f5acdfcb83a888c06592bad05475b7463998d1b/test/selector_assertions_test.rb#L124-L146">nesses testes</a>).</p><p>Já <code>assert_select(element, selector, [equality], [message])</code> garante que a condição de igualdade (<code>equality</code>) é atendida nos elementos selecionados através do seletor, começando no elemento <code>element</code> (instância de <code>Nokogiri::XML::Node</code> ou <code>Nokogiri::XML::NodeSet</code>) e seus descendentes.</p><p>Por exemplo, você poderia verificar o conteúdo do elemento <code>title</code> na sua resposta com:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Welcome to Rails Testing Guide"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3c1ef58d4e8914b544a28950d08bf9b8">assert_select "title", "Welcome to Rails Testing Guide"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3c1ef58d4e8914b544a28950d08bf9b8">Copiar</button>
</div>
<p>Você também pode usar blocos aninhados de <code>assert_select</code> para uma investigação mais profunda.</p><p>No exemplo a seguir, o <code>assert_select</code> mais interno de <code>li.menu_item</code> executa com a coleção de elementos selecionados pelo bloco mais externo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assert_select</span> <span class="s2">"ul.navigation"</span> <span class="k">do</span>
  <span class="n">assert_select</span> <span class="s2">"li.menu_item"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2a6abca53324e8014356707059f1ef7b">assert_select "ul.navigation" do
  assert_select "li.menu_item"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2a6abca53324e8014356707059f1ef7b">Copiar</button>
</div>
<p>Uma coleção de elementos pode ser iterada para que <code>assert_select</code> possa ser chamado individualmente para cada elemento.</p><p>Por exemplo, se a resposta contiver duas listas ordenadas, cada uma com quatro elementos, então os testes a seguir irão passar.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assert_select</span> <span class="s2">"ol"</span> <span class="k">do</span> <span class="o">|</span><span class="n">elements</span><span class="o">|</span>
  <span class="n">elements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">element</span><span class="o">|</span>
    <span class="n">assert_select</span> <span class="n">element</span><span class="p">,</span> <span class="s2">"li"</span><span class="p">,</span> <span class="mi">4</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">assert_select</span> <span class="s2">"ol"</span> <span class="k">do</span>
  <span class="n">assert_select</span> <span class="s2">"li"</span><span class="p">,</span> <span class="mi">8</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f713c48773494b09229eef2a1fac0954">assert_select "ol" do |elements|
  elements.each do |element|
    assert_select element, "li", 4
  end
end

assert_select "ol" do
  assert_select "li", 8
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f713c48773494b09229eef2a1fac0954">Copiar</button>
</div>
<p>Essa asserção é bastante poderosa. Para usos mais avançados, veja a sua <a href="https://github.com/rails/rails-dom-testing/blob/master/lib/rails/dom/testing/assertions/selector_assertions.rb">documentação</a>.</p><h5 id="assercoes-adicionais-para-views"><a class="anchorlink" href="#assercoes-adicionais-para-views">10.1 Asserções Adicionais para <em>Views</em></a></h5><p>Existem mais asserções que são usadas primariamente em testes de <em>views</em>:</p>
<table>
<thead>
<tr>
<th>Asserção</th>
<th>Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>assert_select_email</code></td>
<td>Permite fazer asserções no corpo de um email.</td>
</tr>
<tr>
<td><code>assert_select_encoded</code></td>
<td>Permite fazer asserções em HTML codificado. Isso é feito decodificando os conteúdos de cada elemento e então chamando o bloco com todos os elementos decodificados.</td>
</tr>
<tr>
<td>
<code>css_select(selector)</code> ou <code>css_select(element, selector)</code>
</td>
<td>Retorna uma <em>array</em> de todos os elementos selecionados por <em>selector</em>. Na segunda variante, o método primeiro seleciona o elemento base <code>element</code> e depois tenta selecionar os descendentes de <code>element</code> através de <code>selector</code>. Se não houver nenhum match, ambas variantes retornam <em>array</em> vazia.</td>
</tr>
</tbody>
</table>
<p>Aqui está um exemplo do uso de <code>assert_selected_email</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assert_select_email</span> <span class="k">do</span>
  <span class="n">assert_select</span> <span class="s2">"small"</span><span class="p">,</span> <span class="s2">"Please click the 'Unsubscribe' link if you want to opt-out."</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1b74fa3ddc6794847da47a22de5fc63e">assert_select_email do
  assert_select "small", "Please click the 'Unsubscribe' link if you want to opt-out."
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1b74fa3ddc6794847da47a22de5fc63e">Copiar</button>
</div>
<h3 id="testando-os-helpers"><a class="anchorlink" href="#testando-os-helpers">11 Testando os <em>Helpers</em></a></h3><p>Um <em>helper</em> é apenas um simples módulo onde você pode definir métodos
que estarão disponíveis nas suas <em>views</em>.</p><p>Para testar os <em>helpers</em>, tudo que você precisa fazer é verificar se a saída do
método <em>helper</em> é de fato a saída esperada. Testes relacionados aos <em>helpers</em> estão
localizados dentro da pasta <code>test/helpers</code>.</p><p>Dado o seguinte <em>helper</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">UsersHelper</span>
  <span class="k">def</span> <span class="nf">link_to_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">link_to</span> <span class="s2">"</span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">last_name</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-29884c2d42172f5d56db410f6c1f7b38">module UsersHelper
  def link_to_user(user)
    link_to "#{user.first_name} #{user.last_name}", user
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-29884c2d42172f5d56db410f6c1f7b38">Copiar</button>
</div>
<p>Nós podemos testar a saída desse método da seguinte maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersHelperTest</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"should return the user's full name"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>

    <span class="n">assert_dom_equal</span> <span class="sx">%{&lt;a href="/user/#{user.id}"&gt;David Heinemeier Hansson&lt;/a&gt;}</span><span class="p">,</span> <span class="n">link_to_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cfda544a2e00cad7b97d3944d002bc2b">class UsersHelperTest &lt; ActionView::TestCase
  test "should return the user's full name" do
    user = users(:david)

    assert_dom_equal %{&lt;a href="/user/#{user.id}"&gt;David Heinemeier Hansson&lt;/a&gt;}, link_to_user(user)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cfda544a2e00cad7b97d3944d002bc2b">Copiar</button>
</div>
<p>Além disso, uma vez que a classe de teste se estende de <code>ActionView::TestCase</code>, você tem
acesso aos métodos auxiliares do Rails como <code>link_to</code> ou<code>pluralize</code>.</p><h3 id="testing-your-mailers"><a class="anchorlink" href="#testing-your-mailers">12 Testing Your Mailers</a></h3><p>Testing mailer classes requires some specific tools to do a thorough job.</p><h4 id="keeping-the-postman-in-check"><a class="anchorlink" href="#keeping-the-postman-in-check">12.1 Keeping the Postman in Check</a></h4><p>Your mailer classes - like every other part of your Rails application - should be tested to ensure that they are working as expected.</p><p>The goals of testing your mailer classes are to ensure that:</p>
<ul>
<li>emails are being processed (created and sent)</li>
<li>the email content is correct (subject, sender, body, etc)</li>
<li>the right emails are being sent at the right times</li>
</ul>
<h5 id="from-all-sides"><a class="anchorlink" href="#from-all-sides">12.1.1 From All Sides</a></h5><p>There are two aspects of testing your mailer, the unit tests and the functional tests. In the unit tests, you run the mailer in isolation with tightly controlled inputs and compare the output to a known value (a fixture). In the functional tests you don't so much test the minute details produced by the mailer; instead, we test that our controllers and models are using the mailer in the right way. You test to prove that the right email was sent at the right time.</p><h4 id="unit-testing"><a class="anchorlink" href="#unit-testing">12.2 Unit Testing</a></h4><p>In order to test that your mailer is working as expected, you can use unit tests to compare the actual results of the mailer with pre-written examples of what should be produced.</p><h5 id="revenge-of-the-fixtures"><a class="anchorlink" href="#revenge-of-the-fixtures">12.2.1 Revenge of the Fixtures</a></h5><p>For the purposes of unit testing a mailer, fixtures are used to provide an example of how the output <em>should</em> look. Because these are example emails, and not Active Record data like the other fixtures, they are kept in their own subdirectory apart from the other fixtures. The name of the directory within <code>test/fixtures</code> directly corresponds to the name of the mailer. So, for a mailer named <code>UserMailer</code>, the fixtures should reside in <code>test/fixtures/user_mailer</code> directory.</p><p>If you generated your mailer, the generator does not create stub fixtures for the mailers actions. You'll have to create those files yourself as described above.</p><h5 id="the-basic-test-case"><a class="anchorlink" href="#the-basic-test-case">12.2.2 The Basic Test Case</a></h5><p>Here's a unit test to test a mailer named <code>UserMailer</code> whose action <code>invite</code> is used to send an invitation to a friend. It is an adapted version of the base test created by the generator for an <code>invite</code> action.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"invite"</span> <span class="k">do</span>
    <span class="c1"># Create the email and store it for further assertions</span>
    <span class="n">email</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">create_invite</span><span class="p">(</span><span class="s2">"me@example.com"</span><span class="p">,</span>
                                     <span class="s2">"friend@example.com"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>

    <span class="c1"># Send the email, then test that it got queued</span>
    <span class="n">assert_emails</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">email</span><span class="p">.</span><span class="nf">deliver_now</span>
    <span class="k">end</span>

    <span class="c1"># Test the body of the sent email contains what we expect it to</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s2">"me@example.com"</span><span class="p">],</span> <span class="n">email</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s2">"friend@example.com"</span><span class="p">],</span> <span class="n">email</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="s2">"You have been invited by me@example.com"</span><span class="p">,</span> <span class="n">email</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="n">read_fixture</span><span class="p">(</span><span class="s2">"invite"</span><span class="p">).</span><span class="nf">join</span><span class="p">,</span> <span class="n">email</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-16bcf941a46b12484ccad2364c9c8a30">require "test_helper"

class UserMailerTest &lt; ActionMailer::TestCase
  test "invite" do
    # Create the email and store it for further assertions
    email = UserMailer.create_invite("me@example.com",
                                     "friend@example.com", Time.now)

    # Send the email, then test that it got queued
    assert_emails 1 do
      email.deliver_now
    end

    # Test the body of the sent email contains what we expect it to
    assert_equal ["me@example.com"], email.from
    assert_equal ["friend@example.com"], email.to
    assert_equal "You have been invited by me@example.com", email.subject
    assert_equal read_fixture("invite").join, email.body.to_s
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-16bcf941a46b12484ccad2364c9c8a30">Copiar</button>
</div>
<p>In the test we create the email and store the returned object in the <code>email</code>
variable. We then ensure that it was sent (the first assert), then, in the
second batch of assertions, we ensure that the email does indeed contain what we
expect. The helper <code>read_fixture</code> is used to read in the content from this file.</p><div class="note"><p><code>email.body.to_s</code> is present when there's only one (HTML or text) part present.
If the mailer provides both, you can test your fixture against specific parts
with <code>email.text_part.body.to_s</code> or <code>email.html_part.body.to_s</code>.</p></div><p>Here's the content of the <code>invite</code> fixture:</p><div class="code_container">
<pre><code class="highlight plaintext">Hi friend@example.com,

You have been invited.

Cheers!
</code></pre>
<textarea class="clipboard-content" id="clipboard-16ef8609f7f0fb02344de482d0ab9dbd">Hi friend@example.com,

You have been invited.

Cheers!
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-16ef8609f7f0fb02344de482d0ab9dbd">Copiar</button>
</div>
<p>This is the right time to understand a little more about writing tests for your
mailers. The line <code>ActionMailer::Base.delivery_method = :test</code> in
<code>config/environments/test.rb</code> sets the delivery method to test mode so that
email will not actually be delivered (useful to avoid spamming your users while
testing) but instead it will be appended to an array
(<code>ActionMailer::Base.deliveries</code>).</p><div class="note"><p>The <code>ActionMailer::Base.deliveries</code> array is only reset automatically in
<code>ActionMailer::TestCase</code> and <code>ActionDispatch::IntegrationTest</code> tests.
If you want to have a clean slate outside these test cases, you can reset it
manually with: <code>ActionMailer::Base.deliveries.clear</code></p></div><h4 id="functional-and-system-testing"><a class="anchorlink" href="#functional-and-system-testing">12.3 Functional and System Testing</a></h4><p>Unit testing allows us to test the attributes of the email while functional and system testing allows us to test whether user interactions appropriately trigger the email to be delivered. For example, you can check that the invite friend operation is sending an email appropriately:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Integration Test</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"invite friend"</span> <span class="k">do</span>
    <span class="c1"># Asserts the difference in the ActionMailer::Base.deliveries</span>
    <span class="n">assert_emails</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">invite_friend_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">email: </span><span class="s2">"friend@example.com"</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f3f82847feb52bcaf8cb1169ec1b23aa"># Integration Test
require "test_helper"

class UsersControllerTest &lt; ActionDispatch::IntegrationTest
  test "invite friend" do
    # Asserts the difference in the ActionMailer::Base.deliveries
    assert_emails 1 do
      post invite_friend_url, params: { email: "friend@example.com" }
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f3f82847feb52bcaf8cb1169ec1b23aa">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># System Test</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UsersTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :headless_chrome</span>

  <span class="nb">test</span> <span class="s2">"inviting a friend"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">invite_users_url</span>
    <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"friend@example.com"</span>
    <span class="n">assert_emails</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">click_on</span> <span class="s2">"Invite"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-48a292a127e47ca4fdfc1ba27d0f24d0"># System Test
require "test_helper"

class UsersTest &lt; ActionDispatch::SystemTestCase
  driven_by :selenium, using: :headless_chrome

  test "inviting a friend" do
    visit invite_users_url
    fill_in "Email", with: "friend@example.com"
    assert_emails 1 do
      click_on "Invite"
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-48a292a127e47ca4fdfc1ba27d0f24d0">Copiar</button>
</div>
<div class="note"><p>The <code>assert_emails</code> method is not tied to a particular deliver method and will work with emails delivered with either the <code>deliver_now</code> or <code>deliver_later</code> method. If we explicitly want to assert that the email has been enqueued we can use the <code>assert_enqueued_emails</code> method. More information can be found in the  <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionMailer/TestHelper.html">documentation here</a>.</p></div><h3 id="testando-os-jobs"><a class="anchorlink" href="#testando-os-jobs">13 Testando os <em>Jobs</em></a></h3><p>Uma vez que seus <em>jobs</em> podem ser enfileirados em diferentes camadas dentro da sua aplicação,
será necessário testar tanto os <em>jobs</em> propriamente ditos (seu comportamento, uma vez que estiverem enfileirados),
quanto as entidades que fazem o enfileiramento destes.</p><h4 id="um-caso-de-teste-basico"><a class="anchorlink" href="#um-caso-de-teste-basico">13.1 Um Caso de Teste Básico</a></h4><p>Por padrão, quando você gera um <em>job</em>, também será gerado um teste
dentro do diretório <code>test/jobs</code>. Aqui está um exemplo de teste do <em>job</em> de cobrança (<em>billing</em>):</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">BillingJobTest</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"that account is charged"</span> <span class="k">do</span>
    <span class="no">BillingJob</span><span class="p">.</span><span class="nf">perform_now</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">account</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">charged_for?</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ecd17549039b5a98bb25af0b8ec7f182">require "test_helper"

class BillingJobTest &lt; ActiveJob::TestCase
  test "that account is charged" do
    BillingJob.perform_now(account, product)
    assert account.reload.charged_for?(product)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ecd17549039b5a98bb25af0b8ec7f182">Copiar</button>
</div>
<p>Esse teste é bem simples e somente faz a asserção que <em>job</em> fez o trabalho como esperado.</p><p>Por padrão, <code>ActiveJob::TestCase</code> irá definir o adaptador de fila para <code>:test</code> dessa maneira
seus <em>jobs</em> irão ser executados de forma linear. Isso também irá garantir que todos os <em>jobs</em> realizados
anteriormente e os que estiverem enfileirados serão limpos antes de qualquer execução de teste para que
você possa assumir com segurança que nenhum outro tenha sido executado no âmbito de cada teste.</p><h4 id="assercoes-personalizadas-e-testando-jobs-dentro-de-outros-componentes"><a class="anchorlink" href="#assercoes-personalizadas-e-testando-jobs-dentro-de-outros-componentes">13.2 Asserções Personalizadas e Testando Jobs dentro de Outros Componentes</a></h4><p>O Active Job vem com um monte de asserções customizadas que podem ser usadas para diminuir a verbosidade
dos testes. Para uma lsita completa de asserções disponíveis, visite a documenta da API em
<a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveJob/TestHelper.html"><code>ActiveJob::TestHelper</code></a>.</p><p>É uma boa prática se assegurar que seus <em>jobs</em> serão enfileirados ou executados
onde quer que você os invoque (exemplo: dentro dos seus <em>controllers</em>). Este é um bom local onde
as asserções personalizadas fornecidas pelo Active Job são muito úteis. Por exemplo,
dentro de um <em>model</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestHelper</span>

  <span class="nb">test</span> <span class="s2">"billing job scheduling"</span> <span class="k">do</span>
    <span class="n">assert_enqueued_with</span><span class="p">(</span><span class="ss">job: </span><span class="no">BillingJob</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product</span><span class="p">.</span><span class="nf">charge</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9e85d797300de584c3e4367aaf02d684">require "test_helper"

class ProductTest &lt; ActiveSupport::TestCase
  include ActiveJob::TestHelper

  test "billing job scheduling" do
    assert_enqueued_with(job: BillingJob) do
      product.charge(account)
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9e85d797300de584c3e4367aaf02d684">Copiar</button>
</div>
<h3 id="testing-action-cable"><a class="anchorlink" href="#testing-action-cable">14 Testing Action Cable</a></h3><p>Since Action Cable is used at different levels inside your application,
you'll need to test both the channels, connection classes themselves, and that other
entities broadcast correct messages.</p><h4 id="connection-test-case"><a class="anchorlink" href="#connection-test-case">14.1 Connection Test Case</a></h4><p>By default, when you generate new Rails application with Action Cable, a test for the base connection class (<code>ApplicationCable::Connection</code>) is generated as well under <code>test/channels/application_cable</code> directory.</p><p>Connection tests aim to check whether a connection's identifiers get assigned properly
or that any improper connection requests are rejected. Here is an example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationCable::ConnectionTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Connection</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"connects with params"</span> <span class="k">do</span>
    <span class="c1"># Simulate a connection opening by calling the `connect` method</span>
    <span class="n">connect</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="mi">42</span> <span class="p">}</span>

    <span class="c1"># You can access the Connection object via `connection` in tests</span>
    <span class="n">assert_equal</span> <span class="n">connection</span><span class="p">.</span><span class="nf">user_id</span><span class="p">,</span> <span class="s2">"42"</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"rejects connection without params"</span> <span class="k">do</span>
    <span class="c1"># Use `assert_reject_connection` matcher to verify that</span>
    <span class="c1"># connection is rejected</span>
    <span class="n">assert_reject_connection</span> <span class="p">{</span> <span class="n">connect</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f5ba58fbb7680f8ed5009d874a1f5bb5">class ApplicationCable::ConnectionTest &lt; ActionCable::Connection::TestCase
  test "connects with params" do
    # Simulate a connection opening by calling the `connect` method
    connect params: { user_id: 42 }

    # You can access the Connection object via `connection` in tests
    assert_equal connection.user_id, "42"
  end

  test "rejects connection without params" do
    # Use `assert_reject_connection` matcher to verify that
    # connection is rejected
    assert_reject_connection { connect }
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f5ba58fbb7680f8ed5009d874a1f5bb5">Copiar</button>
</div>
<p>You can also specify request cookies the same way you do in integration tests:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"connects with cookies"</span> <span class="k">do</span>
  <span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"42"</span>

  <span class="n">connect</span>

  <span class="n">assert_equal</span> <span class="n">connection</span><span class="p">.</span><span class="nf">user_id</span><span class="p">,</span> <span class="s2">"42"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c17538e89ad6540fec5494538f91afef">test "connects with cookies" do
  cookies.signed[:user_id] = "42"

  connect

  assert_equal connection.user_id, "42"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c17538e89ad6540fec5494538f91afef">Copiar</button>
</div>
<p>See the API documentation for <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Connection/TestCase.html"><code>ActionCable::Connection::TestCase</code></a> for more information.</p><h4 id="channel-test-case"><a class="anchorlink" href="#channel-test-case">14.2 Channel Test Case</a></h4><p>By default, when you generate a channel, an associated test will be generated as well
under the <code>test/channels</code> directory. Here's an example test with a chat channel:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ChatChannelTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Channel</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"subscribes and stream for room"</span> <span class="k">do</span>
    <span class="c1"># Simulate a subscription creation by calling `subscribe`</span>
    <span class="n">subscribe</span> <span class="ss">room: </span><span class="s2">"15"</span>

    <span class="c1"># You can access the Channel object via `subscription` in tests</span>
    <span class="n">assert</span> <span class="n">subscription</span><span class="p">.</span><span class="nf">confirmed?</span>
    <span class="n">assert_has_stream</span> <span class="s2">"chat_15"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e76a0d27c3fd6a423e20ea823e8d2218">require "test_helper"

class ChatChannelTest &lt; ActionCable::Channel::TestCase
  test "subscribes and stream for room" do
    # Simulate a subscription creation by calling `subscribe`
    subscribe room: "15"

    # You can access the Channel object via `subscription` in tests
    assert subscription.confirmed?
    assert_has_stream "chat_15"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e76a0d27c3fd6a423e20ea823e8d2218">Copiar</button>
</div>
<p>This test is pretty simple and only asserts that the channel subscribes the connection to a particular stream.</p><p>You can also specify the underlying connection identifiers. Here's an example test with a web notifications channel:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">WebNotificationsChannelTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Channel</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"subscribes and stream for user"</span> <span class="k">do</span>
    <span class="n">stub_connection</span> <span class="ss">current_user: </span><span class="n">users</span><span class="p">(</span><span class="ss">:john</span><span class="p">)</span>

    <span class="n">subscribe</span>

    <span class="n">assert_has_stream_for</span> <span class="n">users</span><span class="p">(</span><span class="ss">:john</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-18d66fe605da438696f01cfd0b758e0b">require "test_helper"

class WebNotificationsChannelTest &lt; ActionCable::Channel::TestCase
  test "subscribes and stream for user" do
    stub_connection current_user: users(:john)

    subscribe

    assert_has_stream_for users(:john)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-18d66fe605da438696f01cfd0b758e0b">Copiar</button>
</div>
<p>See the API documentation for <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Channel/TestCase.html"><code>ActionCable::Channel::TestCase</code></a> for more information.</p><h4 id="custom-assertions-and-testing-broadcasts-inside-other-components"><a class="anchorlink" href="#custom-assertions-and-testing-broadcasts-inside-other-components">14.3 Custom Assertions And Testing Broadcasts Inside Other Components</a></h4><p>Action Cable ships with a bunch of custom assertions that can be used to lessen the verbosity of tests. For a full list of available assertions, see the API documentation for <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/TestHelper.html"><code>ActionCable::TestHelper</code></a>.</p><p>It's a good practice to ensure that the correct message has been broadcasted inside other components (e.g. inside your controllers). This is precisely where
the custom assertions provided by Action Cable are pretty useful. For instance,
within a model:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"broadcast status after charge"</span> <span class="k">do</span>
    <span class="n">assert_broadcast_on</span><span class="p">(</span><span class="s2">"products:</span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"charged"</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product</span><span class="p">.</span><span class="nf">charge</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cc608a3c433218aafdf5d04b3911ab2f">require "test_helper"

class ProductTest &lt; ActionCable::TestCase
  test "broadcast status after charge" do
    assert_broadcast_on("products:#{product.id}", type: "charged") do
      product.charge(account)
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cc608a3c433218aafdf5d04b3911ab2f">Copiar</button>
</div>
<p>If you want to test the broadcasting made with <code>Channel.broadcast_to</code>, you should use
<code>Channel.broadcasting_for</code> to generate an underlying stream name:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/jobs/chat_relay_job.rb</span>
<span class="k">class</span> <span class="nc">ChatRelayJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="k">def</span> <span class="nf">perform_later</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="no">ChatChannel</span><span class="p">.</span><span class="nf">broadcast_to</span> <span class="n">room</span><span class="p">,</span> <span class="ss">text: </span><span class="n">message</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a3c9419c75b4f29f0d547d41b046ea80"># app/jobs/chat_relay_job.rb
class ChatRelayJob &lt; ApplicationJob
  def perform_later(room, message)
    ChatChannel.broadcast_to room, text: message
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a3c9419c75b4f29f0d547d41b046ea80">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/jobs/chat_relay_job_test.rb</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ChatRelayJobTest</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">TestHelper</span>

  <span class="nb">test</span> <span class="s2">"broadcast message to room"</span> <span class="k">do</span>
    <span class="n">room</span> <span class="o">=</span> <span class="n">rooms</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>

    <span class="n">assert_broadcast_on</span><span class="p">(</span><span class="no">ChatChannel</span><span class="p">.</span><span class="nf">broadcasting_for</span><span class="p">(</span><span class="n">room</span><span class="p">),</span> <span class="ss">text: </span><span class="s2">"Hi!"</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">ChatRelayJob</span><span class="p">.</span><span class="nf">perform_now</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="s2">"Hi!"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-77db3990e2667468ba2faf2ca93f732a"># test/jobs/chat_relay_job_test.rb
require "test_helper"

class ChatRelayJobTest &lt; ActiveJob::TestCase
  include ActionCable::TestHelper

  test "broadcast message to room" do
    room = rooms(:all)

    assert_broadcast_on(ChatChannel.broadcasting_for(room), text: "Hi!") do
      ChatRelayJob.perform_now(room, "Hi!")
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-77db3990e2667468ba2faf2ca93f732a">Copiar</button>
</div>
<h3 id="recursos-adicionais-para-testes"><a class="anchorlink" href="#recursos-adicionais-para-testes">15 Recursos Adicionais para Testes</a></h3><h4 id="testando-codigo-dependente-de-data-horario"><a class="anchorlink" href="#testando-codigo-dependente-de-data-horario">15.1 Testando Código Dependente de Data/Horário</a></h4><p>O Rails fornece métodos <em>helpers</em> integrados que permitem que você verifique que seu código dependente de data ou hora funcione conforme o esperado.</p><p>Aqui está um exemplo utilizando o <em>helper</em> <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Testing/TimeHelpers.html#method-i-travel_to"><code>travel_to</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Digamos que um usuário só poderá enviar presentes após um mês do seu registro.</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Gaurish"</span><span class="p">,</span> <span class="ss">activation_date: </span><span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
<span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">applicable_for_gifting?</span>
<span class="n">travel_to</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">assert_equal</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">user</span><span class="p">.</span><span class="nf">activation_date</span> <span class="c1"># dentro do bloco `travel_to` é feito o mock de `Date.current` </span>
  <span class="n">assert</span> <span class="n">user</span><span class="p">.</span><span class="nf">applicable_for_gifting?</span>
<span class="k">end</span>
<span class="n">assert_equal</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">user</span><span class="p">.</span><span class="nf">activation_date</span> <span class="c1"># A mudança é visível somente dentro do bloco `travel_to`.</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ef4eea3dd2eeb934af112b712dc45ade"># Digamos que um usuário só poderá enviar presentes após um mês do seu registro.
user = User.create(name: "Gaurish", activation_date: Date.new(2004, 10, 24))
assert_not user.applicable_for_gifting?
travel_to Date.new(2004, 11, 24) do
  assert_equal Date.new(2004, 10, 24), user.activation_date # dentro do bloco `travel_to` é feito o mock de `Date.current` 
  assert user.applicable_for_gifting?
end
assert_equal Date.new(2004, 10, 24), user.activation_date # A mudança é visível somente dentro do bloco `travel_to`.
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ef4eea3dd2eeb934af112b712dc45ade">Copiar</button>
</div>
<p>Por favor consulte a <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Testing/TimeHelpers.html">Documentação da API <code>ActiveSupport::Testing::TimeHelpers</code></a> para obter informações detalhadas sobre os <em>helpers</em> de tempo disponíveis.</p>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua se vir qualquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
