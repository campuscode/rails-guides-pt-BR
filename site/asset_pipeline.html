<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>O Asset Pipeline — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="O Asset Pipeline — Ruby on Rails Guides" />
  <meta name="description" content="O Asset PipelineEste guia aborda o asset pipeline.Depois de ler este guia, você saberá: O que o asset pipeline é e o que ele faz. Como organizar apropriadamente seus assets da aplicação. Os benefícios do asset pipeline. Como adicionar um pré-processador ao pipeline. Como empacotar os assets com uma gem." />
  <meta property="og:description" content="O Asset PipelineEste guia aborda o asset pipeline.Depois de ler este guia, você saberá: O que o asset pipeline é e o que ele faz. Como organizar apropriadamente seus assets da aplicação. Os benefícios do asset pipeline. Como adicionar um pré-processador ao pipeline. Como empacotar os assets com uma gem." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v6.1.4</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>O <em>Asset Pipeline</em></h2><p>Este guia aborda o <em>asset pipeline</em>.</p><p>Depois de ler este guia, você saberá:</p>
<ul>
<li>O que o <em>asset pipeline</em> é e o que ele faz.</li>
<li>Como organizar apropriadamente seus <em>assets</em> da aplicação.</li>
<li>Os benefícios do <em>asset pipeline</em>.</li>
<li>Como adicionar um pré-processador ao <em>pipeline</em>.</li>
<li>Como empacotar os <em>assets</em> com uma <em>gem</em>.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#o-que-e-o-asset-pipeline-questionmark">O que é o <em>Asset Pipeline</em>?</a>

<ul>
<li><a href="#principais-caracteristicas">Principais Características</a></li>
<li><a href="#o-que-e-impressao-digital-e-por-que-eu-deveria-me-importar-questionmark">O que é Impressão Digital e Por Que Eu Deveria Me Importar?</a></li>
</ul>
</li>
<li>
<a href="#como-usar-o-asset-pipeline">Como usar o <em>Asset Pipeline</em></a>

<ul>
<li><a href="#assets-especificos-de-controllers"><em>Assets</em> Específicos de <em>Controllers</em></a></li>
<li><a href="#organizacao-dos-assets">Organização dos <em>Assets</em></a></li>
<li><a href="#codificando-links-para-assets">Codificando <em>Links</em> para <em>Assets</em></a></li>
<li><a href="#arquivos-de-manifesto-e-diretivas">Arquivos de Manifesto e Diretivas</a></li>
<li><a href="#pre-processamento">Pré-processamento</a></li>
</ul>
</li>
<li>
<a href="#in-development">In Development</a>

<ul>
<li><a href="#raise-an-error-when-an-asset-is-not-found">Raise an Error When an Asset is Not Found</a></li>
<li><a href="#turning-digests-off">Turning Digests Off</a></li>
<li><a href="#turning-debugging-off">Turning Debugging Off</a></li>
</ul>
</li>
<li>
<a href="#in-production">In Production</a>

<ul>
<li><a href="#precompiling-assets">Precompiling Assets</a></li>
<li><a href="#local-precompilation">Local Precompilation</a></li>
<li><a href="#live-compilation">Live Compilation</a></li>
<li><a href="#cdns">CDNs</a></li>
</ul>
</li>
<li>
<a href="#customizing-the-pipeline">Customizing the Pipeline</a>

<ul>
<li><a href="#css-compression">CSS Compression</a></li>
<li><a href="#javascript-compression">JavaScript Compression</a></li>
<li><a href="#gzipping-your-assets">GZipping your assets</a></li>
<li><a href="#using-your-own-compressor">Using Your Own Compressor</a></li>
<li><a href="#changing-the-assets-path">Changing the <em>assets</em> Path</a></li>
<li><a href="#x-sendfile-headers">X-Sendfile Headers</a></li>
</ul>
</li>
<li><a href="#assets-cache-store">Assets Cache Store</a></li>
<li><a href="#adding-assets-to-your-gems">Adding Assets to Your Gems</a></li>
<li><a href="#making-your-library-or-gem-a-pre-processor">Making Your Library or Gem a Pre-Processor</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="o-que-e-o-asset-pipeline-questionmark"><a class="anchorlink" href="#o-que-e-o-asset-pipeline-questionmark">1 O que é o <em>Asset Pipeline</em>?</a></h3><p>O <em>asset pipeline</em> fornece um <em>framework</em> para concatenar e minificar ou comprimir
<em>assets</em> JavaScript e CSS. Ele também tem a habilidade de escrever esses <em>assets</em> em
outras linguagens e pré-processadores tais como CoffeeScript, Sass e ERB.
Isso permite que os <em>assets</em> da sua aplicação sejam automaticamente combinados com
<em>assets</em> de outras <em>gems</em>.</p><p>O <em>asset pipeline</em> é implementado pela <em>gem</em>
<a href="https://github.com/rails/sprockets-rails">sprockets-rails</a>,
e é habilitado por padrão. Você pode desabilitar enquanto está criando uma nova aplicação
passando a opção <code>--skip-sprockets</code>.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>new appname <span class="nt">--skip-sprockets</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0d028c415330bbec774c378b122c9c94">rails new appname --skip-sprockets
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0d028c415330bbec774c378b122c9c94">Copiar</button>
</div>
<p>O Rails automaticamente adiciona a <em>gem</em> <a href="https://github.com/rails/sass-rails"><code>sass-rails</code></a>
no seu <code>Gemfile</code>, o qual é usado pelo Sprockets para comprimir
<a href="https://sass-lang.com">Sass</a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'sass-rails'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b3f8ff542af10a60a7d00e42f60a5cd8">gem 'sass-rails'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b3f8ff542af10a60a7d00e42f60a5cd8">Copiar</button>
</div>
<p>Usando a opção <code>--skip-sprockets</code> previnirá que o Rails adicione essa gem ao seu <code>Gemfile</code>,
então se mais tarde você quiser habilitar o <em>asset pipeline</em> você terá que adicionar
essas <em>gems</em> ao seu <code>Gemfile</code> manualmente. Além disso, criando uma aplicação com a opção <code>--skip-sprockets</code>
gerará um arquivo <code>config/application.rb</code> levemente diferente, com a declaração de requerimento
para o <em>sprockets</em> que está comentado. Você terá de remover o operador de comentário nessa linha
para depois habilitar o <em>asset pipeline</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># require "sprockets/railtie"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-aa1eeb924b0e1b511197cea9d60bc7c3"># require "sprockets/railtie"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-aa1eeb924b0e1b511197cea9d60bc7c3">Copiar</button>
</div>
<p>Para configurar os métodos de compactação do <em>asset</em>, coloque as opções de configuração
apropriadas no <code>production.rb</code> - <code>config.assets.css_compressor</code> para o seu CSS e
<code>config.assets.js_compressor</code> para seu JavaScript:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">css_compressor</span> <span class="o">=</span> <span class="ss">:yui</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:uglifier</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-00f2eb66da90d3813e923f3042d09afd">config.assets.css_compressor = :yui
config.assets.js_compressor = :uglifier
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-00f2eb66da90d3813e923f3042d09afd">Copiar</button>
</div>
<div class="note"><p>A <em>gem</em> <code>sass-rails</code> é automaticamente usada para a compactação de CSS se estiver
incluída no <code>Gemfile</code> e nenhuma opção <code>config.assets.css_compressor</code> é definida.</p></div><h4 id="principais-caracteristicas"><a class="anchorlink" href="#principais-caracteristicas">1.1 Principais Características</a></h4><p>A primeira característica do <em>pipeline</em> é concatenar os <em>assets</em>, o qual pode
reduzir o número de requisições que o navegador faz para renderizar uma página web.
Os navegadores web são limitados no número de requisições que eles podem fazer em paralelo,
portanto, menos solicitações podem significar carregamento mais rápido de sua aplicação.</p><p>O <em>Sprockets</em> concatena todos os arquivos JavaScript em um arquivo principal <code>.js</code> e todos
os arquivos CSS em um arquivo principal <code>.css</code>. Como você aprenderá mais tarde neste guia,
você pode mudar esta estratégia para agrupar arquivos da maneira que quiser. Em produção,
o Rails insere uma impressão digital SHA256 dentro de cada nome de arquivo para que o arquivo
seja armazenado em cache no navegador. Você pode invalidar o armazenamento <em>cache</em> alterando essa
impressão digital, o qual acontece automaticamente sempre que você muda o conteúdo do arquivo.</p><p>A segunda característica do <em>asset pipeline</em> é a minificação ou compactação do <em>asset</em>.
Para arquivos CSS, isso é feito removendo espaços em branco e comentários. Para JavaScript,
mais processos complexos são aplicados. Você pode escolher entre um conjunto de opções ou
especificar a sua própria.</p><p>A terceira característica do <em>asset pipeline</em> é que permite a codificação dos
<em>assets</em> por meio de uma línguagem de alto nível, com pré-compilação até os
atuais <em>assets</em>. Línguagens suportadas incluem Sass para CSS, CoffeeScript para
JavaScript, e ERB para ambos por padrão.</p><h4 id="o-que-e-impressao-digital-e-por-que-eu-deveria-me-importar-questionmark"><a class="anchorlink" href="#o-que-e-impressao-digital-e-por-que-eu-deveria-me-importar-questionmark">1.2 O que é Impressão Digital e Por Que Eu Deveria Me Importar?</a></h4><p>Impressão digital é uma técnica que faz o nome do arquivo dependente do conteúdo
do arquivo. Quando o conteúdo do arquivo muda, o nome do arquivo muda também.
Para o conteúdo estático ou que muda com pouca frequência, ele tem uma forma
mais fácil para dizer se duas versões do arquivo são idênticas, mesmo através
de diferentes servidores ou datas de desenvolvimento.</p><p>Quando o nome do arquivo é único e baseado no seu conteúdo, os <em>headers</em> HTTP
podem ser configurados para encorajar armazenamento <em>caches</em> em todo lugar (seja
em CDNs, em ISPs, nos equipamentos de rede, ou nos navegadores web) para manter
suas próprias cópias do conteúdo. Quando o conteúdo é atualizado, a impressão digital
mudará. Isso fará com que os clientes remotos requisitem uma nova cópia do conteúdo.
Isso é geralmente conhecido como <em>cache busting</em>.</p><p>A técnica que o <em>Sprockets</em> usa para impressão digital é inserir um <em>hash</em> do
conteúdo no nome, geralmente no final. Por exemplo o arquivo CSS <code>global.css</code></p><div class="code_container">
<pre><code class="highlight plaintext">global-908e25f4bf641868d8683022a5b62f54.css
</code></pre>
<textarea class="clipboard-content" id="clipboard-1786c57c880deb296b3e6c9b166dcf24">global-908e25f4bf641868d8683022a5b62f54.css
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1786c57c880deb296b3e6c9b166dcf24">Copiar</button>
</div>
<p>Essa é a estratégia adotada pelo <em>asset pipeline</em> do Rails.</p><p>A antiga estratégia do Rails era anexar uma <em>Query String</em>(string de consulta) baseada em data
para cada <em>asset</em> vinculado com um <em>helper</em> interno. Em resumo o código gerado
parecia com isso:</p><div class="code_container">
<pre><code class="highlight plaintext">/stylesheets/global.css?1309495796
</code></pre>
<textarea class="clipboard-content" id="clipboard-9913aab4f4c9d18120f4361477e4af69">/stylesheets/global.css?1309495796
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9913aab4f4c9d18120f4361477e4af69">Copiar</button>
</div>
<p>A estratégia de <em>Query String</em>(string de consulta) tinha várias desvantagens:</p>
<ol>
<li>
<p><strong>Nem todos os <em>caches</em> irão armazenar o conteúdo onde o nome do arquivo se
diferencia apenas por parâmetros de busca</strong></p>
<p><a href="https://www.stevesouders.com/blog/2008/08/23/revving-filenames-dont-use-querystring/">recommendação do Steve Souders</a>,
"...Evitando uma <em>Query String</em>(string de consulta) para recursos de armazenamento de <em>cache</em>".
Ele descobriu que nesse caso 5-20% das requisições não irão ser armazenadas em cache.
<em>Query String</em>(string de consulta) em particular nem sempre funcionam com alguns CDNs por invalidação de cache.</p>
</li>
<li>
<p><strong>O nome do arquivo pode mudar entre nós em ambientes de multi-servidores.</strong></p>
<p>A <em>Query String</em>(string de consulta) padrão no Rails 2.x é baseada na data de modificação dos
arquivos. Quando os <em>assets</em> são implantados em um <em>cluster</em>, não há garantia que o
<em>timestamps</em> será o mesmo, resultando em diferentes valores sendo usados dependendo
de qual servidor lida com a requisição.</p>
</li>
<li>
<p><strong>Muita invalidação de cache</strong></p>
<p>Quando <em>assets</em> estáticos são implementados com novas versões de código, o <em>mtime</em>
(horário da última modificação) de <em>todos</em> esses arquivos muda, forçando todos
os clientes remotos a encontrarem eles de novo, mesmo quando o conteúdo desses
<em>assets</em> não mudaram.</p>
</li>
</ol>
<p>A Impressão digital resolve esses problemas evitando <em>Query String</em>(string de consulta), e garantindo
que o nome dos arquivos sejam coerentes com base no seu conteúdo.</p><p>A impressão digital é habilitada por padrão para ambos os ambientes desenvolvimento e
produção. Você pode habilitar ou desabilitar isso na sua configuração através da opção
<code>config.assets.digest</code>.</p><p>Mais leitura:</p>
<ul>
<li><a href="https://developers.google.com/speed/docs/insights/LeverageBrowserCaching">Otimizar o armazenamento cache</a></li>
<li><a href="http://www.stevesouders.com/blog/2008/08/23/revving-filenames-dont-use-querystring/">Acelerando nome dos arquivos: não use <em>Query String</em>(string de consulta)</a></li>
</ul>
<h3 id="como-usar-o-asset-pipeline"><a class="anchorlink" href="#como-usar-o-asset-pipeline">2 Como usar o <em>Asset Pipeline</em></a></h3><p>Nas versões anteriores do Rails, todos os <em>assets</em> estavam localizados nos subdiretórios
abaixo de <code>public</code>, como <code>imagens</code>, <code>javascripts</code> and <code>stylesheets</code>. Com o <em>asset pipeline</em>,
a localização recomendada para esses <em>assets</em> é agora o diretório <code>app/assets</code>.
Arquivos nesse diretório serão servidos pelo <em>Sprockets middleware</em>.</p><p>Os <em>assets</em> podem ainda ser colocados na hierarquia do <code>public</code>. Qualquer <em>asset</em> sob
<code>public</code> ainda será servido como um arquivo estático pela aplicação ou servidor <em>web</em> quando
<code>config.public_file_server.enabled</code> estiver configurado como <em>true</em>. Você deve usar o 
<code>app/assets</code> para arquivos que devem ser pré-processados antes de serem servidos.</p><p>Em produção, o Rails pré-compila esses arquivos para <code>public/assets</code> por padrão.
As cópias dos arquivos pré-compilados serão então servidas como <em>assets</em> estáticos
pelo servidor <em>web</em>. Os arquivos em <code>app/assets</code> nunca serão servidos diretamente em produção.</p><h4 id="assets-especificos-de-controllers"><a class="anchorlink" href="#assets-especificos-de-controllers">2.1 <em>Assets</em> Específicos de <em>Controllers</em></a></h4><p>Quando você gera um <em>scaffold</em> ou um <em>controller</em>, o Rails também  gera um
arquivo <em>Cascading Style Sheet</em> (ou SCSS se o <code>sass-rails</code> estiver no <code>Gemfile</code>)
para aquele <em>controller</em>. Adicionalmente, quando você gera um <em>scaffold</em>, o Rails
também gera o arquivo <code>scaffolds.css</code> (ou <code>scaffolds.scss</code> se o <code>sass-rails</code> 
estiver no <code>Gemfile</code>.)</p><p>Por exemplo, se você gerar um <code>ProjectsController</code>, o Rails também adicionará um novo
arquivo em <code>app/assets/stylesheets/projects.scss</code>. Por padrão, os arquivos estarão prontos
para serem usados pela sua aplicação imediatamente usando a diretiva <code>require_tree</code>.
Veja <a href="#arquivos-de-manifesto-e-diretivas">Arquivos de Manifesto e Diretivas</a> para mais detalhes
sobre <code>require_tree</code>.</p><p>Você também pode optar por incluir <em>stylesheets</em> específicas do <em>controller</em> e
arquivos JavaScript apenas nos seus respectivos diretórios, usando o seguinte:</p><p><code>&lt;%= javascript_include_tag params[:controller] %&gt;</code> ou <code>&lt;%= stylesheet_link_tag
params[:controller] %&gt;</code></p><p>Ao fazer isso, certifique-se de que você não está usando a diretiva <code>require_tree</code>,
pois isso resultará em seus <em>assets</em> serem incluídos mais de uma vez.</p><div class="warning"><p>Ao usar pré-compilação de <em>assets</em>, você precisará certificar-se de que 
seus <em>assets</em> dos <em>controllers</em> sejam pré-compilados quando carregá-los por página.
Por padrão, arquivos <code>.coffee</code> e <code>.scss</code> não serão pré-compilados por conta própria.
Veja <a href="#precompiling-assets">Pré-compilando <em>Assets</em></a> para mais informações sobre
como a pré-compilação funciona.</p></div><div class="note"><p>Você deve ter uma <em>runtime</em> de ExecJS para usar CoffeeScript.
Se você estiver usando macOS ou Windows, você deve ter uma <em>runtime</em> de JavaScript instalada 
no seu sistema operacional. Veja a documentação do <a href="https://github.com/rails/execjs#readme">ExecJS</a> para conhecer todas as JavaScript <em>runtimes</em>.</p></div><p>Você também pode desabilitar a geração de arquivos de <em>assets</em> específicos dos <em>controllers</em> 
adicionando o seguinte à sua configuração <code>config/application.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby">  <span class="n">config</span><span class="p">.</span><span class="nf">generators</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span>
    <span class="n">g</span><span class="p">.</span><span class="nf">assets</span> <span class="kp">false</span>
  <span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d6abcd05d060930f9894b07d226371e9">  config.generators do |g|
    g.assets false
  end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d6abcd05d060930f9894b07d226371e9">Copiar</button>
</div>
<h4 id="organizacao-dos-assets"><a class="anchorlink" href="#organizacao-dos-assets">2.2 Organização dos <em>Assets</em></a></h4><p>Os <em>pipeline assets</em> podem ser colocados dentro de uma aplicação nos três locais seguintes:
<code>app/assets</code>, <code>lib/assets</code> ou <code>vendor/assets</code>.</p>
<ul>
<li><p><code>app/assets</code> é destinado aos <em>assets</em> que são proprietários da aplicação, como
imagens customizadas, arquivos JavaScript ou folhas de estilo.</p></li>
<li><p><code>lib/assets</code> é destinado ao código das suas próprias bibliotecas que não se encaixam
no escopo da aplicação ou àquelas bibliotecas que são compartilhadas entre aplicações.</p></li>
<li><p><code>vendor/assets</code> é destinado aos <em>assets</em> que são de propriedade de entidades externas,
como código para <em>plugins</em> de JavaScript e <em>frameworks</em> de CSS. Tenha em mente que códigos
de terceiros com referências à outros arquivos também processados pelo <em>asset Pipeline</em>
(imagens, folhas de estilo, etc.), terão que ser reescritos para usarem auxiliares como <code>asset_path</code>.</p></li>
</ul>
<h5 id="caminhos-de-busca"><a class="anchorlink" href="#caminhos-de-busca">2.2.1 Caminhos de Busca</a></h5><p>Quando um arquivo é referenciado a partir de um manifesto ou um <em>helper</em>, o <em>Sprockets</em> procura
por ele em três locais padrões de <em>assets</em>.</p><p>Os três locais padrões são: os diretórios <code>images</code>, <code>javascripts</code> e <code>stylesheets</code>
abaixo da pasta <code>app/assets</code>, mas esses subdiretórios não são especiais - qualquer caminho
sob <code>assets/*</code> será pesquisado.</p><p>Por exemplo, esses arquivos:</p><div class="code_container">
<pre><code class="highlight plaintext">app/assets/javascripts/home.js
lib/assets/javascripts/moovinator.js
vendor/assets/javascripts/slider.js
vendor/assets/somepackage/phonebox.js
</code></pre>
<textarea class="clipboard-content" id="clipboard-ed8633cb503976cf3fa885ba1a54e2ea">app/assets/javascripts/home.js
lib/assets/javascripts/moovinator.js
vendor/assets/javascripts/slider.js
vendor/assets/somepackage/phonebox.js
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ed8633cb503976cf3fa885ba1a54e2ea">Copiar</button>
</div>
<p>poderiam ser referenciados em um manifesto da seguinte maneira:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">//= require home</span>
<span class="c1">//= require moovinator</span>
<span class="c1">//= require slider</span>
<span class="c1">//= require phonebox</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f2eb0e0cc064fb27ddfb5d4a3480a956">//= require home
//= require moovinator
//= require slider
//= require phonebox
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f2eb0e0cc064fb27ddfb5d4a3480a956">Copiar</button>
</div>
<p>Os <em>assets</em> dentro dos subdiretórios também podem ser acessados.</p><div class="code_container">
<pre><code class="highlight plaintext">app/assets/javascripts/sub/something.js
</code></pre>
<textarea class="clipboard-content" id="clipboard-b0086a1908ff24c541083724d52b93b0">app/assets/javascripts/sub/something.js
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b0086a1908ff24c541083724d52b93b0">Copiar</button>
</div>
<p>é referenciado como:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">//= require sub/something</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e4b193591eef69776e80c326234bf48e">//= require sub/something
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e4b193591eef69776e80c326234bf48e">Copiar</button>
</div>
<p>Você pode visualizar o caminho de busca inspecionando
<code>Rails.application.config.assets.paths</code> no <em>console</em> do Rails.</p><p>Adicionalmente, além do caminho padrão <code>assets/*</code>, caminhos (completos)
podem ser adicionados ao <em>pipeline</em> em <code>config/initializers/assets.rb</code>. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">paths</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">,</span> <span class="s2">"videoplayer"</span><span class="p">,</span> <span class="s2">"flash"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-24906d9d418e63f980b5d2f7a43a0537">Rails.application.config.assets.paths &lt;&lt; Rails.root.join("lib", "videoplayer", "flash")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-24906d9d418e63f980b5d2f7a43a0537">Copiar</button>
</div>
<p>Os caminhos são percorridos na ordem em que eles aparecem no caminho de busca. Por padrão,
isso significa que os arquivos em <code>app/assets</code> tem precedência, e mascararão caminhos
correspondentes em <code>lib</code> e <code>vendor</code>.</p><p>É importante notar que os arquivos que você quiser referenciar fora de um manifesto devem
ser adicionados ao <em>array</em> de pré-compilação, caso contrário eles não estarão disponíveis
no ambiente de produção.</p><h5 id="usando-indices-de-arquivos"><a class="anchorlink" href="#usando-indices-de-arquivos">2.2.2 Usando Índices de Arquivos</a></h5><p>O <em>Sprockets</em> usa arquivos nomeados como <code>index</code> (com a extensão relevante) para um propósito
especial.</p><p>Por exemplo, ser você tiver uma biblioteca jQuery com muitos módulos, que é armazenada em
<code>lib/assets/javascripts/library_name</code>, o arquivo <code>lib/assets/javascripts/library_name/index.js</code> serve como
manifesto para todos os arquivos desta biblioteca. Esse arquivo poderia incluir uma lista de
ordenada de todos os arquivos necessários ou uma simples diretiva <code>require_tree</code>.</p><p>A biblioteca como um todo pode ser acessada no manifesto da aplicação como:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">//= require library_name</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8b3337997bbf3eaf16b1e085fcbbbfb9">//= require library_name
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8b3337997bbf3eaf16b1e085fcbbbfb9">Copiar</button>
</div>
<p>Isso simplifica a manutenção e mantém as coisas limpas, permitindo que o código relacionado
seja agrupado antes da inclusão em outro lugar.</p><h4 id="codificando-links-para-assets"><a class="anchorlink" href="#codificando-links-para-assets">2.3 Codificando <em>Links</em> para <em>Assets</em></a></h4><p>O <em>Sprockets</em> não adiciona nenhum método para acessar seus <em>assets</em> - você ainda usa
as familiares <code>javascript_include_tag</code> e <code>stylesheet_link_tag</code>:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media: </span><span class="s2">"all"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-efb29ed519de4cbdfadd5a91ca6dc665">&lt;%= stylesheet_link_tag "application", media: "all" %&gt;
&lt;%= javascript_include_tag "application" %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-efb29ed519de4cbdfadd5a91ca6dc665">Copiar</button>
</div>
<p>Se você estiver usando a <em>gem turbolinks</em>, que é incluída por padrão no Rails, então
inclua a opção 'data-turbolinks-track' que faz com que a turbolinks verifique se um <em>asset</em>
foi atualizado e então o carrega naquela página:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media: </span><span class="s2">"all"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="s2">"reload"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="s2">"reload"</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-56306d6d11430c7ff2c3dd55940ec536">&lt;%= stylesheet_link_tag "application", media: "all", "data-turbolinks-track" =&gt; "reload" %&gt;
&lt;%= javascript_include_tag "application", "data-turbolinks-track" =&gt; "reload" %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-56306d6d11430c7ff2c3dd55940ec536">Copiar</button>
</div>
<p>Em <em>views</em> comuns você pode acessar imagens no diretório <code>app/assets/images</code>
como essa:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"rails.png"</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-20f23666cdf4d316f1b592bc5edc6319">&lt;%= image_tag "rails.png" %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-20f23666cdf4d316f1b592bc5edc6319">Copiar</button>
</div>
<p>Se o <em>pipeline</em> estiver ativo na sua aplicação (e não desativado no contexto
do ambiente atual), esse arquivo é servido pelo <em>Sprockets</em>. Se um arquivo
existir em <code>public/assets/rails.png</code> ele é servido pelo servidor <em>web</em>.</p><p>Alternativamente, uma requisição para um arquivo com um <em>hash</em> SHA256 como
<code>public/assets/rails-f90d8a84c707a8dc923fca1ca1895ae8ed0a09237f6992015fef1e11be77c023.png</code>
é tratado da mesma maneira. A forma como esses <em>hashes</em> são gerados está coberta na seção
<a href="#in-production">Em Produção</a>, posteriormente nesse guia.</p><p>O <em>Sprockets</em> procurará através dos caminhos especificados em <code>config.assets.paths</code>,
que inclui os caminhos padrões da aplicação e quaisquer caminhos adicionados pelas <em>engines</em>
do Rails.</p><p>As imagens também podem ser organizadas em subdiretórios se necessário, e então
podem ser acessadas pelo nome do diretório na tag:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"icons/rails.png"</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9ea5eb00ca0230662422c55667245672">&lt;%= image_tag "icons/rails.png" %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9ea5eb00ca0230662422c55667245672">Copiar</button>
</div>
<div class="warning"><p>Se você estiver pré-compilando seus <em>assets</em> (veja <a href="#in-production">Em Produção</a>
abaixo), fazer um <em>link</em> com um <em>asset</em> que não exista irá levantar uma <em>exception</em> 
na página chamadora. O mesmo vale se for especificado um <em>link</em> para uma <em>string</em> em branco.
Portanto, tenha cautela ao usar a <code>image_tag</code> e os outros <em>helpers</em> com dados informados pelos usuários.</p></div><h5 id="css-e-erb"><a class="anchorlink" href="#css-e-erb">2.3.1 CSS e ERB</a></h5><p>O <em>asset pipeline</em> avalia automaticamente o ERB. Isso significa que se você adicionar
uma extensão <code>erb</code> a um <em>asset</em> CSS (por exemplo, <code>application.css.erb</code>), então
<em>helpers</em> como <code>asset_path</code> estarão disponíveis nas suas regras de CSS:</p><div class="code_container">
<pre><code class="highlight css"><span class="nc">.class</span> <span class="p">{</span> <span class="nl">background-image</span><span class="p">:</span> <span class="sx">url(&lt;%= asset_path 'image.png' %&gt;)</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d3bf7aee45a2f8aa636cfe783d8e1074">.class { background-image: url(&lt;%= asset_path 'image.png' %&gt;) }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d3bf7aee45a2f8aa636cfe783d8e1074">Copiar</button>
</div>
<p>Isso escreve o caminho ao <em>asset</em> em particular que está sendo referenciado. Nesse exemplo,
faria sentido ter uma imagem em um dos caminhos carregados de <em>assets</em>, como 
<code>app/assets/images/image.png</code>, que seria referenciado aqui. Se essa imagem já está
disponível em <code>public/assets</code> como um arquivo com uma impressão digital, então aquele caminho
é referenciado.</p><p>Se você quiser usar <a href="https://en.wikipedia.org/wiki/Data_URI_scheme">URI de dados</a> -
um método para embutir a imagem diretamente no arquivo de CSS - você pode usar
o <em>helper</em> <code>asset_data_uri</code>.</p><div class="code_container">
<pre><code class="highlight css"><span class="nf">#logo</span> <span class="p">{</span> <span class="nl">background</span><span class="p">:</span> <span class="sx">url(&lt;%= asset_data_uri 'logo.png' %&gt;)</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9f7e160c3fa95f1c21506449bc7a59b2">#logo { background: url(&lt;%= asset_data_uri 'logo.png' %&gt;) }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9f7e160c3fa95f1c21506449bc7a59b2">Copiar</button>
</div>
<p>Isso insere uma URI de dados corretamente formatada no CSS fonte.</p><p>Note que a tag de fechamento não pode ser do estilo <code>-%&gt;</code>.</p><h5 id="css-e-sass"><a class="anchorlink" href="#css-e-sass">2.3.2 CSS e Sass</a></h5><p>Ao utilizar o <em>asset pipeline</em>, os caminhos para os <em>assets</em> devem ser reescritos e
o <code>sass-rails</code> provê os <em>helpers</em> <code>-url</code> e <code>-path</code> (hifenizados em Sass,
separados por <em>underscore</em> em Ruby) para as seguintes classes de <em>assets</em>:
imagem, fonte, vídeo, áudio, JavaScript e folha de estilo.</p>
<ul>
<li>
<code>image-url("rails.png")</code> returns <code>url(/assets/rails.png)</code>
</li>
<li>
<code>image-path("rails.png")</code> returns <code>"/assets/rails.png"</code>
</li>
</ul>
<p>A forma mais genérica também pode ser usada:</p>
<ul>
<li>
<code>asset-url("rails.png")</code> retorna <code>url(/assets/rails.png)</code>
</li>
<li>
<code>asset-path("rails.png")</code> retorna <code>"/assets/rails.png"</code>
</li>
</ul>
<h5 id="javascript-coffeescript-e-erb"><a class="anchorlink" href="#javascript-coffeescript-e-erb">2.3.3 JavaScript/CoffeeScript e ERB</a></h5><p>Se você adicionar uma extensão <code>erb</code> a um <em>asset</em> JavaScript, fazendo algo como
<code>application.js.erb</code>, você pode então usar o <em>helper</em> <code>asset_path</code> no seu
código JavaScript:</p><div class="code_container">
<pre><code class="highlight js"><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#logo</span><span class="dl">'</span><span class="p">).</span><span class="nx">attr</span><span class="p">({</span> <span class="na">src</span><span class="p">:</span> <span class="dl">"</span><span class="s2">&lt;%= asset_path('logo.png') %&gt;</span><span class="dl">"</span> <span class="p">});</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c7e723a5522779cb68aba65447ce3aab">$('#logo').attr({ src: "&lt;%= asset_path('logo.png') %&gt;" });
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c7e723a5522779cb68aba65447ce3aab">Copiar</button>
</div>
<p>Isso escreve o caminho ao <em>asset</em> em particular que está sendo referenciado.</p><p>Similarmente, você pode usar o <em>helper</em> <code>asset_path</code> em arquivos CoffeeScript com
a extensão <code>erb</code> (i.e., <code>application.coffee.erb</code>).</p><div class="code_container">
<pre><code class="highlight js"><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#logo</span><span class="dl">'</span><span class="p">).</span><span class="nx">attr</span> <span class="nx">src</span><span class="p">:</span> <span class="dl">"</span><span class="s2">&lt;%= asset_path('logo.png') %&gt;</span><span class="dl">"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-472fbbad59aaeedaa95b7cf17abb348b">$('#logo').attr src: "&lt;%= asset_path('logo.png') %&gt;"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-472fbbad59aaeedaa95b7cf17abb348b">Copiar</button>
</div>
<h4 id="arquivos-de-manifesto-e-diretivas"><a class="anchorlink" href="#arquivos-de-manifesto-e-diretivas">2.4 Arquivos de Manifesto e Diretivas</a></h4><p>O <em>Sprockets</em> usa arquivos de manifesto para determinar quais <em>assets</em> incluir e servir.
Esses arquivos de manifesto contém <em>diretivas</em> - instruções que dirão ao <em>Sprockets</em>
quais arquivos solicitar para construir um arquivo CSS ou JavaScript único. Com
essas diretivas, o <em>Sprockets</em> carrega os arquivos especificados, processa-os se
necessário, concatena-os com em único arquivo e então comprime-os (baseado no valor
de <code>Rails.application.config.assets.js_compressor</code>). Ao servir um arquivo 
ao invés de muitos, o tempo de carregamento das páginas pode ser amplamente reduzido
porque o navegador faz menos requisições. A compressão também reduz o tamanho dos arquivos,
permitindo ao navegador baixá-los mais rapidamente.</p><p>Por exemplo, com um arquivo <code>app/assets/javascripts/application.js</code> contendo as
seguintes linhas:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// ...</span>
<span class="c1">//= require rails-ujs</span>
<span class="c1">//= require turbolinks</span>
<span class="c1">//= require_tree .</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-be19bb8dfb92656b27f23ba2f9a6b212">// ...
//= require rails-ujs
//= require turbolinks
//= require_tree .
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-be19bb8dfb92656b27f23ba2f9a6b212">Copiar</button>
</div>
<p>Nos arquivos JavaScript, as diretivas do Sprocket começam com <code>//=</code>. No caso acima,
o arquivo está usando as diretivas <code>require</code> e <code>require_tree</code>. A diretiva <code>require</code>
é usada para instruir o <em>Sprockets</em> dos arquivos que você deseja solicitar. Aqui, você
está solicitando os arquivos <code>rails-ujs.js</code> e <code>turbolinks.js</code>, que estão disponíveis em
algum lugar no caminho de busca do <em>Sprockets</em>. Você não precisa informar as extensões
explicitamente. O <em>Sprockets</em> assume que você está solicitando um arquivo <code>.js</code> quando
feito de dentro de um arquivo <code>.js</code>.</p><p>A diretiva <code>require_tree</code> instrui ao <em>Sprockets</em> para recursivamente incluir <em>todos</em>
os arquivos JavaScript no diretório especificado no <em>output</em>. Esses caminhos
deverão ser especificados de maneira relativa ao arquivo de manifesto. Você também
pode usar a diretiva <code>require_directory</code>, que inclui todos os arquivos JavaScript
somente do diretório especificado, sem recursão.</p><p>As diretivas são processadas de cima para baixo, mas a ordem na qual os arquivos
são incluídos pelo <code>require_tree</code> não é garantida. Você não deve confiar em
nenhuma ordem particular entre eles. Se você precisar garantir que um JavaScript
em particular termine acima de outro no arquivo concatenado, solicite o pré-requisito
antes no manifesto. Note que a família de diretivas <code>require</code> previne arquivos de
serem incluídos duas vezes no <em>output</em>.</p><p>O Rails também cria um arquivo padrão <code>app/assets/stylesheets/application.css</code>
que contém essas linhas:</p><div class="code_container">
<pre><code class="highlight css"><span class="c">/* ...
 *= require_self
 *= require_tree .
 */</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7595bc8a5999b1ac05f015a65fb0d96c">/* ...
 *= require_self
 *= require_tree .
 */
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7595bc8a5999b1ac05f015a65fb0d96c">Copiar</button>
</div>
<p>O Rails cria o <code>app/assets/stylesheets/application.css</code> independentemente se
a opção <code>--skip-sprockets</code> é usada ao criar uma nova aplicação Rails. Isso permite
que você facilmente adicione o <em>asset pipelining</em> mais tarde se assim o quiser.</p><p>As diretivas que funcionam nos arquivos JavaScript também funcionam nas folhas de estilo
(que obviamente incluem folhas de estilo além de arquivos JavaScript). A diretiva
<code>require_tree</code> em um manifesto CSS funciona da mesma maneira que no JavaScript,
solicitando todas as folhas de estilo do diretório corrente.</p><p>Nesse exemplo, <code>require_self</code> é usado. Isso coloca o CSS contido dentro do 
arquivo (se houver algum) na localização exata da chamada <code>require_self</code>.</p><div class="note"><p>Se você quiser usar múltiplos arquivos Saas, você deve, via de regra, usar a <a href="https://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#import">regra Sass <code>@import</code></a>
ao invés de usar as diretivas <em>Sprockets</em>. Quando usando as diretivas Saas, arquivos Saas existem dentro de seu próprio
escopo, tornando variáveis ou mixins apenas disponíveis dentro do documento nas quais foram definidas.</p></div><p>Você pode fazer <em>globbing</em> dos arquivos usando <code>@import "*"</code> e <code>@import "**/*"</code> para adicionar a árvore completa, que é equivalente a como o <code>require_tree</code> funciona. Veja a <a href="https://github.com/rails/sass-rails#features">documentação do sass-rails</a> para mais informações e ressalvas importantes.</p><p>Você pode ter quantos arquivos de manifesto quiser. Por exemplo, os manifestos
<code>admin.css</code> e <code>admin.js</code> podem conter os arquivos JS e CSS que são usados pela
seção de <em>admin</em> de uma aplicação.</p><p>As mesmas afirmações sobre ordens feitas acima também se aplicam. Em particular, você
pode especificar arquivos individuais e eles serão compilados na ordem especificada.
Por exemplo, você pode concatenar três arquivos CSS juntos da seguinte maneira:</p><div class="code_container">
<pre><code class="highlight js"><span class="cm">/* ...
 *= require reset
 *= require layout
 *= require chrome
 */</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-13810678c8ebf20045dd86fc7f440cc6">/* ...
 *= require reset
 *= require layout
 *= require chrome
 */
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-13810678c8ebf20045dd86fc7f440cc6">Copiar</button>
</div>
<h4 id="pre-processamento"><a class="anchorlink" href="#pre-processamento">2.5 Pré-processamento</a></h4><p>As extensões de arquivos usadas em um <em>asset</em> determinam qual pré-processamento é aplicado.
Quando um <em>controller</em> ou um <em>scaffold</em> é gerado com o gemset padrão do Rails, um arquivo
SCSS é gerado no lugar de um arquivo comum CSS.
O exemplo usado anteriormente era um <em>controller</em> chamado "<em>projects</em>", que gerou um
arquivo <code>app/assets/stylesheets/projects.scss</code>.</p><p>Em modo de desenvolvimento, se o <em>asset pipeline</em> estiver desabilitado, quando esses
arquivos são solicitados, eles serão processados pelos <em>processors</em> especificados
pela gem <code>sass-rails</code> e então enviados de volta ao navegador como
CSS. Quando o <em>asset pipelining</em> está habilitado, esses
arquivos são pré-processados e colocados no diretório <code>public/assets</code>, para serem servidos
seja pela aplicação Rails ou pelo servidor <em>web</em>.</p><p>Camadas adicionais de pré-processamento podem ser solicitadas ao se adicionar outras extensões,
onde cada extensão é processada da direita para a esquerda. Essas devem ser usadas para que
o processamento seja aplicado. Por exemplo, uma folha de estilos chamada
<code>app/assets/stylesheets/projects.scss.erb</code> é primeiramente processada como ERB,
depois como SCSS e finalmente servida como CSS. O mesmo se aplica a um arquivo JavaScript -
<code>app/assets/javascripts/projects.coffee.erb</code>, que é processado como ERB, depois CoffeeScript
e então servido como JavaScript.</p><p>Tenha em mente que a ordem desses pré-processadores é importante. Por exemplo, se
você chamou seu arquivo JavaScript de <code>app/assets/javascripts/projects.erb.coffee</code>,
então ele seria processado pelo interpretador do CoffeeScript primeiro, que não
entende ERB, o que te causaria problemas.</p><h3 id="in-development"><a class="anchorlink" href="#in-development">3 In Development</a></h3><p>In development mode, assets are served as separate files in the order they are
specified in the manifest file.</p><p>This manifest <code>app/assets/javascripts/application.js</code>:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">//= require core</span>
<span class="c1">//= require projects</span>
<span class="c1">//= require tickets</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-af01126e98dca41670e89bc2dd8d7739">//= require core
//= require projects
//= require tickets
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-af01126e98dca41670e89bc2dd8d7739">Copiar</button>
</div>
<p>would generate this HTML:</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/assets/core.js?body=1"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/assets/projects.js?body=1"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/assets/tickets.js?body=1"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-810fa027231fb437d15e02017bf8e180">&lt;script src="/assets/core.js?body=1"&gt;&lt;/script&gt;
&lt;script src="/assets/projects.js?body=1"&gt;&lt;/script&gt;
&lt;script src="/assets/tickets.js?body=1"&gt;&lt;/script&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-810fa027231fb437d15e02017bf8e180">Copiar</button>
</div>
<p>The <code>body</code> param is required by Sprockets.</p><h4 id="raise-an-error-when-an-asset-is-not-found"><a class="anchorlink" href="#raise-an-error-when-an-asset-is-not-found">3.1 Raise an Error When an Asset is Not Found</a></h4><p>If you are using sprockets-rails &gt;= 3.2.0 you can configure what happens
when an asset lookup is performed and nothing is found. If you turn off "asset fallback"
then an error will be raised when an asset cannot be found.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">unknown_asset_fallback</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d10be47f6f22d91d8e3fd99ba14cc3f5">config.assets.unknown_asset_fallback = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d10be47f6f22d91d8e3fd99ba14cc3f5">Copiar</button>
</div>
<p>If "asset fallback" is enabled then when an asset cannot be found the path will be
output instead and no error raised. The asset fallback behavior is disabled by default.</p><h4 id="turning-digests-off"><a class="anchorlink" href="#turning-digests-off">3.2 Turning Digests Off</a></h4><p>You can turn off digests by updating <code>config/environments/development.rb</code> to
include:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f7f22c5e0cc037750061542760e2c274">config.assets.digest = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f7f22c5e0cc037750061542760e2c274">Copiar</button>
</div>
<p>When this option is true, digests will be generated for asset URLs.</p><h4 id="turning-debugging-off"><a class="anchorlink" href="#turning-debugging-off">3.3 Turning Debugging Off</a></h4><p>You can turn off debug mode by updating <code>config/environments/development.rb</code> to
include:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-eb5c352614bf177f9bf83f56f9f88105">config.assets.debug = false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-eb5c352614bf177f9bf83f56f9f88105">Copiar</button>
</div>
<p>When debug mode is off, Sprockets concatenates and runs the necessary
preprocessors on all files. With debug mode turned off the manifest above would
generate instead:</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/assets/application.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1df4bf638406849c0812c2fd969860bd">&lt;script src="/assets/application.js"&gt;&lt;/script&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1df4bf638406849c0812c2fd969860bd">Copiar</button>
</div>
<p>Assets are compiled and cached on the first request after the server is started.
Sprockets sets a <code>must-revalidate</code> Cache-Control HTTP header to reduce request
overhead on subsequent requests - on these the browser gets a 304 (Not Modified)
response.</p><p>If any of the files in the manifest have changed between requests, the server
responds with a new compiled file.</p><p>Debug mode can also be enabled in Rails helper methods:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">debug: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">debug: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f70be37ca73bddb6ccdc1e8eaa0aa561">&lt;%= stylesheet_link_tag "application", debug: true %&gt;
&lt;%= javascript_include_tag "application", debug: true %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f70be37ca73bddb6ccdc1e8eaa0aa561">Copiar</button>
</div>
<p>The <code>:debug</code> option is redundant if debug mode is already on.</p><p>You can also enable compression in development mode as a sanity check, and
disable it on-demand as required for debugging.</p><h3 id="in-production"><a class="anchorlink" href="#in-production">4 In Production</a></h3><p>In the production environment Sprockets uses the fingerprinting scheme outlined
above. By default Rails assumes assets have been precompiled and will be
served as static assets by your web server.</p><p>During the precompilation phase an SHA256 is generated from the contents of the
compiled files, and inserted into the filenames as they are written to disk.
These fingerprinted names are used by the Rails helpers in place of the manifest
name.</p><p>For example this:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-94efa4ed7294b394a680825ea0f2964f">&lt;%= javascript_include_tag "application" %&gt;
&lt;%= stylesheet_link_tag "application" %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-94efa4ed7294b394a680825ea0f2964f">Copiar</button>
</div>
<p>generates something like this:</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/assets/application-908e25f4bf641868d8683022a5b62f54.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"/assets/application-4dd5b109ee3439da54f5bdfd78a80473.css"</span> <span class="na">media=</span><span class="s">"screen"</span>
<span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="nt">/&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c025e97fd4a5a649f90075faee96fb4d">&lt;script src="/assets/application-908e25f4bf641868d8683022a5b62f54.js"&gt;&lt;/script&gt;
&lt;link href="/assets/application-4dd5b109ee3439da54f5bdfd78a80473.css" media="screen"
rel="stylesheet" /&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c025e97fd4a5a649f90075faee96fb4d">Copiar</button>
</div>
<div class="note"><p>with the Asset Pipeline the <code>:cache</code> and <code>:concat</code> options aren't used
anymore, delete these options from the <code>javascript_include_tag</code> and
<code>stylesheet_link_tag</code>.</p></div><p>The fingerprinting behavior is controlled by the <code>config.assets.digest</code>
initialization option (which defaults to <code>true</code>).</p><div class="note"><p>Under normal circumstances the default <code>config.assets.digest</code> option
should not be changed. If there are no digests in the filenames, and far-future
headers are set, remote clients will never know to refetch the files when their
content changes.</p></div><h4 id="precompiling-assets"><a class="anchorlink" href="#precompiling-assets">4.1 Precompiling Assets</a></h4><p>Rails comes bundled with a command to compile the asset manifests and other
files in the pipeline.</p><p>Compiled assets are written to the location specified in <code>config.assets.prefix</code>.
By default, this is the <code>/assets</code> directory.</p><p>You can call this command on the server during deployment to create compiled
versions of your assets directly on the server. See the next section for
information on compiling locally.</p><p>The command is:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nv">RAILS_ENV</span><span class="o">=</span>production <span class="nb">rails </span>assets:precompile
</code></pre>
<textarea class="clipboard-content" id="clipboard-79a20ce07dc4119e935fffe8455c81af">RAILS_ENV=production rails assets:precompile
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-79a20ce07dc4119e935fffe8455c81af">Copiar</button>
</div>
<p>This links the folder specified in <code>config.assets.prefix</code> to <code>shared/assets</code>.
If you already use this shared folder you'll need to write your own deployment
command.</p><p>It is important that this folder is shared between deployments so that remotely
cached pages referencing the old compiled assets still work for the life of
the cached page.</p><p>The default matcher for compiling files includes <code>application.js</code>,
<code>application.css</code> and all non-JS/CSS files (this will include all image assets
automatically) from <code>app/assets</code> folders including your gems:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="p">[</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">filename</span><span class="p">,</span> <span class="n">path</span><span class="o">|</span> <span class="n">path</span> <span class="o">=~</span> <span class="sr">/app\/assets/</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sx">%w(.js .css)</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">extname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="p">},</span>
<span class="sr">/application.(css|js)$/</span> <span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ae522f9a4e46c1ca82a8c064917521c1">[ Proc.new { |filename, path| path =~ /app\/assets/ &amp;&amp; !%w(.js .css).include?(File.extname(filename)) },
/application.(css|js)$/ ]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ae522f9a4e46c1ca82a8c064917521c1">Copiar</button>
</div>
<div class="note"><p>The matcher (and other members of the precompile array; see below) is
applied to final compiled file names. This means anything that compiles to
JS/CSS is excluded, as well as raw JS/CSS files; for example, <code>.coffee</code> and
<code>.scss</code> files are <strong>not</strong> automatically included as they compile to JS/CSS.</p></div><p>If you have other manifests or individual stylesheets and JavaScript files to
include, you can add them to the <code>precompile</code> array in <code>config/initializers/assets.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">precompile</span> <span class="o">+=</span> <span class="sx">%w( admin.js admin.css )</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b1f06afa3b5ece33df5a23733490f5fe">Rails.application.config.assets.precompile += %w( admin.js admin.css )
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b1f06afa3b5ece33df5a23733490f5fe">Copiar</button>
</div>
<div class="note"><p>Always specify an expected compiled filename that ends with <code>.js</code> or <code>.css</code>,
even if you want to add Sass or CoffeeScript files to the precompile array.</p></div><p>The command also generates a <code>.sprockets-manifest-randomhex.json</code> (where <code>randomhex</code> is
a 16-byte random hex string) that contains a list with all your assets and their respective
fingerprints. This is used by the Rails helper methods to avoid handing the
mapping requests back to Sprockets. A typical manifest file looks like:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="p">{</span><span class="s2">"files"</span><span class="p">:{</span><span class="s2">"application-aee4be71f1288037ae78b997df388332edfd246471b533dcedaa8f9fe156442b.js"</span><span class="p">:{</span><span class="s2">"logical_path"</span><span class="ss">:"application.js"</span><span class="p">,</span><span class="s2">"mtime"</span><span class="ss">:"2016-12-23T20:12:03-05:00"</span><span class="p">,</span><span class="s2">"size"</span><span class="p">:</span><span class="mi">412383</span><span class="p">,</span>
<span class="s2">"digest"</span><span class="ss">:"aee4be71f1288037ae78b997df388332edfd246471b533dcedaa8f9fe156442b"</span><span class="p">,</span><span class="s2">"integrity"</span><span class="ss">:"sha256-ruS+cfEogDeueLmX3ziDMu39JGRxtTPc7aqPn+FWRCs="</span><span class="p">},</span>
<span class="s2">"application-86a292b5070793c37e2c0e5f39f73bb387644eaeada7f96e6fc040a028b16c18.css"</span><span class="p">:{</span><span class="s2">"logical_path"</span><span class="ss">:"application.css"</span><span class="p">,</span><span class="s2">"mtime"</span><span class="ss">:"2016-12-23T19:12:20-05:00"</span><span class="p">,</span><span class="s2">"size"</span><span class="p">:</span><span class="mi">2994</span><span class="p">,</span>
<span class="s2">"digest"</span><span class="ss">:"86a292b5070793c37e2c0e5f39f73bb387644eaeada7f96e6fc040a028b16c18"</span><span class="p">,</span><span class="s2">"integrity"</span><span class="ss">:"sha256-hqKStQcHk8N+LA5fOfc7s4dkTq6tp/lub8BAoCixbBg="</span><span class="p">},</span>
<span class="s2">"favicon-8d2387b8d4d32cecd93fa3900df0e9ff89d01aacd84f50e780c17c9f6b3d0eda.ico"</span><span class="p">:{</span><span class="s2">"logical_path"</span><span class="ss">:"favicon.ico"</span><span class="p">,</span><span class="s2">"mtime"</span><span class="ss">:"2016-12-23T20:11:00-05:00"</span><span class="p">,</span><span class="s2">"size"</span><span class="p">:</span><span class="mi">8629</span><span class="p">,</span>
<span class="s2">"digest"</span><span class="ss">:"8d2387b8d4d32cecd93fa3900df0e9ff89d01aacd84f50e780c17c9f6b3d0eda"</span><span class="p">,</span><span class="s2">"integrity"</span><span class="ss">:"sha256-jSOHuNTTLOzZP6OQDfDp/4nQGqzYT1DngMF8n2s9Dto="</span><span class="p">},</span>
<span class="s2">"my_image-f4028156fd7eca03584d5f2fc0470df1e0dbc7369eaae638b2ff033f988ec493.png"</span><span class="p">:{</span><span class="s2">"logical_path"</span><span class="ss">:"my_image.png"</span><span class="p">,</span><span class="s2">"mtime"</span><span class="ss">:"2016-12-23T20:10:54-05:00"</span><span class="p">,</span><span class="s2">"size"</span><span class="p">:</span><span class="mi">23414</span><span class="p">,</span>
<span class="s2">"digest"</span><span class="ss">:"f4028156fd7eca03584d5f2fc0470df1e0dbc7369eaae638b2ff033f988ec493"</span><span class="p">,</span><span class="s2">"integrity"</span><span class="ss">:"sha256-9AKBVv1+ygNYTV8vwEcN8eDbxzaequY4sv8DP5iOxJM="</span><span class="p">}},</span>
<span class="s2">"assets"</span><span class="p">:{</span><span class="s2">"application.js"</span><span class="ss">:"application-aee4be71f1288037ae78b997df388332edfd246471b533dcedaa8f9fe156442b.js"</span><span class="p">,</span>
<span class="s2">"application.css"</span><span class="ss">:"application-86a292b5070793c37e2c0e5f39f73bb387644eaeada7f96e6fc040a028b16c18.css"</span><span class="p">,</span>
<span class="s2">"favicon.ico"</span><span class="ss">:"favicon-8d2387b8d4d32cecd93fa3900df0e9ff89d01aacd84f50e780c17c9f6b3d0eda.ico"</span><span class="p">,</span>
<span class="s2">"my_image.png"</span><span class="ss">:"my_image-f4028156fd7eca03584d5f2fc0470df1e0dbc7369eaae638b2ff033f988ec493.png"</span><span class="p">}}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-976bc68b5a9a4ca634cf8ad5e52eb858">{"files":{"application-aee4be71f1288037ae78b997df388332edfd246471b533dcedaa8f9fe156442b.js":{"logical_path":"application.js","mtime":"2016-12-23T20:12:03-05:00","size":412383,
"digest":"aee4be71f1288037ae78b997df388332edfd246471b533dcedaa8f9fe156442b","integrity":"sha256-ruS+cfEogDeueLmX3ziDMu39JGRxtTPc7aqPn+FWRCs="},
"application-86a292b5070793c37e2c0e5f39f73bb387644eaeada7f96e6fc040a028b16c18.css":{"logical_path":"application.css","mtime":"2016-12-23T19:12:20-05:00","size":2994,
"digest":"86a292b5070793c37e2c0e5f39f73bb387644eaeada7f96e6fc040a028b16c18","integrity":"sha256-hqKStQcHk8N+LA5fOfc7s4dkTq6tp/lub8BAoCixbBg="},
"favicon-8d2387b8d4d32cecd93fa3900df0e9ff89d01aacd84f50e780c17c9f6b3d0eda.ico":{"logical_path":"favicon.ico","mtime":"2016-12-23T20:11:00-05:00","size":8629,
"digest":"8d2387b8d4d32cecd93fa3900df0e9ff89d01aacd84f50e780c17c9f6b3d0eda","integrity":"sha256-jSOHuNTTLOzZP6OQDfDp/4nQGqzYT1DngMF8n2s9Dto="},
"my_image-f4028156fd7eca03584d5f2fc0470df1e0dbc7369eaae638b2ff033f988ec493.png":{"logical_path":"my_image.png","mtime":"2016-12-23T20:10:54-05:00","size":23414,
"digest":"f4028156fd7eca03584d5f2fc0470df1e0dbc7369eaae638b2ff033f988ec493","integrity":"sha256-9AKBVv1+ygNYTV8vwEcN8eDbxzaequY4sv8DP5iOxJM="}},
"assets":{"application.js":"application-aee4be71f1288037ae78b997df388332edfd246471b533dcedaa8f9fe156442b.js",
"application.css":"application-86a292b5070793c37e2c0e5f39f73bb387644eaeada7f96e6fc040a028b16c18.css",
"favicon.ico":"favicon-8d2387b8d4d32cecd93fa3900df0e9ff89d01aacd84f50e780c17c9f6b3d0eda.ico",
"my_image.png":"my_image-f4028156fd7eca03584d5f2fc0470df1e0dbc7369eaae638b2ff033f988ec493.png"}}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-976bc68b5a9a4ca634cf8ad5e52eb858">Copiar</button>
</div>
<p>The default location for the manifest is the root of the location specified in
<code>config.assets.prefix</code> ('/assets' by default).</p><div class="note"><p>If there are missing precompiled files in production you will get a
<code>Sprockets::Helpers::RailsHelper::AssetPaths::AssetNotPrecompiledError</code>
exception indicating the name of the missing file(s).</p></div><h5 id="far-future-expires-header"><a class="anchorlink" href="#far-future-expires-header">4.1.1 Far-future Expires Header</a></h5><p>Precompiled assets exist on the file system and are served directly by your web
server. They do not have far-future headers by default, so to get the benefit of
fingerprinting you'll have to update your server configuration to add those
headers.</p><p>For Apache:</p><div class="code_container">
<pre><code class="highlight apache"><span class="c"># The Expires* directives requires the Apache module</span>
<span class="c"># `mod_expires` to be enabled.</span>
<span class="p">&lt;</span><span class="nl">Location</span><span class="sr"> /assets/</span><span class="p">&gt;
</span>  <span class="c"># Use of ETag is discouraged when Last-Modified is present</span>
  <span class="nc">Header</span> <span class="ss">unset</span> ETag
  <span class="nc">FileETag</span> <span class="ss">None</span>
  <span class="c"># RFC says only cache for 1 year</span>
  <span class="nc">ExpiresActive</span> <span class="ss">On</span>
  <span class="nc">ExpiresDefault</span> "access plus 1 year"
<span class="p">&lt;/</span><span class="nl">Location</span><span class="p">&gt;
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-4cf6c8e8aea5e519aa608eb795cd9175"># The Expires* directives requires the Apache module
# `mod_expires` to be enabled.
&lt;Location /assets/&gt;
  # Use of ETag is discouraged when Last-Modified is present
  Header unset ETag
  FileETag None
  # RFC says only cache for 1 year
  ExpiresActive On
  ExpiresDefault "access plus 1 year"
&lt;/Location&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4cf6c8e8aea5e519aa608eb795cd9175">Copiar</button>
</div>
<p>For NGINX:</p><div class="code_container">
<pre><code class="highlight nginx"><span class="k">location</span> <span class="p">~</span> <span class="sr">^/assets/</span> <span class="p">{</span>
  <span class="kn">expires</span> <span class="s">1y</span><span class="p">;</span>
  <span class="kn">add_header</span> <span class="s">Cache-Control</span> <span class="s">public</span><span class="p">;</span>

  <span class="kn">add_header</span> <span class="s">ETag</span> <span class="s">""</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fcda4718b82edbc9b026b34ef475b015">location ~ ^/assets/ {
  expires 1y;
  add_header Cache-Control public;

  add_header ETag "";
}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fcda4718b82edbc9b026b34ef475b015">Copiar</button>
</div>
<h4 id="local-precompilation"><a class="anchorlink" href="#local-precompilation">4.2 Local Precompilation</a></h4><p>Sometimes, you may not want or be able to compile assets on the production
server. For instance, you may have limited write access to your production
filesystem, or you may plan to deploy frequently without making any changes to
your assets.</p><p>In such cases, you can precompile assets <em>locally</em> — that is, add a finalized
set of compiled, production-ready assets to your source code repository before
pushing to production. This way, they do not need to be precompiled separately
on the production server upon each deployment.</p><p>As above, you can perform this step using</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nv">RAILS_ENV</span><span class="o">=</span>production <span class="nb">rails </span>assets:precompile
</code></pre>
<textarea class="clipboard-content" id="clipboard-e1af898ede52a4e21919e2907d49687f">RAILS_ENV=production rails assets:precompile
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e1af898ede52a4e21919e2907d49687f">Copiar</button>
</div>
<p>Note the following caveats:</p>
<ul>
<li>
<p>  If precompiled assets are available, they will be served — even if they no
longer match the original (uncompiled) assets, <em>even on the development
server.</em></p>
<p>To ensure that the development server always compiles assets on-the-fly (and
thus always reflects the most recent state of the code), the development
environment <em>must be configured to keep precompiled assets in a different
location than production does.</em> Otherwise, any assets precompiled for use in
production will clobber requests for them in development (<em>i.e.,</em> subsequent
changes you make to assets will not be reflected in the browser).</p>
<p>You can do this by adding the following line to
<code>config/environments/development.rb</code>:</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s2">"/dev-assets"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1fbc54cd9212a02308903095fe393734">config.assets.prefix = "/dev-assets"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1fbc54cd9212a02308903095fe393734">Copiar</button>
</div>
</li>
<li><p>The asset precompile task in your deployment tool (<em>e.g.,</em> Capistrano) should
be disabled.</p></li>
<li><p>Any necessary compressors or minifiers must be available on your development
system.</p></li>
</ul>
<h4 id="live-compilation"><a class="anchorlink" href="#live-compilation">4.3 Live Compilation</a></h4><p>In some circumstances you may wish to use live compilation. In this mode all
requests for assets in the pipeline are handled by Sprockets directly.</p><p>To enable this option set:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-49517245209ffe2f50ea7e8b3299e394">config.assets.compile = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-49517245209ffe2f50ea7e8b3299e394">Copiar</button>
</div>
<p>On the first request the assets are compiled and cached as outlined in <a href="#assets-cache-store">Assets
Cache Store</a>, and the manifest names used in the helpers
are altered to include the SHA256 hash.</p><p>Sprockets also sets the <code>Cache-Control</code> HTTP header to <code>max-age=31536000</code>. This
signals all caches between your server and the client browser that this content
(the file served) can be cached for 1 year. The effect of this is to reduce the
number of requests for this asset from your server; the asset has a good chance
of being in the local browser cache or some intermediate cache.</p><p>This mode uses more memory, performs more poorly than the default, and is not
recommended.</p><p>If you are deploying a production application to a system without any
pre-existing JavaScript runtimes, you may want to add one to your <code>Gemfile</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'mini_racer'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ce2b4678bac0f62fa12beebaad8716e1">group :production do
  gem 'mini_racer'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ce2b4678bac0f62fa12beebaad8716e1">Copiar</button>
</div>
<h4 id="cdns"><a class="anchorlink" href="#cdns">4.4 CDNs</a></h4><p>CDN stands for <a href="https://en.wikipedia.org/wiki/Content_delivery_network">Content Delivery
Network</a>, they are
primarily designed to cache assets all over the world so that when a browser
requests the asset, a cached copy will be geographically close to that browser.
If you are serving assets directly from your Rails server in production, the
best practice is to use a CDN in front of your application.</p><p>A common pattern for using a CDN is to set your production application as the
"origin" server. This means when a browser requests an asset from the CDN and
there is a cache miss, it will grab the file from your server on the fly and
then cache it. For example if you are running a Rails application on
<code>example.com</code> and have a CDN configured at <code>mycdnsubdomain.fictional-cdn.com</code>,
then when a request is made to <code>mycdnsubdomain.fictional-
cdn.com/assets/smile.png</code>, the CDN will query your server once at
<code>example.com/assets/smile.png</code> and cache the request. The next request to the
CDN that comes in to the same URL will hit the cached copy. When the CDN can
serve an asset directly the request never touches your Rails server. Since the
assets from a CDN are geographically closer to the browser, the request is
faster, and since your server doesn't need to spend time serving assets, it can
focus on serving application code as fast as possible.</p><h5 id="set-up-a-cdn-to-serve-static-assets"><a class="anchorlink" href="#set-up-a-cdn-to-serve-static-assets">4.4.1 Set up a CDN to Serve Static Assets</a></h5><p>To set up your CDN you have to have your application running in production on
the internet at a publicly available URL, for example <code>example.com</code>. Next
you'll need to sign up for a CDN service from a cloud hosting provider. When you
do this you need to configure the "origin" of the CDN to point back at your
website <code>example.com</code>, check your provider for documentation on configuring the
origin server.</p><p>The CDN you provisioned should give you a custom subdomain for your application
such as <code>mycdnsubdomain.fictional-cdn.com</code> (note fictional-cdn.com is not a
valid CDN provider at the time of this writing). Now that you have configured
your CDN server, you need to tell browsers to use your CDN to grab assets
instead of your Rails server directly. You can do this by configuring Rails to
set your CDN as the asset host instead of using a relative path. To set your
asset host in Rails, you need to set <code>config.asset_host</code> in
<code>config/environments/production.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">asset_host</span> <span class="o">=</span> <span class="s1">'mycdnsubdomain.fictional-cdn.com'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2d3b9d9bfc68b316481e1cfda2d16246">config.asset_host = 'mycdnsubdomain.fictional-cdn.com'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2d3b9d9bfc68b316481e1cfda2d16246">Copiar</button>
</div>
<div class="note"><p>You only need to provide the "host", this is the subdomain and root
domain, you do not need to specify a protocol or "scheme" such as <code>http://</code> or
<code>https://</code>. When a web page is requested, the protocol in the link to your asset
that is generated will match how the webpage is accessed by default.</p></div><p>You can also set this value through an <a href="https://en.wikipedia.org/wiki/Environment_variable">environment
variable</a> to make running a
staging copy of your site easier:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">asset_host</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'CDN_HOST'</span><span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-83fda5834beefce5be223ea6836b717c">config.asset_host = ENV['CDN_HOST']
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-83fda5834beefce5be223ea6836b717c">Copiar</button>
</div>
<div class="note"><p>You would need to set <code>CDN_HOST</code> on your server to <code>mycdnsubdomain
.fictional-cdn.com</code> for this to work.</p></div><p>Once you have configured your server and your CDN when you serve a webpage that
has an asset:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">asset_path</span><span class="p">(</span><span class="s1">'smile.png'</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c5e6da5ce8233e3f7d49219443b0ca30">&lt;%= asset_path('smile.png') %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c5e6da5ce8233e3f7d49219443b0ca30">Copiar</button>
</div>
<p>Instead of returning a path such as <code>/assets/smile.png</code> (digests are left out
for readability). The URL generated will have the full path to your CDN.</p><div class="code_container">
<pre><code class="highlight plaintext">http://mycdnsubdomain.fictional-cdn.com/assets/smile.png
</code></pre>
<textarea class="clipboard-content" id="clipboard-41439c0caa9c0ba5a9fa39bd0d9f7a49">http://mycdnsubdomain.fictional-cdn.com/assets/smile.png
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-41439c0caa9c0ba5a9fa39bd0d9f7a49">Copiar</button>
</div>
<p>If the CDN has a copy of <code>smile.png</code> it will serve it to the browser and your
server doesn't even know it was requested. If the CDN does not have a copy it
will try to find it at the "origin" <code>example.com/assets/smile.png</code> and then store
it for future use.</p><p>If you want to serve only some assets from your CDN, you can use custom <code>:host</code>
option your asset helper, which overwrites value set in
<code>config.action_controller.asset_host</code>.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">asset_path</span> <span class="s1">'image.png'</span><span class="p">,</span> <span class="ss">host: </span><span class="s1">'mycdnsubdomain.fictional-cdn.com'</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9cc0e1a9b774d96567c356f456f89c7a">&lt;%= asset_path 'image.png', host: 'mycdnsubdomain.fictional-cdn.com' %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9cc0e1a9b774d96567c356f456f89c7a">Copiar</button>
</div>
<h5 id="customize-cdn-caching-behavior"><a class="anchorlink" href="#customize-cdn-caching-behavior">4.4.2 Customize CDN Caching Behavior</a></h5><p>A CDN works by caching content. If the CDN has stale or bad content, then it is
hurting rather than helping your application. The purpose of this section is to
describe general caching behavior of most CDNs, your specific provider may
behave slightly differently.</p><h6 id="cdn-request-caching"><a class="anchorlink" href="#cdn-request-caching">4.4.2.1 CDN Request Caching</a></h6><p>While a CDN is described as being good for caching assets, in reality caches the
entire request. This includes the body of the asset as well as any headers. The
most important one being <code>Cache-Control</code> which tells the CDN (and web browsers)
how to cache contents. This means that if someone requests an asset that does
not exist <code>/assets/i-dont-exist.png</code> and your Rails application returns a 404,
then your CDN will likely cache the 404 page if a valid <code>Cache-Control</code> header
is present.</p><h6 id="cdn-header-debugging"><a class="anchorlink" href="#cdn-header-debugging">4.4.2.2 CDN Header Debugging</a></h6><p>One way to check the headers are cached properly in your CDN is by using <a href="https://explainshell.com/explain?cmd=curl+-I+http%3A%2F%2Fwww.example.com">curl</a>. You
can request the headers from both your server and your CDN to verify they are
the same:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-I</span> http://www.example/assets/application-
<span class="go">d0e099e021c95eb0de3615fd1d8c4d83.css
HTTP/1.1 200 OK
Server: Cowboy
Date: Sun, 24 Aug 2014 20:27:50 GMT
Connection: keep-alive
Last-Modified: Thu, 08 May 2014 01:24:14 GMT
Content-Type: text/css
Cache-Control: public, max-age=2592000
Content-Length: 126560
Via: 1.1 vegur
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-bb8ee6b72dc34f543efbf90bed9b1967">curl -I http://www.example/assets/application-
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb8ee6b72dc34f543efbf90bed9b1967">Copiar</button>
</div>
<p>Versus the CDN copy.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-I</span> http://mycdnsubdomain.fictional-cdn.com/application-
<span class="go">d0e099e021c95eb0de3615fd1d8c4d83.css
HTTP/1.1 200 OK Server: Cowboy Last-
Modified: Thu, 08 May 2014 01:24:14 GMT Content-Type: text/css
Cache-Control:
public, max-age=2592000
Via: 1.1 vegur
Content-Length: 126560
Accept-Ranges:
bytes
Date: Sun, 24 Aug 2014 20:28:45 GMT
Via: 1.1 varnish
Age: 885814
Connection: keep-alive
X-Served-By: cache-dfw1828-DFW
X-Cache: HIT
X-Cache-Hits:
68
X-Timer: S1408912125.211638212,VS0,VE0
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-baa541d4272af05ee3fea81258085198">curl -I http://mycdnsubdomain.fictional-cdn.com/application-
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-baa541d4272af05ee3fea81258085198">Copiar</button>
</div>
<p>Check your CDN documentation for any additional information they may provide
such as <code>X-Cache</code> or for any additional headers they may add.</p><h6 id="cdns-and-the-cache-control-header"><a class="anchorlink" href="#cdns-and-the-cache-control-header">4.4.2.3 CDNs and the Cache-Control Header</a></h6><p>The <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9">cache control
header</a> is a W3C
specification that describes how a request can be cached. When no CDN is used, a
browser will use this information to cache contents. This is very helpful for
assets that are not modified so that a browser does not need to re-download a
website's CSS or JavaScript on every request. Generally we want our Rails server
to tell our CDN (and browser) that the asset is "public", that means any cache
can store the request. Also we commonly want to set <code>max-age</code> which is how long
the cache will store the object before invalidating the cache. The <code>max-age</code>
value is set to seconds with a maximum possible value of <code>31536000</code> which is one
year. You can do this in your Rails application by setting</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'Cache-Control'</span> <span class="o">=&gt;</span> <span class="s1">'public, max-age=31536000'</span>
<span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-17c0e6a89f004ba93b53c4c7d42459bd">config.public_file_server.headers = {
  'Cache-Control' =&gt; 'public, max-age=31536000'
}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-17c0e6a89f004ba93b53c4c7d42459bd">Copiar</button>
</div>
<p>Now when your application serves an asset in production, the CDN will store the
asset for up to a year. Since most CDNs also cache headers of the request, this
<code>Cache-Control</code> will be passed along to all future browsers seeking this asset,
the browser then knows that it can store this asset for a very long time before
needing to re-request it.</p><h6 id="cdns-and-url-based-cache-invalidation"><a class="anchorlink" href="#cdns-and-url-based-cache-invalidation">4.4.2.4 CDNs and URL based Cache Invalidation</a></h6><p>Most CDNs will cache contents of an asset based on the complete URL. This means
that a request to</p><div class="code_container">
<pre><code class="highlight plaintext">http://mycdnsubdomain.fictional-cdn.com/assets/smile-123.png
</code></pre>
<textarea class="clipboard-content" id="clipboard-f41fe4b07a963b77dc89804de85c26a5">http://mycdnsubdomain.fictional-cdn.com/assets/smile-123.png
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f41fe4b07a963b77dc89804de85c26a5">Copiar</button>
</div>
<p>Will be a completely different cache from</p><div class="code_container">
<pre><code class="highlight plaintext">http://mycdnsubdomain.fictional-cdn.com/assets/smile.png
</code></pre>
<textarea class="clipboard-content" id="clipboard-2119b2b43096f6af3d252a389ea575c7">http://mycdnsubdomain.fictional-cdn.com/assets/smile.png
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2119b2b43096f6af3d252a389ea575c7">Copiar</button>
</div>
<p>If you want to set far future <code>max-age</code> in your <code>Cache-Control</code> (and you do),
then make sure when you change your assets that your cache is invalidated. For
example when changing the smiley face in an image from yellow to blue, you want
all visitors of your site to get the new blue face. When using a CDN with the
Rails asset pipeline <code>config.assets.digest</code> is set to true by default so that
each asset will have a different file name when it is changed. This way you
don't have to ever manually invalidate any items in your cache. By using a
different unique asset name instead, your users get the latest asset.</p><h3 id="customizing-the-pipeline"><a class="anchorlink" href="#customizing-the-pipeline">5 Customizing the Pipeline</a></h3><h4 id="css-compression"><a class="anchorlink" href="#css-compression">5.1 CSS Compression</a></h4><p>One of the options for compressing CSS is YUI. The <a href="https://yui.github.io/yuicompressor/css.html">YUI CSS
compressor</a> provides
minification.</p><p>The following line enables YUI compression, and requires the <code>yui-compressor</code>
gem.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">css_compressor</span> <span class="o">=</span> <span class="ss">:yui</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-371e878dc885467d76855cdd7ea7ab9e">config.assets.css_compressor = :yui
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-371e878dc885467d76855cdd7ea7ab9e">Copiar</button>
</div>
<p>The other option for compressing CSS if you have the sass-rails gem installed is</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">css_compressor</span> <span class="o">=</span> <span class="ss">:sass</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-76b8a3f16ff0cfa9096966c6ec4c1bcf">config.assets.css_compressor = :sass
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-76b8a3f16ff0cfa9096966c6ec4c1bcf">Copiar</button>
</div>
<h4 id="javascript-compression"><a class="anchorlink" href="#javascript-compression">5.2 JavaScript Compression</a></h4><p>Possible options for JavaScript compression are <code>:closure</code>, <code>:uglifier</code> and
<code>:yui</code>. These require the use of the <code>closure-compiler</code>, <code>uglifier</code> or
<code>yui-compressor</code> gems, respectively.</p><p>Take the <code>uglifier</code> gem, for example.
This gem wraps <a href="https://github.com/mishoo/UglifyJS">UglifyJS</a> (written for
NodeJS) in Ruby. It compresses your code by removing white space and comments,
shortening local variable names, and performing other micro-optimizations such
as changing <code>if</code> and <code>else</code> statements to ternary operators where possible.</p><p>The following line invokes <code>uglifier</code> for JavaScript compression.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:uglifier</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e97e0c709bd5ba9fd767bca6e73d82eb">config.assets.js_compressor = :uglifier
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e97e0c709bd5ba9fd767bca6e73d82eb">Copiar</button>
</div>
<div class="note"><p>You will need an <a href="https://github.com/rails/execjs#readme">ExecJS</a>
supported runtime in order to use <code>uglifier</code>. If you are using macOS or
Windows you have a JavaScript runtime installed in your operating system.</p></div><h4 id="gzipping-your-assets"><a class="anchorlink" href="#gzipping-your-assets">5.3 GZipping your assets</a></h4><p>By default, gzipped version of compiled assets will be generated, along with
the non-gzipped version of assets. Gzipped assets help reduce the transmission
of data over the wire. You can configure this by setting the <code>gzip</code> flag.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">gzip</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># disable gzipped assets generation</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1fcf7fc16b914bc82529a926c7434a0c">config.assets.gzip = false # disable gzipped assets generation
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1fcf7fc16b914bc82529a926c7434a0c">Copiar</button>
</div>
<p>Refer to your web server's documentation for instructions on how to serve gzipped assets.</p><h4 id="using-your-own-compressor"><a class="anchorlink" href="#using-your-own-compressor">5.4 Using Your Own Compressor</a></h4><p>The compressor config settings for CSS and JavaScript also take any object.
This object must have a <code>compress</code> method that takes a string as the sole
argument and it must return a string.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Transformer</span>
  <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">do_something_returning_a_string</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6c1d01f212ca7acebe1fc51309ecd098">class Transformer
  def compress(string)
    do_something_returning_a_string(string)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6c1d01f212ca7acebe1fc51309ecd098">Copiar</button>
</div>
<p>To enable this, pass a new object to the config option in <code>application.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">css_compressor</span> <span class="o">=</span> <span class="no">Transformer</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d16fd42acf5eaf27a2ac703046fcd5bb">config.assets.css_compressor = Transformer.new
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d16fd42acf5eaf27a2ac703046fcd5bb">Copiar</button>
</div>
<h4 id="changing-the-assets-path"><a class="anchorlink" href="#changing-the-assets-path">5.5 Changing the <em>assets</em> Path</a></h4><p>The public path that Sprockets uses by default is <code>/assets</code>.</p><p>This can be changed to something else:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s2">"/some_other_path"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ac1a868e946f4dce4febd26204c98863">config.assets.prefix = "/some_other_path"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ac1a868e946f4dce4febd26204c98863">Copiar</button>
</div>
<p>This is a handy option if you are updating an older project that didn't use the
asset pipeline and already uses this path or you wish to use this path for
a new resource.</p><h4 id="x-sendfile-headers"><a class="anchorlink" href="#x-sendfile-headers">5.6 X-Sendfile Headers</a></h4><p>The X-Sendfile header is a directive to the web server to ignore the response
from the application, and instead serve a specified file from disk. This option
is off by default, but can be enabled if your server supports it. When enabled,
this passes responsibility for serving the file to the web server, which is
faster. Have a look at <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionController/DataStreaming.html#method-i-send_file">send_file</a>
on how to use this feature.</p><p>Apache and NGINX support this option, which can be enabled in
<code>config/environments/production.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config.action_dispatch.x_sendfile_header = "X-Sendfile" # for Apache</span>
<span class="c1"># config.action_dispatch.x_sendfile_header = 'X-Accel-Redirect' # for NGINX</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-67a54a28fa781e98cfc5622ab0af20b9"># config.action_dispatch.x_sendfile_header = "X-Sendfile" # for Apache
# config.action_dispatch.x_sendfile_header = 'X-Accel-Redirect' # for NGINX
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-67a54a28fa781e98cfc5622ab0af20b9">Copiar</button>
</div>
<div class="warning"><p>If you are upgrading an existing application and intend to use this
option, take care to paste this configuration option only into <code>production.rb</code>
and any other environments you define with production behavior (not
<code>application.rb</code>).</p></div><div class="info"><p>For further details have a look at the docs of your production web server:
- <a href="https://tn123.org/mod_xsendfile/">Apache</a>
- <a href="https://www.nginx.com/resources/wiki/start/topics/examples/xsendfile/">NGINX</a></p></div><h3 id="assets-cache-store"><a class="anchorlink" href="#assets-cache-store">6 Assets Cache Store</a></h3><p>By default, Sprockets caches assets in <code>tmp/cache/assets</code> in development
and production environments. This can be changed as follows:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
  <span class="n">env</span><span class="p">.</span><span class="nf">cache</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Cache</span><span class="p">.</span><span class="nf">lookup_store</span><span class="p">(</span><span class="ss">:memory_store</span><span class="p">,</span>
                                                <span class="p">{</span> <span class="ss">size: </span><span class="mi">32</span><span class="p">.</span><span class="nf">megabytes</span> <span class="p">})</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-360c9202a6d9938f062b066e1f21785e">config.assets.configure do |env|
  env.cache = ActiveSupport::Cache.lookup_store(:memory_store,
                                                { size: 32.megabytes })
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-360c9202a6d9938f062b066e1f21785e">Copiar</button>
</div>
<p>To disable the assets cache store:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
  <span class="n">env</span><span class="p">.</span><span class="nf">cache</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Cache</span><span class="p">.</span><span class="nf">lookup_store</span><span class="p">(</span><span class="ss">:null_store</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f24f113f70eb682c3b5750e3161d80e9">config.assets.configure do |env|
  env.cache = ActiveSupport::Cache.lookup_store(:null_store)
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f24f113f70eb682c3b5750e3161d80e9">Copiar</button>
</div>
<h3 id="adding-assets-to-your-gems"><a class="anchorlink" href="#adding-assets-to-your-gems">7 Adding Assets to Your Gems</a></h3><p>Assets can also come from external sources in the form of gems.</p><p>A good example of this is the <code>jquery-rails</code> gem.
This gem contains an engine class which inherits from <code>Rails::Engine</code>.
By doing this, Rails is informed that the directory for this
gem may contain assets and the <code>app/assets</code>, <code>lib/assets</code> and
<code>vendor/assets</code> directories of this engine are added to the search path of
Sprockets.</p><h3 id="making-your-library-or-gem-a-pre-processor"><a class="anchorlink" href="#making-your-library-or-gem-a-pre-processor">8 Making Your Library or Gem a Pre-Processor</a></h3><p>Sprockets uses Processors, Transformers, Compressors, and Exporters to extend
Sprockets functionality. Have a look at
<a href="https://github.com/rails/sprockets/blob/master/guides/extending_sprockets.md">Extending Sprockets</a>
to learn more. Here we registered a preprocessor to add a comment to the end
of text/css (<code>.css</code>) files.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">AddComment</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">data: </span><span class="n">input</span><span class="p">[</span><span class="ss">:data</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"/* Hello From my sprockets extension */"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-825536318a460a8e6d9315ceb8bfbeec">module AddComment
  def self.call(input)
    { data: input[:data] + "/* Hello From my sprockets extension */" }
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-825536318a460a8e6d9315ceb8bfbeec">Copiar</button>
</div>
<p>Now that you have a module that modifies the input data, it's time to register
it as a preprocessor for your mime type.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Sprockets</span><span class="p">.</span><span class="nf">register_preprocessor</span> <span class="s1">'text/css'</span><span class="p">,</span> <span class="no">AddComment</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-664a996b4791981ad2e5a98fad39ab41">Sprockets.register_preprocessor 'text/css', AddComment
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-664a996b4791981ad2e5a98fad39ab41">Copiar</button>
</div>


        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua se vir qualquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
