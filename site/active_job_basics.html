<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Básico de Active Jobs — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Básico de Active Jobs — Ruby on Rails Guides" />
  <meta name="description" content="Básico de Active JobsEste guia oferece a você tudo o que você precisa para começar a criar, enfileirar e executar jobs em backgroundDepois de ler este guia, você saberá: Como criar jobs Como enfileirar jobs como executar jobs em segundo plano Como enviar emails de sua aplicação de maneira assíncrona" />
  <meta property="og:description" content="Básico de Active JobsEste guia oferece a você tudo o que você precisa para começar a criar, enfileirar e executar jobs em backgroundDepois de ler este guia, você saberá: Como criar jobs Como enfileirar jobs como executar jobs em segundo plano Como enviar emails de sua aplicação de maneira assíncrona" />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v6.1.4</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Básico de Active Jobs</h2><p>Este guia oferece a você tudo o que você precisa para começar a criar, enfileirar e executar <em>jobs</em> em <em>background</em></p><p>Depois de ler este guia, você saberá:</p>
<ul>
<li>Como criar <em>jobs</em></li>
<li>Como enfileirar <em>jobs</em></li>
<li>como executar <em>jobs</em> em segundo plano </li>
<li>Como enviar emails de sua aplicação de maneira assíncrona</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#o-que-e-active-job-questionmark">O que é <em>Active Job</em>?</a></li>
<li><a href="#o-proposito-do-active-job">O Propósito do Active Job</a></li>
<li>
<a href="#criando-um-job">Criando um <em>Job</em></a>

<ul>
<li><a href="#crie-o-job">Crie o <em>Job</em></a></li>
<li><a href="#enfileirar-o-job">Enfileirar o <em>Job</em></a></li>
</ul>
</li>
<li>
<a href="#execucao-de-job">Execução de <em>Job</em></a>

<ul>
<li><a href="#backends"><em>Backends</em></a></li>
<li><a href="#configurando-o-backend">Configurando o <em>Backend</em></a></li>
<li><a href="#iniciando-o-backend">Iniciando o <em>Backend</em></a></li>
</ul>
</li>
<li><a href="#filas">Filas</a></li>
<li>
<a href="#callbacks"><em>Callbacks</em></a>

<ul>
<li><a href="#callbacks-disponiveis"><em>Callbacks</em> disponíveis</a></li>
</ul>
</li>
<li><a href="#action-mailer"><em>Action Mailer</em></a></li>
<li><a href="#internacionalizacao">Internacionalização</a></li>
<li>
<a href="#tipos-suportados-por-argumentos">Tipos suportados por argumentos</a>

<ul>
<li><a href="#globalid">GlobalID</a></li>
<li><a href="#serializers"><em>Serializers</em></a></li>
</ul>
</li>
<li>
<a href="#excecoes">Exceções</a>

<ul>
<li><a href="#reexecucao-ou-descarte-de-jobs-falhos">Reexecução ou Descarte de <em>jobs</em> falhos</a></li>
<li><a href="#desserializacao">Desserialização</a></li>
</ul>
</li>
<li><a href="#testando-os-jobs">Testando os <em>Jobs</em></a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="o-que-e-active-job-questionmark"><a class="anchorlink" href="#o-que-e-active-job-questionmark">1 O que é <em>Active Job</em>?</a></h3><p>O <em>Active Job</em> é um <em>framework</em> para declarar <em>jobs</em> e fazê-los executar em uma variedade de <em>backends</em> de fila. Estes <em>jobs</em> podem ser qualquer coisa, de limpezas programadas regularmente, a cobranças de despesas, a envio de emails. Qualquer coisa que possa ser cortada em pequenas unidades de trabalho e executadas paralelamente, sério. </p><h3 id="o-proposito-do-active-job"><a class="anchorlink" href="#o-proposito-do-active-job">2 O Propósito do Active Job</a></h3><p>O ponto principal é garantir que todas as aplicações Rails terão uma infraestrutura
de <em>jobs</em> no lugar. Nós podemos então ter <em>features</em> de <em>frameworks</em> e outras <em>gems</em>
construídas em cima dela, sem ter que nos preocupar com diferenças de API entre vários
executadores de <em>job</em> como <em>Delayed Job</em> e <em>Resque</em>. Dessa forma, escolher o seu <em>backend</em> 
de enfileiramento se torna mais uma preocupação operacional. E você poderá alternar entre eles sem
ter que reescrever os seus <em>jobs</em>. </p><div class="note"><p>Rails por padrão vem com uma implementação de fila assíncrona que executa <em>jobs</em>
com uma <em>pool</em> de <em>threads</em> no processo. <em>Jobs</em> serão executados da maneira assíncrona, mas
quaisquer <em>jobs</em> na fila serão derrubados ao reinicializar.</p></div><h3 id="criando-um-job"><a class="anchorlink" href="#criando-um-job">3 Criando um <em>Job</em></a></h3><p>Esta seção fornecerá um guia passo a passo para criar um <em>job</em> e enfileirá-lo.</p><h4 id="crie-o-job"><a class="anchorlink" href="#crie-o-job">3.1 Crie o <em>Job</em></a></h4><p>O <em>Active Job</em> fornece um gerador Rails para criar <em>jobs</em>. O seguinte criará um
<em>job</em> em <code>app/jobs</code> (com um teste anexado em <code>test/jobs</code>):</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate job guests_cleanup
<span class="go">invoke  test_unit
create    test/jobs/guests_cleanup_job_test.rb
create  app/jobs/guests_cleanup_job.rb
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-4a979445b18a6568461e09eb013b3804">bin/rails generate job guests_cleanup
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4a979445b18a6568461e09eb013b3804">Copiar</button>
</div>
<p>Você também pode criar um <em>job</em> que será executado em uma fila específica:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate job guests_cleanup <span class="nt">--queue</span> urgent
</code></pre>
<textarea class="clipboard-content" id="clipboard-0b466dad953e79159b5b9f61ceeaeb2b">bin/rails generate job guests_cleanup --queue urgent
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0b466dad953e79159b5b9f61ceeaeb2b">Copiar</button>
</div>
<p>Se você não quiser usar um gerador, você pode criar seu próprio arquivo dentro de
<code>app/jobs</code>, apenas certifique-se de que herda de <code>ApplicationJob</code>.</p><p>Aqui está a aparência de um <em>job</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:default</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">guests</span><span class="p">)</span>
    <span class="c1"># Do something later</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a65cbc5a256839cc22f7294e2f0fe2ec">class GuestsCleanupJob &lt; ApplicationJob
  queue_as :default

  def perform(*guests)
    # Do something later
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a65cbc5a256839cc22f7294e2f0fe2ec">Copiar</button>
</div>
<p>Observe que você pode definir <code>perform</code> com quantos argumentos quiser.</p><h4 id="enfileirar-o-job"><a class="anchorlink" href="#enfileirar-o-job">3.2 Enfileirar o <em>Job</em></a></h4><p>Enfileirar um <em>job</em> assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Enfileirar um _job_ para ser executado assim que o sistema de enfileiramento estiver</span>
<span class="c1"># livre.</span>
<span class="no">GuestsCleanupJob</span><span class="p">.</span><span class="nf">perform_later</span> <span class="n">guest</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6d68cf2b098b9eb2270f42389cfb398d"># Enfileirar um _job_ para ser executado assim que o sistema de enfileiramento estiver
# livre.
GuestsCleanupJob.perform_later guest
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6d68cf2b098b9eb2270f42389cfb398d">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Enfileirar um _job_ para ser executado amanhã ao meio-dia.</span>
<span class="no">GuestsCleanupJob</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="ss">wait_until: </span><span class="no">Date</span><span class="p">.</span><span class="nf">tomorrow</span><span class="p">.</span><span class="nf">noon</span><span class="p">).</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">guest</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3de3f4aad465d59d915622b83a87f74d"># Enfileirar um _job_ para ser executado amanhã ao meio-dia.
GuestsCleanupJob.set(wait_until: Date.tomorrow.noon).perform_later(guest)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3de3f4aad465d59d915622b83a87f74d">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Enfileirar um _job_ para ser executado em 1 semana a partir de agora.</span>
<span class="no">GuestsCleanupJob</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="ss">wait: </span><span class="mi">1</span><span class="p">.</span><span class="nf">week</span><span class="p">).</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">guest</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d1b95e7b4b283595fcfea5a1685f627c"># Enfileirar um _job_ para ser executado em 1 semana a partir de agora.
GuestsCleanupJob.set(wait: 1.week).perform_later(guest)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d1b95e7b4b283595fcfea5a1685f627c">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># `perform_now` e `perform_later` irão chamar `perform` por baixo dos panos, então</span>
<span class="c1"># você pode passar quantos argumentos forem definidos no último.</span>
<span class="no">GuestsCleanupJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">guest1</span><span class="p">,</span> <span class="n">guest2</span><span class="p">,</span> <span class="ss">filter: </span><span class="s1">'some_filter'</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-59536828743a50f51caff1472cc4776d"># `perform_now` e `perform_later` irão chamar `perform` por baixo dos panos, então
# você pode passar quantos argumentos forem definidos no último.
GuestsCleanupJob.perform_later(guest1, guest2, filter: 'some_filter')
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-59536828743a50f51caff1472cc4776d">Copiar</button>
</div>
<p>É isso aí!</p><h3 id="execucao-de-job"><a class="anchorlink" href="#execucao-de-job">4 Execução de <em>Job</em></a></h3><p>Para enfileirar e executar <em>jobs</em> em produção você precisa configurar um <em>backend</em> de filas,
ou seja, você precisa decidir por uma <em>lib</em> de enfileiramento de terceiros que o Rails deve usar,
o Rails em si fornece apenas um sistema de filas em processo, que só mantém os <em>jobs</em> em memória(RAM).
Se o processo quebra ou a máquina é reiniciada, todos os <em>jobs</em> pendentes serão perdidos com o
<em>backend</em> assíncrono padrão. Isso pode ser bom para aplicações menores ou <em>jobs</em> não críticos, mas a maioria
das aplicações em produção precisará escolher um <em>backend</em> de persistência.</p><h4 id="backends"><a class="anchorlink" href="#backends">4.1 <em>Backends</em></a></h4><p>O <em>Active Job</em> tem adaptadores <em>built-in</em> para múltiplos <em>backends</em> de fila (Sidekiq
Resque, Delayed Job e outros). Para obter uma lista atualizada dos adaptadores,
consulte a documentação da API para <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveJob/QueueAdapters.html">ActiveJob::QueueAdapters</a>.</p><h4 id="configurando-o-backend"><a class="anchorlink" href="#configurando-o-backend">4.2 Configurando o <em>Backend</em></a></h4><p>Você pode definir facilmente o <em>backend</em> de fila:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="k">module</span> <span class="nn">YourApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># Be sure to have the adapter's gem in your Gemfile</span>
    <span class="c1"># and follow the adapter's specific installation</span>
    <span class="c1"># and deployment instructions.</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">queue_adapter</span> <span class="o">=</span> <span class="ss">:sidekiq</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-97d4aa97aacab6edc06ea70c47523081"># config/application.rb
module YourApp
  class Application &lt; Rails::Application
    # Be sure to have the adapter's gem in your Gemfile
    # and follow the adapter's specific installation
    # and deployment instructions.
    config.active_job.queue_adapter = :sidekiq
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-97d4aa97aacab6edc06ea70c47523081">Copiar</button>
</div>
<p>Você também pode configurar seu <em>backend</em> por um <em>job</em> base:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">queue_adapter</span> <span class="o">=</span> <span class="ss">:resque</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="c1"># Agora o seu job vai usar `resque` como gerenciados de fials sobrescrevendo o</span>
<span class="c1"># que estava configurado em `config.active_job.queue_adapter`.</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-73c6792ff340510ff32c95e36f6cb04d">class GuestsCleanupJob &lt; ApplicationJob
  self.queue_adapter = :resque
  # ...
end

# Agora o seu job vai usar `resque` como gerenciados de fials sobrescrevendo o
# que estava configurado em `config.active_job.queue_adapter`.
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-73c6792ff340510ff32c95e36f6cb04d">Copiar</button>
</div>
<h4 id="iniciando-o-backend"><a class="anchorlink" href="#iniciando-o-backend">4.3 Iniciando o <em>Backend</em></a></h4><p>Uma vez que os <em>jobs</em> são executados em paralelo à sua aplicação Rails, a maioria
das bibliotecas de filas exigem que você inicie um serviço de enfileiramento específico
(além de iniciar sua aplicação Rails) para que o processamento do <em>job</em> funcione. Consulte a
documentação da biblioteca para obter instruções sobre como iniciar o <em>backend</em> da fila.</p><p>Aqui está uma lista não abrangente de documentação:</p>
<ul>
<li><a href="https://github.com/mperham/sidekiq/wiki/Active-Job">Sidekiq</a></li>
<li><a href="https://github.com/resque/resque/wiki/ActiveJob">Resque</a></li>
<li><a href="https://github.com/jondot/sneakers/wiki/How-To:-Rails-Background-Jobs-with-ActiveJob">Sneakers</a></li>
<li><a href="https://github.com/brandonhilkert/sucker_punch#active-job">Sucker Punch</a></li>
<li><a href="https://github.com/QueueClassic/queue_classic#active-job">Queue Classic</a></li>
<li><a href="https://github.com/collectiveidea/delayed_job#active-job">Delayed Job</a></li>
<li><a href="https://github.com/que-rb/que#additional-rails-specific-setup">Que</a></li>
</ul>
<h3 id="filas"><a class="anchorlink" href="#filas">5 Filas</a></h3><p>A maioria dos <em>adapters</em> suportam múltiplas filas. Com o <em>Active Job</em> você pode agendar
o <em>job</em> para executar em uma fila específica:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:low_priority</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-94175d72aae9e69afd47c9911be311a9">class GuestsCleanupJob &lt; ApplicationJob
  queue_as :low_priority
  # ...
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-94175d72aae9e69afd47c9911be311a9">Copiar</button>
</div>
<p>Você pode prefixar o nome da fila para todos os <em>jobs</em> usando
<code>config.active_job.queue_name_prefix</code> in <code>application.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="k">module</span> <span class="nn">YourApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">queue_name_prefix</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a324ecdc5514195a263063af32a2a5e6"># config/application.rb
module YourApp
  class Application &lt; Rails::Application
    config.active_job.queue_name_prefix = Rails.env
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a324ecdc5514195a263063af32a2a5e6">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/jobs/guests_cleanup_job.rb</span>
<span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:low_priority</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="c1"># Agora seu job irá executar na fila production_low_priority no seu</span>
<span class="c1"># ambiente de produção e na staging_low_priority</span>
<span class="c1"># no seu ambiente de desenvolvimento</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9151337e827a7fe897e4b4fc51a01cc2"># app/jobs/guests_cleanup_job.rb
class GuestsCleanupJob &lt; ApplicationJob
  queue_as :low_priority
  # ...
end

# Agora seu job irá executar na fila production_low_priority no seu
# ambiente de produção e na staging_low_priority
# no seu ambiente de desenvolvimento
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9151337e827a7fe897e4b4fc51a01cc2">Copiar</button>
</div>
<p>Você também pode configurar o prefixo para cada <em>job</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:low_priority</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">queue_name_prefix</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="c1"># Agora a fila do seu job não terá um prefixo, sobrescrevendo o que</span>
<span class="c1"># foi configurado em `config.active_job.queue_name_prefix`.</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d5feb09e783a942880afcf2ca1484703">class GuestsCleanupJob &lt; ApplicationJob
  queue_as :low_priority
  self.queue_name_prefix = nil
  # ...
end

# Agora a fila do seu job não terá um prefixo, sobrescrevendo o que
# foi configurado em `config.active_job.queue_name_prefix`.
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d5feb09e783a942880afcf2ca1484703">Copiar</button>
</div>
<p>O prefixo delimitador padrão de nome de fila é '_'. Isso pode ser alterado configurando o
<code>config.active_job.queue_name_delimiter</code> no <code>application.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="k">module</span> <span class="nn">YourApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">queue_name_prefix</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">queue_name_delimiter</span> <span class="o">=</span> <span class="s1">'.'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-35dea699b29171dafc244d8ae3511ec5"># config/application.rb
module YourApp
  class Application &lt; Rails::Application
    config.active_job.queue_name_prefix = Rails.env
    config.active_job.queue_name_delimiter = '.'
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-35dea699b29171dafc244d8ae3511ec5">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/jobs/guests_cleanup_job.rb</span>
<span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:low_priority</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="c1"># Agora seu job irá executar na fila production.low_priority no seu</span>
<span class="c1"># ambiente de produção e na staging.low_priority</span>
<span class="c1"># no seu ambiente de staging</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0c92283d9b74c696cb25e018819bb4e8"># app/jobs/guests_cleanup_job.rb
class GuestsCleanupJob &lt; ApplicationJob
  queue_as :low_priority
  # ...
end

# Agora seu job irá executar na fila production.low_priority no seu
# ambiente de produção e na staging.low_priority
# no seu ambiente de staging
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0c92283d9b74c696cb25e018819bb4e8">Copiar</button>
</div>
<p>Se você quiser mais controle em qual fila um <em>job</em> será executado, você pode passar
uma opção <code>:queue</code> ao <code>set</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">MyJob</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="ss">queue: :another_queue</span><span class="p">).</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-686b077c02ceb6fa7e890edbdcb69953">MyJob.set(queue: :another_queue).perform_later(record)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-686b077c02ceb6fa7e890edbdcb69953">Copiar</button>
</div>
<p>Para controlar a fila a partir do nível do <em>job</em>, você pode passar um bloco para <code>queue_as</code>.
O bloco será executado no contexto do <em>job</em> (o que te permite acessar <code>self.arguments</code>), e ele
deve retornar o nome da fila:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ProcessVideoJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="k">do</span>
    <span class="n">video</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">arguments</span><span class="p">.</span><span class="nf">first</span>
    <span class="k">if</span> <span class="n">video</span><span class="p">.</span><span class="nf">owner</span><span class="p">.</span><span class="nf">premium?</span>
      <span class="ss">:premium_videojobs</span>
    <span class="k">else</span>
      <span class="ss">:videojobs</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>
    <span class="c1"># Processa o vídeo</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c28d49921555fafa22af37b02c3cc522">class ProcessVideoJob &lt; ApplicationJob
  queue_as do
    video = self.arguments.first
    if video.owner.premium?
      :premium_videojobs
    else
      :videojobs
    end
  end

  def perform(video)
    # Processa o vídeo
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c28d49921555fafa22af37b02c3cc522">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="no">ProcessVideoJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="no">Video</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bb70da46b986e4d57c7461b266eb5638">ProcessVideoJob.perform_later(Video.last)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb70da46b986e4d57c7461b266eb5638">Copiar</button>
</div>
<div class="note"><p>Tenha certeza de que o seu <em>backend</em> de fila "escuta" o nome da fila.
Para alguns <em>backends</em> você precisará especificar as filas a serem "ouvidas".</p></div><h3 id="callbacks"><a class="anchorlink" href="#callbacks">6 <em>Callbacks</em></a></h3><p>O <em>Active Job</em> fornece Hooks para disparar lógica durante o ciclo de vida de um <em>Job</em>.
Assim como em outros <em>callbacks</em> no Rails, você pode implementar <em>callbacks</em>
como métodos comuns e usar um método macro de classe para registrá-los
como <em>callbacks</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:default</span>

  <span class="n">around_perform</span> <span class="ss">:around_cleanup</span>

  <span class="k">def</span> <span class="nf">perform</span>
    <span class="c1"># Do something later</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">around_cleanup</span>
      <span class="c1"># Do something before perform</span>
      <span class="k">yield</span>
      <span class="c1"># Do something after perform</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-37e00349155476b4720d9ea363d0392c">class GuestsCleanupJob &lt; ApplicationJob
  queue_as :default

  around_perform :around_cleanup

  def perform
    # Do something later
  end

  private
    def around_cleanup
      # Do something before perform
      yield
      # Do something after perform
    end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-37e00349155476b4720d9ea363d0392c">Copiar</button>
</div>
<p>Os métodos macro de classe podem também receber um bloco. Considere usar esse estilo,
se o código dentro do bloco for tão pequeno que cabe numa única linha.
Por exemplo, você pode enviar métricas para cada <em>job</em> enfileirado:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_enqueue</span> <span class="p">{</span> <span class="o">|</span><span class="n">job</span><span class="o">|</span> <span class="vg">$statsd</span><span class="p">.</span><span class="nf">increment</span> <span class="s2">"</span><span class="si">#{</span><span class="n">job</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">.enqueue"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cc62d6f624e142c1a90491f2748ef544">class ApplicationJob &lt; ActiveJob::Base
  before_enqueue { |job| $statsd.increment "#{job.class.name.underscore}.enqueue" }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cc62d6f624e142c1a90491f2748ef544">Copiar</button>
</div>
<h4 id="callbacks-disponiveis"><a class="anchorlink" href="#callbacks-disponiveis">6.1 <em>Callbacks</em> disponíveis</a></h4>
<ul>
<li><code>before_enqueue</code></li>
<li><code>around_enqueue</code></li>
<li><code>after_enqueue</code></li>
<li><code>before_perform</code></li>
<li><code>around_perform</code></li>
<li><code>after_perform</code></li>
</ul>
<h3 id="action-mailer"><a class="anchorlink" href="#action-mailer">7 <em>Action Mailer</em></a></h3><p>Um dos <em>jobs</em> mais comuns em uma aplicação <em>web</em> moderna é enviar e-mails fora do ciclo de 
<em>request-response</em>, para que o usuário não tenha que esperar por ele. O <em>Active Job</em> está
integrado com o <em>Action Mailer</em>, o que te permite enviar e-mails assincronamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># If you want to send the email now use #deliver_now</span>
<span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">deliver_now</span>

<span class="c1"># If you want to send the email through Active Job use #deliver_later</span>
<span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">deliver_later</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5f07e66ffd60a6a3d3a62b210910506c"># If you want to send the email now use #deliver_now
UserMailer.welcome(@user).deliver_now

# If you want to send the email through Active Job use #deliver_later
UserMailer.welcome(@user).deliver_later
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5f07e66ffd60a6a3d3a62b210910506c">Copiar</button>
</div>
<div class="note"><p>Se você usar uma fila assíncrona de uma <em>Rake task</em> (por exemplo, para enviar um e-mail
usando <code>.deliver_later</code>), geralmente não irá funcionar porque a <em>Rake</em> irá provavelmente
terminar, fazendo com que o processo interno do <em>thread pool</em> seja removido, antes de
qualquer ou todos os e-mails serem processados. Para evitar esse problema, use o 
<code>.deliver_now</code> ou execute uma fila persistente no ambiente de desenvolvimento.</p></div><h3 id="internacionalizacao"><a class="anchorlink" href="#internacionalizacao">8 Internacionalização</a></h3><p>Cada <em>job</em> usa o <code>I18n.locale</code> configurado quando o <em>job</em> é criado. Isso é útil se você
enviar e-mails assincronamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">I18n</span><span class="p">.</span><span class="nf">locale</span> <span class="o">=</span> <span class="ss">:eo</span>

<span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">deliver_later</span> <span class="c1"># O e-mail será localizado para Esperanto.</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b0841c6df061e170400a9ba4e3d785ad">I18n.locale = :eo

UserMailer.welcome(@user).deliver_later # O e-mail será localizado para Esperanto.
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b0841c6df061e170400a9ba4e3d785ad">Copiar</button>
</div>
<h3 id="tipos-suportados-por-argumentos"><a class="anchorlink" href="#tipos-suportados-por-argumentos">9 Tipos suportados por argumentos</a></h3><p>O <em>ActiveJob</em> suporta os seguintes tipos de argumentos por padrão:</p>
<ul>
<li>Basic types (<code>NilClass</code>, <code>String</code>, <code>Integer</code>, <code>Float</code>, <code>BigDecimal</code>, <code>TrueClass</code>, <code>FalseClass</code>)</li>
<li><code>Symbol</code></li>
<li><code>Date</code></li>
<li><code>Time</code></li>
<li><code>DateTime</code></li>
<li><code>ActiveSupport::TimeWithZone</code></li>
<li><code>ActiveSupport::Duration</code></li>
<li>
<code>Hash</code> (Keys should be of <code>String</code> or <code>Symbol</code> type)</li>
<li><code>ActiveSupport::HashWithIndifferentAccess</code></li>
<li><code>Array</code></li>
<li><code>Module</code></li>
<li><code>Class</code></li>
</ul>
<h4 id="globalid"><a class="anchorlink" href="#globalid">9.1 GlobalID</a></h4><p>O <em>Active Job</em> suporta o <a href="https://github.com/rails/globalid/blob/master/README.md">GlobalID</a> como parâmetros.
Isso possibilita passar objetos ativos do <em>Active Record</em> para o <em>job</em> ao invés do par classe/id, que você deve desserializar manualmente.
Anteriormente, os <em>jobs</em> eram feitos dessa forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">TrashableCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">trashable_class</span><span class="p">,</span> <span class="n">trashable_id</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
    <span class="n">trashable</span> <span class="o">=</span> <span class="n">trashable_class</span><span class="p">.</span><span class="nf">constantize</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">trashable_id</span><span class="p">)</span>
    <span class="n">trashable</span><span class="p">.</span><span class="nf">cleanup</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c1b12cdcee429e3a26eb07ae1a3f9040">class TrashableCleanupJob &lt; ApplicationJob
  def perform(trashable_class, trashable_id, depth)
    trashable = trashable_class.constantize.find(trashable_id)
    trashable.cleanup(depth)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c1b12cdcee429e3a26eb07ae1a3f9040">Copiar</button>
</div>
<p>Agora são feitos dessa forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">TrashableCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">trashable</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
    <span class="n">trashable</span><span class="p">.</span><span class="nf">cleanup</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8a89b5914687fba9ae4917a5dcaf530d">class TrashableCleanupJob &lt; ApplicationJob
  def perform(trashable, depth)
    trashable.cleanup(depth)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8a89b5914687fba9ae4917a5dcaf530d">Copiar</button>
</div>
<p>Isso funciona com qualquer classe que está mesclada em <code>GlobalID::Identification</code> que, por padrão, já está mesclada dentro das classes <em>Active Record</em>.</p><h4 id="serializers"><a class="anchorlink" href="#serializers">9.2 <em>Serializers</em></a></h4><p>Você pode ampliar a lista de tipos de argumentos suportados. Só é preciso definir seu próprio <em>serializer</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MoneySerializer</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Serializers</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="c1"># Checa se um argumento pode ser serializado a partir desse serializer.</span>
  <span class="k">def</span> <span class="nf">serialize?</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
    <span class="n">argument</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Money</span>
  <span class="k">end</span>

  <span class="c1"># Converte um objeto em um representante mais simples usando tipos de objetos suportados.</span>
  <span class="c1"># O representante recomendado é uma Hash com uma key específica. As Keys podem ser somente de tipos básicos.</span>
  <span class="c1"># Você deve invocar o `super` para adicionar o serializer customizado na hash.</span>
  <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">money</span><span class="p">)</span>
    <span class="k">super</span><span class="p">(</span>
      <span class="s2">"amount"</span> <span class="o">=&gt;</span> <span class="n">money</span><span class="p">.</span><span class="nf">amount</span><span class="p">,</span>
      <span class="s2">"currency"</span> <span class="o">=&gt;</span> <span class="n">money</span><span class="p">.</span><span class="nf">currency</span>
    <span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Converte o valor serializado em um objeto apropriado.</span>
  <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
    <span class="no">Money</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">hash</span><span class="p">[</span><span class="s2">"amount"</span><span class="p">],</span> <span class="nb">hash</span><span class="p">[</span><span class="s2">"currency"</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1fbbf2ebd8fdee2a2376989a4a55414d">class MoneySerializer &lt; ActiveJob::Serializers::ObjectSerializer
  # Checa se um argumento pode ser serializado a partir desse serializer.
  def serialize?(argument)
    argument.is_a? Money
  end

  # Converte um objeto em um representante mais simples usando tipos de objetos suportados.
  # O representante recomendado é uma Hash com uma key específica. As Keys podem ser somente de tipos básicos.
  # Você deve invocar o `super` para adicionar o serializer customizado na hash.
  def serialize(money)
    super(
      "amount" =&gt; money.amount,
      "currency" =&gt; money.currency
    )
  end

  # Converte o valor serializado em um objeto apropriado.
  def deserialize(hash)
    Money.new(hash["amount"], hash["currency"])
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1fbbf2ebd8fdee2a2376989a4a55414d">Copiar</button>
</div>
<p>e adicionar o serializer na lista:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">custom_serializers</span> <span class="o">&lt;&lt;</span> <span class="no">MoneySerializer</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5f6ed24ac9987b8e9c1494e97ea17554">Rails.application.config.active_job.custom_serializers &lt;&lt; MoneySerializer
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5f6ed24ac9987b8e9c1494e97ea17554">Copiar</button>
</div>
<h3 id="excecoes"><a class="anchorlink" href="#excecoes">10 Exceções</a></h3><p>Os <em>Active Jobs</em> fornecem uma maneira de capturar exceções criadas durante a execução do <em>job</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">GuestsCleanupJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:default</span>

  <span class="n">rescue_from</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">exception</span><span class="o">|</span>
    <span class="c1"># Do something with the exception</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">perform</span>
    <span class="c1"># Do something later</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4bc585a8d1ba5d8b7f277dcf8969acb8">class GuestsCleanupJob &lt; ApplicationJob
  queue_as :default

  rescue_from(ActiveRecord::RecordNotFound) do |exception|
    # Do something with the exception
  end

  def perform
    # Do something later
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4bc585a8d1ba5d8b7f277dcf8969acb8">Copiar</button>
</div>
<p>Se a exceção não for tratada dentro do <em>job</em>, então o <em>job</em> é reconhecido como "<em>failed</em> (falhado)"</p><h4 id="reexecucao-ou-descarte-de-jobs-falhos"><a class="anchorlink" href="#reexecucao-ou-descarte-de-jobs-falhos">10.1 Reexecução ou Descarte de <em>jobs</em> falhos</a></h4><p>Um <em>job</em> que falhou não será executado novamente, exceto se configurado para fazer isso.</p><p>É possível também reexecutar ou descartar um <em>job</em> se uma exceção for gerada durante a execução. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">RemoteServiceJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">retry_on</span> <span class="no">CustomAppException</span> <span class="c1"># defaults to 3s wait, 5 attempts</span>

  <span class="n">discard_on</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">DeserializationError</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="c1"># Might raise CustomAppException or ActiveJob::DeserializationError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7c7f8f871a7aa946ec542129a6eabe91">class RemoteServiceJob &lt; ApplicationJob
  retry_on CustomAppException # defaults to 3s wait, 5 attempts

  discard_on ActiveJob::DeserializationError

  def perform(*args)
    # Might raise CustomAppException or ActiveJob::DeserializationError
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7c7f8f871a7aa946ec542129a6eabe91">Copiar</button>
</div>
<p>Para mais detalhes Veja a Documentação da API para <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveJob/Exceptions/ClassMethods.html">ActiveJob::Exceções</a>.</p><h4 id="desserializacao"><a class="anchorlink" href="#desserializacao">10.2 Desserialização</a></h4><p><em>GlobalID</em> permite serializar todos os objetos do <em>Active Record</em> passado para o <code>#perform</code>.</p><p>Se um registro for deletado após o <em>job</em> ser enfileirado mas antes do método <code>#perform</code> ser chamado, o <em>Active Job</em> vai lançar a exceção <code>ActiveJob::DeserializationError</code>.</p><h3 id="testando-os-jobs"><a class="anchorlink" href="#testando-os-jobs">11 Testando os <em>Jobs</em></a></h3><p>Você pode encontrar instruções mais detalhadas sobre como testar seus <em>jobs</em> no
<a href="testing.html#testing-jobs">guia de teste</a>.</p>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua se vir qualquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
