<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Action Controller Overview — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Action Controller Overview — Ruby on Rails Guides" />
  <meta name="description" content="Action Controller OverviewNesse guia você irá aprender como controllers trabalham e como eles se encaixam no ciclo de requisições da sua aplicação.Depois de ler este guia, você irá saber: Como seguir o fluxo de uma requisição através de um controller. Como restringir parâmetros passados ao seu controller. Como e porque salvar dados na sessão ou nos cookies. Como trabalhar com filtros para executar código durante o processamento de uma requisição. Como utilizar o autenticador HTTP nativo do ActionController. Como transmitir dados diretamente ao navegador do usuário. Como filtrar parâmetros sensíveis, para que não apareçam no log da aplicação. Como lidar com erros que podem surgir durante o processamento de uma requisição." />
  <meta property="og:description" content="Action Controller OverviewNesse guia você irá aprender como controllers trabalham e como eles se encaixam no ciclo de requisições da sua aplicação.Depois de ler este guia, você irá saber: Como seguir o fluxo de uma requisição através de um controller. Como restringir parâmetros passados ao seu controller. Como e porque salvar dados na sessão ou nos cookies. Como trabalhar com filtros para executar código durante o processamento de uma requisição. Como utilizar o autenticador HTTP nativo do ActionController. Como transmitir dados diretamente ao navegador do usuário. Como filtrar parâmetros sensíveis, para que não apareçam no log da aplicação. Como lidar com erros que podem surgir durante o processamento de uma requisição." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.8</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                  <dd><a href="active_record_encryption.html">Active Record Encryption</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - Dezembro 2021</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</option>
                  <option value="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
                  <option value="active_record_encryption.html">Active Record Encryption</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_0_release_notes.html">Version 7.0 - Dezembro 2021</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Action Controller Overview</h2><p>Nesse guia você irá aprender como <code>controllers</code> trabalham e como eles se encaixam no ciclo de requisições da sua aplicação.</p><p>Depois de ler este guia, você irá saber:</p>
<ul>
<li>Como seguir o fluxo de uma requisição através de um <em>controller</em>.</li>
<li>Como restringir parâmetros passados ao seu <em>controller</em>.</li>
<li>Como e porque salvar dados na sessão ou nos <code>cookies</code>.</li>
<li>Como trabalhar com filtros para executar código durante o processamento de uma requisição.</li>
<li>Como utilizar o autenticador HTTP nativo do <code>ActionController</code>.</li>
<li>Como transmitir dados diretamente ao navegador do usuário.</li>
<li>Como filtrar parâmetros sensíveis, para que não apareçam no <em>log</em> da aplicação.</li>
<li>Como lidar com erros que podem surgir durante o processamento de uma requisição.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#o-que-um-controller-faz-questionmark">O que um <em>Controller</em> faz?</a></li>
<li><a href="#conven%C3%A7%C3%A3o-para-nomeclatura-de-controllers">Convenção para Nomeclatura de <em>Controllers</em></a></li>
<li><a href="#m%C3%A9todos-e-actions">Métodos e Actions</a></li>
<li>
<a href="#par%C3%A2metros">Parâmetros</a>

<ul>
<li><a href="#hash-e-par%C3%A2metros-de-array">Hash e Parâmetros de Array</a></li>
<li><a href="#par%C3%A2metros-json">Parâmetros JSON</a></li>
<li><a href="#par%C3%A2metros-de-rota">Parâmetros de Rota</a></li>
<li><a href="#default-url-options"><code>default_url_options</code></a></li>
<li><a href="#par%C3%A2metros-fortes">Parâmetros Fortes</a></li>
</ul>
</li>
<li>
<a href="#sess%C3%A3o">Sessão</a>

<ul>
<li><a href="#acessando-a-sess%C3%A3o">Acessando a Sessão</a></li>
<li><a href="#o-flash">O <em>Flash</em></a></li>
</ul>
</li>
<li><a href="#cookies">Cookies</a></li>
<li><a href="#renderizando-dados-xml-e-json">Renderizando Dados XML e JSON</a></li>
<li>
<a href="#filtros">Filtros</a>

<ul>
<li><a href="#filtros-after-e-around">Filtros after e around</a></li>
<li><a href="#outras-formas-de-usar-filtros">Outras Formas de Usar Filtros</a></li>
</ul>
</li>
<li><a href="#prote%C3%A7%C3%A3o-de-falsifica%C3%A7%C3%A3o-de-requisi%C3%A7%C3%A3o">Proteção de falsificação de requisição</a></li>
<li>
<a href="#os-objetos-de-requisi%C3%A7%C3%A3o-e-resposta">Os Objetos de Requisição e Resposta</a>

<ul>
<li><a href="#o-objeto-request">O Objeto <code>request</code></a></li>
<li><a href="#o-objeto-response">O Objeto <code>response</code></a></li>
</ul>
</li>
<li>
<a href="#autentica%C3%A7%C3%B5es-http">Autenticações HTTP</a>

<ul>
<li><a href="#autentica%C3%A7%C3%A3o-http-basic">Autenticação HTTP <em>Basic</em></a></li>
<li><a href="#autentica%C3%A7%C3%A3o-http-digest">Autenticação HTTP <em>Digest</em></a></li>
<li><a href="#autentica%C3%A7%C3%A3o-http-token">Autenticação HTTP <em>Token</em></a></li>
</ul>
</li>
<li>
<a href="#streaming-e-downloads-de-arquivos"><em>Streaming</em> e <em>Downloads</em> de Arquivos</a>

<ul>
<li><a href="#enviando-arquivos">Enviando Arquivos</a></li>
<li><a href="#restful-downloads"><em>RESTful</em> <em>Downloads</em></a></li>
<li><a href="#transmiss%C3%A3o-ao-vivo-de-dado-arbitr%C3%A1rios">Transmissão Ao Vivo de Dado Arbitrários</a></li>
</ul>
</li>
<li>
<a href="#filtragem-de-log">Filtragem de Log</a>

<ul>
<li><a href="#filtrando-par%C3%A2metros">Filtrando Parâmetros</a></li>
<li><a href="#filtrando-redirecionamentos">Filtrando Redirecionamentos</a></li>
</ul>
</li>
<li>
<a href="#rescue">Rescue</a>

<ul>
<li><a href="#os-templates-404-e-500-padr%C3%A3o">Os <em>Templates</em> 404 e 500 Padrão</a></li>
<li><a href="#rescue-from"><code>rescue_from</code></a></li>
</ul>
</li>
<li><a href="#for%C3%A7ar-o-protocolo-https">Forçar o Protocolo HTTPS</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="o-que-um-controller-faz-questionmark"><a class="anchorlink" href="#o-que-um-controller-faz-questionmark">1 O que um <em>Controller</em> faz?</a></h3><p><em>ActionController</em> é o <em>C</em> em <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">MVC</a>. Após o <code>router</code> determinar qual <em>controller</em> usar para a requisição, o <em>controller</em> será responsável por entender a requisição e retornar a resposta apropriada. Por sorte, <em>ActionController</em> faz a maior parte do trabalho fundamental pra você e usa convenções inteligentes pra fazer esse processo ser tão intuitivo quanto possível.</p><p>Para a maior parte das aplicações <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a>,o <em>controller</em> receberá a requisição (o que é "invisível" a você que está desenvolvendo), busca e/ou salva dados de um <em>model</em>, e usa a <em>view</em> para criar a saída HTML. Se seu <em>controller</em> precisa tratar requisições um pouco diferente, isso não é um problema, este é apenas o jeito mais comum de um <em>controller</em> trabalhar.</p><p>Um <em>controller</em> pode então ser pensado como um intermediário entre um <em>model</em> e uma <em>view</em>. Isso faz com que os dados do <em>model</em> fiquem disponíveis para a <em>view</em>, para que possa ser mostrado ao usuário, e ele salva ou atualiza dados do usuário no <em>model</em>.</p><div class="note"><p>Para mais detalhes sobre processo de roteamento, veja <a href="routing.html">Rails Routing from the Outside In</a></p></div><h3 id="convenção-para-nomeclatura-de-controllers"><a class="anchorlink" href="#conven%C3%A7%C3%A3o-para-nomeclatura-de-controllers">2 Convenção para Nomeclatura de <em>Controllers</em></a></h3><p>A convenção para nomenclatura de <em>controllers</em> no Rails favorece a pluralização da última palavra do nome do <em>controller</em>, embora não seja estritamente necessário (ex: <code>ApplicationController</code>). Por exemplo, <code>ClientsController</code> é recomendado ao invés de <code>ClientController</code>, <code>SiteAdminsController</code> é recomendado ao invés de <code>SiteAdminController</code> ou <code>SitesAdminsController</code>, e assim por diante.</p><p>Seguindo essa convenção será possível utilizar o gerador de rotas padrão (ex: <code>resources</code>, etc) sem precisar configurar cada <code>:path</code> ou <code>:controller</code>, e ainda manter consistente o uso dos auxiliares de rotas em todo o seu projeto. Veja <a href="layouts_and_rendering.html">Layouts e Guia de Renderização</a> para mais detalhes.</p><div class="note"><p>A convenção para nomenclatura de <em>controllers</em> difere da convenção para nomenclatura de <em>models</em>, que devem ser nomeados na forma singular.</p></div><h3 id="métodos-e-actions"><a class="anchorlink" href="#m%C3%A9todos-e-actions">3 Métodos e Actions</a></h3><p>Um <em>controller</em> é uma classe do Ruby que herda de <code>ApplicationController</code> e tem métodos como qualquer outra classe. Quando a sua aplicação recebe uma requisição, o roteamento irá determinar qual <em>controller</em> e qual <em>action</em> serão executados, e então o Rails irá criar uma instância desse <em>controller</em> e executará o método que possui o mesmo nome da <em>action</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ClientsController &lt; ApplicationController
  def new
  end
end
">Copy</button>
</div>
<p>Como exemplo, se um usuário acessar <code>/clients/new</code> na sua aplicação para adicionar um novo cliente, o Rails irá criar uma instância de <code>ClientsController</code> e irá chamar o método <code>new</code> dele. Repare que o método vazio do exemplo acima funcionaria normalmente porque o Rails por padrão vai renderizar a <em>view</em> <code>new.html.erb</code> a menos que a <code>action</code> indique outro caminho. Ao criar um novo <code>Client</code> o método <code>new</code> pode tornar uma variável de instância <code>@client</code> acessível na <code>view</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">new</span>
  <span class="vi">@client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="def new
  @client = Client.new
end
">Copy</button>
</div>
<p>O <a href="layouts_and_rendering.html">Guia de Layouts e Renderização</a> explica essa etapa mais detalhadamente.</p><p>O <code>ApplicationController</code> herda de <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Base.html"><code>ActionController::Base</code></a>, que define uma quantidade de métodos úteis. Este guia vai cobrir alguns destes métodos, mas se você tiver curiosidade para ver o que há neles, você pode ver todos eles na <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController.html">Documentação da API</a> ou no próprio código fonte.</p><p>Apenas métodos públicos são executáveis como <em>actions</em>. É uma boa prática diminuir a visibilidade de métodos (utilizando <code>private</code> ou <code>protected</code>) que não foram designados para serem <em>actions</em>, como métodos auxiliares ou filtros.</p><div class="warning"><p>Alguns nomes de métodos são reservados pelo <em>Action Controller</em>. Redefini-los acidentalmente como <em>actions</em>, ou mesmo como métodos auxiliares (<em>helpers</em>), pode resultar no erro <code>SystemStackError</code>. Se você limitar seus <em>controllers</em> a apenas <em>actions</em> RESTful <a href="routing.html#resource-routing-the-rails-default">Resource Routing</a> você não precisará se preocupar com isso.</p></div><div class="note"><p>Se você precisar usar um método reservado como um nome de <em>action</em>, uma solução alternativa é usar uma rota personalizada para mapear o nome do método reservado para o método da <em>action</em> não reservado.</p></div><h3 id="parâmetros"><a class="anchorlink" href="#par%C3%A2metros">4 Parâmetros</a></h3><p>Você provavelmente vai querer acessar os dados enviados pelo usuário ou outros parâmetros nas <em>actions</em> do seu <em>controller</em>. Existem dois tipos de parâmetros possíveis numa aplicação <em>web</em>. O primeiro são os parâmetros que são enviados como parte da URL, chamados parâmetros de <em>query string</em>. A <em>query string</em> é tudo o que vem após o "?" na URL. O segundo tipo de parâmetro é geralmente referido como os dados de POST. Essa informação geralmente vem de um formulário HTML que foi preenchido pelo usuário. Se chamam dados de POST porque estes dados somente podem ser enviados como parte de uma requisição HTTP usando o verbo POST. O Rails não faz distinção sobre parâmetros de <em>query string</em> e parâmetros de POST, ambos são acessíveis por meio do <em>hash</em> <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/StrongParameters.html#method-i-params"><code>params</code></a> no seu <em>controller</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># Essa action usa parâmetros de query string porque ela é</span>
  <span class="c1"># executada através de uma requisição HTTP GET, mas isso</span>
  <span class="c1"># não faz nenhuma diferença como os parâmetros</span>
  <span class="c1"># são acessados. A URL para essa action seria desse jeito</span>
  <span class="c1"># para mostrar os clientes ativos: /clients?status=activated</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"activated"</span>
      <span class="vi">@clients</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">activated</span>
    <span class="k">else</span>
      <span class="vi">@clients</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">inactivated</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Essa action usa parâmetros de POST. Eles provavelmente estão</span>
  <span class="c1"># vindo de um formulário HTML que o usuário submeteu. A URL</span>
  <span class="c1"># para essa requisição RESTful será "/clients", e os dados</span>
  <span class="c1"># serão enviados como parte do corpo da requisição.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:client</span><span class="p">])</span>
    <span class="k">if</span> <span class="vi">@client</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">redirect_to</span> <span class="vi">@client</span>
    <span class="k">else</span>
      <span class="c1"># Essa linha sobrescreve o método padrão de renderização,</span>
      <span class="c1"># que seria chamado para renderizar a *view* "*create*"</span>
      <span class="n">render</span> <span class="s2">"new"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ClientsController &lt; ApplicationController
  # Essa action usa parâmetros de query string porque ela é
  # executada através de uma requisição HTTP GET, mas isso
  # não faz nenhuma diferença como os parâmetros
  # são acessados. A URL para essa action seria desse jeito
  # para mostrar os clientes ativos: /clients?status=activated
  def index
    if params[:status] == "activated"
      @clients = Client.activated
    else
      @clients = Client.inactivated
    end
  end

  # Essa action usa parâmetros de POST. Eles provavelmente estão
  # vindo de um formulário HTML que o usuário submeteu. A URL
  # para essa requisição RESTful será "/clients", e os dados
  # serão enviados como parte do corpo da requisição.
  def create
    @client = Client.new(params[:client])
    if @client.save
      redirect_to @client
    else
      # Essa linha sobrescreve o método padrão de renderização,
      # que seria chamado para renderizar a *view* "*create*"
      render "new"
    end
  end
end
'>Copy</button>
</div>
<h4 id="hash-e-parâmetros-de-array"><a class="anchorlink" href="#hash-e-par%C3%A2metros-de-array">4.1 Hash e Parâmetros de Array</a></h4><p>O <em>hash</em> <code>params</code> não é limitado a um vetor unidimensional de chaves e valores. Ele pode conter <em>arrays</em> e <em>hashes</em> aninhados. Para enviar um <em>array</em> de valores, concatene um par de colchetes vazio "[]" ao nome da chave:</p><div class="code_container">
<pre><code class="highlight plaintext">GET /clients?ids[]=1&amp;ids[]=2&amp;ids[]=3
</code></pre>
<button class="clipboard-button" data-clipboard-text="GET /clients?ids[]=1&amp;ids[]=2&amp;ids[]=3
">Copy</button>
</div>
<div class="note"><p>A URL efetiva neste neste exemplo será codificada como "/clients?ids%5b%5d=1&amp;ids%5b%5d=2&amp;ids%5b%5d=3", visto que os caracteres "[" e "]" não são permitidos em URLs. Na maioria do tempo você não precisa se preocupar com isso porque o navegador irá codificar os dados para você, e o Rails vai decodificá-los automaticamente, porém se por acaso você se encontrar na situação de ter que enviar este tipo de requisição ao servidor manualmente você deve ter em mente essa questão.</p></div><p>O valor de <code>params[:ids]</code> será neste caso <code>["1", "2", "3"]</code>. Note que os valores de parâmetros são sempre <em>strings</em>; o Rails não tenta adivinhar ou converter o tipo.</p><div class="note"><p>Valores como <code>[nil]</code> ou <code>[nil, nil, ...]</code> em <code>params</code> são substituídos por <code>[]</code> por motivos de segurança por padrão. Veja o <a href="security.html#unsafe-query-generation">Guia de Segurança</a> para mais informações.</p></div><p>Para enviar um <em>hash</em>, você inclui o nome da chave dentro dos colchetes:</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/clients"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"client[name]"</span> <span class="na">value=</span><span class="s">"Acme"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"client[phone]"</span> <span class="na">value=</span><span class="s">"12345"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"client[address][postcode]"</span> <span class="na">value=</span><span class="s">"12345"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"client[address][city]"</span> <span class="na">value=</span><span class="s">"Carrot City"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;form accept-charset="UTF-8" action="/clients" method="post"&gt;
  &lt;input type="text" name="client[name]" value="Acme" /&gt;
  &lt;input type="text" name="client[phone]" value="12345" /&gt;
  &lt;input type="text" name="client[address][postcode]" value="12345" /&gt;
  &lt;input type="text" name="client[address][city]" value="Carrot City" /&gt;
&lt;/form&gt;
'>Copy</button>
</div>
<p>Quando esse formulário é enviado o valor de <code>params[:client]</code> será <code>{ "name" =&gt; "Acme", "phone" =&gt; "12345", "address" =&gt; { "postcode" =&gt; "12345", "city" =&gt; "Carrot City" } }</code>. Repare o <em>hash</em> aninhado em <code>params[:client][:address]</code>.</p><p>O objeto <code>params</code> atua como um <em>hash</em>, mas permite que você use <em>symbols</em> e <em>strings</em> indistintamente como chaves.</p><h4 id="parâmetros-json"><a class="anchorlink" href="#par%C3%A2metros-json">4.2 Parâmetros JSON</a></h4><p>Se você está construindo uma aplicação <em>web</em>, você pode achar mais confortável receber parâmetros no formato JSON. Se o <em>header</em> "Content-Type" da sua requisição estiver definido como "application/json" o Rails vai automaticamente carregar os seus parâmetros no <em>hash</em> <code>params</code>, que você pode acessar como acessaria normalmente.</p><p>Então por exemplo, se você estiver enviando este conteúdo JSON:</p><div class="code_container">
<pre><code class="highlight json"><span class="p">{</span><span class="w"> </span><span class="nl">"company"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"acme"</span><span class="p">,</span><span class="w"> </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123 Carrot Street"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='{ "company": { "name": "acme", "address": "123 Carrot Street" } }
'>Copy</button>
</div>
<p>O seu <em>controller</em> vai receber <code>params[:company]</code> no formato <code>{ "name" =&gt; "acme", "address" =&gt; "123 Carrot Street" }</code>.</p><p>Além disso, se você tiver ativado <code>config.wrap_parameters</code> no seu inicializador ou chamado <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/ParamsWrapper/Options/ClassMethods.html#method-i-wrap_parameters"><code>wrap_parameters</code></a> no seu <em>controller</em>, você pode omitir o elemento raiz no seu parâmetro JSON. Neste caso, os parâmetros serão clonados e enpacotados sob uma chave baseada no nome do seu <em>controller</em>. Então a requisição JSON acima pode ser escrita como:</p><div class="code_container">
<pre><code class="highlight json"><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"acme"</span><span class="p">,</span><span class="w"> </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123 Carrot Street"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='{ "name": "acme", "address": "123 Carrot Street" }
'>Copy</button>
</div>
<p>E, assumindo que você está enviando os dados para <code>CompaniesController</code>, eles serão então encapsulados na chave <code>:company</code> desta maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="p">{</span> <span class="ss">name: </span><span class="s2">"acme"</span><span class="p">,</span> <span class="ss">address: </span><span class="s2">"123 Carrot Street"</span><span class="p">,</span> <span class="ss">company: </span><span class="p">{</span> <span class="ss">name: </span><span class="s2">"acme"</span><span class="p">,</span> <span class="ss">address: </span><span class="s2">"123 Carrot Street"</span> <span class="p">}</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='{ name: "acme", address: "123 Carrot Street", company: { name: "acme", address: "123 Carrot Street" } }
'>Copy</button>
</div>
<p>Você pode customizar o nome da chave ou parâmetros específicos que você quer envelopar consultando a <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/ParamsWrapper.html">documentação da API</a></p><div class="note"><p>Suporte para interpretar parâmetros XML foi extraído para uma <em>gem</em> chamada <code>actionpack-xml_parser</code>.</p></div><h4 id="parâmetros-de-rota"><a class="anchorlink" href="#par%C3%A2metros-de-rota">4.3 Parâmetros de Rota</a></h4><p>O <em>hash</em> <code>params</code> sempre irá conter as chaves <code>:controller</code> e <code>:action</code>, mas você deve usar os métodos <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Metal.html#method-i-controller_name"><code>controller_name</code></a> e <a href="https://api.rubyonrails.org/v7.0.8/classes/AbstractController/Base.html#method-i-action_name"><code>action_name</code></a> para acessar estes valores. Quaisquer outros parâmetros definidos pela rota, como <code>:id</code>, também estarão disponíveis. Por exemplo, considere uma listagem de clientes onde a lista pode mostrar os clientes ativos e inativos. Nós podemos adicionar uma rota que captura o parâmetro <code>:status</code> numa URL "normalizada":</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'/clients/:status'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'clients#index'</span><span class="p">,</span> <span class="ss">foo: </span><span class="s1">'bar'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get '/clients/:status', to: 'clients#index', foo: 'bar'
">Copy</button>
</div>
<p>Neste caso, quando um usuário abrir a URL <code>/clients/active</code>, <code>params[:status]</code> estará definido como "active". Quando esta rota é usada, <code>params[:foo]</code> também será definido como "bar", como se tivesse sido enviado por meio da <em>query string</em>. O seu <em>controller</em> também irá receber <code>params[:action]</code> com o valor "index" e <code>params[:controller]</code> com o valor "clients".</p><h4 id="default-url-options"><a class="anchorlink" href="#default-url-options">4.4 <code>default_url_options</code></a></h4><p>Você pode determinar parâmetros padrão globais para a geração de URLs definindo um método chamado <code>default_url_options</code> no seu <em>controller</em>. Este método deve retornar um <em>hash</em> com os dados padrão desejados, cujas chaves devem ser símbolos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">default_url_options</span>
    <span class="p">{</span> <span class="ss">locale: </span><span class="no">I18n</span><span class="p">.</span><span class="nf">locale</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationController &lt; ActionController::Base
  def default_url_options
    { locale: I18n.locale }
  end
end
">Copy</button>
</div>
<p>Estas opções serão usadas como um ponto de partida na geração de URLs, então é possível que elas sejam sobrescritas pelas opções passadas para chamadas a <code>url_for</code>.</p><p>Se você definir <code>default_url_options</code> em <code>ApplicationController</code>, como no exemplo acima, estes padrões irão ser usados para todas as gerações de URL. O método pode também ser definido num <em>controller</em> específico, neste caso afetando somente as URLs geradas a partir desse escopo.</p><p>Numa requisição o método não é de fato chamado para toda URL gerada. Por questões de performance o <em>hash</em> retornado é cacheado, e há no máximo uma invocação por requisição.</p><h4 id="parâmetros-fortes"><a class="anchorlink" href="#par%C3%A2metros-fortes">4.5 Parâmetros Fortes</a></h4><p>Com parâmetros fortes (<em>strong parameters</em>), os parâmetros do <em>Action Controller</em> são proibidos de serem usados nas atribuições em massa no <em>Active Model</em> até que sejam deliberadamente permitidos. Isso significa que você tem que tomar uma decisão consciente sobre quais atributos podem ser permitidos para um <em>update</em> em massa. Esta é uma prática mais segura para ajudar a prevenir que acidentalmente os usuários atualizem atributos sensíveis do <em>model</em>.</p><p>Além disso, os parâmetros podem ser marcados como obrigatórios e irão seguir por um fluxo de erro e tratamento predefinido que irá resultar num código 400 <em>Bad Request</em> sendo retornado caso todos os parâmetros obrigatórios não forem informados.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PeopleController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Isso vai lançar uma exceção do tipo ActiveModel::ForbiddenAttributesError</span>
  <span class="c1"># porque está usando atribuição em massa sem passar pela etapa de permitir</span>
  <span class="c1"># explicitamente os parâmetros.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:person</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="c1"># Isso irá passar contanto que exista uma chave de *person* nos parâmetros,</span>
  <span class="c1"># caso contrário o código irá lançar uma exceção do tipo</span>
  <span class="c1"># ActionController::ParameterMissing, que será capturada pelo</span>
  <span class="c1"># ActionController::Base e transformada num erro 400 Bad Request.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">current_account</span><span class="p">.</span><span class="nf">people</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">person</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="n">person_params</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="n">person</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="c1"># Usar um método privado para encapsular os parâmetros permissíveis</span>
    <span class="c1"># é um bom padrão visto que que você poderá reusar a mesma lista</span>
    <span class="c1"># para as actions create e update. Você também pode especificar</span>
    <span class="c1"># este método com a checagem de atributos permitidos de acordo com</span>
    <span class="c1"># cada usuário.</span>
    <span class="k">def</span> <span class="nf">person_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:person</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:age</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PeopleController &lt; ActionController::Base
  # Isso vai lançar uma exceção do tipo ActiveModel::ForbiddenAttributesError
  # porque está usando atribuição em massa sem passar pela etapa de permitir
  # explicitamente os parâmetros.
  def create
    Person.create(params[:person])
  end

  # Isso irá passar contanto que exista uma chave de *person* nos parâmetros,
  # caso contrário o código irá lançar uma exceção do tipo
  # ActionController::ParameterMissing, que será capturada pelo
  # ActionController::Base e transformada num erro 400 Bad Request.
  def update
    person = current_account.people.find(params[:id])
    person.update!(person_params)
    redirect_to person
  end

  private
    # Usar um método privado para encapsular os parâmetros permissíveis
    # é um bom padrão visto que que você poderá reusar a mesma lista
    # para as actions create e update. Você também pode especificar
    # este método com a checagem de atributos permitidos de acordo com
    # cada usuário.
    def person_params
      params.require(:person).permit(:name, :age)
    end
end
">Copy</button>
</div>
<h5 id="valores-escalares-permitidos"><a class="anchorlink" href="#valores-escalares-permitidos">4.5.1 Valores Escalares Permitidos</a></h5><p>Chamando <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Parameters.html#method-i-permit"><code>permit</code></a> como:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="params.permit(:id)
">Copy</button>
</div>
<p>permite a chave especificada (<code>:id</code>) para inclusão se ela aparecer em <code>params</code> e ela tiver um valor escalar permitido associado a ela. Caso contrário a chave será filtrada, então <em>arrays</em>, <em>hashes</em>, ou quaisquer outros objetos não poderão ser adicionados.</p><p>Os tipos escalares permitidos são <code>String</code>, <code>Symbol</code>, <code>NilClass</code>, <code>Numeric</code>, <code>TrueClass</code>, <code>FalseClass</code>, <code>Date</code>, <code>Time</code>, <code>DateTime</code>, <code>StringIO</code>, <code>IO</code>, <code>ActionDispatch::Http::UploadedFile</code>, e <code>Rack::Test::UploadedFile</code>.</p><p>Para declarar que o valor em <code>params</code> deve ser um <em>array</em> de valores escalares permitidos, mapeie a chave para um <em>array</em> vazio.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">id: </span><span class="p">[])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="params.permit(id: [])
">Copy</button>
</div>
<p>Às vezes não é possível ou conveniente declarar as chaves válidas de um parâmetro de <em>hash</em> ou sua estrutura interna. Apenas mapeie para um <em>hash</em> vazio:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">preferences: </span><span class="p">{})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="params.permit(preferences: {})
">Copy</button>
</div>
<p>entretanto fique atento porque isso abre a porta para <em>input</em> arbitrário. Neste caso, <code>permit</code> garante que os valores na estrutura retornada são valores escalares permitidos e faz a filtragem de tudo o que houver além deles.</p><p>Para permitir um <em>hash</em> completo de parâmetros, o método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Parameters.html#method-i-permit-21"><code>permit!</code></a> pode ser usado:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:log_entry</span><span class="p">).</span><span class="nf">permit!</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="params.require(:log_entry).permit!
">Copy</button>
</div>
<p>Este código marca o <em>hash</em> de parâmetros <code>:log_entry</code> e qualquer <em>sub-hash</em> dele como valores permitidos e não verifica por escalares permitidos, sendo qualquer coisa a partir dele aceita.
Extremo cuidado deve ser considerado ao usar o método <code>permit!</code>, visto que ele irá permitir que todos os atuais e futuros atributos do <code>model</code> sejam preenchidos em massa.</p><h5 id="parâmetros-aninhados"><a class="anchorlink" href="#par%C3%A2metros-aninhados">4.5.2 Parâmetros Aninhados</a></h5><p>Você também pode usar <code>permit</code> em parâmetros aninhados, da seguinte forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="p">{</span> <span class="ss">emails: </span><span class="p">[]</span> <span class="p">},</span>
              <span class="ss">friends: </span><span class="p">[</span> <span class="ss">:name</span><span class="p">,</span>
                         <span class="p">{</span> <span class="ss">family: </span><span class="p">[</span> <span class="ss">:name</span> <span class="p">],</span> <span class="ss">hobbies: </span><span class="p">[]</span> <span class="p">}])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="params.permit(:name, { emails: [] },
              friends: [ :name,
                         { family: [ :name ], hobbies: [] }])
">Copy</button>
</div>
<p>Esta declaração permite o preenchimento dos atributos <code>name</code>, <code>emails</code>, e <code>friends</code>. É esperado que <code>emails</code> seja um <em>array</em> de valores permitidos escalares, e que <code>friends</code> seja um <em>array</em> de recursos com atributos específicos: deve possuir um atributo <code>name</code> (com quaisquer valores escalares permitidos), um atributo <code>hobbies</code> como um <em>array</em> de valores permitidos escalares, e um atributo <code>family</code> que é restrito a ter um <code>name</code> (com qualquer valor escalar permitido também).</p><h5 id="mais-exemplos"><a class="anchorlink" href="#mais-exemplos">4.5.3 Mais Exemplos</a></h5><p>Você pode também querer usar os atributos permitidos na sua <em>action</em> <code>new</code>. Isso traz o problema que você não pode chamar <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Parameters.html#method-i-require"><code>require</code></a> na chave raiz porque normalmente ela não existe no momento da chamada de <code>new</code></p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># usando fetch você pode fornecer um valor padrão e visualizar</span>
<span class="c1"># a API de Parâmetros Fortes a partir dele.</span>
<span class="n">params</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:blog</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:author</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# usando fetch você pode fornecer um valor padrão e visualizar
# a API de Parâmetros Fortes a partir dele.
params.fetch(:blog, {}).permit(:title, :author)
">Copy</button>
</div>
<p>O método da classe <em>model</em> <code>accepts_nested_attributes_for</code> te permite atualizar e destruir outros <em>models</em> associados. Isso é baseado nos parâmetros <code>id</code> e <code>_destroy</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># permite :id e :_destroy</span>
<span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:author</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">books_attributes: </span><span class="p">[</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:_destroy</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# permite :id e :_destroy
params.require(:author).permit(:name, books_attributes: [:title, :id, :_destroy])
">Copy</button>
</div>
<p><em>Hashes</em> com chaves de valor do tipo inteiro são tratados de maneira diferente, e você pode declarar os atributos como se eles fossem atributos filhos imediatos. Você obtém estes tipos de parâmetros quando você usa <code>accepts_nested_attributes_for</code> combinado com uma associação <code>has_many</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Para permitir os seguintes dados:</span>
<span class="c1"># {"book" =&gt; {"title" =&gt; "Some Book",</span>
<span class="c1">#             "chapters_attributes" =&gt; { "1" =&gt; {"title" =&gt; "First Chapter"},</span>
<span class="c1">#                                        "2" =&gt; {"title" =&gt; "Second Chapter"}}}}</span>
<span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:book</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">chapters_attributes: </span><span class="p">[</span><span class="ss">:title</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# Para permitir os seguintes dados:
# {"book" =&gt; {"title" =&gt; "Some Book",
#             "chapters_attributes" =&gt; { "1" =&gt; {"title" =&gt; "First Chapter"},
#                                        "2" =&gt; {"title" =&gt; "Second Chapter"}}}}
params.require(:book).permit(:title, chapters_attributes: [:title])
'>Copy</button>
</div>
<p>Imagine um cenário onde você tem parâmetros representando um nome de produto e um <em>hash</em> de dados arbitrários associado a esse produto, e você queira permitir o preenchimento do atributo de nome do produto e também o <em>hash</em> de dados:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">product_params</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{})</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="def product_params
  params.require(:product).permit(:name, data: {})
end
">Copy</button>
</div>
<h5 id="fora-do-escopo-de-parâmetros-fortes"><a class="anchorlink" href="#fora-do-escopo-de-par%C3%A2metros-fortes">4.5.4 Fora do Escopo de Parâmetros Fortes</a></h5><p>A API de parâmetros fortes foi desenhada com os casos mais comuns em mente. Não houve a intenção de torná-la uma bala prateada para lidar com todos os seus problemas de filtragem de parâmetros. Entretanto, você pode facilmente misturar a API com seu próprio código para se adaptar à sua situação.</p><h3 id="sessão"><a class="anchorlink" href="#sess%C3%A3o">5 Sessão</a></h3><p>Sua aplicação possui uma sessão para cada usuário, na qual pode-se armazenar quantidades pequenas de dados que serão persistidos entre as requisições. A sessão fica disponível apenas no <em>controller</em> e na <em>view</em> e pode utilizar um dentre vários mecanismos diferentes de armazenamento:</p>
<ul>
<li>
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Session/CookieStore.html"><code>ActionDispatch::Session::CookieStore</code></a> - Armazena tudo no cliente.</li>
<li>
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Session/CacheStore.html"><code>ActionDispatch::Session::CacheStore</code></a> - Armazena os dados no <em>cache</em> do Rails.</li>
<li>
<code>ActionDispatch::Session::ActiveRecordStore</code> - Armazena os dados em um banco de dados utilizando o <em>Active Record</em>. (a gem <code>activerecord-session_store</code> é necessária).</li>
<li>
<a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Session/MemCacheStore.html"><code>ActionDispatch::Session::MemCacheStore</code></a> - Armazena os dados em um <em>cluster</em> de <em>cache</em> de memória (esta é uma implementação legada; considere utilizar o <code>CacheStore</code> como alternativa)</li>
</ul>
<p>Todos os armazenamentos de sessão utilizam um <em>cookie</em> para armazenar um ID único para cada sessão (você deve utilizar um <em>cookie</em>, o Rails não permitirá que você passe o ID da sessão na URL, pois isso é menos seguro).</p><p>Para a maioria dos armazenamentos, esse ID é utilizado para procurar os dados da sessão no servidor, por exemplo, em uma tabela do banco de dados. Há apenas uma exceção, que é o armazenamento de sessão recomendado por padrão - o <em>CookieStore</em> - que armazena todos os dados da sessão no próprio <em>cookie</em> (o ID ainda estará disponível para você, se você precisar). A vantagem é a de ser muito leve e requer zero configuração em uma nova aplicação para utilizar a sessão. Os dados do <em>cookie</em> são assinados criptograficamente para torná-los invioláveis, e também é criptografado para que qualquer pessoa com acesso não leia o seu conteúdo. (O Rails não aceitará se estiver sido editado).</p><p>O <em>CookieStore</em> pode armazenar cerca de 4 kB de dados - muito menos que os demais - mas geralmente é o suficiente. O armazenamento de grandes quantidades de dados na sessão não é recomendado, independentemente de qual armazenamento de sessão sua aplicação utiliza. Você deve evitar armazenar objetos complexos (como instâncias de <code>model</code>) na sessão, pois o servidor pode não ser capaz de remontá-los entre as requisições, o que resultará em um erro.</p><p>Se as suas sessões de usuário não armazenam dados críticos ou não precisam durar por longos períodos (por exemplo, se você apenas utiliza o <em>flash</em> para mensagens), considere o uso do <code>ActionDispatch::Session::CacheStore</code>. Isso armazenará as sessões utilizando a implementação de <em>cache</em> que você configurou para a sua aplicação. A vantagem é que você pode utilizar sua infraestrutura de <em>cache</em> existente para armazenar sessões sem precisar de nenhuma configuração ou administração adicional. A desvantagem é que as sessões serão temporárias e poderão desaparecer a qualquer momento.</p><p>Leia mais sobre armazenamento de sessão no <a href="security.html">Guia de Segurança</a>.</p><p>Se você precisar de um mecanismo diferente de sessão de armazenamento, você poderá alterá-lo no <em>initializer</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Use the database for sessions instead of the cookie-based default,</span>
<span class="c1"># which shouldn't be used to store highly confidential information</span>
<span class="c1"># (create the session table with "rails g active_record:session_migration")</span>
<span class="c1"># Rails.application.config.session_store :active_record_store</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Use the database for sessions instead of the cookie-based default,
# which shouldn't be used to store highly confidential information
# (create the session table with &quot;rails g active_record:session_migration&quot;)
# Rails.application.config.session_store :active_record_store
">Copy</button>
</div>
<p>O Rails configura uma chave de sessão (o nome do <em>cookie</em>) ao assinar os dados da sessão. Estes também podem ser alterados no <em>initializer</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Be sure to restart your server when you modify this file.</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'_your_app_session'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Be sure to restart your server when you modify this file.
Rails.application.config.session_store :cookie_store, key: '_your_app_session'
">Copy</button>
</div>
<p>Você também pode passar uma chave <code>:domain</code> e especificar o nome do domínio para o <em>cookie</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Be sure to restart your server when you modify this file.</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'_your_app_session'</span><span class="p">,</span> <span class="ss">domain: </span><span class="s2">".example.com"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Be sure to restart your server when you modify this file.
Rails.application.config.session_store :cookie_store, key: '_your_app_session', domain: &quot;.example.com&quot;
">Copy</button>
</div>
<p>O Rails configura (para o <em>CookieStore</em>) uma chave secreta utilizada para assinar os dados da sessão em <code>config/credentials.yml.enc</code>. Isso pode ser alterado com o comando <code>bin/rails credentials:edit</code>.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="c1"># aws:</span>
<span class="c1">#   access_key_id: 123</span>
<span class="c1">#   secret_access_key: 345</span>

<span class="c1"># Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.</span>
<span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">492f...</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: 492f...
">Copy</button>
</div>
<div class="note"><p>Alterar a <code>secret_key_base</code> ao utilizar o <code>CookieStore</code> invalidará todas as sessões existentes.</p></div><h4 id="acessando-a-sessão"><a class="anchorlink" href="#acessando-a-sess%C3%A3o">5.1 Acessando a Sessão</a></h4><p>No seu <em>controller</em>, você pode acessar a sessão através do método de instância <code>session</code>.</p><div class="note"><p>As sessões são <a href="https://pt.wikipedia.org/wiki/Lazy_loading"><em>lazy loading</em></a> (carregamento lento). Se você não acessá-las no código da sua <em>action</em>, elas não serão carregadas. Portanto, você nunca precisará desativar as sessões, basta apenas não acessá-las.</p></div><p>Os valores da sessão são armazenados utilizando pares de chave/valor como em um <em>hash</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

  <span class="kp">private</span>

  <span class="c1"># Finds the User with the ID stored in the session with the key</span>
  <span class="c1"># :current_user_id This is a common way to handle user login in</span>
  <span class="c1"># a Rails application; logging in sets the session value and</span>
  <span class="c1"># logging out removes it.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@_current_user</span> <span class="o">||=</span> <span class="n">session</span><span class="p">[</span><span class="ss">:current_user_id</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
      <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">session</span><span class="p">[</span><span class="ss">:current_user_id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationController &lt; ActionController::Base

  private

  # Finds the User with the ID stored in the session with the key
  # :current_user_id This is a common way to handle user login in
  # a Rails application; logging in sets the session value and
  # logging out removes it.
  def current_user
    @_current_user ||= session[:current_user_id] &amp;&amp;
      User.find_by(id: session[:current_user_id])
  end
end
">Copy</button>
</div>
<p>Para armazenar algo na sessão, basta atribuí-lo à chave como em um <em>hash</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">LoginsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># "Create" a login, aka "log the user in"</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:username</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="ss">:password</span><span class="p">])</span>
      <span class="c1"># Save the user ID in the session so it can be used in</span>
      <span class="c1"># subsequent requests</span>
      <span class="n">session</span><span class="p">[</span><span class="ss">:current_user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class LoginsController &lt; ApplicationController
  # "Create" a login, aka "log the user in"
  def create
    if user = User.authenticate(params[:username], params[:password])
      # Save the user ID in the session so it can be used in
      # subsequent requests
      session[:current_user_id] = user.id
      redirect_to root_url
    end
  end
end
'>Copy</button>
</div>
<p>Para remover algo da sessão, exclua o par de chave/valor:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">LoginsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># "Delete" a login, aka "log the user out"</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="c1"># Remove the user id from the session</span>
    <span class="n">session</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:current_user_id</span><span class="p">)</span>
    <span class="c1"># Clear the memoized current user</span>
    <span class="vi">@_current_user</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">status: :see_other</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class LoginsController &lt; ApplicationController
  # "Delete" a login, aka "log the user out"
  def destroy
    # Remove the user id from the session
    session.delete(:current_user_id)
    # Clear the memoized current user
    @_current_user = nil
    redirect_to root_url, status: :see_other
  end
end
'>Copy</button>
</div>
<p>Para redefinir a sessão inteira, utilize <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Metal.html#method-i-reset_session"><code>reset_session</code></a>.</p><h4 id="o-flash"><a class="anchorlink" href="#o-flash">5.2 O <em>Flash</em></a></h4><p>O <em>flash</em> é uma parte especial da sessão, que é limpo a cada requisição. Isso significa que os valores armazenados nele estarão disponíveis somente para a próxima requisição, sendo úteis para enviar mensagens de erro, etc.</p><p>O <em>flash</em> é acessado através do método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Flash/RequestMethods.html#method-i-flash"><code>flash</code></a>. Assim como a sessão, o <em>flash</em> é representado por um objeto <em>hash</em>.</p><p>Usaremos o evento de <em>logout</em> do usuário como exemplo. O <em>controller</em> pode enviar uma mensagem que será exibida na próxima requisição:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">LoginsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">session</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:current_user_id</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Você foi deslogado com sucesso."</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">status: :see_other</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class LoginsController &lt; ApplicationController
  def destroy
    session.delete(:current_user_id)
    flash[:notice] = "Você foi deslogado com sucesso."
    redirect_to root_url, status: :see_other
  end
end
'>Copy</button>
</div>
<p>Observe que também é possível definir uma mensagem <em>flash</em> como parte do redirecionamento. Você pode usar <code>:notice</code>, <code>:alert</code> ou o mais genérico, <code>:flash</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"Você foi deslogado com sucesso."</span>
<span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">alert: </span><span class="s2">"Você está preso aqui!"</span>
<span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">flash: </span><span class="p">{</span> <span class="ss">referral_code: </span><span class="mi">1234</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='redirect_to root_url, notice: "Você foi deslogado com sucesso."
redirect_to root_url, alert: "Você está preso aqui!"
redirect_to root_url, flash: { referral_code: 1234 }
'>Copy</button>
</div>
<p>A <em>action</em> <code>destroy</code> redireciona para a <code>root_url</code> da aplicação, onde a mensagem será exibida. Note que é responsabilidade da próxima <em>action</em> decidir o que (e até mesmo se algo) será feito com o valor anterior contido no <em>flash</em>. É comum exibir quaisquer erros, alertas ou avisos vindos do <em>flash</em> no <em>layout</em> da aplicação:</p><div class="code_container">
<pre><code class="highlight erb"><span class="nt">&lt;html&gt;</span>
  <span class="c">&lt;!-- &lt;head/&gt; --&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">flash</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">|</span> <span class="cp">-%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">content_tag</span> <span class="ss">:div</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="ss">class: </span><span class="nb">name</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">-%&gt;</span>

    <span class="c">&lt;!-- resto do conteúdo --&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;html&gt;
  &lt;!-- &lt;head/&gt; --&gt;
  &lt;body&gt;
    &lt;% flash.each do |name, msg| -%&gt;
      &lt;%= content_tag :div, msg, class: name %&gt;
    &lt;% end -%&gt;

    &lt;!-- resto do conteúdo --&gt;
  &lt;/body&gt;
&lt;/html&gt;
">Copy</button>
</div>
<p>Dessa forma, se uma <em>action</em> gerar um aviso, alerta ou mensagem, o <em>layout</em> o exibirá automaticamente.</p><p>É possível armazenar qualquer valor aceito pela <em>session</em> no <em>flash</em>, não ficando limitado somente aos avisos, alertas e mensagens:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:just_signed_up</span><span class="p">]</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"welcome"</span><span class="nt">&gt;</span>Welcome to our site!<span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;% if flash[:just_signed_up] %&gt;
  &lt;p class="welcome"&gt;Welcome to our site!&lt;/p&gt;
&lt;% end %&gt;
'>Copy</button>
</div>
<p>Se quiser que um <em>flash</em> seja acessado em uma outra requisição, use <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Flash/FlashHash.html#method-i-keep"><code>flash.keep</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MainController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># Digamos que essa action corresponde à root_url, mas você quer que</span>
  <span class="c1"># todas as requisições sejam redirecionadas para UsersController#index.</span>
  <span class="c1"># Se uma action definir o flash e for redirecionada para cá, os valores</span>
  <span class="c1"># seriam perdidos quando um ocorrer um outro redirecionamento.</span>
  <span class="c1"># Para persistir os valores e evitar que isso ocorra, utilize 'keep'.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="c1"># Persistirá os valores.</span>
    <span class="n">flash</span><span class="p">.</span><span class="nf">keep</span>

    <span class="c1"># Usando uma chave é possível persistir somente um tipo de valor:</span>
    <span class="c1"># flash.keep(:notice)</span>
    <span class="n">redirect_to</span> <span class="n">users_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class MainController &lt; ApplicationController
  # Digamos que essa action corresponde à root_url, mas você quer que
  # todas as requisições sejam redirecionadas para UsersController#index.
  # Se uma action definir o flash e for redirecionada para cá, os valores
  # seriam perdidos quando um ocorrer um outro redirecionamento.
  # Para persistir os valores e evitar que isso ocorra, utilize 'keep'.
  def index
    # Persistirá os valores.
    flash.keep

    # Usando uma chave é possível persistir somente um tipo de valor:
    # flash.keep(:notice)
    redirect_to users_url
  end
end
">Copy</button>
</div>
<h5 id="flash-now"><a class="anchorlink" href="#flash-now">5.2.1 <code>flash.now</code></a></h5><p>Por padrão, adicionar valores ao <em>flash</em> os tornará disponíveis somente na próxima requisição, mas em alguns casos, você pode querer acessar estes valores em uma mesma requisição. Por exemplo, se a <em>action</em> <code>create</code> falhar ao salvar um recurso e você renderizar o <em>template</em> <code>new</code> diretamente, isso não resultará em uma nova requisição, mas você ainda pode querer exibir a mensagem usando o <em>flash</em>. Para isso, é possível usar o <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Flash/FlashHash.html#method-i-now"><code>flash.now</code></a>, de maneira similar ao <code>flash</code> simples:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">client_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@client</span><span class="p">.</span><span class="nf">save</span>
      <span class="c1"># ...</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="p">.</span><span class="nf">now</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Não foi possível salvar o cliente."</span>
      <span class="n">render</span> <span class="ss">action: </span><span class="s2">"new"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ClientsController &lt; ApplicationController
  def create
    @client = Client.new(client_params)
    if @client.save
      # ...
    else
      flash.now[:error] = "Não foi possível salvar o cliente."
      render action: "new"
    end
  end
end
'>Copy</button>
</div>
<h3 id="cookies"><a class="anchorlink" href="#cookies">6 Cookies</a></h3><p>Sua Aplicação pode armazemar pequenas quantidades de dados no cliente - chamados de <em>cookies</em> - que serão mantidas entre requisições e até as sessões. O Rails fornece um fácil acesso para os <em>cookies</em> através do método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Cookies.html#method-i-cookies"><code>cookies</code></a>, que - assim como a <code>session</code> - funciona como um hash:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CommentsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="c1"># Preencher automaticamente o nome de quem comentou se ele estiver armazenado em um cookie</span>
    <span class="vi">@comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">author: </span><span class="n">cookies</span><span class="p">[</span><span class="ss">:commenter_name</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">comment_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@comment</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Thanks for your comment!"</span>
      <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:remember_name</span><span class="p">]</span>
        <span class="c1"># Lembrar o nome de quem fez o comentário</span>
        <span class="n">cookies</span><span class="p">[</span><span class="ss">:commenter_name</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@comment</span><span class="p">.</span><span class="nf">author</span>
      <span class="k">else</span>
        <span class="c1"># Deletar o cookie do nome de quem fez o comentário, caso exista.</span>
        <span class="n">cookies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:commenter_name</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">redirect_to</span> <span class="vi">@comment</span><span class="p">.</span><span class="nf">article</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">action: </span><span class="s2">"new"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class CommentsController &lt; ApplicationController
  def new
    # Preencher automaticamente o nome de quem comentou se ele estiver armazenado em um cookie
    @comment = Comment.new(author: cookies[:commenter_name])
  end

  def create
    @comment = Comment.new(comment_params)
    if @comment.save
      flash[:notice] = "Thanks for your comment!"
      if params[:remember_name]
        # Lembrar o nome de quem fez o comentário
        cookies[:commenter_name] = @comment.author
      else
        # Deletar o cookie do nome de quem fez o comentário, caso exista.
        cookies.delete(:commenter_name)
      end
      redirect_to @comment.article
    else
      render action: "new"
    end
  end
end
'>Copy</button>
</div>
<p>Perceba que enquanto para valores de sessão você pode definir a chave como <code>nil</code>, para deletar um valor de <em>cookie</em> você deve usar <code>cookies.delete(:key)</code>.</p><p>O Rails também fornece um <em>cookie jar</em> assinado e um <em>cookie jar</em> criptografado para amazenar
dados sensíveis. O <em>cookie jar</em> assinado anexa uma assinaura criptográfica nos
valores do <em>cookie</em> para proteger sua integridade. O <em>cookie jar</em> criptografado, criptografa os
valores além de assiná-los, para que eles não possam ser lidos pelo usuário final.
Consulte a <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Cookies.html">documentação da API (em inglês)</a>
para mais detalhes.</p><p>Esses <em>cookie jars</em> especiais usam um <em>serializer</em> para serializar os valores atribuídos em
strings e desserializa-os em objetos Ruby na leitura.</p><p>Você pode especificar qual <em>serializer</em> usar:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_serializer</span> <span class="o">=</span> <span class="ss">:json</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config.action_dispatch.cookies_serializer = :json
">Copy</button>
</div>
<p>O <em>serializer</em> padrão para novas aplicações é <code>:json</code>. Para compatibilidade com
aplicações antigas que usam <em>cookies</em>, o <code>:marshal</code> é usado quando a opção
<code>serializer</code> não está especificada.</p><p>Você também pode definir esta opção como <code>:hybrid</code>, nesse caso o Rails desserializaria
de forma transparente os <em>cookies</em> (serializados no formato <code>Marshal</code>) existentes ao ler e reescrevê-los
no formaro <code>JSON</code>. Isso é útil para migrar aplicações existentes para o
<em>serializer</em> <code>:json</code>.</p><p>Também é possível passar um <em>serializer</em> personalizado que responda a <code>load</code> e
<code>dump</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_serializer</span> <span class="o">=</span> <span class="no">MyCustomSerializer</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config.action_dispatch.cookies_serializer = MyCustomSerializer
">Copy</button>
</div>
<p>Ao usar o <em>serializer</em> <code>:json</code> ou <code>:hybrid</code>, lembre-se de que nem todos os
os objetos Ruby podem ser serializados como JSON. Por exemplo, objetos <code>Date</code> e<code>Time</code>
serão serializados como strings, e os <code>Hash</code>es terão suas chaves transformadas em string também.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CookiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">set_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">tomorrow</span> <span class="c1"># =&gt; Thu, 20 Mar 2014</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s1">'read_cookie'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="c1"># =&gt; "2014-03-20"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CookiesController &lt; ApplicationController
  def set_cookie
    cookies.encrypted[:expiration_date] = Date.tomorrow # =&gt; Thu, 20 Mar 2014
    redirect_to action: 'read_cookie'
  end

  def read_cookie
    cookies.encrypted[:expiration_date] # =&gt; &quot;2014-03-20&quot;
  end
end
">Copy</button>
</div>
<p>É aconselhável que você armazene apenas dados simples (strings e números) nos <em>cookies</em>.
Se você precisar armazenar objetos complexos, precisará lidar com a conversão
manualmente ao ler os valores em requisições subsequentes.</p><p>Se você usar o <em>cookie</em> de armazenamento de sessão, isso também se aplicaria aos <em>hashes</em> <code>session</code> e <code>flash</code>.</p><h3 id="renderizando-dados-xml-e-json"><a class="anchorlink" href="#renderizando-dados-xml-e-json">7 Renderizando Dados XML e JSON</a></h3><p>O <em>ActionController</em> faz com que renderizar dados <code>XML</code> ou <code>JSON</code> seja extremamente fácil. Se você gerou um <em>controller</em> usando o <em>scaffold</em>, será algo mais ou menos assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">all</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="c1"># index.html.erb</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">xml</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">xml: </span><span class="vi">@users</span> <span class="p">}</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@users</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class UsersController &lt; ApplicationController
  def index
    @users = User.all
    respond_to do |format|
      format.html # index.html.erb
      format.xml  { render xml: @users }
      format.json { render json: @users }
    end
  end
end
">Copy</button>
</div>
<p>Você pode observar que no código acima estamos usando <code>render xml: @users</code>, e não <code>render xml: @users.to_xml</code>. Se o objeto não é uma <em>String</em>, então o Rails automaticamente chama <code>to_xml</code> por nós.</p><h3 id="filtros"><a class="anchorlink" href="#filtros">8 Filtros</a></h3><p>Filtros são métodos que rodam "before" (antes de), "after" (depois de) ou "around" (em torno de) de uma ação de <em>controller</em>.</p><p>Filtros são herdados, então se você configurou um filtro em <code>ApplicationController</code>, o mesmo irá rodar em cada <em>controller</em> da sua aplicação.</p><p>Filtros "before" são registrados através do método <a href="https://api.rubyonrails.org/v7.0.8/classes/AbstractController/Callbacks/ClassMethods.html#method-i-before_action"><code>before_action</code></a>. Eles podem interromper o ciclo de uma requisição. Um filtro comum para "before" é o que requer que um usuário está logado para que uma ação seja executada. Você pode definir o método do filtro dessa forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="ss">:require_login</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">require_login</span>
        <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">flash</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"You must be logged in to access this section"</span>
        <span class="n">redirect_to</span> <span class="n">new_login_url</span> <span class="c1"># interrompe o ciclo da requisição</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ApplicationController &lt; ActionController::Base
  before_action :require_login

  private
    def require_login
        unless logged_in?
        flash[:error] = "You must be logged in to access this section"
        redirect_to new_login_url # interrompe o ciclo da requisição
        end
    end
end
'>Copy</button>
</div>
<p>Esse método simplesmente armazena uma mensagem de erro no <em>flash</em> e redireciona para o formulário de login se o usuário não estiver logado. Se um filtro "before" renderiza ou redireciona, a ação não será executada. Se filtros adicionais estão programados para executar após esse filtro, eles são cancelados também.</p><p>Nesse exemplo, o filtro é adicionado ao <code>ApplicationController</code> e dessa forma todos os <em>controllers</em> na aplicação irão herdar ele. Isso fará com que tudo na aplicação requeira que o usuário esteja logado para que ele possa usar. Por razões óbvias (o usuário não conseguiria fazer o log in para começo de conversa!), nem todos os <em>controllers</em> devem requerer isso. Você pode evitar esse filtro de ser executado antes de ações em particular com <a href="https://api.rubyonrails.org/v7.0.8/classes/AbstractController/Callbacks/ClassMethods.html#method-i-skip_before_action"><code>skip_before_action</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">LoginsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">skip_before_action</span> <span class="ss">:require_login</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class LoginsController &lt; ApplicationController
  skip_before_action :require_login, only: [:new, :create]
end
">Copy</button>
</div>
<p>Agora, as ações de <code>new</code> e <code>create</code> do <code>LoginsController</code> irão funcionar como antes sem requerer que o usuário esteja logado. A opção <code>:only</code> é usada para pular esse filtro somente para essas ações, e existe também a opção <code>:except</code> que funciona de maneira contrária. Essas opções podem ser utilizadas quando adicionamos filtros também, para que você possa adicionar um filtro que somente executa para as ações selecionadas.</p><div class="note"><p>Chamar o mesmo filtro múltiplas vezes com diferentes opções não irá funcionar,
já que a última definição do filtro irá sobreescrever as anteriores.</p></div><h4 id="filtros-after-e-around"><a class="anchorlink" href="#filtros-after-e-around">8.1 Filtros after e around</a></h4><p>Além de filtros "before", você pode também executar filtros depois que uma ação tenha sido executada, ou antes e depois em conjunto.</p><p>Filtros "after" são registrados através do método <a href="https://api.rubyonrails.org/v7.0.8/classes/AbstractController/Callbacks/ClassMethods.html#method-i-after_action"><code>after_action</code></a>. Eles são similares aos filtros "before", mas porque a ação já foi executada eles tem acesso a dados da resposta que serão enviados para o cliente. Obviamente, filtros "after" não podem impedir uma ação de ser executada. Note também que filtros "after" são executados somente após uma ação bem sucedida, mas não quando uma exceção é gerada durante o ciclo de uma requisição.</p><p>Filtros "around" são registrados através do método <a href="https://api.rubyonrails.org/v7.0.8/classes/AbstractController/Callbacks/ClassMethods.html#method-i-around_action"><code>around_action</code></a>. Eles são responsáveis por executar as ações associadas por <em>yield</em>, simular a como os <em>middlewares</em> do Rack funcionam.</p><p>Por exemplo, em um <em>website</em> aonde alterações possuem um fluxo de aprovação, um administrador pode pré-visualizar as mesmas facilmente, aplicando-as dentro de uma transação.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ChangesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">around_action</span> <span class="ss">:wrap_in_transaction</span><span class="p">,</span> <span class="ss">only: :show</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">wrap_in_transaction</span>
        <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
        <span class="k">begin</span>
            <span class="k">yield</span>
        <span class="k">ensure</span>
            <span class="k">raise</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Rollback</span>
        <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ChangesController &lt; ApplicationController
  around_action :wrap_in_transaction, only: :show

  private
    def wrap_in_transaction
        ActiveRecord::Base.transaction do
        begin
            yield
        ensure
            raise ActiveRecord::Rollback
        end
        end
    end
end
">Copy</button>
</div>
<p>Note que um filtro "around" também envolve a renderização. Em particular, no exemplo acima, se a <em>view</em> efetuar uma leitura no banco de dados (p. ex. usando um <em>scope</em>), a mesma é efetuada dentro de uma transação e então apresenta a informação para visualização.</p><p>Você pode escolher não efetuar <em>yield</em> e montar a resposta você mesmo, o que faria com que a ação não fosse executada.</p><h4 id="outras-formas-de-usar-filtros"><a class="anchorlink" href="#outras-formas-de-usar-filtros">8.2 Outras Formas de Usar Filtros</a></h4><p>Enquanto a forma mais comum de se utilizar filtros é criando métodos privados e usando <code>before_action</code>, <code>after_action</code>, ou <code>around_action</code> para adicioná-los, existem duas outras formas para fazer a mesma coisa.</p><p>A primeira é utilizar um bloco diretamente com método <code>*_action</code>. O bloco recebe o <em>controller</em> como um argumento. O filtro <code>require_login</code> acima pode ser reescrito para utilizar um bloco:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="k">do</span> <span class="o">|</span><span class="n">controller</span><span class="o">|</span>
    <span class="k">unless</span> <span class="n">controller</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:logged_in?</span><span class="p">)</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Você deve estar logado para acessar essa seção"</span>
      <span class="n">redirect_to</span> <span class="n">new_login_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ApplicationController &lt; ActionController::Base
  before_action do |controller|
    unless controller.send(:logged_in?)
      flash[:error] = "Você deve estar logado para acessar essa seção"
      redirect_to new_login_url
    end
  end
end
'>Copy</button>
</div>
<p>Note que, nesse caso, o filtro utiliza <code>send</code> porque o método <code>logged_in?</code> é privado e o filtro não é executado no escopo do <em>controller</em>. Essa não é a forma recomendada para implementar esse filtro em particular, mas em casos mais simples, ele pode ser útil.</p><p>Especificamente para <code>around_action</code>, o bloco também acessa a <code>action</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">around_action</span> <span class="p">{</span> <span class="o">|</span><span class="n">_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">|</span> <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">action</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="around_action { |_controller, action| time(&amp;action) }
">Copy</button>
</div>
<p>A segunda forma é utilizar uma classe (na verdade, qualquer objeto que responda aos métodos corretos serve) para gerenciar a filtragem. Isto é útil em casos mais complexos que não são possíveis de serem implementados de uma forma de fácil leitura e reutilizados usando as outras duas abordagens. Por exemplo, você pode reescrever o filtro de login novamente utilizando uma classe:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="no">LoginFilter</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">LoginFilter</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">before</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">controller</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:logged_in?</span><span class="p">)</span>
      <span class="n">controller</span><span class="p">.</span><span class="nf">flash</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Você deve estar logado para acessar essa seção"</span>
      <span class="n">controller</span><span class="p">.</span><span class="nf">redirect_to</span> <span class="n">controller</span><span class="p">.</span><span class="nf">new_login_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ApplicationController &lt; ActionController::Base
  before_action LoginFilter
end

class LoginFilter
  def self.before(controller)
    unless controller.send(:logged_in?)
      controller.flash[:error] = "Você deve estar logado para acessar essa seção"
      controller.redirect_to controller.new_login_url
    end
  end
end
'>Copy</button>
</div>
<p>Novamente, esse não é um exemplo ideal para esse filtro, pois não é executado dentro do escopo do <em>controller</em> mas recebe o mesmo como um argumento. A classe de filtro deve implementar um método com o mesmo nome do filtro, então para o filtro de <code>before_action</code> a classe deve implementar um método <code>before</code>, e assim em diante. O método <code>around</code> deve efetuar <code>yield</code> para executar a ação.</p><h3 id="proteção-de-falsificação-de-requisição"><a class="anchorlink" href="#prote%C3%A7%C3%A3o-de-falsifica%C3%A7%C3%A3o-de-requisi%C3%A7%C3%A3o">9 Proteção de falsificação de requisição</a></h3><p>Falsificação de requisições <em>cross-site</em> é um tipo de ataque no qual o site engana o usuário a fim de que ele faça requisições em outro site, possivelmente adicionando, alterando ou deletando informações naquela site sem o conhecimento ou a permissão do usuário.</p><p>O primeiro passo para evitar isso é ter certeza que todas as ações "destrutivas" (criar, atualizar, e destruir) possam ser acessadas somente via requisições que não sejam <em>GET</em>. Se você está seguindo as convenções <em>RESTful</em> você já está fazendo isso. Contudo, sites maliciosos continuam podendo enviar requisições não <em>GET</em> para o seu site facilmente, e é aí que a proteção de falsificação de requisição entra. Como o nome diz, ela te protege de requisições falsas.</p><p>A forma como isso é feito é adicionando um <em>token</em> não adivinhável que é conhecido apenas pelo seu servidor para cada requisição. Desta forma, se uma requisição chega sem um token conhecido, o seu acesso será negado.</p><p>Se você gera um <em>form</em> como este:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:username</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form_with model: @user do |form| %&gt;
  &lt;%= form.text_field :username %&gt;
  &lt;%= form.text_field :password %&gt;
&lt;% end %&gt;
">Copy</button>
</div>
<p>Você perceberá como o <em>token</em> é adicionado como um campo invisível.</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/users/1"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span>
       <span class="na">value=</span><span class="s">"67250ab105eb5ad10851c00a5621854a23af5489"</span>
       <span class="na">name=</span><span class="s">"authenticity_token"</span><span class="nt">/&gt;</span>
<span class="c">&lt;!-- fields --&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;form accept-charset="UTF-8" action="/users/1" method="post"&gt;
&lt;input type="hidden"
       value="67250ab105eb5ad10851c00a5621854a23af5489"
       name="authenticity_token"/&gt;
&lt;!-- fields --&gt;
&lt;/form&gt;
'>Copy</button>
</div>
<p>O Rails adiciona esse <em>token</em> para cada <em>form</em> que é gerado usando o <a href="form_helpers.html"><em>form helpers</em></a>, então na maior parte das vezes você não precisa se preocupar com isso. Se você está escrevendo um <em>form</em> manualmente ou precisa adicionar o <em>token</em> para outra sessão, ele está disponível por meio do método <code>form_authenticity_token</code>.</p><p>O <code>form_authenticity_token</code> gera um <em>token</em> de autenticação válido. Isso é útil em lugar aonde o Rails não adiciona o mesmo automaticamente, como em chamadas Ajax personalizadas.</p><p>O <a href="security.html">Guia de segurança</a> possui mais informações sobre isso e muitos outros problemas relacionados a segurança que você deve estar ciente quando desenvolve uma aplicação <em>web</em>.</p><h3 id="os-objetos-de-requisição-e-resposta"><a class="anchorlink" href="#os-objetos-de-requisi%C3%A7%C3%A3o-e-resposta">10 Os Objetos de Requisição e Resposta</a></h3><p>Em todo <em>controller</em>, existem dois métodos de acesso apontando para os objetos de requisição e de resposta associados com o ciclo de requisição que estiver em execução no momento. O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Base.html#method-i-request"><code>request</code></a> contém uma instância de <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Request.html"><code>ActionDispatch::Request</code></a> e o método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Base.html#method-i-response"><code>response</code></a> retorna um objeto de resposta representando o que será enviado de volta ao cliente.</p><h4 id="o-objeto-request"><a class="anchorlink" href="#o-objeto-request">10.1 O Objeto <code>request</code></a></h4><p>O objeto de requisição contém muitas informações úteis sobre a requisição proveniente do cliente. Para obter uma lista completa dos métodos disponíveis verifique a <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Request.html">documentação da API do Rails</a> e a <a href="https://www.rubydoc.info/github/rack/rack/Rack/Request">documentação do Rack</a>. Entre as propriedades que você pode acessar estão:</p>
<table>
<thead>
<tr>
<th>Propriedade de <code>request</code>
</th>
<th>Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>host</code></td>
<td>O <em>hostname</em> utilizado para esta requisição.</td>
</tr>
<tr>
<td><code>domain(n=2)</code></td>
<td>Os primeiros <code>n</code> segmentos do <em>hostname</em>, iniciando pela direita (o domínio de primeiro nível).</td>
</tr>
<tr>
<td><code>format</code></td>
<td>O tipo de conteúdo requisitado pelo cliente.</td>
</tr>
<tr>
<td><code>method</code></td>
<td>O método HTTP utilizado para a requisição.</td>
</tr>
<tr>
<td>
<code>get?</code>, <code>post?</code>, <code>patch?</code>, <code>put?</code>, <code>delete?</code>, <code>head?</code>
</td>
<td>Retorna <em>true</em> se o método HTTP é GET/POST/PATCH/PUT/DELETE/HEAD.</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>Retorna um <em>hash</em> contendo os <em>headers</em> associados com a requisição.</td>
</tr>
<tr>
<td><code>port</code></td>
<td>O número (<em>integer</em>) da porta utilizada para a requisição.</td>
</tr>
<tr>
<td><code>protocol</code></td>
<td>Retorna uma <em>string</em> contendo o protocolo utilizado, além do trecho "://". Por exemplo: "http://".</td>
</tr>
<tr>
<td><code>query_string</code></td>
<td>A <em>query string</em> da URL (todo o trecho após "?").</td>
</tr>
<tr>
<td><code>remote_ip</code></td>
<td>O endereço IP do cliente.</td>
</tr>
<tr>
<td><code>url</code></td>
<td>A URL completa utilizada para a requisição.</td>
</tr>
</tbody>
</table>
<h5 id="path-parameters-query-parameters-e-request-parameters"><a class="anchorlink" href="#path-parameters-query-parameters-e-request-parameters">10.1.1 <code>path_parameters</code>, <code>query_parameters</code>, e <code>request_parameters</code></a></h5><p>O <em>Rails</em> armazena todos os parâmetros enviados com a requisição no <em>hash</em> <code>params</code>, não importando se eles foram enviados como parte da <em>query string</em> ou no corpo da requisição. O objeto de requisição tem três métodos de acesso que te fornecem acesso a estes parâmetros dependendo de onde eles vieram. O <em>hash</em> <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Request.html#method-i-query_parameters"><code>query_parameters</code></a> contem os parâmetros que foram enviados por meio da <em>query_string</em> enquanto o <em>hash</em> <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Request.html#method-i-request_parameters"><code>request_parameters</code></a> contém os parâmetros enviados através do corpo da requisição. O <em>hash</em> <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Http/Parameters.html#method-i-path_parameters"><code>path_parameters</code></a> contém os parâmetros que foram reconhecidos pelo roteamento como parte do caminho que leva ao <em>controller</em> e <em>action</em> sendo executados.</p><h4 id="o-objeto-response"><a class="anchorlink" href="#o-objeto-response">10.2 O Objeto <code>response</code></a></h4><p>O objeto de resposta geralmente não é usado diretamente, mas é construído durante a execução da <em>action</em> e renderização dos dados que serão enviados de volta ao usuário, porém às vezes - como num filtro posterior - ele pode ser útil para acessar a resposta diretamente. Alguns destes métodos de acesso também possuem <em>setters</em>, lhe permitindo mudar seus valores. Para obter uma lista completa dos métodos disponíveis verifique a <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/Response.html">documentação da API do Rails</a> e a <a href="https://www.rubydoc.info/github/rack/rack/Rack/Response">documentação do Rack</a>;</p>
<table>
<thead>
<tr>
<th>Propriedade de <code>response</code>
</th>
<th>Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>body</code></td>
<td>Esta é a <em>string</em> de dados sendo enviada de volta ao usuário. Na maioria dos casos se trata de código HTML.</td>
</tr>
<tr>
<td><code>status</code></td>
<td>O código de <em>status</em> HTTP para a resposta, como um código 200 para uma requisição bem sucedida ou 404 para um arquivo não encontrado.</td>
</tr>
<tr>
<td><code>location</code></td>
<td>A URL que o cliente estiver sendo redirecionado para, caso haja alguma.</td>
</tr>
<tr>
<td><code>content_type</code></td>
<td>O tipo de conteúdo da resposta.</td>
</tr>
<tr>
<td><code>charset</code></td>
<td>O conjunto de caracteres sendo utilizado na resposta. O valor padrão é "utf-8".</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>
<em>Headers</em> utilizados para a resposta.</td>
</tr>
</tbody>
</table>
<h5 id="definindo-headers-customizados"><a class="anchorlink" href="#definindo-headers-customizados">10.2.1 Definindo <em>Headers</em> customizados</a></h5><p>Se você quer definir <em>headers</em> customizados para uma resposta então <code>response.headers</code> é o local indicado para ajustar isto. O atributo <em>headers</em> é um <em>hash</em> que mapeia os nomes dos <em>headers</em> para seus respectivos valores, e o Rails irá definir alguns deles automaticamente. Se você quiser adicionar ou modificar um <em>header</em>, basta sinalizá-lo para <code>response.headers</code> da seguinte maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"Content-Type"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"application/pdf"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='response.headers["Content-Type"] = "application/pdf"
'>Copy</button>
</div>
<div class="note"><p>No caso acima faria mais sentido utilizar o <em>setter</em> <code>content_type</code> diretamente.</p></div><h3 id="autenticações-http"><a class="anchorlink" href="#autentica%C3%A7%C3%B5es-http">11 Autenticações HTTP</a></h3><p>O Rails vem com três mecanismos de autenticação HTTP embutidos:</p>
<ul>
<li>Autenticação <em>Basic</em>
</li>
<li>Autenticação <em>Digest</em>
</li>
<li>Autenticação <em>Token</em>
</li>
</ul>
<h4 id="autenticação-http-basic"><a class="anchorlink" href="#autentica%C3%A7%C3%A3o-http-basic">11.1 Autenticação HTTP <em>Basic</em></a></h4><p>Autenticação HTTP <em>basic</em> é um esquema de autenticação que é suportado pela maioria dos navegadores e outros clientes HTTP. Como um exemplo, considere uma página de administração que será acessável apenas informando um nome de usuário e uma senha na janela de autenticação HTTP <em>basic</em> do navegador. Usar a autenticação embutida é bem fácil e apenas requer que você use um método, <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/HttpAuthentication/Basic/ControllerMethods/ClassMethods.html#method-i-http_basic_authenticate_with"><code>http_basic_authenticate_with</code></a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AdminsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">http_basic_authenticate_with</span> <span class="ss">name: </span><span class="s2">"humbaba"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"5baa61e4"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class AdminsController &lt; ApplicationController
  http_basic_authenticate_with name: "humbaba", password: "5baa61e4"
end
'>Copy</button>
</div>
<p>Com isso, você pode criar <em>controllers</em> com <em>namespaces</em> que herdam de <code>AdminsController</code>. O filtro vai, assim, ser executado para todas as ações nos <em>controllers</em>, protegendo-os com a autenticação HTTP <em>basic</em>.</p><h4 id="autenticação-http-digest"><a class="anchorlink" href="#autentica%C3%A7%C3%A3o-http-digest">11.2 Autenticação HTTP <em>Digest</em></a></h4><p>A autenticação HTTP <em>digest</em> é superior à autenticação <em>basic</em> porque ela não requer que o cliente envie uma senha sem criptografia pela rede (embora a autenticação HTTP <em>basic</em> seja segura via HTTPS). Usar a autenticação <em>digest</em> com Rails é bem fácil e requer apenas o uso de um método, <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/HttpAuthentication/Digest/ControllerMethods.html#method-i-authenticate_or_request_with_http_digest"><code>authenticate_or_request_with_http_digest</code></a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AdminsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="no">USERS</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"lifo"</span> <span class="o">=&gt;</span> <span class="s2">"world"</span> <span class="p">}</span>

  <span class="n">before_action</span> <span class="ss">:authenticate</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">authenticate</span>
      <span class="n">authenticate_or_request_with_http_digest</span> <span class="k">do</span> <span class="o">|</span><span class="n">username</span><span class="o">|</span>
        <span class="no">USERS</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class AdminsController &lt; ApplicationController
  USERS = { "lifo" =&gt; "world" }

  before_action :authenticate

  private
    def authenticate
      authenticate_or_request_with_http_digest do |username|
        USERS[username]
      end
    end
end
'>Copy</button>
</div>
<p>Como visto no exemplo acima, o bloco <code>authenticate_or_request_with_http_digest</code> recebe apenas um argumento - o nome de usuário. E o bloco retorna a senha. Retornar <code>false</code> ou <code>nil</code> em <code>authenticate_or_request_with_http_digest</code> causará falha de autenticação.</p><h4 id="autenticação-http-token"><a class="anchorlink" href="#autentica%C3%A7%C3%A3o-http-token">11.3 Autenticação HTTP <em>Token</em></a></h4><p>A autenticação de <em>token</em> HTTP é um esquema para habilitar o uso de <em>tokens Bearer</em> no <em>header</em> HTTP <code>Authorization</code>. Existem muitos formatos de <em>token</em> disponíveis e sua descrição está fora do escopo desta documentação.</p><p>Por exemplo, suponha que você queira usar um <em>token</em> de autenticação emitido com antecedência para realizar a autenticação e o acesso. Implementar autenticação via <em>token</em> com Rails é bastante fácil e requer apenas o uso de um método, <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/HttpAuthentication/Token/ControllerMethods.html#method-i-authenticate_or_request_with_http_token"><code>authenticate_or_request_with_http_token</code></a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="no">TOKEN</span> <span class="o">=</span> <span class="s2">"secret"</span>

  <span class="n">before_action</span> <span class="ss">:authenticate</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">authenticate</span>
      <span class="n">authenticate_or_request_with_http_token</span> <span class="k">do</span> <span class="o">|</span><span class="n">token</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
        <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">SecurityUtils</span><span class="p">.</span><span class="nf">secure_compare</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="no">TOKEN</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class PostsController &lt; ApplicationController
  TOKEN = "secret"

  before_action :authenticate

  private
    def authenticate
      authenticate_or_request_with_http_token do |token, options|
        ActiveSupport::SecurityUtils.secure_compare(token, TOKEN)
      end
    end
end
'>Copy</button>
</div>
<p>Como visto no exemplo acima, o bloco <code>authenticate_or_request_with_http_token</code> recebe dois argumentos: o <em>token</em> e um<code>Hash</code> contendo as opções que foram analisadas a partir do <em>header</em> HTTP <code>Authorization</code>. O bloco deve retornar <code>true</code> se a autenticação for bem-sucedida. Retornar <code>false</code> ou<code>nil</code> causará uma falha de autenticação.</p><h3 id="streaming-e-downloads-de-arquivos"><a class="anchorlink" href="#streaming-e-downloads-de-arquivos">12 <em>Streaming</em> e <em>Downloads</em> de Arquivos</a></h3><p>Às vezes você pode querer enviar um arquivo para o usuário ao invés de uma página HTML. Todos os <em>controllers</em> no Rails possuem os métodos <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/DataStreaming.html#method-i-send_data"><code>send_data</code></a> e <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/DataStreaming.html#method-i-send_file"><code>send_file</code></a>, que transmitem dados ao navegador. O método <code>send_file</code> permite que você proveja o nome do arquivo no disco e seu conteúdo será transmitido.</p><p>Para transmitir dados para o navegador, use <code>send_data</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"prawn"</span>
<span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># Gera um documento PDF com informações no navegador e</span>
  <span class="c1"># o retorna. O usuário receberá o documento PDF como um download.</span>
  <span class="k">def</span> <span class="nf">download_pdf</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">send_data</span> <span class="n">generate_pdf</span><span class="p">(</span><span class="n">client</span><span class="p">),</span>
              <span class="ss">filename: </span><span class="s2">"</span><span class="si">#{</span><span class="n">client</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">,</span>
              <span class="ss">type: </span><span class="s2">"application/pdf"</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">generate_pdf</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
      <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
        <span class="n">text</span> <span class="n">client</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="ss">align: :center</span>
        <span class="n">text</span> <span class="s2">"Address: </span><span class="si">#{</span><span class="n">client</span><span class="p">.</span><span class="nf">address</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">text</span> <span class="s2">"Email: </span><span class="si">#{</span><span class="n">client</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span><span class="p">.</span><span class="nf">render</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require "prawn"
class ClientsController &lt; ApplicationController
  # Gera um documento PDF com informações no navegador e
  # o retorna. O usuário receberá o documento PDF como um download.
  def download_pdf
    client = Client.find(params[:id])
    send_data generate_pdf(client),
              filename: "#{client.name}.pdf",
              type: "application/pdf"
  end

  private
    def generate_pdf(client)
      Prawn::Document.new do
        text client.name, align: :center
        text "Address: #{client.address}"
        text "Email: #{client.email}"
      end.render
    end
end
'>Copy</button>
</div>
<p>A <em>action</em> <code>download_pdf</code> no exemplo acima está chamando um método privado que na verdade cria o documento PDF e o retorna como uma <em>string</em>. Essa <em>string</em> será então transmitida ao navegador como um arquivo para download e o nome do arquivo será sugerido ao usuário. Às vezes, quando arquivos são transmitidos aos usuários, você pode não querer que façam o download do arquivo. Imagens, por exemplo, podem ser embutidas em páginas HTML. Para comunicar ao navegador que não deve ser feito o download do arquivo, você pode utilizar a propriedade <code>inline</code> na opção <code>:disposition</code>. A propriedade oposta e padrão para essa opção é "<em>attachment</em>".</p><h4 id="enviando-arquivos"><a class="anchorlink" href="#enviando-arquivos">12.1 Enviando Arquivos</a></h4><p>Se você deseja enviar um arquivo que já existe no disco, utilize o método <code>send_file</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># Transmite um arquivo que já foi gerado e salvo no disco.</span>
  <span class="k">def</span> <span class="nf">download_pdf</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">send_file</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/files/clients/</span><span class="si">#{</span><span class="n">client</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">,</span>
              <span class="ss">filename: </span><span class="s2">"</span><span class="si">#{</span><span class="n">client</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">,</span>
              <span class="ss">type: </span><span class="s2">"application/pdf"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ClientsController &lt; ApplicationController
  # Transmite um arquivo que já foi gerado e salvo no disco.
  def download_pdf
    client = Client.find(params[:id])
    send_file("#{Rails.root}/files/clients/#{client.id}.pdf",
              filename: "#{client.name}.pdf",
              type: "application/pdf")
  end
end
'>Copy</button>
</div>
<p>Esse método irá ler e transmitir o arquivo 4 kb por vez, evitando carregar o arquivo inteiro em memória de uma vez. Você pode desativar a transmissão com a opção <code>:stream</code> ou ajustar o tamanho do bloco com a opção <code>:buffer_size</code>.</p><p>Se a opção <code>:type</code> não for especificada, será presumido de acordo com a extensão especificada no <code>:filename</code>. Se o tipo do conteúdo (<code>content-type</code>) não estiver registrado para a extensão, será usado <code>application/octet-stream</code>.</p><div class="warning"><p>Tenha cuidado ao utilizar dados vindos do navegador ( <em>params</em>, <em>cookies</em>, etc.) para localizar um arquivo no disco, pois é um risco de segurança que pode permitir a alguém ter acesso a arquivos não permitidos.</p></div><div class="info"><p>Não é recomendado que você transmita arquivos estáticos através do Rails, você pode, ao invés disso, mantê-los em uma pasta pública no seu servidor <em>web</em>. É muito mais eficiente deixar os usuários baixarem os arquivos diretamente utilizando <em>Apache</em> ou outro servidor <em>web</em>, evitando que a requisição passe, sem necessidade, por todo o fluxo do Rails.</p></div><h4 id="restful-downloads"><a class="anchorlink" href="#restful-downloads">12.2 <em>RESTful</em> <em>Downloads</em></a></h4><p>Apesar de o método <code>send_data</code> funcionar tranquilamente, se você está criando uma aplicação <em>RESTful</em>, geralmente não é necessário ter <em>actions</em> separadas para o <em>download</em> de arquivos. Na terminologia <em>REST</em>, o arquivo PDF do exemplo acima pode ser considerado apenas uma outra representação do recurso do navegador. Rails provê um jeito fácil e prático de fazer "downloads <em>RESTful</em>". Veja como você pode re-escrever o exemplo para que o <em>download</em> do PDF seja parte da <em>action</em> <code>show</code>, sem qualquer transmissão:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># O usuário pode solicitar receber este recurso como HTML ou PDF.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">pdf</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">pdf: </span><span class="n">generate_pdf</span><span class="p">(</span><span class="vi">@client</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ClientsController &lt; ApplicationController
  # O usuário pode solicitar receber este recurso como HTML ou PDF.
  def show
    @client = Client.find(params[:id])

    respond_to do |format|
      format.html
      format.pdf { render pdf: generate_pdf(@client) }
    end
  end
end
">Copy</button>
</div>
<p>Para que este exemplo funcione, você deve adicionar o <code>MIME type</code> ao Rails. Isso pode ser feito adicionando a seguinte linha ao arquivo <code>config/initializers/mime_types.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="p">.</span><span class="nf">register</span> <span class="s2">"application/pdf"</span><span class="p">,</span> <span class="ss">:pdf</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Mime::Type.register "application/pdf", :pdf
'>Copy</button>
</div>
<div class="note"><p>Arquivos de configuração não são recarregados a cada requisição, então você precisa reiniciar seu servidor para que as mudanças tenham efeito.</p></div><p>Agora os usuários podem requerer um arquivo em PDF só adicionando ".pdf" ao final da <em>URL</em>:</p><div class="code_container">
<pre><code class="highlight plaintext">GET /clients/1.pdf
</code></pre>
<button class="clipboard-button" data-clipboard-text="GET /clients/1.pdf
">Copy</button>
</div>
<h4 id="transmissão-ao-vivo-de-dado-arbitrários"><a class="anchorlink" href="#transmiss%C3%A3o-ao-vivo-de-dado-arbitr%C3%A1rios">12.3 Transmissão Ao Vivo de Dado Arbitrários</a></h4><p>O Rails permite que você transmita mais do que apenas arquivos. Na verdade, você pode transmitir o que você desejar
como um objeto de resposta. O modulo <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionController/Live.html"><code>ActionController::Live</code></a> permite
a você criar uma conexão persistente com o navegador. Utilizando esse módulo, você é capaz
de enviar dados arbitrários ao navegador sem depender de uma requisição <em>HTTP</em>.</p><h5 id="implementando-transmissão-ao-vivo-live-streaming"><a class="anchorlink" href="#implementando-transmiss%C3%A3o-ao-vivo-live-streaming">12.3.1 Implementando Transmissão Ao Vivo ( <em>Live Streaming</em> )</a></h5><p>Incluindo <code>ActionController::Live</code> dentro do seu <em>controller</em> irá prover a todas as
<em>actions</em> do seu <em>controller</em> a habilidade de transmitir dados. Você pode mesclar o modulo
da seguinte forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span>

  <span class="k">def</span> <span class="nf">stream</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'text/event-stream'</span>
    <span class="mi">100</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span>
      <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">write</span> <span class="s2">"hello world</span><span class="se">\n</span><span class="s2">"</span>
      <span class="nb">sleep</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="k">ensure</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class MyController &lt; ActionController::Base
  include ActionController::Live

  def stream
    response.headers['Content-Type'] = 'text/event-stream'
    100.times {
      response.stream.write &quot;hello world\n&quot;
      sleep 1
    }
  ensure
    response.stream.close
  end
end
">Copy</button>
</div>
<p>O código acima manterá uma conexão constante com o navegador e mandará 100 mensagens de <code>"hello world\n"</code>, cada uma com um segundo de diferença.</p><p>Existem algumas coisas a serem notadas no exemplo acima. Nós precisamos
ter certeza de que a resposta da transmissão foi terminada. Esquecer de encerrar a transmissão deixará
o <em>socket</em> aberto pra sempre. Nós também precisamos estabelecer o tipo de conteúdo (<code>content_type</code>) para <code>text/event-stream</code>
antes de responder a transmissão. Isso é necessário, pois <em>headers</em> não podem ser escritos
depois que uma resposta foi enviada (quando <code>response.committed?</code> retorna um
valor <em>truthy</em>), que ocorre quando você escreve ou envia (<code>commit</code>) a resposta de uma transmissão.</p><h5 id="exemplo-de-uso"><a class="anchorlink" href="#exemplo-de-uso">12.3.2 Exemplo de Uso</a></h5><p>Vamos supor que você estivesse criando uma máquina de Karaokê e um usuário quer achar a letra de uma música em particular. Cada música (<code>Song</code>) tem um número específico de linhas e cada linha tem um tempo (<code>num_beats</code>) para terminar de ser cantada.</p><p>Se nós quiséssemos retornar as letras no estilo de Karaokê (mandar a linha só quando a linha anterior for terminada de cantar), então poderíamos usar <code>ActionController::Live</code> da seguinte forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">LyricsController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'text/event-stream'</span>
    <span class="n">song</span> <span class="o">=</span> <span class="no">Song</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

    <span class="n">song</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
      <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">write</span> <span class="n">line</span><span class="p">.</span><span class="nf">lyrics</span>
      <span class="nb">sleep</span> <span class="n">line</span><span class="p">.</span><span class="nf">num_beats</span>
    <span class="k">end</span>
  <span class="k">ensure</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class LyricsController &lt; ActionController::Base
  include ActionController::Live

  def show
    response.headers['Content-Type'] = 'text/event-stream'
    song = Song.find(params[:id])

    song.each do |line|
      response.stream.write line.lyrics
      sleep line.num_beats
    end
  ensure
    response.stream.close
  end
end
">Copy</button>
</div>
<p>O código acima envia a próxima linha apenas depois que a pessoa cantando completou a linha anterior.</p><h5 id="considerações-da-transmissão"><a class="anchorlink" href="#considera%C3%A7%C3%B5es-da-transmiss%C3%A3o">12.3.3 Considerações da Transmissão</a></h5><p>Transmitir dados arbitrários é uma ferramenta extremamente poderosa. Como mostrado nos exemplos anteriores, você pode escolher quando e o que enviar na resposta da transmissão. Entretanto, você deveria se atentar aos seguintes pontos:</p>
<ul>
<li>Cada transmissão cria uma nova <em>thread</em> e copia sobre as variáveis locais da
<em>thread</em>, as variáveis da <em>thread</em> original. Ter muitas variáveis locais em uma
<em>thread</em> local pode impactar negativamente na performance. Da mesma forma, um
grande número de <em>threads</em> pode também piorar a performance.</li>
<li>Deixar de encerrar a transmissão deixará o <em>socket</em> correspondente aberto para
sempre. Certifique-se de chamar o método <code>close</code> sempre que estiver transmitindo
dados.</li>
<li>Os servidores WEBrick armazena todas as respostas, então apenas incluir no
<em>controller</em> <code>ActionController::Live</code> não irá funcionar. Você deve usar um
servidor web que não armazene automaticamente as respostas.</li>
</ul>
<h3 id="filtragem-de-log"><a class="anchorlink" href="#filtragem-de-log">13 Filtragem de Log</a></h3><p>Rails mantém um arquivo de log pra cada ambiente na pasta <code>log</code>. Eles são bastante úteis quando estamos depurando o que está de fato acontecendo na sua aplicação, porém você pode não querer que sejam salvos todas as informações sejam armazenadas no arquivo de log em uma aplicação ativa.</p><h4 id="filtrando-parâmetros"><a class="anchorlink" href="#filtrando-par%C3%A2metros">13.1 Filtrando Parâmetros</a></h4><p>Você pode evitar que parâmetros sensíveis da requisição sejam salvos no seu arquivo de log
adicionando-os a <a href="configuring.html#config-filter-parameters"><code>config.filter_parameters</code></a> na configuração da aplicação.
Esses parâmetros aparecerão como [FILTERED] no arquivo de log.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">filter_parameters</span> <span class="o">&lt;&lt;</span> <span class="ss">:password</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.filter_parameters &lt;&lt; :password
">Copy</button>
</div>
<div class="note"><p>Os parâmetros fornecidos serão filtrados correspondendo parcialmente a uma expressão
regular. O Rails por padrão adiciona <code>:passw</code>, <code>:secret</code>, <code>:token</code> no <em>initializer</em>
apropriado (<code>initializers/filter_parameter_logging.</code>) e se preocupa com parâmetros típicos da aplicação
como <code>password</code>, <code>password_confirmation</code> e <code>my_token</code>.</p></div><h4 id="filtrando-redirecionamentos"><a class="anchorlink" href="#filtrando-redirecionamentos">13.2 Filtrando Redirecionamentos</a></h4><p>Às vezes é desejável que sejam filtrados dos arquivos de log alguns locais sensíveis para os quais sua aplicação está redirecionando.
Você pode fazer isso utilizando uma opção de configuração <code>config.filter_redirect</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">filter_redirect</span> <span class="o">&lt;&lt;</span> <span class="s1">'s3.amazonaws.com'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.filter_redirect &lt;&lt; 's3.amazonaws.com'
">Copy</button>
</div>
<p>Você pode utilizar uma <em>String</em>, uma expressão regular ou um array com ambos.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">filter_redirect</span><span class="p">.</span><span class="nf">concat</span> <span class="p">[</span><span class="s1">'s3.amazonaws.com'</span><span class="p">,</span> <span class="sr">/private_path/</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.filter_redirect.concat ['s3.amazonaws.com', /private_path/]
">Copy</button>
</div>
<p><em>URLs</em> correspondentes com a expressão regular serão marcadas como  '[FILTERED]'.</p><h3 id="rescue"><a class="anchorlink" href="#rescue">14 Rescue</a></h3><p>Muito provavelmente sua aplicação irá conter bugs ou enviar exceções que precisam ser tratadas. Por exemplo, se o usuário acessar um link que não possui uma fonte no banco de dados, o Active Record enviará <code>ActiveRecord::RecordNotFound</code> como exceção.</p><p>A exceção padrão do Rails apresenta a mensagem "500 Server Error" para todas as exceções. Se a requisição for feita localmente, um belo <em>traceback</em> e outras informações serão mostradas assim você pode verificar o que deu errado e tratar o problema. Se a requisição for remota o Rails apenas apresentará a mensagem "500 Server Error" para o usuário, ou um "404 Not Found" se houver um erro na rota ou o registro não puder ser encontrado. As vezes você pode querer customizar como esses erros são encontrados e como são apresentados ao usuário. Há diversos níveis de tratamento de excessões disponiveis em uma aplicação Rails:</p><h4 id="os-templates-404-e-500-padrão"><a class="anchorlink" href="#os-templates-404-e-500-padr%C3%A3o">14.1 Os <em>Templates</em> 404 e 500 Padrão</a></h4><p>Por padrão no ambiente de produção a aplicação irá renderizar uma mensagem em um template de erro 404 ou 500. No ambiente de desenvolvimento todas as mensagens de erro são disparadas. Essas mensagens são armazenadas em templates estáticos de HTML na pasta <em>public</em>, em <code>404.html</code> e <code>500.html</code> respectivamente. Você pode customizar essas páginas e adicionar algumas estilizações, mas lembre-se elas são HTML estáticos; i.e. você não pode usar ERB, SCSS, CoffeeScript, ou layouts para elas.</p><h4 id="rescue-from"><a class="anchorlink" href="#rescue-from">14.2 <code>rescue_from</code></a></h4><p>Se você quiser fazer algo mais elaborado quando estiver lidando com erros, você pode usar <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveSupport/Rescuable/ClassMethods.html#method-i-rescue_from"><code>rescue_from</code></a>, que trata as exceções de um certo tipo (ou de vários tipos) em um <em>controller</em> inteiro e nas subclasses.</p><p>Quando uma exceção acontece e é pega por uma diretiva <code>rescue_from</code>, o objeto da exceção é passado ao <em>handler</em>. O <em>handler</em> pode ser um método ou um objeto <code>Proc</code> passado com a opção <code>:with</code>. Você também pode usar um bloco diretamente ao invés de um objeto <code>Proc</code>.</p><p>Aqui está um exemplo de como você pode usar <code>rescue_from</code> para interceptar todos os erros <code>ActiveRecord::RecordNotFound</code> e fazer algo com eles.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">rescue_from</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">,</span> <span class="ss">with: :record_not_found</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">record_not_found</span>
      <span class="n">render</span> <span class="ss">plain: </span><span class="s2">"404 Not Found"</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">404</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class ApplicationController &lt; ActionController::Base
  rescue_from ActiveRecord::RecordNotFound, with: :record_not_found

  private
    def record_not_found
      render plain: "404 Not Found", status: 404
    end
end
'>Copy</button>
</div>
<p>É claro, que este exemplo não é nada elaborado e não melhora muito a forma original de lidar com os erros, mas uma vez que você capture todas essas exceções você é livre para fazer o que quiser com elas. Por exemplo, você pode criar uma exceção personalizada para quando o usuário não tem acesso a uma parte da aplicação:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">rescue_from</span> <span class="no">User</span><span class="o">::</span><span class="no">NotAuthorized</span><span class="p">,</span> <span class="ss">with: :user_not_authorized</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">user_not_authorized</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"You don't have access to this section."</span>
      <span class="n">redirect_back</span><span class="p">(</span><span class="ss">fallback_location: </span><span class="n">root_path</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># Check that the user has the right authorization to access clients.</span>
  <span class="n">before_action</span> <span class="ss">:check_authorization</span>

  <span class="c1"># Note how the actions don't have to worry about all the auth stuff.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="c1"># If the user is not authorized, just throw the exception.</span>
    <span class="k">def</span> <span class="nf">check_authorization</span>
      <span class="k">raise</span> <span class="no">User</span><span class="o">::</span><span class="no">NotAuthorized</span> <span class="k">unless</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationController &lt; ActionController::Base
  rescue_from User::NotAuthorized, with: :user_not_authorized

  private
    def user_not_authorized
      flash[:error] = &quot;You don't have access to this section.&quot;
      redirect_back(fallback_location: root_path)
    end
end

class ClientsController &lt; ApplicationController
  # Check that the user has the right authorization to access clients.
  before_action :check_authorization

  # Note how the actions don't have to worry about all the auth stuff.
  def edit
    @client = Client.find(params[:id])
  end

  private
    # If the user is not authorized, just throw the exception.
    def check_authorization
      raise User::NotAuthorized unless current_user.admin?
    end
end
">Copy</button>
</div>
<div class="warning"><p>Ao usar <code>rescue_from</code> com <code>Exception</code> ou <code>StandardError</code> pode causar efeitos colaterais já que previne o Rails de lidar com as exceções apropriadamente. Dessa forma, não é recomendado fazer sem uma boa razão.</p></div><div class="note"><p>Quando rodando em ambiente de desenvolvimento, todos os erros
<code>ActiveRecord::RecordNotFound</code> renderizam uma página 404. A não ser que você precise de uma forma especifica de tratar isso você não precisa tratar isso.</p></div><div class="note"><p>Certas exceções são tratadas apenas pela classe <code>ApplicationController</code>, já que são acionadas antes do controller ser iniciado a exceção é executada.</p></div><h3 id="forçar-o-protocolo-https"><a class="anchorlink" href="#for%C3%A7ar-o-protocolo-https">15 Forçar o Protocolo HTTPS</a></h3><p>Se você quiser garantir que a comunicação com seu <em>controller</em> seja possível apenas
via HTTPS, você deve fazer isso ativando o middleware <a href="https://api.rubyonrails.org/v7.0.8/classes/ActionDispatch/SSL.html"><code>ActionDispatch::SSL</code></a> via
<a href="configuring.html#config-force-ssl"><code>config.force_ssl</code></a> na configuração do seu ambiente.</p>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua caso veja quaisquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">forum oficial do Ruby on Rails</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
