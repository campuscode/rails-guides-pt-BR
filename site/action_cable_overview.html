<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Action Cable Overview — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Action Cable Overview — Ruby on Rails Guides" />
  <meta name="description" content="Action Cable OverviewNeste guia, você irá aprender como Action Cable funciona e como usar WebSockets para incorporar funcionalidades de tempo real em sua aplicação Rails.Ao ler este guia você aprenderá: O que é um Action Cable e sua integração backend e frontend Como configurar um Action Cable Como configurar canais Configuração de Deployment e Arquitetura para rodar a Action Cable" />
  <meta property="og:description" content="Action Cable OverviewNeste guia, você irá aprender como Action Cable funciona e como usar WebSockets para incorporar funcionalidades de tempo real em sua aplicação Rails.Ao ler este guia você aprenderá: O que é um Action Cable e sua integração backend e frontend Como configurar um Action Cable Como configurar canais Configuração de Deployment e Arquitetura para rodar a Action Cable" />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v6.1.4</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Action Cable Overview</h2><p>Neste guia, você irá aprender como <em>Action Cable</em> funciona e como usar <em>WebSockets</em>
para incorporar funcionalidades de tempo real em sua aplicação Rails.</p><p>Ao ler este guia você aprenderá:</p>
<ul>
<li>O que é um <em>Action Cable</em> e sua integração <em>backend</em> e <em>frontend</em></li>
<li>Como configurar um <em>Action Cable</em></li>
<li>Como configurar canais</li>
<li>Configuração de <em>Deployment</em> e Arquitetura para rodar a <em>Action Cable</em></li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#o-que-e-o-action-cable-questionmark">O que é o <em>Action Cable</em>?</a></li>
<li>
<a href="#terminologia">Terminologia</a>

<ul>
<li><a href="#terminologia-conexoes">Conexões</a></li>
<li><a href="#consumidores">Consumidores</a></li>
<li><a href="#canais">Canais</a></li>
<li><a href="#assinantes">Assinantes</a></li>
</ul>
</li>
<li>
<a href="#pub-sub">_<em>Pub/Sub</em></a>

<ul>
<li><a href="#pub-sub-broadcastings"><strong>Broadcastings</strong></a></li>
</ul>
</li>
<li>
<a href="#componentes-server-side">Componentes <em>Server-Side</em></a>

<ul>
<li><a href="#connections"><em>Connections</em></a></li>
<li><a href="#channels"><em>Channels</em></a></li>
</ul>
</li>
<li>
<a href="#componentes-client-side">Componentes <em>Client-Side</em></a>

<ul>
<li><a href="#componentes-client-side-conexoes">Conexões</a></li>
</ul>
</li>
<li>
<a href="#interacoes-cliente-servidor">Interações Cliente-Servidor</a>

<ul>
<li><a href="#streams"><em>Streams</em></a></li>
<li><a href="#interacoes-cliente-servidor-broadcastings"><em>Broadcastings</em></a></li>
<li><a href="#interacoes-cliente-servidor-subscriptions"><em>Subscriptions</em></a></li>
<li><a href="#passando-parametros-para-channel">Passando Parâmetros para <em>Channel</em></a></li>
<li><a href="#retransmitindo-uma-mensagem">Retransmitindo uma Mensagem</a></li>
</ul>
</li>
<li>
<a href="#full-stack-examples">Full-Stack Examples</a>

<ul>
<li><a href="#example-1-user-appearances">Example 1: User Appearances</a></li>
<li><a href="#example-2-receiving-new-web-notifications">Example 2: Receiving New Web Notifications</a></li>
<li><a href="#more-complete-examples">More Complete Examples</a></li>
</ul>
</li>
<li>
<a href="#configuracao">Configuração</a>

<ul>
<li><a href="#adaptador-de-assinatura">Adaptador de assinatura</a></li>
<li><a href="#origens-de-requisicao-permitidas">Origens de Requisição Permitidas</a></li>
<li><a href="#configuracao-do-consumidor">Configuração do Consumidor</a></li>
<li><a href="#configuracao-do-worker-pool">Configuração do <em>Worker Pool</em></a></li>
<li><a href="#log-no-lado-do-client">Log no lado do client</a></li>
<li><a href="#outras-configuracoes">Outras Configurações</a></li>
</ul>
</li>
<li>
<a href="#executando-servidores-cable-autonomos">Executando Servidores <em>Cable</em> Autônomos</a>

<ul>
<li><a href="#na-aplicacao">Na Aplicação</a></li>
<li><a href="#autonomo">Autônomo</a></li>
<li><a href="#notas">Notas</a></li>
</ul>
</li>
<li><a href="#dependencias">Dependências</a></li>
<li><a href="#implantacao">Implantação</a></li>
<li><a href="#teste">Teste</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="o-que-e-o-action-cable-questionmark"><a class="anchorlink" href="#o-que-e-o-action-cable-questionmark">1 O que é o <em>Action Cable</em>?</a></h3><p>O <em>Action Cable</em> integra-se perfeitamente <a href="https://pt.wikipedia.org/wiki/WebSocket">WebSockets</a> com o resto da sua aplicação Rails. Permite que recursos em tempo real sejam escritos em Ruby no mesmo estilo e forma que o resto de sua aplicação Rails, ao mesmo tempo em que possui desempenho e escabilidade. Isso é uma oferta <em>full-stack</em> que fornece um <em>framework</em> Javascript do lado do cliente (<em>client-side</em>) e um <em>framework</em> Ruby do lado do servidor (<em>server-side</em>). Você tem acesso ao seu <em>model</em> de domínio completo escrito com o <em>Active Record</em> ou o ORM de sua escolha.</p><h3 id="terminologia"><a class="anchorlink" href="#terminologia">2 Terminologia</a></h3><p>O <em>Action Cable</em> utiliza <em>WebSockets</em> ao invés do protocolo de requisição-resposta HTTP.
Tanto o <em>Action Cable</em> quanto os <em>WebSockets</em> apresentam uma terminologia menos familiar:</p><h4 id="terminologia-conexoes"><a class="anchorlink" href="#terminologia-conexoes">2.1 Conexões</a></h4><p>Conexões formam a base do relacionamento cliente-servidor.
Um único servidor <em>Action Cable</em> pode lidar com várias instâncias de conexão. Ele possui uma instância de conexão para cada conexão via <em>WebSocket</em>. Um único usuário pode ter vários <em>WebSockets</em> abertos para sua aplicação se ele utilizar várias abas do navegador ou dispositivos.</p><h4 id="consumidores"><a class="anchorlink" href="#consumidores">2.2 Consumidores</a></h4><p>O client de uma conexão <em>WebSocket</em> é chamado de <em>consumidor</em>. No <em>Action Cable</em>, o consumidor é criado pelo framework JavaScript do lado do cliente.</p><h4 id="canais"><a class="anchorlink" href="#canais">2.3 Canais</a></h4><p>Cada consumidor pode, por sua vez, se inscrever em vários <em>canais</em>.
Cada canal encapsula uma unidade lógica de trabalho, semelhante ao que um
<em>controller</em> faz em uma configuração MVC regular.
Por exemplo, você pode ter um <em>ChatChannel</em> e um <em>AppearancesChannel</em>, e um
consumidor pode ser inscrito em um ou em ambos os canais.
Um consumidor deve se inscrever em, pelo menos, um canal.</p><h4 id="assinantes"><a class="anchorlink" href="#assinantes">2.4 Assinantes</a></h4><p>Quando o consumidor está inscrito em um canal, ele age como um <em>assinante</em>.
A conexão entre o assinante e o canal é, adivinhe, chamada de assinatura.
Um consumidor pode atuar como um assinante de um determinado canal qualquer
número de vezes. Por exemplo, um consumidor pode se inscrever em várias salas de
chat ao mesmo tempo. (E lembre-se que um usuário físico pode ter vários
consumidores, um por aba/dispositivo aberto para sua conexão).</p><h3 id="pub-sub"><a class="anchorlink" href="#pub-sub">3 _<em>Pub/Sub</em></a></h3><p><em><a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">Pub/Sub</a></em>, ou
<em>Publish-Subscribe</em>, refere-se a um paradigma de fila de mensageria o qual os
remetentes de uma informação (<em>publishers</em>) enviam dados à uma classe abstrata de
destinatários (<em>subscribers</em>) sem especificar um destinatário individual.
<em>Action Cable</em> utiliza essa abordagem para manter a comunicação entre o servidor
e diversos clientes.</p><h4 id="pub-sub-broadcastings"><a class="anchorlink" href="#pub-sub-broadcastings">3.1 <strong>Broadcastings</strong></a></h4><p>Uma transmissão (<em>broadcasting</em>) é um link <em>pub/sub</em> em que qualquer coisa transmitida pela emissora é
enviada diretamente para os assinantes (<em>subscribers</em>) do canal que estão transmitindo essa transmissão.
Cada canal pode transmitir zero ou mais transmissões.</p><h3 id="componentes-server-side"><a class="anchorlink" href="#componentes-server-side">4 Componentes <em>Server-Side</em></a></h3><h4 id="connections"><a class="anchorlink" href="#connections">4.1 <em>Connections</em></a></h4><p>Para cada <em>WebSocket</em> aceito pelo servidor, um objeto <em>connection</em> é instanciado. Esse objeto
se torna o pai de todos os <em>channel subscriptions</em> que são criados dali pra frente.
A <em>connection</em> em si não lida com nenhuma lógica específica da aplicação além da
autenticação e autorização. O cliente de um <em>WebSocket <em>connection</em></em> é chamado de
<em>consumer</em>. Um usuário individual criará um par de <em>consumer-connection</em> para cada
aba do navegador, janela ou dispositivo que ele tiver aberto.</p><p><em>Connections</em> são instâncias de <code>ApplicationCable::Connection</code>, que estendem de
<a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Connection/Base.html"><code>ActionCable::Connection::Base</code></a>. Em <code>ApplicationCable::Connection</code>, você
autoriza a <em>connection</em> recebida e procede para estabelecê-la, caso o
usuário possa ser identificado.</p><h5 id="configuracao-de-uma-connection"><a class="anchorlink" href="#configuracao-de-uma-connection">4.1.1 Configuração de uma <em>Connection</em></a></h5><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/application_cable/connection.rb</span>
<span class="k">module</span> <span class="nn">ApplicationCable</span>
  <span class="k">class</span> <span class="nc">Connection</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Connection</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">identified_by</span> <span class="ss">:current_user</span>

    <span class="k">def</span> <span class="nf">connect</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">current_user</span> <span class="o">=</span> <span class="n">find_verified_user</span>
    <span class="k">end</span>

    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">find_verified_user</span>
        <span class="k">if</span> <span class="n">verified_user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span>
          <span class="n">verified_user</span>
        <span class="k">else</span>
          <span class="n">reject_unauthorized_connection</span>
        <span class="k">end</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e699d4ac98f6ed20007c27bc0eba17e9"># app/channels/application_cable/connection.rb
module ApplicationCable
  class Connection &lt; ActionCable::Connection::Base
    identified_by :current_user

    def connect
      self.current_user = find_verified_user
    end

    private
      def find_verified_user
        if verified_user = User.find_by(id: cookies.encrypted[:user_id])
          verified_user
        else
          reject_unauthorized_connection
        end
      end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e699d4ac98f6ed20007c27bc0eba17e9">Copiar</button>
</div>
<p>Aqui, <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Connection/Identification/ClassMethods.html#method-i-identified_by"><code>identified_by</code></a> designa um identificador de <em>connection</em> que pode ser usado para
encontrar uma <em>connection</em> específica mais tarde. Note que qualquer coisa marcada
como um identificador criará automaticamente um <em>delegate</em> pelo mesmo nome em
qualquer instância de <em>channel</em> criada a partir da <em>connection</em>.</p><p>Esse exemplo se baseia no fato de que você já lidou a autenticação do usuário em
algum outro lugar na sua aplicação e essa autenticação bem sucedida definiu um
<em>cookie</em> criptografado com o ID do usuário.</p><p>O <em>cookie</em> é então enviado automaticamente para a instância da <em>connection</em> quando há
a tentativa de criar uma nova <em>connection</em>, e você o usa para definir o <code>current_user</code>.
Ao identificar a <em>connection</em> para o mesmo usuário, você também garante que você pode retornar todas as <em>connections</em> em aberto para um usuário específico (e potencialmente desconectá-los, caso o usuário seja deletado ou desautorizado).</p><p>Se a sua abordagem de autenticação inclui o uso de uma sessão (<em>session</em>), você usa o armazenamento com <em>cookies</em> para a
sessão, seu <em>cookie</em> de sessão é denominado <code>_session</code> e a chave de ID do usuário é <code>user_id</code> você
pode usar esta abordagem:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">verified_user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="s1">'_session'</span><span class="p">][</span><span class="s1">'user_id'</span><span class="p">])</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8d2bf8366c98e86311ce662cd1aa86ee">verified_user = User.find_by(id: cookies.encrypted['_session']['user_id'])
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8d2bf8366c98e86311ce662cd1aa86ee">Copiar</button>
</div>
<h5 id="lidando-com-excecoes-exceptions"><a class="anchorlink" href="#lidando-com-excecoes-exceptions">4.1.2 Lidando com Exceções (<em>Exceptions</em>)</a></h5><p>Por padrão, exceções não tratadas são capturadas e registradas no <em>logger</em> do Rails. Se você gostaria de
interceptar globalmente essas exceções e relatá-las a um serviço externo de rastreamento de <em>bugs</em>, por
exemplo, você pode fazer isso com <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Rescuable/ClassMethods.html#method-i-rescue_from"><code>rescue_from</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/application_cable/connection.rb</span>
<span class="k">module</span> <span class="nn">ApplicationCable</span>
  <span class="k">class</span> <span class="nc">Connection</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Connection</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">rescue_from</span> <span class="no">StandardError</span><span class="p">,</span> <span class="ss">with: :report_error</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">report_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="no">SomeExternalBugtrackingService</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4c0b2773f26019fec7ce58c333de304e"># app/channels/application_cable/connection.rb
module ApplicationCable
  class Connection &lt; ActionCable::Connection::Base
    rescue_from StandardError, with: :report_error

    private

    def report_error(e)
      SomeExternalBugtrackingService.notify(e)
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4c0b2773f26019fec7ce58c333de304e">Copiar</button>
</div>
<h4 id="channels"><a class="anchorlink" href="#channels">4.2 <em>Channels</em></a></h4><p>O <em>channel</em> encapsula uma unidade lógica de trabalho, parecido com o que um
<em>controller</em> faz em um <em>MVC</em> comum. Por padrão, o <em>Rails</em> cria uma classe pai
<code>ApplicationCable::Channel</code> (que estende <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Channel/Base.html"><code>ActionCable::Channel::Base</code></a>) para encapsular a lógica compartilhada entre seus
<em>channels</em>.</p><h5 id="configuracao-do-channel-pai"><a class="anchorlink" href="#configuracao-do-channel-pai">4.2.1 Configuração do <em>Channel</em> pai</a></h5><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/application_cable/channel.rb</span>
<span class="k">module</span> <span class="nn">ApplicationCable</span>
  <span class="k">class</span> <span class="nc">Channel</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Channel</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d09bb9b579cfc8aedfead5c53d9d0b26"># app/channels/application_cable/channel.rb
module ApplicationCable
  class Channel &lt; ActionCable::Channel::Base
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d09bb9b579cfc8aedfead5c53d9d0b26">Copiar</button>
</div>
<p>Então, você criaria suas próprias classes de <em>channel</em>. Por exemplo, você poderia ter um
<code>ChatChannel</code> e um <code>AppearanceChannel</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/chat_channel.rb</span>
<span class="k">class</span> <span class="nc">ChatChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-972182e7c1cd206e967b7b4e5ae4ae32"># app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-972182e7c1cd206e967b7b4e5ae4ae32">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/appearance_channel.rb</span>
<span class="k">class</span> <span class="nc">AppearanceChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5387d0a4a4c7ca6f18660b877f56690d"># app/channels/appearance_channel.rb
class AppearanceChannel &lt; ApplicationCable::Channel
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5387d0a4a4c7ca6f18660b877f56690d">Copiar</button>
</div>
<p>Um <em>consumer</em> poderia então ser inscrito para qualquer ou ambos os <em>channels</em>.</p><h5 id="channels-subscriptions"><a class="anchorlink" href="#channels-subscriptions">4.2.2 <em>Subscriptions</em></a></h5><p><em>Consumers</em> se inscrevem a <em>channels</em>, agindo como <em>subscribers</em>. A <em>connection</em>
deles é chamada de <em>subscription</em>. Mensagens produzidas são então roteadas para esses
<em>channel subscriptions</em> baseados em um identificador enviado pelo <em>channel consumer</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/chat_channel.rb</span>
<span class="k">class</span> <span class="nc">ChatChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="c1"># Chamado quando o *consumer* tornou-se um *subscriber*</span>
  <span class="c1"># desse *channel* com sucesso.</span>
  <span class="k">def</span> <span class="nf">subscribed</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3a7ba78f20afba0da7561155041e80ce"># app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  # Chamado quando o *consumer* tornou-se um *subscriber*
  # desse *channel* com sucesso.
  def subscribed
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3a7ba78f20afba0da7561155041e80ce">Copiar</button>
</div>
<h5 id="lidando-com-excecoes"><a class="anchorlink" href="#lidando-com-excecoes">4.2.3 Lidando com Exceções</a></h5><p>Tal como acontece com <code>ApplicationCable::Connection</code>, você também pode usar <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Rescuable/ClassMethods.html#method-i-rescue_from"><code>rescue_from</code></a> em um
canal específico para lidar com exceções levantadas:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/chat_channel.rb</span>
<span class="k">class</span> <span class="nc">ChatChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="n">rescue_from</span> <span class="s1">'MyError'</span><span class="p">,</span> <span class="ss">with: :deliver_error_message</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">deliver_error_message</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">broadcast_to</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0b5d9a123492a7f072a667e92ec4b689"># app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  rescue_from 'MyError', with: :deliver_error_message

  private

  def deliver_error_message(e)
    broadcast_to(...)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0b5d9a123492a7f072a667e92ec4b689">Copiar</button>
</div>
<h3 id="componentes-client-side"><a class="anchorlink" href="#componentes-client-side">5 Componentes <em>Client-Side</em></a></h3><h4 id="componentes-client-side-conexoes"><a class="anchorlink" href="#componentes-client-side-conexoes">5.1 Conexões</a></h4><p>Consumidores precisam de uma instância da conexão do seu lado. Esta conexão pode
ser estabelecida usando o seguinte JavaScript, que é gerado por padrão pelo
Rails:</p><h5 id="conectar-o-consumidor"><a class="anchorlink" href="#conectar-o-consumidor">5.1.1 Conectar o Consumidor</a></h5><div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/consumer.js</span>
<span class="c1">// Action Cable provides the framework to deal with WebSockets in Rails.</span>
<span class="c1">// You can generate new channels where WebSocket features live using the `bin/rails generate channel` command.</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">createConsumer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/actioncable</span><span class="dl">"</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">createConsumer</span><span class="p">()</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9aea44d10ecdb792d64c7014de0dceac">// app/javascript/channels/consumer.js
// Action Cable provides the framework to deal with WebSockets in Rails.
// You can generate new channels where WebSocket features live using the `bin/rails generate channel` command.

import { createConsumer } from "@rails/actioncable"

export default createConsumer()
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9aea44d10ecdb792d64c7014de0dceac">Copiar</button>
</div>
<p>Isto vai preparar um consumidor que conectará em <code>/cable</code> em seu servidor por
padrão. A conexão não vai ser estabelecida até que você também tenha
especificado ao menos uma inscrição que você tem interesse em ter.</p><p>O consumidor pode optar receber um argumento que especifica a <em>URL</em> para se
conectar. Ela pode ser uma <em>string</em>, ou uma função que retorna uma <em>string</em> que
vai ser chamada quando o <em>WebSocket</em> é aberto.</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// Especifica uma _URL_ diferente para se conectar</span>
<span class="nx">createConsumer</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://ws.example.com/cable</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// Utiliza uma função para gerar a _URL_ dinamicamente</span>
<span class="nx">createConsumer</span><span class="p">(</span><span class="nx">getWebSocketURL</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">getWebSocketURL</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">auth-token</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">return</span> <span class="s2">`https://ws.example.com/cable?token=</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span>
<span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8b52571c71b65c29fd5f535464d9f5c1">// Especifica uma _URL_ diferente para se conectar
createConsumer('https://ws.example.com/cable')

// Utiliza uma função para gerar a _URL_ dinamicamente
createConsumer(getWebSocketURL)

function getWebSocketURL {
  const token = localStorage.get('auth-token')
  return `https://ws.example.com/cable?token=${token}`
}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8b52571c71b65c29fd5f535464d9f5c1">Copiar</button>
</div>
<h5 id="assinante"><a class="anchorlink" href="#assinante">5.1.2 Assinante</a></h5><p>Um consumidor se torna um assinante criando uma assinatura para um canal:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/chat_channel.js</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">channel</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ChatChannel</span><span class="dl">"</span><span class="p">,</span> <span class="na">room</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Best Room</span><span class="dl">"</span> <span class="p">})</span>

<span class="c1">// app/javascript/channels/appearance_channel.js</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">channel</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AppearanceChannel</span><span class="dl">"</span> <span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2f525952cd5e6204d41e29290e22ac8c">// app/javascript/channels/chat_channel.js
import consumer from "./consumer"

consumer.subscriptions.create({ channel: "ChatChannel", room: "Best Room" })

// app/javascript/channels/appearance_channel.js
import consumer from "./consumer"

consumer.subscriptions.create({ channel: "AppearanceChannel" })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2f525952cd5e6204d41e29290e22ac8c">Copiar</button>
</div>
<p>Enquanto isto cria uma assinatura, a funcionalidade necessária para responder
aos dados recebidos será descrita mais tarde.</p><p>Um consumidor pode agir como um assinante para um dado canal qualquer número de
vezes. Por exemplo, um consumidor pode assinar várias salas de <em>chat</em> ao mesmo
tempo.</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/chat_channel.js</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">channel</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ChatChannel</span><span class="dl">"</span><span class="p">,</span> <span class="na">room</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1st Room</span><span class="dl">"</span> <span class="p">})</span>
<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">channel</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ChatChannel</span><span class="dl">"</span><span class="p">,</span> <span class="na">room</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2nd Room</span><span class="dl">"</span> <span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1411c98fd82422042e281bc6a75f82dc">// app/javascript/channels/chat_channel.js
import consumer from "./consumer"

consumer.subscriptions.create({ channel: "ChatChannel", room: "1st Room" })
consumer.subscriptions.create({ channel: "ChatChannel", room: "2nd Room" })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1411c98fd82422042e281bc6a75f82dc">Copiar</button>
</div>
<h3 id="interacoes-cliente-servidor"><a class="anchorlink" href="#interacoes-cliente-servidor">6 Interações Cliente-Servidor</a></h3><h4 id="streams"><a class="anchorlink" href="#streams">6.1 <em>Streams</em></a></h4><p><em>Streams</em> fornecem o mecanismo por onde os <em>channels</em> direcionam o conteúdo publicado (<em>broadcasts</em>) para seus assinantes. Por exemplo, o código a seguir usa <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Channel/Streams.html#method-i-stream_from"><code>stream_from</code></a> para se inscrever na transmissão (<em>broadcasting</em>) chamada <code>chat_Best Room</code> quando o valor do parâmetro <code>:room</code> é <code>"Best Room"</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/chat_channel.rb</span>
<span class="k">class</span> <span class="nc">ChatChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="k">def</span> <span class="nf">subscribed</span>
    <span class="n">stream_from</span> <span class="s2">"chat_</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:room</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6e7f87d6a09f1e4041ffca0cd1324614"># app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_from "chat_#{params[:room]}"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6e7f87d6a09f1e4041ffca0cd1324614">Copiar</button>
</div>
<p>Então, de outro lugar em sua aplicação Rails, é possível transmitir para essa <code>room</code> chamando <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Server/Broadcasting.html#method-i-broadcast"><code>broadcast</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="s2">"chat_Best Room"</span><span class="p">,</span> <span class="p">{</span> <span class="ss">body: </span><span class="s2">"This Room is Best Room."</span> <span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-58f8870d28d2481c2959f90145ddbb61">ActionCable.server.broadcast("chat_Best Room", { body: "This Room is Best Room." })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-58f8870d28d2481c2959f90145ddbb61">Copiar</button>
</div>
<p>Se você possui um <em>stream</em> que está relacionada a uma <em>model</em>, então o nome da transmissão pode ser gerada a partir do <em>channel</em> e <em>model</em>. Por exemplo, o código a seguir usa <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Channel/Streams.html#method-i-stream_for"><code>stream_for</code></a> para se inscrever em uma transmissão como <code>comments:Z2lkOi8vVGVzdEFwcC9Qb3N0LzE</code>, onde <code>Z2lkOi8vVGVzdEFwcC9Qb3N0LzE</code> corresponde ao ID Global da <em>model</em> Post.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CommentsChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="k">def</span> <span class="nf">subscribed</span>
    <span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">stream_for</span> <span class="n">post</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-69ac2df0a2037884ddd58afe5cef342d">class CommentsChannel &lt; ApplicationCable::Channel
  def subscribed
    post = Post.find(params[:id])
    stream_for post
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-69ac2df0a2037884ddd58afe5cef342d">Copiar</button>
</div>
<p>Você pode agora transmitir para esse <em>channel</em> chamando <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Channel/Broadcasting/ClassMethods.html#method-i-broadcast_to"><code>broadcast_to</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">CommentsChannel</span><span class="p">.</span><span class="nf">broadcast_to</span><span class="p">(</span><span class="vi">@post</span><span class="p">,</span> <span class="vi">@comment</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-143fcae15f66c8214fdf6a1950649abc">CommentsChannel.broadcast_to(@post, @comment)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-143fcae15f66c8214fdf6a1950649abc">Copiar</button>
</div>
<h4 id="interacoes-cliente-servidor-broadcastings"><a class="anchorlink" href="#interacoes-cliente-servidor-broadcastings">6.2 <em>Broadcastings</em></a></h4><p>Um <em>broadcasting</em> é um link <em>pub/sub</em> em que qualquer coisa transmitida por um <em>publisher</em> é encaminhada diretamente para os assinantes do <em>channel</em>, este, que está transmitindo o <em>broadcasting</em> de mesmo nome. Cada <em>channel</em> pode estar transmitindo zero ou mais <em>broadcastings</em>.</p><p><em>Broadcastings</em> são puramente filas de espera online e dependentes de tempo. Se um consumidor não estiver transmitindo (assinante de um determinado <em>channel</em>), ele não vai receber o <em>broadcast</em> caso se conecte mais tarde.</p><h4 id="interacoes-cliente-servidor-subscriptions"><a class="anchorlink" href="#interacoes-cliente-servidor-subscriptions">6.3 <em>Subscriptions</em></a></h4><p>Quando um consumidor está inscrito em um <em>channel</em>, ele age como assinante (<em>subscriber</em>). Essa conexão é chamada de assinatura (<em>subscription</em>). Mensagens recebidas são então direcionadas para esses inscritos do <em>channel</em> baseadas em um identificador enviado pelo <em>cable consumer</em></p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/chat_channel.js</span>
<span class="c1">// Assumindo que você já requeriu os direitos para enviar notificações web</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">channel</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ChatChannel</span><span class="dl">"</span><span class="p">,</span> <span class="na">room</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Best Room</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span>
  <span class="nx">received</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">appendLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="nx">appendLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">html</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">[data-chat-room='Best Room']</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="dl">"</span><span class="s2">beforeend</span><span class="dl">"</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="nx">createLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`
      &lt;article class="chat-line"&gt;
        &lt;span class="speaker"&gt;</span><span class="p">${</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">sent_by</span><span class="dl">"</span><span class="p">]}</span><span class="s2">&lt;/span&gt;
        &lt;span class="body"&gt;</span><span class="p">${</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">]}</span><span class="s2">&lt;/span&gt;
      &lt;/article&gt;
    `</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-576c1f7675e27966f97c1beb1e92e194">// app/javascript/channels/chat_channel.js
// Assumindo que você já requeriu os direitos para enviar notificações web
import consumer from "./consumer"

consumer.subscriptions.create({ channel: "ChatChannel", room: "Best Room" }, {
  received(data) {
    this.appendLine(data)
  },

  appendLine(data) {
    const html = this.createLine(data)
    const element = document.querySelector("[data-chat-room='Best Room']")
    element.insertAdjacentHTML("beforeend", html)
  },

  createLine(data) {
    return `
      &lt;article class="chat-line"&gt;
        &lt;span class="speaker"&gt;${data["sent_by"]}&lt;/span&gt;
        &lt;span class="body"&gt;${data["body"]}&lt;/span&gt;
      &lt;/article&gt;
    `
  }
})
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-576c1f7675e27966f97c1beb1e92e194">Copiar</button>
</div>
<h4 id="passando-parametros-para-channel"><a class="anchorlink" href="#passando-parametros-para-channel">6.4 Passando Parâmetros para <em>Channel</em></a></h4><p>Você pode passar parâmetros do lado do cliente para o lado do servidor quando cria a <em>subscription</em>. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/chat_channel.rb</span>
<span class="k">class</span> <span class="nc">ChatChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="k">def</span> <span class="nf">subscribed</span>
    <span class="n">stream_from</span> <span class="s2">"chat_</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:room</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0d8c75eb79cf88be838e66f3d7ad74a7"># app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_from "chat_#{params[:room]}"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0d8c75eb79cf88be838e66f3d7ad74a7">Copiar</button>
</div>
<p>Um objeto passado como primeiro argumento em <code>subscriptions.create</code> torna-se a <em>hash</em> <code>params</code> em <em>cable channel</em>. A <em>keyword</em> <code>channel</code> é obrigatória:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/chat_channel.js</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">channel</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ChatChannel</span><span class="dl">"</span><span class="p">,</span> <span class="na">room</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Best Room</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span>
  <span class="nx">received</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">appendLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="nx">appendLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">html</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">[data-chat-room='Best Room']</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="dl">"</span><span class="s2">beforeend</span><span class="dl">"</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="nx">createLine</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`
      &lt;article class="chat-line"&gt;
        &lt;span class="speaker"&gt;</span><span class="p">${</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">sent_by</span><span class="dl">"</span><span class="p">]}</span><span class="s2">&lt;/span&gt;
        &lt;span class="body"&gt;</span><span class="p">${</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">]}</span><span class="s2">&lt;/span&gt;
      &lt;/article&gt;
    `</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7c1f4e157c08dc0a0ffe5bb75a20c3a8">// app/javascript/channels/chat_channel.js
import consumer from "./consumer"

consumer.subscriptions.create({ channel: "ChatChannel", room: "Best Room" }, {
  received(data) {
    this.appendLine(data)
  },

  appendLine(data) {
    const html = this.createLine(data)
    const element = document.querySelector("[data-chat-room='Best Room']")
    element.insertAdjacentHTML("beforeend", html)
  },

  createLine(data) {
    return `
      &lt;article class="chat-line"&gt;
        &lt;span class="speaker"&gt;${data["sent_by"]}&lt;/span&gt;
        &lt;span class="body"&gt;${data["body"]}&lt;/span&gt;
      &lt;/article&gt;
    `
  }
})
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7c1f4e157c08dc0a0ffe5bb75a20c3a8">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Em algum lugar do seu app isso pode ser chamado, talvez,</span>
<span class="c1"># por um novo NewCommentJob.</span>
<span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span>
  <span class="s2">"chat_</span><span class="si">#{</span><span class="n">room</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="ss">sent_by: </span><span class="s1">'Paul'</span><span class="p">,</span>
    <span class="ss">body: </span><span class="s1">'This is a cool chat app.'</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2f76b48467c5a925af4a0828252381db"># Em algum lugar do seu app isso pode ser chamado, talvez,
# por um novo NewCommentJob.
ActionCable.server.broadcast(
  "chat_#{room}",
  {
    sent_by: 'Paul',
    body: 'This is a cool chat app.'
  }
)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2f76b48467c5a925af4a0828252381db">Copiar</button>
</div>
<h4 id="retransmitindo-uma-mensagem"><a class="anchorlink" href="#retransmitindo-uma-mensagem">6.5 Retransmitindo uma Mensagem</a></h4><p>Um caso de uso comum é ter que retransmitir uma mensagem enviada por um cliente para qualquer outro cliente conectado</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/chat_channel.rb</span>
<span class="k">class</span> <span class="nc">ChatChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="k">def</span> <span class="nf">subscribed</span>
    <span class="n">stream_from</span> <span class="s2">"chat_</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:room</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="s2">"chat_</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:room</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c1df3648fc5b3eda7e603919420c5e92"># app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_from "chat_#{params[:room]}"
  end

  def receive(data)
    ActionCable.server.broadcast("chat_#{params[:room]}", data)
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c1df3648fc5b3eda7e603919420c5e92">Copiar</button>
</div>
<div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/chat_channel.js</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">chatChannel</span> <span class="o">=</span> <span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">channel</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ChatChannel</span><span class="dl">"</span><span class="p">,</span> <span class="na">room</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Best Room</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span>
  <span class="nx">received</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// data =&gt; { sent_by: "Paul", body: "This is a cool chat app." }</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">chatChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">sent_by</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Paul</span><span class="dl">"</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is a cool chat app.</span><span class="dl">"</span> <span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6d9e733f2759079be240a8337b52e92c">// app/javascript/channels/chat_channel.js
import consumer from "./consumer"

const chatChannel = consumer.subscriptions.create({ channel: "ChatChannel", room: "Best Room" }, {
  received(data) {
    // data =&gt; { sent_by: "Paul", body: "This is a cool chat app." }
  }
}

chatChannel.send({ sent_by: "Paul", body: "This is a cool chat app." })
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6d9e733f2759079be240a8337b52e92c">Copiar</button>
</div>
<p>A retransmissão vai ser recebida por todos os clientes conectados, <em>incluindo</em> o cliente que enviou a mensagem. Note que <code>params</code> são os mesmos de quando você se inscreveu no <em>channel</em></p><h3 id="full-stack-examples"><a class="anchorlink" href="#full-stack-examples">7 Full-Stack Examples</a></h3><p>The following setup steps are common to both examples:</p>
<ol>
<li>
<a href="#componentes-server-side-connections">Setup your connection</a>.</li>
<li>
<a href="#configuracao-do-channel-pai">Setup your parent channel</a>.</li>
<li>
<a href="#conectar-o-consumidor">Connect your consumer</a>.</li>
</ol>
<h4 id="example-1-user-appearances"><a class="anchorlink" href="#example-1-user-appearances">7.1 Example 1: User Appearances</a></h4><p>Here's a simple example of a channel that tracks whether a user is online or not
and what page they're on. (This is useful for creating presence features like showing
a green dot next to a user name if they're online).</p><p>Create the server-side appearance channel:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/appearance_channel.rb</span>
<span class="k">class</span> <span class="nc">AppearanceChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="k">def</span> <span class="nf">subscribed</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">appear</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">unsubscribed</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">disappear</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">appear</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">appear</span><span class="p">(</span><span class="ss">on: </span><span class="n">data</span><span class="p">[</span><span class="s1">'appearing_on'</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">away</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">away</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-de53d7b7218aef2f0b28f54d14615d59"># app/channels/appearance_channel.rb
class AppearanceChannel &lt; ApplicationCable::Channel
  def subscribed
    current_user.appear
  end

  def unsubscribed
    current_user.disappear
  end

  def appear(data)
    current_user.appear(on: data['appearing_on'])
  end

  def away
    current_user.away
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-de53d7b7218aef2f0b28f54d14615d59">Copiar</button>
</div>
<p>When a subscription is initiated the <code>subscribed</code> callback gets fired and we
take that opportunity to say "the current user has indeed appeared". That
appear/disappear API could be backed by Redis, a database, or whatever else.</p><p>Create the client-side appearance channel subscription:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/appearance_channel.js</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="dl">"</span><span class="s2">AppearanceChannel</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="c1">// Called once when the subscription is created.</span>
  <span class="nx">initialized</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="c1">// Called when the subscription is ready for use on the server.</span>
  <span class="nx">connected</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>
  <span class="p">},</span>

  <span class="c1">// Called when the WebSocket connection is closed.</span>
  <span class="nx">disconnected</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">},</span>

  <span class="c1">// Called when the subscription is rejected by the server.</span>
  <span class="nx">rejected</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">},</span>

  <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">documentIsActive</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">appear</span><span class="p">()</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">away</span><span class="p">()</span>
  <span class="p">},</span>

  <span class="nx">appear</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Calls `AppearanceChannel#appear(data)` on the server.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="dl">"</span><span class="s2">appear</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">appearing_on</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appearingOn</span> <span class="p">})</span>
  <span class="p">},</span>

  <span class="nx">away</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Calls `AppearanceChannel#away` on the server.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="dl">"</span><span class="s2">away</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="nx">install</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">focus</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">blur</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">turbolinks:load</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">visibilitychange</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="nx">uninstall</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">focus</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">blur</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">turbolinks:load</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">visibilitychange</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="kd">get</span> <span class="nx">documentIsActive</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">visibilityState</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">visible</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">hasFocus</span><span class="p">()</span>
  <span class="p">},</span>

  <span class="kd">get</span> <span class="nx">appearingOn</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">[data-appearing-on]</span><span class="dl">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">element</span> <span class="p">?</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">data-appearing-on</span><span class="dl">"</span><span class="p">)</span> <span class="p">:</span> <span class="kc">null</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-14963274828cfb4c9e633ffbca15f11b">// app/javascript/channels/appearance_channel.js
import consumer from "./consumer"

consumer.subscriptions.create("AppearanceChannel", {
  // Called once when the subscription is created.
  initialized() {
    this.update = this.update.bind(this)
  },

  // Called when the subscription is ready for use on the server.
  connected() {
    this.install()
    this.update()
  },

  // Called when the WebSocket connection is closed.
  disconnected() {
    this.uninstall()
  },

  // Called when the subscription is rejected by the server.
  rejected() {
    this.uninstall()
  },

  update() {
    this.documentIsActive ? this.appear() : this.away()
  },

  appear() {
    // Calls `AppearanceChannel#appear(data)` on the server.
    this.perform("appear", { appearing_on: this.appearingOn })
  },

  away() {
    // Calls `AppearanceChannel#away` on the server.
    this.perform("away")
  },

  install() {
    window.addEventListener("focus", this.update)
    window.addEventListener("blur", this.update)
    document.addEventListener("turbolinks:load", this.update)
    document.addEventListener("visibilitychange", this.update)
  },

  uninstall() {
    window.removeEventListener("focus", this.update)
    window.removeEventListener("blur", this.update)
    document.removeEventListener("turbolinks:load", this.update)
    document.removeEventListener("visibilitychange", this.update)
  },

  get documentIsActive() {
    return document.visibilityState == "visible" &amp;&amp; document.hasFocus()
  },

  get appearingOn() {
    const element = document.querySelector("[data-appearing-on]")
    return element ? element.getAttribute("data-appearing-on") : null
  }
})
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-14963274828cfb4c9e633ffbca15f11b">Copiar</button>
</div>
<h6 id="client-server-interaction"><a class="anchorlink" href="#client-server-interaction">7.1.1 Client-Server Interaction</a></h6>
<ol>
<li><p><strong>Client</strong> connects to the <strong>Server</strong> via <code>App.cable =
ActionCable.createConsumer("ws://cable.example.com")</code>. (<code>cable.js</code>). The
<strong>Server</strong> identifies this connection by <code>current_user</code>.</p></li>
<li><p><strong>Client</strong> subscribes to the appearance channel via
<code>consumer.subscriptions.create({ channel: "AppearanceChannel" })</code>. (<code>appearance_channel.js</code>)</p></li>
<li><p><strong>Server</strong> recognizes a new subscription has been initiated for the
appearance channel and runs its <code>subscribed</code> callback, calling the <code>appear</code>
method on <code>current_user</code>. (<code>appearance_channel.rb</code>)</p></li>
<li><p><strong>Client</strong> recognizes that a subscription has been established and calls
<code>connected</code> (<code>appearance_channel.js</code>) which in turn calls <code>install</code> and <code>appear</code>.
<code>appear</code> calls <code>AppearanceChannel#appear(data)</code> on the server, and supplies a
data hash of <code>{ appearing_on: this.appearingOn }</code>. This is
possible because the server-side channel instance automatically exposes all
public methods declared on the class (minus the callbacks), so that these can be
reached as remote procedure calls via a subscription's <code>perform</code> method.</p></li>
<li><p><strong>Server</strong> receives the request for the <code>appear</code> action on the appearance
channel for the connection identified by <code>current_user</code>
(<code>appearance_channel.rb</code>). <strong>Server</strong> retrieves the data with the
<code>:appearing_on</code> key from the data hash and sets it as the value for the <code>:on</code>
key being passed to <code>current_user.appear</code>.</p></li>
</ol>
<h4 id="example-2-receiving-new-web-notifications"><a class="anchorlink" href="#example-2-receiving-new-web-notifications">7.2 Example 2: Receiving New Web Notifications</a></h4><p>The appearance example was all about exposing server functionality to
client-side invocation over the WebSocket connection. But the great thing
about WebSockets is that it's a two-way street. So now let's show an example
where the server invokes an action on the client.</p><p>This is a web notification channel that allows you to trigger client-side
web notifications when you broadcast to the right streams:</p><p>Create the server-side web notifications channel:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/channels/web_notifications_channel.rb</span>
<span class="k">class</span> <span class="nc">WebNotificationsChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
  <span class="k">def</span> <span class="nf">subscribed</span>
    <span class="n">stream_for</span> <span class="n">current_user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f803ebbf1dd7ef5488f4fadadb139db6"># app/channels/web_notifications_channel.rb
class WebNotificationsChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_for current_user
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f803ebbf1dd7ef5488f4fadadb139db6">Copiar</button>
</div>
<p>Create the client-side web notifications channel subscription:</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// app/javascript/channels/web_notifications_channel.js</span>
<span class="c1">// Client-side which assumes you've already requested</span>
<span class="c1">// the right to send web notifications.</span>
<span class="k">import</span> <span class="nx">consumer</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./consumer</span><span class="dl">"</span>

<span class="nx">consumer</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="dl">"</span><span class="s2">WebNotificationsChannel</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">received</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nx">Notification</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">],</span> <span class="na">body</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">])</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-73e870942cc3bd843f058baf622019cf">// app/javascript/channels/web_notifications_channel.js
// Client-side which assumes you've already requested
// the right to send web notifications.
import consumer from "./consumer"

consumer.subscriptions.create("WebNotificationsChannel", {
  received(data) {
    new Notification(data["title"], body: data["body"])
  }
})
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-73e870942cc3bd843f058baf622019cf">Copiar</button>
</div>
<p>Broadcast content to a web notification channel instance from elsewhere in your
application:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Somewhere in your app this is called, perhaps from a NewCommentJob</span>
<span class="no">WebNotificationsChannel</span><span class="p">.</span><span class="nf">broadcast_to</span><span class="p">(</span>
  <span class="n">current_user</span><span class="p">,</span>
  <span class="ss">title: </span><span class="s1">'New things!'</span><span class="p">,</span>
  <span class="ss">body: </span><span class="s1">'All the news fit to print'</span>
<span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9a425fbcff011e11b8f01080322b7b68"># Somewhere in your app this is called, perhaps from a NewCommentJob
WebNotificationsChannel.broadcast_to(
  current_user,
  title: 'New things!',
  body: 'All the news fit to print'
)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9a425fbcff011e11b8f01080322b7b68">Copiar</button>
</div>
<p>The <code>WebNotificationsChannel.broadcast_to</code> call places a message in the current
subscription adapter's pubsub queue under a separate broadcasting name for each
user. For a user with an ID of 1, the broadcasting name would be
<code>web_notifications:1</code>.</p><p>The channel has been instructed to stream everything that arrives at
<code>web_notifications:1</code> directly to the client by invoking the <code>received</code>
callback. The data passed as argument is the hash sent as the second parameter
to the server-side broadcast call, JSON encoded for the trip across the wire
and unpacked for the data argument arriving as <code>received</code>.</p><h4 id="more-complete-examples"><a class="anchorlink" href="#more-complete-examples">7.3 More Complete Examples</a></h4><p>See the <a href="https://github.com/rails/actioncable-examples">rails/actioncable-examples</a>
repository for a full example of how to set up Action Cable in a Rails app and adding channels.</p><h3 id="configuracao"><a class="anchorlink" href="#configuracao">8 Configuração</a></h3><p>O <em>Action Cable</em> tem duas configurações necessárias: um adaptador de assinatura (<em>subscription</em>) e origens de requisição (<em>request</em>) permitidas.</p><h4 id="adaptador-de-assinatura"><a class="anchorlink" href="#adaptador-de-assinatura">8.1 Adaptador de assinatura</a></h4><p>Por padrão, <em>Action Cable</em> procura um arquivo de configuração em <code>config/cable.yml</code>.
O arquivo deve especificar um adaptador (<em>adapter</em>) para cada ambiente Rails. Veja o
<a href="#dependencias">Dependências</a> seção para obter informações adicionais sobre adaptadores.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">development</span><span class="pi">:</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">async</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">async</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">redis</span>
  <span class="na">url</span><span class="pi">:</span> <span class="s">redis://10.10.3.153:6381</span>
  <span class="na">channel_prefix</span><span class="pi">:</span> <span class="s">appname_production</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d7035d1a6295a214dfdf288af035d29d">development:
  adapter: async

test:
  adapter: async

production:
  adapter: redis
  url: redis://10.10.3.153:6381
  channel_prefix: appname_production
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d7035d1a6295a214dfdf288af035d29d">Copiar</button>
</div>
<h5 id="configuracao-do-adaptador-adapter"><a class="anchorlink" href="#configuracao-do-adaptador-adapter">8.1.1 Configuração do Adaptador (<em>Adapter</em>)</a></h5><p>Abaixo está uma lista dos adaptadores de assinatura disponíveis para usuários finais.</p><h6 id="adaptador-async"><a class="anchorlink" href="#adaptador-async">8.1.1.1 Adaptador Async</a></h6><p>O adaptador assíncrono destina-se ao desenvolvimento / teste e não deve ser usado em produção.</p><h6 id="adaptador-redis"><a class="anchorlink" href="#adaptador-redis">8.1.1.2 Adaptador Redis</a></h6><p>O adaptador Redis requer que os usuários forneçam uma URL apontando para o servidor Redis.
Além disso, um <code>channel_prefix</code> pode ser fornecido para evitar colisões de nome de canal
ao usar o mesmo servidor Redis para vários aplicativos. Veja a
<a href="https://redis.io/topics/pubsub#database-amp-scoping">Documentação Redis PubSub</a> para mais detalhes.</p><h6 id="adaptador-postgresql"><a class="anchorlink" href="#adaptador-postgresql">8.1.1.3 Adaptador PostgreSQL</a></h6><p>O adaptador PostgreSQL usa o <em>pool</em> de conexão do <em>Active Record</em> e, portanto, o
configuração do banco de dados <code>config/database.yml</code> do aplicativo, para sua conexão.
Isso pode mudar no futuro. <a href="https://github.com/rails/rails/issues/27214">#27214</a></p><h4 id="origens-de-requisicao-permitidas"><a class="anchorlink" href="#origens-de-requisicao-permitidas">8.2 Origens de Requisição Permitidas</a></h4><p>Action Cable só aceitará requisições de origens especificadas, que são
passado para a configuração do servidor como um array. As origens podem ser instâncias de
<em>strings</em> ou expressões regulares, contra as quais uma verificação de correspondência será realizada.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_cable</span><span class="p">.</span><span class="nf">allowed_request_origins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'https://rubyonrails.com'</span><span class="p">,</span> <span class="sr">%r{http://ruby.*}</span><span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ce80e9d3f28ce748ca47df98ca4e9931">config.action_cable.allowed_request_origins = ['https://rubyonrails.com', %r{http://ruby.*}]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ce80e9d3f28ce748ca47df98ca4e9931">Copiar</button>
</div>
<p>Para desativar e permitir requisições de qualquer origem:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_cable</span><span class="p">.</span><span class="nf">disable_request_forgery_protection</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bd3bb174d7c7b0a0a83367591cc40c08">config.action_cable.disable_request_forgery_protection = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bd3bb174d7c7b0a0a83367591cc40c08">Copiar</button>
</div>
<p>Por padrão, o <em>Action Cable</em> permite todas as requisições de localhost:3000 durante a execução
no ambiente de desenvolvimento.</p><h4 id="configuracao-do-consumidor"><a class="anchorlink" href="#configuracao-do-consumidor">8.3 Configuração do Consumidor</a></h4><p>Para configurar a URL, adicione uma chamada para <a href="https://api.rubyonrails.org/v6.1.4/classes/ActionCable/Helpers/ActionCableHelper.html#method-i-action_cable_meta_tag"><code>action_cable_meta_tag</code></a> em seu <em>layout</em> HTML
HEAD. Isso usa uma URL ou caminho (<em>path</em>) normalmente definido via <code>config.action_cable.url</code> nos
arquivos de configuração de ambiente.</p><h4 id="configuracao-do-worker-pool"><a class="anchorlink" href="#configuracao-do-worker-pool">8.4 Configuração do <em>Worker Pool</em></a></h4><p>O <em>pool</em> de <em>workers</em> é usado para executar retornos (<em>callbacks</em>) de conexão e ações de <em>channel</em> em
isolamento da <em>thread</em> principal do servidor. <em>Action Cable</em> permite que a aplicação
configure o número de <em>threads</em> processados ​​simultaneamente no <em>worker pool</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_cable</span><span class="p">.</span><span class="nf">worker_pool_size</span> <span class="o">=</span> <span class="mi">4</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b4ff643281070d0fdb7be2d111febd29">config.action_cable.worker_pool_size = 4
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b4ff643281070d0fdb7be2d111febd29">Copiar</button>
</div>
<p>Além disso, observe que seu servidor deve fornecer pelo menos o mesmo número de conexões de banco de dados
que você tem de <em>workers</em>. O tamanho do <em>worker pool</em> de trabalho padrão é definido como 4, então
isso significa que você deve disponibilizar pelo menos 4 conexões de banco de dados.
Você pode mudar isso em <code>config/database.yml</code> através do atributo <code>pool</code>.</p><h4 id="log-no-lado-do-client"><a class="anchorlink" href="#log-no-lado-do-client">8.5 Log no lado do client</a></h4><p>O log <em>client side</em> é desabilitado por padrão. Você pode habilitar essa configuração em <code>ActionCable.logger.enable</code> trocando para <code>true</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">import</span> <span class="o">*</span> <span class="n">as</span> <span class="no">ActionCable</span> <span class="n">from</span> <span class="s1">'@rails/actioncable'</span>

<span class="no">ActionCable</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6eb523d2c16bd9f76a61156f4dd527d3">import * as ActionCable from '@rails/actioncable'

ActionCable.logger.enabled = true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6eb523d2c16bd9f76a61156f4dd527d3">Copiar</button>
</div>
<h4 id="outras-configuracoes"><a class="anchorlink" href="#outras-configuracoes">8.6 Outras Configurações</a></h4><p>A outra opção comum de configurar são as <em>tags</em> de <em>log</em> aplicadas ao
<em>logger</em> por conexão. Aqui está um exemplo que usa
o ID da conta do usuário, se disponível, senão "sem conta" durante a marcação:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_cable</span><span class="p">.</span><span class="nf">log_tags</span> <span class="o">=</span> <span class="p">[</span>
  <span class="o">-&gt;</span> <span class="n">request</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s1">'user_account_id'</span><span class="p">]</span> <span class="o">||</span> <span class="s2">"no-account"</span> <span class="p">},</span>
  <span class="ss">:action_cable</span><span class="p">,</span>
  <span class="o">-&gt;</span> <span class="n">request</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">uuid</span> <span class="p">}</span>
<span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2a20872a59568a1ef142dcc9e24019b5">config.action_cable.log_tags = [
  -&gt; request { request.env['user_account_id'] || "no-account" },
  :action_cable,
  -&gt; request { request.uuid }
]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2a20872a59568a1ef142dcc9e24019b5">Copiar</button>
</div>
<p>Para obter uma lista completa de todas as opções de configuração, consulte o
classe <code>ActionCable::Server::Configuration</code>.</p><h3 id="executando-servidores-cable-autonomos"><a class="anchorlink" href="#executando-servidores-cable-autonomos">9 Executando Servidores <em>Cable</em> Autônomos</a></h3><h4 id="na-aplicacao"><a class="anchorlink" href="#na-aplicacao">9.1 Na Aplicação</a></h4><p>O <em>Action Cable</em> pode ser executado junto com sua aplicação Rails. Por exemplo, para
escutar as requisições <em>WebSocket</em> em <code>/websocket</code>, especifique esse caminho para
<code>config.action_cable.mount_path</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_cable</span><span class="p">.</span><span class="nf">mount_path</span> <span class="o">=</span> <span class="s1">'/websocket'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6dd1c079672b07014e75226b25e9f2df"># config/application.rb
class Application &lt; Rails::Application
  config.action_cable.mount_path = '/websocket'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6dd1c079672b07014e75226b25e9f2df">Copiar</button>
</div>
<p>Você pode usar <code>ActionCable.createConsumer()</code> para conectar ao
<em>cable server</em> se <code>action_cable_meta_tag</code> for invocado no layout. Caso contrário, um caminho é
especificado como primeiro argumento para <code>createConsumer</code> (e.g. <code>ActionCable.createConsumer("/websocket")</code>).</p><p>Para cada instância de seu servidor que você cria e para cada <em>worker</em> que seu servidor
instancia, você também terá uma nova instância do <em>Action Cable</em>, mas o uso do Redis
mantém as mensagens sincronizadas entre as conexões.</p><h4 id="autonomo"><a class="anchorlink" href="#autonomo">9.2 Autônomo</a></h4><p>Os <em>cable servers</em> a cabo podem ser separados do servidor de aplicação normal. Este
ainda é uma aplicação Rack, mas é sua própria aplicação Rack. O recomendado
para a configuração básica é a seguinte:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># cable/config.ru</span>
<span class="nb">require_relative</span> <span class="s2">"../config/environment"</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">eager_load!</span>

<span class="n">run</span> <span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-eb3fad7012f13ccba2530a9bfdbd551a"># cable/config.ru
require_relative "../config/environment"
Rails.application.eager_load!

run ActionCable.server
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-eb3fad7012f13ccba2530a9bfdbd551a">Copiar</button>
</div>
<p>Então você inicia o servidor usando um <em>binstub</em> em <code>bin/cable</code> ala:</p><div class="code_container">
<pre><code class="highlight plaintext">#!/bin/bash
bundle exec puma -p 28080 cable/config.ru
</code></pre>
<textarea class="clipboard-content" id="clipboard-8e15c9c10557198797d48161bc16afb8">#!/bin/bash
bundle exec puma -p 28080 cable/config.ru
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8e15c9c10557198797d48161bc16afb8">Copiar</button>
</div>
<p>O código irá iniciar um <em>cable server</em> na porta 28080.</p><h4 id="notas"><a class="anchorlink" href="#notas">9.3 Notas</a></h4><p>O servidor WebSocket não tem acesso à sessão, mas tem
acesso aos cookies. Isso pode ser usado quando você precisa lidar com
autenticação. Você pode ver uma maneira de fazer isso com o Devise neste <a href="https://greg.molnar.io/blog/actioncable-devise-authentication/">artigo</a>.</p><h3 id="dependencias"><a class="anchorlink" href="#dependencias">10 Dependências</a></h3><p>O <em>Action Cable</em> fornece uma interface de adaptador de assinatura para processar seus
<em>pubsub</em> internos. Por padrão, adaptadores assíncronos, <em>inline</em>, PostgreSQL e Redis
estão incluídos. O adaptador padrão
em novas aplicações Rails é o adaptador assíncrono (<code>async</code>).</p><p>O lado Ruby das coisas é construído em cima de <a href="https://github.com/faye/websocket-driver-ruby">websocket-driver</a>,
<a href="https://github.com/celluloid/nio4r">nio4r</a> e <a href="https://github.com/ruby-concurrency/concurrent-ruby">concurrent-ruby</a>.</p><h3 id="implantacao"><a class="anchorlink" href="#implantacao">11 Implantação</a></h3><p>O <em>Action Cable</em> é alimentado por uma combinação de <em>WebSockets</em> e <em>threads</em>. Tanto o
<a href="https://www.techopedia.com/definition/31509/plumbing"><em>plumbing</em></a> do <em>framework</em> e o trabalho do <em>channel</em> especificado pelo usuário são tratados internamente,
usando suporte de <em>thread</em> nativo do Ruby. Isso significa que você pode usar todos os seus
<em>models</em> dos Rails sem problemas, contanto que você não tenha cometido nenhum pecado de <em>thread-safety</em>.</p><p>O servidor <em>Action Cable</em> implementa o <em>Rack socket hijacking API</em>,
permitindo assim o uso de um padrão <em>multithread</em> para o gerenciamento de conexões
internamente, independentemente de o servidor de aplicativos ser multiencadeado ou não.</p><p>Assim, <em>Action Cable</em> funciona com servidores populares como <em>Unicorn</em>, <em>Puma</em> e
<em>Passenger</em>.</p><h3 id="teste"><a class="anchorlink" href="#teste">12 Teste</a></h3><p>Você pode encontrar instruções detalhadas de como testar a sua funcionalidade <em>Action Cable</em> no
<a href="testing.html#testing-action-cable">guia de teste</a>.</p>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua se vir qualquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
