<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Threading e Execução de Código no Rails — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Threading e Execução de Código no Rails — Ruby on Rails Guides" />
  <meta name="description" content="Threading e Execução de Código no RailsDepois de ler esse guia, você vai saber: Quais códigos o Rails executa automaticamente de maneira concorrente Como integrar código concorrente feito por você com a parte interna do Rails Como envolver todo o código da aplicação Como modificar o recarregamento da aplicação" />
  <meta property="og:description" content="Threading e Execução de Código no RailsDepois de ler esse guia, você vai saber: Quais códigos o Rails executa automaticamente de maneira concorrente Como integrar código concorrente feito por você com a parte interna do Rails Como envolver todo o código da aplicação Como modificar o recarregamento da aplicação" />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.8</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                  <dd><a href="active_record_encryption.html">Active Record Encryption</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - Dezembro 2021</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</option>
                  <option value="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
                  <option value="active_record_encryption.html">Active Record Encryption</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_0_release_notes.html">Version 7.0 - Dezembro 2021</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2><em>Threading</em> e Execução de Código no Rails</h2><p>Depois de ler esse guia, você vai saber:</p>
<ul>
<li>Quais códigos o Rails executa automaticamente de maneira concorrente</li>
<li>Como integrar código concorrente feito por você com a parte interna do Rails</li>
<li>Como envolver todo o código da aplicação</li>
<li>Como modificar o recarregamento da aplicação</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#concorr%C3%AAncia-autom%C3%A1tica">Concorrência Automática</a></li>
<li>
<a href="#executor">Executor</a>

<ul>
<li><a href="#callbacks-padr%C3%B5es">Callbacks Padrões</a></li>
<li><a href="#envolvendo-c%C3%B3digo-da-aplica%C3%A7%C3%A3o">Envolvendo Código da Aplicação</a></li>
<li><a href="#executor-concorr%C3%AAncia">Concorrência</a></li>
</ul>
</li>
<li>
<a href="#reloader">Reloader</a>

<ul>
<li><a href="#callbacks"><em>Callbacks</em></a></li>
<li><a href="#descarregamento-de-classes">Descarregamento de Classes</a></li>
<li><a href="#reloader-concorr%C3%AAncia">Concorrência</a></li>
</ul>
</li>
<li>
<a href="#comportamento-do-framework">Comportamento do <em>Framework</em></a>

<ul>
<li><a href="#configura%C3%A7%C3%A3o">Configuração</a></li>
</ul>
</li>
<li>
<a href="#load-interlock">Load Interlock</a>

<ul>
<li><a href="#permit-concurrent-loads"><code>permit_concurrent_loads</code></a></li>
<li><a href="#actiondispatch-debuglocks">ActionDispatch::DebugLocks</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="concorrência-automática"><a class="anchorlink" href="#concorr%C3%AAncia-autom%C3%A1tica">1 Concorrência Automática</a></h3><p>O Rails automaticamente permite que várias operações sejam feitas ao mesmo tempo.</p><p>Quando um servidor web que utiliza <em>threads</em> está em uso, como o Puma, que é padrão,
múltiplas requisições HTTP serão servidas simultaneamente, com cada requisição
utilizando sua própria instância de <em>controller</em>.</p><p>Adaptadores do Active Job que usam <em>thread</em>, incluindo o Async, que é padrão, vai
executar vários <em>jobs</em> ao mesmo tempo. Os canais (<em>channels</em>) Action Cable também
são gerenciados dessa forma.</p><p>Todos esses mecanismos envolvem múltiplas <em>threads</em>, cada uma gerenciando trabalho
para uma única instância de algum objeto (<em>controller</em>, <em>job</em>, <em>channel</em>), enquanto
compartilham o espaço global do processo (classes e suas configurações e variáveis globais).
Contanto que seu código não modifique nenhuma dessas coisas compartilhadas, ele pode
quase esquecer que outras <em>threads</em> existem.</p><p>O resto desse guia vai mostrar os mecanismos que o Rails usa para fazer com que
suas <em>threads</em> sejam "quase ignoráveis" e como extensões e aplicações com necessidades
especiais podem usar esse aparato.</p><h3 id="executor"><a class="anchorlink" href="#executor">2 Executor</a></h3><p>O <em>Rails Executor</em> separa o código da sua aplicação do código de <em>framework</em>:
toda vez que o <em>framework</em> invoca código que você escreveu em sua aplicação, ele
vai estar envolvido pelo <em>Executor</em>.</p><p>O <em>Executor</em> consiste em dois <em>callbacks</em>: <code>to_run</code> e <code>to_complete</code>. O <em>callback</em>
<em>Run</em> é chamado antes do código da aplicação e o <em>Complete</em> é chamado após o código
da aplicação.</p><h4 id="callbacks-padrões"><a class="anchorlink" href="#callbacks-padr%C3%B5es">2.1 Callbacks Padrões</a></h4><p>Em uma aplicação Rails padrão, os <em>callbacks</em> do <em>Executor</em> são usados para:</p>
<ul>
<li>acompanhar quais <em>threads</em> estão em uma posição segura para carregar e recarregar código automaticamente (<em>autoloading</em> e <em>reloading</em>).</li>
<li>habilitar e desabilitar o cache do Active Record</li>
<li>retornar conexões Active Record adquiridas para o <em>pool</em> de conexões.</li>
<li>controlar a duração dos caches internos</li>
</ul>
<p>Antes do Rails 5.0, algumas dessas funções eram gerenciadas por <em>middlewares</em> Rack
(como <code>ActiveRecord::ConnectionAdapters::ConnectionManagement</code>) ou envolvendo o código
diretamente com métodos como <code>ActiveRecord::Base.connection_pool.with_connection</code>.
O <em>Executor</em> substitui essas interfaces por uma mais simples e mais abstrata.</p><h4 id="envolvendo-código-da-aplicação"><a class="anchorlink" href="#envolvendo-c%C3%B3digo-da-aplica%C3%A7%C3%A3o">2.2 Envolvendo Código da Aplicação</a></h4><p>Se você está escrevendo uma biblioteca ou componente que vai invocar código da aplicação,
você deve envolver esse código com uma chamada para o <em>Executor</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
  <span class="c1"># chame o código da aplicação aqui</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.executor.wrap do
  # chame o código da aplicação aqui
end
">Copy</button>
</div>
<div class="info"><p>Se você quiser repetidamente invocar código da aplicação de um processo de
longa duração, talvez você queira usar o <a href="#reloader"><em>Reloader</em></a> ao invés do <em>Executor</em>.</p></div><p>Toda <em>thread</em> deve ser envolvida antes de rodar código da aplicação, então se sua
aplicação manualmente delega trabalho para outras <em>threads</em> utilizando, por exemplo
<code>Thread.new</code> ou funcionalidades da biblioteca Concurrent Ruby que usam <em>pools</em> de
<em>threads</em>, você deve imediatamente envolver o bloco:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
    <span class="c1"># seu código aqui</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Thread.new do
  Rails.application.executor.wrap do
    # seu código aqui
  end
end
">Copy</button>
</div>
<div class="note"><p>A biblioteca Concurrent Ruby usa um objeto <code>ThreadPoolExecutor</code>, que as vezes se configura
com uma opção chamada <code>executor</code>. Apesar do nome, isso não se relaciona com o <em>Executor</em> do Rails.</p></div><p>O <em>Executor</em> admite re-entradas seguramente. Se ele já está ativo na <em>thread</em> atual,
<code>wrap</code> não faz nada (é uma <em>no-op</em>).</p><p>Se não for possível envolver o código da aplicação em um bloco (como por exemplo
a API Rack, que torna isso difícil), você pode utilizar o par de métodos <code>run!</code>
/ <code>complete!</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">execution_context</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">run!</span>
  <span class="c1"># seu código aqui</span>
<span class="k">ensure</span>
  <span class="n">execution_context</span><span class="p">.</span><span class="nf">complete!</span> <span class="k">if</span> <span class="n">execution_context</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Thread.new do
  execution_context = Rails.application.executor.run!
  # seu código aqui
ensure
  execution_context.complete! if execution_context
end
">Copy</button>
</div>
<h4 id="executor-concorrência"><a class="anchorlink" href="#executor-concorr%C3%AAncia">2.3 Concorrência</a></h4><p>O <em>Executor</em> vai colocar a <em>thread</em> atual no modo <code>running</code>, no <a href="#load-interlock">Load Interlock</a>.
Essa operação irá bloquear temporariamente outras <em>threads</em> que estejam carregando automaticamante
(<em>autoloading</em>) uma constante ou que estejam carregando ou recarregando a aplicação.</p><h3 id="reloader"><a class="anchorlink" href="#reloader">3 Reloader</a></h3><p>Assim como o <em>Executor</em>, o <em>Reloader</em> também envolve o código da aplicação.
Se o <em>Executor</em> ainda não estiver ativo na <em>thread</em> atual, o <em>Reloader</em> vai
invocá-lo para você, logo você só precisa chamar o <em>Reloader</em>. Isso garante que
tudo que o <em>Reloader</em> faça, inclusive suas invocações de <em>callback</em>, ocorram envolvidas
pelo <em>Executor</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">reloader</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
  <span class="c1"># call application code here</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.reloader.wrap do
  # call application code here
end
">Copy</button>
</div>
<p>O <em>Reloader</em> é mais indicado para processos de longa duração de nível de <em>framework</em>
que chamam repetidamente o código da aplicação, como servidores web e filas de <em>jobs</em>.
O Rails automaticamente envolve requisições web e <em>workers</em> do Active Job, logo
você raramente precisará invocar o <em>Reloader</em> por si mesmo. Sempre se pergunte se
o <em>Executor</em> não seria a melhor opção para o seu caso de uso.</p><h4 id="callbacks"><a class="anchorlink" href="#callbacks">3.1 <em>Callbacks</em></a></h4><p>Antes de executar o bloco envolvido, o <em>Reloader</em> vai verificar se a aplicação que
está rodando precisa ser recarregada. Por exemplo, talvez o código fonte de um <em>model</em>
tenha sido alterado. Se é determinado que um recarregamento é necessário, o <em>Reloader</em>
esperará até que seja seguro fazer isso e depois disso irá recarregar a aplicação
antes de continuar. Quando a aplicação está configurada para sempre ser recarregada,
indepentende de modificações, o recarregamento da aplicação é feito no final do bloco,
ao invés de no começo.</p><p>O <em>Reloader</em> também oferece os <em>callbacks</em> <code>to_run</code> e <code>to_complete</code>. Eles são
invocados nos mesmos pontos do <em>Executor</em>, mas somente quando a execução atual começar
um recarregamento da aplicação. Quando o recarregamento não é necessário, o <em>Reloader</em>
irá invocar o bloco envolvido por ele sem executar os <em>callbacks</em>.</p><h4 id="descarregamento-de-classes"><a class="anchorlink" href="#descarregamento-de-classes">3.2 Descarregamento de Classes</a></h4><p>A parte mais trabalhosa do processo de recarregamento é o Descarregamento de Classes,
em que todas as classes automaticamente carregadas são removidas e ficam prontas para
ser carregadas de novo. Isso irá ocorrer imediatamente antes do <em>callback</em> Run ou Complete,
dependendo do valor da configuração <code>reload_classes_only_on_change</code>.</p><p>Na maioria das vezes, algumas ações extras precisam ser feitas exatamente no momento
antes ou no momento posterior ao Descarregamento de Classes, logo o <em>Reloader</em> também
fornece os <em>callbacks</em> <code>before_class_unload</code> e <code>after_class_unload</code>.</p><h4 id="reloader-concorrência"><a class="anchorlink" href="#reloader-concorr%C3%AAncia">3.3 Concorrência</a></h4><p>Somente processos "top level" de longa duração devem invocar o <em>Reloader</em>, porque
se ele determinar que um recarregamento é necessário, ele vai bloquear até que
todas as outras <em>threads</em> tenham terminado qualquer invocação do <em>Executor</em>.</p><p>Se isso ocorrer numa <em>sub-thread</em>, com a <em>thread</em> pai esperando dentro do <em>Executor</em>,
isso irá causar um bloqueio permanente (<em>deadlock</em>) inevitável: o recarregamento
deve ocorrer antes da <em>sub-thread</em> ser executada, mas ela não pode ser invocada com
segurança enquanto a <em>thread</em> pai está em execução. <em>Sub-threads</em> devem usar somente o
<em>Executor</em>.</p><h3 id="comportamento-do-framework"><a class="anchorlink" href="#comportamento-do-framework">4 Comportamento do <em>Framework</em></a></h3><p>Os componentes do <em>framework</em> Rails também utilizam essas ferramentas para gerenciar
suas necessidades relacionadas à concorrência.</p><p><code>ActionDispatch::Executor</code> e <code>ActionDispatch::Reloader</code> são <em>middlewares</em> Rack
que envolvem requisições com o <em>Executor</em> ou <em>Reloader</em> fornecido. Esses componentes
são automaticamente incluídos na pilha de <em>middlewares</em> de uma aplicação padrão.
O <em>Reloader</em> irá garantir que qualquer requisição HTTP seja servida com a cópia
mais recente possível da aplicação se houver qualquer mudança de código.</p><p>O Active Job também envolve a execução de <em>jobs</em> com o <em>Reloader</em>, carregando a
última versão do código para executar cada <em>job</em> assim que sai da fila para ser executado.</p><p>Ao invés de utilizar o <em>Reloader</em>, o Action Cable usa o <em>Executor</em>: já que cada conexão <em>Cable</em>
é associada a uma instância de uma classe, não é possível recarregar a cada mensagem WebSocket.
Somente o <em>message handler</em> é envolvido pelo <em>Reloader</em> a propósito. Uma conexão
de longa duração não previne o recarregamento a aplicação promovido por uma requisição ou
<em>job</em>. Ao invés disso, o Action Cable utiliza o <em>callback</em> <code>before_class_unload</code>
do <em>Reloader</em> para desconectar todas as suas conexões. Quando o cliente automaticamente
reconectar, ele irá se comunicar com a nova versão do código.</p><p>Os pontos acima são <em>entry points</em> para o <em>framework</em>, logo eles são responsáveis
por garantir a proteção de suas <em>threads</em> e por decidir quando um recarregamento
é necessário. Outros componentes utilizam apenas o <em>Executor</em> quando criam <em>threads</em>
adicionais.</p><h4 id="configuração"><a class="anchorlink" href="#configura%C3%A7%C3%A3o">4.1 Configuração</a></h4><p>O <em>Reloader</em> apenas verifica mudanças em arquivos se <code>cache_classes</code> for falso e
<code>reload_classes_only_on_change</code> for verdadeiro (que é o padrão no ambiente <code>development</code>).</p><p>Quando <code>cache_classes</code> for verdadeiro (em <code>production</code>, por padrão), o <em>Reloader</em>
passa o controle imediatamente para o <em>Executor</em>.</p><p>O <em>Executor</em> sempre tem coisas importantes para fazer, como gerenciar as conexões
do banco de dados. Quando <code>cache_classes</code> e <code>eager_load</code> são verdadeiros (<code>production</code>),
nenhum autocarregamento ou recarregamento de classes irá ocorrer, então o <em>Load Interlock</em>
não é necessário. Se algum dessas configurações forem falsas (<code>development</code>), o <em>Executor</em>
irá usar o <em>Load Interlock</em> para garantir que constantes só serão carregadas quando for
seguro.</p><h3 id="load-interlock"><a class="anchorlink" href="#load-interlock">5 Load Interlock</a></h3><p>The Load Interlock allows autoloading and reloading to be enabled in a
multi-threaded runtime environment.</p><p>When one thread is performing an autoload by evaluating the class definition
from the appropriate file, it is important no other thread encounters a
reference to the partially-defined constant.</p><p>Similarly, it is only safe to perform an unload/reload when no application code
is in mid-execution: after the reload, the <code>User</code> constant, for example, may
point to a different class. Without this rule, a poorly-timed reload would mean
<code>User.new.class == User</code>, or even <code>User == User</code>, could be false.</p><p>Both of these constraints are addressed by the Load Interlock. It keeps track of
which threads are currently running application code, loading a class, or
unloading autoloaded constants.</p><p>Only one thread may load or unload at a time, and to do either, it must wait
until no other threads are running application code. If a thread is waiting to
perform a load, it doesn't prevent other threads from loading (in fact, they'll
cooperate, and each perform their queued load in turn, before all resuming
running together).</p><h4 id="permit-concurrent-loads"><a class="anchorlink" href="#permit-concurrent-loads">5.1 <code>permit_concurrent_loads</code></a></h4><p>The Executor automatically acquires a <code>running</code> lock for the duration of its
block, and autoload knows when to upgrade to a <code>load</code> lock, and switch back to
<code>running</code> again afterwards.</p><p>Other blocking operations performed inside the Executor block (which includes
all application code), however, can needlessly retain the <code>running</code> lock. If
another thread encounters a constant it must autoload, this can cause a
deadlock.</p><p>For example, assuming <code>User</code> is not yet loaded, the following will deadlock:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
  <span class="n">th</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
      <span class="no">User</span> <span class="c1"># inner thread waits here; it cannot load</span>
           <span class="c1"># User while another thread is running</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">th</span><span class="p">.</span><span class="nf">join</span> <span class="c1"># outer thread waits here, holding 'running' lock</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.executor.wrap do
  th = Thread.new do
    Rails.application.executor.wrap do
      User # inner thread waits here; it cannot load
           # User while another thread is running
    end
  end

  th.join # outer thread waits here, holding 'running' lock
end
">Copy</button>
</div>
<p>To prevent this deadlock, the outer thread can <code>permit_concurrent_loads</code>. By
calling this method, the thread guarantees it will not dereference any
possibly-autoloaded constant inside the supplied block. The safest way to meet
that promise is to put it as close as possible to the blocking call:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
  <span class="n">th</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
      <span class="no">User</span> <span class="c1"># inner thread can acquire the 'load' lock,</span>
           <span class="c1"># load User, and continue</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">interlock</span><span class="p">.</span><span class="nf">permit_concurrent_loads</span> <span class="k">do</span>
    <span class="n">th</span><span class="p">.</span><span class="nf">join</span> <span class="c1"># outer thread waits here, but has no lock</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.executor.wrap do
  th = Thread.new do
    Rails.application.executor.wrap do
      User # inner thread can acquire the 'load' lock,
           # load User, and continue
    end
  end

  ActiveSupport::Dependencies.interlock.permit_concurrent_loads do
    th.join # outer thread waits here, but has no lock
  end
end
">Copy</button>
</div>
<p>Another example, using Concurrent Ruby:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
  <span class="n">futures</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="no">Concurrent</span><span class="o">::</span><span class="no">Promises</span><span class="p">.</span><span class="nf">future</span> <span class="k">do</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">executor</span><span class="p">.</span><span class="nf">wrap</span> <span class="k">do</span>
        <span class="c1"># do work here</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">values</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">interlock</span><span class="p">.</span><span class="nf">permit_concurrent_loads</span> <span class="k">do</span>
    <span class="n">futures</span><span class="p">.</span><span class="nf">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:value</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.executor.wrap do
  futures = 3.times.collect do |i|
    Concurrent::Promises.future do
      Rails.application.executor.wrap do
        # do work here
      end
    end
  end

  values = ActiveSupport::Dependencies.interlock.permit_concurrent_loads do
    futures.collect(&amp;:value)
  end
end
">Copy</button>
</div>
<h4 id="actiondispatch-debuglocks"><a class="anchorlink" href="#actiondispatch-debuglocks">5.2 ActionDispatch::DebugLocks</a></h4><p>If your application is deadlocking and you think the Load Interlock may be
involved, you can temporarily add the ActionDispatch::DebugLocks middleware to
<code>config/application.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Sendfile</span><span class="p">,</span>
                                  <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">DebugLocks</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.middleware.insert_before Rack::Sendfile,
                                  ActionDispatch::DebugLocks
">Copy</button>
</div>
<p>If you then restart the application and re-trigger the deadlock condition,
<code>/rails/locks</code> will show a summary of all threads currently known to the
interlock, which lock level they are holding or awaiting, and their current
backtrace.</p><p>Generally a deadlock will be caused by the interlock conflicting with some other
external lock or blocking I/O call. Once you find it, you can wrap it with
<code>permit_concurrent_loads</code>.</p>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua caso veja quaisquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">forum oficial do Ruby on Rails</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
