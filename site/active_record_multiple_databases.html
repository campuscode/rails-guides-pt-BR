<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Múltiplos bancos de dados com Active Record — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Múltiplos bancos de dados com Active Record — Ruby on Rails Guides" />
  <meta name="description" content="Múltiplos bancos de dados com Active RecordEste guia cobre o uso de múltiplos bancos de dados na sua aplicação Rails.Após ler este guia, você saberá: Como configurar sua aplicação para usar múltiplos bancos de dados. Como a troca automática de conexão funciona. Como usar fragmentação horizontal (horizontal sharding). Como migrar do legacy_connection_handling para o novo tratamento de conexão. Quais funcionalidades têm suporte e quais ainda estão sendo desenvolvidas." />
  <meta property="og:description" content="Múltiplos bancos de dados com Active RecordEste guia cobre o uso de múltiplos bancos de dados na sua aplicação Rails.Após ler este guia, você saberá: Como configurar sua aplicação para usar múltiplos bancos de dados. Como a troca automática de conexão funciona. Como usar fragmentação horizontal (horizontal sharding). Como migrar do legacy_connection_handling para o novo tratamento de conexão. Quais funcionalidades têm suporte e quais ainda estão sendo desenvolvidas." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                  <dd><a href="active_record_encryption.html">Active Record Encryption</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - ?</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</option>
                  <option value="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
                  <option value="active_record_encryption.html">Active Record Encryption</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_0_release_notes.html">Version 7.0 - ?</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Múltiplos bancos de dados com <em>Active Record</em></h2><p>Este guia cobre o uso de múltiplos bancos de dados na sua aplicação Rails.</p><p>Após ler este guia, você saberá:</p>
<ul>
<li>Como configurar sua aplicação para usar múltiplos bancos de dados.</li>
<li>Como a troca automática de conexão funciona.</li>
<li>Como usar fragmentação horizontal (<em>horizontal sharding</em>).</li>
<li>Como migrar do <code>legacy_connection_handling</code> para o novo tratamento de conexão.</li>
<li>Quais funcionalidades têm suporte e quais ainda estão sendo desenvolvidas.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#configurando-sua-aplicacao">Configurando sua aplicação</a></li>
<li><a href="#conectando-se-a-bancos-de-dados-sem-gerenciar-schema-e-migrations">Conectando-se a Bancos de Dados sem gerenciar <em>Schema</em> e <em>Migrations</em></a></li>
<li><a href="#generators-e-migrations"><em>Generators</em> e <em>Migrations</em></a></li>
<li><a href="#habilitando-a-troca-automatica-de-papel">Habilitando a troca automática de papel</a></li>
<li><a href="#usando-a-troca-de-conexao-manual">Usando a troca de conexão manual</a></li>
<li><a href="#horizontal-sharding">Horizontal sharding</a></li>
<li><a href="#activating-automatic-shard-switching">Activating automatic shard switching</a></li>
<li><a href="#migrate-to-the-new-connection-handling">Migrate to the new connection handling</a></li>
<li>
<a href="#alternando-conexao-de-banco-de-dados-granular">Alternando Conexão de Banco de Dados Granular</a>

<ul>
<li><a href="#manipulando-associacoes-com-join-entre-bancos-de-dados">Manipulando associações com <em>join</em> entre bancos de dados</a></li>
<li><a href="#cache-de-schema"><em>Cache</em> de <em>Schema</em></a></li>
</ul>
</li>
<li>
<a href="#caveats">Caveats</a>

<ul>
<li><a href="#load-balancing-replicas">Load Balancing Replicas</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <p>Conforme uma aplicação cresce em uso e popularidade, você precisará expandir a aplicação para dar suporte aos novos usuários e seus dados. Uma das dimensões na qual sua aplicação precisará expandir é no âmbito do banco de dados. O Rails agora possui suporte para múltiplos bancos de dados, para que você não precise armazenar tudo em um só lugar.</p><p>No presente momento, as seguintes funcionalidades são suportadas:</p>
<ul>
<li>Múltiplos bancos de dados de escrita, com réplicas</li>
<li>Troca automática de conexão para o <em>model</em> em questão</li>
<li>Troca automática entre o banco de escrita e sua réplica, dependendo do verbo HTTP e as escritas mais recentes</li>
<li>
<em>Tasks</em> do Rails para criar, deletar e interagir com os múltiplos bancos.</li>
</ul>
<p>As seguintes funcionalidades (ainda) não têm suporte:</p>
<ul>
<li>
<em>Load balancing</em> de réplicas</li>
</ul>
<h3 id="configurando-sua-aplicacao"><a class="anchorlink" href="#configurando-sua-aplicacao">1 Configurando sua aplicação</a></h3><p>O Rails tenta fazer a maior parte do trabalho para você, porém, mesmo assim, ainda existem alguns passos que você precisa seguir para preparar sua aplicação para múltiplos bancos de dados.</p><p>Digamos que nós temos uma aplicação com um único banco de escrita, e que precisamos adicionar um novo banco para algumas tabelas que estamos criando. O nome deste novo banco será "animals".</p><p>O arquivo <code>database.yml</code> ficará assim:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ROOT_PASSWORD'] %&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8ba05a3c6122476a5032f07822123fb5">production:
  database: my_primary_database
  adapter: mysql
  username: root
  password: &lt;%= ENV['ROOT_PASSWORD'] %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8ba05a3c6122476a5032f07822123fb5">Copiar</button>
</div>
<p>Vamos adicionar uma réplica para a primeira configuração e um segundo banco chamado "animals", também possuindo uma réplica. Para fazer isso, precisamos alterar o arquivo <code>database.yml</code>, com sua atual configuração de 2 níveis para uma nova configuração, de 3 níveis.</p><p>Se uma houver uma configuração primária, esta será usada como padrão. Se não existir uma configuração com o nome "primary", o Rails usará a primeira configuração que encontrar como padrão para cada ambiente. As configurações padrão usarão os nomes de arquivo padrão do Rails. Por exemplo, configurações primárias usarão o arquivo <code>schema.rb</code> para o esquema, enquanto todas as outras configurações usarão <code>[CONFIGURATION_NAMESPACE]_schema.rb</code>.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ROOT_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">primary_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">root_readonly</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ROOT_READONLY_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">animals</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">animals_root</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ANIMALS_ROOT_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">migrations_paths</span><span class="pi">:</span> <span class="s">db/animals_migrate</span>
  <span class="na">animals_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">animals_readonly</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ANIMALS_READONLY_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cc4fc169883a793a6ab17553e5e23626">production:
  primary:
    database: my_primary_database
    username: root
    password: &lt;%= ENV['ROOT_PASSWORD'] %&gt;
    adapter: mysql2
  primary_replica:
    database: my_primary_database
    username: root_readonly
    password: &lt;%= ENV['ROOT_READONLY_PASSWORD'] %&gt;
    adapter: mysql2
    replica: true
  animals:
    database: my_animals_database
    username: animals_root
    password: &lt;%= ENV['ANIMALS_ROOT_PASSWORD'] %&gt;
    adapter: mysql2
    migrations_paths: db/animals_migrate
  animals_replica:
    database: my_animals_database
    username: animals_readonly
    password: &lt;%= ENV['ANIMALS_READONLY_PASSWORD'] %&gt;
    adapter: mysql2
    replica: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cc4fc169883a793a6ab17553e5e23626">Copiar</button>
</div>
<p>Quando usar múltiplos bancos, existem algumas configurações importantes.</p><p>Em primeiro lugar, o nome do banco para a configuração <code>primary</code> e <code>primary_replica</code> precisam ser os mesmos, pois estes contém os mesmos dados. Isso também se aplica para os bancos <code>animals</code> e <code>animals_replica</code>.</p><p>Segundo, o nome de usuário para os bancos de escrita e suas réplicas devem ser diferentes, e as permissões do usuário da réplica devem ser somente leitura.</p><p>Quando usar um banco réplica, é preciso adicionar <code>replica: true</code> à configuração em questão, dentro de <code>database.yml</code>. Sem isso, o Rails não saberá qual é o de escrita e qual é a réplica. O Rails também não executará determinadas tarefas, como migrações, em réplicas.</p><p>Por último, para os novos bancos de escrita, é preciso adicionar o <code>migrations_paths</code> ao diretório onde ficarão as migrações. Veremos <code>migration_paths</code> em mais detalhes ao decorrer deste guia.</p><p>Agora que temos um novo banco, vamos definir o <em>model</em> de conexão. Para usar este novo banco, é necessário criar uma classe abstrata e conectar ao banco <em>animals</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AnimalsRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :animals</span><span class="p">,</span> <span class="ss">reading: :animals_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-88584ae6ed1d5d449eb76301e25ab21c">class AnimalsRecord &lt; ApplicationRecord
  self.abstract_class = true

  connects_to database: { writing: :animals, reading: :animals_replica }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-88584ae6ed1d5d449eb76301e25ab21c">Copiar</button>
</div>
<p>Em seguida, atualizaremos <code>ApplicationRecord</code> para ela saiba da nossa nova réplica.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6b1b8fe38e9621563f5fdd89c1ede7ed">class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true

  connects_to database: { writing: :primary, reading: :primary_replica }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6b1b8fe38e9621563f5fdd89c1ede7ed">Copiar</button>
</div>
<p>Se você usar uma classe com nome diferente para o registro da aplicação, precisará
definir <code>primary_abstract_class</code>, para que o Rails saiba qual classe <code>ActiveRecord::Base</code>
deve compartilhar uma conexão com.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PrimaryApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_abstract_class</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-536e6f96814c523d560d25257bf2df57">class PrimaryApplicationRecord &lt; ActiveRecord::Base
  self.primary_abstract_class
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-536e6f96814c523d560d25257bf2df57">Copiar</button>
</div>
<p>As classes que se conectam a primary/primary_replica podem herdar de da classe primária
como aplicações Rails padrão:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bb8ce3524770d6f60da4e2774d6d142b">class Person &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb8ce3524770d6f60da4e2774d6d142b">Copiar</button>
</div>
<p>Por padrão, o Rails espera os <em>roles</em> de escrita e leitura, para o banco primário e sua réplica, respectivamente. Se você tiver um sistema legado, é possível que existam <em>roles</em> que não deseja mudar. Neste caso, é possível definir um novo nome de <em>role</em> nas configurações da aplicação.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">writing_role</span> <span class="o">=</span> <span class="ss">:default</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">reading_role</span> <span class="o">=</span> <span class="ss">:readonly</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1079b66df0b0d971651d2b79a594bc09">config.active_record.writing_role = :default
config.active_record.reading_role = :readonly
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1079b66df0b0d971651d2b79a594bc09">Copiar</button>
</div>
<p>É importante conectar ao seu banco em um único <em>model</em> e em seguida, herdar para as tabelas, ao invés de abrir várias conexões individuais.
Os usuários do banco têm um limite de conexões abertas, e ao fazer isso, estaríamos multiplicando o número de conexões, visto que o Rails usa o nome da classe do <em>model</em> para o nome da conexão. </p><p>Agora que configuramos o <code>database.yml</code> e novo <em>model</em>, é hora de criar os bancos de dados.
O Rails 6.0 inclui todas as <em>tasks</em> necessárias para usar múltiplos bancos.</p><p>É possível ver todos os comandos disponíveis usando <code>bin/rails -T</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails</span> <span class="nt">-T</span>
<span class="gp">rails db:create                          #</span><span class="w"> </span>Cria o banco a partir da DATABASE_URL ou config/database.yml para o ambiente atual
<span class="gp">rails db:create:animals                  #</span><span class="w"> </span>Cria o banco animals para o ambiente atual
<span class="gp">rails db:create:primary                  #</span><span class="w"> </span>Cria o banco primário para o ambiente atual
<span class="gp">rails db:drop                            #</span><span class="w"> </span>Destrói o banco a partir da DATABASE_URL ou config/database.yml para o ambiente atual
<span class="gp">rails db:drop:animals                    #</span><span class="w"> </span>Destrói o banco animals para o ambiente atual
<span class="gp">rails db:drop:primary                    #</span><span class="w"> </span>Destrói o banco primário para o ambiente atual
<span class="gp">rails db:migrate                         #</span><span class="w"> </span>Migra o banco <span class="o">(</span>as opções são: <span class="nv">VERSION</span><span class="o">=</span>x, <span class="nv">VERBOSE</span><span class="o">=</span><span class="nb">false</span>, <span class="nv">SCOPE</span><span class="o">=</span>blog<span class="o">)</span>
<span class="gp">rails db:migrate:animals                 #</span><span class="w"> </span>Migra o banco animals para o ambiente atual
<span class="gp">rails db:migrate:primary                 #</span><span class="w"> </span>Migra o banco primário para o ambiente atual
<span class="gp">rails db:migrate:status                  #</span><span class="w"> </span>Exibe o status das migrações
<span class="gp">rails db:migrate:status:animals          #</span><span class="w"> </span>Exibe o status das migrações para o banco animals
<span class="gp">rails db:migrate:status:primary          #</span><span class="w"> </span>Exibe o status das migrações para o banco primário
<span class="gp">rails db:reset                           #</span><span class="w"> </span>Elimina e recria todos os bancos de dados com seu esquema para o ambiente atual e carrega as seeds
<span class="gp">rails db:reset:animals                   #</span><span class="w"> </span>Descarta e recria o banco de dados de animais com seu esquema para o ambiente atual e carrega as seeds
<span class="gp">rails db:reset:primary                   #</span><span class="w"> </span>Descarta e recria o banco de dados primário com seu esquema para o ambiente atual e carrega as seeds
<span class="gp">rails db:rollback                        #</span><span class="w"> </span>Reverte o esquema para uma versão anterior, no ambiente atual <span class="o">(</span>especifique o número de versões com <span class="nv">STEP</span><span class="o">=</span>n<span class="o">)</span>
<span class="gp">rails db:rollback:animals                #</span><span class="w"> </span>Reverte o esquema <span class="k">do </span>banco animals para uma versão anterior, no ambiente atual <span class="o">(</span>especifique o número de versões com <span class="nv">STEP</span><span class="o">=</span>n<span class="o">)</span>
<span class="gp">rails db:rollback:primary                #</span><span class="w"> </span>Reverte o esquema <span class="k">do </span>banco primário para uma versão anterior, no ambiente atual <span class="o">(</span>especifique o número de versões com <span class="nv">STEP</span><span class="o">=</span>n<span class="o">)</span>
<span class="gp">rails db:schema:dump                     #</span><span class="w"> </span>Cria um arquivo de esquema <span class="o">(</span>db/schema.rb ou db/structure.sql<span class="o">)</span>
<span class="gp">rails db:schema:dump:animals             #</span><span class="w"> </span>Cria um arquivo de esquema para o banco animals <span class="o">(</span>db/schema.rb ou db/structure.sql<span class="o">)</span>
<span class="gp">rails db:schema:dump:primary             #</span><span class="w"> </span>Cria o arquivo db/schema.rb que será poderá ser carregado para qualquer banco suportado
<span class="gp">rails db:schema:load                     #</span><span class="w"> </span>Importa um arquivo de esquema <span class="o">(</span>db/schema.rb ou db/structure.sql<span class="o">)</span>
<span class="gp">rails db:schema:load:animals             #</span><span class="w"> </span>Importa um arquivo de esquema <span class="o">(</span>db/schema.rb ou db/structure.sql<span class="o">)</span>
<span class="gp">rails db:schema:load:primary             #</span><span class="w"> </span>Importa um arquivo de esquema <span class="o">(</span>db/schema.rb ou db/structure.sql<span class="o">)</span>
<span class="gp">rails db:setup                           #</span><span class="w"> </span>Cria todos os bancos de dados, carrega todos com os esquemas e inicializa com os dados de seeds <span class="o">(</span>use db:reset para também descartar todos os bancos de dados primeiro<span class="o">)</span>
<span class="gp">rails db:setup:animals                   #</span><span class="w"> </span>Cria o banco de dados de animais, carrega o esquema e inicializa com os dados de seeds <span class="o">(</span>use db:reset:animals para também descartar o banco de dados primeiro<span class="o">)</span>
<span class="gp">rails db:setup:primary                   #</span><span class="w"> </span>Cria o banco de dados primário, carrega o esquema e inicializa com os dados de seeds <span class="o">(</span>use db:reset:primary para também descartar o banco de dados primeiro<span class="o">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-19bbf157b53634702281e29d440dc039">bin/rails -T
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-19bbf157b53634702281e29d440dc039">Copiar</button>
</div>
<p>Executar um comando como <code>bin/rails db:create</code> criará tanto o banco primário quanto o banco <em>animals</em>.
Observe que não existe um comando para criar os usuários do banco de dados. Estes precisam ser criados manualmente, para dar suporte aos usuários somente leitura das réplicas. Se deseja criar somente o banco <em>animals</em>, basta executar <code>bin/rails db:create:animals</code>.</p><h3 id="conectando-se-a-bancos-de-dados-sem-gerenciar-schema-e-migrations"><a class="anchorlink" href="#conectando-se-a-bancos-de-dados-sem-gerenciar-schema-e-migrations">2 Conectando-se a Bancos de Dados sem gerenciar <em>Schema</em> e <em>Migrations</em></a></h3><p>Se você gostaria de se conectar a um banco de dados externo sem nenhum gerenciamento de banco de dados
usando os comandos, como gerenciamento de <em>schema</em>, <em>migrations</em>, <em>seeds</em>, etc., você pode definir
a opção de configuração do banco de dados <code>database_tasks: false</code>. Por padrão ela é
definida como verdadeira.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">animals</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">database_tasks</span><span class="pi">:</span> <span class="no">false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4b90f4acd35cc5358621d0d8af139f89">production:
  primary:
    database: my_database
    adapter: mysql2
  animals:
    database: my_animals_database
    adapter: mysql2
    database_tasks: false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4b90f4acd35cc5358621d0d8af139f89">Copiar</button>
</div>
<h3 id="generators-e-migrations"><a class="anchorlink" href="#generators-e-migrations">3 <em>Generators</em> e <em>Migrations</em></a></h3><p>Migrações para múltiplos bancos devem ficar nos seus próprios diretórios, prefixados pelo nome da chave do banco especificado nas configurações.</p><p>Também é preciso definir <code>migrations_paths</code> nas configurações do banco, para que o Rails saiba onde as encontrar.</p><p>Por exemplo, o banco <em>animals</em> buscaria suas migrações no diretório <code>db/animals_migrate</code>, da mesma forma que o banco <em>primary</em> buscaria em <code>db/migrate</code>. Os <em>generators</em> do Rails agora permitem especificar a opção <code>--database</code>, de modo que o arquivo seja gerado no diretório correto. O comando pode ser executado da seguinte forma:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration CreateDogs name:string <span class="nt">--database</span> animals
</code></pre>
<textarea class="clipboard-content" id="clipboard-afd3a58b562ff12bf027b41cc649146e">bin/rails generate migration CreateDogs name:string --database animals
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-afd3a58b562ff12bf027b41cc649146e">Copiar</button>
</div>
<p>Se estiver usando os <em>generators</em> do Rails, os <em>generators</em> de <em>scaffold</em> e de <em>model</em> criarão a classe abstrata para você. Basta especificar a chave do banco no comando.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate scaffold Dog name:string <span class="nt">--database</span> animals
</code></pre>
<textarea class="clipboard-content" id="clipboard-65affba76890e2a6293e3a8df816a887">bin/rails generate scaffold Dog name:string --database animals
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-65affba76890e2a6293e3a8df816a887">Copiar</button>
</div>
<p>Uma classe com mesmo nome do banco e a palavra <code>Record</code> será criada. Neste exemplo, o banco é <code>Animals</code>, então teremos <code>AnimalsRecord</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AnimalsRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :animals</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9e1c322e1fabc71ae0e06754263f4ae5">class AnimalsRecord &lt; ApplicationRecord
  self.abstract_class = true

  connects_to database: { writing: :animals }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9e1c322e1fabc71ae0e06754263f4ae5">Copiar</button>
</div>
<p>O <em>model</em> gerado herdará automaticamente de <code>AnimalsRecord</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Dog</span> <span class="o">&lt;</span> <span class="no">AnimalsRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-facca918f7664d4613b24aaa4459432e">class Dog &lt; AnimalsRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-facca918f7664d4613b24aaa4459432e">Copiar</button>
</div>
<p>Note: Visto que o Rails não sabe qual banco de dados é a réplica para o escritor, você precisará adicionar isso à classe abstrata quando tiver terminado.</p><p>O Rails criará a nova classe somente uma vez. Esta não será sobrescrita por futuros <em>scaffolds</em> e nem mesmo deletada, caso o <em>scaffold</em> seja excluído.</p><p>Se você já possui uma classe abstrata e seu nome difere da em <code>AnimalsRecord</code>, você pode especificar a opção <code>--parent</code> se desejar uma classe abstrata diferente:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate scaffold Dog name:string <span class="nt">--database</span> animals <span class="nt">--parent</span> Animals::Record
</code></pre>
<textarea class="clipboard-content" id="clipboard-fb5436f09a605f2f021ceee7c3ef56f1">bin/rails generate scaffold Dog name:string --database animals --parent Animals::Record
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fb5436f09a605f2f021ceee7c3ef56f1">Copiar</button>
</div>
<p>Isto fará com que a geração de <code>AnimalsRecord</code> seja ignorada, visto que você indicou para o Rails que irá usar uma outra classe pai.</p><h3 id="habilitando-a-troca-automatica-de-papel"><a class="anchorlink" href="#habilitando-a-troca-automatica-de-papel">4 Habilitando a troca automática de papel</a></h3><p>Por último, para conseguir usar a réplica de leitura na sua aplicação, será necessário habilitar o <em>middleware</em> de troca automática.</p><p>A troca automática permite que a aplicação alterne entre os bancos de escrita e a réplica, baseado no método HTTP e também se houve uma escrita recente pela requisição do usuário.</p><p>Se a aplicação receber uma requisição POST, PUT, DELETE, ou PATCH, a conexão será feita automaticamente para o banco de escrita. Por um determinado tempo após a escrita, a leitura será feita no banco primário. Para os métodos GET ou HEAD, a aplicação usará a réplica, a menos que tenha ocorrido uma escrita recente.</p><p>Para ativar o <em>middleware</em> de troca automática de conexão, você pode executar o gerados de troca automática:</p><div class="code_container">
<pre><code class="highlight plaintext">$ bin/rails g active_record:multi_db
</code></pre>
<textarea class="clipboard-content" id="clipboard-99528760a05e55b0d8dee697df5ef597">$ bin/rails g active_record:multi_db
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-99528760a05e55b0d8dee697df5ef597">Copiar</button>
</div>
<p>E então descomentar as seguintes linhas:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span><span class="o">::</span><span class="no">Session</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0ba68895b2a7cb93dc4e849141fb4af5">Rails.application.configure do
  config.active_record.database_selector = { delay: 2.seconds }
  config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
  config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0ba68895b2a7cb93dc4e849141fb4af5">Copiar</button>
</div>
<p>O Rails garante o chamado "leia sua própria escrita" e encaminhará as requisições de método GET ou HEAD para o banco de escrita, se estes ocorrerem dentro do intervalo especificado pelo <code>delay</code>. Você deve alterar esta configuração para melhor atender a infraestrutura do seu banco de dados. O Rails não garante "leia sua escrita recente" para outros usuários dentro do intervalo de <em>delay</em>, e encaminhará as requisições GET e HEAD para a réplica, a menos que eles tenham escrito algo recentemente.</p><p>A troca automática de conexão do Rails é relativamente simples e deliberadamente não faz muita coisa. O objetivo é ter um sistema que demonstre como fazer a troca automática de conexão, e que seja suficientemente flexível para que as pessoas desenvolvedoras possam customizar.</p><p>O <em>setup</em> do Rails permite que você altere com facilidade como é feita a troca automática, e em quais parâmetros ela se baseia. Digamos que você queira usar <em>cookies</em> ao invés da <em>session</em> para decidir quando trocar as conexões. Você poderia escrever sua própria classe:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyCookieResolver</span>
  <span class="c1"># código da sua classe</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-911e26c289b6fe4b532121ff900b7b86">class MyCookieResolver
  # código da sua classe
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-911e26c289b6fe4b532121ff900b7b86">Copiar</button>
</div>
<p>Em seguida, especifique sua nova classe no <em>middleware</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">MyCookieResolver</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cb8f44e378a6db29c7b8175b9d1f073b">config.active_record.database_selector = { delay: 2.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = MyCookieResolver
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cb8f44e378a6db29c7b8175b9d1f073b">Copiar</button>
</div>
<h3 id="usando-a-troca-de-conexao-manual"><a class="anchorlink" href="#usando-a-troca-de-conexao-manual">5 Usando a troca de conexão manual</a></h3><p>Existem casos nos quais você pode querer que sua aplicação se conecte ao banco de escrita ou à réplica, e onde a troca automática de conexão não será adequada. Por exemplo, suponhamos que exista uma requisição em particular que sempre deverá ser encaminhada para a réplica, mesmo que tenha método POST.</p><p>Para isso, o Rails possui um método chamado <code>connected_to</code>, que trocará para a conexão desejada.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># o código deste bloco estará conectado ao role 'reading'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2a7cc5c88fea436a2ae3bd53e0e073de">ActiveRecord::Base.connected_to(role: :reading) do
  # o código deste bloco estará conectado ao role 'reading'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2a7cc5c88fea436a2ae3bd53e0e073de">Copiar</button>
</div>
<p>O <em>role</em> definido em <code>connected_to</code> buscará as conexões ligadas naquele determinado <em>handler</em> (ou <em>role</em>). O <em>handler</em> da conexão <code>reading</code> receberá todas as conexões feitas através do <code>connects_to</code>, que tenham o <em>role</em> <code>reading</code>.</p><p>Observe que o <code>connected_to</code> com um <em>role</em> definido buscará e trocará para uma conexão existente, usando o nome da conexão. Isso quer dizer que ao passar um <em>role</em> desconhecido ou inválido, como por exemplo, <code>connected_to(role: :nonexistent)</code>, causará um erro com a seguinte mensagem: <code>ActiveRecord::ConnectionNotEstablished (No connection pool for 'ActiveRecord::Base' found for the 'nonexistent' role.)</code></p><p>Se você quiser que o Rails garanta que todas as consultas executadas sejam somente leitura, passe <code>prevent_writes: true</code>.
Isso apenas impede que consultas que pareçam gravações sejam enviadas ao banco de dados.
Você também deve configurar seu banco de dados de réplica para ser executado no modo somente leitura.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">prevent_writes: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># O Rails irá checar cada query para garantir que é uma query de leitura</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-43228359f62c2aa1d91a6ff328c0fae8">ActiveRecord::Base.connected_to(role: :reading, prevent_writes: true) do
  # O Rails irá checar cada query para garantir que é uma query de leitura
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-43228359f62c2aa1d91a6ff328c0fae8">Copiar</button>
</div>
<h3 id="horizontal-sharding"><a class="anchorlink" href="#horizontal-sharding">6 Horizontal sharding</a></h3><p>Fragmentação horizontal é quando você divide seu banco de dados para reduzir o número de linhas em cada
servidor de banco de dados, mas mantém o mesmo esquema em "fragmentos". Isso é comumente chamado de fragmentação "multilocatário" (<em>multi-tenant</em>).</p><p>A API para suportar fragmentação horizontal no Rails é semelhante ao banco de dados múltiplo / 
API de vertical fragmentação que existe desde o Rails 6.0.</p><p>Os fragmentos são declarados na configuração de três camadas como este:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">primary_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">primary_shard_one</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_one</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">primary_shard_one_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_one</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-832b3dab573259752133d6d35df4ff1a">production:
  primary:
    database: my_primary_database
    adapter: mysql2
  primary_replica:
    database: my_primary_database
    adapter: mysql2
    replica: true
  primary_shard_one:
    database: my_primary_shard_one
    adapter: mysql2
  primary_shard_one_replica:
    database: my_primary_shard_one
    adapter: mysql2
    replica: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-832b3dab573259752133d6d35df4ff1a">Copiar</button>
</div>
<p>Os <em>models</em> são então conectados à API <code>connects_to</code> por meio da chave<code>shards</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">shards: </span><span class="p">{</span>
    <span class="ss">default: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">},</span>
    <span class="ss">shard_one: </span><span class="p">{</span> <span class="ss">writing: :primary_shard_one</span><span class="p">,</span> <span class="ss">reading: :primary_shard_one_replica</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b7a83a5f50a450fce0d4ef27d7c59607">class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true

  connects_to shards: {
    default: { writing: :primary, reading: :primary_replica },
    shard_one: { writing: :primary_shard_one, reading: :primary_shard_one_replica }
  }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b7a83a5f50a450fce0d4ef27d7c59607">Copiar</button>
</div>
<p>Então, os <em>models</em> podem trocar conexões manualmente por meio da API <code>connected_to</code>. Se
usando o <em>sharding</em>, um <code>role</code> e um<code>shard</code> devem ser passados:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">,</span> <span class="ss">shard: :default</span><span class="p">)</span> <span class="k">do</span>
  <span class="vi">@id</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create!</span> <span class="c1"># Cria um registro no fragmento padrão</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@id</span><span class="p">)</span> <span class="c1"># Não é possível encontrar o registro, não existe porque foi criado</span>
                   <span class="c1"># no fragmento padrão</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9c5c99529e326e2638f0cc8a79a2bc29">ActiveRecord::Base.connected_to(role: :writing, shard: :default) do
  @id = Person.create! # Cria um registro no fragmento padrão
end

ActiveRecord::Base.connected_to(role: :writing, shard: :shard_one) do
  Person.find(@id) # Não é possível encontrar o registro, não existe porque foi criado
                   # no fragmento padrão
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9c5c99529e326e2638f0cc8a79a2bc29">Copiar</button>
</div>
<p>A API de fragmentação horizontal também oferece suporte a réplicas de leitura. Você pode trocar o
papel (<em>role</em>) e o fragmento (<em>shard</em>) com a API <code>connected_to</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Procura um registro de uma réplica de leitura do shard_one</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7cb258fb17bc8c4e2d5688d0fa8413fe">ActiveRecord::Base.connected_to(role: :reading, shard: :shard_one) do
  Person.first # Procura um registro de uma réplica de leitura do shard_one
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7cb258fb17bc8c4e2d5688d0fa8413fe">Copiar</button>
</div>
<h3 id="activating-automatic-shard-switching"><a class="anchorlink" href="#activating-automatic-shard-switching">7 Activating automatic shard switching</a></h3><p>Applications are able to automatically switch shards per request using the provided
middleware.</p><p>The ShardSelector Middleware provides a framework for automatically
swapping shards. Rails provides a basic framework to determine which
shard to switch to and allows for applications to write custom strategies
for swapping if needed.</p><p>The ShardSelector takes a set of options (currently only <code>lock</code> is supported)
that can be used by the middleware to alter behavior. <code>lock</code> is
true by default and will prohibit the request from switching shards once
inside the block. If <code>lock</code> is false, then shard swapping will be allowed.
For tenant based sharding, <code>lock</code> should always be true to prevent application
code from mistakenly switching between tenants.</p><p>The same generator as the database selector can be used to generate the file for
automatic shard swapping:</p><div class="code_container">
<pre><code class="highlight plaintext">$ bin/rails g active_record:multi_db
</code></pre>
<textarea class="clipboard-content" id="clipboard-7e17713fd713ac3e224dbf8546cc7e21">$ bin/rails g active_record:multi_db
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7e17713fd713ac3e224dbf8546cc7e21">Copiar</button>
</div>
<p>Then in the file uncomment the following:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">shard_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">lock: </span><span class="kp">true</span> <span class="p">}</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">shard_resolver</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="no">Tenant</span><span class="p">.</span><span class="nf">find_by!</span><span class="p">(</span><span class="ss">host: </span><span class="n">request</span><span class="p">.</span><span class="nf">host</span><span class="p">).</span><span class="nf">shard</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0db68d7f24a5f81513f0b6fb09a5d9f4">Rails.application.configure do
  config.active_record.shard_selector = { lock: true }
  config.active_record.shard_resolver = -&gt;(request) { Tenant.find_by!(host: request.host).shard }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0db68d7f24a5f81513f0b6fb09a5d9f4">Copiar</button>
</div>
<p>Applications must provide the code for the resolver as it depends on application
specific models. An example resolver would look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">shard_resolver</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">subdomain</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">subdomain</span>
  <span class="n">tenant</span> <span class="o">=</span> <span class="no">Tenant</span><span class="p">.</span><span class="nf">find_by_subdomain!</span><span class="p">(</span><span class="n">subdomain</span><span class="p">)</span>
  <span class="n">tenant</span><span class="p">.</span><span class="nf">shard</span>
<span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9dc7d1fd77a8eea9ea337b723a80b155">config.active_record.shard_resolver = -&gt;(request) {
  subdomain = request.subdomain
  tenant = Tenant.find_by_subdomain!(subdomain)
  tenant.shard
}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9dc7d1fd77a8eea9ea337b723a80b155">Copiar</button>
</div>
<h3 id="migrate-to-the-new-connection-handling"><a class="anchorlink" href="#migrate-to-the-new-connection-handling">8 Migrate to the new connection handling</a></h3><p>In Rails 6.1+, Active Record provides a new internal API for connection management.
In most cases applications will not need to make any changes except to opt-in to the
new behavior (if upgrading from 6.0 and below) by setting
<code>config.active_record.legacy_connection_handling = false</code>. If you have a single database
application, no other changes will be required. If you have a multiple database application
the following changes are required if your application is using these methods:</p>
<ul>
<li>
<code>connection_handlers</code> and <code>connection_handlers=</code> no longer works in the new connection
handling. If you were calling a method on one of the connection handlers, for example,
<code>connection_handlers[:reading].retrieve_connection_pool("ActiveRecord::Base")</code>
you will now need to update that call to be
<code>connection_handlers.retrieve_connection_pool("ActiveRecord::Base", role: :reading)</code>.</li>
<li>Calls to <code>ActiveRecord::Base.connection_handler.prevent_writes</code> will need to be updated
to <code>ActiveRecord::Base.connection.preventing_writes?</code>.</li>
<li>If you need all the pools, including writing and reading, a new method has been provided on
the handler. Call <code>connection_handler.all_connection_pools</code> to use this. In most cases though
you'll want writing or reading pools with <code>connection_handler.connection_pool_list(:writing)</code> or
<code>connection_handler.connection_pool_list(:reading)</code>.</li>
<li>If you turn off <code>legacy_connection_handling</code> in your application, any method that's unsupported
will raise an error (i.e. <code>connection_handlers=</code>).</li>
</ul>
<h3 id="alternando-conexao-de-banco-de-dados-granular"><a class="anchorlink" href="#alternando-conexao-de-banco-de-dados-granular">9 Alternando Conexão de Banco de Dados Granular</a></h3><p>No Rails 6.1 é possível alternar conexões para um banco de dados ao invés de
todos os bancos de dados globalmente. Para usar este recurso, você deve primeiro definir
<code>config.active_record.legacy_connection_handling</code> para<code>false</code> nas configurações da sua
aplicação. A maioria das aplicações não precisam fazer nenhuma outra
alteração, uma vez que as APIs públicas têm o mesmo comportamento. Consulte a seção acima para
como habilitar e migrar do <code>legacy_connection_handling</code>.</p><p>Com <code>legacy_connection_handling</code> definido como <code>false</code>, qualquer classe de conexão abstrata
será capaz de alternar as conexões sem afetar outras conexões. Esse
é útil para mudar suas consultas <code>AnimalsRecord</code> para ler a partir da réplica
enquanto garante que suas consultas <code>ApplicationRecord</code> vão para o primário.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">AnimalsRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from animals_replica</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span>  <span class="c1"># Reads from primary</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-47a6a8b092ce1b87d5e0acde641982af">AnimalsRecord.connected_to(role: :reading) do
  Dog.first # Reads from animals_replica
  Person.first  # Reads from primary
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-47a6a8b092ce1b87d5e0acde641982af">Copiar</button>
</div>
<p>Também é possível trocar conexões granularmente por fragmentos.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">AnimalsRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Will read from shard_one_replica. If no connection exists for shard_one_replica,</span>
  <span class="c1"># a ConnectionNotEstablished error will be raised</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Will read from primary writer</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c3e8e9d203b9f10863d3899c766f5bd3">AnimalsRecord.connected_to(role: :reading, shard: :shard_one) do
  Dog.first # Will read from shard_one_replica. If no connection exists for shard_one_replica,
  # a ConnectionNotEstablished error will be raised
  Person.first # Will read from primary writer
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c3e8e9d203b9f10863d3899c766f5bd3">Copiar</button>
</div>
<p>Para mudar apenas o <a href="https://pt.wikipedia.org/wiki/Cluster"><em>cluster</em></a> de banco de dados primário, use <code>ApplicationRecord</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from primary_shard_one_replica</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from animals_primary</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-41c4f632b3678f1d28f5344ba01d25d6">ApplicationRecord.connected_to(role: :reading, shard: :shard_one) do
  Person.first # Reads from primary_shard_one_replica
  Dog.first # Reads from animals_primary
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-41c4f632b3678f1d28f5344ba01d25d6">Copiar</button>
</div>
<p><code>ActiveRecord::Base.connected_to</code> mantém a capacidade de alternar
conexões globalmente.</p><h4 id="manipulando-associacoes-com-join-entre-bancos-de-dados"><a class="anchorlink" href="#manipulando-associacoes-com-join-entre-bancos-de-dados">9.1 Manipulando associações com <em>join</em> entre bancos de dados</a></h4><p>A partir do Rails 7.0+, o Active Record tem uma opção para manipular associações que realizariam
um <em>join</em> em vários bancos de dados. Se você tem um <em>has many through</em> ou uma associação <em>has one through</em>
que você deseja desabilitar o <em>join</em> e realizar 2 ou mais consultas, passe a opção <code>disable_joins: true</code>.</p><p>Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Dog</span> <span class="o">&lt;</span> <span class="no">AnimalsRecord</span>
  <span class="n">has_many</span> <span class="ss">:treats</span><span class="p">,</span> <span class="ss">through: :humans</span><span class="p">,</span> <span class="ss">disable_joins: </span><span class="kp">true</span>
  <span class="n">has_many</span> <span class="ss">:humans</span>

  <span class="n">has_one</span> <span class="ss">:home</span>
  <span class="n">has_one</span> <span class="ss">:yard</span><span class="p">,</span> <span class="ss">through: :home</span><span class="p">,</span> <span class="ss">disable_joins: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Home</span>
  <span class="n">belongs_to</span> <span class="ss">:dog</span>
  <span class="n">has_one</span> <span class="ss">:yard</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Yard</span>
  <span class="n">belongs_to</span> <span class="ss">:home</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-43ae3517a8218bccf2781492a031c7b4">class Dog &lt; AnimalsRecord
  has_many :treats, through: :humans, disable_joins: true
  has_many :humans

  has_one :home
  has_one :yard, through: :home, disable_joins: true
end

class Home
  belongs_to :dog
  has_one :yard
end

class Yard
  belongs_to :home
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-43ae3517a8218bccf2781492a031c7b4">Copiar</button>
</div>
<p>Anteriormente chamando <code>@dog.treats</code> sem <code>disable_joins</code> ou <code>@dog.yard</code> sem <code>disable_joins</code>
geraria um erro porque os bancos de dados não conseguem lidar com <em>joins</em> entre <em>clusters</em>. Com o
opção <code>disable_joins</code>, Rails irá gerar múltiplas consultas de seleção
para evitar a tentativa de <em>join</em> entre <em>clusters</em>. Para a associação acima, <code>@dog.treats</code> geraria o
seguinte SQL:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"humans"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">FROM</span> <span class="nv">"humans"</span> <span class="k">WHERE</span> <span class="nv">"humans"</span><span class="p">.</span><span class="nv">"dog_id"</span> <span class="o">=</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"dog_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">SELECT</span> <span class="nv">"treats"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"treats"</span> <span class="k">WHERE</span> <span class="nv">"treats"</span><span class="p">.</span><span class="nv">"human_id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>  <span class="p">[[</span><span class="nv">"human_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="nv">"human_id"</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="nv">"human_id"</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f4c0e649b29aeacbaa3927f1da13c1ca">SELECT "humans"."id" FROM "humans" WHERE "humans"."dog_id" = ?  [["dog_id", 1]]
SELECT "treats".* FROM "treats" WHERE "treats"."human_id" IN (?, ?, ?)  [["human_id", 1], ["human_id", 2], ["human_id", 3]]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f4c0e649b29aeacbaa3927f1da13c1ca">Copiar</button>
</div>
<p>Enquanto <code>@dog.yard</code> geraria o seguinte SQL:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"home"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">FROM</span> <span class="nv">"homes"</span> <span class="k">WHERE</span> <span class="nv">"homes"</span><span class="p">.</span><span class="nv">"dog_id"</span> <span class="o">=</span> <span class="o">?</span> <span class="p">[[</span><span class="nv">"dog_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">SELECT</span> <span class="nv">"yards"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"yards"</span> <span class="k">WHERE</span> <span class="nv">"yards"</span><span class="p">.</span><span class="nv">"home_id"</span> <span class="o">=</span> <span class="o">?</span> <span class="p">[[</span><span class="nv">"home_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c2999e8b236ee758000c3fd79f2a8832">SELECT "home"."id" FROM "homes" WHERE "homes"."dog_id" = ? [["dog_id", 1]]
SELECT "yards".* FROM "yards" WHERE "yards"."home_id" = ? [["home_id", 1]]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c2999e8b236ee758000c3fd79f2a8832">Copiar</button>
</div>
<p>Há algumas coisas importantes a serem observadas com esta opção:</p><p>1) Pode haver implicações de desempenho, pois agora duas ou mais consultas serão executadas (dependendo
na associação) em vez de um <em>join</em>. Se a seleção de <code>humans</code> retornou um grande número de IDs
o select for <code>treats</code> pode enviar muitos IDs.
2) Como não estamos mais realizando <em>join</em>, uma consulta com uma ordem ou limite agora é classificada na memória, pois
ordem de uma tabela não pode ser aplicada a outra tabela.
3) Essa configuração deve ser adicionada a todas as associações nas quais você deseja que a participação seja desabilitada.
O Rails não pode adivinhar isso para você porque o carregamento de associação é <em>lazy</em>, para carregar <code>treats</code> em <code>@dog.treats</code>
o Rails já precisa saber qual SQL deve ser gerado.</p><h4 id="cache-de-schema"><a class="anchorlink" href="#cache-de-schema">9.2 <em>Cache</em> de <em>Schema</em></a></h4><p>Se você quiser carregar um <em>cache</em> de <em>schema</em> para cada banco de dados, você deve definir um <code>schema_cache_path</code> em cada configuração de banco de dados e definir <code>config.active_record.lazily_load_schema_cache = true</code> na configuração de sua aplicação. Observe que isso carregará o <em>cache</em> lentamente quando as conexões do banco de dados forem estabelecidas.</p><h3 id="caveats"><a class="anchorlink" href="#caveats">10 Caveats</a></h3><h4 id="load-balancing-replicas"><a class="anchorlink" href="#load-balancing-replicas">10.1 Load Balancing Replicas</a></h4><p>Rails also doesn't support automatic load balancing of replicas. This is very
dependent on your infrastructure. We may implement basic, primitive load balancing
in the future, but for an application at scale this should be something your application
handles outside of Rails.</p>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua caso veja quaisquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
