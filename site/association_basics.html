<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Associações Active Record — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/toggle-theme.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Associações Active Record — Ruby on Rails Guides" />
  <meta name="description" content="Associações Active RecordEsse guia cobre os recursos de associação do Active Record.Após ler esse guia, você saberá: Como declarar associações entre models do Active Record. Como entender os vários tipos de associações Active Record. Como usar os métodos adicionados em seus models ao criar associações." />
  <meta property="og:description" content="Associações Active RecordEsse guia cobre os recursos de associação do Active Record.Após ler esse guia, você saberá: Como declarar associações entre models do Active Record. Como entender os vários tipos de associações Active Record. Como usar os métodos adicionados em seus models ao criar associações." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.8</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                  <dd><a href="active_record_encryption.html">Active Record Encryption</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - Dezembro 2021</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - Dezembro 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </dl>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="action_view_helpers.html">Action View Helpers</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</option>
                  <option value="classic_to_zeitwerk_howto.html">Classic para Zeitwerk - Como Fazer</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
                  <option value="active_record_encryption.html">Active Record Encryption</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_0_release_notes.html">Version 7.0 - Dezembro 2021</option>
                  <option value="6_1_release_notes.html">Version 6.1 - Dezembro 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Associações Active Record</h2><p>Esse guia cobre os recursos de associação do <em>Active Record</em>.</p><p>Após ler esse guia, você saberá:</p>
<ul>
<li>Como declarar associações entre <em>models</em> do <em>Active Record</em>.</li>
<li>Como entender os vários tipos de associações <em>Active Record</em>.</li>
<li>Como usar os métodos adicionados em seus <em>models</em> ao criar associações.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#por-que-associa%C3%A7%C3%B5es-questionmark">Por Que Associações?</a></li>
<li>
<a href="#os-tipos-de-associa%C3%A7%C3%B5es">Os Tipos de Associações</a>

<ul>
<li><a href="#a-associa%C3%A7%C3%A3o-belongs-to">A Associação <code>belongs_to</code></a></li>
<li><a href="#a-associa%C3%A7%C3%A3o-has-one">A associação <code>has_one</code></a></li>
<li><a href="#a-associa%C3%A7%C3%A3o-has-many">A Associação <code>has_many</code></a></li>
<li><a href="#a-associa%C3%A7%C3%A3o-has-many-through">A Associação <code>has_many :through</code></a></li>
<li><a href="#a-associa%C3%A7%C3%A3o-has-one-through">A Associação <code>has_one :through</code></a></li>
<li><a href="#a-associa%C3%A7%C3%A3o-has-and-belongs-to-many">A Associação <code>has_and_belongs_to_many</code></a></li>
<li><a href="#escolhendo-entre-belongs-to-and-has-one">Escolhendo entre <code>belongs_to</code> and <code>has_one</code></a></li>
<li><a href="#escolhendo-entre-has-many-through-e-has-and-belongs-to-many">Escolhendo entre <code>has_many :through</code> e <code>has_and_belongs_to_many</code></a></li>
<li><a href="#associa%C3%A7%C3%B5es-polim%C3%B3rficas">Associações Polimórficas</a></li>
<li><a href="#self-joins">Self Joins</a></li>
</ul>
</li>
<li>
<a href="#dicas-truques-e-avisos">Dicas, Truques e Avisos</a>

<ul>
<li><a href="#controlando-o-caching">Controlando o <em>Caching</em></a></li>
<li><a href="#evitando-colis%C3%B5es-de-nome">Evitando Colisões de Nome</a></li>
<li><a href="#atualizando-o-schema">Atualizando o <em>Schema</em></a></li>
<li><a href="#controlando-o-escopo-de-associa%C3%A7%C3%A3o">Controlando o Escopo de Associação</a></li>
<li><a href="#associa%C3%A7%C3%B5es-bidirecionais">Associações Bidirecionais</a></li>
</ul>
</li>
<li>
<a href="#refer%C3%AAncia-detalhada-das-associa%C3%A7%C3%B5es">Referência Detalhada das Associações</a>

<ul>
<li><a href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-belongs-to">Referência da Associação <code>belongs_to</code></a></li>
<li><a href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-one">Referência da Associação <code>has_one</code></a></li>
<li><a href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-many">Referência da Associação <code>has_many</code></a></li>
<li><a href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-and-belongs-to-many">Referência da Associação <code>has_and_belongs_to_many</code></a></li>
<li><a href="#callbacks-de-associa%C3%A7%C3%A3o"><em>Callbacks</em> de Associação</a></li>
<li><a href="#association-extensions">Association Extensions</a></li>
</ul>
</li>
<li><a href="#single-table-inheritance-sti">Single Table Inheritance (STI)</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="por-que-associações-questionmark"><a class="anchorlink" href="#por-que-associa%C3%A7%C3%B5es-questionmark">1 Por Que Associações?</a></h3><p>Em Rails, uma <em>associação</em> é uma conexão entre dois <em>models</em> em <em>Active Record</em>.
Por que precisamos de associações entre <em>models</em>? Porque eles tornam as operações
comuns mais simples e fáceis de entender em seu código. Por exemplo, considere
uma aplicação Rails simples que inclua um <em>model</em> para autores e um <em>model</em> para
livros. Cada autor pode ter vários livros. Sem associações, as declarações do
<em>model</em> seriam assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
end

class Book &lt; ApplicationRecord
end
">Copy</button>
</div>
<p>Agora, suponha que queremos adicionar um novo livro para um autor existente.
Nós precisaríamos fazer algo assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = Book.create(published_at: Time.now, author_id: @author.id)
">Copy</button>
</div>
<p>Ou considere excluir um autor, garantindo que todos os seus livros serão
excluídos também:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
<span class="k">end</span>
<span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = Book.where(author_id: @author.id)
@books.each do |book|
  book.destroy
end
@author.destroy
">Copy</button>
</div>
<p>Com as associações do <em>Active Record</em>, podemos otimizar essas - e outras -
operações declarando ao Rails que há uma conexão entre os dois <em>models</em>. Aqui
está o código revisado para configurar autores e livros:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, dependent: :destroy
end

class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Com essa alteração, é mais fácil criar um novo livro para um autor específico:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.create(published_at: Time.now)
">Copy</button>
</div>
<p>Excluir um autor e todos os seus livros é <strong>muito</strong> mais fácil:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.destroy
">Copy</button>
</div>
<p>Para saber mais sobre os diferentes tipos de associações, leia a próxima seção
deste guia. Em seguida há algumas dicas e truques para trabalhar com associações
e, na sequência, uma referência completa dos métodos e opções para associações no
Rails.</p><h3 id="os-tipos-de-associações"><a class="anchorlink" href="#os-tipos-de-associa%C3%A7%C3%B5es">2 Os Tipos de Associações</a></h3><p>O Rails suporta seis tipos de associações:</p>
<ul>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a></li>
</ul>
<p>As associações são implementadas usando chamadas <em>macro-style</em>, para que você possa adicionar declarativamente recursos aos seus <em>models</em>. Por exemplo, ao declarar que um <em>model</em> <code>belongs_to</code> (pertence a outro), você instrui o Rails a manter as informações de <a href="https://pt.wikipedia.org/wiki/Chave_prim%C3%A1ria">Primary Key</a>-<a href="https://pt.wikipedia.org/wiki/Chave_estrangeira">Foreign Key</a> (Chave primária-Chave Estrangeira) entre instâncias dos dois <em>models</em>, e também obtém vários métodos úteis adicionados ao seu <em>model</em>.</p><p>No restante deste guia, você aprenderá como declarar e usar as várias formas de associação. Mas primeiro, uma rápida introdução para as situações em que cada tipo de associação é apropriada.</p><h4 id="a-associação-belongs-to"><a class="anchorlink" href="#a-associa%C3%A7%C3%A3o-belongs-to">2.1 A Associação <code>belongs_to</code></a></h4><p>Uma associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> configura uma conexão com outro <em>model</em>, de modo que cada instância do <em>model</em> declarante "pertença a" uma instância do outro <em>model</em>. Por exemplo, se sua aplicação incluir autores e livros, e cada livro pertencer a apenas um autor, você declarará o <em>model</em> do livro da seguinte maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p><img src="images/association_basics/belongs_to.png" alt="Diagrama de Associação belongs_to"></p><div class="note"><p>as associações <code>belongs_to</code> <em>devem</em> usar o termo no singular. Se você usou o plural no exemplo acima para a associação <code>autor</code> no <em>model</em> <code>Livro</code> e tentou criar a instância com <code>Book.create(authors: @author)</code>, você seria informado de que existe uma "constante não inicializada <code>Book::Authors</code>". Isso ocorre porque o Rails deduz automaticamente o nome da classe a partir do nome da associação. Se o nome da associação estiver incorretamente no plural, a classe inferida também estará incorreta.</p></div><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>Quando usado sozinho, <code>belongs_to</code> produz uma conexão unidirecional um-para-um. Portanto, cada livro no exemplo acima "conhece" seu autor, mas os autores não sabem sobre seus livros.
Para configurar uma <a href="#associacoes-bidirecionais">associação bidirecional</a> - use <code>belongs_to</code> em combinação com <code>has_one</code> ou <code>has_many</code> no outro <em>model</em>.</p><p><code>belongs_to</code> não garante consistência de referência, portanto, dependendo do caso de uso, você também pode precisar adicionar uma restrição de chave estrangeira a nível de banco de dados na coluna de referência, assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, foreign_key: true
  # ...
end
">Copy</button>
</div>
<h4 id="a-associação-has-one"><a class="anchorlink" href="#a-associa%C3%A7%C3%A3o-has-one">2.2 A associação <code>has_one</code></a></h4><p>Uma associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> indica que um outro <em>model</em> tem uma referência a este <em>model</em>. Esse <em>model</em> pode ser obtido por meio dessa associação.</p><p>Por exemplo, se cada fornecedor (<em>supplier</em>) da sua aplicação tiver apenas uma conta, você declararia o <em>model</em> de fornecedor desta forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end
">Copy</button>
</div>
<p>A principal diferença do <code>belongs_to</code> é que a coluna do link <code>supplier_id</code> está localizada na outra tabela:</p><p><img src="images/association_basics/has_one.png" alt="Diagrama de Associação has_one"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>Dependendo do caso de uso, também pode ser necessário criar um índice exclusivo e/ou
uma restrição de <em>foreign key</em> na coluna do fornecedor para a tabela de contas. Nesse
caso, a definição da coluna parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :accounts do |t|
  t.belongs_to :supplier, index: { unique: true }, foreign_key: true
  # ...
end
">Copy</button>
</div>
<p>Esta relação pode ser <a href="#associacoes-bidirecionais">bidirecional</a> quando usada em combinação com <code>belongs_to</code> no outro <em>model</em>.</p><h4 id="a-associação-has-many"><a class="anchorlink" href="#a-associa%C3%A7%C3%A3o-has-many">2.3 A Associação <code>has_many</code></a></h4><p>Uma associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> é semelhante a <code>has_one</code>, mas indica uma conexão um-para-muitos com outro <em>model</em>. Você encontrará frequentemente essa associação no "outro lado" de uma associação <code>belongs_to</code>. Essa associação 
indica que cada instância do <em>model</em> possui zero ou mais instâncias de outro <em>model</em>. Por exemplo, em uma aplicação que contém autores e livros, o <em>model</em> do autor pode ser declarado assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>O nome do outro <em>model</em> é pluralizado ao declarar uma associação <code>has_many</code>.</p></div><p><img src="images/association_basics/has_many.png" alt="Diagrama de Assocação has_many"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAuthors &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>Dependendo do caso de uso, geralmente é uma boa ideia criar um índice não único e, opcionalmente,
uma restrição de chave estrangeira na coluna do autor para a tabela de livros:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, index: true, foreign_key: true
  # ...
end
">Copy</button>
</div>
<h4 id="a-associação-has-many-through"><a class="anchorlink" href="#a-associa%C3%A7%C3%A3o-has-many-through">2.4 A Associação <code>has_many :through</code></a></h4><p>Uma associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a> é frequentemente usada para estabelecer uma conexão muitos-para-muitos com outro <em>model</em>. Essa associação indica que o <em>model</em> declarado pode ser correspondido com zero ou mais instâncias de outro <em>model</em>, prosseguindo através (<em>through</em>) de um terceiro <em>model</em>. Por exemplo, considere uma prática médica em que os pacientes marcam consultas com médicos. As declarações de associação relevantes podem ter a seguinte aparência:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Physician</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:patients</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Appointment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:physician</span>
  <span class="n">belongs_to</span> <span class="ss">:patient</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:physicians</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Physician &lt; ApplicationRecord
  has_many :appointments
  has_many :patients, through: :appointments
end

class Appointment &lt; ApplicationRecord
  belongs_to :physician
  belongs_to :patient
end

class Patient &lt; ApplicationRecord
  has_many :appointments
  has_many :physicians, through: :appointments
end
">Copy</button>
</div>
<p><img src="images/association_basics/has_many_through.png" alt="Diagrama de Associação has_many :through"></p><p>A <em>migration</em> correspondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:physicians</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:patients</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAppointments &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :physicians do |t|
      t.string :name
      t.timestamps
    end

    create_table :patients do |t|
      t.string :name
      t.timestamps
    end

    create_table :appointments do |t|
      t.belongs_to :physician
      t.belongs_to :patient
      t.datetime :appointment_date
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>O conjunto da junção dos <em>models</em> pode ser gerenciada através dos <a href="#referencia-da-associacao-has-many">métodos de associação <code>has_many</code></a>.
Por exemplo, se você atribuir:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">physician</span><span class="p">.</span><span class="nf">patients</span> <span class="o">=</span> <span class="n">patients</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="physician.patients = patients
">Copy</button>
</div>
<p>Em seguida, novos <em>models</em> de junção são criados automaticamente para os objetos recém-associados.
Se alguns que existiam anteriormente estão faltando agora, suas linhas de junção são excluídas automaticamente.</p><div class="warning"><p>A exclusão automática de <em>models</em> de junção é direta, nenhum <em>callback</em> de destruição é acionado.</p></div><p>A associação <code>has_many :through</code> também é útil para configurar "atalhos" através de associações aninhadas <code>has_many</code>. Por exemplo, se um documento possui muitas seções e uma seção com muitos parágrafos, você pode obter uma coleção simples de todos os parágrafos do documento. Você pode configurar dessa maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sections</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span><span class="p">,</span> <span class="ss">through: :sections</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Section</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:document</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paragraph</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:section</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Document &lt; ApplicationRecord
  has_many :sections
  has_many :paragraphs, through: :sections
end

class Section &lt; ApplicationRecord
  belongs_to :document
  has_many :paragraphs
end

class Paragraph &lt; ApplicationRecord
  belongs_to :section
end
">Copy</button>
</div>
<p>Com <code>through: :section</code> especificado, o Rails agora entenderá:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@document</span><span class="p">.</span><span class="nf">paragraphs</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@document.paragraphs
">Copy</button>
</div>
<h4 id="a-associação-has-one-through"><a class="anchorlink" href="#a-associa%C3%A7%C3%A3o-has-one-through">2.5 A Associação <code>has_one :through</code></a></h4><p>Uma Associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a> estabelece uma conexão um-para-um com outro <em>model</em>. Essa associação indica
que o <em>model</em> declarante pode ser combinado com uma instância de outro <em>model</em>, prosseguindo através(<em>through</em>) de um terceiro <em>model</em>.
Por exemplo, se cada fornecedor tiver uma conta, e cada conta estiver associada a um histórico da conta, então o
<em>model</em> fornecedor poderia ficar assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span><span class="p">,</span> <span class="ss">through: :account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountHistory</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
  has_one :account_history, through: :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  has_one :account_history
end

class AccountHistory &lt; ApplicationRecord
  belongs_to :account
end
">Copy</button>
</div>
<p><img src="images/association_basics/has_one_through.png" alt="has_one :through Association Diagram"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAccountHistories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:account_histories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:account</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:credit_rating</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAccountHistories &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end

    create_table :account_histories do |t|
      t.belongs_to :account
      t.integer :credit_rating
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<h4 id="a-associação-has-and-belongs-to-many"><a class="anchorlink" href="#a-associa%C3%A7%C3%A3o-has-and-belongs-to-many">2.6 A Associação <code>has_and_belongs_to_many</code></a></h4><p>Uma associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> cria uma conexão direta muitos-para-muitos com outro <em>model</em>, sem nenhum <em>model</em> intermediário.
Essa associação indica que cada instância do <em>model</em> declarado se refere a zero ou mais instâncias do outro <em>model</em>
Por exemplo, se sua aplicação incluir conjuntos e peças, com cada conjunto tendo muitas peças e cada peça aparecendo em muitos conjuntos, você poderá declarar os <em>model</em> desta maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p><img src="images/association_basics/habtm.png" alt="has_and_belongs_to_many Association Diagram"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:assembly</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:part</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesAndParts &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :assemblies do |t|
      t.string :name
      t.timestamps
    end

    create_table :parts do |t|
      t.string :part_number
      t.timestamps
    end

    create_table :assemblies_parts, id: false do |t|
      t.belongs_to :assembly
      t.belongs_to :part
    end
  end
end
">Copy</button>
</div>
<h4 id="escolhendo-entre-belongs-to-and-has-one"><a class="anchorlink" href="#escolhendo-entre-belongs-to-and-has-one">2.7 Escolhendo entre <code>belongs_to</code> and <code>has_one</code></a></h4><p>Se você deseja configurar um relacionamento um-para-um entre dois <em>models</em>, será necessário adicionar <code>belongs_to</code> para um e <code>has_one</code> ao outro. Como você sabe qual é qual?</p><p>A distinção é onde você coloca a <em>foreign key</em> (ela aparece na tabela para a classe que declara a associação <code>belongs_to</code>), mas você deve pensar um pouco no significado real dos dados também. O relacionamento <code>has_one</code> diz que um de algo é seu - isto é, que algo aponta para você. Por exemplo, faz mais sentido dizer que um fornecedor possui uma conta do que uma conta possui um fornecedor. Isso sugere que os relacionamentos corretos são assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
end
">Copy</button>
</div>
<p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:supplier_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:supplier_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.bigint  :supplier_id
      t.string  :account_number
      t.timestamps
    end

    add_index :accounts, :supplier_id
  end
end
">Copy</button>
</div>
<div class="note"><p>O uso de <code>t.bigint :supplier_id</code> torna a nomeação da <em>foreign key</em> óbvia e explícita. Nas versões atuais do Rails, você pode abstrair esses detalhes de implementação usando <code>t.references :supplier</code>.</p></div><h4 id="escolhendo-entre-has-many-through-e-has-and-belongs-to-many"><a class="anchorlink" href="#escolhendo-entre-has-many-through-e-has-and-belongs-to-many">2.8 Escolhendo entre <code>has_many :through</code> e <code>has_and_belongs_to_many</code></a></h4><p>O Rails oferece duas maneiras diferentes de declarar um relacionamento muitos-para-muitos entre os <em>models</em>. A primeira maneira é usar <code>has_and_belongs_to_many</code>, o que permite fazer a associação diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>A segunda maneira de declara um relacionamento muitos-para-muito é usar <code>has_many :through</code>. Isso faz uma associação de forma indireta, através de um <em>model</em> de junção:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:parts</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manifest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:assembly</span>
  <span class="n">belongs_to</span> <span class="ss">:part</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_many :manifests
  has_many :parts, through: :manifests
end

class Manifest &lt; ApplicationRecord
  belongs_to :assembly
  belongs_to :part
end

class Part &lt; ApplicationRecord
  has_many :manifests
  has_many :assemblies, through: :manifests
end
">Copy</button>
</div>
<p>A regra mais simples é que você deve configurar um relacionamento <code>has_many :through</code> se precisar trabalhar com o <em>models</em> de relacionamento como uma entidade independente. Se você não precisar fazer nada com o <em>model</em> de relacionamento, pode ser mais simples configurar um relacionamento <code>has_and_belongs_to_many</code> (embora seja necessário lembrar de criar a tabela de junção no banco de dados).</p><p>Você deve usar <code>has_many :through</code> se precisar de validações, <em>callbacks</em> ou atributos extras no <em>join model</em>(modelo de junção).</p><h4 id="associações-polimórficas"><a class="anchorlink" href="#associa%C3%A7%C3%B5es-polim%C3%B3rficas">2.9 Associações Polimórficas</a></h4><p>Uma mudança um pouco mais avançada nas associações é a <em>associação polimórfica</em>. Com associações polimórficas, um <em>model</em> pode pertencer a mais de um outro <em>model</em>, em uma única associação. Por exemplo, você pode ter um <em>model</em> de foto que pertença a um <em>model</em> de funcionário ou a um <em>model</em> de produto. Veja como isso pode ser declarado:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Picture &lt; ApplicationRecord
  belongs_to :imageable, polymorphic: true
end

class Employee &lt; ApplicationRecord
  has_many :pictures, as: :imageable
end

class Product &lt; ApplicationRecord
  has_many :pictures, as: :imageable
end
">Copy</button>
</div>
<p>Você pode pensar em uma declaração polimórfica <code>belongs_to</code> como uma configuração de interface que qualquer outro <em>model</em> pode usar. Em uma instância do <em>model</em> <code>Funcionário</code>, você pode recuperar uma coleção de fotos: <code>@employee.pictures</code>.</p><p>Da mesma forma, você pode recuperar <code>@product.pictures</code>.</p><p>Se você tem uma instância do <em>model</em> <code>Fotos</code>, você pode chegar ao seu pai via <code>@picture.imageable</code>. Para fazer isso funcionar, você precisa declarar uma coluna de <em>foreign key</em> e uma coluna de tipo no <em>model</em> que declara a interface polimórfica:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:imageable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:imageable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="p">[</span><span class="ss">:imageable_type</span><span class="p">,</span> <span class="ss">:imageable_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :pictures do |t|
      t.string  :name
      t.bigint  :imageable_id
      t.string  :imageable_type
      t.timestamps
    end

    add_index :pictures, [:imageable_type, :imageable_id]
  end
end
">Copy</button>
</div>
<p>Esta <em>migration</em> pode ser simplificada usando a forma de <code>t.references</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :pictures do |t|
      t.string :name
      t.references :imageable, polymorphic: true
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p><img src="images/association_basics/polymorphic.png" alt="Diagrama de Associação Polimórfica"></p><h4 id="self-joins"><a class="anchorlink" href="#self-joins">2.10 Self Joins</a></h4><p>Ao projetar um modelo de dados, algumas vezes você encontrará um <em>model</em> que deve ter uma relação consigo mesmo. Por exemplo, você pode querer armazenar todos os funcionários em um único modelo de banco de dados, mas conseguir rastrear relacionamentos como entre gerente e subordinados. Essa situação pode ser modelada com associações <em>self-joining</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span>
                          <span class="ss">foreign_key: </span><span class="s2">"manager_id"</span>

  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Employee &lt; ApplicationRecord
  has_many :subordinates, class_name: "Employee",
                          foreign_key: "manager_id"

  belongs_to :manager, class_name: "Employee", optional: true
end
'>Copy</button>
</div>
<p>Com esta configuração, você pode recuperar <code>@employee.subordinates</code> e <code>@employee.manager</code>.</p><p>Em suas <em>migrations</em>/<em>schema</em>, você adicionará uma coluna de referências ao próprio <em>model</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateEmployees</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:employees</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">to_table: :employees</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateEmployees &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :employees do |t|
      t.references :manager, foreign_key: { to_table: :employees }
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<h3 id="dicas-truques-e-avisos"><a class="anchorlink" href="#dicas-truques-e-avisos">3 Dicas, Truques e Avisos</a></h3><p>Segue algumas coisas que você deve saber para utilizar as associações do <em>Active Record</em> nas suas aplicações Rails:</p>
<ul>
<li>Controlando o <em>caching</em>
</li>
<li>Evitando colisões de nome</li>
<li>Atualizando o <em>schema</em>
</li>
<li>Controlando o escopo de associação</li>
<li>Associações bidirecionais</li>
</ul>
<h4 id="controlando-o-caching"><a class="anchorlink" href="#controlando-o-caching">3.1 Controlando o <em>Caching</em></a></h4><p>Todos os métodos de associação são construídos em torno de <em>caching</em>, o que mantém o resultado da <em>query</em> mais recente disponível para operações futuras. O <em>cache</em> é até compartilhado entre métodos. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># retorna books do banco de dados</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># usa a versão salva em cache da busca por books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># usa a versão salva em cache da busca por books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# retorna books do banco de dados
author.books.load

# usa a versão salva em cache da busca por books
author.books.size

# usa a versão salva em cache da busca por books
author.books.empty?
">Copy</button>
</div>
<p>Mas e se você quiser recarregar o <em>cache</em>, porque pode haver alterações nos dados devido a outra parte da aplicação? Simplesmente chame <code>reload</code> na associação:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># retorna books do banco de dados</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span>

<span class="c1"># usa a versão salva em cache da busca por books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># descarta a resposta da busca salva em cache por books</span>
<span class="c1"># e volta a olhar para o banco de dados</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# retorna books do banco de dados
author.books

# usa a versão salva em cache da busca por books
author.books.size

# descarta a resposta da busca salva em cache por books
# e volta a olhar para o banco de dados
author.books.reload.empty?
">Copy</button>
</div>
<h4 id="evitando-colisões-de-nome"><a class="anchorlink" href="#evitando-colis%C3%B5es-de-nome">3.2 Evitando Colisões de Nome</a></h4><p>Não é possível usar simplesmente qualquer nome para suas associações. Considerando que ao criar uma associação adicionamos um método com o nome especificado ao <em>model</em>, é uma péssima ideia dar um nome para uma associação que já foi utilizado para um método de instância de <code>ActiveRecord::Base</code>. O método da associação sobrescreverá o método base e quebrará coisas. Por exemplo, <code>attributes</code> ou <code>connection</code> não são indicados como nomes para associações.</p><h4 id="atualizando-o-schema"><a class="anchorlink" href="#atualizando-o-schema">3.3 Atualizando o <em>Schema</em></a></h4><p>Associações são extremamente úteis, mas não são mágica. Você fica responsável por manter o <em>schema</em> do seu banco de dados de forma que corresponda às suas associações. Na prática, isto significa duas coisas, dependendo do tipo de associação que você criar. Para associações <code>belongs_to</code> você precisa criar chaves estrangeiras, e para associações <code>has_and_belongs_to_many</code> você precisa criar a tabela de junção (<em>join table</em>) apropriada.</p><h5 id="criando-chaves-estrangeiras-para-associações-belongs-to"><a class="anchorlink" href="#criando-chaves-estrangeiras-para-associa%C3%A7%C3%B5es-belongs-to">3.3.1 Criando Chaves Estrangeiras para Associações <code>belongs_to</code></a></h5><p>Quando você declara uma associação <code>belongs_to</code>, você precisa criar as chaves estrangeiras apropriadas. Por exemplo, considere este <em>model</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Esta declaração precisa do apoio de uma coluna de chave estrangeira apropriada na tabela <em>books</em>. Pra uma tabela recém criada, a migração pode parecer com isto:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span>   <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>     <span class="ss">:book_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :books do |t|
      t.datetime   :published_at
      t.string     :book_number
      t.references :author
    end
  end
end
">Copy</button>
</div>
<p>Enquanto que para uma tabela existente, pode parecer com isto:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddAuthorToBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:author</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddAuthorToBooks &lt; ActiveRecord::Migration[7.0]
  def change
    add_reference :books, :author
  end
end
">Copy</button>
</div>
<div class="note"><p>Se você quiser <a href="/active_record_migrations.html#foreign-keys">impor integridade de referência no nível do banco de dados</a>, acrescente a opção <code>foreign_key: true</code> à declaração da coluna <em>'reference'</em> acima.</p></div><h5 id="criando-tabelas-de-junção-para-associações-has-and-belongs-to-many"><a class="anchorlink" href="#criando-tabelas-de-jun%C3%A7%C3%A3o-para-associa%C3%A7%C3%B5es-has-and-belongs-to-many">3.3.2 Criando Tabelas de Junção para Associações <code>has_and_belongs_to_many</code></a></h5><p>Se você criar uma associação <code>has_and_belongs_to_many</code>, você precisa criar a tabela de junção de forma explícita. A menos que o nome da tabela de junção seja especificado de forma explícita através da opção <code>:join_table</code>, o <em>Active Record</em> cria o nome utilizando a ordem léxica dos nomes de classe. Dessa forma, uma junção entre os <em>models</em> <em>author</em> e <em>book</em> resulta no nome de tabela de junção padrão <em>"authors_books"</em> porque "a" precede "b" na ordenação léxica.</p><div class="warning"><p>A precedência entre nomes de <em>model</em> é calculada usando o operador <code>&lt;=&gt;</code> para <code>String</code>. Isto significa que se as <em>strings</em> têm comprimentos diferentes, e as <em>strings</em> são iguais quando comparados até o menor comprimento, então a <em>string</em> mais comprido recebe uma precedência léxica maior que o mais curto. Por exemplo, à primeira vista você pode esperar que as tabelas <em>"paper_boxes"</em> e <em>"papers"</em> resultem numa tabela de junção chamada <em>"papers_paper_boxes"</em> por causa do comprimento do nome <em>"paper_boxes"</em>, mas em vez disso cria-se a tabela de junção chamada <em>"paper_boxes_papers"</em> (porque o <em>underscore</em> '_' recebe um peso lexicográfico <em>menor</em> que 's' em <em>encodings</em> comuns).</p></div><p>Independente do nome, você deve gerar manualmente a tabela de junção com a migração apropriada. Por exemplo, considere estas associações:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>Elas precisam do apoio de uma migração para criar a tabela <code>assemblies_parts</code>. Esta tabela deve ser criada sem a chave primária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:part_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:assembly_id</span>
    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:part_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :assemblies_parts, id: false do |t|
      t.bigint :assembly_id
      t.bigint :part_id
    end

    add_index :assemblies_parts, :assembly_id
    add_index :assemblies_parts, :part_id
  end
end
">Copy</button>
</div>
<p>Passamos <code>id: false</code> para <code>create_table</code> porque esta tabela não representa um <em>model</em>. Isto é necessário para a associação funcionar de maneira correta. Se você observar qualquer comportamento estranho numa associação <code>has_and_belongs_to_many</code> como IDs de <em>model</em> corrompidos, ou exceções envolvendo IDs em conflito, é provável que você tenha esquecido deste detalhe.</p><p>Você também pode utilizar o método <code>create_join_table</code></p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable &lt; ActiveRecord::Migration[7.0]
  def change
    create_join_table :assemblies, :parts do |t|
      t.index :assembly_id
      t.index :part_id
    end
  end
end
">Copy</button>
</div>
<h4 id="controlando-o-escopo-de-associação"><a class="anchorlink" href="#controlando-o-escopo-de-associa%C3%A7%C3%A3o">3.4 Controlando o Escopo de Associação</a></h4><p>Por padrão, associações procuram por objetos apenas dentro do escopo do <em>model</em> atual. Isto é relevante quando você declara <em>models</em> do <em>Active Record</em> dentro de um módulo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account
    end

    class Account &lt; ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>Isto funciona corretamente, porque tanto a classe <code>Supplier</code> quanto a classe <code>Account</code> são definidas dentro do mesmo escopo. Mas o próximo exemplo <strong>não</strong> funcionará, porque <code>Supplier</code> e <code>Account</code> são definidos em escopos diferentes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account
    end
  end

  module Billing
    class Account &lt; ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>Para associar um <em>model</em> a outro <em>model</em> em um <em>namespace</em> diferente, você deve especificar o nome completo da classe na declaração da sua associação:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Billing::Account"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Business::Supplier"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account,
        class_name: "MyApplication::Billing::Account"
    end
  end

  module Billing
    class Account &lt; ApplicationRecord
      belongs_to :supplier,
        class_name: "MyApplication::Business::Supplier"
    end
  end
end
'>Copy</button>
</div>
<h4 id="associações-bidirecionais"><a class="anchorlink" href="#associa%C3%A7%C3%B5es-bidirecionais">3.5 Associações Bidirecionais</a></h4><p>É normal para associações funcionar em duas direções, necessitando de declarações em dois <em>models</em> diferentes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>O <em>Active Record</em> tentará identificar automaticamente que estes dois <em>models</em> compartilham uma associação bidirecional baseando-se no nome da associação. Desta forma, o <em>Active Record</em> carregará apenas uma cópia do objeto <code>Author</code>, tornando sua aplicação mais eficiente e evitando dados inconsistentes:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="a = Author.first
b = a.books.first
a.first_name == b.author.first_name
a.first_name = 'David'
a.first_name == b.author.first_name
">Copy</button>
</div>
<p>O <em>Active Record</em> suporta a identificação automática para a maioria das associações com
nomes padrão. No entanto, o <em>Active Record</em> não identificará automaticamente
associações bidirecionais que contêm o <code>:through</code> ou <code>:foreign_key</code>.
Escopos personalizados na associação oposta também impedem
identificação, assim como escopos personalizados na própria associação, a menos que
<a href="configuring.html#config-active-record-automatic-scope-inversing"><code>config.active_record.automatic_scope_inversing</code></a> estiver definido como verdadeiro (o padrão para
novas aplicações).</p><p>Por exemplo, considere as declarações de <em>models</em> abaixo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>O <em>Active Record</em> não reconhecerá mais a associação bidirecional:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="a = Author.first
b = a.books.first
a.first_name == b.writer.first_name
a.first_name = 'David'
a.first_name == b.writer.first_name
">Copy</button>
</div>
<p>O <em>Active Record</em> fornece a opção <code>:inverse_of</code> para declarar associações bidirecionais de forma explícita:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: </span><span class="s1">'writer'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, inverse_of: 'writer'
end

class Book &lt; ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>Ao incluir a opção <code>:inverse_of</code> na declaração da associação <code>has_many</code>, o <em>Active Record</em> agora reconhecerá a associação bidirecional:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="a = Author.first
b = a.books.first
a.first_name == b.writer.first_name
a.first_name = 'David'
a.first_name == b.writer.first_name
">Copy</button>
</div>
<h3 id="referência-detalhada-das-associações"><a class="anchorlink" href="#refer%C3%AAncia-detalhada-das-associa%C3%A7%C3%B5es">4 Referência Detalhada das Associações</a></h3><p>As seções seguintes dão detalhes sobre cada tipo de associação, incluindo os métodos que elas adicionam e as opções que você pode usar quando declarar uma associação.</p><h4 id="referência-da-associação-belongs-to"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-belongs-to">4.1 Referência da Associação <code>belongs_to</code></a></h4><p>Em termos de banco de dados, esta associação diz que a tabela deste modelo contém uma coluna que representa uma referência a outra tabela.
Isso pode ser usado para configurar relações um-para-um ou um-para-muitos, dependendo da configuração.
Se a tabela da outra classe contém a referência em uma relação um-para-um, então você deve usar <code>has_one</code>.</p><h5 id="métodos-adicionados-por-belongs-to"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-belongs-to">4.1.1 Métodos Adicionados por <code>belongs_to</code></a></h5><p>Quando você declara uma associação <code>belongs_to</code>, a classe declarada ganha automaticamente 8 métodos relacionados à associação:</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
<li><code>association_changed?</code></li>
<li><code>association_previously_changed?</code></li>
</ul>
<p>Em todos esses métodos, <code>association</code> é substituída pelo <em>symbol</em> passado como primeiro argumento para <code>belongs_to</code>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Cada instância do <em>model</em> <code>Book</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">author</span>
<span class="n">author</span><span class="o">=</span>
<span class="n">build_author</span>
<span class="n">create_author</span>
<span class="n">create_author!</span>
<span class="n">reload_author</span>
<span class="n">author_changed?</span>
<span class="n">author_previously_changed?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author
author=
build_author
create_author
create_author!
reload_author
author_changed?
author_previously_changed?
">Copy</button>
</div>
<div class="note"><p>Quando inicializar uma associação <code>has_one</code> ou <code>belongs_to</code> nova você deve usar o prefixo <code>build_</code> para montar a associação, ao invés do método <code>association.build</code> que seria usado para associações <code>has_many</code> ou <code>has_and_belongs_to_many</code>. Para criar uma associação nova, use o prefixo <code>create_</code>.</p></div><h6 id="métodos-adicionados-por-belongs-to-association"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-belongs-to-association">4.1.1.1 <code>association</code></a></h6><p>O método <code>association</code> retorna o objeto associado, se ele existir. Se nenhum objeto associado for encontrado, ele retorna <code>nil</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.author
">Copy</button>
</div>
<p>Se o objeto associado já foi retornado pelo banco de dados para este objeto, a versão em <em>cache</em> será retornada. Para sobrescrever este comportamento (e forçar a leitura do banco de dados), chame <code>#reload_association</code> no objeto pai.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reload_author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.reload_author
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-belongs-to-association-associate"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-belongs-to-association-associate">4.1.1.2 <code>association=(associate)</code></a></h6><p>O método <code>association=</code> atribui um objeto associado a este objeto. Por trás das cenas, isto significa extrair a chave primária do objeto associado e atribuir à chave estrangeira do objeto o mesmo valor.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="vi">@author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author = @author
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-belongs-to-build-association-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-belongs-to-build-association-attributes">4.1.1.3 <code>build_association(attributes = {})</code></a></h6><p>O método <code>build_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, mas o objeto associado ainda <em>não será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">build_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                             <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@author = @book.build_author(author_number: 123,
                             author_name: "John Doe")
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-belongs-to-create-association-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-belongs-to-create-association-attributes">4.1.1.4 <code>create_association(attributes = {})</code></a></h6><p>O método <code>create_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, e, uma vez que ele passe por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                              <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@author = @book.create_author(author_number: 123,
                              author_name: "John Doe")
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-belongs-to-create-association-bang-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-belongs-to-create-association-bang-attributes">4.1.1.5 <code>create_association!(attributes = {})</code></a></h6><p>Faz a mesma coisa que o método <code>create_association</code> acima, mas retorna <code>ActiveRecord::RecordInvalid</code> se o registro for inválido.</p><h6 id="association-changed-questionmark"><a class="anchorlink" href="#association-changed-questionmark">4.1.1.6 <code>association_changed?</code></a></h6><p>O método <code>association_changed?</code> retorna <code>true</code> se um novo objeto associado foi atribuído e a chave estrangeira será atualizada no próximo salvamento.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; true</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book.author # =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;
@book.author_changed? # =&gt; false

@book.author = Author.second # =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;
@book.author_changed? # =&gt; true

@book.save!
@book.author_changed? # =&gt; false
'>Copy</button>
</div>
<h6 id="association-previously-changed-questionmark"><a class="anchorlink" href="#association-previously-changed-questionmark">4.1.1.7 <code>association_previously_changed?</code></a></h6><p>O método <code>association_previously_changed?</code> retorna <code>true</code> se o salvamento anterior atualizou a associação para referenciar um novo objeto associado.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book.author # =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;
@book.author_previously_changed? # =&gt; false

@book.author = Author.second # =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;
@book.save!
@book.author_previously_changed? # =&gt; true
'>Copy</button>
</div>
<h5 id="opções-para-belongs-to"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to">4.1.2 Opções para <code>belongs_to</code></a></h5><p>Enquanto o Rails utiliza padrões inteligentes que funcionarão bem pra maior parte das situações, pode haver momentos onde você quer customizar o comportamento da referência à associação <code>belongs_to</code>. Estas customizações podem ser realizadas facilmente ao passar opções e blocos de escopo quando você cria a associação. Por exemplo, esta associação utiliza duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span><span class="p">,</span>
    <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, touch: :books_updated_at,
    counter_cache: true
end
">Copy</button>
</div>
<p>A associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> tem suporte a estas opções:</p>
<ul>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:primary_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:polymorphic</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
<li><code>:optional</code></li>
</ul>
<h6 id="opções-para-belongs-to-autosave"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-autosave">4.1.2.1 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opções-para-belongs-to-class-name"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-class-name">4.1.2.2 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para passar o nome do <em>model</em>. Por exemplo, se um <em>book</em> pertence a um <em>author</em>, mas o nome de fato do <em>model</em> contendo <em>authors</em> é <code>Patron</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  belongs_to :author, class_name: "Patron"
end
'>Copy</button>
</div>
<h6 id="opções-para-belongs-to-counter-cache"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-counter-cache">4.1.2.3 <code>:counter_cache</code></a></h6><p>A opção <code>:counter_cache</code> pode ser usada para tornar a busca pela quantidade de objetos que pertencem à associação mais eficiente. Considere estes <em>models</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>Com estas declarações, pedir o valor de <code>@author.books.size</code> requer fazer uma chamada para o banco de dados para realizar uma consulta <code>COUNT(*)</code>. Para evitar esta chamada, você pode adicionar um cache de contagem ao <em>model</em> <em>pertencente</em> ao outro:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, counter_cache: true
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>Com esta declaração, o Rails manterá o valor do <em>cache</em> atualizado, e aí retornará esse valor em resposta ao método <code>size</code>.</p><p>Embora a opção <code>:counter_cache</code> seja especificada no <em>model</em> que inclui a
declaração <code>belongs_to</code>, a coluna de fato deve ser adicionada ao <em>model</em>
<em>associado</em> (<code>has_many</code>). No caso acima, você precisaria adicionar uma coluna
com nome <code>books_count</code> ao <em>model</em> <code>Author</code>.</p><p>Você pode sobrescrever o nome padrão da coluna ao especificar um nome de coluna
customizado na declaração de <code>counter_cache</code> ao invés de especificar <code>true</code>. Por
exemplo, para usar <code>count_of_books</code> ao invés de <code>books_count</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: :count_of_books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, counter_cache: :count_of_books
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>Você só precisa especificar a opção <code>:counter_cache</code> no lado <code>belongs_to</code>
da associação.</p></div><p>Colunas de contagem de <em>cache</em> são adicionadas à lista de atributos de leitura do <em>model</em> contendo a associação através de <code>attr_readonly</code>.</p><h6 id="opções-para-belongs-to-dependent"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-dependent">4.1.2.4 <code>:dependent</code></a></h6><p>Se você configurar a opção <code>:dependent</code> para:</p>
<ul>
<li>
<code>:destroy</code>, quando o objeto for destruído, o método <code>destroy</code> será chamado nos
seus objetos associados.</li>
<li>
<code>:delete</code>, quando o objeto for destruído, todos os objetos associados serão
deletados diretamente do banco de dados sem chamar o método <code>destroy</code>.</li>
<li>
<code>:destroy_async</code>: quando o objeto é destruído, um <em>job</em> <code>ActiveRecord::DestroyAssociationAsyncJob</code>
é enfileirado, o que chamará <code>destroy</code> em seus objetos associados. O <em>Active Job</em> deve ser configurado
para que isso funcione.</li>
</ul>
<div class="warning"><p>Você não deve especificar esta opção numa associação <code>belongs_to</code> que estiver conectada com uma associação <code>has_many</code> com outra classe. Isto pode resultar em registros órfãos no seu banco de dados.</p></div><h6 id="opções-para-belongs-to-foreign-key"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-foreign-key">4.1.2.5 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna usada para armazenar a chave estrangeira no <em>model</em> é o nome da associação com o sufixo <code>_id</code> adicionado. A opção <code>:foreign_key</code> permite que você atribua o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span><span class="p">,</span>
                      <span class="ss">foreign_key: </span><span class="s2">"patron_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  belongs_to :author, class_name: "Patron",
                      foreign_key: "patron_id"
end
'>Copy</button>
</div>
<div class="info"><p>Em todo caso, o Rails não criará colunas de chave estrangeira para você. Você precisa defini-las de forma explícita como parte das suas migrações</p></div><h6 id="opções-para-belongs-to-primary-key"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-primary-key">4.1.2.6 <code>:primary_key</code></a></h6><p>Por convenção, o Rails presume que a coluna <code>id</code> é usada para armazenar a chave
primária de suas tabelas. A opção <code>:primary_key</code> permite especificar uma coluna
diferente para isto.</p><p>Por exemplo, dada uma tabela <code>users</code> com <code>guid</code> como chave primária. Se quisermos que uma tabela <code>todos</code> separada guarde a chave estrangeira <code>user_id</code> na coluna <code>guid</code>, então podemos usar <code>primary_key</code> para realizar isto desta forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s1">'guid'</span> <span class="c1"># primary key is guid and not id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="s1">'guid'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  self.primary_key = 'guid' # primary key is guid and not id
end

class Todo &lt; ApplicationRecord
  belongs_to :user, primary_key: 'guid'
end
">Copy</button>
</div>
<p>Quando executamos <code>@user.todos.create</code> então o registro <code>@todo</code> terá seu valor
<code>user_id</code> como o valor <code>guid</code> de <code>@user</code>.</p><h6 id="opções-para-belongs-to-inverse-of"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-inverse-of">4.1.2.7 <code>:inverse_of</code></a></h6><p>A opção <code>:inverse_of</code> específica o nome da associação <code>has_many</code> ou <code>has_one</code> que é o inverso desta associação definida.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book &lt; ApplicationRecord
  belongs_to :author, inverse_of: :books
end
">Copy</button>
</div>
<h6 id="polymorphic"><a class="anchorlink" href="#polymorphic">4.1.2.8 <code>:polymorphic</code></a></h6><p>Passar <code>true</code> para a opção <code>:polymorphic</code> indica que esta é uma associação polimórfica. Associações polimórficas foram discutidas com detalhes <a href="#associacoes-polimorficas">anteriormente neste guia</a>.</p><h6 id="opções-para-belongs-to-touch"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-touch">4.1.2.9 <code>:touch</code></a></h6><p>Se você configurar a opção <code>:touch</code> como <code>true</code>, então o <em>timestamp</em> <code>updated_at</code> ou <code>updated_on</code> no objeto associado será configurado com a hora atual quando este objeto for salvo ou destruído:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, touch: true
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>Neste caso, salvar ou destruir um <em>book</em> atualizará o <em>timestamp</em> no <em>author</em> associado. Você também pode especificar um <em>timestamp</em> particular para atualizar:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, touch: :books_updated_at
end
">Copy</button>
</div>
<h6 id="opções-para-belongs-to-validate"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-belongs-to-validate">4.1.2.10 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>true</code>, então os novos objetos associados serão validados quando você salvar este objeto. Por padrão, este valor é <code>false</code>: novos objetos associados não serão validados quando este objeto for salvo.</p><h6 id="optional"><a class="anchorlink" href="#optional">4.1.2.11 <code>:optional</code></a></h6><p>Se você configurar a opção <code>:optional</code> como <code>true</code>, então a presença do objeto
associado não será validada. Por padrão, esta opção está configurada como
<code>false</code>.</p><h5 id="escopos-para-belongs-to"><a class="anchorlink" href="#escopos-para-belongs-to">4.1.3 Escopos para <code>belongs_to</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>belongs_to</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, -&gt; { where active: true }
end
">Copy</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h6 id="escopos-para-belongs-to-where"><a class="anchorlink" href="#escopos-para-belongs-to-where">4.1.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, -&gt; { where active: true }
end
">Copy</button>
</div>
<h6 id="escopos-para-belongs-to-includes"><a class="anchorlink" href="#escopos-para-belongs-to-includes">4.1.3.2 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas de forma adiantada quando esta associação for utilizada. Por exemplo, considere estes models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Chapter &lt; ApplicationRecord
  belongs_to :book
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>Se você consulta <em>authors</em> com frequência diretamente de <em>chapters</em> (<code>@chapter.book.author</code>), então você pode deixar o seu código relativamente mais eficiente ao incluir <em>authors</em> na associação de <em>chapters</em> para <em>books</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:author</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Chapter &lt; ApplicationRecord
  belongs_to :book, -&gt; { includes :author }
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>Não há necessidade de usar <code>includes</code> para associações imediatas - isto é, se você tem <code>Book belongs_to :author</code>, então o <em>author</em> será carregado de forma adiantada automaticamente quando necessário.</p></div><h6 id="escopos-para-belongs-to-readonly"><a class="anchorlink" href="#escopos-para-belongs-to-readonly">4.1.3.3 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então o objeto associado só terá acesso de leitura quando retornado através da associação.</p><h6 id="escopos-para-belongs-to-select"><a class="anchorlink" href="#escopos-para-belongs-to-select">4.1.3.4 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é usada para consultar dados sobre objeto associado. Por padrão, o Rails retorna todas as colunas.</p><div class="info"><p>If you use the <code>select</code> method on a <code>belongs_to</code> association, you should also set the <code>:foreign_key</code> option to guarantee the correct results.</p></div><h5 id="referência-da-associação-belongs-to-todos-os-objetos-associados-existem-questionmark"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-belongs-to-todos-os-objetos-associados-existem-questionmark">4.1.4 Todos os Objetos Associados Existem?</a></h5><p>Você pode ver se os objetos associados existem ao utilizar o método <code>association.nil?</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No author found for this book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='if @book.author.nil?
  @msg = "No author found for this book"
end
'>Copy</button>
</div>
<h5 id="referência-da-associação-belongs-to-quando-os-objetos-são-salvos-questionmark"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-belongs-to-quando-os-objetos-s%C3%A3o-salvos-questionmark">4.1.5 Quando os Objetos são Salvos?</a></h5><p>Atribuir um objeto a uma associação <code>belongs_to</code> <em>não</em> salva o objeto automaticamente. Isto também não salva o objeto associado.</p><h4 id="referência-da-associação-has-one"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-one">4.2 Referência da Associação <code>has_one</code></a></h4><p>A associação <code>has_one</code> cria uma relação um-para-um com outro <em>model</em>. Em termos do banco de dados, esta associação diz que a outra classe contém a chave estrangeira. Se esta classe contém a chave estrangeira, então você deve utilizar <code>belongs_to</code>.</p><h5 id="métodos-adicionados-por-has-one"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-one">4.2.1 Métodos Adicionados por <code>has_one</code></a></h5><p>Quando você declara uma associação <code>has_one</code>, a classe declarada ganha automaticamente 6 métodos relacionados à associação:</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
</ul>
<p>Em todos estes métodos, <code>association</code> será substituído pelo <em>symbol</em> passado como primeiro argumento para <code>has_one</code>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end
">Copy</button>
</div>
<p>Cada instância do <em>model</em> <code>Supplier</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">account</span>
<span class="n">account</span><span class="o">=</span>
<span class="n">build_account</span>
<span class="n">create_account</span>
<span class="n">create_account!</span>
<span class="n">reload_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="account
account=
build_account
create_account
create_account!
reload_account
">Copy</button>
</div>
<div class="note"><p>Quando inicializar uma nova associação <code>has_one</code> ou <code>belongs_to</code> você deve usar o prefixo <code>build_</code> para montar a associação, ao invés do método <code>association.build</code> que seria usado para associações <code>has_many</code> ou <code>has_and_belongs_to_many</code>. Para criar uma, use o prefixo <code>create_</code>.</p></div><h6 id="métodos-adicionados-por-has-one-association"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-one-association">4.2.1.1 <code>association</code></a></h6><p>O método <code>association</code> retorna o objeto associado, se ele existir. Se nenhum objeto associado for encontrado, ele retorna <code>nil</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.account
">Copy</button>
</div>
<p>Se o objeto associado já foi retornado pelo banco de dados para este objeto, a versão em <em>cache</em> será retornada. Para sobrescrever este comportamento (e forçar a leitura do banco de dados), chame <code>#reload_association</code> no objeto pai.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">reload_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.reload_account
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-one-association-associate"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-one-association-associate">4.2.1.2 <code>association=(associate)</code></a></h6><p>O método <code>association=</code> atribui um objeto associado a este objeto. Por trás das cenas, isto significa extrair a chave primária do objeto associado e atribuir à chave estrangeira do objeto o mesmo valor.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span> <span class="o">=</span> <span class="vi">@account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@supplier.account = @account
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-one-build-association-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-one-build-association-attributes">4.2.1.3 <code>build_association(attributes = {})</code></a></h6><p>O método <code>build_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, mas o objeto associado ainda <em>não será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@account = @supplier.build_account(terms: "Net 30")
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-one-create-association-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-one-create-association-attributes">4.2.1.4 <code>create_association(attributes = {})</code></a></h6><p>O método <code>create_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, e, uma vez que ele passe por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@account = @supplier.create_account(terms: "Net 30")
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-one-create-association-bang-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-one-create-association-bang-attributes">4.2.1.5 <code>create_association!(attributes = {})</code></a></h6><p>Faz a mesma coisa que o método <code>create_association</code> acima, mas retorna <code>ActiveRecord::RecordInvalid</code> se o registro for inválido.</p><h5 id="opções-para-has-one"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one">4.2.2 Opções para <code>has_one</code></a></h5><p>Embora o Rails utilize padrões inteligentes que funcionarão bem na maioria das situações, pode haver momentos onde você queira customizar o comportamento da referência da associação <code>has_one</code>. Tais customizações podem ser feitas facilmente ao passar opções quando você cria a associação. Por exemplo, esta associação usa duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span><span class="p">,</span> <span class="ss">dependent: :nullify</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, class_name: "Billing", dependent: :nullify
end
'>Copy</button>
</div>
<p>A associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> tem suporte para estas opções:</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="opções-para-has-one-as"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-as">4.2.2.1 <code>:as</code></a></h6><p>Configurar a opção <code>:as</code> indica que esta é uma associação polimórfica. Associações polimórficas foram discutidas com detalhes <a href="#associacoes-polimorficas">anteriormente neste guia</a>.</p><h6 id="opções-para-has-one-autosave"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-autosave">4.2.2.2 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opções-para-has-one-class-name"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-class-name">4.2.2.3 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para fornecer o nome do <em>model</em>. Por exemplo, se um <em>supplier</em> tem uma <em>account</em>, mas o nome de fato do <em>model</em> contendo <em>accounts</em> é <code>Billing</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, class_name: "Billing"
end
'>Copy</button>
</div>
<h6 id="opções-para-has-one-dependent"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-dependent">4.2.2.4 <code>:dependent</code></a></h6><p>Controla o que acontece com o objeto associado quando o dono dele é destruído:</p>
<ul>
<li>
<code>:destroy</code> faz com que o objeto associado também seja destruído</li>
<li>
<code>:delete</code> faz com que o objeto associado seja deletado diretamente do banco de dados (dessa forma os <em>callbacks</em> não serão executados)</li>
<li>
<code>:destroy_async</code>: quando o objeto é destruído, um <em>job</em> <code>ActiveRecord::DestroyAssociationAsyncJob</code> é enfileirado, que chamará <code>destroy</code> em seus objetos associados. O <em>Active Job</em> deve ser configurado para que funcione.</li>
<li>
<code>:nullify</code> faz com que a chave estrangeira seja configurada para <code>NULL</code>. Colunas polimórficas também recebem <code>NULL</code> em associações polimórficas. <em>Callbacks</em> não são executados.</li>
<li>
<code>:restrict_with_exception</code> faz com que a exceção <code>ActiveRecord::DeleteRestrictionError</code> seja retornada se houver um registro associado</li>
<li>
<code>:restrict_with_error</code> adiciona um erro ao dono se já houver um objeto associado</li>
</ul>
<p>É necessário não configurar ou deixar a opção <code>:nullify</code> para estas associações
que tem a restrição <code>NOT NULL</code> no banco de dados. Se você não configurar
<code>dependent</code> para estas associações você não poderá mudar o objeto associado
porque a chave estrangeira do objeto associado inicial será configurada para o
valor <code>NULL</code> que não é permitido.</p><h6 id="opções-para-has-one-foreign-key"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-foreign-key">4.2.2.5 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna usada para guardar a chave estrangeira no outro model tem o nome deste <em>model</em> com o sufixo <code>_id</code> adicionado. A opção <code>:foreign_key</code> permite que você configure o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"supp_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, foreign_key: "supp_id"
end
'>Copy</button>
</div>
<div class="info"><p>Em todo caso, o Rails não criará colunas de chave estrangeira para você. Você precisa defini-las de forma explícita como parte das suas migrações.</p></div><h6 id="opções-para-has-one-inverse-of"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-inverse-of">4.2.2.6 <code>:inverse_of</code></a></h6><p>A opção <code>:inverse_of</code> específica o nome da associação <code>has_many</code> ou <code>has_one</code> que é o inverso desta associação definida.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">inverse_of: :supplier</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">inverse_of: :account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, inverse_of: :supplier
end

class Account &lt; ApplicationRecord
  belongs_to :supplier, inverse_of: :account
end
">Copy</button>
</div>
<h6 id="opções-para-has-one-primary-key"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-primary-key">4.2.2.7 <code>:primary_key</code></a></h6><p>Por convenção, o Rails presume que a coluna <code>id</code> é usada para armazenar a chave primária de suas tabelas. A opção <code>:primary_key</code> permite especificar uma coluna diferente para isto.</p><h6 id="opções-para-has-one-source"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-source">4.2.2.8 <code>:source</code></a></h6><p>A opção <code>:source</code> especifica a associação fonte para uma associação <code>has_one :through</code>.</p><h6 id="opções-para-has-one-source-type"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-source-type">4.2.2.9 <code>:source_type</code></a></h6><p>A opção <code>:source_type</code> especifica o tipo da associação fonte para uma associação <code>has_one :through</code> que procede através de uma associação polimórfica.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:book</span>
  <span class="n">has_one</span> <span class="ss">:hardback</span><span class="p">,</span> <span class="ss">through: :book</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Hardback"</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span><span class="p">,</span> <span class="ss">through: :hardback</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">DustJacket</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_one :book
  has_one :hardback, through: :book, source: :format, source_type: "Hardback"
  has_one :dust_jacket, through: :hardback
end

class Book &lt; ApplicationRecord
  belongs_to :format, polymorphic: true
end

class Paperback &lt; ApplicationRecord; end

class Hardback &lt; ApplicationRecord
  has_one :dust_jacket
end

class DustJacket &lt; ApplicationRecord; end
'>Copy</button>
</div>
<h6 id="opções-para-has-one-through"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-through">4.2.2.10 <code>:through</code></a></h6><p>A opção <code>:through</code> específica um <em>model</em> de junção para realizar uma <em>query</em> através dele. Associações <code>has_one :through</code> foram discutidas com detalhes <a href="#a-associacao-has-one-through">anteriormente neste guia</a>.</p><h6 id="opções-para-has-one-touch"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-touch">4.2.2.11 <code>:touch</code></a></h6><p>Se você configurar a opção <code>:touch</code> como <code>true</code>, então o <em>timestamp</em> <code>updated_at</code> ou <code>updated_on</code> no objeto associado será configurado com a hora atual quando este objeto for salvo ou destruído:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, touch: true
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
end
">Copy</button>
</div>
<p>Neste caso, salvar ou destruir um <em>supplier</em> atualizará o <em>timestamp</em> na <em>account</em> associada. Você também pode especificar um <em>timestamp</em> particular para atualizar:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: :suppliers_updated_at</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, touch: :suppliers_updated_at
end
">Copy</button>
</div>
<h6 id="opções-para-has-one-validate"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-one-validate">4.2.2.12 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>true</code>, então os novos objetos associados serão validados quando você salvar este objeto. Por padrão, este valor é <code>false</code>: novos objetos associados não serão validados quando este objeto for salvo.</p><h5 id="escopos-para-has-one"><a class="anchorlink" href="#escopos-para-has-one">4.2.3 Escopos para <code>has_one</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>has_one</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { where active: true }
end
">Copy</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h6 id="escopos-para-has-one-where"><a class="anchorlink" href="#escopos-para-has-one-where">4.2.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { where "confirmed = 1" }
end
'>Copy</button>
</div>
<h6 id="escopos-para-has-one-includes"><a class="anchorlink" href="#escopos-para-has-one-includes">4.2.3.2 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas de forma adiantada quando esta associação for utilizada. Por exemplo, considere estes models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative &lt; ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<p>Se você consulta <em>representatives</em> diretamente de <em>suppliers</em> com frequência (<code>@supplier.account.representative</code>), então você pode tornar seu código relativamente mais eficiente ao incluir <em>representatives</em> na associação de <em>suppliers</em> para <em>accounts</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:representative</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { includes :representative }
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative &lt; ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<h6 id="escopos-para-has-one-readonly"><a class="anchorlink" href="#escopos-para-has-one-readonly">4.2.3.3 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então o objeto associado só terá acesso de leitura quando retornado através da associação.</p><h6 id="escopos-para-has-one-select"><a class="anchorlink" href="#escopos-para-has-one-select">4.2.3.4 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é usada para consultar dados sobre objeto associado. Por padrão, o Rails retorna todas as colunas.</p><h5 id="referência-da-associação-has-one-todos-os-objetos-associados-existem-questionmark"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-one-todos-os-objetos-associados-existem-questionmark">4.2.4 Todos os Objetos Associados Existem?</a></h5><p>Você pode ver se os objetos associados existem ao utilizar o método <code>association.nil?</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No account found for this supplier"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='if @supplier.account.nil?
  @msg = "No account found for this supplier"
end
'>Copy</button>
</div>
<h5 id="referência-da-associação-has-one-quando-os-objetos-são-salvos-questionmark"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-one-quando-os-objetos-s%C3%A3o-salvos-questionmark">4.2.5 Quando os Objetos são Salvos?</a></h5><p>Quando você atribui um objeto a uma associação <code>has_one</code>, este objeto será salvo automaticamente (para atualizar sua chave estrangeira). Além disso, qualquer objeto substituído também será salvo automaticamente, porque sua chave estrangeira também irá mudar.</p><p>Se qualquer uma destas operações de escrita falharem devido a erros de validação, então a atribuição retornará <code>false</code> e a atribuição em si será cancelada.</p><p>Se o objeto pai (o que declarar a associação <code>has_one</code>) não for salvo (isto é, <code>new_record?</code> retorna <code>true</code>) então os objetos filhos não serão salvos. Eles serão salvos automaticamente quando o objeto pai for salvo.</p><p>Se você quiser atribuir um objeto para uma associação <code>has_one</code> sem salvar o objeto, utilize o método <code>build_association</code>.</p><h4 id="referência-da-associação-has-many"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-many">4.3 Referência da Associação <code>has_many</code></a></h4><p>A associação <code>has_many</code> cria uma relação um-para-muitos com outro <em>model</em>. Em termos do banco de dados, esta associação diz que a outra classe terá uma chave estrangeira que se refere a instâncias desta classe.</p><h5 id="métodos-adicionados-por-has-many"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many">4.3.1 Métodos Adicionados por <code>has_many</code></a></h5><p>Quando você declara uma associação <code>has_many</code>, a classe declarada ganha automaticamente 17 métodos relacionados à associação:</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>Em todos estes métodos, <code>collection</code> será substituído pelo <em>symbol</em> passado como primeiro argumento para <code>has_many</code>, e <code>collection_singular</code> será substituído pela versão em singular daquele <em>symbol</em>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>Cada instância do <em>model</em> <code>Author</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">books</span>
<span class="n">books</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">book_ids</span>
<span class="n">book_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">books</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">books</span><span class="p">.</span><span class="nf">size</span>
<span class="n">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="books
books&lt;&lt;(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection">4.3.1.1 <code>collection</code></a></h6><p>O método <code>collection</code> retorna uma <em>Relation</em> de todos os objetos associados. Se não há objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-object"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-object">4.3.1.2 <code>collection&lt;&lt;(object, ...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> acrescenta um ou mais objetos à coleção configurando a chave estrangeira deles como a chave primária do <em>model</em> pai.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="vi">@book1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books &lt;&lt; @book1
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-delete-object"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-delete-object">4.3.1.3 <code>collection.delete(object, ...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> remove um ou mais objetos da coleção ao configurar a chave estrangeira deles como <code>NULL</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.delete(@book1)
">Copy</button>
</div>
<div class="warning"><p>Além disso, os objetos serão destruídos se estiverem associados com <code>dependent: :destroy</code>, e deletados se estiverem associados com <code>dependent: :delete_all</code>.</p></div><h6 id="métodos-adicionados-por-has-many-collection-destroy-object"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-destroy-object">4.3.1.4 <code>collection.destroy(object, ...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> remove um ou mais objetos da coleção executando <code>destroy</code> em cada objeto.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.destroy(@book1)
">Copy</button>
</div>
<div class="warning"><p>Os objetos <em>sempre</em> serão removidos do banco de dados, ignorando a opção <code>:dependent</code>.</p></div><h6 id="métodos-adicionados-por-has-many-collection-objects"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-objects">4.3.1.5 <code>collection=(objects)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos fornecidos, ao adicionar e deletar da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="métodos-adicionados-por-has-many-collection-singular-ids"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-singular-ids">4.3.1.6 <code>collection_singular_ids</code></a></h6><p>O método <code>collection_singular_ids</code> retorna um <em>array</em> de <em>ids</em> dos objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_ids</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">book_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_ids = @author.book_ids
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-singular-ids-ids"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-singular-ids-ids">4.3.1.7 <code>collection_singular_ids=(ids)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos identificados pelo valor das chaves primárias fornecidas, adicionando e deletando da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="métodos-adicionados-por-has-many-collection-clear"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-clear">4.3.1.8 <code>collection.clear</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> remove todos os objetos da coleção de acordo com a estratégia especificada pela opção <code>dependent</code>. Se nenhuma opção for especificada, ele segue a estratégia padrão. A estratégia padrão para associações <code>has_many :through</code> é <code>delete_all</code>, e para associações <code>has_many</code> é configurar as chaves estrangeiras como <code>NULL</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">clear</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.clear
">Copy</button>
</div>
<div class="warning"><p>Objetos serão deletados se eles forem associados com <code>dependent: :destroy</code> ou <code>dependent: :destroy_async</code>,
assim como <code>dependent: :delete_all</code>.</p></div><h6 id="métodos-adicionados-por-has-many-collection-empty-questionmark"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-empty-questionmark">4.3.1.9 <code>collection.empty?</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> retorna <code>true</code> se a coleção não contiver nenhum objeto associado.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  No Books Found
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% if @author.books.empty? %&gt;
  No Books Found
&lt;% end %&gt;
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-size"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-size">4.3.1.10 <code>collection.size</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> retorna o número de objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_count</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_count = @author.books.size
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-find"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-find">4.3.1.11 <code>collection.find(...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> procura objetos dentro da tabela da coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_book = @author.books.find(1)
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-where"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-where">4.3.1.12 <code>collection.where(...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> procura objetos dentro da coleção com base nas condições fornecidas mas os objetos serão carregados apenas quando necessário (<em>lazy loading</em>) significando que o banco de dados é consultado apenas quando os objetos são acessados.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">available: </span><span class="kp">true</span><span class="p">)</span> <span class="c1"># No query yet</span>
<span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@available_books</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Now the database will be queried</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_books = @author.books.where(available: true) # No query yet
@available_book = @available_books.first # Now the database will be queried
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-exists-questionmark"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-exists-questionmark">4.3.1.13 <code>collection.exists?(...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> confere se um objeto que atende às condições fornecidas
existe na tabela da coleção.</p><h6 id="métodos-adicionados-por-has-many-collection-build-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-build-attributes">4.3.1.14 <code>collection.build(attributes = {})</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> retorna apenas um objeto ou um <em>array</em> de objetos. Os objetos serão instanciados com base nos atributos passados para o método e será criada uma ligação através de chaves estrangeiras, mas os objetos associados <em>não</em> serão salvos ainda.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                            <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book = @author.books.build(published_at: Time.now,
                            book_number: "A12345")

@books = @author.books.build([
  { published_at: Time.now, book_number: "A12346" },
  { published_at: Time.now, book_number: "A12347" }
])
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-create-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-create-attributes">4.3.1.15 <code>collection.create(attributes = {})</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> retorna um objeto ou um <em>array</em> de novos objetos do tipo associado. Os objetos serão instanciados com base nos atributos que foram passados para o método, e uma ligação será criada através de uma chave estrangeira, e, uma vez que estes objetos passem por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                             <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book = @author.books.create(published_at: Time.now,
                             book_number: "A12345")

@books = @author.books.create([
  { published_at: Time.now, book_number: "A12346" },
  { published_at: Time.now, book_number: "A12347" }
])
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-many-collection-create-bang-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-create-bang-attributes">4.3.1.16 <code>collection.create!(attributes = {})</code></a></h6><p>Faz o mesmo que <code>collection.create</code> acima, mas retorna <code>ActiveRecord::RecordInvalid</code> se o dado for inválido.</p><h6 id="métodos-adicionados-por-has-many-collection-reload"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-many-collection-reload">4.3.1.17 <code>collection.reload</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> retorna uma <em>Relation</em> de todos os objetos associados, forçando uma leitura do banco de dados. Se não houver objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books.reload
">Copy</button>
</div>
<h5 id="opções-para-has-many"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many">4.3.2 Opções para <code>has_many</code></a></h5><p>Embora o Rails utilize padrões inteligentes que funcionarão bem na maioria das situações, pode haver momentos onde você queira customizar o comportamento da referência da associação <code>has_many</code>. Tais customizações podem ser feitas facilmente ao passar opções quando você cria a associação. Por exemplo, esta associação usa duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :delete_all</span><span class="p">,</span> <span class="ss">validate: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, dependent: :delete_all, validate: false
end
">Copy</button>
</div>
<p>A associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> tem suporte para estas opções:</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="opções-para-has-many-as"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-as">4.3.2.1 <code>:as</code></a></h6><p>Configurar a opção <code>:as</code> indica que esta é uma associação polimórfica, como discutido <a href="#associacoes-polimorficas">anteriomente neste guia</a>.</p><h6 id="opções-para-has-many-autosave"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-autosave">4.3.2.2 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opções-para-has-many-class-name"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-class-name">4.3.2.3 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para fornecer o nome do <em>model</em>. Por exemplo, se um <em>author</em> tem muitos <em>books</em>, mas o nome de fato do <em>model</em> contendo <em>books</em> é <code>Transaction</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Transaction"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books, class_name: "Transaction"
end
'>Copy</button>
</div>
<h6 id="opções-para-has-many-counter-cache"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-counter-cache">4.3.2.4 <code>:counter_cache</code></a></h6><p>Esta opção pode ser utilizada para configurar um <code>:counter_cache</code> personalizado. Você só precisa desta opção quando você personalizar o nome do seu <code>:counter_cache</code> na <a href="#opcoes-para-belongs-to">associação belongs_to</a>.</p><h6 id="dependent"><a class="anchorlink" href="#dependent">4.3.2.5 <code>:dependent</code></a></h6><p>Controla o que acontece com os objetos associados quando o dono deles é destruído:</p>
<ul>
<li>
<code>:destroy</code> faz com que todos os objetos associados também sejam destruídos</li>
<li>
<code>:delete_all</code> faz com que todos os objetos associados sejam deletados diretamente do banco de dados (dessa forma os <em>callbacks</em> não serão executados)</li>
<li>
<code>:destroy_async</code>: quando o objeto é destruído, um <em>job</em> <code>ActiveRecord::DestroyAssociationAsyncJob</code> é enfileirado, que chamará <code>destroy</code> em seus objetos associados. O <em>Active Job</em> deve ser configurado para que funcione.</li>
<li>
<code>:nullify</code> faz com que a chave estrangeira seja configurada para <code>NULL</code>. Colunas polimórficas também recebem <code>NULL</code> em associações polimórficas. <em>Callbacks</em> não são executados.</li>
<li>
<code>:restrict_with_exception</code> faz com a exceção <code>ActiveRecord::DeleteRestrictionError</code> seja retornada se houverem objetos associados</li>
<li>
<code>:restrict_with_error</code> adiciona um erro ao objeto dono se houverem objetos associados</li>
</ul>
<p>As opções <code>:destroy</code> e <code>:delete_all</code> também afetam a semântica dos métodos <code>collection.delete</code> e <code>collection=</code> fazendo com que eles destruam objetos associados ao removê-los da coleção.</p><h6 id="opções-para-has-many-foreign-key"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-foreign-key">4.3.2.6 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna usada para guardar a chave estrangeira no outro model tem o nome deste <em>model</em> com o sufixo <code>_id</code> adicionado. A opção <code>:foreign_key</code> permite que você configure o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"cust_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books, foreign_key: "cust_id"
end
'>Copy</button>
</div>
<div class="info"><p>Em todo caso, o Rails não criará colunas de chave estrangeira para você. Você precisa defini-las de forma explícita como parte das suas migrações.</p></div><h6 id="inverse-of"><a class="anchorlink" href="#inverse-of">4.3.2.7 <code>:inverse_of</code></a></h6><p>A opção <code>:inverse_of</code> específica o nome da associação <code>has_many</code> ou <code>has_one</code> que é o inverso desta associação definida.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book &lt; ApplicationRecord
  belongs_to :author, inverse_of: :books
end
">Copy</button>
</div>
<h6 id="primary-key"><a class="anchorlink" href="#primary-key">4.3.2.8 <code>:primary_key</code></a></h6><p>Por convenção, o Rails presume que a coluna <code>id</code> é usada para armazenar a chave primária de suas tabelas. A opção <code>:primary_key</code> permite especificar uma coluna diferente para isto.</p><p>Digamos que a tabela <code>users</code> tenha <code>id</code> como chave primária mas também tem uma
coluna <code>guid</code>. O requerimento é que a tabela <code>todos</code> deve guardar o valor da
coluna <code>guid</code> como chave estrangeria e não o valor de <code>id</code>. Podemos fazer isto
desta forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:todos</span><span class="p">,</span> <span class="ss">primary_key: :guid</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  has_many :todos, primary_key: :guid
end
">Copy</button>
</div>
<p>Agora ao executar <code>@todo = @user.todos.create</code> o valor de <code>user_id</code> no
registro <code>@todo</code> será o valor <code>guid</code> de <code>@user</code>.</p><h6 id="opções-para-has-many-source"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-source">4.3.2.9 <code>:source</code></a></h6><p>A opção <code>:source</code> especifica a associação fonte para uma associação <code>has_many :through</code>. Você só precisa utilizar esta opção se não for possível inferir o nome da associação fonte automaticamente.</p><h6 id="opções-para-has-many-source-type"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-source-type">4.3.2.10 <code>:source_type</code></a></h6><p>A opção <code>:source_type</code> especifica o tipo da associação fonte para uma associação <code>has_many :through</code> que procede através de uma associação polimórfica.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:paperbacks</span><span class="p">,</span> <span class="ss">through: :books</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Paperback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books
  has_many :paperbacks, through: :books, source: :format, source_type: "Paperback"
end

class Book &lt; ApplicationRecord
  belongs_to :format, polymorphic: true
end

class Hardback &lt; ApplicationRecord; end
class Paperback &lt; ApplicationRecord; end
'>Copy</button>
</div>
<h6 id="opções-para-has-many-through"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-through">4.3.2.11 <code>:through</code></a></h6><p>A opção <code>:through</code> específica um <em>model</em> de junção para realizar uma <em>query</em> através dele. Associações <code>has_many :through</code> fornecem uma maneira de implementar relações muitos-para-muitos, como discutido <a href="#a-associacao-has-many-through">anteriormente neste guia</a>.</p><h6 id="opções-para-has-many-validate"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-many-validate">4.3.2.12 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>false</code>, então os novos objetos associados não serão validados quando você salvar este objeto. Por padrão, este valor é <code>true</code>: novos objetos associados serão validados quando este objeto for salvo.</p><h5 id="escopos-para-has-many"><a class="anchorlink" href="#escopos-para-has-many">4.3.3 Escopos para <code>has_many</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>has_many</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">processed: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, -&gt; { where processed: true }
end
">Copy</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h6 id="escopos-para-has-many-where"><a class="anchorlink" href="#escopos-para-has-many-where">4.3.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :confirmed_books, -&gt; { where "confirmed = 1" },
    class_name: "Book"
end
'>Copy</button>
</div>
<p>Você também pode especificar condições através de um <em>hash</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">confirmed: </span><span class="kp">true</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :confirmed_books, -&gt; { where confirmed: true },
    class_name: "Book"
end
'>Copy</button>
</div>
<p>Se você utilizar uma opção no estilo <em>hash</em>, então a criação de dados através desta associação terá o escopo limitado automaticamente utilizando o <em>hash</em>. Neste caso, utilizar <code>@author.confirmed_books.create</code> ou <code>@author.confirmed_books.build</code> criará <code>books</code> onde a coluna <code>confirmed</code> terá o valor <code>true</code>.</p><h6 id="escopos-para-has-many-extending"><a class="anchorlink" href="#escopos-para-has-many-extending">4.3.3.2 <code>extending</code></a></h6><p>O método <code>extending</code> específica um módulo com nome para estender a delegação da associação. Extensões de associações são discutidas com detalhes <a href="#association-extensions">mais pra frente neste guia</a>.</p><h6 id="escopos-para-has-many-group"><a class="anchorlink" href="#escopos-para-has-many-group">4.3.3.3 <code>group</code></a></h6><p>O método <code>group</code> fornece um nome de atributo para agrupar o resultado da consulta ao banco de dados, utilizando a cláusula <code>GROUP BY</code> na busca SQL.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s1">'books.id'</span> <span class="p">},</span>
                      <span class="ss">through: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :chapters, -&gt; { group 'books.id' },
                      through: :books
end
">Copy</button>
</div>
<h6 id="escopos-para-has-many-includes"><a class="anchorlink" href="#escopos-para-has-many-includes">4.3.3.4 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas de forma adiantada quando esta associação for utilizada. Por exemplo, considere estes models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter &lt; ApplicationRecord
  belongs_to :book
end
">Copy</button>
</div>
<p>Se você busca <em>chapters</em> com frequência de <em>authors</em> (<code>@author.books.chapters</code>), então você pode deixar o seu código ligeiramente mais eficiente ao incluir <em>chapters</em> na associação de <em>authors</em> para <em>books</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:chapters</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, -&gt; { includes :chapters }
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter &lt; ApplicationRecord
  belongs_to :book
end
">Copy</button>
</div>
<h6 id="escopos-para-has-many-limit"><a class="anchorlink" href="#escopos-para-has-many-limit">4.3.3.5 <code>limit</code></a></h6><p>O método <code>limit</code> permite restringir o número total de objetos que serão retornados através de uma associação.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:recent_books</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'published_at desc'</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :recent_books,
    -&gt; { order('published_at desc').limit(100) },
    class_name: &quot;Book&quot;
end
">Copy</button>
</div>
<h6 id="escopos-para-has-many-offset"><a class="anchorlink" href="#escopos-para-has-many-offset">4.3.3.6 <code>offset</code></a></h6><p>O método permite especificar o deslocamento inicial ao buscar objetos do banco de dados através de uma associação. . Por exemplo, <code>-&gt; { offset(11) }</code> pulará os primeiros 11 registros no banco de dados.</p><h6 id="escopos-para-has-many-order"><a class="anchorlink" href="#escopos-para-has-many-order">4.3.3.7 <code>order</code></a></h6><p>O método <code>order</code> determina a ordem pela qual objetos associados serão retornados (na sintaxe utilizada pela cláusula SQL <code>ORDER BY</code>).</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"date_confirmed DESC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books, -&gt; { order "date_confirmed DESC" }
end
'>Copy</button>
</div>
<h6 id="escopos-para-has-many-readonly"><a class="anchorlink" href="#escopos-para-has-many-readonly">4.3.3.8 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então os objetos associados só terão acesso de leitura quando retornados através da associação.</p><h6 id="escopos-para-has-many-select"><a class="anchorlink" href="#escopos-para-has-many-select">4.3.3.9 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é utilizada para retornar dados sobre os objetos associados. Por padrão, o Rails retorna todas as colunas.</p><div class="warning"><p>Se você especificar seu próprio <code>select</code>, certifique-se de incluir as colunas de chave primária e chave estrangeira do <em>model</em> associado. Se você não fizer isto, o Rails retornará um erro.</p></div><h6 id="escopos-para-has-many-distinct"><a class="anchorlink" href="#escopos-para-has-many-distinct">4.3.3.10 <code>distinct</code></a></h6><p>Utilize o método <code>distinct</code> para manter a coleção livre de objetos duplicados. Isto é
mais útil junto com a opção <code>:through</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  has_many :readings
  has_many :articles, through: :readings
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 5, name: "a1"&gt;</span><span class="p">,</span> <span class="c1">#&lt;Article id: 5, name: "a1"&gt;]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">13</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'John')
article = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>No caso acima há dois <em>readings</em> e <code>person.articles</code> retorna os dois apesar
destes registros apontarem para o mesmo <em>article</em>.</p><p>Agora vamos especificar <code>distinct</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person
  has_many :readings
  has_many :articles, -&gt; { distinct }, through: :readings
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 7, name: "a1"&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">16</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">17</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>No caso acima ainda há dois <em>readings</em>. Contudo, <code>person.articles</code> mostra apenas
um <em>article</em> porque a coleção carrega apenas registros únicos.</p><p>Se você quiser ter certeza que, ao inserir dados novos no banco, todos os
registros na associação persistida sejam distintos (de forma que você também
possa ter certeza que quando inspecionar a associação, não achará dados
duplicados), você deve colocar um índice único na própria tabela. Por exemplo,
se você tem uma tabela chamada <code>readings</code> e você quer ter certeza que os
<em>articles</em> sejam adicionados por uma <em>person</em> apenas uma vez, você pode colocar
o seguinte em uma migração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_index</span> <span class="ss">:readings</span><span class="p">,</span> <span class="p">[</span><span class="ss">:person_id</span><span class="p">,</span> <span class="ss">:article_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_index :readings, [:person_id, :article_id], unique: true
">Copy</button>
</div>
<p>Uma vez que você tenha este índice único, tentar incluir um <em>article</em> a uma
<em>person</em> duas vezes retornará um erro <code>ActiveRecord::RecordNotUnique</code>:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="go">ActiveRecord::RecordNotUnique
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
">Copy</button>
</div>
<p>Note que conferir por unicidade utilizando algo como <code>include?</code> está sujeito a
<em>race conditions</em> (Exemplo:
<a href="https://pt.wikipedia.org/wiki/Condi%C3%A7%C3%A3o_de_corrida">https://pt.wikipedia.org/wiki/Condi%C3%A7%C3%A3o_de_corrida</a>). Não tente utilizar
<code>include?</code> para impor que objetos sejam distintos em um associação. Por exemplo,
utilizando o exemplo de <em>article</em> acima, o código seguinte teria uma <em>race
condition</em> porque múltiplos usuários podem tentar isto ao mesmo tempo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person.articles &lt;&lt; article unless person.articles.include?(article)
">Copy</button>
</div>
<h5 id="referência-da-associação-has-many-quando-os-objetos-são-salvos-questionmark"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-many-quando-os-objetos-s%C3%A3o-salvos-questionmark">4.3.4 Quando os Objetos são Salvos?</a></h5><p>Quando você atribui um objeto a uma associação <code>has_many</code>, este objeto será salvo automaticamente (para atualizar sua chave estrangeira). Se você atribuir vários objetos em uma declaração, então todos serão salvos.</p><p>Se qualquer uma destas operações de escrita falharem devido a erros de validação, então a atribuição retornará <code>false</code> e a atribuição em si será cancelada.</p><p>Se o objeto pai (o que declarar a associação <code>has_many</code>) não for salvo (isto é, <code>new_record?</code> retorna <code>true</code>) então os objetos filhos não serão salvos quando forem adicionados à coleção. Todos os membros da associação que não forem salvos anteriormente serão salvos automaticamente quando o objeto pai for salvo.</p><p>Se você quiser atribuir um objeto para uma associação <code>has_many</code> sem salvar o objeto, utilize o método <code>collection.build</code>.</p><h4 id="referência-da-associação-has-and-belongs-to-many"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-and-belongs-to-many">4.4 Referência da Associação <code>has_and_belongs_to_many</code></a></h4><p>A associação <code>has_and_belongs_to_many</code> cria uma relação muitos-para-muitos com outro <em>model</em>. Em termos do banco de dados, isto associa duas classes através de uma tabela de junção intermediária que inclui chaves estrangeiras fazendo referência a cada classe.</p><h5 id="métodos-adicionados-por-has-and-belongs-to-many"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many">4.4.1 Métodos Adicionados por <code>has_and_belongs_to_many</code></a></h5><p>Quando você declara uma associação <code>has_and_belongs_to_many</code>, a classe declarada ganha automaticamente vários métodos relacionados à associação:</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>Em todos estes métodos, <code>collection</code> será substituído pelo <em>symbol</em> passado como primeiro argumento para <code>has_and_belongs_to_many</code>, e <code>collection_singular</code> será substituído com a versão singular daquele <em>symbol</em>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>Cada instância do <em>model</em> <code>Part</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assemblies</span>
<span class="n">assemblies</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">assembly_ids</span>
<span class="n">assembly_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">size</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="assemblies
assemblies&lt;&lt;(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
">Copy</button>
</div>
<h6 id="métodos-adicionais-de-coluna"><a class="anchorlink" href="#m%C3%A9todos-adicionais-de-coluna">4.4.1.1 Métodos Adicionais de Coluna</a></h6><p>Se a tabela de junção para uma associação <code>has_and_belongs_to_many</code> tem colunas adicionais além das duas chaves estrangeiras, estas colunas serão adicionadas como atributos dos registros retornados através da associação. Registros retornados com atributos adicionais apenas poderão ter acesso de leitura, porque o Rails não pode salvar mudanças destes atributos.</p><div class="warning"><p>O uso de atributos extras na tabela de junção em uma associação <code>has_and_belongs_to_many</code> está deprecado. Se você necessitar deste tipo de comportamento complexo na tabela que liga dois <em>models</em> em uma relação muitos-para-muitos, você deve utilizar uma associação <code>has_many :through</code> ao invés de uma associação <code>has_and_belongs_to_many</code>.</p></div><h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection">4.4.1.2 <code>collection</code></a></h6><p>O método <code>collection</code> retorna uma <em>Relation</em> de todos os objetos associados. Se não há objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-object"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-object">4.4.1.3 <code>collection&lt;&lt;(object, ...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> acrescenta um ou mais objetos à coleção criando dados na tabela de junção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span> <span class="o">&lt;&lt;</span> <span class="vi">@assembly1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies &lt;&lt; @assembly1
">Copy</button>
</div>
<div class="note"><p>Este método pode ser chamado como <code>collection.concat</code> e <code>collection.push</code>.</p></div><h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-delete-object"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-delete-object">4.4.1.4 <code>collection.delete(object, ...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> remove um ou mais objetos da coleção deletando dados da tabela de junção. Isto não destrói os objetos.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.delete(@assembly1)
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-destroy-object"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-destroy-object">4.4.1.5 <code>collection.destroy(object, ...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> remove um ou mais objetos da coleção deletando dados da tabela de junção. Isto não destrói os objetos.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.destroy(@assembly1)
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-objects"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-objects">4.4.1.6 <code>collection=(objects)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos fornecidos, ao adicionar e deletar da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-singular-ids"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-singular-ids">4.4.1.7 <code>collection_singular_ids</code></a></h6><p>O método <code>collection_singular_ids</code> retorna um <em>array</em> de <em>ids</em> dos objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_ids</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assembly_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_ids = @part.assembly_ids
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-singular-ids-ids"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-singular-ids-ids">4.4.1.8 <code>collection_singular_ids=(ids)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos identificados pelo valor das chaves primárias fornecidas, adicionando e deletando da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-clear"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-clear">4.4.1.9 <code>collection.clear</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> remove todos os objetos da coleção deletando todas as linhas da tabela de junção. Isto não destrói os objetos associados.</p><h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-empty-questionmark"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-empty-questionmark">4.4.1.10 <code>collection.empty?</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> retorna <code>true</code> se a coleção não contiver nenhum objeto associado.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  This part is not used in any assemblies
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% if @part.assemblies.empty? %&gt;
  This part is not used in any assemblies
&lt;% end %&gt;
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-size"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-size">4.4.1.11 <code>collection.size</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> retorna o número de objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_count</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_count = @part.assemblies.size
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-find"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-find">4.4.1.12 <code>collection.find(...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> procura objetos dentro da tabela da coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.find(1)
">Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-where"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-where">4.4.1.13 <code>collection.where(...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> procura objetos dentro da coleção com base nas condições fornecidas mas os objetos serão carregados apenas quando necessário (<em>lazy loading</em>) significando que o banco de dados é consultado apenas quando os objetos são acessados.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@new_assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@new_assemblies = @part.assemblies.where("created_at &gt; ?", 2.days.ago)
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-exists-questionmark"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-exists-questionmark">4.4.1.14 <code>collection.exists?(...)</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> confere se um objeto que atende às condições fornecidas
existe na tabela da coleção.</p><h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-build-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-build-attributes">4.4.1.15 <code>collection.build(attributes = {})</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> retorna um objeto novo do tipo associado. O objeto será instanciado com base nos atributos passados para o método e será criada uma ligação através de uma chave estrangeira, mas o objeto associado <em>não</em> será salvo ainda.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@assembly = @part.assemblies.build({assembly_name: "Transmission housing"})
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-create-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-create-attributes">4.4.1.16 <code>collection.create(attributes = {})</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> retorna um objeto novo do tipo associado. Este objeto será instanciado com base nos atributos que foram passados para o método, a ligação através da tabela de junção será criado, e, uma vez que o objeto passe por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@assembly = @part.assemblies.create({assembly_name: "Transmission housing"})
'>Copy</button>
</div>
<h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-create-bang-attributes"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-create-bang-attributes">4.4.1.17 <code>collection.create!(attributes = {})</code></a></h6><p>Faz o mesmo que <code>collection.create</code>, mas retorna <code>ActiveRecord::RecordInvalid</code> se o dado for inválido.</p><h6 id="métodos-adicionados-por-has-and-belongs-to-many-collection-reload"><a class="anchorlink" href="#m%C3%A9todos-adicionados-por-has-and-belongs-to-many-collection-reload">4.4.1.18 <code>collection.reload</code></a></h6><p>O método <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> retorna uma <em>Relation</em> de todos os objetos associados, forçando uma leitura do banco de dados. Se não houver objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies.reload
">Copy</button>
</div>
<h5 id="opções-para-has-and-belongs-to-many"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-and-belongs-to-many">4.4.2 Opções para <code>has_and_belongs_to_many</code></a></h5><p>Embora o Rails utilize padrões inteligentes que funcionarão bem na maioria das situações, pode haver momentos onde você queira customizar o comportamento da referência da associação <code>has_and_belongs_to_many</code>. Tais customizações podem ser feitas facilmente ao passar opções quando você cria a associação. Por exemplo, esta associação usa duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">readonly</span> <span class="p">},</span>
                                       <span class="ss">autosave: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { readonly },
                                       autosave: true
end
">Copy</button>
</div>
<p>A associação <a href="https://api.rubyonrails.org/v7.0.8/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> tem suporte para estas opções:</p>
<ul>
<li><code>:association_foreign_key</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:foreign_key</code></li>
<li><code>:join_table</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="association-foreign-key"><a class="anchorlink" href="#association-foreign-key">4.4.2.1 <code>:association_foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna na tabela de junção utilizada para guardar a chave estrangeira que aponta para o outro <em>model</em> tem o nome daquele <em>model</em> com o sufixo <code>_id</code> acrescentado. A opção <code>:association_foreign_key</code> permite especificar o nome da chave estrangeira diretamente:</p><div class="info"><p>As opções <code>:foreign_key</code> e <code>:association_foreign_key</code> são úteis quando você configura uma relação muitos-para-muitos entre o mesmo <em>model</em>. Por exemplo:</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: "User",
      foreign_key: "this_user_id",
      association_foreign_key: "other_user_id"
end
'>Copy</button>
</div>
<h6 id="opções-para-has-and-belongs-to-many-autosave"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-and-belongs-to-many-autosave">4.4.2.2 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opções-para-has-and-belongs-to-many-class-name"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-and-belongs-to-many-class-name">4.4.2.3 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para fornecer o nome do <em>model</em>. Por exemplo, se uma <em>part</em> tem muitas <em>assemblies</em>, mas o nome de fato do <em>model</em> contendo <em>assemblies</em> é <code>Gadget</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Gadget"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, class_name: "Gadget"
end
'>Copy</button>
</div>
<h6 id="opções-para-has-and-belongs-to-many-foreign-key"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-and-belongs-to-many-foreign-key">4.4.2.4 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna na tabela de junção utilizada para armazenar a chave estrangeira apontando para este <em>model</em> é o nome deste <em>model</em> com o sufixo <code>_id</code> acrescentado. A opção <code>:foreign_key</code> permite que você atribua o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: "User",
      foreign_key: "this_user_id",
      association_foreign_key: "other_user_id"
end
'>Copy</button>
</div>
<h6 id="join-table"><a class="anchorlink" href="#join-table">4.4.2.5 <code>:join_table</code></a></h6><p>Se o nome padrão da tabela de junção, baseado no ordenamento léxico, não for o que você quer, você pode utilizar a opção <code>:join_table</code> para sobrescrever o nome padrão.</p><h6 id="opções-para-has-and-belongs-to-many-validate"><a class="anchorlink" href="#op%C3%A7%C3%B5es-para-has-and-belongs-to-many-validate">4.4.2.6 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>false</code>, então os novos objetos associados não serão validados quando você salvar este objeto. Por padrão, este valor é <code>true</code>: novos objetos associados serão validados quando este objeto for salvo.</p><h5 id="escopos-para-has-and-belongs-to-many"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many">4.4.3 Escopos para <code>has_and_belongs_to_many</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>has_and_belongs_to_many</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { where active: true }
end
">Copy</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h6 id="escopos-para-has-and-belongs-to-many-where"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-where">4.4.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"factory = 'Seattle'"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { where &quot;factory = 'Seattle'&quot; }
end
">Copy</button>
</div>
<p>Você também pode especificar condições através de um <em>hash</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">factory: </span><span class="s1">'Seattle'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { where factory: 'Seattle' }
end
">Copy</button>
</div>
<p>Se você utilizar a opção <code>where</code> no estilo <em>hash</em>, então a criação de dados através desta associação terá o escopo limitado automaticamente utilizando o <em>hash</em>. Neste caso, utilizar <code>@parts.assemblies.create</code> ou <code>@parts.assemblies.build</code> criará <code>orders</code> onde a coluna <code>factory</code> terá o valor "Seattle".</p><h6 id="escopos-para-has-and-belongs-to-many-extending"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-extending">4.4.3.2 <code>extending</code></a></h6><p>O método <code>extending</code> específica um módulo com nome para estender a delegação da associação. Extensões de associações são discutidas com detalhes <a href="#association-extensions">mais pra frente neste guia</a>.</p><h6 id="escopos-para-has-and-belongs-to-many-group"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-group">4.4.3.3 <code>group</code></a></h6><p>O método <code>group</code> fornece um nome de atributo para agrupar o resultado da consulta ao banco de dados, utilizando a cláusula <code>GROUP BY</code> na busca SQL.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s2">"factory"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { group "factory" }
end
'>Copy</button>
</div>
<h6 id="escopos-para-has-and-belongs-to-many-includes"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-includes">4.4.3.4 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas com antecedêncai quando esta associação for utilizada.</p><h6 id="escopos-para-has-and-belongs-to-many-limit"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-limit">4.4.3.5 <code>limit</code></a></h6><p>O método <code>limit</code> permite restringir o número total de objetos que serão retornados através de uma associação.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { order("created_at DESC").limit(50) }
end
'>Copy</button>
</div>
<h6 id="escopos-para-has-and-belongs-to-many-offset"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-offset">4.4.3.6 <code>offset</code></a></h6><p>O método permite especificar o deslocamento inicial ao buscar objetos do banco de dados através de uma associação. Por exemplo, se você utilizar <code>offset(11)</code>, ele pulará os primeiros 11 registros no banco de dados.</p><h6 id="escopos-para-has-and-belongs-to-many-order"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-order">4.4.3.7 <code>order</code></a></h6><p>O método <code>order</code> determina a ordem pela qual objetos associados serão retornados (na sintaxe utilizada pela cláusula SQL <code>ORDER BY</code>).</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"assembly_name ASC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { order "assembly_name ASC" }
end
'>Copy</button>
</div>
<h6 id="escopos-para-has-and-belongs-to-many-readonly"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-readonly">4.4.3.8 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então os objetos associados só terão acesso de leitura quando retornados através da associação.</p><h6 id="escopos-para-has-and-belongs-to-many-select"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-select">4.4.3.9 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é utilizada para retornar dados sobre os objetos associados. Por padrão, o Rails retorna todas as colunas.</p><h6 id="escopos-para-has-and-belongs-to-many-distinct"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-distinct">4.4.3.10 <code>distinct</code></a></h6><p>Utilize o método <code>distinct</code> para remover objetos duplicados da coleção.</p><h5 id="referência-da-associação-has-and-belongs-to-many-quando-os-objetos-são-salvos-questionmark"><a class="anchorlink" href="#refer%C3%AAncia-da-associa%C3%A7%C3%A3o-has-and-belongs-to-many-quando-os-objetos-s%C3%A3o-salvos-questionmark">4.4.4 Quando os Objetos são Salvos?</a></h5><p>Quando você atribui um objeto a uma associação <code>has_and_belongs_to_many</code>, este objeto será salvo automaticamente (para atualizar a tabela de junção). Se você atribuir vários objetos em uma declaração, então todos serão salvos.</p><p>Se qualquer uma destas operações de escrita falharem devido a erros de validação, então a atribuição retornará <code>false</code> e a atribuição em si será cancelada.</p><p>Se o objeto pai (o que declarar a associação <code>has_and_belongs_to_many</code>) não for salvo (isto é, <code>new_record?</code> retorna <code>true</code>) então os objetos filhos não serão salvos quando forem adicionados à coleção. Todos os membros da associação que não forem salvos anteriormente serão salvos automaticamente quando o objeto pai for salvo.</p><p>Se você quiser atribuir um objeto para uma associação <code>has_and_belongs_to_many</code> sem salvar o objeto, utilize o método <code>collection.build</code>.</p><h4 id="callbacks-de-associação"><a class="anchorlink" href="#callbacks-de-associa%C3%A7%C3%A3o">4.5 <em>Callbacks</em> de Associação</a></h4><p><em>Callbacks</em> normais aparecem no ciclo de vida dos objetos do Active Record, permitindo trabalhar com estes objetos em vários pontos. Por exemplo, você pode utilizar <em>callbacks</em> <code>:before_save</code> para fazer com que algo aconteça logo antes de salvar o objeto.</p><p><em>Callbacks</em> de associação são similares a <em>callbacks</em> normais, mas eles são ativados por eventos no ciclo de vida de uma coleção. Há quatro <em>callbacks</em> de associação disponíveis:</p>
<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>
<p>Você define <em>callbacks</em> de associação ao adicionar opções à declaração da associação. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_credit_limit</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, before_add: :check_credit_limit

  def check_credit_limit(book)
    # ...
  end
end
">Copy</button>
</div>
<p>O Rails passa o objeto que é adicionado ou removido do <em>callback</em>.</p><p>Você pode empilhar <em>callbacks</em> em um único evento ao passá-los como um <em>array</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span>
    <span class="ss">before_add: </span><span class="p">[</span><span class="ss">:check_credit_limit</span><span class="p">,</span> <span class="ss">:calculate_shipping_charges</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_shipping_charges</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books,
    before_add: [:check_credit_limit, :calculate_shipping_charges]

  def check_credit_limit(book)
    # ...
  end

  def calculate_shipping_charges(book)
    # ...
  end
end
">Copy</button>
</div>
<p>Se um <em>callback</em> <code>before_add</code> retorna a exceção <code>:abort</code>, o objeto não será adicionado 
à coleção. De forma similar, se um <em>callback</em> <code>before_remove</code> retorna a exceção <code>:abort</code>, o
objeto não será removido da coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># livros não serão adicionado se o limite foi atingido</span>
<span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
  <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit_reached?</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# livros não serão adicionado se o limite foi atingido
def check_credit_limit(book)
  throw(:abort) if limit_reached?
end
">Copy</button>
</div>
<div class="note"><p>Estes <em>callbacks</em> são chamados apenas quando os objetos associados são adicionados ou removidos através da coleção da associação:</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Ativa o *callback* `before_add`</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="n">book</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">=</span> <span class="p">[</span><span class="n">book</span><span class="p">,</span> <span class="n">book2</span><span class="p">]</span>

<span class="c1"># Não ativa o *callback* `before_add`</span>
<span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">author_id: </span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Ativa o *callback* `before_add`
author.books &lt;&lt; book
author.books = [book, book2]

# Não ativa o *callback* `before_add`
book.update(author_id: 1)
">Copy</button>
</div>
<h4 id="association-extensions"><a class="anchorlink" href="#association-extensions">4.6 Association Extensions</a></h4><p>Suas opções não estão limitadas às funcionalidades que o Rails monta automaticamente nos objetos de referência da associação. Você também pode extender estes objetos através de módulos anônimos, acrescentar <em>finders</em> novos, <em>creators</em>, ou outros métodos. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_book_prefix</span><span class="p">(</span><span class="n">book_number</span><span class="p">)</span>
      <span class="n">find_by</span><span class="p">(</span><span class="ss">category_id: </span><span class="n">book_number</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books do
    def find_by_book_prefix(book_number)
      find_by(category_id: book_number[0..2])
    end
  end
end
">Copy</button>
</div>
<p>Se você tem uma extensão que deve ser compartilhada por várias associações, você pode utilizar um módulo de extensão com nome. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FindRecentExtension</span>
  <span class="k">def</span> <span class="nf">find_recent</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module FindRecentExtension
  def find_recent
    where("created_at &gt; ?", 5.days.ago)
  end
end

class Author &lt; ApplicationRecord
  has_many :books, -&gt; { extending FindRecentExtension }
end

class Supplier &lt; ApplicationRecord
  has_many :deliveries, -&gt; { extending FindRecentExtension }
end
'>Copy</button>
</div>
<p>Extensões podem fazer referência a detalehs internos do objeto de referência da associação utilizando estes três atributos do acessor <code>proxy_association</code>:</p>
<ul>
<li>
<code>proxy_association.owner</code> retorna o objeto do qual a associação faz parte.</li>
<li>
<code>proxy_association.reflection</code> retorna o objeto de reflexão que descreve a associação.</li>
<li>
<code>proxy_association.target</code> retorna o objeto associado para <code>belongs_to</code> ou <code>has_one</code>, ou a coleção de objetos associados para <code>has_many</code> ou <code>has_and_belongs_to_many</code>.</li>
</ul>
<h3 id="single-table-inheritance-sti"><a class="anchorlink" href="#single-table-inheritance-sti">5 Single Table Inheritance (STI)</a></h3><p>Às vezes é desejável compartilhar atributos e comportamento entre <em>models</em>.
Vamos dizer que temos <em>models</em> <code>Car</code>, <code>Motorcycle</code> e <code>Bicycle</code>. Queremos
compartilhar os atributos de <code>color</code> e <code>price</code> e também alguns métodos para
estes atributos, mas ainda mantendo comportamentos específicos para cada um
deles, incluindo <em>controllers</em> separados.</p><p>Primeiro, vamos gerar o <em>model</em> de base, <code>Vehicle</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model vehicle <span class="nb">type</span>:string color:string price:decimal<span class="o">{</span>10.2<span class="o">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model vehicle type:string color:string price:decimal{10.2}
">Copy</button>
</div>
<p>Você notou que estamos adicionando um atributo <code>type</code>? Dado que todos os <em>models</em>
serão armazenados em uma única tabela, o Rails vai armazenar o nome do <em>model</em>
nesse atributo. No nosso exemplo, as possibilidades são <code>Car</code>, <code>Motorcycle</code> ou
<code>Bicycle</code>. STI não funciona sem um atributo <code>type</code> na tabela.</p><p>Em seguida, vamos gerar os três <em>models</em> <code>Car</code> que herdam de <code>Vehicle</code>. Para isso podemos
usar a opção <code>--parent=PARENT</code> que vai gerar um <em>model</em> que herda do "<em>parent</em>"
especificado e sem uma <em>migration</em> equivalente (dado que a tabela já existe).</p><p>Por exemplo, para gerar o <em>model</em> <code>Car</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model car <span class="nt">--parent</span><span class="o">=</span>Vehicle
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model car --parent=Vehicle
">Copy</button>
</div>
<p>O <em>model</em> gerado vai parecer com:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Car &lt; Vehicle
end
">Copy</button>
</div>
<p>Isso significa que todo o comportamento adicionado à classe <code>Vehicle</code> estará
disponível também na classe <code>Car</code>, incluindo as associações, métodos públicos,
etc.</p><p>Criar um carro vai armazená-lo na tabela <code>vehicles</code> e popular o atributo <code>type</code>
com o valor "<em>Car</em>":</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">color: </span><span class="s1">'Red'</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.create(color: 'Red', price: 10000)
">Copy</button>
</div>
<p>vai gerar o seguinte SQL:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"vehicles"</span> <span class="p">(</span><span class="nv">"type"</span><span class="p">,</span> <span class="nv">"color"</span><span class="p">,</span> <span class="nv">"price"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">,</span> <span class="s1">'Red'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="INSERT INTO &quot;vehicles&quot; (&quot;type&quot;, &quot;color&quot;, &quot;price&quot;) VALUES ('Car', 'Red', 10000)
">Copy</button>
</div>
<p>A <em>query</em> (consulta) por registros de carros vai buscar veiculos que
são do tipo <em>Car</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.all
">Copy</button>
</div>
<p>vai executar a seguinte <em>query</em>:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"vehicles"</span> <span class="k">WHERE</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="nv">"type"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT &quot;vehicles&quot;.* FROM &quot;vehicles&quot; WHERE &quot;vehicles&quot;.&quot;type&quot; IN ('Car')
">Copy</button>
</div>


        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua caso veja quaisquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na main do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch main.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">forum oficial do Ruby on Rails</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
  <div id="toggle">
    <img alt="dark theme icon" class="icon">
  </div>
</body>
</html>
