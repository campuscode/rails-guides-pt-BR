<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Associações Active Record — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Associações Active Record — Ruby on Rails Guides" />
  <meta name="description" content="Associações Active RecordEsse guia cobre os recursos de associação do Active Record.Após ler esse guia, você saberá: Como declarar associações entre models do Active Record. Como entender os vários tipos de associações Active Record. Como usar os métodos adicionados em seus models ao criar associações." />
  <meta property="og:description" content="Associações Active RecordEsse guia cobre os recursos de associação do Active Record.Após ler esse guia, você saberá: Como declarar associações entre models do Active Record. Como entender os vários tipos de associações Active Record. Como usar os métodos adicionados em seus models ao criar associações." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://stackoverflow.com/questions/tagged/ruby-on-rails">Peça por ajuda</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <div class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 Release Notes - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="6_0_release_notes.html">6.0 Release Notes - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Associações Active Record</h2><p>Esse guia cobre os recursos de associação do <em>Active Record</em>.</p><p>Após ler esse guia, você saberá:</p>
<ul>
<li>Como declarar associações entre <em>models</em> do <em>Active Record</em>.</li>
<li>Como entender os vários tipos de associações <em>Active Record</em>.</li>
<li>Como usar os métodos adicionados em seus <em>models</em> ao criar associações.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#por-que-associacoes-questionmark">Por Que Associações?</a></li>
<li>
<a href="#os-tipos-de-associacoes">Os Tipos de Associações</a>

<ul>
<li><a href="#a-associacao-belongs-to">A Associação <code>belongs_to</code></a></li>
<li><a href="#a-associacao-has-one">A associação <code>has_one</code></a></li>
<li><a href="#a-associacao-has-many">A Associação <code>has_many</code></a></li>
<li><a href="#a-associacao-has-many-through">A Associação <code>has_many :through</code></a></li>
<li><a href="#a-associacao-has-one-through">A Associação <code>has_one :through</code></a></li>
<li><a href="#a-associacao-has-and-belongs-to-many">A Associação <code>has_and_belongs_to_many</code></a></li>
<li><a href="#escolhendo-entre-belongs-to-and-has-one">Escolhendo entre <code>belongs_to</code> and <code>has_one</code></a></li>
<li><a href="#escolhendo-entre-has-many-through-e-has-and-belongs-to-many">Escolhendo entre <code>has_many :through</code> e <code>has_and_belongs_to_many</code></a></li>
<li><a href="#associacoes-polimorficas">Associações Polimórficas</a></li>
<li><a href="#self-joins">Self Joins</a></li>
</ul>
</li>
<li>
<a href="#dicas-truques-e-avisos">Dicas, Truques e Avisos</a>

<ul>
<li><a href="#controlando-o-caching">Controlando o <em>Caching</em></a></li>
<li><a href="#evitando-colisoes-de-nome">Evitando Colisões de Nome</a></li>
<li><a href="#atualizando-o-schema">Atualizando o <em>Schema</em></a></li>
<li><a href="#controlando-o-escopo-de-associacao">Controlando o Escopo de Associação</a></li>
<li><a href="#associacoes-bidirecionais">Associações Bidirecionais</a></li>
</ul>
</li>
<li>
<a href="#referencia-detalhada-das-associacoes">Referência Detalhada das Associações</a>

<ul>
<li><a href="#referencia-da-associacao-belongs-to">Referência da Associação <code>belongs_to</code></a></li>
<li><a href="#referencia-da-associacao-has-one">Referência da Associação <code>has_one</code></a></li>
<li><a href="#referencia-da-associacao-has-many">Referência da Associação <code>has_many</code></a></li>
<li><a href="#referencia-da-associacao-has-and-belongs-to-many">Referência da Associação <code>has_and_belongs_to_many</code></a></li>
<li><a href="#callbacks-de-associacao"><em>Callbacks</em> de Associação</a></li>
<li><a href="#association-extensions">Association Extensions</a></li>
</ul>
</li>
<li><a href="#single-table-inheritance">Single Table Inheritance</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="por-que-associacoes-questionmark"><a class="anchorlink" href="#por-que-associacoes-questionmark">1 Por Que Associações?</a></h3><p>Em Rails, uma <em>associação</em> é uma conexão entre dois <em>models</em> em <em>Active Record</em>.
Por que precisamos de associações entre <em>models</em>? Porque eles tornam as operações
comuns mais simples e fáceis de entender em seu código. Por exemplo, considere
uma aplicação Rails simples que inclua um <em>model</em> para autores e um <em>model</em> para
livros. Cada autor pode ter vários livros. Sem associações, as declarações do
<em>model</em> seriam assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5f88071275bf503b927e0d41410b0810">class Author &lt; ApplicationRecord
end

class Book &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5f88071275bf503b927e0d41410b0810">Copiar</button>
</div>
<p>Agora, suponha que queremos adicionar um novo livro para um autor existente.
Nós precisaríamos fazer algo assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e95b60877af05e96ffe9970070995411">@book = Book.create(published_at: Time.now, author_id: @author.id)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e95b60877af05e96ffe9970070995411">Copiar</button>
</div>
<p>Ou considere excluir um autor, garantindo que todos os seus livros serão
excluídos também:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
<span class="k">end</span>
<span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6dce44b900a703fd60462e549b15df6b">@books = Book.where(author_id: @author.id)
@books.each do |book|
  book.destroy
end
@author.destroy
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6dce44b900a703fd60462e549b15df6b">Copiar</button>
</div>
<p>Com as associações do <em>Active Record</em>, podemos otimizar essas - e outras -
operações declarando ao Rails que há uma conexão entre os dois <em>models</em>. Aqui
está o código revisado para configurar autores e livros:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9b7b0a30c4d51aa0754ce17fa2b5d3dd">class Author &lt; ApplicationRecord
  has_many :books, dependent: :destroy
end

class Book &lt; ApplicationRecord
  belongs_to :author
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9b7b0a30c4d51aa0754ce17fa2b5d3dd">Copiar</button>
</div>
<p>Com essa alteração, é mais fácil criar um novo livro para um autor específico:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-22db1419b9feb14fe45218ab6ac42a42">@book = @author.books.create(published_at: Time.now)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-22db1419b9feb14fe45218ab6ac42a42">Copiar</button>
</div>
<p>Excluir um autor e todos os seus livros é <strong>muito</strong> mais fácil:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e67096e4d91187fd9ed263988a635659">@author.destroy
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e67096e4d91187fd9ed263988a635659">Copiar</button>
</div>
<p>Para saber mais sobre os diferentes tipos de associações, leia a próxima seção
deste guia. Em seguida há algumas dicas e truques para trabalhar com associações
e, na sequência, uma referência completa dos métodos e opções para associações no
Rails.</p><h3 id="os-tipos-de-associacoes"><a class="anchorlink" href="#os-tipos-de-associacoes">2 Os Tipos de Associações</a></h3><p>O Rails suporta seis tipos de associações:</p>
<ul>
<li><code>belongs_to</code></li>
<li><code>has_one</code></li>
<li><code>has_many</code></li>
<li><code>has_many :through</code></li>
<li><code>has_one :through</code></li>
<li><code>has_and_belongs_to_many</code></li>
</ul>
<p>As associações são implementadas usando chamadas <em>macro-style</em>, para que você possa adicionar declarativamente recursos aos seus <em>models</em>. Por exemplo, ao declarar que um <em>model</em> <code>belongs_to</code> (pertence a outro), você instrui o Rails a manter as informações de <a href="https://pt.wikipedia.org/wiki/Chave_prim%C3%A1ria">Primary Key</a>-<a href="https://pt.wikipedia.org/wiki/Chave_estrangeira">Foreign Key</a> (Chave primária-Chave Estrangeira) entre instâncias dos dois <em>models</em>, e também obtém vários métodos úteis adicionados ao seu <em>model</em>.</p><p>No restante deste guia, você aprenderá como declarar e usar as várias formas de associação. Mas primeiro, uma rápida introdução para as situações em que cada tipo de associação é apropriada.</p><h4 id="a-associacao-belongs-to"><a class="anchorlink" href="#a-associacao-belongs-to">2.1 A Associação <code>belongs_to</code></a></h4><p>Uma associação <code>belongs_to</code> configura uma conexão um-para-um com outro <em>model</em>, de modo que cada instância do <em>model</em> declarante "pertença a" uma instância do outro <em>model</em>. Por exemplo, se sua aplicação incluir autores e livros, e cada livro pertencer a apenas um autor, você declarará o <em>model</em> do livro da seguinte maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d1bd533268a7213362ca7652f42f72c5">class Book &lt; ApplicationRecord
  belongs_to :author
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d1bd533268a7213362ca7652f42f72c5">Copiar</button>
</div>
<p><img src="images/association_basics/belongs_to.png" alt="Diagrama de Associação belongs_to"></p><div class="note"><p>as associações <code>belongs_to</code> <em>devem</em> usar o termo no singular. Se você usou o plural no exemplo acima para a associação <code>autor</code> no <em>model</em> <code>Livro</code> e tentou criar a instância com <code>Book.create(authors: @author)</code>, você seria informado de que existe uma "constante não inicializada <code>Book::Authors</code>". Isso ocorre porque o Rails deduz automaticamente o nome da classe a partir do nome da associação. Se o nome da associação estiver incorretamente no plural, a classe inferida também estará incorreta.</p></div><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-740dc79f7d93d2d5b6f3a151d1ff84e0">class CreateBooks &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-740dc79f7d93d2d5b6f3a151d1ff84e0">Copiar</button>
</div>
<h4 id="a-associacao-has-one"><a class="anchorlink" href="#a-associacao-has-one">2.2 A associação <code>has_one</code></a></h4><p>Uma associação <code>has_one</code> também estabelece uma conexão um-para-um com outro <em>model</em>, mas com semânticas um pouco diferentes (e consequências). Essa associação indica que cada instância de um <em>model</em> contém ou possui uma instância de outro <em>model</em>. Por exemplo, se cada fornecedor em sua aplicação possuir apenas uma conta, você vai declarar o <em>model</em> de fornecedor da seguinte maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f7d458a66a34152a3790a7cc7dd81d43">class Supplier &lt; ApplicationRecord
  has_one :account
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f7d458a66a34152a3790a7cc7dd81d43">Copiar</button>
</div>
<p><img src="images/association_basics/has_one.png" alt="Diagrama de Associação has_one"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b21cac0e06d0b5dcc0b33fcc1e8f5664">class CreateSuppliers &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b21cac0e06d0b5dcc0b33fcc1e8f5664">Copiar</button>
</div>
<p>Dependendo do caso de uso, também pode ser necessário criar um índice exclusivo e/ou
uma restrição de <em>foreign key</em> na coluna do fornecedor para a tabela de contas. Nesse
caso, a definição da coluna parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-40406877ad6e4841869cbe7decb5b7ad">create_table :accounts do |t|
  t.belongs_to :supplier, index: { unique: true }, foreign_key: true
  # ...
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-40406877ad6e4841869cbe7decb5b7ad">Copiar</button>
</div>
<h4 id="a-associacao-has-many"><a class="anchorlink" href="#a-associacao-has-many">2.3 A Associação <code>has_many</code></a></h4><p>Uma associação <code>has_many</code> indica uma conexão um-para-muitos com outro <em>model</em>. Você encontrará frequentemente essa associação no "outro lado" de uma associação <code>belongs_to</code>. Essa associação indica que cada instância do <em>model</em> possui zero ou mais instâncias de outro <em>model</em>. Por exemplo, em uma aplicação que contém autores e livros, o <em>model</em> do autor pode ser declarado assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-43a9908583a99381609fb0d6a7255512">class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-43a9908583a99381609fb0d6a7255512">Copiar</button>
</div>
<div class="note"><p>O nome do outro <em>model</em> é pluralizado ao declarar uma associação <code>has_many</code>.</p></div><p><img src="images/association_basics/has_many.png" alt="Diagrama de Assocação has_many"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e829156b8d20f1a03f508fe03e4ea4f9">class CreateAuthors &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e829156b8d20f1a03f508fe03e4ea4f9">Copiar</button>
</div>
<h4 id="a-associacao-has-many-through"><a class="anchorlink" href="#a-associacao-has-many-through">2.4 A Associação <code>has_many :through</code></a></h4><p>Uma associação <code>has_many :through</code> é frequentemente usada para estabelecer uma conexão muitos-para-muitos com outro <em>model</em>. Essa associação indica que o <em>model</em> declarado pode ser correspondido com zero ou mais instâncias de outro <em>model</em>, prosseguindo através (<em>through</em>) de um terceiro <em>model</em>. Por exemplo, considere uma prática médica em que os pacientes marcam consultas com médicos. As declarações de associação relevantes podem ter a seguinte aparência:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Physician</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:patients</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Appointment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:physician</span>
  <span class="n">belongs_to</span> <span class="ss">:patient</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:physicians</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-abba1b544292ca11c0d4e23a57098d3a">class Physician &lt; ApplicationRecord
  has_many :appointments
  has_many :patients, through: :appointments
end

class Appointment &lt; ApplicationRecord
  belongs_to :physician
  belongs_to :patient
end

class Patient &lt; ApplicationRecord
  has_many :appointments
  has_many :physicians, through: :appointments
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-abba1b544292ca11c0d4e23a57098d3a">Copiar</button>
</div>
<p><img src="images/association_basics/has_many_through.png" alt="Diagrama de Associação has_many :through"></p><p>A <em>migration</em> correspondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:physicians</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:patients</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d7e9f8df9dbfacabb93b8593ac1047dd">class CreateAppointments &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :physicians do |t|
      t.string :name
      t.timestamps
    end

    create_table :patients do |t|
      t.string :name
      t.timestamps
    end

    create_table :appointments do |t|
      t.belongs_to :physician
      t.belongs_to :patient
      t.datetime :appointment_date
      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d7e9f8df9dbfacabb93b8593ac1047dd">Copiar</button>
</div>
<p>O conjunto da junção dos <em>models</em> pode ser gerenciada através dos <a href="#referencia-da-associacao-has-many">métodos de associação <code>has_many</code></a>.
Por exemplo, se você atribuir:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">physician</span><span class="p">.</span><span class="nf">patients</span> <span class="o">=</span> <span class="n">patients</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cfb5142c15be7410720a1a190e69d0ab">physician.patients = patients
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cfb5142c15be7410720a1a190e69d0ab">Copiar</button>
</div>
<p>Em seguida, novos <em>models</em> de junção são criados automaticamente para os objetos recém-associados.
Se alguns que existiam anteriormente estão faltando agora, suas linhas de junção são excluídas automaticamente.</p><div class="warning"><p>A exclusão automática de <em>models</em> de junção é direta, nenhum <em>callback</em> de destruição é acionado.</p></div><p>A associação <code>has_many :through</code> também é útil para configurar "atalhos" através de associações aninhadas <code>has_many</code>. Por exemplo, se um documento possui muitas seções e uma seção com muitos parágrafos, você pode obter uma coleção simples de todos os parágrafos do documento. Você pode configurar dessa maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sections</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span><span class="p">,</span> <span class="ss">through: :sections</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Section</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:document</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paragraph</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:section</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-82c3a627c98aab7a9f756224f441aafd">class Document &lt; ApplicationRecord
  has_many :sections
  has_many :paragraphs, through: :sections
end

class Section &lt; ApplicationRecord
  belongs_to :document
  has_many :paragraphs
end

class Paragraph &lt; ApplicationRecord
  belongs_to :section
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-82c3a627c98aab7a9f756224f441aafd">Copiar</button>
</div>
<p>Com <code>through: :section</code> especificado, o Rails agora entenderá:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@document</span><span class="p">.</span><span class="nf">paragraphs</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7315498849b27b097188308c06c4dbd8">@document.paragraphs
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7315498849b27b097188308c06c4dbd8">Copiar</button>
</div>
<h4 id="a-associacao-has-one-through"><a class="anchorlink" href="#a-associacao-has-one-through">2.5 A Associação <code>has_one :through</code></a></h4><p>Uma Associação <code>has_one :through</code> estabelece uma conexão um-para-um com outro <em>model</em>. Essa associação indica
que o <em>model</em> declarante pode ser combinado com uma instância de outro <em>model</em>, prosseguindo através(<em>through</em>) de um terceiro <em>model</em>.
Por exemplo, se cada fornecedor tiver uma conta, e cada conta estiver associada a um histórico da conta, então o
<em>model</em> fornecedor poderia ficar assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span><span class="p">,</span> <span class="ss">through: :account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountHistory</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-43565ab7493d85ca664b347d7c07303c">class Supplier &lt; ApplicationRecord
  has_one :account
  has_one :account_history, through: :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  has_one :account_history
end

class AccountHistory &lt; ApplicationRecord
  belongs_to :account
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-43565ab7493d85ca664b347d7c07303c">Copiar</button>
</div>
<p><img src="images/association_basics/has_one_through.png" alt="has_one :through Association Diagram"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAccountHistories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:account_histories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:account</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:credit_rating</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-14e2009f89e5cde5575e4498c8c22e17">class CreateAccountHistories &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end

    create_table :account_histories do |t|
      t.belongs_to :account
      t.integer :credit_rating
      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-14e2009f89e5cde5575e4498c8c22e17">Copiar</button>
</div>
<h4 id="a-associacao-has-and-belongs-to-many"><a class="anchorlink" href="#a-associacao-has-and-belongs-to-many">2.6 A Associação <code>has_and_belongs_to_many</code></a></h4><p>Uma associação <code>has_and_belongs_to_many</code> cria uma conexão direta muitos-para-muitos com outro <em>model</em>, sem nenhum <em>model</em> intermediário. Por exemplo, se sua aplicação incluir conjuntos e peças, com cada conjunto tendo muitas peças e cada peça aparecendo em muitos conjuntos, você poderá declarar os <em>model</em> desta maneira:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-76373e53ba16cae6ab3dc14012c50e6b">class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-76373e53ba16cae6ab3dc14012c50e6b">Copiar</button>
</div>
<p><img src="images/association_basics/habtm.png" alt="has_and_belongs_to_many Association Diagram"></p><p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:assembly</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:part</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6e1781e4b47eb09b401c5b8a925d976d">class CreateAssembliesAndParts &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :assemblies do |t|
      t.string :name
      t.timestamps
    end

    create_table :parts do |t|
      t.string :part_number
      t.timestamps
    end

    create_table :assemblies_parts, id: false do |t|
      t.belongs_to :assembly
      t.belongs_to :part
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6e1781e4b47eb09b401c5b8a925d976d">Copiar</button>
</div>
<h4 id="escolhendo-entre-belongs-to-and-has-one"><a class="anchorlink" href="#escolhendo-entre-belongs-to-and-has-one">2.7 Escolhendo entre <code>belongs_to</code> and <code>has_one</code></a></h4><p>Se você deseja configurar um relacionamento um-para-um entre dois <em>models</em>, será necessário adicionar <code>belongs_to</code> para um e <code>has_one</code> ao outro. Como você sabe qual é qual?</p><p>A distinção é onde você coloca a <em>foreign key</em> (ela aparece na tabela para a classe que declara a associação <code>belongs_to</code>), mas você deve pensar um pouco no significado real dos dados também. O relacionamento <code>has_one</code> diz que um de algo é seu - isto é, que algo aponta para você. Por exemplo, faz mais sentido dizer que um fornecedor possui uma conta do que uma conta possui um fornecedor. Isso sugere que os relacionamentos corretos são assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-22196ea0ffab5a6c277b63eeefbad766">class Supplier &lt; ApplicationRecord
  has_one :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-22196ea0ffab5a6c277b63eeefbad766">Copiar</button>
</div>
<p>A <em>migration</em> correpondente parecerá assim:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:supplier_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:supplier_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bb2632372f3a8ed10196f12fe698756a">class CreateSuppliers &lt; ActiveRecord::Migration[5.2]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.bigint  :supplier_id
      t.string  :account_number
      t.timestamps
    end

    add_index :accounts, :supplier_id
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb2632372f3a8ed10196f12fe698756a">Copiar</button>
</div>
<div class="note"><p>O uso de <code>t.bigint :supplier_id</code> torna a nomeação da <em>foreign key</em> óbvia e explícita. Nas versões atuais do Rails, você pode abstrair esses detalhes de implementação usando <code>t.references :supplier</code>.</p></div><h4 id="escolhendo-entre-has-many-through-e-has-and-belongs-to-many"><a class="anchorlink" href="#escolhendo-entre-has-many-through-e-has-and-belongs-to-many">2.8 Escolhendo entre <code>has_many :through</code> e <code>has_and_belongs_to_many</code></a></h4><p>O Rails oferece duas maneiras diferentes de declarar um relacionamento muitos-para-muitos entre os <em>models</em>. A maneira mais simples é usar <code>has_and_belongs_to_many</code>, o que permite fazer a associação diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-89d0e8c9cae6a6848c4a133f6ec4d231">class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-89d0e8c9cae6a6848c4a133f6ec4d231">Copiar</button>
</div>
<p>A segunda maneira de declara um relacionamento muitos-para-muito é usar <code>has_many :through</code>. Isso faz uma associação de forma indireta, através de um <em>model</em> de junção:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:parts</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manifest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:assembly</span>
  <span class="n">belongs_to</span> <span class="ss">:part</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-98c9445181697a075d8f9412c5dbedbb">class Assembly &lt; ApplicationRecord
  has_many :manifests
  has_many :parts, through: :manifests
end

class Manifest &lt; ApplicationRecord
  belongs_to :assembly
  belongs_to :part
end

class Part &lt; ApplicationRecord
  has_many :manifests
  has_many :assemblies, through: :manifests
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-98c9445181697a075d8f9412c5dbedbb">Copiar</button>
</div>
<p>A regra mais simples é que você deve configurar um relacionamento <code>has_many :through</code> se precisar trabalhar com o <em>models</em> de relacionamento como uma entidade independente. Se você não precisar fazer nada com o <em>model</em> de relacionamento, pode ser mais simples configurar um relacionamento <code>has_and_belongs_to_many</code> (embora seja necessário lembrar de criar a tabela de junção no banco de dados).</p><p>Você deve usar <code>has_many :through</code> se precisar de validações, <em>callbacks</em> ou atributos extras no <em>join model</em>(modelo de junção).</p><h4 id="associacoes-polimorficas"><a class="anchorlink" href="#associacoes-polimorficas">2.9 Associações Polimórficas</a></h4><p>Uma mudança um pouco mais avançada nas associações é a <em>associação polimórfica</em>. Com associações polimórficas, um <em>model</em> pode pertencer a mais de um outro <em>model</em>, em uma única associação. Por exemplo, você pode ter um <em>model</em> de foto que pertença a um <em>model</em> de funcionário ou a um <em>model</em> de produto. Veja como isso pode ser declarado:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-adfc25b0e0d98d1a9a4257946608a2c8">class Picture &lt; ApplicationRecord
  belongs_to :imageable, polymorphic: true
end

class Employee &lt; ApplicationRecord
  has_many :pictures, as: :imageable
end

class Product &lt; ApplicationRecord
  has_many :pictures, as: :imageable
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-adfc25b0e0d98d1a9a4257946608a2c8">Copiar</button>
</div>
<p>Você pode pensar em uma declaração polimórfica <code>belongs_to</code> como uma configuração de interface que qualquer outro <em>model</em> pode usar. Em uma instância do <em>model</em> <code>Funcionário</code>, você pode recuperar uma coleção de fotos: <code>@employee.pictures</code>.</p><p>Da mesma forma, você pode recuperar <code>@product.pictures</code>.</p><p>Se você tem uma instância do <em>model</em> <code>Fotos</code>, você pode chegar ao seu pai via <code>@picture.imageable</code>. Para fazer isso funcionar, você precisa declarar uma coluna de <em>foreign key</em> e uma coluna de tipo no <em>model</em> que declara a interface polimórfica:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:imageable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:imageable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="p">[</span><span class="ss">:imageable_type</span><span class="p">,</span> <span class="ss">:imageable_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-de90a1e2afe7262aa9eac634723c4635">class CreatePictures &lt; ActiveRecord::Migration[5.2]
  def change
    create_table :pictures do |t|
      t.string  :name
      t.bigint  :imageable_id
      t.string  :imageable_type
      t.timestamps
    end

    add_index :pictures, [:imageable_type, :imageable_id]
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-de90a1e2afe7262aa9eac634723c4635">Copiar</button>
</div>
<p>Esta <em>migration</em> pode ser simplificada usando a forma de <code>t.references</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-24f9e89630fba1490887a3d35eff4b28">class CreatePictures &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :pictures do |t|
      t.string :name
      t.references :imageable, polymorphic: true
      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-24f9e89630fba1490887a3d35eff4b28">Copiar</button>
</div>
<p><img src="images/association_basics/polymorphic.png" alt="Diagrama de Associação Polimórfica"></p><h4 id="self-joins"><a class="anchorlink" href="#self-joins">2.10 Self Joins</a></h4><p>Ao projetar um modelo de dados, algumas vezes você encontrará um <em>model</em> que deve ter uma relação consigo mesmo. Por exemplo, você pode querer armazenar todos os funcionários em um único modelo de banco de dados, mas conseguir rastrear relacionamentos como entre gerente e subordinados. Essa situação pode ser modelada com associações <em>self-joining</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span>
                          <span class="ss">foreign_key: </span><span class="s2">"manager_id"</span>

  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f038e7683f658a59ebc1d81cafbff59f">class Employee &lt; ApplicationRecord
  has_many :subordinates, class_name: "Employee",
                          foreign_key: "manager_id"

  belongs_to :manager, class_name: "Employee", optional: true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f038e7683f658a59ebc1d81cafbff59f">Copiar</button>
</div>
<p>Com esta configuração, você pode recuperar <code>@employee.subordinates</code> e <code>@employee.manager</code>.</p><p>Em suas <em>migrations</em>/<em>schema</em>, você adicionará uma coluna de referências ao próprio <em>model</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateEmployees</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:employees</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:manager</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ab413408d5c23275677085a0ee860ecd">class CreateEmployees &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :employees do |t|
      t.references :manager
      t.timestamps
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ab413408d5c23275677085a0ee860ecd">Copiar</button>
</div>
<h3 id="dicas-truques-e-avisos"><a class="anchorlink" href="#dicas-truques-e-avisos">3 Dicas, Truques e Avisos</a></h3><p>Segue algumas coisas que você deve saber para utilizar as associações do <em>Active Record</em> nas suas aplicações Rails:</p>
<ul>
<li>Controlando o <em>caching</em>
</li>
<li>Evitando colisões de nome</li>
<li>Atualizando o <em>schema</em>
</li>
<li>Controlando o escopo de associação</li>
<li>Associações bidirecionais</li>
</ul>
<h4 id="controlando-o-caching"><a class="anchorlink" href="#controlando-o-caching">3.1 Controlando o <em>Caching</em></a></h4><p>Todos os métodos de associação são construídos em torno de <em>caching</em>, o que mantém o resultado da <em>query</em> mais recente disponível para operações futuras. O <em>cache</em> é até compartilhado entre métodos. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">author</span><span class="p">.</span><span class="nf">books</span>                 <span class="c1"># retorna *books* do banco de dados</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>            <span class="c1"># usa a versão salva em cache da busca por *books*</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span>          <span class="c1"># usa a versão salva em cache da busca por *books*</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4151afed4a22a86ec75d16164b08fda1">author.books                 # retorna *books* do banco de dados
author.books.size            # usa a versão salva em cache da busca por *books*
author.books.empty?          # usa a versão salva em cache da busca por *books*
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4151afed4a22a86ec75d16164b08fda1">Copiar</button>
</div>
<p>Mas e se você quiser recarregar o <em>cache</em>, porque pode haver alterações nos dados devido a outra parte da aplicação? Simplesmente chame <code>reload</code> na associação:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">author</span><span class="p">.</span><span class="nf">books</span>                 <span class="c1"># retorna *books* do banco de dados</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>            <span class="c1"># usa a versão salva em cache da busca por *books*</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">empty?</span>   <span class="c1"># descarta a resposta da busca salva em cache por *books*</span>
                             <span class="c1"># e volta a olhar para o banco de dados</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2ba0c091f8fa5c279b39cf65225cad48">author.books                 # retorna *books* do banco de dados
author.books.size            # usa a versão salva em cache da busca por *books*
author.books.reload.empty?   # descarta a resposta da busca salva em cache por *books*
                             # e volta a olhar para o banco de dados
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2ba0c091f8fa5c279b39cf65225cad48">Copiar</button>
</div>
<h4 id="evitando-colisoes-de-nome"><a class="anchorlink" href="#evitando-colisoes-de-nome">3.2 Evitando Colisões de Nome</a></h4><p>Não é possível usar simplesmente qualquer nome para suas associações. Considerando que ao criar uma associação adicionamos um método com o nome especificado ao <em>model</em>, é uma péssima ideia dar um nome para uma associação que já foi utilizado para um método de instância de <code>ActiveRecord::Base</code>. O método da associação sobrescreverá o método base e quebrará coisas. Por exemplo, <code>attributes</code> ou <code>connection</code> não são indicados como nomes para associações.</p><h4 id="atualizando-o-schema"><a class="anchorlink" href="#atualizando-o-schema">3.3 Atualizando o <em>Schema</em></a></h4><p>Associações são extremamente úteis, mas não são mágica. Você fica responsável por manter o <em>schema</em> do seu banco de dados de forma que corresponda às suas associações. Na prática, isto significa duas coisas, dependendo do tipo de associação que você criar. Para associações <code>belongs_to</code> você precisa criar chaves estrangeiras, e para associações <code>has_and_belongs_to_many</code> você precisa criar a tabela de junção (<em>join table</em>) apropriada.</p><h5 id="criando-chaves-estrangeiras-para-associacoes-belongs-to"><a class="anchorlink" href="#criando-chaves-estrangeiras-para-associacoes-belongs-to">3.3.1 Criando Chaves Estrangeiras para Associações <code>belongs_to</code></a></h5><p>Quando você declara uma associação <code>belongs_to</code>, você precisa criar as chaves estrangeiras apropriadas. Por exemplo, considere este <em>model</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bd3c4a3e5e399b9c64e76517037318e0">class Book &lt; ApplicationRecord
  belongs_to :author
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bd3c4a3e5e399b9c64e76517037318e0">Copiar</button>
</div>
<p>Esta declaração precisa do apoio de uma coluna de chave estrangeira apropriada na tabela <em>books</em>. Pra uma tabela recém criada, a migração pode parecer com isto:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span>   <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>     <span class="ss">:book_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9c75a242fbd8e99d62d50584d8ee42fe">class CreateBooks &lt; ActiveRecord::Migration[5.0]
  def change
    create_table :books do |t|
      t.datetime   :published_at
      t.string     :book_number
      t.references :author
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9c75a242fbd8e99d62d50584d8ee42fe">Copiar</button>
</div>
<p>Enquanto que para uma tabela existente, pode parecer com isto:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddAuthorToBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:author</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-77e5c1224e31bda0c3f7986bb9a9498f">class AddAuthorToBooks &lt; ActiveRecord::Migration[5.0]
  def change
    add_reference :books, :author
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-77e5c1224e31bda0c3f7986bb9a9498f">Copiar</button>
</div>
<div class="note"><p>Se você quiser <a href="/active_record_migrations.html#foreign-keys">impor integridade de referência no nível do banco de dados</a>, acrescente a opção <code>foreign_key: true</code> à declaração da coluna <em>'reference'</em> acima.</p></div><h5 id="criando-tabelas-de-juncao-para-associacoes-has-and-belongs-to-many"><a class="anchorlink" href="#criando-tabelas-de-juncao-para-associacoes-has-and-belongs-to-many">3.3.2 Criando Tabelas de Junção para Associações <code>has_and_belongs_to_many</code></a></h5><p>Se você criar uma associação <code>has_and_belongs_to_many</code>, você precisa criar a tabela de junção de forma explícita. A menos que o nome da tabela de junção seja especificado de forma explícita através da opção <code>:join_table</code>, o <em>Active Record</em> cria o nome utilizando a ordem léxica dos nomes de classe. Dessa forma, uma junção entre os <em>models</em> <em>author</em> e <em>book</em> resulta no nome de tabela de junção padrão <em>"authors_books"</em> porque "a" precede "b" na ordenação léxica.</p><div class="warning"><p>A precedência entre nomes de <em>model</em> é calculada usando o operador <code>&lt;=&gt;</code> para <code>String</code>. Isto significa que se as <em>strings</em> têm comprimentos diferentes, e as <em>strings</em> são iguais quando comparados até o menor comprimento, então a <em>string</em> mais comprido recebe uma precedência léxica maior que o mais curto. Por exemplo, à primeira vista você pode esperar que as tabelas <em>"paper_boxes"</em> e <em>"papers"</em> resultem numa tabela de junção chamada <em>"papers_paper_boxes"</em> por causa do comprimento do nome <em>"paper_boxes"</em>, mas em vez disso cria-se a tabela de junção chamada <em>"paper_boxes_papers"</em> (porque o <em>underscore</em> '_' recebe um peso lexicográfico <em>menor</em> que 's' em <em>encodings</em> comuns).</p></div><p>Independente do nome, você deve gerar manualmente a tabela de junção com a migração apropriada. Por exemplo, considere estas associações:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2e0ce7883c108cc931292c93d6f501ba">class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2e0ce7883c108cc931292c93d6f501ba">Copiar</button>
</div>
<p>Elas precisam do apoio de uma migração para criar a tabela <code>assemblies_parts</code>. Esta tabela deve ser criada sem a chave primária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:part_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:assembly_id</span>
    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:part_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2311add81bf7b95e9d3575c7963a3a9b">class CreateAssembliesPartsJoinTable &lt; ActiveRecord::Migration[5.2]
  def change
    create_table :assemblies_parts, id: false do |t|
      t.bigint :assembly_id
      t.bigint :part_id
    end

    add_index :assemblies_parts, :assembly_id
    add_index :assemblies_parts, :part_id
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2311add81bf7b95e9d3575c7963a3a9b">Copiar</button>
</div>
<p>Passamos <code>id: false</code> para <code>create_table</code> porque esta tabela não representa um <em>model</em>. Isto é necessário para a associação funcionar de maneira correta. Se você observar qualquer comportamento estranho numa associação <code>has_and_belongs_to_many</code> como IDs de <em>model</em> corrompidos, ou exceções envolvendo IDs em conflito, é provável que você tenha esquecido deste detalhe.</p><p>Você também pode utilizar o método <code>create_join_table</code></p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-00457acaa01369894e156ecf76af1cfd">class CreateAssembliesPartsJoinTable &lt; ActiveRecord::Migration[5.0]
  def change
    create_join_table :assemblies, :parts do |t|
      t.index :assembly_id
      t.index :part_id
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-00457acaa01369894e156ecf76af1cfd">Copiar</button>
</div>
<h4 id="controlando-o-escopo-de-associacao"><a class="anchorlink" href="#controlando-o-escopo-de-associacao">3.4 Controlando o Escopo de Associação</a></h4><p>Por padrão, associações procuram por objetos apenas dentro do escopo do <em>model</em> atual. Isto é relevante quando você declara <em>models</em> do <em>Active Record</em> dentro de um módulo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c53bd950328e7e5b4b60da8dfa25249c">module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account
    end

    class Account &lt; ApplicationRecord
      belongs_to :supplier
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c53bd950328e7e5b4b60da8dfa25249c">Copiar</button>
</div>
<p>Isto funciona corretamente, porque tanto a classe <code>Supplier</code> quanto a classe <code>Account</code> são definidas dentro do mesmo escopo. Mas o próximo exemplo <strong>não</strong> funcionará, porque <code>Supplier</code> e <code>Account</code> são definidos em escopos diferentes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-27e4195528b36e874419e249ebd3b6b0">module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account
    end
  end

  module Billing
    class Account &lt; ApplicationRecord
      belongs_to :supplier
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-27e4195528b36e874419e249ebd3b6b0">Copiar</button>
</div>
<p>Para associar um <em>model</em> a outro <em>model</em> em um <em>namespace</em> diferente, você deve especificar o nome completo da classe na declaração da sua associação:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Billing::Account"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Business::Supplier"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0757f6384b59b3586eaac65c1c524076">module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account,
        class_name: "MyApplication::Billing::Account"
    end
  end

  module Billing
    class Account &lt; ApplicationRecord
      belongs_to :supplier,
        class_name: "MyApplication::Business::Supplier"
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0757f6384b59b3586eaac65c1c524076">Copiar</button>
</div>
<h4 id="associacoes-bidirecionais"><a class="anchorlink" href="#associacoes-bidirecionais">3.5 Associações Bidirecionais</a></h4><p>É normal para associações funcionar em duas direções, necessitando de declarações em dois <em>models</em> diferentes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9d86c8094afbd50c90283a2a1033c14f">class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :author
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9d86c8094afbd50c90283a2a1033c14f">Copiar</button>
</div>
<p>O <em>Active Record</em> tentará identificar automaticamente que estes dois <em>models</em> compartilham uma associação bidirecional baseando-se no nome da associação. Desta forma, o <em>Active Record</em> carregará apenas uma cópia do objeto <code>Author</code>, tornando sua aplicação mais eficiente e evitando dados inconsistentes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">first_name</span> <span class="c1"># =&gt; true</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">first_name</span> <span class="c1"># =&gt; true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-901ac3be88e559118cae9c9c30b3f714">a = Author.first
b = a.books.first
a.first_name == b.author.first_name # =&gt; true
a.first_name = 'David'
a.first_name == b.author.first_name # =&gt; true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-901ac3be88e559118cae9c9c30b3f714">Copiar</button>
</div>
<p>O <em>Active Record</em> tem suporte a identificação automática para a maioria das associações com nomes padrão. Contudo, o <em>Active Record</em> não identificará automaticamente associações bidirecionais que contém um escopo ou qualquer uma das opções abaixo:</p>
<ul>
<li><code>:through</code></li>
<li><code>:foreign_key</code></li>
</ul>
<p>Por exemplo, considere as declarações de <em>models</em> abaixo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1d67709c1df53d08b2622134d8f3f6a1">class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1d67709c1df53d08b2622134d8f3f6a1">Copiar</button>
</div>
<p>O <em>Active Record</em> não reconhecerá mais a associação bidirecional:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span> <span class="c1"># =&gt; true</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span> <span class="c1"># =&gt; false</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-97b99457fa6db4759374a9728c2afe97">a = Author.first
b = a.books.first
a.first_name == b.writer.first_name # =&gt; true
a.first_name = 'David'
a.first_name == b.writer.first_name # =&gt; false
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-97b99457fa6db4759374a9728c2afe97">Copiar</button>
</div>
<p>O <em>Active Record</em> fornece a opção <code>:inverse_of</code> para declarar associações bidirecionais de forma explícita:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: </span><span class="s1">'writer'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3e9e79650677109b1a9257d01059743b">class Author &lt; ApplicationRecord
  has_many :books, inverse_of: 'writer'
end

class Book &lt; ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3e9e79650677109b1a9257d01059743b">Copiar</button>
</div>
<p>Ao incluir a opção <code>:inverse_of</code> na declaração da associação <code>has_many</code>, o <em>Active Record</em> agora reconhecerá a associação bidirecional:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span> <span class="c1"># =&gt; true</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span> <span class="c1"># =&gt; true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-676d06311a30c810f9cdd6d222ba9d85">a = Author.first
b = a.books.first
a.first_name == b.writer.first_name # =&gt; true
a.first_name = 'David'
a.first_name == b.writer.first_name # =&gt; true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-676d06311a30c810f9cdd6d222ba9d85">Copiar</button>
</div>
<h3 id="referencia-detalhada-das-associacoes"><a class="anchorlink" href="#referencia-detalhada-das-associacoes">4 Referência Detalhada das Associações</a></h3><p>As seções seguintes dão detalhes sobre cada tipo de associação, incluindo os métodos que elas adicionam e as opções que você pode usar quando declarar uma associação.</p><h4 id="referencia-da-associacao-belongs-to"><a class="anchorlink" href="#referencia-da-associacao-belongs-to">4.1 Referência da Associação <code>belongs_to</code></a></h4><p>A associação <code>belongs_to</code> cria uma relação um-para-um com outro <em>model</em>. Em termos de banco de dados, esta associação diz que esta classe contém a chave estrangeira. Se a outra classe contém a chave estrangeira, então você deve utilizar <code>has_one</code> no lugar.</p><h5 id="metodos-adicionados-por-belongs-to"><a class="anchorlink" href="#metodos-adicionados-por-belongs-to">4.1.1 Métodos Adicionados por <code>belongs_to</code></a></h5><p>Quando você declara uma associação <code>belongs_to</code>, a classe declarada ganha automaticamente 6 métodos relacionados à associação:</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
</ul>
<p>Em todos esses métodos, <code>association</code> é substituída pelo <em>symbol</em> passado como primeiro argumento para <code>belongs_to</code>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5561c75c45a89b32f2c1ca36e3ae9991">class Book &lt; ApplicationRecord
  belongs_to :author
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5561c75c45a89b32f2c1ca36e3ae9991">Copiar</button>
</div>
<p>Cada instância do <em>model</em> <code>Book</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">author</span>
<span class="n">author</span><span class="o">=</span>
<span class="n">build_author</span>
<span class="n">create_author</span>
<span class="n">create_author!</span>
<span class="n">reload_author</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-09157c6fa272f271538e39d2d93c6b69">author
author=
build_author
create_author
create_author!
reload_author
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-09157c6fa272f271538e39d2d93c6b69">Copiar</button>
</div>
<div class="note"><p>Quando inicializar uma associação <code>has_one</code> ou <code>belongs_to</code> nova você deve usar o prefixo <code>build_</code> para montar a associação, ao invés do método <code>association.build</code> que seria usado para associações <code>has_many</code> ou <code>has_and_belongs_to_many</code>. Para criar uma associação nova, use o prefixo <code>create_</code>.</p></div><h6 id="metodos-adicionados-por-belongs-to-association"><a class="anchorlink" href="#metodos-adicionados-por-belongs-to-association">4.1.1.1 <code>association</code></a></h6><p>O método <code>association</code> retorna o objeto associado, se ele existir. Se nenhum objeto associado for encontrado, ele retorna <code>nil</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9d6a21a9348360a894cdcd46389ffeab">@author = @book.author
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9d6a21a9348360a894cdcd46389ffeab">Copiar</button>
</div>
<p>Se o objeto associado já foi retornado pelo banco de dados para este objeto, a versão em <em>cache</em> será retornada. Para sobrescrever este comportamento (e forçar a leitura do banco de dados), chame <code>#reload_association</code> no objeto pai.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reload_author</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-323636b9253ea6b5f66f0684600c6562">@author = @book.reload_author
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-323636b9253ea6b5f66f0684600c6562">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-belongs-to-association-associate"><a class="anchorlink" href="#metodos-adicionados-por-belongs-to-association-associate">4.1.1.2 <code>association=(associate)</code></a></h6><p>O método <code>association=</code> atribui um objeto associado a este objeto. Por trás das cenas, isto significa extrair a chave primária do objeto associado e atribuir à chave estrangeira do objeto o mesmo valor.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="vi">@author</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c1ccb4460a616928b700c37493514895">@book.author = @author
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c1ccb4460a616928b700c37493514895">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-belongs-to-build-association-attributes"><a class="anchorlink" href="#metodos-adicionados-por-belongs-to-build-association-attributes">4.1.1.3 <code>build_association(attributes = {})</code></a></h6><p>O método <code>build_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, mas o objeto associado ainda <em>não será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">build_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                                  <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a81314f170e949704e5ad33094a2ee73">@author = @book.build_author(author_number: 123,
                                  author_name: "John Doe")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a81314f170e949704e5ad33094a2ee73">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-belongs-to-create-association-attributes"><a class="anchorlink" href="#metodos-adicionados-por-belongs-to-create-association-attributes">4.1.1.4 <code>create_association(attributes = {})</code></a></h6><p>O método <code>create_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, e, uma vez que ele passe por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                                   <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7dd04a6d3eb9f62f940769b554f962d9">@author = @book.create_author(author_number: 123,
                                   author_name: "John Doe")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7dd04a6d3eb9f62f940769b554f962d9">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-belongs-to-create-association-bang-attributes"><a class="anchorlink" href="#metodos-adicionados-por-belongs-to-create-association-bang-attributes">4.1.1.5 <code>create_association!(attributes = {})</code></a></h6><p>Faz a mesma coisa que o método <code>create_association</code> acima, mas retorna <code>ActiveRecord::RecordInvalid</code> se o registro for inválido.</p><h5 id="opcoes-para-belongs-to"><a class="anchorlink" href="#opcoes-para-belongs-to">4.1.2 Opções para <code>belongs_to</code></a></h5><p>Enquanto o Rails utiliza padrões inteligentes que funcionarão bem pra maior parte das situações, pode haver momentos onde você quer customizar o comportamento da referência à associação <code>belongs_to</code>. Estas customizações podem ser realizadas facilmente ao passar opções e blocos de escopo quando você cria a associação. Por exemplo, esta associação utiliza duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span><span class="p">,</span>
    <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-53a38d854bed2c9beece78b2f007d9c6">class Book &lt; ApplicationRecord
  belongs_to :author, touch: :books_updated_at,
    counter_cache: true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-53a38d854bed2c9beece78b2f007d9c6">Copiar</button>
</div>
<p>A associação <code>belongs_to</code> tem suporte a estas opções:</p>
<ul>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:primary_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:polymorphic</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
<li><code>:optional</code></li>
</ul>
<h6 id="opcoes-para-belongs-to-autosave"><a class="anchorlink" href="#opcoes-para-belongs-to-autosave">4.1.2.1 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opcoes-para-belongs-to-class-name"><a class="anchorlink" href="#opcoes-para-belongs-to-class-name">4.1.2.2 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para passar o nome do <em>model</em>. Por exemplo, se um <em>book</em> pertence a um <em>author</em>, mas o nome de fato do <em>model</em> contendo <em>authors</em> é <code>Patron</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-21d87c2a5f0f404a9b558a80e5b4519c">class Book &lt; ApplicationRecord
  belongs_to :author, class_name: "Patron"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-21d87c2a5f0f404a9b558a80e5b4519c">Copiar</button>
</div>
<h6 id="opcoes-para-belongs-to-counter-cache"><a class="anchorlink" href="#opcoes-para-belongs-to-counter-cache">4.1.2.3 <code>:counter_cache</code></a></h6><p>A opção <code>:counter_cache</code> pode ser usada para tornar a busca pela quantidade de objetos que pertencem à associação mais eficiente. Considere estes <em>models</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8110d228118e9d1d9d0012b0123bd072">class Book &lt; ApplicationRecord
  belongs_to :author
end
class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8110d228118e9d1d9d0012b0123bd072">Copiar</button>
</div>
<p>Com estas declarações, pedir o valor de <code>@author.books.size</code> requer fazer uma chamada para o banco de dados para realizar uma consulta <code>COUNT(*)</code>. Para evitar esta chamada, você pode adicionar um cache de contagem ao <em>model</em> <em>pertencente</em> ao outro:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-878747d2e2317e4ecf35bbd8d03193f3">class Book &lt; ApplicationRecord
  belongs_to :author, counter_cache: true
end
class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-878747d2e2317e4ecf35bbd8d03193f3">Copiar</button>
</div>
<p>Com esta declaração, o Rails manterá o valor do <em>cache</em> atualizado, e aí retornará esse valor em resposta ao método <code>size</code>.</p><p>Embora a opção <code>:counter_cache</code> seja especificada no <em>model</em> que inclui a
declaração <code>belongs_to</code>, a coluna de fato deve ser adicionada ao <em>model</em>
<em>associado</em> (<code>has_many</code>). No caso acima, você precisaria adicionar uma coluna
com nome <code>books_count</code> ao <em>model</em> <code>Author</code>.</p><p>Você pode sobrescrever o nome padrão da coluna ao especificar um nome de coluna
customizado na declaração de <code>counter_cache</code> ao invés de especificar <code>true</code>. Por
exemplo, para usar <code>count_of_books</code> ao invés de <code>books_count</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: :count_of_books</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5a555e85d0d7aea1c197d63944cc6c4b">class Book &lt; ApplicationRecord
  belongs_to :author, counter_cache: :count_of_books
end
class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5a555e85d0d7aea1c197d63944cc6c4b">Copiar</button>
</div>
<div class="note"><p>Você só precisa especificar a opção <code>:counter_cache</code> no lado <code>belongs_to</code>
da associação.</p></div><p>Colunas de contagem de <em>cache</em> são adicionadas à lista de atributos de leitura do <em>model</em> contendo a associação através de <code>attr_readonly</code>.</p><h6 id="opcoes-para-belongs-to-dependent"><a class="anchorlink" href="#opcoes-para-belongs-to-dependent">4.1.2.4 <code>:dependent</code></a></h6><p>Se você configurar a opção <code>:dependent</code> para:</p>
<ul>
<li>
<code>:destroy</code>, quando o objeto for destruído, o método <code>destroy</code> será chamado nos
seus objetos associados.</li>
<li>
<code>:delete</code>, quando o objeto for destruído, todos os objetos associados serão
deletados diretamente do banco de dados sem chamar o método <code>destroy</code>.</li>
</ul>
<div class="warning"><p>Você não deve especificar esta opção numa associação <code>belongs_to</code> que estiver conectada com uma associação <code>has_many</code> com outra classe. Isto pode resultar em registros órfãos no seu banco de dados.</p></div><h6 id="opcoes-para-belongs-to-foreign-key"><a class="anchorlink" href="#opcoes-para-belongs-to-foreign-key">4.1.2.5 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna usada para armazenar a chave estrangeira no <em>model</em> é o nome da associação com o sufixo <code>_id</code> adicionado. A opção <code>:foreign_key</code> permite que você atribua o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span><span class="p">,</span>
                        <span class="ss">foreign_key: </span><span class="s2">"patron_id"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-342dafdab5dc7a94fc31a5bf6d0f3b74">class Book &lt; ApplicationRecord
  belongs_to :author, class_name: "Patron",
                        foreign_key: "patron_id"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-342dafdab5dc7a94fc31a5bf6d0f3b74">Copiar</button>
</div>
<div class="info"><p>Em todo caso, o Rails não criará colunas de chave estrangeira para você. Você precisa defini-las de forma explícita como parte das suas migrações</p></div><h6 id="opcoes-para-belongs-to-primary-key"><a class="anchorlink" href="#opcoes-para-belongs-to-primary-key">4.1.2.6 <code>:primary_key</code></a></h6><p>Por convenção, o Rails presume que a coluna <code>id</code> é usada para armazenar a chave
primária de suas tabelas. A opção <code>:primary_key</code> permite especificar uma coluna
diferente para isto.</p><p>Por exemplo, dada uma tabela <code>users</code> com <code>guid</code> como chave primária. Se quisermos que uma tabela <code>todos</code> separada guarde a chave estrangeira <code>user_id</code> na coluna <code>guid</code>, então podemos usar <code>primary_key</code> para realizar isto desta forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s1">'guid'</span> <span class="c1"># primary key is guid and not id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="s1">'guid'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bbec0334f63e28d89337105a40ef5c05">class User &lt; ApplicationRecord
  self.primary_key = 'guid' # primary key is guid and not id
end

class Todo &lt; ApplicationRecord
  belongs_to :user, primary_key: 'guid'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bbec0334f63e28d89337105a40ef5c05">Copiar</button>
</div>
<p>Quando executamos <code>@user.todos.create</code> então o registro <code>@todo</code> terá seu valor
<code>user_id</code> como o valor <code>guid</code> de <code>@user</code>.</p><h6 id="opcoes-para-belongs-to-inverse-of"><a class="anchorlink" href="#opcoes-para-belongs-to-inverse-of">4.1.2.7 <code>:inverse_of</code></a></h6><p>A opção <code>:inverse_of</code> específica o nome da associação <code>has_many</code> ou <code>has_one</code> que é o inverso desta associação definida.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6f273de9dccde506909dacb60c9e113e">class Author &lt; ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book &lt; ApplicationRecord
  belongs_to :author, inverse_of: :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6f273de9dccde506909dacb60c9e113e">Copiar</button>
</div>
<h6 id="polymorphic"><a class="anchorlink" href="#polymorphic">4.1.2.8 <code>:polymorphic</code></a></h6><p>Passar <code>true</code> para a opção <code>:polymorphic</code> indica que esta é uma associação polimórfica. Associações polimórficas foram discutidas com detalhes <a href="#associacoes-polimorficas">anteriormente neste guia</a>.</p><h6 id="opcoes-para-belongs-to-touch"><a class="anchorlink" href="#opcoes-para-belongs-to-touch">4.1.2.9 <code>:touch</code></a></h6><p>Se você configurar a opção <code>:touch</code> como <code>true</code>, então o <em>timestamp</em> <code>updated_at</code> ou <code>updated_on</code> no objeto associado será configurado com a hora atual quando este objeto for salvo ou destruído:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-35c9c79b804269cc4889c2091b4d9017">class Book &lt; ApplicationRecord
  belongs_to :author, touch: true
end

class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-35c9c79b804269cc4889c2091b4d9017">Copiar</button>
</div>
<p>Neste caso, salvar ou destruir um <em>book</em> atualizará o <em>timestamp</em> no <em>author</em> associado. Você também pode especificar um <em>timestamp</em> particular para atualizar:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f31ca2d5a228a335ba3d8cf6923a0ee4">class Book &lt; ApplicationRecord
  belongs_to :author, touch: :books_updated_at
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f31ca2d5a228a335ba3d8cf6923a0ee4">Copiar</button>
</div>
<h6 id="opcoes-para-belongs-to-validate"><a class="anchorlink" href="#opcoes-para-belongs-to-validate">4.1.2.10 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>true</code>, então os objetos associados serão validados quando você salvar este objeto. Por padrão, este valor é <code>false</code>: objetos associados não serão validados quando este objeto for salvo.</p><h6 id="optional"><a class="anchorlink" href="#optional">4.1.2.11 <code>:optional</code></a></h6><p>Se você configurar a opção <code>:optional</code> como <code>true</code>, então a presença do objeto
associado não será validada. Por padrão, esta opção está configurada como
<code>false</code>.</p><h5 id="escopos-para-belongs-to"><a class="anchorlink" href="#escopos-para-belongs-to">4.1.3 Escopos para <code>belongs_to</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>belongs_to</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8345b21ec33c5c3b65011ef4fc77b66a">class Book &lt; ApplicationRecord
  belongs_to :author, -&gt; { where active: true }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8345b21ec33c5c3b65011ef4fc77b66a">Copiar</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h6 id="escopos-para-belongs-to-where"><a class="anchorlink" href="#escopos-para-belongs-to-where">4.1.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c276f6cfd836afbb7fc074e7a2de06da">class Book &lt; ApplicationRecord
  belongs_to :author, -&gt; { where active: true }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c276f6cfd836afbb7fc074e7a2de06da">Copiar</button>
</div>
<h6 id="escopos-para-belongs-to-includes"><a class="anchorlink" href="#escopos-para-belongs-to-includes">4.1.3.2 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas de forma adiantada quando esta associação for utilizada. Por exemplo, considere estes models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6bda185c3d52e130f21c259f4306ae5a">class Chapter &lt; ApplicationRecord
  belongs_to :book
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6bda185c3d52e130f21c259f4306ae5a">Copiar</button>
</div>
<p>Se você consulta <em>authors</em> com frequência diretamente de <em>chapters</em> (<code>@chapter.book.author</code>), então você pode deixar o seu código relativamente mais eficiente ao incluir <em>authors</em> na associação de <em>chapters</em> para <em>books</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:author</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a49ac5a9149c19f58bacda7cb4ead280">class Chapter &lt; ApplicationRecord
  belongs_to :book, -&gt; { includes :author }
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a49ac5a9149c19f58bacda7cb4ead280">Copiar</button>
</div>
<div class="note"><p>Não há necessidade de usar <code>includes</code> para associações imediatas - isto é, se você tem <code>Book belongs_to :author</code>, então o <em>author</em> será carregado de forma adiantada automaticamente quando necessário.</p></div><h6 id="escopos-para-belongs-to-readonly"><a class="anchorlink" href="#escopos-para-belongs-to-readonly">4.1.3.3 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então o objeto associado só terá acesso de leitura quando retornado através da associação.</p><h6 id="escopos-para-belongs-to-select"><a class="anchorlink" href="#escopos-para-belongs-to-select">4.1.3.4 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é usada para consultar dados sobre objeto associado. Por padrão, o Rails retorna todas as colunas.</p><div class="info"><p>If you use the <code>select</code> method on a <code>belongs_to</code> association, you should also set the <code>:foreign_key</code> option to guarantee the correct results.</p></div><h5 id="referencia-da-associacao-belongs-to-todos-os-objetos-associados-existem-questionmark"><a class="anchorlink" href="#referencia-da-associacao-belongs-to-todos-os-objetos-associados-existem-questionmark">4.1.4 Todos os Objetos Associados Existem?</a></h5><p>Você pode ver se os objetos associados existem ao utilizar o método <code>association.nil?</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No author found for this book"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a07e7874141c174c43376b44fd4be738">if @book.author.nil?
  @msg = "No author found for this book"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a07e7874141c174c43376b44fd4be738">Copiar</button>
</div>
<h5 id="referencia-da-associacao-belongs-to-quando-os-objetos-sao-salvos-questionmark"><a class="anchorlink" href="#referencia-da-associacao-belongs-to-quando-os-objetos-sao-salvos-questionmark">4.1.5 Quando os Objetos são Salvos?</a></h5><p>Atribuir um objeto a uma associação <code>belongs_to</code> <em>não</em> salva o objeto automaticamente. Isto também não salva o objeto associado.</p><h4 id="referencia-da-associacao-has-one"><a class="anchorlink" href="#referencia-da-associacao-has-one">4.2 Referência da Associação <code>has_one</code></a></h4><p>A associação <code>has_one</code> cria uma relação um-para-um com outro <em>model</em>. Em termos do banco de dados, esta associação diz que a outra classe contém a chave estrangeira. Se esta classe contém a chave estrangeira, então você deve utilizar <code>belongs_to</code>.</p><h5 id="metodos-adicionados-por-has-one"><a class="anchorlink" href="#metodos-adicionados-por-has-one">4.2.1 Métodos Adicionados por <code>has_one</code></a></h5><p>Quando você declara uma associação <code>has_one</code>, a classe declarada ganha automaticamente 6 métodos relacionados à associação:</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
</ul>
<p>Em todos estes métodos, <code>association</code> será substituído pelo <em>symbol</em> passado como primeiro argumento para <code>has_one</code>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b0db33ce989763da7b25ca33fedb6416">class Supplier &lt; ApplicationRecord
  has_one :account
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b0db33ce989763da7b25ca33fedb6416">Copiar</button>
</div>
<p>Cada instância do <em>model</em> <code>Supplier</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">account</span>
<span class="n">account</span><span class="o">=</span>
<span class="n">build_account</span>
<span class="n">create_account</span>
<span class="n">create_account!</span>
<span class="n">reload_account</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-80c95fb1ef3a5b286431c3c2784fd290">account
account=
build_account
create_account
create_account!
reload_account
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-80c95fb1ef3a5b286431c3c2784fd290">Copiar</button>
</div>
<div class="note"><p>Quando inicializar uma nova associação <code>has_one</code> ou <code>belongs_to</code> você deve usar o prefixo <code>build_</code> para montar a associação, ao invés do método <code>association.build</code> que seria usado para associações <code>has_many</code> ou <code>has_and_belongs_to_many</code>. Para criar uma, use o prefixo <code>create_</code>.</p></div><h6 id="metodos-adicionados-por-has-one-association"><a class="anchorlink" href="#metodos-adicionados-por-has-one-association">4.2.1.1 <code>association</code></a></h6><p>O método <code>association</code> retorna o objeto associado, se ele existir. Se nenhum objeto associado for encontrado, ele retorna <code>nil</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f1abfaaa2cd9aec325e96dae68431bcc">@account = @supplier.account
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f1abfaaa2cd9aec325e96dae68431bcc">Copiar</button>
</div>
<p>Se o objeto associado já foi retornado pelo banco de dados para este objeto, a versão em <em>cache</em> será retornada. Para sobrescrever este comportamento (e forçar a leitura do banco de dados), chame <code>#reload_association</code> no objeto pai.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">reload_account</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0381725eb78a89a6e192001581ae3bad">@account = @supplier.reload_account
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0381725eb78a89a6e192001581ae3bad">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-one-association-associate"><a class="anchorlink" href="#metodos-adicionados-por-has-one-association-associate">4.2.1.2 <code>association=(associate)</code></a></h6><p>O método <code>association=</code> atribui um objeto associado a este objeto. Por trás das cenas, isto significa extrair a chave primária do objeto associado e atribuir à chave estrangeira do objeto o mesmo valor.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span> <span class="o">=</span> <span class="vi">@account</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-76f2cb25a7ed6b9c07d5a9574acf9f07">@supplier.account = @account
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-76f2cb25a7ed6b9c07d5a9574acf9f07">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-one-build-association-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-one-build-association-attributes">4.2.1.3 <code>build_association(attributes = {})</code></a></h6><p>O método <code>build_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, mas o objeto associado ainda <em>não será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1b266d91e4266b31bb7350f2da793606">@account = @supplier.build_account(terms: "Net 30")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1b266d91e4266b31bb7350f2da793606">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-one-create-association-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-one-create-association-attributes">4.2.1.4 <code>create_association(attributes = {})</code></a></h6><p>O método <code>create_association</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com os atributos passados, e a ligação através da chave estrangeira deste objeto será configurada, e, uma vez que ele passe por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-54195eea89a9085144cb2f2b2305a0e6">@account = @supplier.create_account(terms: "Net 30")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-54195eea89a9085144cb2f2b2305a0e6">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-one-create-association-bang-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-one-create-association-bang-attributes">4.2.1.5 <code>create_association!(attributes = {})</code></a></h6><p>Faz a mesma coisa que o método <code>create_association</code> acima, mas retorna <code>ActiveRecord::RecordInvalid</code> se o registro for inválido.</p><h5 id="opcoes-para-has-one"><a class="anchorlink" href="#opcoes-para-has-one">4.2.2 Opções para <code>has_one</code></a></h5><p>Embora o Rails utilize padrões inteligentes que funcionarão bem na maioria das situações, pode haver momentos onde você queira customizar o comportamento da referência da associação <code>has_one</code>. Tais customizações podem ser feitas facilmente ao passar opções quando você cria a associação. Por exemplo, esta associação usa duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span><span class="p">,</span> <span class="ss">dependent: :nullify</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0452a8f2e8fac84b9912dcb39d8fc59f">class Supplier &lt; ApplicationRecord
  has_one :account, class_name: "Billing", dependent: :nullify
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0452a8f2e8fac84b9912dcb39d8fc59f">Copiar</button>
</div>
<p>A associação <code>has_one</code> tem suporte para estas opções:</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="opcoes-para-has-one-as"><a class="anchorlink" href="#opcoes-para-has-one-as">4.2.2.1 <code>:as</code></a></h6><p>Configurar a opção <code>:as</code> indica que esta é uma associação polimórfica. Associações polimórficas foram discutidas com detalhes <a href="#associacoes-polimorficas">anteriormente neste guia</a>.</p><h6 id="opcoes-para-has-one-autosave"><a class="anchorlink" href="#opcoes-para-has-one-autosave">4.2.2.2 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opcoes-para-has-one-class-name"><a class="anchorlink" href="#opcoes-para-has-one-class-name">4.2.2.3 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para fornecer o nome do <em>model</em>. Por exemplo, se um <em>supplier</em> tem uma <em>account</em>, mas o nome de fato do <em>model</em> contendo <em>accounts</em> é <code>Billing</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fb02ad00176825d389c7f2235abddb57">class Supplier &lt; ApplicationRecord
  has_one :account, class_name: "Billing"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fb02ad00176825d389c7f2235abddb57">Copiar</button>
</div>
<h6 id="opcoes-para-has-one-dependent"><a class="anchorlink" href="#opcoes-para-has-one-dependent">4.2.2.4 <code>:dependent</code></a></h6><p>Controla o que acontece com o objeto associado quando o dono dele é destruído:</p>
<ul>
<li>
<code>:destroy</code> faz com que o objeto associado também seja destruído</li>
<li>
<code>:delete</code> faz com que o objeto associado seja deletado diretamente do banco de dados (dessa forma os <em>callbacks</em> não serão executados)</li>
<li>
<code>:nullify</code> faz com que a chave estrangeira seja configurada para <code>NULL</code>. Colunas polimórficas também recebem <code>NULL</code> em associações polimórficas. <em>Callbacks</em> não são executados.</li>
<li>
<code>:restrict_with_exception</code> faz com que a exceção <code>ActiveRecord::DeleteRestrictionError</code> seja retornada se houver um registro associado</li>
<li>
<code>:restrict_with_error</code> adiciona um erro ao dono se já houver um objeto associado</li>
</ul>
<p>É necessário não configurar ou deixar a opção <code>:nullify</code> para estas associações
que tem a restrição <code>NOT NULL</code> no banco de dados. Se você não configurar
<code>dependent</code> para estas associações você não poderá mudar o objeto associado
porque a chave estrangeira do objeto associado inicial será configurada para o
valor <code>NULL</code> que não é permitido.</p><h6 id="opcoes-para-has-one-foreign-key"><a class="anchorlink" href="#opcoes-para-has-one-foreign-key">4.2.2.5 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna usada para guardar a chave estrangeira no outro model tem o nome deste <em>model</em> com o sufixo <code>_id</code> adicionado. A opção <code>:foreign_key</code> permite que você configure o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"supp_id"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-830ab33b559babcb514f41e6d7afc049">class Supplier &lt; ApplicationRecord
  has_one :account, foreign_key: "supp_id"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-830ab33b559babcb514f41e6d7afc049">Copiar</button>
</div>
<div class="info"><p>Em todo caso, o Rails não criará colunas de chave estrangeira para você. Você precisa defini-las de forma explícita como parte das suas migrações.</p></div><h6 id="opcoes-para-has-one-inverse-of"><a class="anchorlink" href="#opcoes-para-has-one-inverse-of">4.2.2.6 <code>:inverse_of</code></a></h6><p>A opção <code>:inverse_of</code> específica o nome da associação <code>has_many</code> ou <code>has_one</code> que é o inverso desta associação definida.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">inverse_of: :supplier</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">inverse_of: :account</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-32efd7a7a8d5c280e0270bc0e79df212">class Supplier &lt; ApplicationRecord
  has_one :account, inverse_of: :supplier
end

class Account &lt; ApplicationRecord
  belongs_to :supplier, inverse_of: :account
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-32efd7a7a8d5c280e0270bc0e79df212">Copiar</button>
</div>
<h6 id="opcoes-para-has-one-primary-key"><a class="anchorlink" href="#opcoes-para-has-one-primary-key">4.2.2.7 <code>:primary_key</code></a></h6><p>Por convenção, o Rails presume que a coluna <code>id</code> é usada para armazenar a chave primária de suas tabelas. A opção <code>:primary_key</code> permite especificar uma coluna diferente para isto.</p><h6 id="opcoes-para-has-one-source"><a class="anchorlink" href="#opcoes-para-has-one-source">4.2.2.8 <code>:source</code></a></h6><p>A opção <code>:source</code> especifica a associação fonte para uma associação <code>has_one :through</code>.</p><h6 id="opcoes-para-has-one-source-type"><a class="anchorlink" href="#opcoes-para-has-one-source-type">4.2.2.9 <code>:source_type</code></a></h6><p>A opção <code>:source_type</code> especifica o tipo da associação fonte para uma associação <code>has_one :through</code> que procede através de uma associação polimórfica.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span><span class="p">,</span> <span class="ss">through: :format</span><span class="p">,</span> <span class="ss">source: :dust_jacket</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Hardback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">DustJacket</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-69a4945ea08ad97d6b17108a593e01cd">class Book &lt; ApplicationRecord
  has_one :format, polymorphic: true
  has_one :dust_jacket, through: :format, source: :dust_jacket, source_type: "Hardback"
end

class Paperback &lt; ApplicationRecord; end

class Hardback &lt; ApplicationRecord
  has_one :dust_jacket
end

class DustJacket &lt; ApplicationRecord; end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-69a4945ea08ad97d6b17108a593e01cd">Copiar</button>
</div>
<h6 id="opcoes-para-has-one-through"><a class="anchorlink" href="#opcoes-para-has-one-through">4.2.2.10 <code>:through</code></a></h6><p>A opção <code>:through</code> específica um <em>model</em> de junção para realizar uma <em>query</em> através dele. Associações <code>has_one :through</code> foram discutidas com detalhes <a href="#a-associacao-has-one-through">anteriormente neste guia</a>.</p><h6 id="opcoes-para-has-one-touch"><a class="anchorlink" href="#opcoes-para-has-one-touch">4.2.2.11 <code>:touch</code></a></h6><p>Se você configurar a opção <code>:touch</code> como <code>true</code>, então o <em>timestamp</em> <code>updated_at</code> ou <code>updated_on</code> no objeto associado será configurado com a hora atual quando este objeto for salvo ou destruído:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-16b33bf6c3b66d0e044f9133e16c487c">class Supplier &lt; ApplicationRecord
  has_one :account, touch: true
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-16b33bf6c3b66d0e044f9133e16c487c">Copiar</button>
</div>
<p>Neste caso, salvar ou destruir um <em>supplier</em> atualizará o <em>timestamp</em> na <em>account</em> associada. Você também pode especificar um <em>timestamp</em> particular para atualizar:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: :suppliers_updated_at</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9fff453980d69705217522a71de8faad">class Supplier &lt; ApplicationRecord
  has_one :account, touch: :suppliers_updated_at
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9fff453980d69705217522a71de8faad">Copiar</button>
</div>
<h6 id="opcoes-para-has-one-validate"><a class="anchorlink" href="#opcoes-para-has-one-validate">4.2.2.12 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>true</code>, então os objetos associados serão validados quando você salvar este objeto. Por padrão, este valor é <code>false</code>: objetos associados não serão validados quando este objeto for salvo.</p><h5 id="escopos-para-has-one"><a class="anchorlink" href="#escopos-para-has-one">4.2.3 Escopos para <code>has_one</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>has_one</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-84e1ff68480f03f2dbeadbee84ada6ca">class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { where active: true }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-84e1ff68480f03f2dbeadbee84ada6ca">Copiar</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h6 id="escopos-para-has-one-where"><a class="anchorlink" href="#escopos-para-has-one-where">4.2.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-df9de841eaadb592060e992c5e6f4747">class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { where "confirmed = 1" }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-df9de841eaadb592060e992c5e6f4747">Copiar</button>
</div>
<h6 id="escopos-para-has-one-includes"><a class="anchorlink" href="#escopos-para-has-one-includes">4.2.3.2 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas de forma adiantada quando esta associação for utilizada. Por exemplo, considere estes models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-659ad60a3854449ff635cd1e81065114">class Supplier &lt; ApplicationRecord
  has_one :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative &lt; ApplicationRecord
  has_many :accounts
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-659ad60a3854449ff635cd1e81065114">Copiar</button>
</div>
<p>Se você consulta <em>representatives</em> diretamente de <em>suppliers</em> com frequência (<code>@supplier.account.representative</code>), então você pode tornar seu código relativamente mais eficiente ao incluir <em>representatives</em> na associação de <em>suppliers</em> para <em>accounts</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:representative</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-476422d7d8ab249d9a1d851d756f3452">class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { includes :representative }
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative &lt; ApplicationRecord
  has_many :accounts
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-476422d7d8ab249d9a1d851d756f3452">Copiar</button>
</div>
<h6 id="escopos-para-has-one-readonly"><a class="anchorlink" href="#escopos-para-has-one-readonly">4.2.3.3 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então o objeto associado só terá acesso de leitura quando retornado através da associação.</p><h6 id="escopos-para-has-one-select"><a class="anchorlink" href="#escopos-para-has-one-select">4.2.3.4 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é usada para consultar dados sobre objeto associado. Por padrão, o Rails retorna todas as colunas.</p><h5 id="referencia-da-associacao-has-one-todos-os-objetos-associados-existem-questionmark"><a class="anchorlink" href="#referencia-da-associacao-has-one-todos-os-objetos-associados-existem-questionmark">4.2.4 Todos os Objetos Associados Existem?</a></h5><p>Você pode ver se os objetos associados existem ao utilizar o método <code>association.nil?</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No account found for this supplier"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5a938ead50db8cd609012a9e58c9aa37">if @supplier.account.nil?
  @msg = "No account found for this supplier"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5a938ead50db8cd609012a9e58c9aa37">Copiar</button>
</div>
<h5 id="referencia-da-associacao-has-one-quando-os-objetos-sao-salvos-questionmark"><a class="anchorlink" href="#referencia-da-associacao-has-one-quando-os-objetos-sao-salvos-questionmark">4.2.5 Quando os Objetos são Salvos?</a></h5><p>Quando você atribui um objeto a uma associação <code>has_one</code>, este objeto será salvo automaticamente (para atualizar sua chave estrangeira). Além disso, qualquer objeto substituído também será salvo automaticamente, porque sua chave estrangeira também irá mudar.</p><p>Se qualquer uma destas operações de escrita falharem devido a erros de validação, então a atribuição retornará <code>false</code> e a atribuição em si será cancelada.</p><p>Se o objeto pai (o que declarar a associação <code>has_one</code>) não for salvo (isto é, <code>new_record?</code> retorna <code>true</code>) então os objetos filhos não serão salvos. Eles serão salvos automaticamente quando o objeto pai for salvo.</p><p>Se você quiser atribuir um objeto para uma associação <code>has_one</code> sem salvar o objeto, utilize o método <code>build_association</code>.</p><h4 id="referencia-da-associacao-has-many"><a class="anchorlink" href="#referencia-da-associacao-has-many">4.3 Referência da Associação <code>has_many</code></a></h4><p>A associação <code>has_many</code> cria uma relação um-para-muitos com outro <em>model</em>. Em termos do banco de dados, esta associação diz que a outra classe terá uma chave estrangeira que se refere a instâncias desta classe.</p><h5 id="metodos-adicionados-por-has-many"><a class="anchorlink" href="#metodos-adicionados-por-has-many">4.3.1 Métodos Adicionados por <code>has_many</code></a></h5><p>Quando você declara uma associação <code>has_many</code>, a classe declarada ganha automaticamente 17 métodos relacionados à associação:</p>
<ul>
<li><code>collection</code></li>
<li><code>collection&lt;&lt;(object, ...)</code></li>
<li><code>collection.delete(object, ...)</code></li>
<li><code>collection.destroy(object, ...)</code></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><code>collection.clear</code></li>
<li><code>collection.empty?</code></li>
<li><code>collection.size</code></li>
<li><code>collection.find(...)</code></li>
<li><code>collection.where(...)</code></li>
<li><code>collection.exists?(...)</code></li>
<li><code>collection.build(attributes = {}, ...)</code></li>
<li><code>collection.create(attributes = {})</code></li>
<li><code>collection.create!(attributes = {})</code></li>
<li><code>collection.reload</code></li>
</ul>
<p>Em todos estes métodos, <code>collection</code> será substituído pelo <em>symbol</em> passado como primeiro argumento para <code>has_many</code>, e <code>collection_singular</code> será substituído pela versão em singular daquele <em>symbol</em>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-58ec1ee7e9feb9189d94219d03383ffc">class Author &lt; ApplicationRecord
  has_many :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-58ec1ee7e9feb9189d94219d03383ffc">Copiar</button>
</div>
<p>Cada instância do <em>model</em> <code>Author</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">books</span>
<span class="n">books</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">book_ids</span>
<span class="n">book_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">books</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">books</span><span class="p">.</span><span class="nf">size</span>
<span class="n">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a97bd758b97908aa16b914e9b9e408a5">books
books&lt;&lt;(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a97bd758b97908aa16b914e9b9e408a5">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection">4.3.1.1 <code>collection</code></a></h6><p>O método <code>collection</code> retorna uma <em>Relation</em> de todos os objetos associados. Se não há objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-918f49ba770996490d516aa5aea00706">@books = @author.books
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-918f49ba770996490d516aa5aea00706">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-object"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-object">4.3.1.2 <code>collection&lt;&lt;(object, ...)</code></a></h6><p>O método <code>collection&lt;&lt;</code> acrescenta um ou mais objetos à coleção configurando a chave estrangeira deles como a chave primária do <em>model</em> pai.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="vi">@book1</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-75eff535445f2b2111c731223cf4b679">@author.books &lt;&lt; @book1
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-75eff535445f2b2111c731223cf4b679">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-delete-object"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-delete-object">4.3.1.3 <code>collection.delete(object, ...)</code></a></h6><p>O método <code>collection.delete</code> remove um ou mais objetos da coleção ao configurar a chave estrangeira deles como <code>NULL</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-129a02e83c56abd21f9c4d68a9b7d7fd">@author.books.delete(@book1)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-129a02e83c56abd21f9c4d68a9b7d7fd">Copiar</button>
</div>
<div class="warning"><p>Além disso, os objetos serão destruídos se estiverem associados com <code>dependent: :destroy</code>, e deletados se estiverem associados com <code>dependent: :delete_all</code>.</p></div><h6 id="metodos-adicionados-por-has-many-collection-destroy-object"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-destroy-object">4.3.1.4 <code>collection.destroy(object, ...)</code></a></h6><p>O método <code>collection.destroy</code> remove um ou mais objetos da coleção executando <code>destroy</code> em cada objeto.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d7e624587bbc855e3c3dca50a28b1505">@author.books.destroy(@book1)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d7e624587bbc855e3c3dca50a28b1505">Copiar</button>
</div>
<div class="warning"><p>Os objetos <em>sempre</em> serão removidos do banco de dados, ignorando a opção <code>:dependent</code>.</p></div><h6 id="metodos-adicionados-por-has-many-collection-objects"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-objects">4.3.1.5 <code>collection=(objects)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos fornecidos, ao adicionar e deletar da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="metodos-adicionados-por-has-many-collection-singular-ids"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-singular-ids">4.3.1.6 <code>collection_singular_ids</code></a></h6><p>O método <code>collection_singular_ids</code> retorna um <em>array</em> de <em>ids</em> dos objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_ids</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">book_ids</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-14aca1f4510905f1114b559b49f0f3a9">@book_ids = @author.book_ids
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-14aca1f4510905f1114b559b49f0f3a9">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-singular-ids-ids"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-singular-ids-ids">4.3.1.7 <code>collection_singular_ids=(ids)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos identificados pelo valor das chaves primárias fornecidas, adicionando e deletando da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="metodos-adicionados-por-has-many-collection-clear"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-clear">4.3.1.8 <code>collection.clear</code></a></h6><p>O método <code>collection.clear</code> remove todos os objetos da coleção de acordo com a estratégia especificada pela opção <code>dependent</code>. Se nenhuma opção for especificada, ele segue a estratégia padrão. A estratégia padrão para associações <code>has_many :through</code> é <code>delete_all</code>, e para associações <code>has_many</code> é configurar as chaves estrangeiras como <code>NULL</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">clear</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a1e87de34a2a105e4aaa156118884cca">@author.books.clear
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a1e87de34a2a105e4aaa156118884cca">Copiar</button>
</div>
<div class="warning"><p>Objetos serão deletados se eles forem associados com <code>dependent: :destroy</code>,
assim como <code>dependent: :delete_all</code>.</p></div><h6 id="metodos-adicionados-por-has-many-collection-empty-questionmark"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-empty-questionmark">4.3.1.9 <code>collection.empty?</code></a></h6><p>O método <code>collection.empty?</code> retorna <code>true</code> se a coleção não contiver nenhum objeto associado.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  No Books Found
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a53e60dc7007a79464ef1f08031a154a">&lt;% if @author.books.empty? %&gt;
  No Books Found
&lt;% end %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a53e60dc7007a79464ef1f08031a154a">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-size"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-size">4.3.1.10 <code>collection.size</code></a></h6><p>O método <code>collection.size</code> retorna o número de objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_count</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ff97a380d96f46bc9b8af024a587c8a6">@book_count = @author.books.size
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ff97a380d96f46bc9b8af024a587c8a6">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-find"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-find">4.3.1.11 <code>collection.find(...)</code></a></h6><p>O método <code>collection.find</code> procura objetos dentro da coleção. Ele utiliza a mesma sintaxe e opções que
<a href="https://api.rubyonrails.org/v6.0.3.4/classes/ActiveRecord/FinderMethods.html#method-i-find"><code>ActiveRecord::Base.find</code></a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0027b836207da7f4534749cf258bc130">@available_book = @author.books.find(1)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0027b836207da7f4534749cf258bc130">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-where"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-where">4.3.1.12 <code>collection.where(...)</code></a></h6><p>O método <code>collection.where</code> procura objetos dentro da coleção com base nas condições fornecidas mas os objetos serão carregados apenas quando necessário (<em>lazy loading</em>) significando que o banco de dados é consultado apenas quando os objetos são acessados.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">available: </span><span class="kp">true</span><span class="p">)</span> <span class="c1"># No query yet</span>
<span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@available_books</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Now the database will be queried</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9c124afe56baec21c4ea6abdbbf081a6">@available_books = @author.books.where(available: true) # No query yet
@available_book = @available_books.first # Now the database will be queried
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9c124afe56baec21c4ea6abdbbf081a6">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-exists-questionmark"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-exists-questionmark">4.3.1.13 <code>collection.exists?(...)</code></a></h6><p>O método <code>collection.exists?</code> confere se um objeto que atende às condições fornecidas
existe na coleção. Ele usa a mesma sintaxe e opções que
<a href="https://api.rubyonrails.org/v6.0.3.4/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>ActiveRecord::Base.exists?</code></a>.</p><h6 id="metodos-adicionados-por-has-many-collection-build-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-build-attributes">4.3.1.14 <code>collection.build(attributes = {}, ...)</code></a></h6><p>O método <code>collection.build</code> retorna apenas um objeto ou um <em>array</em> de objetos. Os objetos serão instanciados com base nos atributos passados para o método e será criada uma ligação através de chaves estrangeiras, mas os objetos associados <em>não</em> serão salvos ainda.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                                <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-70a04ba346c8d79d737aed55ea19cdd3">@book = @author.books.build(published_at: Time.now,
                                book_number: "A12345")

@books = @author.books.build([
  { published_at: Time.now, book_number: "A12346" },
  { published_at: Time.now, book_number: "A12347" }
])
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-70a04ba346c8d79d737aed55ea19cdd3">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-create-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-create-attributes">4.3.1.15 <code>collection.create(attributes = {})</code></a></h6><p>O método <code>collection.create</code> retorna um objeto ou um <em>array</em> de novos objetos do tipo associado. Os objetos serão instanciados com base nos atributos que foram passados para o método, e uma ligação será criada através de uma chave estrangeira, e, uma vez que estes objetos passem por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                                 <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6f941adfb55e31f9fc8872ed54530ff2">@book = @author.books.create(published_at: Time.now,
                                 book_number: "A12345")

@books = @author.books.create([
  { published_at: Time.now, book_number: "A12346" },
  { published_at: Time.now, book_number: "A12347" }
])
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6f941adfb55e31f9fc8872ed54530ff2">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-many-collection-create-bang-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-create-bang-attributes">4.3.1.16 <code>collection.create!(attributes = {})</code></a></h6><p>Faz o mesmo que <code>collection.create</code> acima, mas retorna <code>ActiveRecord::RecordInvalid</code> se o dado for inválido.</p><h6 id="metodos-adicionados-por-has-many-collection-reload"><a class="anchorlink" href="#metodos-adicionados-por-has-many-collection-reload">4.3.1.17 <code>collection.reload</code></a></h6><p>O método <code>collection.reload</code> retorna uma <em>Relation</em> de todos os objetos associados, forçando uma leitura do banco de dados. Se não houver objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-be8369011d220cea7afc4278902cf420">@books = @author.books.reload
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-be8369011d220cea7afc4278902cf420">Copiar</button>
</div>
<h5 id="opcoes-para-has-many"><a class="anchorlink" href="#opcoes-para-has-many">4.3.2 Opções para <code>has_many</code></a></h5><p>Embora o Rails utilize padrões inteligentes que funcionarão bem na maioria das situações, pode haver momentos onde você queira customizar o comportamento da referência da associação <code>has_many</code>. Tais customizações podem ser feitas facilmente ao passar opções quando você cria a associação. Por exemplo, esta associação usa duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :delete_all</span><span class="p">,</span> <span class="ss">validate: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cd2404dc0febd30830e48f779599767e">class Author &lt; ApplicationRecord
  has_many :books, dependent: :delete_all, validate: false
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cd2404dc0febd30830e48f779599767e">Copiar</button>
</div>
<p>A associação <code>has_many</code> tem suporte para estas opções:</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="opcoes-para-has-many-as"><a class="anchorlink" href="#opcoes-para-has-many-as">4.3.2.1 <code>:as</code></a></h6><p>Configurar a opção <code>:as</code> indica que esta é uma associação polimórfica, como discutido <a href="#associacoes-polimorficas">anteriomente neste guia</a>.</p><h6 id="opcoes-para-has-many-autosave"><a class="anchorlink" href="#opcoes-para-has-many-autosave">4.3.2.2 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opcoes-para-has-many-class-name"><a class="anchorlink" href="#opcoes-para-has-many-class-name">4.3.2.3 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para fornecer o nome do <em>model</em>. Por exemplo, se um <em>author</em> tem muitos <em>books</em>, mas o nome de fato do <em>model</em> contendo <em>books</em> é <code>Transaction</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Transaction"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6b72fb7f5c3868939043ac8451841b31">class Author &lt; ApplicationRecord
  has_many :books, class_name: "Transaction"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6b72fb7f5c3868939043ac8451841b31">Copiar</button>
</div>
<h6 id="opcoes-para-has-many-counter-cache"><a class="anchorlink" href="#opcoes-para-has-many-counter-cache">4.3.2.4 <code>:counter_cache</code></a></h6><p>Esta opção pode ser utilizada para configurar um <code>:counter_cache</code> personalizado. Você só precisa desta opção quando você personalizar o nome do seu <code>:counter_cache</code> na <a href="#opcoes-para-belongs-to">associação belongs_to</a>.</p><h6 id="dependent"><a class="anchorlink" href="#dependent">4.3.2.5 <code>:dependent</code></a></h6><p>Controla o que acontece com os objetos associados quando o dono deles é destruído:</p>
<ul>
<li>
<code>:destroy</code> faz com que todos os objetos associados também sejam destruídos</li>
<li>
<code>:delete_all</code> faz com que todos os objetos associados sejam deletados diretamente do banco de dados (dessa forma os <em>callbacks</em> não serão executados)</li>
<li>
<code>:nullify</code> faz com que a chave estrangeira seja configurada para <code>NULL</code>. Colunas polimórficas também recebem <code>NULL</code> em associações polimórficas. <em>Callbacks</em> não são executados.</li>
<li>
<code>:restrict_with_exception</code> faz com a exceção <code>ActiveRecord::DeleteRestrictionError</code> seja retornada se houverem objetos associados</li>
<li>
<code>:restrict_with_error</code> adiciona um erro ao objeto dono se houverem objetos associados</li>
</ul>
<p>As opções <code>:destroy</code> e <code>:delete_all</code> também afetam a semântica dos métodos <code>collection.delete</code> e <code>collection=</code> fazendo com que eles destruam objetos associados ao removê-los da coleção.</p><h6 id="opcoes-para-has-many-foreign-key"><a class="anchorlink" href="#opcoes-para-has-many-foreign-key">4.3.2.6 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna usada para guardar a chave estrangeira no outro model tem o nome deste <em>model</em> com o sufixo <code>_id</code> adicionado. A opção <code>:foreign_key</code> permite que você configure o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"cust_id"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-00f0b39ee94dd35dba707593beb46542">class Author &lt; ApplicationRecord
  has_many :books, foreign_key: "cust_id"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-00f0b39ee94dd35dba707593beb46542">Copiar</button>
</div>
<div class="info"><p>Em todo caso, o Rails não criará colunas de chave estrangeira para você. Você precisa defini-las de forma explícita como parte das suas migrações.</p></div><h6 id="inverse-of"><a class="anchorlink" href="#inverse-of">4.3.2.7 <code>:inverse_of</code></a></h6><p>A opção <code>:inverse_of</code> específica o nome da associação <code>has_many</code> ou <code>has_one</code> que é o inverso desta associação definida.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-479e520cdab2da794fa932aae0b8a292">class Author &lt; ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book &lt; ApplicationRecord
  belongs_to :author, inverse_of: :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-479e520cdab2da794fa932aae0b8a292">Copiar</button>
</div>
<h6 id="primary-key"><a class="anchorlink" href="#primary-key">4.3.2.8 <code>:primary_key</code></a></h6><p>Por convenção, o Rails presume que a coluna <code>id</code> é usada para armazenar a chave primária de suas tabelas. A opção <code>:primary_key</code> permite especificar uma coluna diferente para isto.</p><p>Digamos que a tabela <code>users</code> tenha <code>id</code> como chave primária mas também tem uma
coluna <code>guid</code>. O requerimento é que a tabela <code>todos</code> deve guardar o valor da
coluna <code>guid</code> como chave estrangeria e não o valor de <code>id</code>. Podemos fazer isto
desta forma:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:todos</span><span class="p">,</span> <span class="ss">primary_key: :guid</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-adc5d140598bf2c372f9ce4b7f651bda">class User &lt; ApplicationRecord
  has_many :todos, primary_key: :guid
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-adc5d140598bf2c372f9ce4b7f651bda">Copiar</button>
</div>
<p>Agora ao executar <code>@todo = @user.todos.create</code> o valor de <code>user_id</code> no
registro <code>@todo</code> será o valor <code>guid</code> de <code>@user</code>.</p><h6 id="opcoes-para-has-many-source"><a class="anchorlink" href="#opcoes-para-has-many-source">4.3.2.9 <code>:source</code></a></h6><p>A opção <code>:source</code> especifica a associação fonte para uma associação <code>has_many :through</code>. Você só precisa utilizar esta opção se não for possível inferir o nome da associação fonte automaticamente.</p><h6 id="opcoes-para-has-many-source-type"><a class="anchorlink" href="#opcoes-para-has-many-source-type">4.3.2.10 <code>:source_type</code></a></h6><p>A opção <code>:source_type</code> especifica o tipo da associação fonte para uma associação <code>has_many :through</code> que procede através de uma associação polimórfica.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:paperbacks</span><span class="p">,</span> <span class="ss">through: :books</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Paperback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-30b181529e561e1253eb7b4bf17d7a4f">class Author &lt; ApplicationRecord
  has_many :books
  has_many :paperbacks, through: :books, source: :format, source_type: "Paperback"
end

class Book &lt; ApplicationRecord
  has_one :format, polymorphic: true
end

class Hardback &lt; ApplicationRecord; end
class Paperback &lt; ApplicationRecord; end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-30b181529e561e1253eb7b4bf17d7a4f">Copiar</button>
</div>
<h6 id="opcoes-para-has-many-through"><a class="anchorlink" href="#opcoes-para-has-many-through">4.3.2.11 <code>:through</code></a></h6><p>A opção <code>:through</code> específica um <em>model</em> de junção para realizar uma <em>query</em> através dele. Associações <code>has_many :through</code> fornecem uma maneira de implementar relações muitos-para-muitos, como discutido <a href="#a-associacao-has-many-through">anteriormente neste guia</a>.</p><h6 id="opcoes-para-has-many-validate"><a class="anchorlink" href="#opcoes-para-has-many-validate">4.3.2.12 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>false</code>, então os objetos associados não serão validados quando você salvar este objeto. Por padrão, este valor é <code>true</code>: objetos associados serão validados quando este objeto for salvo.</p><h5 id="escopos-para-has-many"><a class="anchorlink" href="#escopos-para-has-many">4.3.3 Escopos para <code>has_many</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>has_many</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">processed: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7c9d6250625645c433e4cfaf0790346c">class Author &lt; ApplicationRecord
  has_many :books, -&gt; { where processed: true }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7c9d6250625645c433e4cfaf0790346c">Copiar</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h6 id="escopos-para-has-many-where"><a class="anchorlink" href="#escopos-para-has-many-where">4.3.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-54700a44c868ba5b584617639bbda669">class Author &lt; ApplicationRecord
  has_many :confirmed_books, -&gt; { where "confirmed = 1" },
    class_name: "Book"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-54700a44c868ba5b584617639bbda669">Copiar</button>
</div>
<p>Você também pode especificar condições através de um <em>hash</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">confirmed: </span><span class="kp">true</span> <span class="p">},</span>
                              <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c6c5e01d504970887d473d8d5e065599">class Author &lt; ApplicationRecord
  has_many :confirmed_books, -&gt; { where confirmed: true },
                              class_name: "Book"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c6c5e01d504970887d473d8d5e065599">Copiar</button>
</div>
<p>Se você utilizar uma opção no estilo <em>hash</em>, então a criação de dados através desta associação terá o escopo limitado automaticamente utilizando o <em>hash</em>. Neste caso, utilizar <code>@author.confirmed_books.create</code> ou <code>@author.confirmed_books.build</code> criará <code>books</code> onde a coluna <code>confirmed</code> terá o valor <code>true</code>.</p><h6 id="escopos-para-has-many-extending"><a class="anchorlink" href="#escopos-para-has-many-extending">4.3.3.2 <code>extending</code></a></h6><p>O método <code>extending</code> específica um módulo com nome para estender a delegação da associação. Extensões de associações são discutidas com detalhes <a href="#association-extensions">mais pra frente neste guia</a>.</p><h6 id="escopos-para-has-many-group"><a class="anchorlink" href="#escopos-para-has-many-group">4.3.3.3 <code>group</code></a></h6><p>O método <code>group</code> fornece um nome de atributo para agrupar o resultado da consulta ao banco de dados, utilizando a cláusula <code>GROUP BY</code> na busca SQL.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s1">'books.id'</span> <span class="p">},</span>
                      <span class="ss">through: :books</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ea9177aa7c464b9d156616e43774b5a9">class Author &lt; ApplicationRecord
  has_many :chapters, -&gt; { group 'books.id' },
                      through: :books
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ea9177aa7c464b9d156616e43774b5a9">Copiar</button>
</div>
<h6 id="escopos-para-has-many-includes"><a class="anchorlink" href="#escopos-para-has-many-includes">4.3.3.4 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas de forma adiantada quando esta associação for utilizada. Por exemplo, considere estes models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-838071ab3968a74c44275667d0fc83e4">class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter &lt; ApplicationRecord
  belongs_to :book
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-838071ab3968a74c44275667d0fc83e4">Copiar</button>
</div>
<p>Se você busca <em>chapters</em> com frequência de <em>authors</em> (<code>@author.books.chapters</code>), então você pode deixar o seu código ligeiramente mais eficiente ao incluir <em>chapters</em> na associação de <em>authors</em> para <em>books</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:chapters</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a39de730f061a943aa299214011888c5">class Author &lt; ApplicationRecord
  has_many :books, -&gt; { includes :chapters }
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter &lt; ApplicationRecord
  belongs_to :book
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a39de730f061a943aa299214011888c5">Copiar</button>
</div>
<h6 id="escopos-para-has-many-limit"><a class="anchorlink" href="#escopos-para-has-many-limit">4.3.3.5 <code>limit</code></a></h6><p>O método <code>limit</code> permite restringir o número total de objetos que serão retornados através de uma associação.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:recent_books</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'published_at desc'</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3766526dee8ba45cc91078ddbbe66dc7">class Author &lt; ApplicationRecord
  has_many :recent_books,
    -&gt; { order('published_at desc').limit(100) },
    class_name: "Book"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3766526dee8ba45cc91078ddbbe66dc7">Copiar</button>
</div>
<h6 id="escopos-para-has-many-offset"><a class="anchorlink" href="#escopos-para-has-many-offset">4.3.3.6 <code>offset</code></a></h6><p>O método permite especificar o deslocamento inicial ao buscar objetos do banco de dados através de uma associação. . Por exemplo, <code>-&gt; { offset(11) }</code> pulará os primeiros 11 registros no banco de dados.</p><h6 id="escopos-para-has-many-order"><a class="anchorlink" href="#escopos-para-has-many-order">4.3.3.7 <code>order</code></a></h6><p>O método <code>order</code> determina a ordem pela qual objetos associados serão retornados (na sintaxe utilizada pela cláusula SQL <code>ORDER BY</code>).</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"date_confirmed DESC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4fd05a3d3a9e5b9f3a89776748636817">class Author &lt; ApplicationRecord
  has_many :books, -&gt; { order "date_confirmed DESC" }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4fd05a3d3a9e5b9f3a89776748636817">Copiar</button>
</div>
<h6 id="escopos-para-has-many-readonly"><a class="anchorlink" href="#escopos-para-has-many-readonly">4.3.3.8 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então os objetos associados só terão acesso de leitura quando retornados através da associação.</p><h6 id="escopos-para-has-many-select"><a class="anchorlink" href="#escopos-para-has-many-select">4.3.3.9 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é utilizada para retornar dados sobre os objetos associados. Por padrão, o Rails retorna todas as colunas.</p><div class="warning"><p>Se você especificar seu próprio <code>select</code>, certifique-se de incluir as colunas de chave primária e chave estrangeira do <em>model</em> associado. Se você não fizer isto, o Rails retornará um erro.</p></div><h6 id="escopos-para-has-many-distinct"><a class="anchorlink" href="#escopos-para-has-many-distinct">4.3.3.10 <code>distinct</code></a></h6><p>Utilize o método <code>distinct</code> para manter a coleção livre de objetos duplicados. Isto é
mais útil junto com a opção <code>:through</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">through: :readings</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="n">article</span>   <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">inspect</span> <span class="c1"># =&gt; [#&lt;Article id: 5, name: "a1"&gt;, #&lt;Article id: 5, name: "a1"&gt;]</span>
<span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">inspect</span>     <span class="c1"># =&gt; [#&lt;Reading id: 12, person_id: 5, article_id: 5&gt;, #&lt;Reading id: 13, person_id: 5, article_id: 5&gt;]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7f9f8f387e1575dfd4e1d17d38555acb">class Person &lt; ApplicationRecord
  has_many :readings
  has_many :articles, through: :readings
end

person = Person.create(name: 'John')
article   = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
person.articles.inspect # =&gt; [#&lt;Article id: 5, name: "a1"&gt;, #&lt;Article id: 5, name: "a1"&gt;]
Reading.all.inspect     # =&gt; [#&lt;Reading id: 12, person_id: 5, article_id: 5&gt;, #&lt;Reading id: 13, person_id: 5, article_id: 5&gt;]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7f9f8f387e1575dfd4e1d17d38555acb">Copiar</button>
</div>
<p>No caso acima há dois <em>readings</em> e <code>person.articles</code> retorna os dois apesar
destes registros apontarem para o mesmo <em>article</em>.</p><p>Agora vamos especificar <code>distinct</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through: :readings</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="n">article</span>   <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">inspect</span> <span class="c1"># =&gt; [#&lt;Article id: 7, name: "a1"&gt;]</span>
<span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">inspect</span>     <span class="c1"># =&gt; [#&lt;Reading id: 16, person_id: 7, article_id: 7&gt;, #&lt;Reading id: 17, person_id: 7, article_id: 7&gt;]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-575e5cd9f5b71cd77327da29e59decd4">class Person
  has_many :readings
  has_many :articles, -&gt; { distinct }, through: :readings
end

person = Person.create(name: 'Honda')
article   = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
person.articles.inspect # =&gt; [#&lt;Article id: 7, name: "a1"&gt;]
Reading.all.inspect     # =&gt; [#&lt;Reading id: 16, person_id: 7, article_id: 7&gt;, #&lt;Reading id: 17, person_id: 7, article_id: 7&gt;]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-575e5cd9f5b71cd77327da29e59decd4">Copiar</button>
</div>
<p>No caso acima ainda há dois <em>readings</em>. Contudo, <code>person.articles</code> mostra apenas
um <em>article</em> porque a coleção carrega apenas registros únicos.</p><p>Se você quiser ter certeza que, ao inserir dados novos no banco, todos os
registros na associação persistida sejam distintos (de forma que você também
possa ter certeza que quando inspecionar a associação, não achará dados
duplicados), você deve colocar um índice único na própria tabela. Por exemplo,
se você tem uma tabela chamada <code>readings</code> e você quer ter certeza que os
<em>articles</em> sejam adicionados por uma <em>person</em> apenas uma vez, você pode colocar
o seguinte em uma migração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_index</span> <span class="ss">:readings</span><span class="p">,</span> <span class="p">[</span><span class="ss">:person_id</span><span class="p">,</span> <span class="ss">:article_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e97d9a916049fcc7cd8278a771f9bd28">add_index :readings, [:person_id, :article_id], unique: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e97d9a916049fcc7cd8278a771f9bd28">Copiar</button>
</div>
<p>Uma vez que você tenha este índice único, tentar incluir um <em>article</em> a uma
<em>person</em> duas vezes retornará um erro <code>ActiveRecord::RecordNotUnique</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="c1"># =&gt; ActiveRecord::RecordNotUnique</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-47bd9f7e6ea2768eef058f55fc611fb0">person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article # =&gt; ActiveRecord::RecordNotUnique
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-47bd9f7e6ea2768eef058f55fc611fb0">Copiar</button>
</div>
<p>Note que conferir por unicidade utilizando algo como <code>include?</code> está sujeito a
<em>race conditions</em> (Exemplo:
<a href="https://pt.wikipedia.org/wiki/Condi%C3%A7%C3%A3o_de_corrida">https://pt.wikipedia.org/wiki/Condi%C3%A7%C3%A3o_de_corrida</a>). Não tente utilizar
<code>include?</code> para impor que objetos sejam distintos em um associação. Por exemplo,
utilizando o exemplo de <em>article</em> acima, o código seguinte teria uma <em>race
condition</em> porque múltiplos usuários podem tentar isto ao mesmo tempo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cf37df3d77361a565d7cba441d87c5db">person.articles &lt;&lt; article unless person.articles.include?(article)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cf37df3d77361a565d7cba441d87c5db">Copiar</button>
</div>
<h5 id="referencia-da-associacao-has-many-quando-os-objetos-sao-salvos-questionmark"><a class="anchorlink" href="#referencia-da-associacao-has-many-quando-os-objetos-sao-salvos-questionmark">4.3.4 Quando os Objetos são Salvos?</a></h5><p>Quando você atribui um objeto a uma associação <code>has_many</code>, este objeto será salvo automaticamente (para atualizar sua chave estrangeira). Se você atribuir vários objetos em uma declaração, então todos serão salvos.</p><p>Se qualquer uma destas operações de escrita falharem devido a erros de validação, então a atribuição retornará <code>false</code> e a atribuição em si será cancelada.</p><p>Se o objeto pai (o que declarar a associação <code>has_many</code>) não for salvo (isto é, <code>new_record?</code> retorna <code>true</code>) então os objetos filhos não serão salvos quando forem adicionados à coleção. Todos os membros da associação que não forem salvos anteriormente serão salvos automaticamente quando o objeto pai for salvo.</p><p>Se você quiser atribuir um objeto para uma associação <code>has_many</code> sem salvar o objeto, utilize o método <code>collection.build</code>.</p><h4 id="referencia-da-associacao-has-and-belongs-to-many"><a class="anchorlink" href="#referencia-da-associacao-has-and-belongs-to-many">4.4 Referência da Associação <code>has_and_belongs_to_many</code></a></h4><p>A associação <code>has_and_belongs_to_many</code> cria uma relação muitos-para-muitos com outro <em>model</em>. Em termos do banco de dados, isto associa duas classes através de uma tabela de junção intermediária que inclui chaves estrangeiras fazendo referência a cada classe.</p><h5 id="metodos-adicionados-por-has-and-belongs-to-many"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many">4.4.1 Métodos Adicionados por <code>has_and_belongs_to_many</code></a></h5><p>Quando você declara uma associação <code>has_and_belongs_to_many</code>, a classe declarada ganha automaticamente 17 métodos relacionados à associação:</p>
<ul>
<li><code>collection</code></li>
<li><code>collection&lt;&lt;(object, ...)</code></li>
<li><code>collection.delete(object, ...)</code></li>
<li><code>collection.destroy(object, ...)</code></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><code>collection.clear</code></li>
<li><code>collection.empty?</code></li>
<li><code>collection.size</code></li>
<li><code>collection.find(...)</code></li>
<li><code>collection.where(...)</code></li>
<li><code>collection.exists?(...)</code></li>
<li><code>collection.build(attributes = {})</code></li>
<li><code>collection.create(attributes = {})</code></li>
<li><code>collection.create!(attributes = {})</code></li>
<li><code>collection.reload</code></li>
</ul>
<p>Em todos estes métodos, <code>collection</code> será substituído pelo <em>symbol</em> passado como primeiro argumento para <code>has_and_belongs_to_many</code>, e <code>collection_singular</code> será substituído com a versão singular daquele <em>symbol</em>. Por exemplo, dada a declaração:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a6f8640b206d8967ff6ccaf7fcab50b3">class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a6f8640b206d8967ff6ccaf7fcab50b3">Copiar</button>
</div>
<p>Cada instância do <em>model</em> <code>Part</code> terá estes métodos:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assemblies</span>
<span class="n">assemblies</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">assembly_ids</span>
<span class="n">assembly_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">size</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-661f55d3af08e3b58898a5286f0ac405">assemblies
assemblies&lt;&lt;(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-661f55d3af08e3b58898a5286f0ac405">Copiar</button>
</div>
<h6 id="metodos-adicionais-de-coluna"><a class="anchorlink" href="#metodos-adicionais-de-coluna">4.4.1.1 Métodos Adicionais de Coluna</a></h6><p>Se a tabela de junção para uma associação <code>has_and_belongs_to_many</code> tem colunas adicionais além das duas chaves estrangeiras, estas colunas serão adicionadas como atributos dos registros retornados através da associação. Registros retornados com atributos adicionais apenas poderão ter acesso de leitura, porque o Rails não pode salvar mudanças destes atributos.</p><div class="warning"><p>O uso de atributos extras na tabela de junção em uma associação <code>has_and_belongs_to_many</code> está deprecado. Se você necessitar deste tipo de comportamento complexo na tabela que liga dois <em>models</em> em uma relação muitos-para-muitos, você deve utilizar uma associação <code>has_many :through</code> ao invés de uma associação <code>has_and_belongs_to_many</code>.</p></div><h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection">4.4.1.2 <code>collection</code></a></h6><p>O método <code>collection</code> retorna uma <em>Relation</em> de todos os objetos associados. Se não há objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-145f81770df49449db70f1c502e9b8e8">@assemblies = @part.assemblies
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-145f81770df49449db70f1c502e9b8e8">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-object"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-object">4.4.1.3 <code>collection&lt;&lt;(object, ...)</code></a></h6><p>O método <code>collection&lt;&lt;</code> acrescenta um ou mais objetos à coleção criando dados na tabela de junção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span> <span class="o">&lt;&lt;</span> <span class="vi">@assembly1</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a14fc2707a9dde30b6b6e8fd7761f430">@part.assemblies &lt;&lt; @assembly1
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a14fc2707a9dde30b6b6e8fd7761f430">Copiar</button>
</div>
<div class="note"><p>Este método pode ser chamado como <code>collection.concat</code> e <code>collection.push</code>.</p></div><h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-delete-object"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-delete-object">4.4.1.4 <code>collection.delete(object, ...)</code></a></h6><p>O método <code>collection.delete</code> remove um ou mais objetos da coleção deletando dados da tabela de junção. Isto não destrói os objetos.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-39173977ca76ae66bedb5f75edf88b12">@part.assemblies.delete(@assembly1)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-39173977ca76ae66bedb5f75edf88b12">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-destroy-object"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-destroy-object">4.4.1.5 <code>collection.destroy(object, ...)</code></a></h6><p>O método <code>collection.destroy</code> remove um ou mais objetos da coleção deletando dados da tabela de junção. Isto não destrói os objetos.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4cc1c5083560376f26bc2a88f45ddfb6">@part.assemblies.destroy(@assembly1)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4cc1c5083560376f26bc2a88f45ddfb6">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-objects"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-objects">4.4.1.6 <code>collection=(objects)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos fornecidos, ao adicionar e deletar da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-singular-ids"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-singular-ids">4.4.1.7 <code>collection_singular_ids</code></a></h6><p>O método <code>collection_singular_ids</code> retorna um <em>array</em> de <em>ids</em> dos objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_ids</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assembly_ids</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-96039b3766a9feed8a8f403a6a1cc191">@assembly_ids = @part.assembly_ids
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-96039b3766a9feed8a8f403a6a1cc191">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-singular-ids-ids"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-singular-ids-ids">4.4.1.8 <code>collection_singular_ids=(ids)</code></a></h6><p>O método <code>collection=</code> faz com que a coleção contenha apenas os objetos identificados pelo valor das chaves primárias fornecidas, adicionando e deletando da forma que for mais apropriada. As mudanças são persistidas no banco de dados.</p><h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-clear"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-clear">4.4.1.9 <code>collection.clear</code></a></h6><p>O método <code>collection.clear</code> remove todos os objetos da coleção deletando todas as linhas da tabela de junção. Isto não destrói os objetos associados.</p><h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-empty-questionmark"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-empty-questionmark">4.4.1.10 <code>collection.empty?</code></a></h6><p>O método <code>collection.empty?</code> retorna <code>true</code> se a coleção não contiver nenhum objeto associado.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="o">&lt;</span><span class="sx">% if </span><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">empty?</span> <span class="sx">%&gt;
  This part is not used in any assemblies
&lt;% end %&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-54ceee3663ab81166b59c4904c742316">&lt;% if @part.assemblies.empty? %&gt;
  This part is not used in any assemblies
&lt;% end %&gt;
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-54ceee3663ab81166b59c4904c742316">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-size"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-size">4.4.1.11 <code>collection.size</code></a></h6><p>O método <code>collection.size</code> retorna o número de objetos na coleção.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_count</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f7e5f6e5f7f0924e0f7a3e50a15c07a8">@assembly_count = @part.assemblies.size
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f7e5f6e5f7f0924e0f7a3e50a15c07a8">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-find"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-find">4.4.1.12 <code>collection.find(...)</code></a></h6><p>O método <code>collection.find</code> procura objetos dentro da coleção. Ele utiliza a mesma sintaxe e opções que
<a href="https://api.rubyonrails.org/v6.0.3.4/classes/ActiveRecord/FinderMethods.html#method-i-find"><code>ActiveRecord::Base.find</code></a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-338a8c66116b2d645de4d724f423126e">@assembly = @part.assemblies.find(1)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-338a8c66116b2d645de4d724f423126e">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-where"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-where">4.4.1.13 <code>collection.where(...)</code></a></h6><p>O método <code>collection.where</code> procura objetos dentro da coleção com base nas condições fornecidas mas os objetos serão carregados apenas quando necessário (<em>lazy loading</em>) significando que o banco de dados é consultado apenas quando os objetos são acessados.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@new_assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-df044528c584941b1531d50c814786e2">@new_assemblies = @part.assemblies.where("created_at &gt; ?", 2.days.ago)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-df044528c584941b1531d50c814786e2">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-exists-questionmark"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-exists-questionmark">4.4.1.14 <code>collection.exists?(...)</code></a></h6><p>O método <code>collection.exists?</code> confere se um objeto que atende às condições fornecidas
existe na coleção. Ele usa a mesma sintaxe e opções que
<a href="https://api.rubyonrails.org/v6.0.3.4/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>ActiveRecord::Base.exists?</code></a>.</p><h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-build-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-build-attributes">4.4.1.15 <code>collection.build(attributes = {})</code></a></h6><p>O método <code>collection.build</code> retorna um objeto novo do tipo associado. O objeto será instanciado com base nos atributos passados para o método e será criada uma ligação através de uma chave estrangeira, mas o objeto associado <em>não</em> será salvo ainda.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cbf7dc5746cc658c7c51847b20d28364">@assembly = @part.assemblies.build({assembly_name: "Transmission housing"})
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cbf7dc5746cc658c7c51847b20d28364">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-create-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-create-attributes">4.4.1.16 <code>collection.create(attributes = {})</code></a></h6><p>O método <code>collection.create</code> retorna um objeto novo do tipo associado. Este objeto será instanciado com base nos atributos que foram passados para o método, a ligação através da tabela de junção será criado, e, uma vez que o objeto passe por todas as validações especificadas no <em>model</em> associado, o objeto associado <em>será</em> salvo.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3638c2715ab1a968736d45968d4e26fa">@assembly = @part.assemblies.create({assembly_name: "Transmission housing"})
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3638c2715ab1a968736d45968d4e26fa">Copiar</button>
</div>
<h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-create-bang-attributes"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-create-bang-attributes">4.4.1.17 <code>collection.create!(attributes = {})</code></a></h6><p>Faz o mesmo que <code>collection.create</code>, mas retorna <code>ActiveRecord::RecordInvalid</code> se o dado for inválido.</p><h6 id="metodos-adicionados-por-has-and-belongs-to-many-collection-reload"><a class="anchorlink" href="#metodos-adicionados-por-has-and-belongs-to-many-collection-reload">4.4.1.18 <code>collection.reload</code></a></h6><p>O método <code>collection.reload</code> retorna uma <em>Relation</em> de todos os objetos associados, forçando uma leitura do banco de dados. Se não houver objetos associados, ele retorna uma <em>Relation</em> vazia.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9cb958f03669cc54800c8c3e631d59eb">@assemblies = @part.assemblies.reload
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9cb958f03669cc54800c8c3e631d59eb">Copiar</button>
</div>
<h5 id="opcoes-para-has-and-belongs-to-many"><a class="anchorlink" href="#opcoes-para-has-and-belongs-to-many">4.4.2 Opções para <code>has_and_belongs_to_many</code></a></h5><p>Embora o Rails utilize padrões inteligentes que funcionarão bem na maioria das situações, pode haver momentos onde você queira customizar o comportamento da referência da associação <code>has_and_belongs_to_many</code>. Tais customizações podem ser feitas facilmente ao passar opções quando você cria a associação. Por exemplo, esta associação usa duas destas opções:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">readonly</span> <span class="p">},</span>
                                       <span class="ss">autosave: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9fe3514ed53b23711f428f9b4095e4d9">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { readonly },
                                       autosave: true
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9fe3514ed53b23711f428f9b4095e4d9">Copiar</button>
</div>
<p>A associação <code>has_and_belongs_to_many</code> tem suporte para estas opções:</p>
<ul>
<li><code>:association_foreign_key</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:foreign_key</code></li>
<li><code>:join_table</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="association-foreign-key"><a class="anchorlink" href="#association-foreign-key">4.4.2.1 <code>:association_foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna na tabela de junção utilizada para guardar a chave estrangeira que aponta para o outro <em>model</em> tem o nome daquele <em>model</em> com o sufixo <code>_id</code> acrescentado. A opção <code>:association_foreign_key</code> permite especificar o nome da chave estrangeira diretamente:</p><div class="info"><p>As opções <code>:foreign_key</code> e <code>:association_foreign_key</code> são úteis quando você configura uma relação muitos-para-muitos entre o mesmo <em>model</em>. Por exemplo:</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3e8d90359cc00809b3220c18e6be33aa">class User &lt; ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: "User",
      foreign_key: "this_user_id",
      association_foreign_key: "other_user_id"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3e8d90359cc00809b3220c18e6be33aa">Copiar</button>
</div>
<h6 id="opcoes-para-has-and-belongs-to-many-autosave"><a class="anchorlink" href="#opcoes-para-has-and-belongs-to-many-autosave">4.4.2.2 <code>:autosave</code></a></h6><p>Se você configurar a opção <code>:autosave</code> para <code>true</code>, o Rails salvará qualquer membro da associação carregada e destruirá membros que forem marcados para destruição quando você salvar o objeto pai. Ao configurar <code>:autosave</code> para <code>false</code> não é o mesmo que configurar a opção <code>:autosave</code>. Se a opção <code>:autosave</code> não estiver presente, então novos objetos associados serão salvos, mas objetos associados que forem atualizados não serão salvos.</p><h6 id="opcoes-para-has-and-belongs-to-many-class-name"><a class="anchorlink" href="#opcoes-para-has-and-belongs-to-many-class-name">4.4.2.3 <code>:class_name</code></a></h6><p>Se o nome do outro <em>model</em> não puder ser derivado a partir do nome da associação, você pode usar a opção <code>:class_name</code> para fornecer o nome do <em>model</em>. Por exemplo, se uma <em>part</em> tem muitas <em>assemblies</em>, mas o nome de fato do <em>model</em> contendo <em>assemblies</em> é <code>Gadget</code>, esta configuração seria necessária:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Gadget"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-32117abc0a6ab3c141c368d9bddf36f8">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, class_name: "Gadget"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-32117abc0a6ab3c141c368d9bddf36f8">Copiar</button>
</div>
<h6 id="opcoes-para-has-and-belongs-to-many-foreign-key"><a class="anchorlink" href="#opcoes-para-has-and-belongs-to-many-foreign-key">4.4.2.4 <code>:foreign_key</code></a></h6><p>Por convenção, o Rails presume que a coluna na tabela de junção utilizada para armazenar a chave estrangeira apontando para este <em>model</em> é o nome deste <em>model</em> com o sufixo <code>_id</code> acrescentado. A opção <code>:foreign_key</code> permite que você atribua o nome da chave estrangeira diretamente:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ccd615a4752e85e898f25bfdcfaf4e14">class User &lt; ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: "User",
      foreign_key: "this_user_id",
      association_foreign_key: "other_user_id"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ccd615a4752e85e898f25bfdcfaf4e14">Copiar</button>
</div>
<h6 id="join-table"><a class="anchorlink" href="#join-table">4.4.2.5 <code>:join_table</code></a></h6><p>Se o nome padrão da tabela de junção, baseado no ordenamento léxico, não for o que você quer, você pode utilizar a opção <code>:join_table</code> para sobrescrever o nome padrão.</p><h6 id="opcoes-para-has-and-belongs-to-many-validate"><a class="anchorlink" href="#opcoes-para-has-and-belongs-to-many-validate">4.4.2.6 <code>:validate</code></a></h6><p>Se você configurar a opção <code>:validate</code> como <code>false</code>, então os objetos associados não serão validados quando você salvar este objeto. Por padrão, este valor é <code>true</code>: objetos associados serão validados quando este objeto for salvo.</p><h5 id="escopos-para-has-and-belongs-to-many"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many">4.4.3 Escopos para <code>has_and_belongs_to_many</code></a></h5><p>Podem haver momentos onde você pode querer customizar a consulta utilizada por <code>has_and_belongs_to_many</code>. Estas customizações podem ser feitas através de um bloco de escopo. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-decab928a70bec9f1e8d678041efeba3">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { where active: true }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-decab928a70bec9f1e8d678041efeba3">Copiar</button>
</div>
<p>Você pode utilizar qualquer um dos <a href="active_record_querying.html">métodos padrão de consulta abaixo</a> dentro do bloco de escopo. Os métodos seguintes são discutidos abaixo:</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h6 id="escopos-para-has-and-belongs-to-many-where"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-where">4.4.3.1 <code>where</code></a></h6><p>O método <code>where</code> permite especificar as condições que o objeto associado deve atender.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"factory = 'Seattle'"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4e1562ef512dd5f907feb88f2012d1b5">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { where "factory = 'Seattle'" }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4e1562ef512dd5f907feb88f2012d1b5">Copiar</button>
</div>
<p>Você também pode especificar condições através de um <em>hash</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">factory: </span><span class="s1">'Seattle'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5ad303e9b3067395e88aca80f2c5537c">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { where factory: 'Seattle' }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5ad303e9b3067395e88aca80f2c5537c">Copiar</button>
</div>
<p>Se você utilizar a opção <code>where</code> no estilo <em>hash</em>, então a criação de dados através desta associação terá o escopo limitado automaticamente utilizando o <em>hash</em>. Neste caso, utilizar <code>@parts.assemblies.create</code> ou <code>@parts.assemblies.build</code> criará <code>orders</code> onde a coluna <code>factory</code> terá o valor "Seattle".</p><h6 id="escopos-para-has-and-belongs-to-many-extending"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-extending">4.4.3.2 <code>extending</code></a></h6><p>O método <code>extending</code> específica um módulo com nome para estender a delegação da associação. Extensões de associações são discutidas com detalhes <a href="#association-extensions">mais pra frente neste guia</a>.</p><h6 id="escopos-para-has-and-belongs-to-many-group"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-group">4.4.3.3 <code>group</code></a></h6><p>O método <code>group</code> fornece um nome de atributo para agrupar o resultado da consulta ao banco de dados, utilizando a cláusula <code>GROUP BY</code> na busca SQL.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s2">"factory"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-69debd6a8ecfde61339efa137420b434">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { group "factory" }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-69debd6a8ecfde61339efa137420b434">Copiar</button>
</div>
<h6 id="escopos-para-has-and-belongs-to-many-includes"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-includes">4.4.3.4 <code>includes</code></a></h6><p>Você pode utilizar o método <code>includes</code> para especificar associações de segunda ordem que devem ser carregadas com antecedêncai quando esta associação for utilizada.</p><h6 id="escopos-para-has-and-belongs-to-many-limit"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-limit">4.4.3.5 <code>limit</code></a></h6><p>O método <code>limit</code> permite restringir o número total de objetos que serão retornados através de uma associação.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3a7b0c7cd57d63bb166288079aa43421">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { order("created_at DESC").limit(50) }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3a7b0c7cd57d63bb166288079aa43421">Copiar</button>
</div>
<h6 id="escopos-para-has-and-belongs-to-many-offset"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-offset">4.4.3.6 <code>offset</code></a></h6><p>O método permite especificar o deslocamento inicial ao buscar objetos do banco de dados através de uma associação. Por exemplo, se você utilizar <code>offset(11)</code>, ele pulará os primeiros 11 registros no banco de dados.</p><h6 id="escopos-para-has-and-belongs-to-many-order"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-order">4.4.3.7 <code>order</code></a></h6><p>O método <code>order</code> determina a ordem pela qual objetos associados serão retornados (na sintaxe utilizada pela cláusula SQL <code>ORDER BY</code>).</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"assembly_name ASC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-24fd94a0f1456348f99816f85bb8fbdc">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { order "assembly_name ASC" }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-24fd94a0f1456348f99816f85bb8fbdc">Copiar</button>
</div>
<h6 id="escopos-para-has-and-belongs-to-many-readonly"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-readonly">4.4.3.8 <code>readonly</code></a></h6><p>Se você utilizar o método <code>readonly</code>, então os objetos associados só terão acesso de leitura quando retornados através da associação.</p><h6 id="escopos-para-has-and-belongs-to-many-select"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-select">4.4.3.9 <code>select</code></a></h6><p>O método <code>select</code> permite sobrescrever a cláusula SQL <code>SELECT</code> que é utilizada para retornar dados sobre os objetos associados. Por padrão, o Rails retorna todas as colunas.</p><h6 id="escopos-para-has-and-belongs-to-many-distinct"><a class="anchorlink" href="#escopos-para-has-and-belongs-to-many-distinct">4.4.3.10 <code>distinct</code></a></h6><p>Utilize o método <code>distinct</code> para remover objetos duplicados da coleção.</p><h5 id="referencia-da-associacao-has-and-belongs-to-many-quando-os-objetos-sao-salvos-questionmark"><a class="anchorlink" href="#referencia-da-associacao-has-and-belongs-to-many-quando-os-objetos-sao-salvos-questionmark">4.4.4 Quando os Objetos são Salvos?</a></h5><p>Quando você atribui um objeto a uma associação <code>has_and_belongs_to_many</code>, este objeto será salvo automaticamente (para atualizar a tabela de junção). Se você atribuir vários objetos em uma declaração, então todos serão salvos.</p><p>Se qualquer uma destas operações de escrita falharem devido a erros de validação, então a atribuição retornará <code>false</code> e a atribuição em si será cancelada.</p><p>Se o objeto pai (o que declarar a associação <code>has_and_belongs_to_many</code>) não for salvo (isto é, <code>new_record?</code> retorna <code>true</code>) então os objetos filhos não serão salvos quando forem adicionados à coleção. Todos os membros da associação que não forem salvos anteriormente serão salvos automaticamente quando o objeto pai for salvo.</p><p>Se você quiser atribuir um objeto para uma associação <code>has_and_belongs_to_many</code> sem salvar o objeto, utilize o método <code>collection.build</code>.</p><h4 id="callbacks-de-associacao"><a class="anchorlink" href="#callbacks-de-associacao">4.5 <em>Callbacks</em> de Associação</a></h4><p><em>Callbacks</em> normais aparecem no ciclo de vida dos objetos do Active Record, permitindo trabalhar com estes objetos em vários pontos. Por exemplo, você pode utilizar <em>callbacks</em> <code>:before_save</code> para fazer com que algo aconteça logo antes de salvar o objeto.</p><p><em>Callbacks</em> de associação são similares a <em>callbacks</em> normais, mas eles são ativados por eventos no ciclo de vida de uma coleção. Há quatro <em>callbacks</em> de associação disponíveis:</p>
<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>
<p>Você define <em>callbacks</em> de associação ao adicionar opções à declaração da associação. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_credit_limit</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-27c843ae34740f2cfb3ec266c24743cd">class Author &lt; ApplicationRecord
  has_many :books, before_add: :check_credit_limit

  def check_credit_limit(book)
    ...
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-27c843ae34740f2cfb3ec266c24743cd">Copiar</button>
</div>
<p>O Rails passa o objeto que é adicionado ou removido do <em>callback</em>.</p><p>Você pode empilhar <em>callbacks</em> em um único evento ao passá-los como um <em>array</em>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span>
    <span class="ss">before_add: </span><span class="p">[</span><span class="ss">:check_credit_limit</span><span class="p">,</span> <span class="ss">:calculate_shipping_charges</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_shipping_charges</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e927e50a470192f5f9e83a3202badb8b">class Author &lt; ApplicationRecord
  has_many :books,
    before_add: [:check_credit_limit, :calculate_shipping_charges]

  def check_credit_limit(book)
    ...
  end

  def calculate_shipping_charges(book)
    ...
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e927e50a470192f5f9e83a3202badb8b">Copiar</button>
</div>
<p>Se um <em>callback</em>  <code>before_add</code> retornar uma exceção, o objeto não será adicionado à coleção. De forma similar, se um <em>callback</em> <code>before_remove</code> retornar uma exceção, o objeto não será removido da coleção.</p><div class="note"><p>Estes <em>callbacks</em> são chamados apenas quando os objetos associados são adicionados ou removidos através da coleção da associação:</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Ativa o *callback* `before_add`</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="n">book</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">=</span> <span class="p">[</span><span class="n">book</span><span class="p">,</span> <span class="n">book2</span><span class="p">]</span>

<span class="c1"># Não ativa o *callback* `before_add`</span>
<span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">author_id: </span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-a13384c22cbef2dff9a2eaec6c2cf5f0"># Ativa o *callback* `before_add`
author.books &lt;&lt; book
author.books = [book, book2]

# Não ativa o *callback* `before_add`
book.update(author_id: 1)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a13384c22cbef2dff9a2eaec6c2cf5f0">Copiar</button>
</div>
<h4 id="association-extensions"><a class="anchorlink" href="#association-extensions">4.6 Association Extensions</a></h4><p>Suas opções não estão limitadas às funcionalidades que o Rails monta automaticamente nos objetos de referência da associação. Você também pode extender estes objetos através de módulos anônimos, acrescentar <em>finders</em> novos, <em>creators</em>, ou outros métodos. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_book_prefix</span><span class="p">(</span><span class="n">book_number</span><span class="p">)</span>
      <span class="n">find_by</span><span class="p">(</span><span class="ss">category_id: </span><span class="n">book_number</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7cec99ac4df89aae0d174e837ba3afa3">class Author &lt; ApplicationRecord
  has_many :books do
    def find_by_book_prefix(book_number)
      find_by(category_id: book_number[0..2])
    end
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7cec99ac4df89aae0d174e837ba3afa3">Copiar</button>
</div>
<p>Se você tem uma extensão que deve ser compartilhada por várias associações, você pode utilizar um módulo de extensão com nome. Por exemplo:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FindRecentExtension</span>
  <span class="k">def</span> <span class="nf">find_recent</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7aed6cc112148a2af29ef691b72973d5">module FindRecentExtension
  def find_recent
    where("created_at &gt; ?", 5.days.ago)
  end
end

class Author &lt; ApplicationRecord
  has_many :books, -&gt; { extending FindRecentExtension }
end

class Supplier &lt; ApplicationRecord
  has_many :deliveries, -&gt; { extending FindRecentExtension }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7aed6cc112148a2af29ef691b72973d5">Copiar</button>
</div>
<p>Extensões podem fazer referência a detalehs internos do objeto de referência da associação utilizando estes três atributos do acessor <code>proxy_association</code>:</p>
<ul>
<li>
<code>proxy_association.owner</code> retorna o objeto do qual a associação faz parte.</li>
<li>
<code>proxy_association.reflection</code> retorna o objeto de reflexão que descreve a associação.</li>
<li>
<code>proxy_association.target</code> retorna o objeto associado para <code>belongs_to</code> ou <code>has_one</code>, ou a coleção de objetos associados para <code>has_many</code> ou <code>has_and_belongs_to_many</code>.</li>
</ul>
<h3 id="single-table-inheritance"><a class="anchorlink" href="#single-table-inheritance">5 Single Table Inheritance</a></h3><p>Às vezes é desejável compartilhar atributos e comportamento entre <em>models</em>.
Vamos dizer que temos <em>models</em> <code>Car</code>, <code>Motorcycle</code> e <code>Bicycle</code>. Queremos
compartilhar os atributos de <code>color</code> e <code>price</code> e também alguns métodos para
estes atributos, mas ainda mantendo comportamentos específicos para cada um
deles, incluindo <em>controllers</em> separados.</p><p>O Rails deixa isso bem fácil. Primeiro, vamos gerar o <em>model</em> de base, <code>Vehicle</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>generate model vehicle <span class="nb">type</span>:string color:string price:decimal<span class="o">{</span>10.2<span class="o">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-87d653fcf6701d82b1eef9c99709119c">rails generate model vehicle type:string color:string price:decimal{10.2}
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-87d653fcf6701d82b1eef9c99709119c">Copiar</button>
</div>
<p>Você notou que estamos adicionando um atributo <code>type</code>? Dado que todos os <em>models</em>
serão armazenados em uma única tabela, o Rails vai armazenar o nome do <em>model</em>
nesse atributo. No nosso exemplo, as possibilidades são <code>Car</code>, <code>Motorcycle</code> ou
<code>Bicycle</code>. STI não funciona sem um atributo <code>type</code> na tabela.</p><p>Em seguida, vamos gerar os três <em>models</em> que herdam de <code>Vehicle</code>. Para isso podemos
usar a opção <code>--parent=PARENT</code> que vai gerar um <em>model</em> que herda do "<em>parent</em>"
especificado e sem uma <em>migration</em> equivalente (dado que a tabela já existe).</p><p>Por exemplo, para gerar o <em>model</em> <code>Car</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>generate model car <span class="nt">--parent</span><span class="o">=</span>Vehicle
</code></pre>
<textarea class="clipboard-content" id="clipboard-2a4acc8b341f1b768c2e293d04d36019">rails generate model car --parent=Vehicle
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2a4acc8b341f1b768c2e293d04d36019">Copiar</button>
</div>
<p>O <em>model</em> gerado vai parecer com:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-86078e701dbed0c3f9e24a9d08892ac7">class Car &lt; Vehicle
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-86078e701dbed0c3f9e24a9d08892ac7">Copiar</button>
</div>
<p>Isso significa que todo o comportamento adicionado à classe <code>Vehicle</code> estará
disponível também na classe <code>Car</code>, incluindo as associações, métodos públicos,
etc.</p><p>Criar um carro vai armazená-lo na tabela <code>vehicles</code> e popular o atributo <code>type</code>
com o valor "<em>Car</em>":</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">color: </span><span class="s1">'Red'</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">10000</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2bcd812fc039e6f9d2cd39118838e06f">Car.create(color: 'Red', price: 10000)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2bcd812fc039e6f9d2cd39118838e06f">Copiar</button>
</div>
<p>vai gerar o seguinte SQL:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"vehicles"</span> <span class="p">(</span><span class="nv">"type"</span><span class="p">,</span> <span class="nv">"color"</span><span class="p">,</span> <span class="nv">"price"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">,</span> <span class="s1">'Red'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-44a5ca116d972583c441e5ab86db29be">INSERT INTO "vehicles" ("type", "color", "price") VALUES ('Car', 'Red', 10000)
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-44a5ca116d972583c441e5ab86db29be">Copiar</button>
</div>
<p>A <em>query</em> (consulta) por registros de carros vai simplesmente buscar veiculos que
são do tipo <em>Car</em>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b780ef73373c1a2ff763ce9cda352f00">Car.all
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b780ef73373c1a2ff763ce9cda352f00">Copiar</button>
</div>
<p>vai executar a seguinte <em>query</em>:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"vehicles"</span> <span class="k">WHERE</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="nv">"type"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1646c85911608eca6fc217f9d34d9d4f">SELECT "vehicles".* FROM "vehicles" WHERE "vehicles"."type" IN ('Car')
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1646c85911608eca6fc217f9d34d9d4f">Copiar</button>
</div>


        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua se vir qualquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na master do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch master.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
</body>
</html>
